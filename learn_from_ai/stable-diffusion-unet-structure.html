<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta property="og:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta name="twitter:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta property="og:url" content="https://blog.ryo-okami.xyz/learn_from_ai/stable-diffusion-unet-structure" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@ryo_okami" data-next-head=""/><meta name="twitter:creator" content="@ryo_okami" data-next-head=""/><link rel="icon" href="/blog-next/favicon.ico" data-next-head=""/><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" data-next-head=""/><title data-next-head="">Stable Diffusion UNet 内部结构 | Ryo&#x27;s Blog</title><meta property="og:title" content="Stable Diffusion UNet 内部结构" data-next-head=""/><meta property="og:site_name" content="Ryo&#x27;s Blog" data-next-head=""/><meta name="twitter:title" content="Stable Diffusion UNet 内部结构 | Ryo&#x27;s Blog" data-next-head=""/><meta name="description" content="&gt; [!summary]
&gt; 以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录
在 `train_text_to_image_lora.py` 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。" data-next-head=""/><meta property="og:description" content="&gt; [!summary]
&gt; 以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录
在 `train_text_to_image_lora.py` 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。" data-next-head=""/><meta name="twitter:description" content="&gt; [!summary]
&gt; 以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录
在 `train_text_to_image_lora.py` 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2025-03-28T02:00:00.000Z" data-next-head=""/><meta property="article:modified_time" content="2025-03-28T02:00:00.000Z" data-next-head=""/><meta property="article:tag" content="深度学习" data-next-head=""/><meta property="article:tag" content="Stable Diffusion" data-next-head=""/><meta property="article:tag" content="LoRA" data-next-head=""/><meta property="article:tag" content="参数高效微调" data-next-head=""/><meta property="article:tag" content="模型训练" data-next-head=""/><meta property="article:tag" content="学习笔记" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" as="style"/><link rel="preload" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" as="style"/><link rel="stylesheet" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" data-n-g=""/><link rel="stylesheet" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/blog-next/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/blog-next/_next/static/chunks/webpack-63b01344875cd2b5.js" defer=""></script><script src="/blog-next/_next/static/chunks/framework-0907bc41f77e1d3c.js" defer=""></script><script src="/blog-next/_next/static/chunks/main-f6bb73538570e395.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/_app-46f15a352f2e34a5.js" defer=""></script><script src="/blog-next/_next/static/chunks/6d2b60a9-beef439121ada977.js" defer=""></script><script src="/blog-next/_next/static/chunks/52d06cd5-18d657cfd06e973c.js" defer=""></script><script src="/blog-next/_next/static/chunks/4130-4f55663d0ffc3327.js" defer=""></script><script src="/blog-next/_next/static/chunks/4587-ad3e00575945688a.js" defer=""></script><script src="/blog-next/_next/static/chunks/366-e7aa9bf3cae7308c.js" defer=""></script><script src="/blog-next/_next/static/chunks/7564-2d1adbbf02956a78.js" defer=""></script><script src="/blog-next/_next/static/chunks/8494-d96a947715d36e05.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/learn_from_ai/%5Bslug%5D-9684e89c88263b0e.js" defer=""></script><script src="/blog-next/_next/static/jAGlVzXXWmm3gN9ilzCwJ/_buildManifest.js" defer=""></script><script src="/blog-next/_next/static/jAGlVzXXWmm3gN9ilzCwJ/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css czlpqi">.css-czlpqi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-czlpqi{position:absolute;}}</style><style data-emotion="css 1cmpeoq">.css-1cmpeoq{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:var(--Paper-shadow);background-image:var(--Paper-overlay);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-1cmpeoq{position:absolute;}}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionFixed mui-fixed css-1cmpeoq" style="--Paper-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"><style data-emotion="css 1guk29">@media (min-width:0px){.css-1guk29{display:none;}}@media (min-width:900px){.css-1guk29{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="ml-2 w-24 mr-4 MuiBox-root css-1guk29"><a class="DefaultLayout_textlink__W55gl" href="/blog-next">Ryo&#x27;s Blog</a></div><style data-emotion="css 1m04nb5">@media (min-width:0px){.css-1m04nb5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:900px){.css-1m04nb5{display:none;}}</style><div class="ml-2 mr-4 MuiBox-root css-1m04nb5"><a title="Ryo&#x27;s Blog" href="/blog-next"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium h-6 w-6 text-gray-300 hover:text-white css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></a></div><style data-emotion="css nznm6s">.css-nznm6s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="MuiBox-root css-nznm6s"><div class="DefaultLayoutMenu bg-transparent min-w-full"><ul class="rc-menu-overflow rc-menu rc-menu-root rc-menu-horizontal" role="menu" tabindex="0" data-menu-list="true"><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:0" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/articles">Articles</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:1" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/learn_from_ai">Learn from AI</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:2" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/tags">Tags</a></li><li class="rc-menu-overflow-item rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:1;order:3" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span class="DefaultLayout_textlink__W55gl">More</span><i class="rc-menu-submenu-arrow"></i></div></li><li class="rc-menu-overflow-item rc-menu-overflow-item-rest rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" title="..." aria-expanded="false" aria-haspopup="true">...<i class="rc-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></div></div><style data-emotion="css k008qs">.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="MuiBox-root css-k008qs"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></header><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"></div><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="DefaultLayout_contentHeight__RDRZE"><article class="Post_post__acRqJ"><h1 class="Post_postTitle__N1NIA">Stable Diffusion UNet 内部结构</h1><div class="Post_postDate__SQx7A"><time dateTime="2025-03-28T02:00:00.000Z">2025-03-28</time></div><div class="TagsBox_tagsBox__WzhAf mt-2"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->深度学习</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/stable-diffusion">#<!-- -->Stable Diffusion</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->参数高效微调</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->模型训练</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->学习笔记</a></div><div class="post-body Post_postContent__mJ_Ju"><div class="rounded-md p-2 my-4 bg-teal-100"><div class="text-base font-bold text-teal-500"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M7 15h7v2H7zm0-4h10v2H7zm0-4h10v2H7zm12-4h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-.14 0-.27.01-.4.04-.39.08-.74.28-1.01.55-.18.18-.33.4-.43.64-.1.23-.16.49-.16.77v14c0 .27.06.54.16.78s.25.45.43.64c.27.27.62.47 1.01.55.13.02.26.03.4.03h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-7-.25c.41 0 .75.34.75.75s-.34.75-.75.75-.75-.34-.75-.75.34-.75.75-.75M19 19H5V5h14z"></path></svg> <!-- -->Summary<!-- --> </div><div class="m-2"><p>以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录</p></div></div>
<h1 id="q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤"><a href="#q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: @train_text_to_image_lora.py 这段代码中如何体现 LoRA “使用两个低秩矩阵进行微调” 的步骤？</h1>
<p>在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>train_text_to_image_lora.py</span></span></code></span> 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。</p>
<p>以下是脚本中如何体现 LoRA 使用两个低秩矩阵进行微调的步骤：</p>
<h3 id="1-lora-配置"><a href="#1-lora-配置" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. LoRA 配置</h3>
<p>在脚本中，LoRA 的配置通常通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>LoraConfig</span></span></code></span> 类来定义。这个配置包括低秩矩阵的秩（<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>rank</span></span></code></span>）和其他参数：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">unet_lora_config </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> LoraConfig(</span></span>
<span data-line=""><span style="color:#C6CCD7">    r</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">args.rank,  </span><span style="color:#5F6672;font-style:italic"># 低秩矩阵的秩</span></span>
<span data-line=""><span style="color:#C6CCD7">    lora_alpha</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">args.rank,  </span><span style="color:#5F6672;font-style:italic"># LoRA 的缩放因子</span></span>
<span data-line=""><span style="color:#C6CCD7">    init_lora_weights</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">gaussian</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,  </span><span style="color:#5F6672;font-style:italic"># 初始化权重的方法</span></span>
<span data-line=""><span style="color:#C6CCD7">    target_modules</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">[</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">to_k</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">to_q</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">to_v</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">to_out.0</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">],  </span><span style="color:#5F6672;font-style:italic"># 目标模块</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<h3 id="2-添加-lora-层"><a href="#2-添加-lora-层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 添加 LoRA 层</h3>
<p>在模型中插入 LoRA 层是通过调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>add_adapter</span></span></code></span> 方法实现的：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">unet.add_adapter(unet_lora_config)</span></span></code></pre></figure>
<p>这个方法会在指定的目标模块中插入两个低秩矩阵 (A) 和 (B)，用于调整模型的权重。具体来说，LoRA 在模型的注意力层中插入这些矩阵，以便在不改变原始权重的情况下进行微调。</p>
<h3 id="3-训练过程中的权重更新"><a href="#3-训练过程中的权重更新" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 训练过程中的权重更新</h3>
<p>在训练过程中，只有 LoRA 插入的低秩矩阵的参数是可训练的。原始模型的权重保持冻结状态。这是通过以下代码实现的：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># freeze parameters of models to save more memory</span></span>
<span data-line=""><span style="color:#A9B2C3">unet.requires_grad_(</span><span style="color:#56B6C2">False</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#A9B2C3">vae.requires_grad_(</span><span style="color:#56B6C2">False</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#A9B2C3">text_encoder.requires_grad_(</span><span style="color:#56B6C2">False</span><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<p>通过这种方式，训练过程只会更新 LoRA 层的参数，而不会影响原始模型的权重。</p>
<h3 id="4-参数更新"><a href="#4-参数更新" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. 参数更新</h3>
<p>在训练循环中，反向传播和参数更新步骤只会影响 LoRA 层的参数：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># Backpropagate</span></span>
<span data-line=""><span style="color:#A9B2C3">accelerator.backward(loss)</span></span>
<span data-line=""><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> accelerator.sync_gradients:</span></span>
<span data-line=""><span style="color:#A9B2C3">    params_to_clip </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> lora_layers</span></span>
<span data-line=""><span style="color:#A9B2C3">    accelerator.clip_grad_norm_(params_to_clip, args.max_grad_norm)</span></span>
<span data-line=""><span style="color:#A9B2C3">optimizer.step()</span></span>
<span data-line=""><span style="color:#A9B2C3">lr_scheduler.step()</span></span>
<span data-line=""><span style="color:#A9B2C3">optimizer.zero_grad()</span></span></code></pre></figure>
<p>这里的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>lora_layers</span></span></code></span> 是一个过滤器，只包含 LoRA 层的可训练参数。</p>
<h3 id="总结"><a href="#总结" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>总结</h3>
<p>通过在模型的特定层中插入两个低秩矩阵，LoRA 实现了参数高效的微调。这种方法允许在不改变原始模型权重的情况下，通过调整低秩矩阵来适应新的数据分布，从而实现高效的模型微调。</p>
<h1 id="q-unet-是个什么样的结构"><a href="#q-unet-是个什么样的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: unet 是个什么样的结构？</h1>
<p>UNet 是一种常用于图像生成和分割任务的神经网络架构。它最初是在医学图像分割领域中引入的，但由于其强大的特性和灵活性，UNet 也被广泛应用于其他计算机视觉任务，包括图像生成、去噪和超分辨率等。</p>
<h3 id="unet-的基本结构"><a href="#unet-的基本结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>UNet 的基本结构</h3>
<p>UNet 的结构可以分为两个主要部分：编码器（下采样路径）和解码器（上采样路径），中间通过跳跃连接（skip connections）相连。</p>
<ol>
<li>
<p><strong>编码器（下采样路径）</strong>：</p>
<ul>
<li>由一系列卷积层和池化层组成。</li>
<li>每个卷积层通常后接一个激活函数（如 ReLU）。</li>
<li>池化层用于逐步减少特征图的空间维度，同时增加特征的抽象程度。</li>
</ul>
</li>
<li>
<p><strong>解码器（上采样路径）</strong>：</p>
<ul>
<li>由一系列上采样层（如反卷积或上采样）和卷积层组成。</li>
<li>逐步恢复特征图的空间维度。</li>
<li>使用跳跃连接将编码器中相应层的特征图与解码器中的特征图连接，以保留细节信息。</li>
</ul>
</li>
<li>
<p><strong>跳跃连接（Skip Connections）</strong>：</p>
<ul>
<li>将编码器中的特征图直接连接到解码器中相应层的特征图。</li>
<li>这种连接方式有助于保留输入图像的细节信息，改善生成结果的质量。</li>
</ul>
</li>
</ol>
<h3 id="unet-在-stable-diffusion-中的应用"><a href="#unet-在-stable-diffusion-中的应用" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>UNet 在 Stable Diffusion 中的应用</h3>
<p>在 Stable Diffusion 模型中，UNet 作为核心组件用于处理图像的潜在表示。具体来说，UNet 在扩散模型中用于预测噪声残差，从而逐步生成高质量的图像。</p>
<ul>
<li><strong>输入</strong>：UNet 接收一个带有噪声的潜在表示（通常是一个低维的特征图）。</li>
<li><strong>输出</strong>：UNet 输出一个与输入相同大小的特征图，表示对噪声的预测。</li>
<li><strong>训练目标</strong>：通过最小化预测噪声与真实噪声之间的差异，UNet 学会如何去除噪声，从而生成清晰的图像。</li>
</ul>
<h3 id="unet-的优势"><a href="#unet-的优势" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>UNet 的优势</h3>
<ul>
<li><strong>高效的特征提取</strong>：通过编码器提取多尺度特征。</li>
<li><strong>细节保留</strong>：通过跳跃连接保留输入图像的细节信息。</li>
<li><strong>灵活性</strong>：可以适应不同的输入尺寸和任务需求。</li>
</ul>
<p>UNet 的这种结构使其在图像生成任务中表现出色，特别是在需要高分辨率输出和细节保留的场景中。</p>
<h1 id="q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的"><a href="#q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 为什么这里 unet、 vae 、 tokenizer 等几个模型都是从同一个路径加载的？</h1>
<p>在这个代码片段中，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>vae</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>tokenizer</span></span></code></span> 和其他组件都是从同一个路径加载的，这是因为它们都是 Stable Diffusion 模型的一部分。Stable Diffusion 是一个复杂的生成模型，通常由多个子模块组成，每个子模块负责不同的任务。以下是这些组件的作用和为什么它们从同一路径加载的原因：</p>
<h3 id="1-统一的模型路径"><a href="#1-统一的模型路径" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 统一的模型路径</h3>
<ul>
<li><strong>路径一致性</strong>：所有这些组件都从同一个路径加载，因为它们通常被打包在一个预训练模型中。这个路径通常指向一个包含所有必要文件的目录或一个 Hugging Face Hub 上的模型仓库。</li>
<li><strong>版本控制</strong>：通过从同一个路径加载，确保所有组件使用的是同一个版本的模型，避免版本不匹配导致的兼容性问题。</li>
</ul>
<h3 id="2-各个组件的作用"><a href="#2-各个组件的作用" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 各个组件的作用</h3>
<ul>
<li>
<p><strong>UNet (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet</span></span></code></span>)</strong>：</p>
<ul>
<li>负责处理图像的潜在表示，预测噪声残差。</li>
<li>在扩散模型中用于逐步生成高质量的图像。</li>
</ul>
</li>
<li>
<p><strong>VAE (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>vae</span></span></code></span>)</strong>：</p>
<ul>
<li>自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。</li>
<li>在 Stable Diffusion 中，VAE 用于将输入图像转换为潜在表示，供 UNet 处理。</li>
</ul>
</li>
<li>
<p><strong>Tokenizer (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>tokenizer</span></span></code></span>)</strong>：</p>
<ul>
<li>用于将文本输入（如生成图像的描述）转换为模型可理解的标记。</li>
<li>在文本到图像生成任务中，tokenizer 将文本描述转换为输入 ID，供文本编码器使用。</li>
</ul>
</li>
<li>
<p><strong>Text Encoder (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>text_encoder</span></span></code></span>)</strong>：</p>
<ul>
<li>将文本输入编码为特征向量，供 UNet 使用。</li>
<li>在生成过程中，文本编码器提供条件信息，指导图像生成。</li>
</ul>
</li>
<li>
<p><strong>Noise Scheduler (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>noise_scheduler</span></span></code></span>)</strong>：</p>
<ul>
<li>控制扩散过程中的噪声添加和去除。</li>
<li>在训练和推理过程中，调度器决定在每个时间步添加多少噪声。</li>
</ul>
</li>
</ul>
<h3 id="3-统一加载的好处"><a href="#3-统一加载的好处" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 统一加载的好处</h3>
<ul>
<li><strong>简化管理</strong>：从同一位置加载所有组件简化了模型管理和部署。</li>
<li><strong>一致性</strong>：确保所有组件在同一训练配置下工作，避免不兼容问题。</li>
<li><strong>便捷性</strong>：用户只需指定一个路径或模型标识符，即可加载整个模型的所有必要部分。</li>
</ul>
<p>通过这种方式，用户可以方便地使用预训练的 Stable Diffusion 模型进行微调或推理，而不必单独管理每个组件的版本和路径。</p>
<h1 id="q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web"><a href="#q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 这些是 Stable Diffusion 的内部设计对吧？这些都在哪篇论文里提出的？ @Web</h1>
<p>Stable Diffusion 是一种基于扩散模型的图像生成技术，其核心组件和设计在多篇论文中得到了详细描述。以下是与 Stable Diffusion 相关的关键论文：</p>
<ol>
<li>
<p><strong>扩散模型的基础</strong>：</p>
<ul>
<li><strong>论文</strong>：<em>Denoising Diffusion Probabilistic Models</em> by Jonathan Ho, Ajay Jain, Pieter Abbeel (2020)</li>
<li><strong>链接</strong>：<a href="https://arxiv.org/abs/2006.11239">arXiv:2006.11239</a></li>
<li><strong>内容</strong>：这篇论文介绍了扩散模型的基本原理和去噪过程，是 Stable Diffusion 的理论基础。</li>
</ul>
</li>
<li>
<p><strong>Stable Diffusion 的具体实现</strong>：</p>
<ul>
<li><strong>论文</strong>：<em>High-Resolution Image Synthesis with Latent Diffusion Models</em> by Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, Björn Ommer (2021)</li>
<li><strong>链接</strong>：<a href="https://arxiv.org/abs/2112.10752">arXiv:2112.10752</a></li>
<li><strong>内容</strong>：这篇论文详细描述了 Stable Diffusion 的架构，包括使用潜在空间的扩散模型、VAE 的应用以及如何在高分辨率图像生成中实现高效计算。</li>
</ul>
</li>
<li>
<p><strong>CLIP 模型的使用</strong>：</p>
<ul>
<li><strong>论文</strong>：<em>Learning Transferable Visual Models From Natural Language Supervision</em> by Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, Gretchen Krueger, Ilya Sutskever (2021)</li>
<li><strong>链接</strong>：<a href="https://arxiv.org/abs/2103.00020">arXiv:2103.00020</a></li>
<li><strong>内容</strong>：CLIP 模型用于将文本和图像结合在一起进行训练，Stable Diffusion 使用 CLIP 作为文本编码器来处理文本输入。</li>
</ul>
</li>
</ol>
<p>这些论文共同构成了 Stable Diffusion 的理论和技术基础，描述了其内部设计和实现细节。通过结合扩散模型、VAE 和 CLIP，Stable Diffusion 实现了高效的文本到图像生成。</p>
<h1 id="q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy"><a href="#q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 解释 StableDiffusionPipeline 的结构 @pipeline_stable_diffusion.py</h1>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 是一个用于实现 Stable Diffusion 模型的核心类，负责将多个组件组合在一起以实现文本到图像的生成。以下是对 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 结构的详细解释：</p>
<h3 id="继承关系"><a href="#继承关系" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>继承关系</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 继承了多个类，这些类为其提供了不同的功能：</p>
<ul>
<li><strong>DiffusionPipeline</strong>: 提供了基本的扩散模型功能。</li>
<li><strong>StableDiffusionMixin</strong>: 包含与 Stable Diffusion 相关的特定功能。</li>
<li><strong>TextualInversionLoaderMixin</strong>: 支持文本反转加载功能。</li>
<li><strong>StableDiffusionLoraLoaderMixin</strong>: 支持 LoRA（低秩适应）加载功能。</li>
<li><strong>IPAdapterMixin</strong>: 提供 IP 适配器功能。</li>
<li><strong>FromSingleFileMixin</strong>: 支持从单个文件加载模型。</li>
</ul>
<h3 id="初始化方法"><a href="#初始化方法" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>初始化方法</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>__init__</span></span></code></span> 方法用于初始化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 的各个组件：</p>
<ul>
<li><strong>VAE (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>vae</span></span></code></span>)</strong>: 自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。</li>
<li><strong>Text Encoder (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>text_encoder</span></span></code></span>)</strong>: 使用 CLIP 模型将文本输入编码为特征向量。</li>
<li><strong>Tokenizer (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>tokenizer</span></span></code></span>)</strong>: 将文本输入转换为模型可理解的标记。</li>
<li><strong>UNet (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet</span></span></code></span>)</strong>: 负责处理图像的潜在表示，预测噪声残差。</li>
<li><strong>Scheduler (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>scheduler</span></span></code></span>)</strong>: 控制扩散过程中的噪声添加和去除。</li>
<li><strong>Safety Checker (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safety_checker</span></span></code></span>)</strong>: 用于检查生成图像的安全性。</li>
<li><strong>Feature Extractor (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>feature_extractor</span></span></code></span>)</strong>: 用于从图像中提取特征。</li>
<li><strong>Image Encoder (<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>image_encoder</span></span></code></span>)</strong>: 可选组件，用于图像编码。</li>
</ul>
<h3 id="功能和方法"><a href="#功能和方法" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>功能和方法</h3>
<ul>
<li><strong>Deprecation Warnings</strong>: 在初始化过程中，检查 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>scheduler</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet</span></span></code></span> 的配置是否过时，并提供相应的弃用警告。</li>
<li><strong>Module Registration</strong>: 使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>register_modules</span></span></code></span> 方法将各个组件注册到管道中，便于统一管理。</li>
<li><strong>Safety Checks</strong>: 提供安全检查功能，确保生成的图像符合安全标准。</li>
<li><strong>Guidance Scale</strong>: 提供指导比例的计算和应用，用于控制生成图像的风格和内容。</li>
<li><strong>Image Processing</strong>: 包含图像处理方法，如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>decode_latents</span></span></code></span>，用于将潜在表示转换为图像。</li>
</ul>
<h3 id="属性"><a href="#属性" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>属性</h3>
<ul>
<li><strong>Guidance Scale</strong>: 控制生成图像的风格和内容。</li>
<li><strong>Cross Attention</strong>: 提供交叉注意力机制的参数。</li>
<li><strong>Timesteps</strong>: 控制扩散过程的时间步数。</li>
</ul>
<h3 id="设计目的"><a href="#设计目的" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>设计目的</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 的设计目的是将 Stable Diffusion 模型的各个组件整合在一起，提供一个统一的接口来进行文本到图像的生成。通过继承和组合多个功能模块，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 能够灵活地支持不同的生成任务和配置需求。</p>
<h1 id="q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么"><a href="#q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: @pipeline_utils.py 解释 DiffusionPipeline 的结构，以及 from_pretrained 在做什么</h1>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 是一个用于管理和执行扩散模型的核心类，提供了加载、配置和运行模型的基本功能。以下是对 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 结构和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法的详细解释：</p>
<h3 id="diffusionpipeline-的结构"><a href="#diffusionpipeline-的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>DiffusionPipeline 的结构</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 是一个抽象基类，定义了扩散模型的基本接口和功能。其主要结构包括：</p>
<ol>
<li>
<p><strong>模块注册</strong>：</p>
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>register_modules</span></span></code></span> 方法用于注册模型的各个组件（如 VAE、UNet、调度器等），便于统一管理和调用。</li>
</ul>
</li>
<li>
<p><strong>模型加载</strong>：</p>
<ul>
<li>提供从预训练模型加载各个组件的功能，通常通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法实现。</li>
</ul>
</li>
<li>
<p><strong>推理接口</strong>：</p>
<ul>
<li>定义了模型推理的基本接口，用户可以通过调用这些接口生成图像或其他输出。</li>
</ul>
</li>
<li>
<p><strong>配置管理</strong>：</p>
<ul>
<li>提供配置加载和保存功能，便于模型的复用和共享。</li>
</ul>
</li>
<li>
<p><strong>实用工具</strong>：</p>
<ul>
<li>包含一些实用工具方法，如检查版本、处理设备映射等。</li>
</ul>
</li>
</ol>
<h3 id="from_pretrained-方法"><a href="#from_pretrained-方法" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>from_pretrained 方法</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 中的一个关键方法，用于从预训练模型加载管道的各个组件。其主要功能包括：</p>
<ol>
<li>
<p><strong>模型路径解析</strong>：</p>
<ul>
<li>接受一个模型标识符（如 Hugging Face Hub 上的模型 ID）或本地路径，解析并定位模型文件。</li>
</ul>
</li>
<li>
<p><strong>组件加载</strong>：</p>
<ul>
<li>从指定路径加载模型的各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。</li>
<li>支持加载不同版本和变体的模型组件。</li>
</ul>
</li>
<li>
<p><strong>配置加载</strong>：</p>
<ul>
<li>加载模型的配置文件，设置模型的超参数和其他配置选项。</li>
</ul>
</li>
<li>
<p><strong>设备映射</strong>：</p>
<ul>
<li>根据用户指定的设备映射策略，将模型组件分配到合适的计算设备（如 CPU、GPU）。</li>
</ul>
</li>
<li>
<p><strong>安全检查</strong>：</p>
<ul>
<li>在加载过程中，检查模型的安全性和兼容性，确保加载的模型符合预期。</li>
</ul>
</li>
<li>
<p><strong>返回实例</strong>：</p>
<ul>
<li>完成加载后，返回一个配置好的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 实例，用户可以直接使用该实例进行推理。</li>
</ul>
</li>
</ol>
<h3 id="设计目的-1"><a href="#设计目的-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>设计目的</h3>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline</span></span></code></span> 的设计目的是提供一个统一的接口来管理和执行扩散模型。通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法，用户可以方便地加载和配置预训练模型，快速进行推理和生成任务。这种设计使得扩散模型的使用更加简便和高效，适合各种应用场景。</p>
<h1 id="q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗"><a href="#q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: @train_text_to_image_lora.py 里，从 DiffusionPipeline.from_pretrained 加载到了 @pipeline_stable_diffusion.py 中 StableDiffusionPipeline 类的实例，我理解的对吗？</h1>
<p>是的，你的理解是正确的。在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>train_text_to_image_lora.py</span></span></code></span> 中，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline.from_pretrained</span></span></code></span> 方法用于加载预训练的模型管道实例。在这个过程中，它会根据指定的模型路径和配置，实例化一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 类的对象。</p>
<h3 id="具体过程如下"><a href="#具体过程如下" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>具体过程如下：</h3>
<ol>
<li>
<p><strong>调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法</strong>：</p>
<ul>
<li>在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>train_text_to_image_lora.py</span></span></code></span> 中，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline.from_pretrained</span></span></code></span> 被调用来加载预训练的模型。</li>
<li>这个方法会根据提供的路径或模型标识符，从 Hugging Face Hub 或本地文件系统加载模型的权重和配置。</li>
</ul>
</li>
<li>
<p><strong>实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span></strong>：</p>
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法会识别模型的类型，并根据配置文件中的信息选择合适的管道类进行实例化。</li>
<li>在这个例子中，由于加载的是 Stable Diffusion 模型，因此会实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 类。</li>
</ul>
</li>
<li>
<p><strong>加载组件</strong>：</p>
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>__init__</span></span></code></span> 方法会被调用，加载模型的各个组件（如 VAE、UNet、调度器等）。</li>
<li>这些组件会根据预训练的权重进行初始化，并注册到管道中。</li>
</ul>
</li>
<li>
<p><strong>返回实例</strong>：</p>
<ul>
<li>完成加载后，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法返回一个配置好的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>StableDiffusionPipeline</span></span></code></span> 实例。</li>
<li>这个实例可以用于进一步的推理或微调任务。</li>
</ul>
</li>
</ol>
<p>通过这种方式，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>train_text_to_image_lora.py</span></span></code></span> 脚本能够方便地加载和使用预训练的 Stable Diffusion 模型进行微调和生成任务。</p>
<h1 id="q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase"><a href="#q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 解读 @pipeline_utils.py 中 from_pretrained 代码，详细说明如何识别模型类型选择管道类。 @Codebase</h1>
<p>在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>pipeline_utils.py</span></span></code></span> 中，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法负责从预训练模型加载管道实例。以下是该方法如何识别模型类型并选择合适的管道类的详细说明：</p>
<h3 id="识别模型类型并选择管道类的步骤"><a href="#识别模型类型并选择管道类的步骤" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>识别模型类型并选择管道类的步骤</h3>
<ol>
<li>
<p><strong>下载和缓存模型文件</strong>：</p>
<ul>
<li>首先，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法会检查 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>pretrained_model_name_or_path</span></span></code></span> 是否是一个本地路径。如果不是，它会调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cls.download</span></span></code></span> 方法从 Hugging Face Hub 下载模型文件，并将其缓存到本地。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">763</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">788</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>加载配置文件</strong>：</p>
<ul>
<li>使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cls.load_config</span></span></code></span> 方法加载模型的配置文件，该文件包含模型的超参数和其他配置信息。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">812</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">818</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>识别模型变体</strong>：</p>
<ul>
<li>通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_identify_model_variants</span></span></code></span> 方法识别模型的变体（如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>fp16</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ema</span></span></code></span> 等），以便加载正确的模型文件。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">820</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">827</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>解析自定义管道和类</strong>：</p>
<ul>
<li>使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_resolve_custom_pipeline_and_cls</span></span></code></span> 方法解析自定义管道和类名。如果用户指定了自定义管道，则从 Hub 加载相应的模块。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">831</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">833</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>获取管道类</strong>：</p>
<ul>
<li>调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_get_pipeline_class</span></span></code></span> 方法，根据配置文件和用户指定的选项，确定要实例化的管道类。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">834</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">842</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>加载管道组件</strong>：</p>
<ul>
<li>根据管道类的签名，加载并实例化各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">857</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">980</span></span></code></pre></figure>
</li>
</ul>
</li>
<li>
<p><strong>实例化管道</strong>：</p>
<ul>
<li>使用加载的组件和配置，实例化最终的管道对象。</li>
<li>相关代码行：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">startLine: </span><span style="color:#56B6C2">1021</span></span>
<span data-line=""><span style="color:#A9B2C3">endLine: </span><span style="color:#56B6C2">1028</span></span></code></pre></figure>
</li>
</ul>
</li>
</ol>
<p>通过这些步骤，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法能够识别模型类型并选择合适的管道类，确保加载的模型能够正确地进行推理和生成任务。</p>
<h1 id="q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例"><a href="#q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 如果我只有一个 sd_xl_base_1.0.safetensors 文件，是否无法使用 from_pretrained 方法得到具体的 Pipeline 实例？</h1>
<p>如果你只有一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>sd_xl_base_1.0.safetensors</span></span></code></span> 文件，直接使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法可能会遇到一些困难，因为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 通常期望从一个包含完整模型配置和权重的目录或 Hugging Face Hub 仓库中加载模型。</p>
<h3 id="解决方案"><a href="#解决方案" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>解决方案</h3>
<ol>
<li>
<p><strong>手动加载权重</strong>：</p>
<ul>
<li>你可以手动加载 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 文件中的权重，并将它们分配给相应的模型组件（如 UNet、VAE 等）。</li>
<li>这需要你对模型的架构有深入的了解，以便正确地将权重映射到模型的各个部分。</li>
</ul>
</li>
<li>
<p><strong>创建配置文件</strong>：</p>
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法依赖于配置文件来确定如何构建模型管道。你可以尝试创建一个与模型匹配的配置文件，通常是一个 JSON 文件，描述模型的架构和超参数。</li>
<li>这个配置文件需要放在与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 文件相同的目录中。</li>
</ul>
</li>
<li>
<p><strong>使用自定义加载逻辑</strong>：</p>
<ul>
<li>如果你熟悉模型的架构，可以编写自定义的加载逻辑，将 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 文件中的权重加载到模型中。</li>
<li>这可能涉及使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 库来读取权重，并手动将它们分配给模型的各个层。</li>
</ul>
</li>
<li>
<p><strong>检查社区资源</strong>：</p>
<ul>
<li>有时，社区会提供工具或脚本来帮助加载特定格式的模型文件。你可以在相关的 GitHub 仓库或论坛中查找是否有适合的工具。</li>
</ul>
</li>
</ol>
<h3 id="总结-1"><a href="#总结-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>总结</h3>
<p>虽然 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法提供了便捷的加载方式，但它通常需要完整的模型目录或 Hub 仓库。如果只有一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 文件，你可能需要手动处理权重加载和配置，以便正确地构建和使用模型管道。</p>
<h1 id="q-如果我只需要进行推理是否仍需配置文件"><a href="#q-如果我只需要进行推理是否仍需配置文件" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 如果我只需要进行推理，是否仍需配置文件？</h1>
<p>在进行推理时，配置文件仍然是非常有用的，尽管在某些情况下你可能能够在没有完整配置文件的情况下进行推理。以下是一些考虑因素：</p>
<h3 id="为什么需要配置文件"><a href="#为什么需要配置文件" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>为什么需要配置文件</h3>
<ol>
<li>
<p><strong>模型架构信息</strong>：</p>
<ul>
<li>配置文件通常包含模型的架构信息，如层数、隐藏单元数、激活函数等。这些信息对于正确构建模型至关重要。</li>
</ul>
</li>
<li>
<p><strong>超参数设置</strong>：</p>
<ul>
<li>配置文件中可能包含一些超参数设置，如学习率、优化器设置等，虽然这些在推理时不直接使用，但了解这些信息有助于理解模型的行为。</li>
</ul>
</li>
<li>
<p><strong>组件初始化</strong>：</p>
<ul>
<li>在复杂模型（如 Stable Diffusion）中，配置文件用于初始化各个组件（如 VAE、UNet、调度器等）。这些组件需要正确的参数来进行推理。</li>
</ul>
</li>
</ol>
<h3 id="没有配置文件时的推理"><a href="#没有配置文件时的推理" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>没有配置文件时的推理</h3>
<p>如果你没有配置文件，但仍希望进行推理，可以考虑以下方法：</p>
<ol>
<li>
<p><strong>手动构建模型</strong>：</p>
<ul>
<li>如果你对模型的架构有深入了解，可以手动构建模型，并使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>safetensors</span></span></code></span> 文件中的权重进行初始化。</li>
</ul>
</li>
<li>
<p><strong>使用默认设置</strong>：</p>
<ul>
<li>在某些情况下，你可以使用一些默认的设置来初始化模型组件，但这可能会导致性能不佳或结果不准确。</li>
</ul>
</li>
<li>
<p><strong>社区支持</strong>：</p>
<ul>
<li>查找社区提供的工具或脚本，这些工具可能已经解决了如何在没有完整配置文件的情况下进行推理的问题。</li>
</ul>
</li>
</ol>
<h3 id="总结-2"><a href="#总结-2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>总结</h3>
<p>虽然在某些情况下可以在没有配置文件的情况下进行推理，但拥有配置文件通常会使过程更简单、更可靠。如果可能，尝试获取或创建一个与模型匹配的配置文件，以确保推理的准确性和效率。</p>
<h1 id="q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的"><a href="#q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 以你上面举的例子为例，@pipeline_loading_utils.py load_sub_model 中，实例化的是 @unet_2d_condition.py 中的 UNet2DConditionModel 类吗？ load_sub_model 是怎么找到这个类并实例化的？</h1>
<p>Deepseek R-1:</p>
<think><p>好的，我需要仔细分析用户的问题。用户问的是在<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>pipeline_loading_utils.py</span></span></code></span>中的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span>函数是否实例化了<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet_2d_condition.py</span></span></code></span>中的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>类，以及这个过程是如何找到并实例化该类的。</p><p>首先，我需要回忆<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span>函数的作用。根据之前的讨论，这个函数负责动态加载模型的各个子组件，比如 UNet、VAE 等。用户提供的代码片段显示，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span>通过<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_obj</span></span></code></span>来实例化具体的类，而<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_obj</span></span></code></span>是通过<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_class_obj_and_candidates</span></span></code></span>函数获取的。</p><p>接下来，我需要查看<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_class_obj_and_candidates</span></span></code></span>函数的逻辑。这个函数会根据<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>library_name</span></span></code></span>和<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_name</span></span></code></span>来查找对应的类。例如，当<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>library_name</span></span></code></span>是&quot;diffusers&quot;，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_name</span></span></code></span>是&quot;UNet2DConditionModel&quot;时，应该会导入<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>diffusers.models.unets.unet_2d_condition</span></span></code></span>模块中的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>类。</p><p>然后，我需要确认<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet_2d_condition.py</span></span></code></span>中的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>类是否被正确注册到<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ALL_IMPORTABLE_CLASSES</span></span></code></span>中。在 Diffusers 库中，通常会有全局的类注册机制，确保各个组件可以被动态发现和加载。</p><p>此外，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span>函数中的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_method</span></span></code></span>是通过<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_get_load_method</span></span></code></span>获取的，这可能涉及到从预训练权重加载模型的方法，比如<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span>。需要检查<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>类是否实现了相应的类方法，以支持从配置文件或预训练文件加载。</p><p>最后，需要验证实例化的过程是否正确，包括参数传递和配置的应用。例如，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>__init__</span></span></code></span>方法需要接收正确的参数来构建模型结构，而这些参数可能来自配置文件或默认值。</p><p>总结来说，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span>通过类名和库名找到对应的类，利用其加载方法（如<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span>）实例化对象，而<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>作为可导入的类被正确注册和引用，从而完成实例化。</p></think>
<p>是的，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>pipeline_loading_utils.py</span></span></code></span> 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span> 函数最终会实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet_2d_condition.py</span></span></code></span> 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 类。以下是完整的加载逻辑解析：</p>
<hr/>
<h3 id="核心加载流程"><a href="#核心加载流程" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>核心加载流程</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># pipeline_loading_utils.py 中的关键代码段</span></span>
<span data-line=""><span style="color:#61AFEF">def</span><span style="color:#B57EDC"> load_sub_model</span><span style="color:#A9B2C3">(...):</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 1. 获取类对象和候选类</span></span>
<span data-line=""><span style="color:#A9B2C3">    class_obj, class_candidates </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> get_class_obj_and_candidates(</span></span>
<span data-line=""><span style="color:#A9B2C3">        library_name,</span></span>
<span data-line=""><span style="color:#A9B2C3">        class_name,</span></span>
<span data-line=""><span style="color:#A9B2C3">        importable_classes,</span></span>
<span data-line=""><span style="color:#A9B2C3">        pipelines,</span></span>
<span data-line=""><span style="color:#A9B2C3">        is_pipeline_module,</span></span>
<span data-line=""><span style="color:#C6CCD7">        component_name</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">name,</span></span>
<span data-line=""><span style="color:#C6CCD7">        cache_dir</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">cached_folder,</span></span>
<span data-line=""><span style="color:#A9B2C3">    )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 2. 确定加载方法（如 from_pretrained）</span></span>
<span data-line=""><span style="color:#A9B2C3">    load_method_name </span><span style="color:#E06C75">=</span><span style="color:#56B6C2"> None</span></span>
<span data-line=""><span style="color:#E06C75">    for</span><span style="color:#A9B2C3"> candidate_name, candidate_class </span><span style="color:#E06C75">in</span><span style="color:#A9B2C3"> class_candidates.items():</span></span>
<span data-line=""><span style="color:#E06C75">        if</span><span style="color:#B57EDC"> issubclass</span><span style="color:#A9B2C3">(class_obj, candidate_class):</span></span>
<span data-line=""><span style="color:#A9B2C3">            load_method_name </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> importable_classes[candidate_name][</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">]  </span><span style="color:#5F6672;font-style:italic"># 通常是 &quot;from_pretrained&quot;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 3. 获取具体的加载方法</span></span>
<span data-line=""><span style="color:#A9B2C3">    load_method </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> _get_load_method(class_obj, load_method_name, </span><span style="color:#C6CCD7">is_dduf</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">dduf_entries </span><span style="color:#E06C75">is</span><span style="color:#E06C75"> not</span><span style="color:#56B6C2"> None</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 4. 执行加载</span></span>
<span data-line=""><span style="color:#A9B2C3">    loaded_sub_model </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> load_method(cached_folder, </span><span style="color:#E06C75">**</span><span style="color:#A9B2C3">loading_kwargs)</span></span></code></pre></figure>
<hr/>
<h3 id="具体步骤解析"><a href="#具体步骤解析" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>具体步骤解析</strong></h3>
<h4 id="1-类对象获取-get_class_obj_and_candidates"><a href="#1-类对象获取-get_class_obj_and_candidates" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>1. 类对象获取 (get_class_obj_and_candidates)</strong></h4>
<ul>
<li><strong>作用</strong>：根据 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>library_name</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_name</span></span></code></span> 动态导入对应的 Python 类。</li>
<li><strong>实现</strong>：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 通过 library_name 定位模块路径</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 例如 library_name=&quot;diffusers&quot;, class_name=&quot;UNet2DConditionModel&quot;</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 会导入 diffusers.models.unets.unet_2d_condition 模块</span></span>
<span data-line=""><span style="color:#A9B2C3">module </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> importlib.import_module(library_name)</span></span>
<span data-line=""><span style="color:#A9B2C3">class_obj </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(module, class_name)  </span><span style="color:#5F6672;font-style:italic"># 获取 UNet2DConditionModel 类</span></span></code></pre></figure>
</li>
</ul>
<h4 id="2-加载方法匹配"><a href="#2-加载方法匹配" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>2. 加载方法匹配</strong></h4>
<ul>
<li><strong>候选类</strong>：<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_candidates</span></span></code></span> 来自 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ALL_IMPORTABLE_CLASSES</span></span></code></span>，包含所有可加载的基类（如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin</span></span></code></span>）。</li>
<li><strong>方法选择</strong>：通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>issubclass</span></span></code></span> 检查 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_obj</span></span></code></span> 是否继承自候选类，从而确定使用哪个基类的加载方法（如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin.from_pretrained</span></span></code></span>）。</li>
</ul>
<h4 id="3-加载方法绑定"><a href="#3-加载方法绑定" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>3. 加载方法绑定</strong></h4>
<ul>
<li><strong>动态绑定</strong>：<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_get_load_method</span></span></code></span> 会将 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_obj.from_pretrained</span></span></code></span> 方法绑定为实际加载函数。</li>
<li><strong>特殊处理</strong>：如果是 DDUF 格式（HuggingFace 的分布式格式），会使用特定的加载逻辑。</li>
</ul>
<h4 id="4-实例化-unet"><a href="#4-实例化-unet" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>4. 实例化 UNet</strong></h4>
<ul>
<li><strong>参数传递</strong>：<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>loading_kwargs</span></span></code></span> 包含模型路径、设备映射、精度设置等。</li>
<li><strong>最终调用</strong>：<!-- -->
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 等效于执行：</span></span>
<span data-line=""><span style="color:#A9B2C3">UNet2DConditionModel.from_pretrained(</span></span>
<span data-line=""><span style="color:#C6CCD7">    pretrained_model_name_or_path</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">cached_folder,</span></span>
<span data-line=""><span style="color:#C6CCD7">    subfolder</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">name,  </span><span style="color:#5F6672;font-style:italic"># 如 &quot;unet&quot;</span></span>
<span data-line=""><span style="color:#C6CCD7">    torch_dtype</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">torch_dtype,</span></span>
<span data-line=""><span style="color:#C6CCD7">    device_map</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">device_map,</span></span>
<span data-line=""><span style="color:#56B6C2">    ...</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
</li>
</ul>
<hr/>
<h3 id="unet2dconditionmodel-的注册机制"><a href="#unet2dconditionmodel-的注册机制" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>UNet2DConditionModel 的注册机制</strong></h3>
<p>在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>diffusers</span></span></code></span> 的全局注册表 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ALL_IMPORTABLE_CLASSES</span></span></code></span> 中，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 被注册为可导入类：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 在某个初始化模块中（如 src/diffusers/__init__.py）</span></span>
<span data-line=""><span style="color:#56B6C2">ALL_IMPORTABLE_CLASSES</span><span style="color:#E06C75"> =</span><span style="color:#A9B2C3"> {</span></span>
<span data-line=""><span style="color:#A9B2C3">    &quot;</span><span style="color:#98C379">UNet2DConditionModel</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">: (</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">diffusers.models.unets.unet_2d_condition</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">UNet2DConditionModel</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">),</span></span>
<span data-line=""><span style="color:#56B6C2">    ...</span></span>
<span data-line=""><span style="color:#A9B2C3">}</span></span></code></pre></figure>
<p>这使得 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_class_obj_and_candidates</span></span></code></span> 能通过名称匹配找到该类。</p>
<hr/>
<h3 id="架构参数如何生效"><a href="#架构参数如何生效" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>架构参数如何生效</strong></h3>
<p>当调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 时：</p>
<ol>
<li><strong>配置加载</strong>：从 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>config.json</span></span></code></span> 中读取 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>down_block_types</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>up_block_types</span></span></code></span> 等参数。</li>
<li><strong>动态构建</strong>：<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel.__init__</span></span></code></span> 根据这些参数，通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_down_block</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_up_block</span></span></code></span> 动态构建网络层。</li>
</ol>
<p>例如：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 根据 config.json 中的 down_block_types 创建下采样块</span></span>
<span data-line=""><span style="color:#A9B2C3">down_block_type </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> &quot;</span><span style="color:#98C379">CrossAttnDownBlock2D</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#A9B2C3">down_block </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> get_down_block(</span></span>
<span data-line=""><span style="color:#A9B2C3">    down_block_type,</span></span>
<span data-line=""><span style="color:#C6CCD7">    num_layers</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">layers_per_block[i],</span></span>
<span data-line=""><span style="color:#C6CCD7">    in_channels</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">input_channel,</span></span>
<span data-line=""><span style="color:#C6CCD7">    out_channels</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">output_channel,</span></span>
<span data-line=""><span style="color:#56B6C2">    ...</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<hr/>
<h3 id="总结流程图"><a href="#总结流程图" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结流程图</strong></h3>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><style data-emotion="css 14awfyb animation-61bdi0">.css-14awfyb{display:inline-block;-webkit-animation:animation-61bdi0 1.4s linear infinite;animation:animation-61bdi0 1.4s linear infinite;color:#1976d2;}@-webkit-keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}</style><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><style data-emotion="css 4ejps8">.css-4ejps8{display:block;}</style><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><style data-emotion="css 13odlrs animation-1o38n3e">.css-13odlrs{stroke:currentColor;stroke-dasharray:80px,200px;stroke-dashoffset:0;-webkit-animation:animation-1o38n3e 1.4s ease-in-out infinite;animation:animation-1o38n3e 1.4s ease-in-out infinite;}@-webkit-keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}@keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}</style><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<p>通过这种动态加载机制，Diffusers 库实现了高度模块化的模型管理，能够灵活支持不同结构的 UNet 变体。</p>
<div class="rounded-md p-2 my-4 bg-sky-100"><div class="text-base font-bold text-sky-500"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="m14.06 9.02.92.92L5.92 19H5v-.92zM17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29m-3.6 3.19L3 17.25V21h3.75L17.81 9.94z"></path></svg> <!-- -->Info-太史公曰<!-- --> </div><div class="m-2"><p>应当不是。正确来说，是上层（ <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>DiffusionPipeline.from_pretained</span></span></code></span> ）从 importable_classes 参数中传入 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ALL_IMPORTABLE_CLASSES</span></span></code></span> ， <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>get_class_obj_and_candidates</span></span></code></span> 中从 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>diffuser</span></span></code></span> 中加载到 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin</span></span></code></span> ，调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin.from_pretrained</span></span></code></span> 才实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 类。</p><p>因此估计往 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>load_sub_model</span></span></code></span> 中传入的是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>diffuser</span></span></code></span> 与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin</span></span></code></span></p></div></div>
<h1 id="q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-"><a href="#q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 解析代码，详解@modeling_utils.py 的 from_pretrained 如何实例化 @unet_2d_condition.py 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> ？</h1>
<think><p>我需要详细解析 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>modeling_utils.py</span></span></code></span> 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法如何实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>。根据提供的代码，我可以看到整个加载流程。</p><p>首先，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin</span></span></code></span> 类的一个类方法，而 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 继承自 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ModelMixin</span></span></code></span>，所以它继承了这个方法。</p><p>加载流程大致如下：</p><ol>
<li>首先获取配置文件和模型文件路径</li>
<li>加载配置文件</li>
<li>使用配置创建模型实例</li>
<li>加载权重到模型中</li>
<li>处理设备映射等高级功能</li>
<li>返回加载好的模型</li>
</ol><p>具体来看，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法首先会确定模型文件的位置，然后加载配置文件。接着，它会使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cls.from_config(config, **unused_kwargs)</span></span></code></span> 创建一个模型实例。这里的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cls</span></span></code></span> 就是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>，所以实际上是调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel.from_config</span></span></code></span> 来创建模型实例。</p><p>然后，它会加载权重文件，并将权重加载到模型中。这个过程通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_load_pretrained_model</span></span></code></span> 方法完成。最后，它会处理设备映射等高级功能，并返回加载好的模型。</p><p>我需要详细解释这个过程，特别是如何从配置创建模型实例，以及如何加载权重到模型中。</p></think>
<h1 id="from_pretrained-如何实例化-unet2dconditionmodel-的详细流程"><a href="#from_pretrained-如何实例化-unet2dconditionmodel-的详细流程" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 如何实例化 UNet2DConditionModel 的详细流程</h1>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>modeling_utils.py</span></span></code></span> 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_pretrained</span></span></code></span> 方法负责实例化 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>，整个过程可分为以下关键步骤：</p>
<h2 id="1-加载配置文件"><a href="#1-加载配置文件" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 加载配置文件</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 确定模型路径并加载配置</span></span>
<span data-line=""><span style="color:#A9B2C3">config_dict </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> cls</span><span style="color:#A9B2C3">.load_config(</span></span>
<span data-line=""><span style="color:#A9B2C3">    pretrained_model_name_or_path,</span></span>
<span data-line=""><span style="color:#C6CCD7">    cache_dir</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">cache_dir,</span></span>
<span data-line=""><span style="color:#C6CCD7">    force_download</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">force_download,</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 其他参数...</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<p>这一步从模型目录或 Hub 加载 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>config.json</span></span></code></span>，包含了 UNet 的所有配置参数（如通道数、注意力头数等）。</p>
<h2 id="2-创建空模型实例"><a href="#2-创建空模型实例" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 创建空模型实例</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 使用上下文管理器创建空模型</span></span>
<span data-line=""><span style="color:#E06C75">with</span><span style="color:#A9B2C3"> ContextManagers(init_contexts):</span></span>
<span data-line=""><span style="color:#A9B2C3">    model </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> cls</span><span style="color:#A9B2C3">.from_config(config, </span><span style="color:#E06C75">**</span><span style="color:#A9B2C3">unused_kwargs)</span></span></code></pre></figure>
<p>这里的关键是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cls.from_config</span></span></code></span>，它调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel.from_config</span></span></code></span> 方法，该方法由 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ConfigMixin</span></span></code></span> 提供。</p>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>from_config</span></span></code></span> 会：</p>
<ul>
<li>解析配置参数</li>
<li>调用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel.__init__</span></span></code></span> 构造函数</li>
<li>创建所有子模块（如下采样块、上采样块、注意力层等）</li>
</ul>
<h2 id="3-加载权重文件"><a href="#3-加载权重文件" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 加载权重文件</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 加载权重文件</span></span>
<span data-line=""><span style="color:#A9B2C3">state_dict </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> load_state_dict(resolved_model_file[</span><span style="color:#56B6C2">0</span><span style="color:#A9B2C3">], </span><span style="color:#C6CCD7">disable_mmap</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">disable_mmap, </span><span style="color:#C6CCD7">dduf_entries</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">dduf_entries)</span></span></code></pre></figure>
<p>这一步加载预训练权重文件（如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>diffusion_pytorch_model.bin</span></span></code></span> 或 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>.safetensors</span></span></code></span>）。</p>
<h2 id="4-将权重加载到模型中"><a href="#4-将权重加载到模型中" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. 将权重加载到模型中</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">model, missing_keys, unexpected_keys, mismatched_keys, offload_index, error_msgs </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> cls</span><span style="color:#A9B2C3">._load_pretrained_model(</span></span>
<span data-line=""><span style="color:#A9B2C3">    model,</span></span>
<span data-line=""><span style="color:#A9B2C3">    state_dict,</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 其他参数...</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>_load_pretrained_model</span></span></code></span> 方法负责：</p>
<ul>
<li>将权重映射到模型参数</li>
<li>处理可能的形状不匹配</li>
<li>支持低内存加载</li>
<li>处理量化和设备映射</li>
</ul>
<h2 id="5-设备分配和后处理"><a href="#5-设备分配和后处理" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>5. 设备分配和后处理</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 如果指定了设备映射，将模型分配到不同设备</span></span>
<span data-line=""><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> device_map </span><span style="color:#E06C75">is</span><span style="color:#E06C75"> not</span><span style="color:#56B6C2"> None</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    dispatch_model(model, </span><span style="color:#E06C75">**</span><span style="color:#A9B2C3">device_map_kwargs)</span></span></code></pre></figure>
<p>这一步处理模型在多 GPU 或 CPU/GPU 混合环境下的分配。</p>
<h2 id="6-返回实例化的模型"><a href="#6-返回实例化的模型" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>6. 返回实例化的模型</h2>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">model.eval()  </span><span style="color:#5F6672;font-style:italic"># 设置为评估模式</span></span>
<span data-line=""><span style="color:#E06C75">return</span><span style="color:#A9B2C3"> model</span></span></code></pre></figure>
<p>最终返回完全加载好的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 实例。</p>
<h2 id="关键实现细节"><a href="#关键实现细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>关键实现细节</h2>
<ol>
<li>
<p><strong>动态类型处理</strong>：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> torch_dtype </span><span style="color:#E06C75">is</span><span style="color:#E06C75"> not</span><span style="color:#56B6C2"> None</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    dtype_orig </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> cls</span><span style="color:#A9B2C3">._set_default_torch_dtype(torch_dtype)</span></span></code></pre></figure>
<p>支持不同精度（如 fp16、bf16）的模型加载</p>
</li>
<li>
<p><strong>低内存加载</strong>：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> low_cpu_mem_usage:</span></span>
<span data-line=""><span style="color:#A9B2C3">    init_contexts.append(accelerate.init_empty_weights())</span></span></code></pre></figure>
<p>通过 accelerate 库实现大模型的高效加载</p>
</li>
<li>
<p><strong>权重修复</strong>：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">model._fix_state_dict_keys_on_load(state_dict)</span></span></code></pre></figure>
<p>处理不同版本模型间的键名差异</p>
</li>
<li>
<p><strong>设备映射</strong>：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#A9B2C3">device_map </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> _determine_device_map(model, device_map, max_memory, </span><span style="color:#56B6C2">...</span><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<p>智能分配模型层到不同设备</p>
</li>
</ol>
<p>整个过程实现了从预训练权重到可用模型实例的无缝转换，同时处理了各种高级功能如设备管理、精度控制和内存优化。</p>
<h1 id="q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构"><a href="#q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细解释 @unet_2d_condition.py 中 UNet2DConditionModel 的结构</h1>
<think><p>嗯，用户想让我详细解释 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>unet_2d_condition.py</span></span></code></span> 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 结构。首先，我需要回忆一下 UNet 的基本结构，特别是 Stable Diffusion 中的 UNet。Stable Diffusion 的 UNet 是一个条件模型，结合了文本嵌入作为输入，所以这个 UNet2DConditionModel 应该是在传统 UNet 的基础上增加了对条件输入的处理，比如文本嵌入或时间步信息。</p><p>接下来，我需要考虑用户可能的背景。用户可能在使用或修改 Diffusers 库，或者在尝试理解 Stable Diffusion 的工作原理。他们可能遇到了问题，比如模型加载错误，或者想自定义 UNet 的结构，因此需要了解其内部组件。用户可能已经看过代码，但需要更清晰的解释，特别是各个模块的作用和连接方式。</p><p>我需要检查用户提供的代码片段，特别是<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span>的<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>__init__</span></span></code></span>方法，看看有哪些组件被初始化。比如，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>conv_in</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>time_embedding</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>down_blocks</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>mid_block</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>up_blocks</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>conv_out</span></span></code></span>等。这些部分对应了 UNet 的不同阶段，下采样、中间层、上采样等。</p><p>然后，我需要考虑如何将这些组件组织成一个连贯的结构解释。可能需要分块讲解，比如输入处理、时间嵌入、下采样块、中间块、上采样块、输出处理等。同时，条件输入（如文本嵌入）是如何被整合到模型中的，比如通过交叉注意力机制。</p><p>另外，用户可能对某些参数或配置选项感兴趣，比如<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>attention_head_dim</span></span></code></span>、<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cross_attention_dim</span></span></code></span>等，这些参数如何影响模型结构。需要解释这些参数的作用，以及它们在模型中的具体应用位置。</p><p>还要注意代码中的一些特定处理，比如<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>class_embeddings_concat</span></span></code></span>如何处理类别嵌入，<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>resnet_time_scale_shift</span></span></code></span>的不同模式对残差块的影响，以及<span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>attention_type</span></span></code></span>的选择（如默认的交叉注意力或其他类型）。</p><p>最后，可能需要提供一个结构图或流程图，帮助用户更直观地理解数据在模型中的流动路径，特别是条件信息如何在不同层中被整合。如果用户需要进一步的代码示例或调试帮助，也需要在解释中提及可能的常见问题或配置错误。</p></think>
<p>以下是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 的详细结构解析，该模型是 Stable Diffusion 的核心组件，负责噪声预测和条件控制：</p>
<hr/>
<h3 id="整体架构"><a href="#整体架构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>整体架构</strong></h3>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<hr/>
<h3 id="核心组件"><a href="#核心组件" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>核心组件</strong></h3>
<h4 id="1-输入处理"><a href="#1-输入处理" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 输入处理</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.conv_in </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(</span></span>
<span data-line=""><span style="color:#A9B2C3">    in_channels,</span></span>
<span data-line=""><span style="color:#A9B2C3">    block_out_channels[</span><span style="color:#56B6C2">0</span><span style="color:#A9B2C3">],</span></span>
<span data-line=""><span style="color:#C6CCD7">    kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">    padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<ul>
<li>作用：将输入图像（latent space）映射到初始特征空间</li>
<li>参数：<!-- -->
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>in_channels</span></span></code></span>：输入通道数（通常为 4）</li>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>block_out_channels[0]</span></span></code></span>：首层输出通道数（通常为 320）</li>
</ul>
</li>
</ul>
<hr/>
<h4 id="2-时间嵌入系统"><a href="#2-时间嵌入系统" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 时间嵌入系统</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.time_embedding </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> TimestepEmbedding(</span></span>
<span data-line=""><span style="color:#A9B2C3">    timestep_input_dim,  </span><span style="color:#5F6672;font-style:italic"># 时间步编码维度</span></span>
<span data-line=""><span style="color:#A9B2C3">    time_embed_dim,       </span><span style="color:#5F6672;font-style:italic"># 嵌入维度（通常1280）</span></span>
<span data-line=""><span style="color:#C6CCD7">    act_fn</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">act_fn         </span><span style="color:#5F6672;font-style:italic"># 激活函数（如silu）</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<ul>
<li>功能：将时间步信息编码为条件向量</li>
<li>流程：<!-- -->
<ol>
<li>通过正弦位置编码生成时间特征</li>
<li>经过全连接层和非线性激活</li>
<li>与文本嵌入等条件信息融合</li>
</ol>
</li>
</ul>
<hr/>
<h4 id="3-下采样模块"><a href="#3-下采样模块" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 下采样模块</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.down_blocks </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.ModuleList([</span></span>
<span data-line=""><span style="color:#A9B2C3">    DownBlock2D(</span></span>
<span data-line=""><span style="color:#C6CCD7">        in_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">320</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        out_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">320</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        temb_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        num_layers</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">2</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        resnet_eps</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1e-5</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        resnet_act_fn</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">silu</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        cross_attention_dim</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">768</span><span style="color:#5F6672;font-style:italic">  # 文本嵌入维度</span></span>
<span data-line=""><span style="color:#A9B2C3">    ),</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 其他下采样块...</span></span>
<span data-line=""><span style="color:#A9B2C3">])</span></span></code></pre></figure>
<ul>
<li>结构特点：<!-- -->
<ul>
<li>每个下采样块包含：<!-- -->
<ul>
<li>多个残差块（ResNet）</li>
<li>交叉注意力层（处理文本条件）</li>
<li>可能的降采样卷积</li>
</ul>
</li>
<li>典型配置：4 个下采样块，通道数逐级增加（320→640→1280→1280）</li>
</ul>
</li>
</ul>
<hr/>
<h4 id="4-中间模块"><a href="#4-中间模块" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>4. 中间模块</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.mid_block </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> UNetMidBlock2DCrossAttn(</span></span>
<span data-line=""><span style="color:#C6CCD7">    in_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">    temb_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">    resnet_eps</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1e-5</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">    resnet_act_fn</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">silu</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">    attn_num_head_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span></span>
<span data-line=""><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<ul>
<li>核心组成：<!-- -->
<ul>
<li>残差块</li>
<li>自注意力机制</li>
<li>交叉注意力机制</li>
</ul>
</li>
<li>作用：在最低分辨率层进行全局特征整合</li>
</ul>
<hr/>
<h4 id="5-上采样模块"><a href="#5-上采样模块" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>5. 上采样模块</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.up_blocks </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.ModuleList([</span></span>
<span data-line=""><span style="color:#A9B2C3">    UpBlock2D(</span></span>
<span data-line=""><span style="color:#C6CCD7">        in_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        prev_output_channel</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        out_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        temb_channels</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1280</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        num_layers</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        resnet_eps</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1e-5</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">        resnet_act_fn</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">silu</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#A9B2C3">    ),</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 其他上采样块...</span></span>
<span data-line=""><span style="color:#A9B2C3">])</span></span></code></pre></figure>
<ul>
<li>关键特性：<!-- -->
<ul>
<li>包含残差块和交叉注意力层</li>
<li>通过跳跃连接融合下采样特征</li>
<li>使用转置卷积或插值进行上采样</li>
</ul>
</li>
</ul>
<hr/>
<h4 id="6-输出处理"><a href="#6-输出处理" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>6. 输出处理</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.conv_norm_out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">320</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.conv_act </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.SiLU()</span></span>
<span data-line=""><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.conv_out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(</span><span style="color:#56B6C2">320</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">4</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span></code></pre></figure>
<ul>
<li>流程：<!-- -->
<ol>
<li>归一化处理</li>
<li>激活函数</li>
<li>最终卷积将特征映射到输出空间（4 通道）</li>
</ol>
</li>
</ul>
<hr/>
<h3 id="条件控制机制"><a href="#条件控制机制" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>条件控制机制</strong></h3>
<h4 id="交叉注意力层"><a href="#交叉注意力层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>交叉注意力层</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> CrossAttention</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">query_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_q </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(query_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_k </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_v </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        q </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_q(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        k </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_k(context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        v </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_v(context)</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 计算注意力权重...</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> output</span></span></code></pre></figure>
<ul>
<li>作用：将文本嵌入（context）注入到图像特征中</li>
<li>位置：每个下采样和上采样块中都包含该层</li>
</ul>
<hr/>
<h3 id="关键参数说明"><a href="#关键参数说明" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>关键参数说明</strong></h3>
<table><thead><tr><th>参数</th><th>典型值</th><th>作用</th></tr></thead><tbody><tr><td><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>cross_attention_dim</span></span></code></span></td><td>768</td><td>文本嵌入的维度（CLIP 文本编码器输出维度）</td></tr><tr><td><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>attention_head_dim</span></span></code></span></td><td>8/16</td><td>注意力头的维度</td></tr><tr><td><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>layers_per_block</span></span></code></span></td><td>2</td><td>每个块中的残差层数</td></tr><tr><td><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>num_attention_heads</span></span></code></span></td><td>8</td><td>注意力头数量</td></tr><tr><td><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>resnet_time_scale_shift</span></span></code></span></td><td>&quot;default&quot;</td><td>时间条件注入方式（add/scale）</td></tr></tbody></table>
<hr/>
<h3 id="数据流动示例"><a href="#数据流动示例" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>数据流动示例</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">timestep</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">encoder_hidden_states</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 1. 输入处理</span></span>
<span data-line=""><span style="color:#A9B2C3">    x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_in(x)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 2. 时间嵌入</span></span>
<span data-line=""><span style="color:#A9B2C3">    t_emb </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.time_embedding(timestep)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 3. 下采样</span></span>
<span data-line=""><span style="color:#A9B2C3">    down_samples </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> []</span></span>
<span data-line=""><span style="color:#E06C75">    for</span><span style="color:#A9B2C3"> down_block </span><span style="color:#E06C75">in</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.down_blocks:</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> down_block(x, t_emb, encoder_hidden_states)</span></span>
<span data-line=""><span style="color:#A9B2C3">        down_samples.append(x)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 4. 中间处理</span></span>
<span data-line=""><span style="color:#A9B2C3">    x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.mid_block(x, t_emb, encoder_hidden_states)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 5. 上采样</span></span>
<span data-line=""><span style="color:#E06C75">    for</span><span style="color:#A9B2C3"> up_block </span><span style="color:#E06C75">in</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.up_blocks:</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> up_block(x, down_samples.pop(), t_emb, encoder_hidden_states)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 6. 输出</span></span>
<span data-line=""><span style="color:#A9B2C3">    x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_norm_out(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">    x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_act(x)</span></span>
<span data-line=""><span style="color:#E06C75">    return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_out(x)</span></span></code></pre></figure>
<p>如果需要更详细的某个组件解析（如下采样块的具体实现），可以进一步展开说明。</p>
<h1 id="q-详细解释下采样快的细节"><a href="#q-详细解释下采样快的细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细解释下采样快的细节</h1>
<p>好的，下面是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中下采样块的详细结构和实现细节：</p>
<hr/>
<h3 id="下采样块概述"><a href="#下采样块概述" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>下采样块概述</strong></h3>
<p>下采样块的主要功能是逐步降低特征图的空间分辨率，同时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。每个下采样块通常包含多个残差块和一个降采样操作。</p>
<hr/>
<h3 id="下采样块的结构"><a href="#下采样块的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>下采样块的结构</strong></h3>
<h4 id="1-残差块resnet-block"><a href="#1-残差块resnet-block" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 残差块（ResNet Block）</h4>
<p>每个下采样块包含多个残差块，负责特征提取和非线性变换。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> ResNetBlock</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, in_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act1 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(in_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, out_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act2 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(out_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.temb_proj </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(temb_channels, out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm1(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act1(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv1(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv2(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 时间嵌入注入</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">+=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.temb_proj(temb)[:, :, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> h </span><span style="color:#E06C75">+</span><span style="color:#A9B2C3"> x  </span><span style="color:#5F6672;font-style:italic"># 残差连接</span></span></code></pre></figure>
<ul>
<li><strong>特征归一化</strong>：使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>GroupNorm</span></span></code></span> 进行归一化，稳定训练过程。</li>
<li><strong>激活函数</strong>：通常使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>SiLU</span></span></code></span> 或 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ReLU</span></span></code></span>。</li>
<li><strong>卷积层</strong>：两个 3x3 卷积层，保持特征图大小不变。</li>
<li><strong>时间嵌入</strong>：通过全连接层将时间嵌入注入到特征图中。</li>
</ul>
<hr/>
<h4 id="2-交叉注意力层"><a href="#2-交叉注意力层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 交叉注意力层</h4>
<p>在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> CrossAttention</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">query_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_q </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(query_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_k </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_v </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.scale </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> query_dim </span><span style="color:#E06C75">**</span><span style="color:#E06C75"> -</span><span style="color:#56B6C2">0.5</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        q </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_q(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        k </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_k(context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        v </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_v(context)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqd,bkd-&gt;bqk</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, q, k) </span><span style="color:#E06C75">*</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.scale</span></span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> attn_weights.softmax(</span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqk,bvd-&gt;bqd</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, attn_weights, v)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> out</span></span></code></pre></figure>
<ul>
<li><strong>查询、键、值</strong>：通过线性变换生成查询、键和值向量。</li>
<li><strong>注意力计算</strong>：使用缩放点积注意力机制。</li>
<li><strong>条件注入</strong>：将文本嵌入等条件信息注入到特征图中。</li>
</ul>
<hr/>
<h4 id="3-降采样操作"><a href="#3-降采样操作" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 降采样操作</h4>
<p>通常使用卷积或池化操作来降低特征图的空间分辨率。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> Downsample</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(in_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">stride</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">2</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv(x)</span></span></code></pre></figure>
<ul>
<li><strong>卷积降采样</strong>：通过步长为 2 的卷积实现降采样，减少特征图的宽高。</li>
<li><strong>通道数增加</strong>：通常在降采样时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。</li>
</ul>
<hr/>
<h3 id="下采样块的完整实现"><a href="#下采样块的完整实现" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>下采样块的完整实现</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> DownBlock2D</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">num_layers</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">cross_attention_dim</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.resnets </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.ModuleList([</span></span>
<span data-line=""><span style="color:#A9B2C3">            ResNetBlock(in_channels </span><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> i </span><span style="color:#E06C75">==</span><span style="color:#56B6C2"> 0</span><span style="color:#E06C75"> else</span><span style="color:#A9B2C3"> out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)</span></span>
<span data-line=""><span style="color:#E06C75">            for</span><span style="color:#A9B2C3"> i </span><span style="color:#E06C75">in</span><span style="color:#B57EDC"> range</span><span style="color:#A9B2C3">(num_layers)</span></span>
<span data-line=""><span style="color:#A9B2C3">        ])</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.attention </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> CrossAttention(out_channels, cross_attention_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.downsample </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> Downsample(out_channels, out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E06C75">        for</span><span style="color:#A9B2C3"> resnet </span><span style="color:#E06C75">in</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.resnets:</span></span>
<span data-line=""><span style="color:#A9B2C3">            x </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> resnet(x, temb)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.attention(x, context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.downsample(x)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> x</span></span></code></pre></figure>
<ul>
<li><strong>残差块</strong>：多个残差块串联，进行特征提取。</li>
<li><strong>交叉注意力</strong>：在特征提取后注入条件信息。</li>
<li><strong>降采样</strong>：降低特征图的空间分辨率。</li>
</ul>
<hr/>
<h3 id="总结-3"><a href="#总结-3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结</strong></h3>
<p>下采样块在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将输入图像的特征压缩到更低的分辨率，为后续的中间块和上采样块提供丰富的特征信息。</p>
<h1 id="q-详细讲解上采样块的细节"><a href="#q-详细讲解上采样块的细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细讲解上采样块的细节</h1>
<p>好的，下面是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中上采样块的详细结构和实现细节：</p>
<hr/>
<h3 id="上采样块概述"><a href="#上采样块概述" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>上采样块概述</strong></h3>
<p>上采样块的主要功能是逐步恢复特征图的空间分辨率，同时结合下采样块的特征，通过跳跃连接（skip connections）实现特征的融合。每个上采样块通常包含多个残差块和一个上采样操作。</p>
<hr/>
<h3 id="上采样块的结构"><a href="#上采样块的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>上采样块的结构</strong></h3>
<h4 id="1-残差块resnet-block-1"><a href="#1-残差块resnet-block-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 残差块（ResNet Block）</h4>
<p>每个上采样块包含多个残差块，负责特征提取和非线性变换。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> ResNetBlock</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, in_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act1 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(in_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, out_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act2 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(out_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.temb_proj </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(temb_channels, out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm1(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act1(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv1(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv2(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 时间嵌入注入</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">+=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.temb_proj(temb)[:, :, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> h </span><span style="color:#E06C75">+</span><span style="color:#A9B2C3"> x  </span><span style="color:#5F6672;font-style:italic"># 残差连接</span></span></code></pre></figure>
<ul>
<li><strong>特征归一化</strong>：使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>GroupNorm</span></span></code></span> 进行归一化，稳定训练过程。</li>
<li><strong>激活函数</strong>：通常使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>SiLU</span></span></code></span> 或 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ReLU</span></span></code></span>。</li>
<li><strong>卷积层</strong>：两个 3x3 卷积层，保持特征图大小不变。</li>
<li><strong>时间嵌入</strong>：通过全连接层将时间嵌入注入到特征图中。</li>
</ul>
<hr/>
<h4 id="2-交叉注意力层-1"><a href="#2-交叉注意力层-1" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 交叉注意力层</h4>
<p>在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> CrossAttention</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">query_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_q </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(query_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_k </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_v </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.scale </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> query_dim </span><span style="color:#E06C75">**</span><span style="color:#E06C75"> -</span><span style="color:#56B6C2">0.5</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        q </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_q(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        k </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_k(context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        v </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_v(context)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqd,bkd-&gt;bqk</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, q, k) </span><span style="color:#E06C75">*</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.scale</span></span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> attn_weights.softmax(</span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqk,bvd-&gt;bqd</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, attn_weights, v)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> out</span></span></code></pre></figure>
<ul>
<li><strong>查询、键、值</strong>：通过线性变换生成查询、键和值向量。</li>
<li><strong>注意力计算</strong>：使用缩放点积注意力机制。</li>
<li><strong>条件注入</strong>：将文本嵌入等条件信息注入到特征图中。</li>
</ul>
<hr/>
<h4 id="3-上采样操作"><a href="#3-上采样操作" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 上采样操作</h4>
<p>通常使用转置卷积或插值操作来增加特征图的空间分辨率。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> Upsample</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.ConvTranspose2d(in_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">stride</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">2</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">output_padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv(x)</span></span></code></pre></figure>
<ul>
<li><strong>转置卷积上采样</strong>：通过转置卷积实现上采样，增加特征图的宽高。</li>
<li><strong>通道数减少</strong>：通常在上采样时减少通道数，以便恢复到输入图像的通道数。</li>
</ul>
<hr/>
<h3 id="上采样块的完整实现"><a href="#上采样块的完整实现" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>上采样块的完整实现</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> UpBlock2D</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">prev_output_channel</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">num_layers</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">cross_attention_dim</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.resnets </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.ModuleList([</span></span>
<span data-line=""><span style="color:#A9B2C3">            ResNetBlock(in_channels </span><span style="color:#E06C75">if</span><span style="color:#A9B2C3"> i </span><span style="color:#E06C75">==</span><span style="color:#56B6C2"> 0</span><span style="color:#E06C75"> else</span><span style="color:#A9B2C3"> out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)</span></span>
<span data-line=""><span style="color:#E06C75">            for</span><span style="color:#A9B2C3"> i </span><span style="color:#E06C75">in</span><span style="color:#B57EDC"> range</span><span style="color:#A9B2C3">(num_layers)</span></span>
<span data-line=""><span style="color:#A9B2C3">        ])</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.attention </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> CrossAttention(out_channels, cross_attention_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.upsample </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> Upsample(out_channels, out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">res_samples</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E06C75">        for</span><span style="color:#A9B2C3"> resnet </span><span style="color:#E06C75">in</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.resnets:</span></span>
<span data-line=""><span style="color:#A9B2C3">            x </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> resnet(x, temb)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.attention(x, context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.upsample(x)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> x</span></span></code></pre></figure>
<ul>
<li><strong>残差块</strong>：多个残差块串联，进行特征提取。</li>
<li><strong>交叉注意力</strong>：在特征提取后注入条件信息。</li>
<li><strong>上采样</strong>：增加特征图的空间分辨率。</li>
</ul>
<hr/>
<h3 id="总结-4"><a href="#总结-4" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结</strong></h3>
<p>上采样块在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将特征图的分辨率恢复到输入图像的大小，并结合下采样块的特征实现特征的融合。</p>
<h1 id="q-详细讲解中间模块细节"><a href="#q-详细讲解中间模块细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细讲解中间模块细节</h1>
<p>好的，下面是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中中间模块（Mid Block）的详细结构和实现细节：</p>
<hr/>
<h3 id="中间模块概述"><a href="#中间模块概述" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>中间模块概述</strong></h3>
<p>中间模块位于下采样和上采样块之间，负责在最低分辨率的特征图上进行全局特征整合。它通常包含残差块和注意力机制，以便在特征图的最小空间维度上进行复杂的特征交互。</p>
<hr/>
<h3 id="中间模块的结构"><a href="#中间模块的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>中间模块的结构</strong></h3>
<h4 id="1-残差块resnet-block-2"><a href="#1-残差块resnet-block-2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 残差块（ResNet Block）</h4>
<p>中间模块通常包含一个或多个残差块，用于特征提取和非线性变换。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> ResNetBlock</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, in_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act1 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(in_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.norm2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, out_channels, </span><span style="color:#C6CCD7">eps</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">resnet_eps)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act2 </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, resnet_act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(out_channels, out_channels, </span><span style="color:#C6CCD7">kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.temb_proj </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(temb_channels, out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm1(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act1(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv1(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.norm2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act2(h)</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv2(h)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 时间嵌入注入</span></span>
<span data-line=""><span style="color:#A9B2C3">        h </span><span style="color:#E06C75">+=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.temb_proj(temb)[:, :, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> h </span><span style="color:#E06C75">+</span><span style="color:#A9B2C3"> x  </span><span style="color:#5F6672;font-style:italic"># 残差连接</span></span></code></pre></figure>
<ul>
<li><strong>特征归一化</strong>：使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>GroupNorm</span></span></code></span> 进行归一化，稳定训练过程。</li>
<li><strong>激活函数</strong>：通常使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>SiLU</span></span></code></span> 或 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ReLU</span></span></code></span>。</li>
<li><strong>卷积层</strong>：两个 3x3 卷积层，保持特征图大小不变。</li>
<li><strong>时间嵌入</strong>：通过全连接层将时间嵌入注入到特征图中。</li>
</ul>
<hr/>
<h4 id="2-自注意力层"><a href="#2-自注意力层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 自注意力层</h4>
<p>自注意力层用于在特征图的最小空间维度上进行全局特征交互。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> SelfAttention</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_qkv </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(dim, dim </span><span style="color:#E06C75">*</span><span style="color:#56B6C2"> 3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">bias</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">False</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(dim, dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.scale </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> dim </span><span style="color:#E06C75">**</span><span style="color:#E06C75"> -</span><span style="color:#56B6C2">0.5</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        b, n, _, h </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> *</span><span style="color:#A9B2C3">x.shape, </span><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.heads</span></span>
<span data-line=""><span style="color:#A9B2C3">        qkv </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_qkv(x).chunk(</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#A9B2C3">        q, k, v </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> map</span><span style="color:#A9B2C3">(</span><span style="color:#61AFEF">lambda</span><span style="color:#C6CCD7"> t</span><span style="color:#A9B2C3">: t.reshape(b, n, h, </span><span style="color:#E06C75">-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">).transpose(</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">2</span><span style="color:#A9B2C3">), qkv)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        dots </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bhid,bhjd-&gt;bhij</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, q, k) </span><span style="color:#E06C75">*</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.scale</span></span>
<span data-line=""><span style="color:#A9B2C3">        attn </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> dots.softmax(</span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bhij,bhjd-&gt;bhid</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, attn, v)</span></span>
<span data-line=""><span style="color:#A9B2C3">        out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> out.transpose(</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">, </span><span style="color:#56B6C2">2</span><span style="color:#A9B2C3">).reshape(b, n, </span><span style="color:#E06C75">-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_out(out)</span></span></code></pre></figure>
<ul>
<li><strong>查询、键、值</strong>：通过线性变换生成查询、键和值向量。</li>
<li><strong>注意力计算</strong>：使用缩放点积注意力机制。</li>
<li><strong>全局特征交互</strong>：在特征图的最小空间维度上进行全局特征交互。</li>
</ul>
<hr/>
<h4 id="3-交叉注意力层"><a href="#3-交叉注意力层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>3. 交叉注意力层</h4>
<p>在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> CrossAttention</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">query_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">8</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_q </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(query_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_k </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.to_v </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(context_dim, query_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.scale </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> query_dim </span><span style="color:#E06C75">**</span><span style="color:#E06C75"> -</span><span style="color:#56B6C2">0.5</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">context</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        q </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_q(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        k </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_k(context)</span></span>
<span data-line=""><span style="color:#A9B2C3">        v </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.to_v(context)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqd,bkd-&gt;bqk</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, q, k) </span><span style="color:#E06C75">*</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.scale</span></span>
<span data-line=""><span style="color:#A9B2C3">        attn_weights </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> attn_weights.softmax(</span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">        out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.einsum(</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">bqk,bvd-&gt;bqd</span><span style="color:#A9B2C3">&#x27;</span><span style="color:#A9B2C3">, attn_weights, v)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> out</span></span></code></pre></figure>
<ul>
<li><strong>查询、键、值</strong>：通过线性变换生成查询、键和值向量。</li>
<li><strong>注意力计算</strong>：使用缩放点积注意力机制。</li>
<li><strong>条件注入</strong>：将文本嵌入等条件信息注入到特征图中。</li>
</ul>
<hr/>
<h3 id="中间模块的完整实现"><a href="#中间模块的完整实现" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>中间模块的完整实现</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> UNetMidBlock2DCrossAttn</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_eps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">resnet_act_fn</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">attn_num_head_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.resnet1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.attn1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> SelfAttention(in_channels, </span><span style="color:#C6CCD7">heads</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">attn_num_head_channels)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.cross_attn </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> CrossAttention(in_channels, in_channels)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.resnet2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">temb</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">encoder_hidden_states</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">attention_mask</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">cross_attention_kwargs</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.resnet1(x, temb)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.attn1(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.cross_attn(x, encoder_hidden_states)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.resnet2(x, temb)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> x</span></span></code></pre></figure>
<ul>
<li><strong>残差块</strong>：两个残差块串联，进行特征提取。</li>
<li><strong>自注意力</strong>：在特征图的最小空间维度上进行全局特征交互。</li>
<li><strong>交叉注意力</strong>：在特征提取后注入条件信息。</li>
</ul>
<hr/>
<h3 id="总结-5"><a href="#总结-5" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结</strong></h3>
<p>中间模块在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，通过多层次的特征提取和注意力机制，在最低分辨率的特征图上进行全局特征整合，为上采样块提供丰富的特征信息。</p>
<h1 id="q-详细讲解输入处理与输出处理模块细节"><a href="#q-详细讲解输入处理与输出处理模块细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细讲解输入处理与输出处理模块细节</h1>
<p>好的，下面是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中输入处理和输出处理模块的详细结构和实现细节：</p>
<hr/>
<h3 id="输入处理模块"><a href="#输入处理模块" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>输入处理模块</strong></h3>
<p>输入处理模块的主要功能是将输入的图像特征（通常是潜在空间表示）映射到模型的初始特征空间。</p>
<h4 id="1-输入卷积层"><a href="#1-输入卷积层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 输入卷积层</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> InputProcessing</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv_in </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(</span></span>
<span data-line=""><span style="color:#A9B2C3">            in_channels,</span></span>
<span data-line=""><span style="color:#A9B2C3">            out_channels,</span></span>
<span data-line=""><span style="color:#C6CCD7">            kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">            padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span></span>
<span data-line=""><span style="color:#A9B2C3">        )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_in(x)</span></span></code></pre></figure>
<ul>
<li><strong>卷积层</strong>：使用一个 3x3 的卷积层，将输入的通道数映射到模型的初始通道数。</li>
<li><strong>作用</strong>：将输入图像的特征映射到更高维度的特征空间，以便后续的特征提取。</li>
</ul>
<hr/>
<h3 id="输出处理模块"><a href="#输出处理模块" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>输出处理模块</strong></h3>
<p>输出处理模块的主要功能是将模型的最终特征图映射回输入的通道数，通常是生成图像的潜在空间表示。</p>
<h4 id="1-输出卷积层"><a href="#1-输出卷积层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 输出卷积层</h4>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> OutputProcessing</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv_norm_out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.GroupNorm(</span><span style="color:#56B6C2">32</span><span style="color:#A9B2C3">, in_channels)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv_act </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.SiLU()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.conv_out </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Conv2d(</span></span>
<span data-line=""><span style="color:#A9B2C3">            in_channels,</span></span>
<span data-line=""><span style="color:#A9B2C3">            out_channels,</span></span>
<span data-line=""><span style="color:#C6CCD7">            kernel_size</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">3</span><span style="color:#A9B2C3">,</span></span>
<span data-line=""><span style="color:#C6CCD7">            padding</span><span style="color:#E06C75">=</span><span style="color:#56B6C2">1</span></span>
<span data-line=""><span style="color:#A9B2C3">        )</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_norm_out(x)</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_act(x)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.conv_out(x)</span></span></code></pre></figure>
<ul>
<li><strong>归一化层</strong>：使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>GroupNorm</span></span></code></span> 对特征图进行归一化，稳定输出。</li>
<li><strong>激活函数</strong>：使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>SiLU</span></span></code></span> 激活函数，增加非线性。</li>
<li><strong>卷积层</strong>：使用一个 3x3 的卷积层，将特征图映射回输入的通道数。</li>
</ul>
<hr/>
<h3 id="输入与输出处理的完整实现"><a href="#输入与输出处理的完整实现" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>输入与输出处理的完整实现</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> UNet2DConditionModel</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">in_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">out_channels</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">block_out_channels</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 输入处理</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.input_processing </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> InputProcessing(in_channels, block_out_channels[</span><span style="color:#56B6C2">0</span><span style="color:#A9B2C3">])</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 其他模块（下采样、中间、上采样）</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 输出处理</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.output_processing </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> OutputProcessing(block_out_channels[</span><span style="color:#E06C75">-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">], out_channels)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 输入处理</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.input_processing(x)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 其他模块处理</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 输出处理</span></span>
<span data-line=""><span style="color:#A9B2C3">        x </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.output_processing(x)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> x</span></span></code></pre></figure>
<ul>
<li><strong>输入处理</strong>：将输入图像的特征映射到模型的初始特征空间。</li>
<li><strong>输出处理</strong>：将模型的最终特征图映射回输入的通道数。</li>
</ul>
<hr/>
<h3 id="总结-6"><a href="#总结-6" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结</strong></h3>
<p>输入处理和输出处理模块在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，分别负责将输入图像的特征映射到模型的初始特征空间，以及将模型的最终特征图映射回输入的通道数。这两个模块通过简单的卷积操作实现了特征的维度变换，为模型的特征提取和生成提供了基础。</p>
<h1 id="q-详细讲解时间嵌入系统的细节"><a href="#q-详细讲解时间嵌入系统的细节" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Q: 详细讲解时间嵌入系统的细节</h1>
<p>时间嵌入系统在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，它将时间步信息编码为条件向量，以便在模型的各个阶段中注入时间信息。下面是时间嵌入系统的详细结构和实现细节：</p>
<hr/>
<h3 id="时间嵌入系统概述"><a href="#时间嵌入系统概述" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>时间嵌入系统概述</strong></h3>
<p>时间嵌入系统的主要功能是将时间步（timestep）信息转换为高维向量，这些向量在模型的残差块中被用作条件信息，以指导模型在不同时间步的特征提取和生成过程。</p>
<hr/>
<h3 id="时间嵌入系统的结构"><a href="#时间嵌入系统的结构" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>时间嵌入系统的结构</strong></h3>
<h4 id="1-正弦位置编码"><a href="#1-正弦位置编码" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>1. 正弦位置编码</h4>
<p>时间嵌入系统通常使用正弦位置编码来生成初始时间特征。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">def</span><span style="color:#B57EDC"> get_timestep_embedding</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">timesteps</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">embedding_dim</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">    half_dim </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> embedding_dim </span><span style="color:#E06C75">//</span><span style="color:#56B6C2"> 2</span></span>
<span data-line=""><span style="color:#A9B2C3">    emb </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> math.log(</span><span style="color:#56B6C2">10000</span><span style="color:#A9B2C3">) </span><span style="color:#E06C75">/</span><span style="color:#A9B2C3"> (half_dim </span><span style="color:#E06C75">-</span><span style="color:#56B6C2"> 1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#A9B2C3">    emb </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.exp(torch.arange(half_dim, </span><span style="color:#C6CCD7">dtype</span><span style="color:#E06C75">=</span><span style="color:#A9B2C3">torch.float32) </span><span style="color:#E06C75">*</span><span style="color:#E06C75"> -</span><span style="color:#A9B2C3">emb)</span></span>
<span data-line=""><span style="color:#A9B2C3">    emb </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> timesteps[:, </span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">] </span><span style="color:#E06C75">*</span><span style="color:#A9B2C3"> emb[</span><span style="color:#56B6C2">None</span><span style="color:#A9B2C3">, :]</span></span>
<span data-line=""><span style="color:#A9B2C3">    emb </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> torch.cat([torch.sin(emb), torch.cos(emb)], </span><span style="color:#C6CCD7">dim</span><span style="color:#E06C75">=-</span><span style="color:#56B6C2">1</span><span style="color:#A9B2C3">)</span></span>
<span data-line=""><span style="color:#E06C75">    return</span><span style="color:#A9B2C3"> emb</span></span></code></pre></figure>
<ul>
<li><strong>正弦和余弦函数</strong>：使用正弦和余弦函数生成时间步的周期性表示。</li>
<li><strong>维度扩展</strong>：将时间步扩展为高维向量，维度为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>embedding_dim</span></span></code></span>。</li>
</ul>
<hr/>
<h4 id="2-时间嵌入层"><a href="#2-时间嵌入层" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>2. 时间嵌入层</h4>
<p>时间嵌入层将正弦位置编码的输出进一步转换为模型所需的高维条件向量。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> TimestepEmbedding</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">timestep_input_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">time_embed_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">act_fn</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.linear1 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(timestep_input_dim, time_embed_dim)</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.act </span><span style="color:#E06C75">=</span><span style="color:#B57EDC"> getattr</span><span style="color:#A9B2C3">(nn, act_fn)()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.linear2 </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> nn.Linear(time_embed_dim, time_embed_dim)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">timesteps</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#A9B2C3">        emb </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> get_timestep_embedding(timesteps, </span><span style="color:#E06C75">self</span><span style="color:#A9B2C3">.linear1.in_features)</span></span>
<span data-line=""><span style="color:#A9B2C3">        emb </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.linear1(emb)</span></span>
<span data-line=""><span style="color:#A9B2C3">        emb </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.act(emb)</span></span>
<span data-line=""><span style="color:#A9B2C3">        emb </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.linear2(emb)</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> emb</span></span></code></pre></figure>
<ul>
<li><strong>线性变换</strong>：使用两个线性层将时间步嵌入转换为高维条件向量。</li>
<li><strong>激活函数</strong>：通常使用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>SiLU</span></span></code></span> 或 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ReLU</span></span></code></span> 激活函数，增加非线性。</li>
</ul>
<hr/>
<h3 id="时间嵌入系统的完整实现"><a href="#时间嵌入系统的完整实现" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>时间嵌入系统的完整实现</strong></h3>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="python" data-theme="plastic"><code data-language="python" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#61AFEF">class</span><span style="color:#E5C07B"> UNet2DConditionModel</span><span style="color:#A9B2C3">(</span><span style="color:#D19A66">nn</span><span style="color:#A9B2C3">.</span><span style="color:#D19A66">Module</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> __init__</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">timestep_input_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">time_embed_dim</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">act_fn</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#E5C07B">        super</span><span style="color:#A9B2C3">().</span><span style="color:#B57EDC">__init__</span><span style="color:#A9B2C3">()</span></span>
<span data-line=""><span style="color:#E06C75">        self</span><span style="color:#A9B2C3">.time_embedding </span><span style="color:#E06C75">=</span><span style="color:#A9B2C3"> TimestepEmbedding(timestep_input_dim, time_embed_dim, act_fn)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#61AFEF">    def</span><span style="color:#B57EDC"> forward</span><span style="color:#A9B2C3">(</span><span style="color:#C6CCD7">self</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">x</span><span style="color:#A9B2C3">, </span><span style="color:#C6CCD7">timesteps</span><span style="color:#A9B2C3">):</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 时间嵌入</span></span>
<span data-line=""><span style="color:#A9B2C3">        t_emb </span><span style="color:#E06C75">=</span><span style="color:#E06C75"> self</span><span style="color:#A9B2C3">.time_embedding(timesteps)</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 其他模块处理</span></span>
<span data-line=""><span style="color:#E06C75">        return</span><span style="color:#A9B2C3"> x</span></span></code></pre></figure>
<ul>
<li><strong>时间嵌入</strong>：将时间步信息转换为高维条件向量。</li>
<li><strong>注入到模型</strong>：时间嵌入被注入到模型的各个阶段，指导特征提取和生成。</li>
</ul>
<hr/>
<h3 id="总结-7"><a href="#总结-7" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>总结</strong></h3>
<p>时间嵌入系统在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>UNet2DConditionModel</span></span></code></span> 中起到了关键作用，通过将时间步信息编码为高维条件向量，指导模型在不同时间步的特征提取和生成过程。这一系统通过正弦位置编码和线性变换实现了时间信息的高效编码，为模型的时间条件注入提供了基础。</p></div><div class="w-96 text-gray-700 leading-none"><span class="!text-sm"><a class="!inline-block !p-0 !m-0 align-text-bottom" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" loading="lazy" width="88" height="31" decoding="async" data-nimg="1" class="!m-0 h-4 w-auto pr-1" style="color:transparent;border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/></a>This work is licensed under a<!-- --> <a class="underline" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</span></div><div class="TagsBox_tagsBox__WzhAf mt-4"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->深度学习</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/stable-diffusion">#<!-- -->Stable Diffusion</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->参数高效微调</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->模型训练</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->学习笔记</a></div><div class="mt-4 mb-4 flex justify-center"><div class="ml-0 mr-auto"><a href="/blog-next/learn_from_ai/mqtt-protocol-principles-applications">&lt;- 详细介绍 MQTT 协议的内容，原理，应用场景</a></div><div class="mr-0 ml-auto"><a href="/blog-next/learn_from_ai/golang-new-and-memory-management">GoLang 中 new() 与内存管理机制详解 -&gt;</a></div></div><hr class="mt-4"/></article></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"><div class="inset-0 w-full h-full flex items-center justify-center bg-transparent"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div></div><footer class="DefaultLayout_footer__aWV4u"><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="flex flex-row justify-center items-center"><div class="DefaultLayout_footerLeft__Qn_VV">© 2023 Ryo Jerry Yu. All rights reserved.</div><div class="DefaultLayout_footerRight__GlReP"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"stable-diffusion-unet-structure","tags":[{"tag":"深度学习","slug":"深度学习","path":"/tags/深度学习","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"Stable Diffusion","slug":"stable-diffusion","path":"/tags/stable-diffusion","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"LoRA","slug":"lora","path":"/tags/lora","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"参数高效微调","slug":"参数高效微调","path":"/tags/参数高效微调","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"模型训练","slug":"模型训练","path":"/tags/模型训练","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"学习笔记","slug":"学习笔记","path":"/tags/学习笔记","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/opencv-coordinate-system-conventions"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]}],"source":{"compiledSource":"\"use strict\";\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = {\n    a: \"a\",\n    code: \"code\",\n    em: \"em\",\n    figure: \"figure\",\n    h1: \"h1\",\n    h2: \"h2\",\n    h3: \"h3\",\n    h4: \"h4\",\n    hr: \"hr\",\n    li: \"li\",\n    ol: \"ol\",\n    p: \"p\",\n    pre: \"pre\",\n    span: \"span\",\n    strong: \"strong\",\n    table: \"table\",\n    tbody: \"tbody\",\n    td: \"td\",\n    th: \"th\",\n    thead: \"thead\",\n    tr: \"tr\",\n    ul: \"ul\",\n    ..._provideComponents(),\n    ...props.components\n  }, {CodeBlockMermaid, ObsidianCallout} = _components;\n  if (!CodeBlockMermaid) _missingMdxReference(\"CodeBlockMermaid\", true);\n  if (!ObsidianCallout) _missingMdxReference(\"ObsidianCallout\", true);\n  return _jsxs(_Fragment, {\n    children: [_jsx(ObsidianCallout, {\n      type: \"summary\",\n      title: \"\",\n      children: _jsx(_components.p, {\n        children: \"以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录\"\n      })\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: @train_text_to_image_lora.py 这段代码中如何体现 LoRA “使用两个低秩矩阵进行微调” 的步骤？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"train_text_to_image_lora.py\"\n            })\n          })\n        })\n      }), \" 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"以下是脚本中如何体现 LoRA 使用两个低秩矩阵进行微调的步骤：\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"1-lora-配置\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-lora-配置\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. LoRA 配置\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在脚本中，LoRA 的配置通常通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"LoraConfig\"\n            })\n          })\n        })\n      }), \" 类来定义。这个配置包括低秩矩阵的秩（\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"rank\"\n            })\n          })\n        })\n      }), \"）和其他参数：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"unet_lora_config \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" LoraConfig(\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    r\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"args.rank,  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 低秩矩阵的秩\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    lora_alpha\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"args.rank,  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# LoRA 的缩放因子\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    init_lora_weights\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gaussian\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 初始化权重的方法\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    target_modules\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"to_k\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"to_q\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"to_v\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"to_out.0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"],  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 目标模块\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"2-添加-lora-层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-添加-lora-层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 添加 LoRA 层\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在模型中插入 LoRA 层是通过调用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"add_adapter\"\n            })\n          })\n        })\n      }), \" 方法实现的：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"unet.add_adapter(unet_lora_config)\"\n            })\n          })\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这个方法会在指定的目标模块中插入两个低秩矩阵 (A) 和 (B)，用于调整模型的权重。具体来说，LoRA 在模型的注意力层中插入这些矩阵，以便在不改变原始权重的情况下进行微调。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"3-训练过程中的权重更新\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-训练过程中的权重更新\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 训练过程中的权重更新\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在训练过程中，只有 LoRA 插入的低秩矩阵的参数是可训练的。原始模型的权重保持冻结状态。这是通过以下代码实现的：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# freeze parameters of models to save more memory\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"unet.requires_grad_(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"False\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"vae.requires_grad_(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"False\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"text_encoder.requires_grad_(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"False\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通过这种方式，训练过程只会更新 LoRA 层的参数，而不会影响原始模型的权重。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"4-参数更新\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#4-参数更新\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"4. 参数更新\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在训练循环中，反向传播和参数更新步骤只会影响 LoRA 层的参数：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# Backpropagate\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"accelerator.backward(loss)\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"if\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" accelerator.sync_gradients:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    params_to_clip \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" lora_layers\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    accelerator.clip_grad_norm_(params_to_clip, args.max_grad_norm)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"optimizer.step()\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"lr_scheduler.step()\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"optimizer.zero_grad()\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这里的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"lora_layers\"\n            })\n          })\n        })\n      }), \" 是一个过滤器，只包含 LoRA 层的可训练参数。\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"总结\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通过在模型的特定层中插入两个低秩矩阵，LoRA 实现了参数高效的微调。这种方法允许在不改变原始模型权重的情况下，通过调整低秩矩阵来适应新的数据分布，从而实现高效的模型微调。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-unet-是个什么样的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-unet-是个什么样的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: unet 是个什么样的结构？\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"UNet 是一种常用于图像生成和分割任务的神经网络架构。它最初是在医学图像分割领域中引入的，但由于其强大的特性和灵活性，UNet 也被广泛应用于其他计算机视觉任务，包括图像生成、去噪和超分辨率等。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"unet-的基本结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#unet-的基本结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"UNet 的基本结构\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"UNet 的结构可以分为两个主要部分：编码器（下采样路径）和解码器（上采样路径），中间通过跳跃连接（skip connections）相连。\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"编码器（下采样路径）\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"由一系列卷积层和池化层组成。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"每个卷积层通常后接一个激活函数（如 ReLU）。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"池化层用于逐步减少特征图的空间维度，同时增加特征的抽象程度。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"解码器（上采样路径）\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"由一系列上采样层（如反卷积或上采样）和卷积层组成。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"逐步恢复特征图的空间维度。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"使用跳跃连接将编码器中相应层的特征图与解码器中的特征图连接，以保留细节信息。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"跳跃连接（Skip Connections）\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"将编码器中的特征图直接连接到解码器中相应层的特征图。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"这种连接方式有助于保留输入图像的细节信息，改善生成结果的质量。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"unet-在-stable-diffusion-中的应用\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#unet-在-stable-diffusion-中的应用\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"UNet 在 Stable Diffusion 中的应用\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在 Stable Diffusion 模型中，UNet 作为核心组件用于处理图像的潜在表示。具体来说，UNet 在扩散模型中用于预测噪声残差，从而逐步生成高质量的图像。\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"输入\"\n        }), \"：UNet 接收一个带有噪声的潜在表示（通常是一个低维的特征图）。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"输出\"\n        }), \"：UNet 输出一个与输入相同大小的特征图，表示对噪声的预测。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"训练目标\"\n        }), \"：通过最小化预测噪声与真实噪声之间的差异，UNet 学会如何去除噪声，从而生成清晰的图像。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"unet-的优势\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#unet-的优势\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"UNet 的优势\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"高效的特征提取\"\n        }), \"：通过编码器提取多尺度特征。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"细节保留\"\n        }), \"：通过跳跃连接保留输入图像的细节信息。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"灵活性\"\n        }), \"：可以适应不同的输入尺寸和任务需求。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"UNet 的这种结构使其在图像生成任务中表现出色，特别是在需要高分辨率输出和细节保留的场景中。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 为什么这里 unet、 vae 、 tokenizer 等几个模型都是从同一个路径加载的？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在这个代码片段中，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"unet\"\n            })\n          })\n        })\n      }), \"、\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"vae\"\n            })\n          })\n        })\n      }), \"、\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"tokenizer\"\n            })\n          })\n        })\n      }), \" 和其他组件都是从同一个路径加载的，这是因为它们都是 Stable Diffusion 模型的一部分。Stable Diffusion 是一个复杂的生成模型，通常由多个子模块组成，每个子模块负责不同的任务。以下是这些组件的作用和为什么它们从同一路径加载的原因：\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"1-统一的模型路径\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-统一的模型路径\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 统一的模型路径\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"路径一致性\"\n        }), \"：所有这些组件都从同一个路径加载，因为它们通常被打包在一个预训练模型中。这个路径通常指向一个包含所有必要文件的目录或一个 Hugging Face Hub 上的模型仓库。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"版本控制\"\n        }), \"：通过从同一个路径加载，确保所有组件使用的是同一个版本的模型，避免版本不匹配导致的兼容性问题。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"2-各个组件的作用\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-各个组件的作用\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 各个组件的作用\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"UNet (\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"unet\"\n                  })\n                })\n              })\n            }), \")\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"负责处理图像的潜在表示，预测噪声残差。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在扩散模型中用于逐步生成高质量的图像。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"VAE (\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"vae\"\n                  })\n                })\n              })\n            }), \")\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在 Stable Diffusion 中，VAE 用于将输入图像转换为潜在表示，供 UNet 处理。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"Tokenizer (\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"tokenizer\"\n                  })\n                })\n              })\n            }), \")\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"用于将文本输入（如生成图像的描述）转换为模型可理解的标记。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在文本到图像生成任务中，tokenizer 将文本描述转换为输入 ID，供文本编码器使用。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"Text Encoder (\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"text_encoder\"\n                  })\n                })\n              })\n            }), \")\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"将文本输入编码为特征向量，供 UNet 使用。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在生成过程中，文本编码器提供条件信息，指导图像生成。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"Noise Scheduler (\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"noise_scheduler\"\n                  })\n                })\n              })\n            }), \")\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"控制扩散过程中的噪声添加和去除。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"在训练和推理过程中，调度器决定在每个时间步添加多少噪声。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"3-统一加载的好处\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-统一加载的好处\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 统一加载的好处\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"简化管理\"\n        }), \"：从同一位置加载所有组件简化了模型管理和部署。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"一致性\"\n        }), \"：确保所有组件在同一训练配置下工作，避免不兼容问题。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"便捷性\"\n        }), \"：用户只需指定一个路径或模型标识符，即可加载整个模型的所有必要部分。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通过这种方式，用户可以方便地使用预训练的 Stable Diffusion 模型进行微调或推理，而不必单独管理每个组件的版本和路径。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 这些是 Stable Diffusion 的内部设计对吧？这些都在哪篇论文里提出的？ @Web\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Stable Diffusion 是一种基于扩散模型的图像生成技术，其核心组件和设计在多篇论文中得到了详细描述。以下是与 Stable Diffusion 相关的关键论文：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"扩散模型的基础\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"论文\"\n            }), \"：\", _jsx(_components.em, {\n              children: \"Denoising Diffusion Probabilistic Models\"\n            }), \" by Jonathan Ho, Ajay Jain, Pieter Abbeel (2020)\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"链接\"\n            }), \"：\", _jsx(_components.a, {\n              href: \"https://arxiv.org/abs/2006.11239\",\n              children: \"arXiv:2006.11239\"\n            })]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"内容\"\n            }), \"：这篇论文介绍了扩散模型的基本原理和去噪过程，是 Stable Diffusion 的理论基础。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"Stable Diffusion 的具体实现\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"论文\"\n            }), \"：\", _jsx(_components.em, {\n              children: \"High-Resolution Image Synthesis with Latent Diffusion Models\"\n            }), \" by Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, Björn Ommer (2021)\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"链接\"\n            }), \"：\", _jsx(_components.a, {\n              href: \"https://arxiv.org/abs/2112.10752\",\n              children: \"arXiv:2112.10752\"\n            })]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"内容\"\n            }), \"：这篇论文详细描述了 Stable Diffusion 的架构，包括使用潜在空间的扩散模型、VAE 的应用以及如何在高分辨率图像生成中实现高效计算。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"CLIP 模型的使用\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"论文\"\n            }), \"：\", _jsx(_components.em, {\n              children: \"Learning Transferable Visual Models From Natural Language Supervision\"\n            }), \" by Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, Gretchen Krueger, Ilya Sutskever (2021)\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"链接\"\n            }), \"：\", _jsx(_components.a, {\n              href: \"https://arxiv.org/abs/2103.00020\",\n              children: \"arXiv:2103.00020\"\n            })]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.strong, {\n              children: \"内容\"\n            }), \"：CLIP 模型用于将文本和图像结合在一起进行训练，Stable Diffusion 使用 CLIP 作为文本编码器来处理文本输入。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这些论文共同构成了 Stable Diffusion 的理论和技术基础，描述了其内部设计和实现细节。通过结合扩散模型、VAE 和 CLIP，Stable Diffusion 实现了高效的文本到图像生成。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 解释 StableDiffusionPipeline 的结构 @pipeline_stable_diffusion.py\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 是一个用于实现 Stable Diffusion 模型的核心类，负责将多个组件组合在一起以实现文本到图像的生成。以下是对 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 结构的详细解释：\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"继承关系\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#继承关系\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"继承关系\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 继承了多个类，这些类为其提供了不同的功能：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"DiffusionPipeline\"\n        }), \": 提供了基本的扩散模型功能。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"StableDiffusionMixin\"\n        }), \": 包含与 Stable Diffusion 相关的特定功能。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"TextualInversionLoaderMixin\"\n        }), \": 支持文本反转加载功能。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"StableDiffusionLoraLoaderMixin\"\n        }), \": 支持 LoRA（低秩适应）加载功能。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"IPAdapterMixin\"\n        }), \": 提供 IP 适配器功能。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"FromSingleFileMixin\"\n        }), \": 支持从单个文件加载模型。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"初始化方法\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#初始化方法\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"初始化方法\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"__init__\"\n            })\n          })\n        })\n      }), \" 方法用于初始化 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 的各个组件：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"VAE (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"vae\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Text Encoder (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"text_encoder\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 使用 CLIP 模型将文本输入编码为特征向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Tokenizer (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"tokenizer\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 将文本输入转换为模型可理解的标记。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"UNet (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"unet\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 负责处理图像的潜在表示，预测噪声残差。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Scheduler (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"scheduler\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 控制扩散过程中的噪声添加和去除。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Safety Checker (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"safety_checker\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 用于检查生成图像的安全性。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Feature Extractor (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"feature_extractor\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 用于从图像中提取特征。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsxs(_components.strong, {\n          children: [\"Image Encoder (\", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"image_encoder\"\n                })\n              })\n            })\n          }), \")\"]\n        }), \": 可选组件，用于图像编码。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"功能和方法\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#功能和方法\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"功能和方法\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Deprecation Warnings\"\n        }), \": 在初始化过程中，检查 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"scheduler\"\n              })\n            })\n          })\n        }), \" 和 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"unet\"\n              })\n            })\n          })\n        }), \" 的配置是否过时，并提供相应的弃用警告。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Module Registration\"\n        }), \": 使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"register_modules\"\n              })\n            })\n          })\n        }), \" 方法将各个组件注册到管道中，便于统一管理。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Safety Checks\"\n        }), \": 提供安全检查功能，确保生成的图像符合安全标准。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Guidance Scale\"\n        }), \": 提供指导比例的计算和应用，用于控制生成图像的风格和内容。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Image Processing\"\n        }), \": 包含图像处理方法，如 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"decode_latents\"\n              })\n            })\n          })\n        }), \"，用于将潜在表示转换为图像。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"属性\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#属性\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"属性\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Guidance Scale\"\n        }), \": 控制生成图像的风格和内容。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Cross Attention\"\n        }), \": 提供交叉注意力机制的参数。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Timesteps\"\n        }), \": 控制扩散过程的时间步数。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"设计目的\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#设计目的\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"设计目的\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 的设计目的是将 Stable Diffusion 模型的各个组件整合在一起，提供一个统一的接口来进行文本到图像的生成。通过继承和组合多个功能模块，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 能够灵活地支持不同的生成任务和配置需求。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: @pipeline_utils.py 解释 DiffusionPipeline 的结构，以及 from_pretrained 在做什么\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 是一个用于管理和执行扩散模型的核心类，提供了加载、配置和运行模型的基本功能。以下是对 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 结构和 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法的详细解释：\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"diffusionpipeline-的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#diffusionpipeline-的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"DiffusionPipeline 的结构\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 是一个抽象基类，定义了扩散模型的基本接口和功能。其主要结构包括：\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"模块注册\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"register_modules\"\n                  })\n                })\n              })\n            }), \" 方法用于注册模型的各个组件（如 VAE、UNet、调度器等），便于统一管理和调用。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"模型加载\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"提供从预训练模型加载各个组件的功能，通常通过 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法实现。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"推理接口\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"定义了模型推理的基本接口，用户可以通过调用这些接口生成图像或其他输出。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"配置管理\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"提供配置加载和保存功能，便于模型的复用和共享。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"实用工具\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"包含一些实用工具方法，如检查版本、处理设备映射等。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"from_pretrained-方法\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#from_pretrained-方法\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"from_pretrained 方法\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 中的一个关键方法，用于从预训练模型加载管道的各个组件。其主要功能包括：\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"模型路径解析\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"接受一个模型标识符（如 Hugging Face Hub 上的模型 ID）或本地路径，解析并定位模型文件。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"组件加载\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"从指定路径加载模型的各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"支持加载不同版本和变体的模型组件。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"配置加载\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"加载模型的配置文件，设置模型的超参数和其他配置选项。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"设备映射\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"根据用户指定的设备映射策略，将模型组件分配到合适的计算设备（如 CPU、GPU）。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"安全检查\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"在加载过程中，检查模型的安全性和兼容性，确保加载的模型符合预期。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"返回实例\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"完成加载后，返回一个配置好的 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"DiffusionPipeline\"\n                  })\n                })\n              })\n            }), \" 实例，用户可以直接使用该实例进行推理。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"设计目的-1\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#设计目的-1\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"设计目的\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 的设计目的是提供一个统一的接口来管理和执行扩散模型。通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法，用户可以方便地加载和配置预训练模型，快速进行推理和生成任务。这种设计使得扩散模型的使用更加简便和高效，适合各种应用场景。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: @train_text_to_image_lora.py 里，从 DiffusionPipeline.from_pretrained 加载到了 @pipeline_stable_diffusion.py 中 StableDiffusionPipeline 类的实例，我理解的对吗？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"是的，你的理解是正确的。在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"train_text_to_image_lora.py\"\n            })\n          })\n        })\n      }), \" 中，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"DiffusionPipeline.from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法用于加载预训练的模型管道实例。在这个过程中，它会根据指定的模型路径和配置，实例化一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"StableDiffusionPipeline\"\n            })\n          })\n        })\n      }), \" 类的对象。\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"具体过程如下\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#具体过程如下\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"具体过程如下：\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"调用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法\"]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"在 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"train_text_to_image_lora.py\"\n                  })\n                })\n              })\n            }), \" 中，\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"DiffusionPipeline.from_pretrained\"\n                  })\n                })\n              })\n            }), \" 被调用来加载预训练的模型。\"]\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"这个方法会根据提供的路径或模型标识符，从 Hugging Face Hub 或本地文件系统加载模型的权重和配置。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsxs(_components.strong, {\n            children: [\"实例化 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"StableDiffusionPipeline\"\n                  })\n                })\n              })\n            })]\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法会识别模型的类型，并根据配置文件中的信息选择合适的管道类进行实例化。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"在这个例子中，由于加载的是 Stable Diffusion 模型，因此会实例化 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"StableDiffusionPipeline\"\n                  })\n                })\n              })\n            }), \" 类。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"加载组件\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"StableDiffusionPipeline\"\n                  })\n                })\n              })\n            }), \" 的 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"__init__\"\n                  })\n                })\n              })\n            }), \" 方法会被调用，加载模型的各个组件（如 VAE、UNet、调度器等）。\"]\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"这些组件会根据预训练的权重进行初始化，并注册到管道中。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"返回实例\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"完成加载后，\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法返回一个配置好的 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"StableDiffusionPipeline\"\n                  })\n                })\n              })\n            }), \" 实例。\"]\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"这个实例可以用于进一步的推理或微调任务。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"通过这种方式，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"train_text_to_image_lora.py\"\n            })\n          })\n        })\n      }), \" 脚本能够方便地加载和使用预训练的 Stable Diffusion 模型进行微调和生成任务。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 解读 @pipeline_utils.py 中 from_pretrained 代码，详细说明如何识别模型类型选择管道类。 @Codebase\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"pipeline_utils.py\"\n            })\n          })\n        })\n      }), \" 中，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法负责从预训练模型加载管道实例。以下是该方法如何识别模型类型并选择合适的管道类的详细说明：\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"识别模型类型并选择管道类的步骤\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#识别模型类型并选择管道类的步骤\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"识别模型类型并选择管道类的步骤\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"下载和缓存模型文件\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"首先，\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法会检查 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"pretrained_model_name_or_path\"\n                  })\n                })\n              })\n            }), \" 是否是一个本地路径。如果不是，它会调用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"cls.download\"\n                  })\n                })\n              })\n            }), \" 方法从 Hugging Face Hub 下载模型文件，并将其缓存到本地。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"763\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"788\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"加载配置文件\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"使用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"cls.load_config\"\n                  })\n                })\n              })\n            }), \" 方法加载模型的配置文件，该文件包含模型的超参数和其他配置信息。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"812\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"818\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"识别模型变体\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"通过 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"_identify_model_variants\"\n                  })\n                })\n              })\n            }), \" 方法识别模型的变体（如 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"fp16\"\n                  })\n                })\n              })\n            }), \"、\", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"ema\"\n                  })\n                })\n              })\n            }), \" 等），以便加载正确的模型文件。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"820\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"827\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"解析自定义管道和类\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"使用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"_resolve_custom_pipeline_and_cls\"\n                  })\n                })\n              })\n            }), \" 方法解析自定义管道和类名。如果用户指定了自定义管道，则从 Hub 加载相应的模块。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"831\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"833\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"获取管道类\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"调用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"_get_pipeline_class\"\n                  })\n                })\n              })\n            }), \" 方法，根据配置文件和用户指定的选项，确定要实例化的管道类。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"834\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"842\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"加载管道组件\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"根据管道类的签名，加载并实例化各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。\"\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"857\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"980\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"实例化管道\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"使用加载的组件和配置，实例化最终的管道对象。\"\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"相关代码行：\", \"\\n\", _jsx(_components.figure, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.pre, {\n                tabIndex: \"0\",\n                \"data-language\": \"python\",\n                \"data-theme\": \"plastic\",\n                children: _jsxs(_components.code, {\n                  \"data-language\": \"python\",\n                  \"data-theme\": \"plastic\",\n                  style: {\n                    display: \"grid\"\n                  },\n                  children: [_jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"startLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"1021\"\n                    })]\n                  }), \"\\n\", _jsxs(_components.span, {\n                    \"data-line\": \"\",\n                    children: [_jsx(_components.span, {\n                      style: {\n                        color: \"#A9B2C3\"\n                      },\n                      children: \"endLine: \"\n                    }), _jsx(_components.span, {\n                      style: {\n                        color: \"#56B6C2\"\n                      },\n                      children: \"1028\"\n                    })]\n                  })]\n                })\n              })\n            }), \"\\n\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"通过这些步骤，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法能够识别模型类型并选择合适的管道类，确保加载的模型能够正确地进行推理和生成任务。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 如果我只有一个 sd_xl_base_1.0.safetensors 文件，是否无法使用 from_pretrained 方法得到具体的 Pipeline 实例？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"如果你只有一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"sd_xl_base_1.0.safetensors\"\n            })\n          })\n        })\n      }), \" 文件，直接使用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法可能会遇到一些困难，因为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 通常期望从一个包含完整模型配置和权重的目录或 Hugging Face Hub 仓库中加载模型。\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"解决方案\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#解决方案\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"解决方案\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"手动加载权重\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"你可以手动加载 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"safetensors\"\n                  })\n                })\n              })\n            }), \" 文件中的权重，并将它们分配给相应的模型组件（如 UNet、VAE 等）。\"]\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"这需要你对模型的架构有深入的了解，以便正确地将权重映射到模型的各个部分。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"创建配置文件\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"from_pretrained\"\n                  })\n                })\n              })\n            }), \" 方法依赖于配置文件来确定如何构建模型管道。你可以尝试创建一个与模型匹配的配置文件，通常是一个 JSON 文件，描述模型的架构和超参数。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"这个配置文件需要放在与 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"safetensors\"\n                  })\n                })\n              })\n            }), \" 文件相同的目录中。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"使用自定义加载逻辑\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"如果你熟悉模型的架构，可以编写自定义的加载逻辑，将 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"safetensors\"\n                  })\n                })\n              })\n            }), \" 文件中的权重加载到模型中。\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [\"这可能涉及使用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"safetensors\"\n                  })\n                })\n              })\n            }), \" 库来读取权重，并手动将它们分配给模型的各个层。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"检查社区资源\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"有时，社区会提供工具或脚本来帮助加载特定格式的模型文件。你可以在相关的 GitHub 仓库或论坛中查找是否有适合的工具。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-1\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-1\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"总结\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"虽然 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法提供了便捷的加载方式，但它通常需要完整的模型目录或 Hub 仓库。如果只有一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"safetensors\"\n            })\n          })\n        })\n      }), \" 文件，你可能需要手动处理权重加载和配置，以便正确地构建和使用模型管道。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-如果我只需要进行推理是否仍需配置文件\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-如果我只需要进行推理是否仍需配置文件\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 如果我只需要进行推理，是否仍需配置文件？\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在进行推理时，配置文件仍然是非常有用的，尽管在某些情况下你可能能够在没有完整配置文件的情况下进行推理。以下是一些考虑因素：\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"为什么需要配置文件\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#为什么需要配置文件\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"为什么需要配置文件\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"模型架构信息\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"配置文件通常包含模型的架构信息，如层数、隐藏单元数、激活函数等。这些信息对于正确构建模型至关重要。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"超参数设置\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"配置文件中可能包含一些超参数设置，如学习率、优化器设置等，虽然这些在推理时不直接使用，但了解这些信息有助于理解模型的行为。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"组件初始化\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"在复杂模型（如 Stable Diffusion）中，配置文件用于初始化各个组件（如 VAE、UNet、调度器等）。这些组件需要正确的参数来进行推理。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"没有配置文件时的推理\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#没有配置文件时的推理\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"没有配置文件时的推理\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果你没有配置文件，但仍希望进行推理，可以考虑以下方法：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"手动构建模型\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"如果你对模型的架构有深入了解，可以手动构建模型，并使用 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"safetensors\"\n                  })\n                })\n              })\n            }), \" 文件中的权重进行初始化。\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"使用默认设置\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"在某些情况下，你可以使用一些默认的设置来初始化模型组件，但这可能会导致性能不佳或结果不准确。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"社区支持\"\n          }), \"：\"]\n        }), \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"查找社区提供的工具或脚本，这些工具可能已经解决了如何在没有完整配置文件的情况下进行推理的问题。\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-2\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-2\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"总结\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"虽然在某些情况下可以在没有配置文件的情况下进行推理，但拥有配置文件通常会使过程更简单、更可靠。如果可能，尝试获取或创建一个与模型匹配的配置文件，以确保推理的准确性和效率。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 以你上面举的例子为例，@pipeline_loading_utils.py load_sub_model 中，实例化的是 @unet_2d_condition.py 中的 UNet2DConditionModel 类吗？ load_sub_model 是怎么找到这个类并实例化的？\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Deepseek R-1:\"\n    }), \"\\n\", _jsxs(\"think\", {\n      children: [_jsxs(_components.p, {\n        children: [\"好的，我需要仔细分析用户的问题。用户问的是在\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"pipeline_loading_utils.py\"\n              })\n            })\n          })\n        }), \"中的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \"函数是否实例化了\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"unet_2d_condition.py\"\n              })\n            })\n          })\n        }), \"中的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"类，以及这个过程是如何找到并实例化该类的。\"]\n      }), _jsxs(_components.p, {\n        children: [\"首先，我需要回忆\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \"函数的作用。根据之前的讨论，这个函数负责动态加载模型的各个子组件，比如 UNet、VAE 等。用户提供的代码片段显示，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \"通过\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_obj\"\n              })\n            })\n          })\n        }), \"来实例化具体的类，而\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_obj\"\n              })\n            })\n          })\n        }), \"是通过\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"get_class_obj_and_candidates\"\n              })\n            })\n          })\n        }), \"函数获取的。\"]\n      }), _jsxs(_components.p, {\n        children: [\"接下来，我需要查看\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"get_class_obj_and_candidates\"\n              })\n            })\n          })\n        }), \"函数的逻辑。这个函数会根据\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"library_name\"\n              })\n            })\n          })\n        }), \"和\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_name\"\n              })\n            })\n          })\n        }), \"来查找对应的类。例如，当\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"library_name\"\n              })\n            })\n          })\n        }), \"是\\\"diffusers\\\"，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_name\"\n              })\n            })\n          })\n        }), \"是\\\"UNet2DConditionModel\\\"时，应该会导入\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"diffusers.models.unets.unet_2d_condition\"\n              })\n            })\n          })\n        }), \"模块中的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"类。\"]\n      }), _jsxs(_components.p, {\n        children: [\"然后，我需要确认\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"unet_2d_condition.py\"\n              })\n            })\n          })\n        }), \"中的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"类是否被正确注册到\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ALL_IMPORTABLE_CLASSES\"\n              })\n            })\n          })\n        }), \"中。在 Diffusers 库中，通常会有全局的类注册机制，确保各个组件可以被动态发现和加载。\"]\n      }), _jsxs(_components.p, {\n        children: [\"此外，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \"函数中的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_method\"\n              })\n            })\n          })\n        }), \"是通过\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"_get_load_method\"\n              })\n            })\n          })\n        }), \"获取的，这可能涉及到从预训练权重加载模型的方法，比如\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"from_pretrained\"\n              })\n            })\n          })\n        }), \"。需要检查\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"类是否实现了相应的类方法，以支持从配置文件或预训练文件加载。\"]\n      }), _jsxs(_components.p, {\n        children: [\"最后，需要验证实例化的过程是否正确，包括参数传递和配置的应用。例如，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"__init__\"\n              })\n            })\n          })\n        }), \"方法需要接收正确的参数来构建模型结构，而这些参数可能来自配置文件或默认值。\"]\n      }), _jsxs(_components.p, {\n        children: [\"总结来说，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \"通过类名和库名找到对应的类，利用其加载方法（如\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"from_pretrained\"\n              })\n            })\n          })\n        }), \"）实例化对象，而\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"作为可导入的类被正确注册和引用，从而完成实例化。\"]\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"是的，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"pipeline_loading_utils.py\"\n            })\n          })\n        })\n      }), \" 中的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"load_sub_model\"\n            })\n          })\n        })\n      }), \" 函数最终会实例化 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"unet_2d_condition.py\"\n            })\n          })\n        })\n      }), \" 中的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 类。以下是完整的加载逻辑解析：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"核心加载流程\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#核心加载流程\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"核心加载流程\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# pipeline_loading_utils.py 中的关键代码段\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" load_sub_model\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(...):\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 1. 获取类对象和候选类\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    class_obj, class_candidates \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" get_class_obj_and_candidates(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        library_name,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        class_name,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        importable_classes,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        pipelines,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        is_pipeline_module,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        component_name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"name,\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        cache_dir\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"cached_folder,\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    )\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 2. 确定加载方法（如 from_pretrained）\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    load_method_name \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" None\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"    for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" candidate_name, candidate_class \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" class_candidates.items():\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        if\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" issubclass\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(class_obj, candidate_class):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            load_method_name \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" importable_classes[candidate_name][\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 通常是 \\\"from_pretrained\\\"\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 3. 获取具体的加载方法\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    load_method \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" _get_load_method(class_obj, load_method_name, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"is_dduf\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"dduf_entries \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"is\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" not\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 4. 执行加载\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    loaded_sub_model \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" load_method(cached_folder, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"loading_kwargs)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"具体步骤解析\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#具体步骤解析\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"具体步骤解析\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-类对象获取-get_class_obj_and_candidates\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-类对象获取-get_class_obj_and_candidates\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"1. 类对象获取 (get_class_obj_and_candidates)\"\n      })]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"作用\"\n        }), \"：根据 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"library_name\"\n              })\n            })\n          })\n        }), \" 和 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_name\"\n              })\n            })\n          })\n        }), \" 动态导入对应的 Python 类。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"实现\"\n        }), \"：\", \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsxs(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: [_jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 通过 library_name 定位模块路径\"\n                })\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 例如 library_name=\\\"diffusers\\\", class_name=\\\"UNet2DConditionModel\\\"\"\n                })\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 会导入 diffusers.models.unets.unet_2d_condition 模块\"\n                })\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"module \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \" importlib.import_module(library_name)\"\n                })]\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"class_obj \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#B57EDC\"\n                  },\n                  children: \" getattr\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"(module, class_name)  \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 获取 UNet2DConditionModel 类\"\n                })]\n              })]\n            })\n          })\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-加载方法匹配\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-加载方法匹配\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"2. 加载方法匹配\"\n      })]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"候选类\"\n        }), \"：\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_candidates\"\n              })\n            })\n          })\n        }), \" 来自 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ALL_IMPORTABLE_CLASSES\"\n              })\n            })\n          })\n        }), \"，包含所有可加载的基类（如 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin\"\n              })\n            })\n          })\n        }), \"）。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"方法选择\"\n        }), \"：通过 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"issubclass\"\n              })\n            })\n          })\n        }), \" 检查 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_obj\"\n              })\n            })\n          })\n        }), \" 是否继承自候选类，从而确定使用哪个基类的加载方法（如 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin.from_pretrained\"\n              })\n            })\n          })\n        }), \"）。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"3-加载方法绑定\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-加载方法绑定\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"3. 加载方法绑定\"\n      })]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"动态绑定\"\n        }), \"：\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"_get_load_method\"\n              })\n            })\n          })\n        }), \" 会将 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_obj.from_pretrained\"\n              })\n            })\n          })\n        }), \" 方法绑定为实际加载函数。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"特殊处理\"\n        }), \"：如果是 DDUF 格式（HuggingFace 的分布式格式），会使用特定的加载逻辑。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"4-实例化-unet\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#4-实例化-unet\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"4. 实例化 UNet\"\n      })]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"参数传递\"\n        }), \"：\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"loading_kwargs\"\n              })\n            })\n          })\n        }), \" 包含模型路径、设备映射、精度设置等。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"最终调用\"\n        }), \"：\", \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsxs(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: [_jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 等效于执行：\"\n                })\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"UNet2DConditionModel.from_pretrained(\"\n                })\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#C6CCD7\"\n                  },\n                  children: \"    pretrained_model_name_or_path\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"cached_folder,\"\n                })]\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#C6CCD7\"\n                  },\n                  children: \"    subfolder\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"name,  \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#5F6672\",\n                    fontStyle: \"italic\"\n                  },\n                  children: \"# 如 \\\"unet\\\"\"\n                })]\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#C6CCD7\"\n                  },\n                  children: \"    torch_dtype\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"torch_dtype,\"\n                })]\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#C6CCD7\"\n                  },\n                  children: \"    device_map\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"device_map,\"\n                })]\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#56B6C2\"\n                  },\n                  children: \"    ...\"\n                })\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \")\"\n                })\n              })]\n            })\n          })\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"unet2dconditionmodel-的注册机制\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#unet2dconditionmodel-的注册机制\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"UNet2DConditionModel 的注册机制\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"diffusers\"\n            })\n          })\n        })\n      }), \" 的全局注册表 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"ALL_IMPORTABLE_CLASSES\"\n            })\n          })\n        })\n      }), \" 中，\", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 被注册为可导入类：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 在某个初始化模块中（如 src/diffusers/__init__.py）\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"ALL_IMPORTABLE_CLASSES\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" =\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" {\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    \\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"UNet2DConditionModel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": (\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"diffusers.models.unets.unet_2d_condition\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"UNet2DConditionModel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"),\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"    ...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"}\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这使得 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"get_class_obj_and_candidates\"\n            })\n          })\n        })\n      }), \" 能通过名称匹配找到该类。\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"架构参数如何生效\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#架构参数如何生效\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"架构参数如何生效\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"当调用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 时：\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"配置加载\"\n        }), \"：从 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"config.json\"\n              })\n            })\n          })\n        }), \" 中读取 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"down_block_types\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"up_block_types\"\n              })\n            })\n          })\n        }), \" 等参数。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"动态构建\"\n        }), \"：\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel.__init__\"\n              })\n            })\n          })\n        }), \" 根据这些参数，通过 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"get_down_block\"\n              })\n            })\n          })\n        }), \" 和 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"get_up_block\"\n              })\n            })\n          })\n        }), \" 动态构建网络层。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"例如：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 根据 config.json 中的 down_block_types 创建下采样块\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"down_block_type \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" \\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"CrossAttnDownBlock2D\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"down_block \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" get_down_block(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    down_block_type,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    num_layers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"layers_per_block[i],\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"input_channel,\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"output_channel,\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"    ...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结流程图\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结流程图\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结流程图\"\n      })]\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"graph TD\\n    A[load_sub_model] --\u003e B[get_class_obj_and_candidates]\\n    B --\u003e C{找到 UNet2DConditionModel 类}\\n    C --\u003e D[确定加载方法 from_pretrained]\\n    D --\u003e E[调用 UNet2DConditionModel.from_pretrained]\\n    E --\u003e F[加载 config.json]\\n    F --\u003e G[根据配置动态构建网络层]\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通过这种动态加载机制，Diffusers 库实现了高度模块化的模型管理，能够灵活支持不同结构的 UNet 变体。\"\n    }), \"\\n\", _jsxs(ObsidianCallout, {\n      type: \"info-太史公曰\",\n      title: \"\",\n      children: [_jsxs(_components.p, {\n        children: [\"应当不是。正确来说，是上层（ \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"DiffusionPipeline.from_pretained\"\n              })\n            })\n          })\n        }), \" ）从 importable_classes 参数中传入 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ALL_IMPORTABLE_CLASSES\"\n              })\n            })\n          })\n        }), \" ， \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"get_class_obj_and_candidates\"\n              })\n            })\n          })\n        }), \" 中从 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"diffuser\"\n              })\n            })\n          })\n        }), \" 中加载到 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin\"\n              })\n            })\n          })\n        }), \" ，调用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin.from_pretrained\"\n              })\n            })\n          })\n        }), \" 才实例化 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \" 类。\"]\n      }), _jsxs(_components.p, {\n        children: [\"因此估计往 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"load_sub_model\"\n              })\n            })\n          })\n        }), \" 中传入的是 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"diffuser\"\n              })\n            })\n          })\n        }), \" 与 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin\"\n              })\n            })\n          })\n        })]\n      })]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 解析代码，详解@modeling_utils.py 的 from_pretrained 如何实例化 @unet_2d_condition.py 中的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" ？\"]\n    }), \"\\n\", _jsxs(\"think\", {\n      children: [_jsxs(_components.p, {\n        children: [\"我需要详细解析 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"modeling_utils.py\"\n              })\n            })\n          })\n        }), \" 中的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"from_pretrained\"\n              })\n            })\n          })\n        }), \" 方法如何实例化 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"。根据提供的代码，我可以看到整个加载流程。\"]\n      }), _jsxs(_components.p, {\n        children: [\"首先，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"from_pretrained\"\n              })\n            })\n          })\n        }), \" 是 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin\"\n              })\n            })\n          })\n        }), \" 类的一个类方法，而 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \" 继承自 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ModelMixin\"\n              })\n            })\n          })\n        }), \"，所以它继承了这个方法。\"]\n      }), _jsx(_components.p, {\n        children: \"加载流程大致如下：\"\n      }), _jsxs(_components.ol, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"首先获取配置文件和模型文件路径\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"加载配置文件\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"使用配置创建模型实例\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"加载权重到模型中\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"处理设备映射等高级功能\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"返回加载好的模型\"\n        }), \"\\n\"]\n      }), _jsxs(_components.p, {\n        children: [\"具体来看，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"from_pretrained\"\n              })\n            })\n          })\n        }), \" 方法首先会确定模型文件的位置，然后加载配置文件。接着，它会使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"cls.from_config(config, **unused_kwargs)\"\n              })\n            })\n          })\n        }), \" 创建一个模型实例。这里的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"cls\"\n              })\n            })\n          })\n        }), \" 就是 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"，所以实际上是调用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel.from_config\"\n              })\n            })\n          })\n        }), \" 来创建模型实例。\"]\n      }), _jsxs(_components.p, {\n        children: [\"然后，它会加载权重文件，并将权重加载到模型中。这个过程通过 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"_load_pretrained_model\"\n              })\n            })\n          })\n        }), \" 方法完成。最后，它会处理设备映射等高级功能，并返回加载好的模型。\"]\n      }), _jsx(_components.p, {\n        children: \"我需要详细解释这个过程，特别是如何从配置创建模型实例，以及如何加载权重到模型中。\"\n      })]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"from_pretrained-如何实例化-unet2dconditionmodel-的详细流程\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#from_pretrained-如何实例化-unet2dconditionmodel-的详细流程\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 如何实例化 UNet2DConditionModel 的详细流程\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"modeling_utils.py\"\n            })\n          })\n        })\n      }), \" 中的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_pretrained\"\n            })\n          })\n        })\n      }), \" 方法负责实例化 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \"，整个过程可分为以下关键步骤：\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"1-加载配置文件\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-加载配置文件\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 加载配置文件\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 确定模型路径并加载配置\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"config_dict \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" cls\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".load_config(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    pretrained_model_name_or_path,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    cache_dir\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"cache_dir,\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    force_download\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"force_download,\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 其他参数...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这一步从模型目录或 Hub 加载 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"config.json\"\n            })\n          })\n        })\n      }), \"，包含了 UNet 的所有配置参数（如通道数、注意力头数等）。\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"2-创建空模型实例\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-创建空模型实例\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 创建空模型实例\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 使用上下文管理器创建空模型\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"with\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" ContextManagers(init_contexts):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    model \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" cls\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".from_config(config, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"unused_kwargs)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这里的关键是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"cls.from_config\"\n            })\n          })\n        })\n      }), \"，它调用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel.from_config\"\n            })\n          })\n        })\n      }), \" 方法，该方法由 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"ConfigMixin\"\n            })\n          })\n        })\n      }), \" 提供。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"from_config\"\n            })\n          })\n        })\n      }), \" 会：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"解析配置参数\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"调用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel.__init__\"\n              })\n            })\n          })\n        }), \" 构造函数\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"创建所有子模块（如下采样块、上采样块、注意力层等）\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"3-加载权重文件\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-加载权重文件\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 加载权重文件\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 加载权重文件\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"state_dict \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" load_state_dict(resolved_model_file[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"], \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"disable_mmap\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"disable_mmap, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dduf_entries\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"dduf_entries)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这一步加载预训练权重文件（如 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"diffusion_pytorch_model.bin\"\n            })\n          })\n        })\n      }), \" 或 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \".safetensors\"\n            })\n          })\n        })\n      }), \"）。\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"4-将权重加载到模型中\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#4-将权重加载到模型中\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"4. 将权重加载到模型中\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"model, missing_keys, unexpected_keys, mismatched_keys, offload_index, error_msgs \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" cls\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"._load_pretrained_model(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    model,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    state_dict,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 其他参数...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"_load_pretrained_model\"\n            })\n          })\n        })\n      }), \" 方法负责：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"将权重映射到模型参数\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"处理可能的形状不匹配\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"支持低内存加载\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"处理量化和设备映射\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"5-设备分配和后处理\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#5-设备分配和后处理\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"5. 设备分配和后处理\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 如果指定了设备映射，将模型分配到不同设备\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"if\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" device_map \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"is\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" not\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    dispatch_model(model, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"device_map_kwargs)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这一步处理模型在多 GPU 或 CPU/GPU 混合环境下的分配。\"\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"6-返回实例化的模型\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#6-返回实例化的模型\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"6. 返回实例化的模型\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"model.eval()  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 设置为评估模式\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" model\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"最终返回完全加载好的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 实例。\"]\n    }), \"\\n\", _jsxs(_components.h2, {\n      id: \"关键实现细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#关键实现细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"关键实现细节\"]\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"动态类型处理\"\n          }), \"：\"]\n        }), \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsxs(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: [_jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"if\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \" torch_dtype \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"is\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \" not\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#56B6C2\"\n                  },\n                  children: \" None\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \":\"\n                })]\n              }), \"\\n\", _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"    dtype_orig \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \" cls\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"._set_default_torch_dtype(torch_dtype)\"\n                })]\n              })]\n            })\n          })\n        }), \"\\n\", _jsx(_components.p, {\n          children: \"支持不同精度（如 fp16、bf16）的模型加载\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"低内存加载\"\n          }), \"：\"]\n        }), \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsxs(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: [_jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"if\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \" low_cpu_mem_usage:\"\n                })]\n              }), \"\\n\", _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"    init_contexts.append(accelerate.init_empty_weights())\"\n                })\n              })]\n            })\n          })\n        }), \"\\n\", _jsx(_components.p, {\n          children: \"通过 accelerate 库实现大模型的高效加载\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"权重修复\"\n          }), \"：\"]\n        }), \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"model._fix_state_dict_keys_on_load(state_dict)\"\n                })\n              })\n            })\n          })\n        }), \"\\n\", _jsx(_components.p, {\n          children: \"处理不同版本模型间的键名差异\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"\\n\", _jsxs(_components.p, {\n          children: [_jsx(_components.strong, {\n            children: \"设备映射\"\n          }), \"：\"]\n        }), \"\\n\", _jsx(_components.figure, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.pre, {\n            tabIndex: \"0\",\n            \"data-language\": \"python\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"python\",\n              \"data-theme\": \"plastic\",\n              style: {\n                display: \"grid\"\n              },\n              children: _jsxs(_components.span, {\n                \"data-line\": \"\",\n                children: [_jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \"device_map \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#E06C75\"\n                  },\n                  children: \"=\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \" _determine_device_map(model, device_map, max_memory, \"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#56B6C2\"\n                  },\n                  children: \"...\"\n                }), _jsx(_components.span, {\n                  style: {\n                    color: \"#A9B2C3\"\n                  },\n                  children: \")\"\n                })]\n              })\n            })\n          })\n        }), \"\\n\", _jsx(_components.p, {\n          children: \"智能分配模型层到不同设备\"\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"整个过程实现了从预训练权重到可用模型实例的无缝转换，同时处理了各种高级功能如设备管理、精度控制和内存优化。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细解释 @unet_2d_condition.py 中 UNet2DConditionModel 的结构\"]\n    }), \"\\n\", _jsxs(\"think\", {\n      children: [_jsxs(_components.p, {\n        children: [\"嗯，用户想让我详细解释 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"unet_2d_condition.py\"\n              })\n            })\n          })\n        }), \" 中的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \" 结构。首先，我需要回忆一下 UNet 的基本结构，特别是 Stable Diffusion 中的 UNet。Stable Diffusion 的 UNet 是一个条件模型，结合了文本嵌入作为输入，所以这个 UNet2DConditionModel 应该是在传统 UNet 的基础上增加了对条件输入的处理，比如文本嵌入或时间步信息。\"]\n      }), _jsx(_components.p, {\n        children: \"接下来，我需要考虑用户可能的背景。用户可能在使用或修改 Diffusers 库，或者在尝试理解 Stable Diffusion 的工作原理。他们可能遇到了问题，比如模型加载错误，或者想自定义 UNet 的结构，因此需要了解其内部组件。用户可能已经看过代码，但需要更清晰的解释，特别是各个模块的作用和连接方式。\"\n      }), _jsxs(_components.p, {\n        children: [\"我需要检查用户提供的代码片段，特别是\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"UNet2DConditionModel\"\n              })\n            })\n          })\n        }), \"的\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"__init__\"\n              })\n            })\n          })\n        }), \"方法，看看有哪些组件被初始化。比如，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"conv_in\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"time_embedding\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"down_blocks\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"mid_block\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"up_blocks\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"conv_out\"\n              })\n            })\n          })\n        }), \"等。这些部分对应了 UNet 的不同阶段，下采样、中间层、上采样等。\"]\n      }), _jsx(_components.p, {\n        children: \"然后，我需要考虑如何将这些组件组织成一个连贯的结构解释。可能需要分块讲解，比如输入处理、时间嵌入、下采样块、中间块、上采样块、输出处理等。同时，条件输入（如文本嵌入）是如何被整合到模型中的，比如通过交叉注意力机制。\"\n      }), _jsxs(_components.p, {\n        children: [\"另外，用户可能对某些参数或配置选项感兴趣，比如\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"attention_head_dim\"\n              })\n            })\n          })\n        }), \"、\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"cross_attention_dim\"\n              })\n            })\n          })\n        }), \"等，这些参数如何影响模型结构。需要解释这些参数的作用，以及它们在模型中的具体应用位置。\"]\n      }), _jsxs(_components.p, {\n        children: [\"还要注意代码中的一些特定处理，比如\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"class_embeddings_concat\"\n              })\n            })\n          })\n        }), \"如何处理类别嵌入，\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"resnet_time_scale_shift\"\n              })\n            })\n          })\n        }), \"的不同模式对残差块的影响，以及\", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"attention_type\"\n              })\n            })\n          })\n        }), \"的选择（如默认的交叉注意力或其他类型）。\"]\n      }), _jsx(_components.p, {\n        children: \"最后，可能需要提供一个结构图或流程图，帮助用户更直观地理解数据在模型中的流动路径，特别是条件信息如何在不同层中被整合。如果用户需要进一步的代码示例或调试帮助，也需要在解释中提及可能的常见问题或配置错误。\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"以下是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 的详细结构解析，该模型是 Stable Diffusion 的核心组件，负责噪声预测和条件控制：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"整体架构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#整体架构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"整体架构\"\n      })]\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"graph TD\\n    A[输入] --\u003e B[Conv2D_3x3]\\n    B --\u003e C[时间嵌入]\\n    C --\u003e D[下采样块 x4]\\n    D --\u003e E[中间块]\\n    E --\u003e F[上采样块 x4]\\n    F --\u003e G[Conv2D_3x3]\\n    G --\u003e H[输出]\\n    D --\u003e|跳跃连接| F\\n    C --\u003e|条件注入| D\\n    C --\u003e|条件注入| E\\n    C --\u003e|条件注入| F\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"核心组件\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#核心组件\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"核心组件\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-输入处理\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-输入处理\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 输入处理\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_in \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    in_channels,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    block_out_channels[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"],\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"作用：将输入图像（latent space）映射到初始特征空间\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"参数：\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"in_channels\"\n                  })\n                })\n              })\n            }), \"：输入通道数（通常为 4）\"]\n          }), \"\\n\", _jsxs(_components.li, {\n            children: [_jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"block_out_channels[0]\"\n                  })\n                })\n              })\n            }), \"：首层输出通道数（通常为 320）\"]\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-时间嵌入系统\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-时间嵌入系统\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 时间嵌入系统\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".time_embedding \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" TimestepEmbedding(\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    timestep_input_dim,  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 时间步编码维度\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    time_embed_dim,       \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 嵌入维度（通常1280）\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"act_fn         \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 激活函数（如silu）\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"功能：将时间步信息编码为条件向量\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"流程：\", \"\\n\", _jsxs(_components.ol, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"通过正弦位置编码生成时间特征\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"经过全连接层和非线性激活\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"与文本嵌入等条件信息融合\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"3-下采样模块\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-下采样模块\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 下采样模块\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".down_blocks \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.ModuleList([\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    DownBlock2D(\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"320\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"320\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        num_layers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1e-5\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"silu\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        cross_attention_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"768\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 文本嵌入维度\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    ),\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 其他下采样块...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"])\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"结构特点：\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsxs(_components.li, {\n            children: [\"每个下采样块包含：\", \"\\n\", _jsxs(_components.ul, {\n              children: [\"\\n\", _jsx(_components.li, {\n                children: \"多个残差块（ResNet）\"\n              }), \"\\n\", _jsx(_components.li, {\n                children: \"交叉注意力层（处理文本条件）\"\n              }), \"\\n\", _jsx(_components.li, {\n                children: \"可能的降采样卷积\"\n              }), \"\\n\"]\n            }), \"\\n\"]\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"典型配置：4 个下采样块，通道数逐级增加（320→640→1280→1280）\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"4-中间模块\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#4-中间模块\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"4. 中间模块\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".mid_block \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" UNetMidBlock2DCrossAttn(\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1e-5\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"silu\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"    attn_num_head_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"核心组成：\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"残差块\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"自注意力机制\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"交叉注意力机制\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"作用：在最低分辨率层进行全局特征整合\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"5-上采样模块\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#5-上采样模块\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"5. 上采样模块\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".up_blocks \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.ModuleList([\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    UpBlock2D(\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        prev_output_channel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1280\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        num_layers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1e-5\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"        resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"silu\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    ),\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 其他上采样块...\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"])\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"关键特性：\", \"\\n\", _jsxs(_components.ul, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"包含残差块和交叉注意力层\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"通过跳跃连接融合下采样特征\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"使用转置卷积或插值进行上采样\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"6-输出处理\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#6-输出处理\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"6. 输出处理\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_norm_out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"320\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_act \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.SiLU()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"320\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"4\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [\"流程：\", \"\\n\", _jsxs(_components.ol, {\n          children: [\"\\n\", _jsx(_components.li, {\n            children: \"归一化处理\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"激活函数\"\n          }), \"\\n\", _jsx(_components.li, {\n            children: \"最终卷积将特征映射到输出空间（4 通道）\"\n          }), \"\\n\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"条件控制机制\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#条件控制机制\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"条件控制机制\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"交叉注意力层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#交叉注意力层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"交叉注意力层\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" CrossAttention\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"query_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(query_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k(context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v(context)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 计算注意力权重...\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" output\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"作用：将文本嵌入（context）注入到图像特征中\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"位置：每个下采样和上采样块中都包含该层\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"关键参数说明\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#关键参数说明\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"关键参数说明\"\n      })]\n    }), \"\\n\", _jsxs(_components.table, {\n      children: [_jsx(_components.thead, {\n        children: _jsxs(_components.tr, {\n          children: [_jsx(_components.th, {\n            children: \"参数\"\n          }), _jsx(_components.th, {\n            children: \"典型值\"\n          }), _jsx(_components.th, {\n            children: \"作用\"\n          })]\n        })\n      }), _jsxs(_components.tbody, {\n        children: [_jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"cross_attention_dim\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            children: \"768\"\n          }), _jsx(_components.td, {\n            children: \"文本嵌入的维度（CLIP 文本编码器输出维度）\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"attention_head_dim\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            children: \"8/16\"\n          }), _jsx(_components.td, {\n            children: \"注意力头的维度\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"layers_per_block\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            children: \"2\"\n          }), _jsx(_components.td, {\n            children: \"每个块中的残差层数\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"num_attention_heads\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            children: \"8\"\n          }), _jsx(_components.td, {\n            children: \"注意力头数量\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"resnet_time_scale_shift\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            children: \"\\\"default\\\"\"\n          }), _jsx(_components.td, {\n            children: \"时间条件注入方式（add/scale）\"\n          })]\n        })]\n      })]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"数据流动示例\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#数据流动示例\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"数据流动示例\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timestep\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"encoder_hidden_states\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 1. 输入处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_in(x)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 2. 时间嵌入\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    t_emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".time_embedding(timestep)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 3. 下采样\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    down_samples \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" []\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"    for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" down_block \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".down_blocks:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" down_block(x, t_emb, encoder_hidden_states)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        down_samples.append(x)\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 4. 中间处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".mid_block(x, t_emb, encoder_hidden_states)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 5. 上采样\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"    for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" up_block \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".up_blocks:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" up_block(x, down_samples.pop(), t_emb, encoder_hidden_states)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 6. 输出\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_norm_out(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_act(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"    return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_out(x)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果需要更详细的某个组件解析（如下采样块的具体实现），可以进一步展开说明。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细解释下采样快的细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细解释下采样快的细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细解释下采样快的细节\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"好的，下面是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中下采样块的详细结构和实现细节：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"下采样块概述\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#下采样块概述\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"下采样块概述\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下采样块的主要功能是逐步降低特征图的空间分辨率，同时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。每个下采样块通常包含多个残差块和一个降采样操作。\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"下采样块的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#下采样块的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"下采样块的结构\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-残差块resnet-block\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-残差块resnet-block\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 残差块（ResNet Block）\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"每个下采样块包含多个残差块，负责特征提取和非线性变换。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" ResNetBlock\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", in_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(in_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(out_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(temb_channels, out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 时间嵌入注入\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj(temb)[:, :, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 残差连接\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"特征归一化\"\n        }), \"：使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"GroupNorm\"\n              })\n            })\n          })\n        }), \" 进行归一化，稳定训练过程。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"激活函数\"\n        }), \"：通常使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"SiLU\"\n              })\n            })\n          })\n        }), \" 或 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ReLU\"\n              })\n            })\n          })\n        }), \"。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积层\"\n        }), \"：两个 3x3 卷积层，保持特征图大小不变。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"时间嵌入\"\n        }), \"：通过全连接层将时间嵌入注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-交叉注意力层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-交叉注意力层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 交叉注意力层\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" CrossAttention\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"query_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(query_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" query_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" -\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0.5\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k(context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v(context)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqd,bkd-\u003ebqk\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", q, k) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" attn_weights.softmax(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqk,bvd-\u003ebqd\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", attn_weights, v)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"查询、键、值\"\n        }), \"：通过线性变换生成查询、键和值向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"注意力计算\"\n        }), \"：使用缩放点积注意力机制。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"条件注入\"\n        }), \"：将文本嵌入等条件信息注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"3-降采样操作\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-降采样操作\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 降采样操作\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通常使用卷积或池化操作来降低特征图的空间分辨率。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" Downsample\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(in_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"stride\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv(x)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积降采样\"\n        }), \"：通过步长为 2 的卷积实现降采样，减少特征图的宽高。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"通道数增加\"\n        }), \"：通常在降采样时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"下采样块的完整实现\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#下采样块的完整实现\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"下采样块的完整实现\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" DownBlock2D\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"num_layers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"cross_attention_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnets \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.ModuleList([\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            ResNetBlock(in_channels \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"if\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" i \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"==\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" else\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"            for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" i \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" range\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(num_layers)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        ])\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attention \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" CrossAttention(out_channels, cross_attention_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".downsample \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" Downsample(out_channels, out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" resnet \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnets:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" resnet(x, temb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attention(x, context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".downsample(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"残差块\"\n        }), \"：多个残差块串联，进行特征提取。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"交叉注意力\"\n        }), \"：在特征提取后注入条件信息。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"降采样\"\n        }), \"：降低特征图的空间分辨率。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-3\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-3\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"下采样块在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将输入图像的特征压缩到更低的分辨率，为后续的中间块和上采样块提供丰富的特征信息。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细讲解上采样块的细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细讲解上采样块的细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细讲解上采样块的细节\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"好的，下面是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中上采样块的详细结构和实现细节：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"上采样块概述\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#上采样块概述\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"上采样块概述\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"上采样块的主要功能是逐步恢复特征图的空间分辨率，同时结合下采样块的特征，通过跳跃连接（skip connections）实现特征的融合。每个上采样块通常包含多个残差块和一个上采样操作。\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"上采样块的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#上采样块的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"上采样块的结构\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-残差块resnet-block-1\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-残差块resnet-block-1\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 残差块（ResNet Block）\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"每个上采样块包含多个残差块，负责特征提取和非线性变换。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" ResNetBlock\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", in_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(in_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(out_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(temb_channels, out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 时间嵌入注入\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj(temb)[:, :, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 残差连接\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"特征归一化\"\n        }), \"：使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"GroupNorm\"\n              })\n            })\n          })\n        }), \" 进行归一化，稳定训练过程。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"激活函数\"\n        }), \"：通常使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"SiLU\"\n              })\n            })\n          })\n        }), \" 或 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ReLU\"\n              })\n            })\n          })\n        }), \"。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积层\"\n        }), \"：两个 3x3 卷积层，保持特征图大小不变。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"时间嵌入\"\n        }), \"：通过全连接层将时间嵌入注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-交叉注意力层-1\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-交叉注意力层-1\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 交叉注意力层\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" CrossAttention\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"query_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(query_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" query_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" -\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0.5\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k(context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v(context)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqd,bkd-\u003ebqk\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", q, k) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" attn_weights.softmax(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqk,bvd-\u003ebqd\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", attn_weights, v)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"查询、键、值\"\n        }), \"：通过线性变换生成查询、键和值向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"注意力计算\"\n        }), \"：使用缩放点积注意力机制。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"条件注入\"\n        }), \"：将文本嵌入等条件信息注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"3-上采样操作\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-上采样操作\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 上采样操作\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"通常使用转置卷积或插值操作来增加特征图的空间分辨率。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" Upsample\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.ConvTranspose2d(in_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"stride\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"output_padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv(x)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"转置卷积上采样\"\n        }), \"：通过转置卷积实现上采样，增加特征图的宽高。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"通道数减少\"\n        }), \"：通常在上采样时减少通道数，以便恢复到输入图像的通道数。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"上采样块的完整实现\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#上采样块的完整实现\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"上采样块的完整实现\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" UpBlock2D\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"prev_output_channel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"num_layers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"cross_attention_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnets \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.ModuleList([\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            ResNetBlock(in_channels \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"if\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" i \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"==\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" else\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"            for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" i \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" range\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(num_layers)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        ])\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attention \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" CrossAttention(out_channels, cross_attention_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".upsample \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" Upsample(out_channels, out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"res_samples\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        for\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" resnet \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"in\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnets:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" resnet(x, temb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attention(x, context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".upsample(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"残差块\"\n        }), \"：多个残差块串联，进行特征提取。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"交叉注意力\"\n        }), \"：在特征提取后注入条件信息。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"上采样\"\n        }), \"：增加特征图的空间分辨率。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-4\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-4\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"上采样块在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将特征图的分辨率恢复到输入图像的大小，并结合下采样块的特征实现特征的融合。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细讲解中间模块细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细讲解中间模块细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细讲解中间模块细节\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"好的，下面是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中中间模块（Mid Block）的详细结构和实现细节：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"中间模块概述\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#中间模块概述\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"中间模块概述\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"中间模块位于下采样和上采样块之间，负责在最低分辨率的特征图上进行全局特征整合。它通常包含残差块和注意力机制，以便在特征图的最小空间维度上进行复杂的特征交互。\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"中间模块的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#中间模块的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"中间模块的结构\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-残差块resnet-block-2\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-残差块resnet-block-2\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 残差块（ResNet Block）\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"中间模块通常包含一个或多个残差块，用于特征提取和非线性变换。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" ResNetBlock\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", in_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(in_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"resnet_eps)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, resnet_act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(out_channels, out_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(temb_channels, out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm1(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act1(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv1(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".norm2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act2(h)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv2(h)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 时间嵌入注入\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".temb_proj(temb)[:, :, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"+\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 残差连接\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"特征归一化\"\n        }), \"：使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"GroupNorm\"\n              })\n            })\n          })\n        }), \" 进行归一化，稳定训练过程。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"激活函数\"\n        }), \"：通常使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"SiLU\"\n              })\n            })\n          })\n        }), \" 或 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ReLU\"\n              })\n            })\n          })\n        }), \"。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积层\"\n        }), \"：两个 3x3 卷积层，保持特征图大小不变。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"时间嵌入\"\n        }), \"：通过全连接层将时间嵌入注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-自注意力层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-自注意力层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 自注意力层\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"自注意力层用于在特征图的最小空间维度上进行全局特征交互。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" SelfAttention\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_qkv \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(dim, dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"bias\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"False\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(dim, dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" -\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0.5\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        b, n, _, h \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" *\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"x.shape, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".heads\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        qkv \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_qkv(x).chunk(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        q, k, v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" map\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"lambda\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \" t\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": t.reshape(b, n, h, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \").transpose(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"), qkv)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        dots \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bhid,bhjd-\u003ebhij\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", q, k) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" dots.softmax(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bhij,bhjd-\u003ebhid\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", attn, v)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out.transpose(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \").reshape(b, n, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_out(out)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"查询、键、值\"\n        }), \"：通过线性变换生成查询、键和值向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"注意力计算\"\n        }), \"：使用缩放点积注意力机制。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"全局特征交互\"\n        }), \"：在特征图的最小空间维度上进行全局特征交互。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"3-交叉注意力层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#3-交叉注意力层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"3. 交叉注意力层\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" CrossAttention\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"query_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(query_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(context_dim, query_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" query_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"**\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" -\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0.5\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"context\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        q \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_q(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        k \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_k(context)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        v \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".to_v(context)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqd,bkd-\u003ebqk\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", q, k) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".scale\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        attn_weights \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" attn_weights.softmax(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.einsum(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"bqk,bvd-\u003ebqd\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", attn_weights, v)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" out\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"查询、键、值\"\n        }), \"：通过线性变换生成查询、键和值向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"注意力计算\"\n        }), \"：使用缩放点积注意力机制。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"条件注入\"\n        }), \"：将文本嵌入等条件信息注入到特征图中。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"中间模块的完整实现\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#中间模块的完整实现\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"中间模块的完整实现\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" UNetMidBlock2DCrossAttn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_eps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"resnet_act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"attn_num_head_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnet1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attn1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" SelfAttention(in_channels, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"heads\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"attn_num_head_channels)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".cross_attn \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" CrossAttention(in_channels, in_channels)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnet2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"temb\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"encoder_hidden_states\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"attention_mask\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"cross_attention_kwargs\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnet1(x, temb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".attn1(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".cross_attn(x, encoder_hidden_states)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".resnet2(x, temb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"残差块\"\n        }), \"：两个残差块串联，进行特征提取。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"自注意力\"\n        }), \"：在特征图的最小空间维度上进行全局特征交互。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"交叉注意力\"\n        }), \"：在特征提取后注入条件信息。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-5\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-5\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"中间模块在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，通过多层次的特征提取和注意力机制，在最低分辨率的特征图上进行全局特征整合，为上采样块提供丰富的特征信息。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细讲解输入处理与输出处理模块细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细讲解输入处理与输出处理模块细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细讲解输入处理与输出处理模块细节\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"好的，下面是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中输入处理和输出处理模块的详细结构和实现细节：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"输入处理模块\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#输入处理模块\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"输入处理模块\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"输入处理模块的主要功能是将输入的图像特征（通常是潜在空间表示）映射到模型的初始特征空间。\"\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-输入卷积层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-输入卷积层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 输入卷积层\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" InputProcessing\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_in \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            in_channels,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            out_channels,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"            kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"            padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        )\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_in(x)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积层\"\n        }), \"：使用一个 3x3 的卷积层，将输入的通道数映射到模型的初始通道数。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"作用\"\n        }), \"：将输入图像的特征映射到更高维度的特征空间，以便后续的特征提取。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"输出处理模块\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#输出处理模块\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"输出处理模块\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"输出处理模块的主要功能是将模型的最终特征图映射回输入的通道数，通常是生成图像的潜在空间表示。\"\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-输出卷积层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-输出卷积层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 输出卷积层\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" OutputProcessing\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_norm_out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.GroupNorm(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"32\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", in_channels)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_act \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.SiLU()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_out \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Conv2d(\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            in_channels,\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"            out_channels,\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"            kernel_size\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"            padding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        )\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_norm_out(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_act(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".conv_out(x)\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"归一化层\"\n        }), \"：使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"GroupNorm\"\n              })\n            })\n          })\n        }), \" 对特征图进行归一化，稳定输出。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"激活函数\"\n        }), \"：使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"SiLU\"\n              })\n            })\n          })\n        }), \" 激活函数，增加非线性。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"卷积层\"\n        }), \"：使用一个 3x3 的卷积层，将特征图映射回输入的通道数。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"输入与输出处理的完整实现\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#输入与输出处理的完整实现\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"输入与输出处理的完整实现\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" UNet2DConditionModel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"in_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"block_out_channels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 输入处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".input_processing \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" InputProcessing(in_channels, block_out_channels[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"])\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 其他模块（下采样、中间、上采样）\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 输出处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".output_processing \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" OutputProcessing(block_out_channels[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"], out_channels)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 输入处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".input_processing(x)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 其他模块处理\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 输出处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        x \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".output_processing(x)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"输入处理\"\n        }), \"：将输入图像的特征映射到模型的初始特征空间。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"输出处理\"\n        }), \"：将模型的最终特征图映射回输入的通道数。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-6\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-6\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"输入处理和输出处理模块在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，分别负责将输入图像的特征映射到模型的初始特征空间，以及将模型的最终特征图映射回输入的通道数。这两个模块通过简单的卷积操作实现了特征的维度变换，为模型的特征提取和生成提供了基础。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"q-详细讲解时间嵌入系统的细节\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#q-详细讲解时间嵌入系统的细节\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Q: 详细讲解时间嵌入系统的细节\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"时间嵌入系统在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，它将时间步信息编码为条件向量，以便在模型的各个阶段中注入时间信息。下面是时间嵌入系统的详细结构和实现细节：\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"时间嵌入系统概述\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#时间嵌入系统概述\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"时间嵌入系统概述\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"时间嵌入系统的主要功能是将时间步（timestep）信息转换为高维向量，这些向量在模型的残差块中被用作条件信息，以指导模型在不同时间步的特征提取和生成过程。\"\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"时间嵌入系统的结构\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#时间嵌入系统的结构\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"时间嵌入系统的结构\"\n      })]\n    }), \"\\n\", _jsxs(_components.h4, {\n      id: \"1-正弦位置编码\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#1-正弦位置编码\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"1. 正弦位置编码\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"时间嵌入系统通常使用正弦位置编码来生成初始时间特征。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" get_timestep_embedding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timesteps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"embedding_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    half_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" embedding_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"//\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" math.log(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"10000\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \") \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"/\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" (half_dim \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.exp(torch.arange(half_dim, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dtype\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"torch.float32) \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" -\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"emb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" timesteps[:, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"] \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"*\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" emb[\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", :]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" torch.cat([torch.sin(emb), torch.cos(emb)], \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=-\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"    return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" emb\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"正弦和余弦函数\"\n        }), \"：使用正弦和余弦函数生成时间步的周期性表示。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"维度扩展\"\n        }), \"：将时间步扩展为高维向量，维度为 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"embedding_dim\"\n              })\n            })\n          })\n        }), \"。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h4, {\n      id: \"2-时间嵌入层\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#2-时间嵌入层\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"2. 时间嵌入层\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"时间嵌入层将正弦位置编码的输出进一步转换为模型所需的高维条件向量。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" TimestepEmbedding\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timestep_input_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"time_embed_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".linear1 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(timestep_input_dim, time_embed_dim)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" getattr\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(nn, act_fn)()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".linear2 \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" nn.Linear(time_embed_dim, time_embed_dim)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timesteps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" get_timestep_embedding(timesteps, \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".linear1.in_features)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".linear1(emb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".act(emb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".linear2(emb)\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" emb\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"线性变换\"\n        }), \"：使用两个线性层将时间步嵌入转换为高维条件向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"激活函数\"\n        }), \"：通常使用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"SiLU\"\n              })\n            })\n          })\n        }), \" 或 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"ReLU\"\n              })\n            })\n          })\n        }), \" 激活函数，增加非线性。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"时间嵌入系统的完整实现\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#时间嵌入系统的完整实现\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"时间嵌入系统的完整实现\"\n      })]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"python\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"python\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \" UNet2DConditionModel\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"nn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"Module\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" __init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timestep_input_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"time_embed_dim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"act_fn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        super\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"().\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"__init__\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"()\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".time_embedding \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" TimestepEmbedding(timestep_input_dim, time_embed_dim, act_fn)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#61AFEF\"\n              },\n              children: \"    def\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \" forward\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"x\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#C6CCD7\"\n              },\n              children: \"timesteps\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"):\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 时间嵌入\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        t_emb \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \" self\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \".time_embedding(timesteps)\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 其他模块处理\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"        return\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" x\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"时间嵌入\"\n        }), \"：将时间步信息转换为高维条件向量。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"注入到模型\"\n        }), \"：时间嵌入被注入到模型的各个阶段，指导特征提取和生成。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.hr, {}), \"\\n\", _jsxs(_components.h3, {\n      id: \"总结-7\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#总结-7\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), _jsx(_components.strong, {\n        children: \"总结\"\n      })]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"时间嵌入系统在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"UNet2DConditionModel\"\n            })\n          })\n        })\n      }), \" 中起到了关键作用，通过将时间步信息编码为高维条件向量，指导模型在不同时间步的特征提取和生成过程。这一系统通过正弦位置编码和线性变换实现了时间信息的高效编码，为模型的时间条件注入提供了基础。\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = {\n    ..._provideComponents(),\n    ...props.components\n  };\n  return MDXLayout ? _jsx(MDXLayout, {\n    ...props,\n    children: _jsx(_createMdxContent, {\n      ...props\n    })\n  }) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error(\"Expected \" + (component ? \"component\" : \"object\") + \" `\" + id + \"` to be defined: you likely forgot to import, pass, or provide it.\");\n}\n","frontmatter":{},"scope":{}},"meta":{"content":"\n\u003e [!summary]\n\u003e 以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录\n\n# Q: @train_text_to_image_lora.py 这段代码中如何体现 LoRA “使用两个低秩矩阵进行微调” 的步骤？\n\n在 `train_text_to_image_lora.py` 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。\n\n以下是脚本中如何体现 LoRA 使用两个低秩矩阵进行微调的步骤：\n\n### 1. LoRA 配置\n\n在脚本中，LoRA 的配置通常通过 `LoraConfig` 类来定义。这个配置包括低秩矩阵的秩（`rank`）和其他参数：\n\n```python\nunet_lora_config = LoraConfig(\n    r=args.rank,  # 低秩矩阵的秩\n    lora_alpha=args.rank,  # LoRA 的缩放因子\n    init_lora_weights=\"gaussian\",  # 初始化权重的方法\n    target_modules=[\"to_k\", \"to_q\", \"to_v\", \"to_out.0\"],  # 目标模块\n)\n```\n\n### 2. 添加 LoRA 层\n\n在模型中插入 LoRA 层是通过调用 `add_adapter` 方法实现的：\n\n```python\nunet.add_adapter(unet_lora_config)\n```\n\n这个方法会在指定的目标模块中插入两个低秩矩阵 \\(A\\) 和 \\(B\\)，用于调整模型的权重。具体来说，LoRA 在模型的注意力层中插入这些矩阵，以便在不改变原始权重的情况下进行微调。\n\n### 3. 训练过程中的权重更新\n\n在训练过程中，只有 LoRA 插入的低秩矩阵的参数是可训练的。原始模型的权重保持冻结状态。这是通过以下代码实现的：\n\n```python\n# freeze parameters of models to save more memory\nunet.requires_grad_(False)\nvae.requires_grad_(False)\ntext_encoder.requires_grad_(False)\n```\n\n通过这种方式，训练过程只会更新 LoRA 层的参数，而不会影响原始模型的权重。\n\n### 4. 参数更新\n\n在训练循环中，反向传播和参数更新步骤只会影响 LoRA 层的参数：\n\n```python\n# Backpropagate\naccelerator.backward(loss)\nif accelerator.sync_gradients:\n    params_to_clip = lora_layers\n    accelerator.clip_grad_norm_(params_to_clip, args.max_grad_norm)\noptimizer.step()\nlr_scheduler.step()\noptimizer.zero_grad()\n```\n\n这里的 `lora_layers` 是一个过滤器，只包含 LoRA 层的可训练参数。\n\n### 总结\n\n通过在模型的特定层中插入两个低秩矩阵，LoRA 实现了参数高效的微调。这种方法允许在不改变原始模型权重的情况下，通过调整低秩矩阵来适应新的数据分布，从而实现高效的模型微调。\n\n# Q: unet 是个什么样的结构？\n\nUNet 是一种常用于图像生成和分割任务的神经网络架构。它最初是在医学图像分割领域中引入的，但由于其强大的特性和灵活性，UNet 也被广泛应用于其他计算机视觉任务，包括图像生成、去噪和超分辨率等。\n\n### UNet 的基本结构\n\nUNet 的结构可以分为两个主要部分：编码器（下采样路径）和解码器（上采样路径），中间通过跳跃连接（skip connections）相连。\n\n1. **编码器（下采样路径）**：\n\n   - 由一系列卷积层和池化层组成。\n   - 每个卷积层通常后接一个激活函数（如 ReLU）。\n   - 池化层用于逐步减少特征图的空间维度，同时增加特征的抽象程度。\n\n2. **解码器（上采样路径）**：\n\n   - 由一系列上采样层（如反卷积或上采样）和卷积层组成。\n   - 逐步恢复特征图的空间维度。\n   - 使用跳跃连接将编码器中相应层的特征图与解码器中的特征图连接，以保留细节信息。\n\n3. **跳跃连接（Skip Connections）**：\n   - 将编码器中的特征图直接连接到解码器中相应层的特征图。\n   - 这种连接方式有助于保留输入图像的细节信息，改善生成结果的质量。\n\n### UNet 在 Stable Diffusion 中的应用\n\n在 Stable Diffusion 模型中，UNet 作为核心组件用于处理图像的潜在表示。具体来说，UNet 在扩散模型中用于预测噪声残差，从而逐步生成高质量的图像。\n\n- **输入**：UNet 接收一个带有噪声的潜在表示（通常是一个低维的特征图）。\n- **输出**：UNet 输出一个与输入相同大小的特征图，表示对噪声的预测。\n- **训练目标**：通过最小化预测噪声与真实噪声之间的差异，UNet 学会如何去除噪声，从而生成清晰的图像。\n\n### UNet 的优势\n\n- **高效的特征提取**：通过编码器提取多尺度特征。\n- **细节保留**：通过跳跃连接保留输入图像的细节信息。\n- **灵活性**：可以适应不同的输入尺寸和任务需求。\n\nUNet 的这种结构使其在图像生成任务中表现出色，特别是在需要高分辨率输出和细节保留的场景中。\n\n# Q: 为什么这里 unet、 vae 、 tokenizer 等几个模型都是从同一个路径加载的？\n\n在这个代码片段中，`unet`、`vae`、`tokenizer` 和其他组件都是从同一个路径加载的，这是因为它们都是 Stable Diffusion 模型的一部分。Stable Diffusion 是一个复杂的生成模型，通常由多个子模块组成，每个子模块负责不同的任务。以下是这些组件的作用和为什么它们从同一路径加载的原因：\n\n### 1. 统一的模型路径\n\n- **路径一致性**：所有这些组件都从同一个路径加载，因为它们通常被打包在一个预训练模型中。这个路径通常指向一个包含所有必要文件的目录或一个 Hugging Face Hub 上的模型仓库。\n- **版本控制**：通过从同一个路径加载，确保所有组件使用的是同一个版本的模型，避免版本不匹配导致的兼容性问题。\n\n### 2. 各个组件的作用\n\n- **UNet (`unet`)**：\n\n  - 负责处理图像的潜在表示，预测噪声残差。\n  - 在扩散模型中用于逐步生成高质量的图像。\n\n- **VAE (`vae`)**：\n\n  - 自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。\n  - 在 Stable Diffusion 中，VAE 用于将输入图像转换为潜在表示，供 UNet 处理。\n\n- **Tokenizer (`tokenizer`)**：\n\n  - 用于将文本输入（如生成图像的描述）转换为模型可理解的标记。\n  - 在文本到图像生成任务中，tokenizer 将文本描述转换为输入 ID，供文本编码器使用。\n\n- **Text Encoder (`text_encoder`)**：\n\n  - 将文本输入编码为特征向量，供 UNet 使用。\n  - 在生成过程中，文本编码器提供条件信息，指导图像生成。\n\n- **Noise Scheduler (`noise_scheduler`)**：\n  - 控制扩散过程中的噪声添加和去除。\n  - 在训练和推理过程中，调度器决定在每个时间步添加多少噪声。\n\n### 3. 统一加载的好处\n\n- **简化管理**：从同一位置加载所有组件简化了模型管理和部署。\n- **一致性**：确保所有组件在同一训练配置下工作，避免不兼容问题。\n- **便捷性**：用户只需指定一个路径或模型标识符，即可加载整个模型的所有必要部分。\n\n通过这种方式，用户可以方便地使用预训练的 Stable Diffusion 模型进行微调或推理，而不必单独管理每个组件的版本和路径。\n\n# Q: 这些是 Stable Diffusion 的内部设计对吧？这些都在哪篇论文里提出的？ @Web\n\nStable Diffusion 是一种基于扩散模型的图像生成技术，其核心组件和设计在多篇论文中得到了详细描述。以下是与 Stable Diffusion 相关的关键论文：\n\n1. **扩散模型的基础**：\n\n   - **论文**：_Denoising Diffusion Probabilistic Models_ by Jonathan Ho, Ajay Jain, Pieter Abbeel (2020)\n   - **链接**：[arXiv:2006.11239](https://arxiv.org/abs/2006.11239)\n   - **内容**：这篇论文介绍了扩散模型的基本原理和去噪过程，是 Stable Diffusion 的理论基础。\n\n2. **Stable Diffusion 的具体实现**：\n\n   - **论文**：_High-Resolution Image Synthesis with Latent Diffusion Models_ by Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, Björn Ommer (2021)\n   - **链接**：[arXiv:2112.10752](https://arxiv.org/abs/2112.10752)\n   - **内容**：这篇论文详细描述了 Stable Diffusion 的架构，包括使用潜在空间的扩散模型、VAE 的应用以及如何在高分辨率图像生成中实现高效计算。\n\n3. **CLIP 模型的使用**：\n   - **论文**：_Learning Transferable Visual Models From Natural Language Supervision_ by Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, Gretchen Krueger, Ilya Sutskever (2021)\n   - **链接**：[arXiv:2103.00020](https://arxiv.org/abs/2103.00020)\n   - **内容**：CLIP 模型用于将文本和图像结合在一起进行训练，Stable Diffusion 使用 CLIP 作为文本编码器来处理文本输入。\n\n这些论文共同构成了 Stable Diffusion 的理论和技术基础，描述了其内部设计和实现细节。通过结合扩散模型、VAE 和 CLIP，Stable Diffusion 实现了高效的文本到图像生成。\n\n# Q: 解释 StableDiffusionPipeline 的结构 @pipeline_stable_diffusion.py\n\n`StableDiffusionPipeline` 是一个用于实现 Stable Diffusion 模型的核心类，负责将多个组件组合在一起以实现文本到图像的生成。以下是对 `StableDiffusionPipeline` 结构的详细解释：\n\n### 继承关系\n\n`StableDiffusionPipeline` 继承了多个类，这些类为其提供了不同的功能：\n\n- **DiffusionPipeline**: 提供了基本的扩散模型功能。\n- **StableDiffusionMixin**: 包含与 Stable Diffusion 相关的特定功能。\n- **TextualInversionLoaderMixin**: 支持文本反转加载功能。\n- **StableDiffusionLoraLoaderMixin**: 支持 LoRA（低秩适应）加载功能。\n- **IPAdapterMixin**: 提供 IP 适配器功能。\n- **FromSingleFileMixin**: 支持从单个文件加载模型。\n\n### 初始化方法\n\n`__init__` 方法用于初始化 `StableDiffusionPipeline` 的各个组件：\n\n- **VAE (`vae`)**: 自动编码器，用于将图像编码为潜在空间表示，并从潜在空间解码回图像。\n- **Text Encoder (`text_encoder`)**: 使用 CLIP 模型将文本输入编码为特征向量。\n- **Tokenizer (`tokenizer`)**: 将文本输入转换为模型可理解的标记。\n- **UNet (`unet`)**: 负责处理图像的潜在表示，预测噪声残差。\n- **Scheduler (`scheduler`)**: 控制扩散过程中的噪声添加和去除。\n- **Safety Checker (`safety_checker`)**: 用于检查生成图像的安全性。\n- **Feature Extractor (`feature_extractor`)**: 用于从图像中提取特征。\n- **Image Encoder (`image_encoder`)**: 可选组件，用于图像编码。\n\n### 功能和方法\n\n- **Deprecation Warnings**: 在初始化过程中，检查 `scheduler` 和 `unet` 的配置是否过时，并提供相应的弃用警告。\n- **Module Registration**: 使用 `register_modules` 方法将各个组件注册到管道中，便于统一管理。\n- **Safety Checks**: 提供安全检查功能，确保生成的图像符合安全标准。\n- **Guidance Scale**: 提供指导比例的计算和应用，用于控制生成图像的风格和内容。\n- **Image Processing**: 包含图像处理方法，如 `decode_latents`，用于将潜在表示转换为图像。\n\n### 属性\n\n- **Guidance Scale**: 控制生成图像的风格和内容。\n- **Cross Attention**: 提供交叉注意力机制的参数。\n- **Timesteps**: 控制扩散过程的时间步数。\n\n### 设计目的\n\n`StableDiffusionPipeline` 的设计目的是将 Stable Diffusion 模型的各个组件整合在一起，提供一个统一的接口来进行文本到图像的生成。通过继承和组合多个功能模块，`StableDiffusionPipeline` 能够灵活地支持不同的生成任务和配置需求。\n\n# Q: @pipeline_utils.py 解释 DiffusionPipeline 的结构，以及 from_pretrained 在做什么\n\n`DiffusionPipeline` 是一个用于管理和执行扩散模型的核心类，提供了加载、配置和运行模型的基本功能。以下是对 `DiffusionPipeline` 结构和 `from_pretrained` 方法的详细解释：\n\n### DiffusionPipeline 的结构\n\n`DiffusionPipeline` 是一个抽象基类，定义了扩散模型的基本接口和功能。其主要结构包括：\n\n1. **模块注册**：\n\n   - `register_modules` 方法用于注册模型的各个组件（如 VAE、UNet、调度器等），便于统一管理和调用。\n\n2. **模型加载**：\n\n   - 提供从预训练模型加载各个组件的功能，通常通过 `from_pretrained` 方法实现。\n\n3. **推理接口**：\n\n   - 定义了模型推理的基本接口，用户可以通过调用这些接口生成图像或其他输出。\n\n4. **配置管理**：\n\n   - 提供配置加载和保存功能，便于模型的复用和共享。\n\n5. **实用工具**：\n   - 包含一些实用工具方法，如检查版本、处理设备映射等。\n\n### from_pretrained 方法\n\n`from_pretrained` 是 `DiffusionPipeline` 中的一个关键方法，用于从预训练模型加载管道的各个组件。其主要功能包括：\n\n1. **模型路径解析**：\n\n   - 接受一个模型标识符（如 Hugging Face Hub 上的模型 ID）或本地路径，解析并定位模型文件。\n\n2. **组件加载**：\n\n   - 从指定路径加载模型的各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。\n   - 支持加载不同版本和变体的模型组件。\n\n3. **配置加载**：\n\n   - 加载模型的配置文件，设置模型的超参数和其他配置选项。\n\n4. **设备映射**：\n\n   - 根据用户指定的设备映射策略，将模型组件分配到合适的计算设备（如 CPU、GPU）。\n\n5. **安全检查**：\n\n   - 在加载过程中，检查模型的安全性和兼容性，确保加载的模型符合预期。\n\n6. **返回实例**：\n   - 完成加载后，返回一个配置好的 `DiffusionPipeline` 实例，用户可以直接使用该实例进行推理。\n\n### 设计目的\n\n`DiffusionPipeline` 的设计目的是提供一个统一的接口来管理和执行扩散模型。通过 `from_pretrained` 方法，用户可以方便地加载和配置预训练模型，快速进行推理和生成任务。这种设计使得扩散模型的使用更加简便和高效，适合各种应用场景。\n\n# Q: @train_text_to_image_lora.py 里，从 DiffusionPipeline.from_pretrained 加载到了 @pipeline_stable_diffusion.py 中 StableDiffusionPipeline 类的实例，我理解的对吗？\n\n是的，你的理解是正确的。在 `train_text_to_image_lora.py` 中，`DiffusionPipeline.from_pretrained` 方法用于加载预训练的模型管道实例。在这个过程中，它会根据指定的模型路径和配置，实例化一个 `StableDiffusionPipeline` 类的对象。\n\n### 具体过程如下：\n\n1. **调用 `from_pretrained` 方法**：\n\n   - 在 `train_text_to_image_lora.py` 中，`DiffusionPipeline.from_pretrained` 被调用来加载预训练的模型。\n   - 这个方法会根据提供的路径或模型标识符，从 Hugging Face Hub 或本地文件系统加载模型的权重和配置。\n\n2. **实例化 `StableDiffusionPipeline`**：\n\n   - `from_pretrained` 方法会识别模型的类型，并根据配置文件中的信息选择合适的管道类进行实例化。\n   - 在这个例子中，由于加载的是 Stable Diffusion 模型，因此会实例化 `StableDiffusionPipeline` 类。\n\n3. **加载组件**：\n\n   - `StableDiffusionPipeline` 的 `__init__` 方法会被调用，加载模型的各个组件（如 VAE、UNet、调度器等）。\n   - 这些组件会根据预训练的权重进行初始化，并注册到管道中。\n\n4. **返回实例**：\n   - 完成加载后，`from_pretrained` 方法返回一个配置好的 `StableDiffusionPipeline` 实例。\n   - 这个实例可以用于进一步的推理或微调任务。\n\n通过这种方式，`train_text_to_image_lora.py` 脚本能够方便地加载和使用预训练的 Stable Diffusion 模型进行微调和生成任务。\n\n# Q: 解读 @pipeline_utils.py 中 from_pretrained 代码，详细说明如何识别模型类型选择管道类。 @Codebase\n\n在 `pipeline_utils.py` 中，`from_pretrained` 方法负责从预训练模型加载管道实例。以下是该方法如何识别模型类型并选择合适的管道类的详细说明：\n\n### 识别模型类型并选择管道类的步骤\n\n1. **下载和缓存模型文件**：\n\n   - 首先，`from_pretrained` 方法会检查 `pretrained_model_name_or_path` 是否是一个本地路径。如果不是，它会调用 `cls.download` 方法从 Hugging Face Hub 下载模型文件，并将其缓存到本地。\n   - 相关代码行：\n     ```python\n     startLine: 763\n     endLine: 788\n     ```\n\n2. **加载配置文件**：\n\n   - 使用 `cls.load_config` 方法加载模型的配置文件，该文件包含模型的超参数和其他配置信息。\n   - 相关代码行：\n     ```python\n     startLine: 812\n     endLine: 818\n     ```\n\n3. **识别模型变体**：\n\n   - 通过 `_identify_model_variants` 方法识别模型的变体（如 `fp16`、`ema` 等），以便加载正确的模型文件。\n   - 相关代码行：\n     ```python\n     startLine: 820\n     endLine: 827\n     ```\n\n4. **解析自定义管道和类**：\n\n   - 使用 `_resolve_custom_pipeline_and_cls` 方法解析自定义管道和类名。如果用户指定了自定义管道，则从 Hub 加载相应的模块。\n   - 相关代码行：\n     ```python\n     startLine: 831\n     endLine: 833\n     ```\n\n5. **获取管道类**：\n\n   - 调用 `_get_pipeline_class` 方法，根据配置文件和用户指定的选项，确定要实例化的管道类。\n   - 相关代码行：\n     ```python\n     startLine: 834\n     endLine: 842\n     ```\n\n6. **加载管道组件**：\n\n   - 根据管道类的签名，加载并实例化各个组件（如 VAE、UNet、调度器等），并将它们注册到管道中。\n   - 相关代码行：\n     ```python\n     startLine: 857\n     endLine: 980\n     ```\n\n7. **实例化管道**：\n   - 使用加载的组件和配置，实例化最终的管道对象。\n   - 相关代码行：\n     ```python\n     startLine: 1021\n     endLine: 1028\n     ```\n\n通过这些步骤，`from_pretrained` 方法能够识别模型类型并选择合适的管道类，确保加载的模型能够正确地进行推理和生成任务。\n\n# Q: 如果我只有一个 sd_xl_base_1.0.safetensors 文件，是否无法使用 from_pretrained 方法得到具体的 Pipeline 实例？\n\n如果你只有一个 `sd_xl_base_1.0.safetensors` 文件，直接使用 `from_pretrained` 方法可能会遇到一些困难，因为 `from_pretrained` 通常期望从一个包含完整模型配置和权重的目录或 Hugging Face Hub 仓库中加载模型。\n\n### 解决方案\n\n1. **手动加载权重**：\n\n   - 你可以手动加载 `safetensors` 文件中的权重，并将它们分配给相应的模型组件（如 UNet、VAE 等）。\n   - 这需要你对模型的架构有深入的了解，以便正确地将权重映射到模型的各个部分。\n\n2. **创建配置文件**：\n\n   - `from_pretrained` 方法依赖于配置文件来确定如何构建模型管道。你可以尝试创建一个与模型匹配的配置文件，通常是一个 JSON 文件，描述模型的架构和超参数。\n   - 这个配置文件需要放在与 `safetensors` 文件相同的目录中。\n\n3. **使用自定义加载逻辑**：\n\n   - 如果你熟悉模型的架构，可以编写自定义的加载逻辑，将 `safetensors` 文件中的权重加载到模型中。\n   - 这可能涉及使用 `safetensors` 库来读取权重，并手动将它们分配给模型的各个层。\n\n4. **检查社区资源**：\n   - 有时，社区会提供工具或脚本来帮助加载特定格式的模型文件。你可以在相关的 GitHub 仓库或论坛中查找是否有适合的工具。\n\n### 总结\n\n虽然 `from_pretrained` 方法提供了便捷的加载方式，但它通常需要完整的模型目录或 Hub 仓库。如果只有一个 `safetensors` 文件，你可能需要手动处理权重加载和配置，以便正确地构建和使用模型管道。\n\n# Q: 如果我只需要进行推理，是否仍需配置文件？\n\n在进行推理时，配置文件仍然是非常有用的，尽管在某些情况下你可能能够在没有完整配置文件的情况下进行推理。以下是一些考虑因素：\n\n### 为什么需要配置文件\n\n1. **模型架构信息**：\n\n   - 配置文件通常包含模型的架构信息，如层数、隐藏单元数、激活函数等。这些信息对于正确构建模型至关重要。\n\n2. **超参数设置**：\n\n   - 配置文件中可能包含一些超参数设置，如学习率、优化器设置等，虽然这些在推理时不直接使用，但了解这些信息有助于理解模型的行为。\n\n3. **组件初始化**：\n   - 在复杂模型（如 Stable Diffusion）中，配置文件用于初始化各个组件（如 VAE、UNet、调度器等）。这些组件需要正确的参数来进行推理。\n\n### 没有配置文件时的推理\n\n如果你没有配置文件，但仍希望进行推理，可以考虑以下方法：\n\n1. **手动构建模型**：\n\n   - 如果你对模型的架构有深入了解，可以手动构建模型，并使用 `safetensors` 文件中的权重进行初始化。\n\n2. **使用默认设置**：\n\n   - 在某些情况下，你可以使用一些默认的设置来初始化模型组件，但这可能会导致性能不佳或结果不准确。\n\n3. **社区支持**：\n   - 查找社区提供的工具或脚本，这些工具可能已经解决了如何在没有完整配置文件的情况下进行推理的问题。\n\n### 总结\n\n虽然在某些情况下可以在没有配置文件的情况下进行推理，但拥有配置文件通常会使过程更简单、更可靠。如果可能，尝试获取或创建一个与模型匹配的配置文件，以确保推理的准确性和效率。\n\n# Q: 以你上面举的例子为例，@pipeline_loading_utils.py load_sub_model 中，实例化的是 @unet_2d_condition.py 中的 UNet2DConditionModel 类吗？ load_sub_model 是怎么找到这个类并实例化的？\n\nDeepseek R-1:\n\n\u003cthink\u003e\n\n好的，我需要仔细分析用户的问题。用户问的是在`pipeline_loading_utils.py`中的`load_sub_model`函数是否实例化了`unet_2d_condition.py`中的`UNet2DConditionModel`类，以及这个过程是如何找到并实例化该类的。\n\n首先，我需要回忆`load_sub_model`函数的作用。根据之前的讨论，这个函数负责动态加载模型的各个子组件，比如 UNet、VAE 等。用户提供的代码片段显示，`load_sub_model`通过`class_obj`来实例化具体的类，而`class_obj`是通过`get_class_obj_and_candidates`函数获取的。\n\n接下来，我需要查看`get_class_obj_and_candidates`函数的逻辑。这个函数会根据`library_name`和`class_name`来查找对应的类。例如，当`library_name`是\"diffusers\"，`class_name`是\"UNet2DConditionModel\"时，应该会导入`diffusers.models.unets.unet_2d_condition`模块中的`UNet2DConditionModel`类。\n\n然后，我需要确认`unet_2d_condition.py`中的`UNet2DConditionModel`类是否被正确注册到`ALL_IMPORTABLE_CLASSES`中。在 Diffusers 库中，通常会有全局的类注册机制，确保各个组件可以被动态发现和加载。\n\n此外，`load_sub_model`函数中的`load_method`是通过`_get_load_method`获取的，这可能涉及到从预训练权重加载模型的方法，比如`from_pretrained`。需要检查`UNet2DConditionModel`类是否实现了相应的类方法，以支持从配置文件或预训练文件加载。\n\n最后，需要验证实例化的过程是否正确，包括参数传递和配置的应用。例如，`UNet2DConditionModel`的`__init__`方法需要接收正确的参数来构建模型结构，而这些参数可能来自配置文件或默认值。\n\n总结来说，`load_sub_model`通过类名和库名找到对应的类，利用其加载方法（如`from_pretrained`）实例化对象，而`UNet2DConditionModel`作为可导入的类被正确注册和引用，从而完成实例化。\n\u003c/think\u003e\n\n是的，`pipeline_loading_utils.py` 中的 `load_sub_model` 函数最终会实例化 `unet_2d_condition.py` 中的 `UNet2DConditionModel` 类。以下是完整的加载逻辑解析：\n\n---\n\n### **核心加载流程**\n\n```python\n# pipeline_loading_utils.py 中的关键代码段\ndef load_sub_model(...):\n    # 1. 获取类对象和候选类\n    class_obj, class_candidates = get_class_obj_and_candidates(\n        library_name,\n        class_name,\n        importable_classes,\n        pipelines,\n        is_pipeline_module,\n        component_name=name,\n        cache_dir=cached_folder,\n    )\n\n    # 2. 确定加载方法（如 from_pretrained）\n    load_method_name = None\n    for candidate_name, candidate_class in class_candidates.items():\n        if issubclass(class_obj, candidate_class):\n            load_method_name = importable_classes[candidate_name][1]  # 通常是 \"from_pretrained\"\n\n    # 3. 获取具体的加载方法\n    load_method = _get_load_method(class_obj, load_method_name, is_dduf=dduf_entries is not None)\n\n    # 4. 执行加载\n    loaded_sub_model = load_method(cached_folder, **loading_kwargs)\n```\n\n---\n\n### **具体步骤解析**\n\n#### **1. 类对象获取 (get_class_obj_and_candidates)**\n\n- **作用**：根据 `library_name` 和 `class_name` 动态导入对应的 Python 类。\n- **实现**：\n  ```python\n  # 通过 library_name 定位模块路径\n  # 例如 library_name=\"diffusers\", class_name=\"UNet2DConditionModel\"\n  # 会导入 diffusers.models.unets.unet_2d_condition 模块\n  module = importlib.import_module(library_name)\n  class_obj = getattr(module, class_name)  # 获取 UNet2DConditionModel 类\n  ```\n\n#### **2. 加载方法匹配**\n\n- **候选类**：`class_candidates` 来自 `ALL_IMPORTABLE_CLASSES`，包含所有可加载的基类（如 `ModelMixin`）。\n- **方法选择**：通过 `issubclass` 检查 `class_obj` 是否继承自候选类，从而确定使用哪个基类的加载方法（如 `ModelMixin.from_pretrained`）。\n\n#### **3. 加载方法绑定**\n\n- **动态绑定**：`_get_load_method` 会将 `class_obj.from_pretrained` 方法绑定为实际加载函数。\n- **特殊处理**：如果是 DDUF 格式（HuggingFace 的分布式格式），会使用特定的加载逻辑。\n\n#### **4. 实例化 UNet**\n\n- **参数传递**：`loading_kwargs` 包含模型路径、设备映射、精度设置等。\n- **最终调用**：\n  ```python\n  # 等效于执行：\n  UNet2DConditionModel.from_pretrained(\n      pretrained_model_name_or_path=cached_folder,\n      subfolder=name,  # 如 \"unet\"\n      torch_dtype=torch_dtype,\n      device_map=device_map,\n      ...\n  )\n  ```\n\n---\n\n### **UNet2DConditionModel 的注册机制**\n\n在 `diffusers` 的全局注册表 `ALL_IMPORTABLE_CLASSES` 中，`UNet2DConditionModel` 被注册为可导入类：\n\n```python\n# 在某个初始化模块中（如 src/diffusers/__init__.py）\nALL_IMPORTABLE_CLASSES = {\n    \"UNet2DConditionModel\": (\"diffusers.models.unets.unet_2d_condition\", \"UNet2DConditionModel\"),\n    ...\n}\n```\n\n这使得 `get_class_obj_and_candidates` 能通过名称匹配找到该类。\n\n---\n\n### **架构参数如何生效**\n\n当调用 `from_pretrained` 时：\n\n1. **配置加载**：从 `config.json` 中读取 `down_block_types`、`up_block_types` 等参数。\n2. **动态构建**：`UNet2DConditionModel.__init__` 根据这些参数，通过 `get_down_block` 和 `get_up_block` 动态构建网络层。\n\n例如：\n\n```python\n# 根据 config.json 中的 down_block_types 创建下采样块\ndown_block_type = \"CrossAttnDownBlock2D\"\ndown_block = get_down_block(\n    down_block_type,\n    num_layers=layers_per_block[i],\n    in_channels=input_channel,\n    out_channels=output_channel,\n    ...\n)\n```\n\n---\n\n### **总结流程图**\n\n```mermaid\ngraph TD\n    A[load_sub_model] --\u003e B[get_class_obj_and_candidates]\n    B --\u003e C{找到 UNet2DConditionModel 类}\n    C --\u003e D[确定加载方法 from_pretrained]\n    D --\u003e E[调用 UNet2DConditionModel.from_pretrained]\n    E --\u003e F[加载 config.json]\n    F --\u003e G[根据配置动态构建网络层]\n```\n\n通过这种动态加载机制，Diffusers 库实现了高度模块化的模型管理，能够灵活支持不同结构的 UNet 变体。\n\n\u003e [!info-太史公曰]\n\u003e 应当不是。正确来说，是上层（ `DiffusionPipeline.from_pretained` ）从 importable_classes 参数中传入 `ALL_IMPORTABLE_CLASSES` ， `get_class_obj_and_candidates` 中从 `diffuser` 中加载到 `ModelMixin` ，调用 `ModelMixin.from_pretrained` 才实例化 `UNet2DConditionModel` 类。\n\u003e\n\u003e 因此估计往 `load_sub_model` 中传入的是 `diffuser` 与 `ModelMixin`\n\n# Q: 解析代码，详解@modeling_utils.py 的 from_pretrained 如何实例化 @unet_2d_condition.py 中的 `UNet2DConditionModel` ？\n\n\u003cthink\u003e\n我需要详细解析 `modeling_utils.py` 中的 `from_pretrained` 方法如何实例化 `UNet2DConditionModel`。根据提供的代码，我可以看到整个加载流程。\n\n首先，`from_pretrained` 是 `ModelMixin` 类的一个类方法，而 `UNet2DConditionModel` 继承自 `ModelMixin`，所以它继承了这个方法。\n\n加载流程大致如下：\n\n1. 首先获取配置文件和模型文件路径\n2. 加载配置文件\n3. 使用配置创建模型实例\n4. 加载权重到模型中\n5. 处理设备映射等高级功能\n6. 返回加载好的模型\n\n具体来看，`from_pretrained` 方法首先会确定模型文件的位置，然后加载配置文件。接着，它会使用 `cls.from_config(config, **unused_kwargs)` 创建一个模型实例。这里的 `cls` 就是 `UNet2DConditionModel`，所以实际上是调用 `UNet2DConditionModel.from_config` 来创建模型实例。\n\n然后，它会加载权重文件，并将权重加载到模型中。这个过程通过 `_load_pretrained_model` 方法完成。最后，它会处理设备映射等高级功能，并返回加载好的模型。\n\n我需要详细解释这个过程，特别是如何从配置创建模型实例，以及如何加载权重到模型中。\n\u003c/think\u003e\n\n# `from_pretrained` 如何实例化 UNet2DConditionModel 的详细流程\n\n`modeling_utils.py` 中的 `from_pretrained` 方法负责实例化 `UNet2DConditionModel`，整个过程可分为以下关键步骤：\n\n## 1. 加载配置文件\n\n```python\n# 确定模型路径并加载配置\nconfig_dict = cls.load_config(\n    pretrained_model_name_or_path,\n    cache_dir=cache_dir,\n    force_download=force_download,\n    # 其他参数...\n)\n```\n\n这一步从模型目录或 Hub 加载 `config.json`，包含了 UNet 的所有配置参数（如通道数、注意力头数等）。\n\n## 2. 创建空模型实例\n\n```python\n# 使用上下文管理器创建空模型\nwith ContextManagers(init_contexts):\n    model = cls.from_config(config, **unused_kwargs)\n```\n\n这里的关键是 `cls.from_config`，它调用 `UNet2DConditionModel.from_config` 方法，该方法由 `ConfigMixin` 提供。\n\n`from_config` 会：\n\n- 解析配置参数\n- 调用 `UNet2DConditionModel.__init__` 构造函数\n- 创建所有子模块（如下采样块、上采样块、注意力层等）\n\n## 3. 加载权重文件\n\n```python\n# 加载权重文件\nstate_dict = load_state_dict(resolved_model_file[0], disable_mmap=disable_mmap, dduf_entries=dduf_entries)\n```\n\n这一步加载预训练权重文件（如 `diffusion_pytorch_model.bin` 或 `.safetensors`）。\n\n## 4. 将权重加载到模型中\n\n```python\nmodel, missing_keys, unexpected_keys, mismatched_keys, offload_index, error_msgs = cls._load_pretrained_model(\n    model,\n    state_dict,\n    # 其他参数...\n)\n```\n\n`_load_pretrained_model` 方法负责：\n\n- 将权重映射到模型参数\n- 处理可能的形状不匹配\n- 支持低内存加载\n- 处理量化和设备映射\n\n## 5. 设备分配和后处理\n\n```python\n# 如果指定了设备映射，将模型分配到不同设备\nif device_map is not None:\n    dispatch_model(model, **device_map_kwargs)\n```\n\n这一步处理模型在多 GPU 或 CPU/GPU 混合环境下的分配。\n\n## 6. 返回实例化的模型\n\n```python\nmodel.eval()  # 设置为评估模式\nreturn model\n```\n\n最终返回完全加载好的 `UNet2DConditionModel` 实例。\n\n## 关键实现细节\n\n1. **动态类型处理**：\n\n   ```python\n   if torch_dtype is not None:\n       dtype_orig = cls._set_default_torch_dtype(torch_dtype)\n   ```\n\n   支持不同精度（如 fp16、bf16）的模型加载\n\n2. **低内存加载**：\n\n   ```python\n   if low_cpu_mem_usage:\n       init_contexts.append(accelerate.init_empty_weights())\n   ```\n\n   通过 accelerate 库实现大模型的高效加载\n\n3. **权重修复**：\n\n   ```python\n   model._fix_state_dict_keys_on_load(state_dict)\n   ```\n\n   处理不同版本模型间的键名差异\n\n4. **设备映射**：\n   ```python\n   device_map = _determine_device_map(model, device_map, max_memory, ...)\n   ```\n   智能分配模型层到不同设备\n\n整个过程实现了从预训练权重到可用模型实例的无缝转换，同时处理了各种高级功能如设备管理、精度控制和内存优化。\n\n# Q: 详细解释 @unet_2d_condition.py 中 UNet2DConditionModel 的结构\n\n\u003cthink\u003e\n\n嗯，用户想让我详细解释 `unet_2d_condition.py` 中的 `UNet2DConditionModel` 结构。首先，我需要回忆一下 UNet 的基本结构，特别是 Stable Diffusion 中的 UNet。Stable Diffusion 的 UNet 是一个条件模型，结合了文本嵌入作为输入，所以这个 UNet2DConditionModel 应该是在传统 UNet 的基础上增加了对条件输入的处理，比如文本嵌入或时间步信息。\n\n接下来，我需要考虑用户可能的背景。用户可能在使用或修改 Diffusers 库，或者在尝试理解 Stable Diffusion 的工作原理。他们可能遇到了问题，比如模型加载错误，或者想自定义 UNet 的结构，因此需要了解其内部组件。用户可能已经看过代码，但需要更清晰的解释，特别是各个模块的作用和连接方式。\n\n我需要检查用户提供的代码片段，特别是`UNet2DConditionModel`的`__init__`方法，看看有哪些组件被初始化。比如，`conv_in`、`time_embedding`、`down_blocks`、`mid_block`、`up_blocks`、`conv_out`等。这些部分对应了 UNet 的不同阶段，下采样、中间层、上采样等。\n\n然后，我需要考虑如何将这些组件组织成一个连贯的结构解释。可能需要分块讲解，比如输入处理、时间嵌入、下采样块、中间块、上采样块、输出处理等。同时，条件输入（如文本嵌入）是如何被整合到模型中的，比如通过交叉注意力机制。\n\n另外，用户可能对某些参数或配置选项感兴趣，比如`attention_head_dim`、`cross_attention_dim`等，这些参数如何影响模型结构。需要解释这些参数的作用，以及它们在模型中的具体应用位置。\n\n还要注意代码中的一些特定处理，比如`class_embeddings_concat`如何处理类别嵌入，`resnet_time_scale_shift`的不同模式对残差块的影响，以及`attention_type`的选择（如默认的交叉注意力或其他类型）。\n\n最后，可能需要提供一个结构图或流程图，帮助用户更直观地理解数据在模型中的流动路径，特别是条件信息如何在不同层中被整合。如果用户需要进一步的代码示例或调试帮助，也需要在解释中提及可能的常见问题或配置错误。\n\u003c/think\u003e\n\n以下是 `UNet2DConditionModel` 的详细结构解析，该模型是 Stable Diffusion 的核心组件，负责噪声预测和条件控制：\n\n---\n\n### **整体架构**\n\n```mermaid\ngraph TD\n    A[输入] --\u003e B[Conv2D_3x3]\n    B --\u003e C[时间嵌入]\n    C --\u003e D[下采样块 x4]\n    D --\u003e E[中间块]\n    E --\u003e F[上采样块 x4]\n    F --\u003e G[Conv2D_3x3]\n    G --\u003e H[输出]\n    D --\u003e|跳跃连接| F\n    C --\u003e|条件注入| D\n    C --\u003e|条件注入| E\n    C --\u003e|条件注入| F\n```\n\n---\n\n### **核心组件**\n\n#### 1. 输入处理\n\n```python\nself.conv_in = nn.Conv2d(\n    in_channels,\n    block_out_channels[0],\n    kernel_size=3,\n    padding=1\n)\n```\n\n- 作用：将输入图像（latent space）映射到初始特征空间\n- 参数：\n  - `in_channels`：输入通道数（通常为 4）\n  - `block_out_channels[0]`：首层输出通道数（通常为 320）\n\n---\n\n#### 2. 时间嵌入系统\n\n```python\nself.time_embedding = TimestepEmbedding(\n    timestep_input_dim,  # 时间步编码维度\n    time_embed_dim,       # 嵌入维度（通常1280）\n    act_fn=act_fn         # 激活函数（如silu）\n)\n```\n\n- 功能：将时间步信息编码为条件向量\n- 流程：\n  1. 通过正弦位置编码生成时间特征\n  2. 经过全连接层和非线性激活\n  3. 与文本嵌入等条件信息融合\n\n---\n\n#### 3. 下采样模块\n\n```python\nself.down_blocks = nn.ModuleList([\n    DownBlock2D(\n        in_channels=320,\n        out_channels=320,\n        temb_channels=1280,\n        num_layers=2,\n        resnet_eps=1e-5,\n        resnet_act_fn=\"silu\",\n        cross_attention_dim=768  # 文本嵌入维度\n    ),\n    # 其他下采样块...\n])\n```\n\n- 结构特点：\n  - 每个下采样块包含：\n    - 多个残差块（ResNet）\n    - 交叉注意力层（处理文本条件）\n    - 可能的降采样卷积\n  - 典型配置：4 个下采样块，通道数逐级增加（320→640→1280→1280）\n\n---\n\n#### 4. 中间模块\n\n```python\nself.mid_block = UNetMidBlock2DCrossAttn(\n    in_channels=1280,\n    temb_channels=1280,\n    resnet_eps=1e-5,\n    resnet_act_fn=\"silu\",\n    attn_num_head_channels=8\n)\n```\n\n- 核心组成：\n  - 残差块\n  - 自注意力机制\n  - 交叉注意力机制\n- 作用：在最低分辨率层进行全局特征整合\n\n---\n\n#### 5. 上采样模块\n\n```python\nself.up_blocks = nn.ModuleList([\n    UpBlock2D(\n        in_channels=1280,\n        prev_output_channel=1280,\n        out_channels=1280,\n        temb_channels=1280,\n        num_layers=3,\n        resnet_eps=1e-5,\n        resnet_act_fn=\"silu\"\n    ),\n    # 其他上采样块...\n])\n```\n\n- 关键特性：\n  - 包含残差块和交叉注意力层\n  - 通过跳跃连接融合下采样特征\n  - 使用转置卷积或插值进行上采样\n\n---\n\n#### 6. 输出处理\n\n```python\nself.conv_norm_out = nn.GroupNorm(32, 320)\nself.conv_act = nn.SiLU()\nself.conv_out = nn.Conv2d(320, 4, 3, padding=1)\n```\n\n- 流程：\n  1. 归一化处理\n  2. 激活函数\n  3. 最终卷积将特征映射到输出空间（4 通道）\n\n---\n\n### **条件控制机制**\n\n#### 交叉注意力层\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n        # 计算注意力权重...\n        return output\n```\n\n- 作用：将文本嵌入（context）注入到图像特征中\n- 位置：每个下采样和上采样块中都包含该层\n\n---\n\n### **关键参数说明**\n\n| 参数                      | 典型值    | 作用                                      |\n| ------------------------- | --------- | ----------------------------------------- |\n| `cross_attention_dim`     | 768       | 文本嵌入的维度（CLIP 文本编码器输出维度） |\n| `attention_head_dim`      | 8/16      | 注意力头的维度                            |\n| `layers_per_block`        | 2         | 每个块中的残差层数                        |\n| `num_attention_heads`     | 8         | 注意力头数量                              |\n| `resnet_time_scale_shift` | \"default\" | 时间条件注入方式（add/scale）             |\n\n---\n\n### **数据流动示例**\n\n```python\ndef forward(self, x, timestep, encoder_hidden_states):\n    # 1. 输入处理\n    x = self.conv_in(x)\n\n    # 2. 时间嵌入\n    t_emb = self.time_embedding(timestep)\n\n    # 3. 下采样\n    down_samples = []\n    for down_block in self.down_blocks:\n        x = down_block(x, t_emb, encoder_hidden_states)\n        down_samples.append(x)\n\n    # 4. 中间处理\n    x = self.mid_block(x, t_emb, encoder_hidden_states)\n\n    # 5. 上采样\n    for up_block in self.up_blocks:\n        x = up_block(x, down_samples.pop(), t_emb, encoder_hidden_states)\n\n    # 6. 输出\n    x = self.conv_norm_out(x)\n    x = self.conv_act(x)\n    return self.conv_out(x)\n```\n\n如果需要更详细的某个组件解析（如下采样块的具体实现），可以进一步展开说明。\n\n# Q: 详细解释下采样快的细节\n\n好的，下面是 `UNet2DConditionModel` 中下采样块的详细结构和实现细节：\n\n---\n\n### **下采样块概述**\n\n下采样块的主要功能是逐步降低特征图的空间分辨率，同时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。每个下采样块通常包含多个残差块和一个降采样操作。\n\n---\n\n### **下采样块的结构**\n\n#### 1. 残差块（ResNet Block）\n\n每个下采样块包含多个残差块，负责特征提取和非线性变换。\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # 时间嵌入注入\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # 残差连接\n```\n\n- **特征归一化**：使用 `GroupNorm` 进行归一化，稳定训练过程。\n- **激活函数**：通常使用 `SiLU` 或 `ReLU`。\n- **卷积层**：两个 3x3 卷积层，保持特征图大小不变。\n- **时间嵌入**：通过全连接层将时间嵌入注入到特征图中。\n\n---\n\n#### 2. 交叉注意力层\n\n在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **查询、键、值**：通过线性变换生成查询、键和值向量。\n- **注意力计算**：使用缩放点积注意力机制。\n- **条件注入**：将文本嵌入等条件信息注入到特征图中。\n\n---\n\n#### 3. 降采样操作\n\n通常使用卷积或池化操作来降低特征图的空间分辨率。\n\n```python\nclass Downsample(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size=3, stride=2, padding=1)\n\n    def forward(self, x):\n        return self.conv(x)\n```\n\n- **卷积降采样**：通过步长为 2 的卷积实现降采样，减少特征图的宽高。\n- **通道数增加**：通常在降采样时增加通道数，以便在更低的分辨率上进行更复杂的特征提取。\n\n---\n\n### **下采样块的完整实现**\n\n```python\nclass DownBlock2D(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, num_layers, resnet_eps, resnet_act_fn, cross_attention_dim):\n        super().__init__()\n        self.resnets = nn.ModuleList([\n            ResNetBlock(in_channels if i == 0 else out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\n            for i in range(num_layers)\n        ])\n        self.attention = CrossAttention(out_channels, cross_attention_dim)\n        self.downsample = Downsample(out_channels, out_channels)\n\n    def forward(self, x, temb, context):\n        for resnet in self.resnets:\n            x = resnet(x, temb)\n        x = self.attention(x, context)\n        x = self.downsample(x)\n        return x\n```\n\n- **残差块**：多个残差块串联，进行特征提取。\n- **交叉注意力**：在特征提取后注入条件信息。\n- **降采样**：降低特征图的空间分辨率。\n\n---\n\n### **总结**\n\n下采样块在 `UNet2DConditionModel` 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将输入图像的特征压缩到更低的分辨率，为后续的中间块和上采样块提供丰富的特征信息。\n\n# Q: 详细讲解上采样块的细节\n\n好的，下面是 `UNet2DConditionModel` 中上采样块的详细结构和实现细节：\n\n---\n\n### **上采样块概述**\n\n上采样块的主要功能是逐步恢复特征图的空间分辨率，同时结合下采样块的特征，通过跳跃连接（skip connections）实现特征的融合。每个上采样块通常包含多个残差块和一个上采样操作。\n\n---\n\n### **上采样块的结构**\n\n#### 1. 残差块（ResNet Block）\n\n每个上采样块包含多个残差块，负责特征提取和非线性变换。\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # 时间嵌入注入\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # 残差连接\n```\n\n- **特征归一化**：使用 `GroupNorm` 进行归一化，稳定训练过程。\n- **激活函数**：通常使用 `SiLU` 或 `ReLU`。\n- **卷积层**：两个 3x3 卷积层，保持特征图大小不变。\n- **时间嵌入**：通过全连接层将时间嵌入注入到特征图中。\n\n---\n\n#### 2. 交叉注意力层\n\n在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **查询、键、值**：通过线性变换生成查询、键和值向量。\n- **注意力计算**：使用缩放点积注意力机制。\n- **条件注入**：将文本嵌入等条件信息注入到特征图中。\n\n---\n\n#### 3. 上采样操作\n\n通常使用转置卷积或插值操作来增加特征图的空间分辨率。\n\n```python\nclass Upsample(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv = nn.ConvTranspose2d(in_channels, out_channels, kernel_size=3, stride=2, padding=1, output_padding=1)\n\n    def forward(self, x):\n        return self.conv(x)\n```\n\n- **转置卷积上采样**：通过转置卷积实现上采样，增加特征图的宽高。\n- **通道数减少**：通常在上采样时减少通道数，以便恢复到输入图像的通道数。\n\n---\n\n### **上采样块的完整实现**\n\n```python\nclass UpBlock2D(nn.Module):\n    def __init__(self, in_channels, prev_output_channel, out_channels, temb_channels, num_layers, resnet_eps, resnet_act_fn, cross_attention_dim):\n        super().__init__()\n        self.resnets = nn.ModuleList([\n            ResNetBlock(in_channels if i == 0 else out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\n            for i in range(num_layers)\n        ])\n        self.attention = CrossAttention(out_channels, cross_attention_dim)\n        self.upsample = Upsample(out_channels, out_channels)\n\n    def forward(self, x, res_samples, temb, context):\n        for resnet in self.resnets:\n            x = resnet(x, temb)\n        x = self.attention(x, context)\n        x = self.upsample(x)\n        return x\n```\n\n- **残差块**：多个残差块串联，进行特征提取。\n- **交叉注意力**：在特征提取后注入条件信息。\n- **上采样**：增加特征图的空间分辨率。\n\n---\n\n### **总结**\n\n上采样块在 `UNet2DConditionModel` 中起到了关键作用，通过多层次的特征提取和条件注入，逐步将特征图的分辨率恢复到输入图像的大小，并结合下采样块的特征实现特征的融合。\n\n# Q: 详细讲解中间模块细节\n\n好的，下面是 `UNet2DConditionModel` 中中间模块（Mid Block）的详细结构和实现细节：\n\n---\n\n### **中间模块概述**\n\n中间模块位于下采样和上采样块之间，负责在最低分辨率的特征图上进行全局特征整合。它通常包含残差块和注意力机制，以便在特征图的最小空间维度上进行复杂的特征交互。\n\n---\n\n### **中间模块的结构**\n\n#### 1. 残差块（ResNet Block）\n\n中间模块通常包含一个或多个残差块，用于特征提取和非线性变换。\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # 时间嵌入注入\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # 残差连接\n```\n\n- **特征归一化**：使用 `GroupNorm` 进行归一化，稳定训练过程。\n- **激活函数**：通常使用 `SiLU` 或 `ReLU`。\n- **卷积层**：两个 3x3 卷积层，保持特征图大小不变。\n- **时间嵌入**：通过全连接层将时间嵌入注入到特征图中。\n\n---\n\n#### 2. 自注意力层\n\n自注意力层用于在特征图的最小空间维度上进行全局特征交互。\n\n```python\nclass SelfAttention(nn.Module):\n    def __init__(self, dim, heads=8):\n        super().__init__()\n        self.to_qkv = nn.Linear(dim, dim * 3, bias=False)\n        self.to_out = nn.Linear(dim, dim)\n        self.scale = dim ** -0.5\n\n    def forward(self, x):\n        b, n, _, h = *x.shape, self.heads\n        qkv = self.to_qkv(x).chunk(3, dim=-1)\n        q, k, v = map(lambda t: t.reshape(b, n, h, -1).transpose(1, 2), qkv)\n\n        dots = torch.einsum('bhid,bhjd-\u003ebhij', q, k) * self.scale\n        attn = dots.softmax(dim=-1)\n\n        out = torch.einsum('bhij,bhjd-\u003ebhid', attn, v)\n        out = out.transpose(1, 2).reshape(b, n, -1)\n        return self.to_out(out)\n```\n\n- **查询、键、值**：通过线性变换生成查询、键和值向量。\n- **注意力计算**：使用缩放点积注意力机制。\n- **全局特征交互**：在特征图的最小空间维度上进行全局特征交互。\n\n---\n\n#### 3. 交叉注意力层\n\n在处理条件输入（如文本嵌入）时，交叉注意力层用于将条件信息注入到特征图中。\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **查询、键、值**：通过线性变换生成查询、键和值向量。\n- **注意力计算**：使用缩放点积注意力机制。\n- **条件注入**：将文本嵌入等条件信息注入到特征图中。\n\n---\n\n### **中间模块的完整实现**\n\n```python\nclass UNetMidBlock2DCrossAttn(nn.Module):\n    def __init__(self, in_channels, temb_channels, resnet_eps, resnet_act_fn, attn_num_head_channels):\n        super().__init__()\n        self.resnet1 = ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\n        self.attn1 = SelfAttention(in_channels, heads=attn_num_head_channels)\n        self.cross_attn = CrossAttention(in_channels, in_channels)\n        self.resnet2 = ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\n\n    def forward(self, x, temb, encoder_hidden_states, attention_mask=None, cross_attention_kwargs=None):\n        x = self.resnet1(x, temb)\n        x = self.attn1(x)\n        x = self.cross_attn(x, encoder_hidden_states)\n        x = self.resnet2(x, temb)\n        return x\n```\n\n- **残差块**：两个残差块串联，进行特征提取。\n- **自注意力**：在特征图的最小空间维度上进行全局特征交互。\n- **交叉注意力**：在特征提取后注入条件信息。\n\n---\n\n### **总结**\n\n中间模块在 `UNet2DConditionModel` 中起到了关键作用，通过多层次的特征提取和注意力机制，在最低分辨率的特征图上进行全局特征整合，为上采样块提供丰富的特征信息。\n\n# Q: 详细讲解输入处理与输出处理模块细节\n\n好的，下面是 `UNet2DConditionModel` 中输入处理和输出处理模块的详细结构和实现细节：\n\n---\n\n### **输入处理模块**\n\n输入处理模块的主要功能是将输入的图像特征（通常是潜在空间表示）映射到模型的初始特征空间。\n\n#### 1. 输入卷积层\n\n```python\nclass InputProcessing(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv_in = nn.Conv2d(\n            in_channels,\n            out_channels,\n            kernel_size=3,\n            padding=1\n        )\n\n    def forward(self, x):\n        return self.conv_in(x)\n```\n\n- **卷积层**：使用一个 3x3 的卷积层，将输入的通道数映射到模型的初始通道数。\n- **作用**：将输入图像的特征映射到更高维度的特征空间，以便后续的特征提取。\n\n---\n\n### **输出处理模块**\n\n输出处理模块的主要功能是将模型的最终特征图映射回输入的通道数，通常是生成图像的潜在空间表示。\n\n#### 1. 输出卷积层\n\n```python\nclass OutputProcessing(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv_norm_out = nn.GroupNorm(32, in_channels)\n        self.conv_act = nn.SiLU()\n        self.conv_out = nn.Conv2d(\n            in_channels,\n            out_channels,\n            kernel_size=3,\n            padding=1\n        )\n\n    def forward(self, x):\n        x = self.conv_norm_out(x)\n        x = self.conv_act(x)\n        return self.conv_out(x)\n```\n\n- **归一化层**：使用 `GroupNorm` 对特征图进行归一化，稳定输出。\n- **激活函数**：使用 `SiLU` 激活函数，增加非线性。\n- **卷积层**：使用一个 3x3 的卷积层，将特征图映射回输入的通道数。\n\n---\n\n### **输入与输出处理的完整实现**\n\n```python\nclass UNet2DConditionModel(nn.Module):\n    def __init__(self, in_channels, out_channels, block_out_channels):\n        super().__init__()\n        # 输入处理\n        self.input_processing = InputProcessing(in_channels, block_out_channels[0])\n\n        # 其他模块（下采样、中间、上采样）\n\n        # 输出处理\n        self.output_processing = OutputProcessing(block_out_channels[-1], out_channels)\n\n    def forward(self, x):\n        # 输入处理\n        x = self.input_processing(x)\n\n        # 其他模块处理\n\n        # 输出处理\n        x = self.output_processing(x)\n        return x\n```\n\n- **输入处理**：将输入图像的特征映射到模型的初始特征空间。\n- **输出处理**：将模型的最终特征图映射回输入的通道数。\n\n---\n\n### **总结**\n\n输入处理和输出处理模块在 `UNet2DConditionModel` 中起到了关键作用，分别负责将输入图像的特征映射到模型的初始特征空间，以及将模型的最终特征图映射回输入的通道数。这两个模块通过简单的卷积操作实现了特征的维度变换，为模型的特征提取和生成提供了基础。\n\n# Q: 详细讲解时间嵌入系统的细节\n\n时间嵌入系统在 `UNet2DConditionModel` 中起到了关键作用，它将时间步信息编码为条件向量，以便在模型的各个阶段中注入时间信息。下面是时间嵌入系统的详细结构和实现细节：\n\n---\n\n### **时间嵌入系统概述**\n\n时间嵌入系统的主要功能是将时间步（timestep）信息转换为高维向量，这些向量在模型的残差块中被用作条件信息，以指导模型在不同时间步的特征提取和生成过程。\n\n---\n\n### **时间嵌入系统的结构**\n\n#### 1. 正弦位置编码\n\n时间嵌入系统通常使用正弦位置编码来生成初始时间特征。\n\n```python\ndef get_timestep_embedding(timesteps, embedding_dim):\n    half_dim = embedding_dim // 2\n    emb = math.log(10000) / (half_dim - 1)\n    emb = torch.exp(torch.arange(half_dim, dtype=torch.float32) * -emb)\n    emb = timesteps[:, None] * emb[None, :]\n    emb = torch.cat([torch.sin(emb), torch.cos(emb)], dim=-1)\n    return emb\n```\n\n- **正弦和余弦函数**：使用正弦和余弦函数生成时间步的周期性表示。\n- **维度扩展**：将时间步扩展为高维向量，维度为 `embedding_dim`。\n\n---\n\n#### 2. 时间嵌入层\n\n时间嵌入层将正弦位置编码的输出进一步转换为模型所需的高维条件向量。\n\n```python\nclass TimestepEmbedding(nn.Module):\n    def __init__(self, timestep_input_dim, time_embed_dim, act_fn):\n        super().__init__()\n        self.linear1 = nn.Linear(timestep_input_dim, time_embed_dim)\n        self.act = getattr(nn, act_fn)()\n        self.linear2 = nn.Linear(time_embed_dim, time_embed_dim)\n\n    def forward(self, timesteps):\n        emb = get_timestep_embedding(timesteps, self.linear1.in_features)\n        emb = self.linear1(emb)\n        emb = self.act(emb)\n        emb = self.linear2(emb)\n        return emb\n```\n\n- **线性变换**：使用两个线性层将时间步嵌入转换为高维条件向量。\n- **激活函数**：通常使用 `SiLU` 或 `ReLU` 激活函数，增加非线性。\n\n---\n\n### **时间嵌入系统的完整实现**\n\n```python\nclass UNet2DConditionModel(nn.Module):\n    def __init__(self, timestep_input_dim, time_embed_dim, act_fn):\n        super().__init__()\n        self.time_embedding = TimestepEmbedding(timestep_input_dim, time_embed_dim, act_fn)\n\n    def forward(self, x, timesteps):\n        # 时间嵌入\n        t_emb = self.time_embedding(timesteps)\n\n        # 其他模块处理\n        return x\n```\n\n- **时间嵌入**：将时间步信息转换为高维条件向量。\n- **注入到模型**：时间嵌入被注入到模型的各个阶段，指导特征提取和生成。\n\n---\n\n### **总结**\n\n时间嵌入系统在 `UNet2DConditionModel` 中起到了关键作用，通过将时间步信息编码为高维条件向量，指导模型在不同时间步的特征提取和生成过程。这一系统通过正弦位置编码和线性变换实现了时间信息的高效编码，为模型的时间条件注入提供了基础。\n","title":"Stable Diffusion UNet 内部结构","abstract":"\u003e [!summary]\n\u003e 以下内容为 Cursor 中拥有 codebase 上下文的情况下与 claude-3.7-sonnet 的对话记录\n在 `train_text_to_image_lora.py` 脚本中，LoRA（Low-Rank Adaptation）通过在模型的特定层中插入低秩矩阵来实现微调。这种方法通过添加两个低秩矩阵来调整模型的权重，而不改变原始权重，从而实现参数高效的微调。","length":1560,"created_at":"2025-03-28T02:00:00.000Z","updated_at":"2025-03-28T02:00:00.000Z","tags":["深度学习","Stable Diffusion","LoRA","参数高效微调","模型训练","学习笔记"],"license":true,"headingTrees":[{"key":"q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤","href":"#q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤","heading":1,"title":"Q: @train_text_to_image_lora.py 这段代码中如何体现 LoRA “使用两个低秩矩阵进行微调” 的步骤？","children":[{"key":"1-lora-配置","href":"#1-lora-配置","heading":3,"title":"1. LoRA 配置","children":[],"id":"1-lora-配置"},{"key":"2-添加-lora-层","href":"#2-添加-lora-层","heading":3,"title":"2. 添加 LoRA 层","children":[],"id":"2-添加-lora-层"},{"key":"3-训练过程中的权重更新","href":"#3-训练过程中的权重更新","heading":3,"title":"3. 训练过程中的权重更新","children":[],"id":"3-训练过程中的权重更新"},{"key":"4-参数更新","href":"#4-参数更新","heading":3,"title":"4. 参数更新","children":[],"id":"4-参数更新"},{"key":"总结","href":"#总结","heading":3,"title":"总结","children":[],"id":"总结"}],"id":"q-train_text_to_image_lorapy-这段代码中如何体现-lora-使用两个低秩矩阵进行微调-的步骤"},{"key":"q-unet-是个什么样的结构","href":"#q-unet-是个什么样的结构","heading":1,"title":"Q: unet 是个什么样的结构？","children":[{"key":"unet-的基本结构","href":"#unet-的基本结构","heading":3,"title":"UNet 的基本结构","children":[],"id":"unet-的基本结构"},{"key":"unet-在-stable-diffusion-中的应用","href":"#unet-在-stable-diffusion-中的应用","heading":3,"title":"UNet 在 Stable Diffusion 中的应用","children":[],"id":"unet-在-stable-diffusion-中的应用"},{"key":"unet-的优势","href":"#unet-的优势","heading":3,"title":"UNet 的优势","children":[],"id":"unet-的优势"}],"id":"q-unet-是个什么样的结构"},{"key":"q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的","href":"#q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的","heading":1,"title":"Q: 为什么这里 unet、 vae 、 tokenizer 等几个模型都是从同一个路径加载的？","children":[{"key":"1-统一的模型路径","href":"#1-统一的模型路径","heading":3,"title":"1. 统一的模型路径","children":[],"id":"1-统一的模型路径"},{"key":"2-各个组件的作用","href":"#2-各个组件的作用","heading":3,"title":"2. 各个组件的作用","children":[],"id":"2-各个组件的作用"},{"key":"3-统一加载的好处","href":"#3-统一加载的好处","heading":3,"title":"3. 统一加载的好处","children":[],"id":"3-统一加载的好处"}],"id":"q-为什么这里-unet-vae--tokenizer-等几个模型都是从同一个路径加载的"},{"key":"q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web","href":"#q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web","heading":1,"title":"Q: 这些是 Stable Diffusion 的内部设计对吧？这些都在哪篇论文里提出的？ @Web","children":[],"id":"q-这些是-stable-diffusion-的内部设计对吧这些都在哪篇论文里提出的-web"},{"key":"q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy","href":"#q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy","heading":1,"title":"Q: 解释 StableDiffusionPipeline 的结构 @pipeline_stable_diffusion.py","children":[{"key":"继承关系","href":"#继承关系","heading":3,"title":"继承关系","children":[],"id":"继承关系"},{"key":"初始化方法","href":"#初始化方法","heading":3,"title":"初始化方法","children":[],"id":"初始化方法"},{"key":"功能和方法","href":"#功能和方法","heading":3,"title":"功能和方法","children":[],"id":"功能和方法"},{"key":"属性","href":"#属性","heading":3,"title":"属性","children":[],"id":"属性"},{"key":"设计目的","href":"#设计目的","heading":3,"title":"设计目的","children":[],"id":"设计目的"}],"id":"q-解释-stablediffusionpipeline-的结构-pipeline_stable_diffusionpy"},{"key":"q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么","href":"#q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么","heading":1,"title":"Q: @pipeline_utils.py 解释 DiffusionPipeline 的结构，以及 from_pretrained 在做什么","children":[{"key":"diffusionpipeline-的结构","href":"#diffusionpipeline-的结构","heading":3,"title":"DiffusionPipeline 的结构","children":[],"id":"diffusionpipeline-的结构"},{"key":"from_pretrained-方法","href":"#from_pretrained-方法","heading":3,"title":"from_pretrained 方法","children":[],"id":"from_pretrained-方法"},{"key":"设计目的-1","href":"#设计目的-1","heading":3,"title":"设计目的","children":[],"id":"设计目的-1"}],"id":"q-pipeline_utilspy-解释-diffusionpipeline-的结构以及-from_pretrained-在做什么"},{"key":"q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗","href":"#q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗","heading":1,"title":"Q: @train_text_to_image_lora.py 里，从 DiffusionPipeline.from_pretrained 加载到了 @pipeline_stable_diffusion.py 中 StableDiffusionPipeline 类的实例，我理解的对吗？","children":[{"key":"具体过程如下","href":"#具体过程如下","heading":3,"title":"具体过程如下：","children":[],"id":"具体过程如下"}],"id":"q-train_text_to_image_lorapy-里从-diffusionpipelinefrom_pretrained-加载到了-pipeline_stable_diffusionpy-中-stablediffusionpipeline-类的实例我理解的对吗"},{"key":"q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase","href":"#q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase","heading":1,"title":"Q: 解读 @pipeline_utils.py 中 from_pretrained 代码，详细说明如何识别模型类型选择管道类。 @Codebase","children":[{"key":"识别模型类型并选择管道类的步骤","href":"#识别模型类型并选择管道类的步骤","heading":3,"title":"识别模型类型并选择管道类的步骤","children":[],"id":"识别模型类型并选择管道类的步骤"}],"id":"q-解读-pipeline_utilspy-中-from_pretrained-代码详细说明如何识别模型类型选择管道类-codebase"},{"key":"q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例","href":"#q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例","heading":1,"title":"Q: 如果我只有一个 sd_xl_base_1.0.safetensors 文件，是否无法使用 from_pretrained 方法得到具体的 Pipeline 实例？","children":[{"key":"解决方案","href":"#解决方案","heading":3,"title":"解决方案","children":[],"id":"解决方案"},{"key":"总结-1","href":"#总结-1","heading":3,"title":"总结","children":[],"id":"总结-1"}],"id":"q-如果我只有一个-sd_xl_base_10safetensors-文件是否无法使用-from_pretrained-方法得到具体的-pipeline-实例"},{"key":"q-如果我只需要进行推理是否仍需配置文件","href":"#q-如果我只需要进行推理是否仍需配置文件","heading":1,"title":"Q: 如果我只需要进行推理，是否仍需配置文件？","children":[{"key":"为什么需要配置文件","href":"#为什么需要配置文件","heading":3,"title":"为什么需要配置文件","children":[],"id":"为什么需要配置文件"},{"key":"没有配置文件时的推理","href":"#没有配置文件时的推理","heading":3,"title":"没有配置文件时的推理","children":[],"id":"没有配置文件时的推理"},{"key":"总结-2","href":"#总结-2","heading":3,"title":"总结","children":[],"id":"总结-2"}],"id":"q-如果我只需要进行推理是否仍需配置文件"},{"key":"q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的","href":"#q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的","heading":1,"title":"Q: 以你上面举的例子为例，@pipeline_loading_utils.py load_sub_model 中，实例化的是 @unet_2d_condition.py 中的 UNet2DConditionModel 类吗？ load_sub_model 是怎么找到这个类并实例化的？","children":[{"key":"核心加载流程","href":"#核心加载流程","heading":3,"title":"核心加载流程","children":[],"id":"核心加载流程"},{"key":"具体步骤解析","href":"#具体步骤解析","heading":3,"title":"具体步骤解析","children":[{"key":"1-类对象获取-get_class_obj_and_candidates","href":"#1-类对象获取-get_class_obj_and_candidates","heading":4,"title":"1. 类对象获取 (get_class_obj_and_candidates)","children":[],"id":"1-类对象获取-get_class_obj_and_candidates"},{"key":"2-加载方法匹配","href":"#2-加载方法匹配","heading":4,"title":"2. 加载方法匹配","children":[],"id":"2-加载方法匹配"},{"key":"3-加载方法绑定","href":"#3-加载方法绑定","heading":4,"title":"3. 加载方法绑定","children":[],"id":"3-加载方法绑定"},{"key":"4-实例化-unet","href":"#4-实例化-unet","heading":4,"title":"4. 实例化 UNet","children":[],"id":"4-实例化-unet"}],"id":"具体步骤解析"},{"key":"unet2dconditionmodel-的注册机制","href":"#unet2dconditionmodel-的注册机制","heading":3,"title":"UNet2DConditionModel 的注册机制","children":[],"id":"unet2dconditionmodel-的注册机制"},{"key":"架构参数如何生效","href":"#架构参数如何生效","heading":3,"title":"架构参数如何生效","children":[],"id":"架构参数如何生效"},{"key":"总结流程图","href":"#总结流程图","heading":3,"title":"总结流程图","children":[],"id":"总结流程图"}],"id":"q-以你上面举的例子为例pipeline_loading_utilspy-load_sub_model-中实例化的是-unet_2d_conditionpy-中的-unet2dconditionmodel-类吗-load_sub_model-是怎么找到这个类并实例化的"},{"key":"q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-","href":"#q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-","heading":1,"title":"Q: 解析代码，详解@modeling_utils.py 的 from_pretrained 如何实例化 @unet_2d_condition.py 中的 UNet2DConditionModel ？","children":[],"id":"q-解析代码详解modeling_utilspy-的-from_pretrained-如何实例化-unet_2d_conditionpy-中的-unet2dconditionmodel-"},{"key":"from_pretrained-如何实例化-unet2dconditionmodel-的详细流程","href":"#from_pretrained-如何实例化-unet2dconditionmodel-的详细流程","heading":1,"title":"from_pretrained 如何实例化 UNet2DConditionModel 的详细流程","children":[{"key":"1-加载配置文件","href":"#1-加载配置文件","heading":2,"title":"1. 加载配置文件","children":[],"id":"1-加载配置文件"},{"key":"2-创建空模型实例","href":"#2-创建空模型实例","heading":2,"title":"2. 创建空模型实例","children":[],"id":"2-创建空模型实例"},{"key":"3-加载权重文件","href":"#3-加载权重文件","heading":2,"title":"3. 加载权重文件","children":[],"id":"3-加载权重文件"},{"key":"4-将权重加载到模型中","href":"#4-将权重加载到模型中","heading":2,"title":"4. 将权重加载到模型中","children":[],"id":"4-将权重加载到模型中"},{"key":"5-设备分配和后处理","href":"#5-设备分配和后处理","heading":2,"title":"5. 设备分配和后处理","children":[],"id":"5-设备分配和后处理"},{"key":"6-返回实例化的模型","href":"#6-返回实例化的模型","heading":2,"title":"6. 返回实例化的模型","children":[],"id":"6-返回实例化的模型"},{"key":"关键实现细节","href":"#关键实现细节","heading":2,"title":"关键实现细节","children":[],"id":"关键实现细节"}],"id":"from_pretrained-如何实例化-unet2dconditionmodel-的详细流程"},{"key":"q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构","href":"#q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构","heading":1,"title":"Q: 详细解释 @unet_2d_condition.py 中 UNet2DConditionModel 的结构","children":[{"key":"整体架构","href":"#整体架构","heading":3,"title":"整体架构","children":[],"id":"整体架构"},{"key":"核心组件","href":"#核心组件","heading":3,"title":"核心组件","children":[{"key":"1-输入处理","href":"#1-输入处理","heading":4,"title":"1. 输入处理","children":[],"id":"1-输入处理"},{"key":"2-时间嵌入系统","href":"#2-时间嵌入系统","heading":4,"title":"2. 时间嵌入系统","children":[],"id":"2-时间嵌入系统"},{"key":"3-下采样模块","href":"#3-下采样模块","heading":4,"title":"3. 下采样模块","children":[],"id":"3-下采样模块"},{"key":"4-中间模块","href":"#4-中间模块","heading":4,"title":"4. 中间模块","children":[],"id":"4-中间模块"},{"key":"5-上采样模块","href":"#5-上采样模块","heading":4,"title":"5. 上采样模块","children":[],"id":"5-上采样模块"},{"key":"6-输出处理","href":"#6-输出处理","heading":4,"title":"6. 输出处理","children":[],"id":"6-输出处理"}],"id":"核心组件"},{"key":"条件控制机制","href":"#条件控制机制","heading":3,"title":"条件控制机制","children":[{"key":"交叉注意力层","href":"#交叉注意力层","heading":4,"title":"交叉注意力层","children":[],"id":"交叉注意力层"}],"id":"条件控制机制"},{"key":"关键参数说明","href":"#关键参数说明","heading":3,"title":"关键参数说明","children":[],"id":"关键参数说明"},{"key":"数据流动示例","href":"#数据流动示例","heading":3,"title":"数据流动示例","children":[],"id":"数据流动示例"}],"id":"q-详细解释-unet_2d_conditionpy-中-unet2dconditionmodel-的结构"},{"key":"q-详细解释下采样快的细节","href":"#q-详细解释下采样快的细节","heading":1,"title":"Q: 详细解释下采样快的细节","children":[{"key":"下采样块概述","href":"#下采样块概述","heading":3,"title":"下采样块概述","children":[],"id":"下采样块概述"},{"key":"下采样块的结构","href":"#下采样块的结构","heading":3,"title":"下采样块的结构","children":[{"key":"1-残差块resnet-block","href":"#1-残差块resnet-block","heading":4,"title":"1. 残差块（ResNet Block）","children":[],"id":"1-残差块resnet-block"},{"key":"2-交叉注意力层","href":"#2-交叉注意力层","heading":4,"title":"2. 交叉注意力层","children":[],"id":"2-交叉注意力层"},{"key":"3-降采样操作","href":"#3-降采样操作","heading":4,"title":"3. 降采样操作","children":[],"id":"3-降采样操作"}],"id":"下采样块的结构"},{"key":"下采样块的完整实现","href":"#下采样块的完整实现","heading":3,"title":"下采样块的完整实现","children":[],"id":"下采样块的完整实现"},{"key":"总结-3","href":"#总结-3","heading":3,"title":"总结","children":[],"id":"总结-3"}],"id":"q-详细解释下采样快的细节"},{"key":"q-详细讲解上采样块的细节","href":"#q-详细讲解上采样块的细节","heading":1,"title":"Q: 详细讲解上采样块的细节","children":[{"key":"上采样块概述","href":"#上采样块概述","heading":3,"title":"上采样块概述","children":[],"id":"上采样块概述"},{"key":"上采样块的结构","href":"#上采样块的结构","heading":3,"title":"上采样块的结构","children":[{"key":"1-残差块resnet-block-1","href":"#1-残差块resnet-block-1","heading":4,"title":"1. 残差块（ResNet Block）","children":[],"id":"1-残差块resnet-block-1"},{"key":"2-交叉注意力层-1","href":"#2-交叉注意力层-1","heading":4,"title":"2. 交叉注意力层","children":[],"id":"2-交叉注意力层-1"},{"key":"3-上采样操作","href":"#3-上采样操作","heading":4,"title":"3. 上采样操作","children":[],"id":"3-上采样操作"}],"id":"上采样块的结构"},{"key":"上采样块的完整实现","href":"#上采样块的完整实现","heading":3,"title":"上采样块的完整实现","children":[],"id":"上采样块的完整实现"},{"key":"总结-4","href":"#总结-4","heading":3,"title":"总结","children":[],"id":"总结-4"}],"id":"q-详细讲解上采样块的细节"},{"key":"q-详细讲解中间模块细节","href":"#q-详细讲解中间模块细节","heading":1,"title":"Q: 详细讲解中间模块细节","children":[{"key":"中间模块概述","href":"#中间模块概述","heading":3,"title":"中间模块概述","children":[],"id":"中间模块概述"},{"key":"中间模块的结构","href":"#中间模块的结构","heading":3,"title":"中间模块的结构","children":[{"key":"1-残差块resnet-block-2","href":"#1-残差块resnet-block-2","heading":4,"title":"1. 残差块（ResNet Block）","children":[],"id":"1-残差块resnet-block-2"},{"key":"2-自注意力层","href":"#2-自注意力层","heading":4,"title":"2. 自注意力层","children":[],"id":"2-自注意力层"},{"key":"3-交叉注意力层","href":"#3-交叉注意力层","heading":4,"title":"3. 交叉注意力层","children":[],"id":"3-交叉注意力层"}],"id":"中间模块的结构"},{"key":"中间模块的完整实现","href":"#中间模块的完整实现","heading":3,"title":"中间模块的完整实现","children":[],"id":"中间模块的完整实现"},{"key":"总结-5","href":"#总结-5","heading":3,"title":"总结","children":[],"id":"总结-5"}],"id":"q-详细讲解中间模块细节"},{"key":"q-详细讲解输入处理与输出处理模块细节","href":"#q-详细讲解输入处理与输出处理模块细节","heading":1,"title":"Q: 详细讲解输入处理与输出处理模块细节","children":[{"key":"输入处理模块","href":"#输入处理模块","heading":3,"title":"输入处理模块","children":[{"key":"1-输入卷积层","href":"#1-输入卷积层","heading":4,"title":"1. 输入卷积层","children":[],"id":"1-输入卷积层"}],"id":"输入处理模块"},{"key":"输出处理模块","href":"#输出处理模块","heading":3,"title":"输出处理模块","children":[{"key":"1-输出卷积层","href":"#1-输出卷积层","heading":4,"title":"1. 输出卷积层","children":[],"id":"1-输出卷积层"}],"id":"输出处理模块"},{"key":"输入与输出处理的完整实现","href":"#输入与输出处理的完整实现","heading":3,"title":"输入与输出处理的完整实现","children":[],"id":"输入与输出处理的完整实现"},{"key":"总结-6","href":"#总结-6","heading":3,"title":"总结","children":[],"id":"总结-6"}],"id":"q-详细讲解输入处理与输出处理模块细节"},{"key":"q-详细讲解时间嵌入系统的细节","href":"#q-详细讲解时间嵌入系统的细节","heading":1,"title":"Q: 详细讲解时间嵌入系统的细节","children":[{"key":"时间嵌入系统概述","href":"#时间嵌入系统概述","heading":3,"title":"时间嵌入系统概述","children":[],"id":"时间嵌入系统概述"},{"key":"时间嵌入系统的结构","href":"#时间嵌入系统的结构","heading":3,"title":"时间嵌入系统的结构","children":[{"key":"1-正弦位置编码","href":"#1-正弦位置编码","heading":4,"title":"1. 正弦位置编码","children":[],"id":"1-正弦位置编码"},{"key":"2-时间嵌入层","href":"#2-时间嵌入层","heading":4,"title":"2. 时间嵌入层","children":[],"id":"2-时间嵌入层"}],"id":"时间嵌入系统的结构"},{"key":"时间嵌入系统的完整实现","href":"#时间嵌入系统的完整实现","heading":3,"title":"时间嵌入系统的完整实现","children":[],"id":"时间嵌入系统的完整实现"},{"key":"总结-7","href":"#总结-7","heading":3,"title":"总结","children":[],"id":"总结-7"}],"id":"q-详细讲解时间嵌入系统的细节"}],"wikiRefAliases":[],"richRefAliases":[]},"prevNextInfo":{"prevInfo":{"pathMapping":{"pagePath":"/learn_from_ai/mqtt-protocol-principles-applications","filePath":"public/content/learn_from_ai/2025-03-28-mqtt-protocol-principles-applications.md"},"meta":{"title":"详细介绍 MQTT 协议的内容，原理，应用场景","created_at":"2025-03-28T06:35:00.000Z","updated_at":"2025-03-28T06:35:00.000Z"}},"nextInfo":{"pathMapping":{"pagePath":"/learn_from_ai/golang-new-and-memory-management","filePath":"public/content/learn_from_ai/2025-03-07-golang-new-and-memory-management.md"},"meta":{"title":"GoLang 中 new() 与内存管理机制详解","created_at":"2025-03-07T16:00:00.000Z","updated_at":"2025-03-07T16:00:00.000Z"}}},"backRefResources":[],"hyperProps":{"withSEO":true,"withComments":false}},"__N_SSG":true},"page":"/learn_from_ai/[slug]","query":{"slug":"stable-diffusion-unet-structure"},"buildId":"jAGlVzXXWmm3gN9ilzCwJ","assetPrefix":"/blog-next","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>