<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta property="og:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta name="twitter:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta property="og:url" content="https://blog.ryo-okami.xyz/articles/introduction-for-k8s-2" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@ryo_okami" data-next-head=""/><meta name="twitter:creator" content="@ryo_okami" data-next-head=""/><link rel="icon" href="/blog-next/favicon.ico" data-next-head=""/><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" data-next-head=""/><title data-next-head="">Kubernetes 入门 （2） | Ryo&#x27;s Blog</title><meta property="og:title" content="Kubernetes 入门 （2）" data-next-head=""/><meta property="og:site_name" content="Ryo&#x27;s Blog" data-next-head=""/><meta name="twitter:title" content="Kubernetes 入门 （2） | Ryo&#x27;s Blog" data-next-head=""/><meta name="description" content="我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。
其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？
在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。" data-next-head=""/><meta property="og:description" content="我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。
其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？
在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。" data-next-head=""/><meta name="twitter:description" content="我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。
其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？
在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2022-08-20T21:56:52.000Z" data-next-head=""/><meta property="article:modified_time" content="2022-08-20T14:02:18.000Z" data-next-head=""/><meta property="article:tag" content="Kubernetes" data-next-head=""/><meta property="article:tag" content="DevOps" data-next-head=""/><meta property="article:tag" content="Docker" data-next-head=""/><meta property="article:tag" content="Cloud Native" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" as="style"/><link rel="preload" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" as="style"/><link rel="stylesheet" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" data-n-g=""/><link rel="stylesheet" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/blog-next/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/blog-next/_next/static/chunks/webpack-c432b1ec7364dcfe.js" defer=""></script><script src="/blog-next/_next/static/chunks/framework-bd61ec64032c2de7.js" defer=""></script><script src="/blog-next/_next/static/chunks/main-0d790d35cd43e765.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/_app-b378900ad73d35ce.js" defer=""></script><script src="/blog-next/_next/static/chunks/6d2b60a9-beef439121ada977.js" defer=""></script><script src="/blog-next/_next/static/chunks/52d06cd5-18d657cfd06e973c.js" defer=""></script><script src="/blog-next/_next/static/chunks/4130-4f55663d0ffc3327.js" defer=""></script><script src="/blog-next/_next/static/chunks/4587-ad3e00575945688a.js" defer=""></script><script src="/blog-next/_next/static/chunks/366-18974ff975371ff8.js" defer=""></script><script src="/blog-next/_next/static/chunks/7564-2d1adbbf02956a78.js" defer=""></script><script src="/blog-next/_next/static/chunks/8494-2925249a12348ea9.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/articles/%5Bslug%5D-4759ef57d55fd17a.js" defer=""></script><script src="/blog-next/_next/static/2bZ63KvBkpjc51_BACkni/_buildManifest.js" defer=""></script><script src="/blog-next/_next/static/2bZ63KvBkpjc51_BACkni/_ssgManifest.js" defer=""></script></head><body><link rel="preload" as="image" href="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg"/><div id="__next"><style data-emotion="css czlpqi">.css-czlpqi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-czlpqi{position:absolute;}}</style><style data-emotion="css 1cmpeoq">.css-1cmpeoq{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:var(--Paper-shadow);background-image:var(--Paper-overlay);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-1cmpeoq{position:absolute;}}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionFixed mui-fixed css-1cmpeoq" style="--Paper-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"><style data-emotion="css 1guk29">@media (min-width:0px){.css-1guk29{display:none;}}@media (min-width:900px){.css-1guk29{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="ml-2 w-24 mr-4 MuiBox-root css-1guk29"><a class="DefaultLayout_textlink__W55gl" href="/blog-next">Ryo&#x27;s Blog</a></div><style data-emotion="css 1m04nb5">@media (min-width:0px){.css-1m04nb5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:900px){.css-1m04nb5{display:none;}}</style><div class="ml-2 mr-4 MuiBox-root css-1m04nb5"><a title="Ryo&#x27;s Blog" href="/blog-next"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium h-6 w-6 text-gray-300 hover:text-white css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></a></div><style data-emotion="css nznm6s">.css-nznm6s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="MuiBox-root css-nznm6s"><div class="DefaultLayoutMenu bg-transparent min-w-full"><ul class="rc-menu-overflow rc-menu rc-menu-root rc-menu-horizontal" role="menu" tabindex="0" data-menu-list="true"><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:0" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/articles">Articles</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:1" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/learn_from_ai">Learn from AI</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:2" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/tags">Tags</a></li><li class="rc-menu-overflow-item rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:1;order:3" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span class="DefaultLayout_textlink__W55gl">More</span><i class="rc-menu-submenu-arrow"></i></div></li><li class="rc-menu-overflow-item rc-menu-overflow-item-rest rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" title="..." aria-expanded="false" aria-haspopup="true">...<i class="rc-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></div></div><style data-emotion="css k008qs">.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="MuiBox-root css-k008qs"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></header><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"></div><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="DefaultLayout_contentHeight__RDRZE"><article class="Post_post__acRqJ"><h1 class="Post_postTitle__N1NIA">Kubernetes 入门 （2）</h1><div class="Post_postDate__SQx7A"><time dateTime="2022-08-20T21:56:52.000Z">2022-08-20</time></div><div class="TagsBox_tagsBox__WzhAf mt-2"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/kubernetes">#<!-- -->Kubernetes</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/devops">#<!-- -->DevOps</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/docker">#<!-- -->Docker</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/cloud-native">#<!-- -->Cloud Native</a></div><div class="post-body Post_postContent__mJ_Ju"><p>我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。</p>
<h1 id="储存"><a href="#储存" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>储存</h1>
<p>其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？</p>
<p>在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。</p>
<blockquote>
<p>CSI: Container Storage Interface ，容器储存接口标准，是 K8s 提出的一种规范。不管是哪种储存引擎，只要编写一个对应的插件实现 CSI ，都可以在 K8s 中使用。</p>
</blockquote>
<h3 id="k8s-中使用-volume-与可用的-volume-类型"><a href="#k8s-中使用-volume-与可用的-volume-类型" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>K8s 中使用 Volume 与可用的 Volume 类型</h3>
<p>其实 K8s 中使用 Volume 的例子我们一开始就已经接触过了。还记得一开始介绍 Pod 时的 Nginx 例子吗？</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">simple-webapp</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">main-application</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/log/nginx</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">sidecar-container</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">busybox</span></span>
<span data-line=""><span style="color:#E5C07B">      command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">sh</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-c</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">while true; do cat /var/log/nginx/access.log; sleep 30; done</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/log/nginx</span></span>
<span data-line=""><span style="color:#E5C07B">  volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">      emptyDir</span><span style="color:#A9B2C3">: {}</span></span></code></pre></figure>
<p>这个 Pod 描述中声明了一个种类为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>emptyDir</span></span></code></span> 的，名为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>shared-logs</span></span></code></span> 的 Volume ，然后 Pod 中的两个容器都分别 Mount 了这个 Volume 。</p>
<p>K8s 中默认提供了几种 Volume ，比如：</p>
<ul>
<li>emptyDir ：一个简单的空目录，一般用于储存临时数据或是 Pod 的容器之间共享数据。</li>
<li>hostPath ：绑定到节点宿主机文件系统上的路径，一般在 Daemon Set 中使用。</li>
<li>gitRepo ：这种 Volume 其实相当于 emptyDir ，不过在 Pod 启动时会从 Git 仓库 clone 一份内容作为默认数据。</li>
<li>configMap 、 secret ：一般用于配置文件加载，需要与 configMap 、 secret 这两种资源一同使用。会将 configMap 、 secret 中对应的内容拷贝一份作为 Volume 绑到容器。（下一节中会展开讨论）</li>
<li>nfs 、 glusterfs 、 ……：可以通过各种网络存储协议直接挂载一个网络存储</li>
<li>(deprecated!) gcePersistentDisk 、 awsElasticBlockStore ……：可以调用各个云平台的 API ，创建一个块储存硬件挂载到宿主机上，再将那个硬件挂载到容器中。</li>
<li>persistentVolumeClaim ：持久卷声明，用于把实际储存方式抽象化，使得 Pod 不需要关心具体的储存类型。这种类型会在下面详细介绍。</li>
</ul>
<p>我们可以注意到， Volume 的声明是 Pod 的一个属性，而不是一种单独的资源。 Volume 是 Pod 的一部分，因此不同的 Pod 之间永远不可能共享同一个 Volume 。</p>
<blockquote>
<p>但是 Volume 所指向的位置可以相同，比如 HostPath 类型的 Volume 就可以两个 Pod 可以绑定到宿主机上同一个路径，因此 Volume 里的数据还是能通过一定方式在 Pod 间共享。但当然 K8s 不推荐这么做。</p>
</blockquote>
<p>另外，由于 Volume 是 Pod 的一部分， Volume 的生命周期也是跟随 Pod 的，当一个 Pod 被销毁时， Volume 也会被销毁，因此最主要还是用于 Pod 内容器间的文件共享。如果需要持久化储存，需要使用 Persistent Volume 。</p>
<blockquote>
<p>Volume 会被销毁不代表 Volume 指向的内容会被销毁。比如 hostPath 、 NFS 等类型 Volume 中的内容就会继续保留在宿主机或是 NAS 上。下面提到的 Presistent Volume Claim 也是，拥有 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>persistentVolumeClaim</span></span></code></span> 类型 Volume 的 Pod 被删除后对应的 PVC 不一定会被删除。</p>
</blockquote>
<h3 id="presistent-volume--presistent-volume-claim--storage-class"><a href="#presistent-volume--presistent-volume-claim--storage-class" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Presistent Volume 、 Presistent Volume Claim 、 Storage Class</h3>
<p>如果需要在 Pod 声明中直接指定 NFS 、 awsElasticBlockStore 之类的信息，就需要应用的开发人员对真实可用的储存结构有所理解，违背了 K8s 的理念。因此 K8s 就弄出了小标题中的三种资源来将储存抽象化。</p>
<p>一个 Persistent Volume (PV) 对应云平台提供的一个块存储，或是 NAS 上的一个路径。可以简单地理解为 <strong>PV 直接描述了一块可用的物理存储</strong> 。因为 PV 直接对应到硬件，因此 PV 跟节点一样，是名称空间无关的。</p>
<p>而一个 <strong>Persistent Volume Claim (PVC) 则是描述了怎样去使用储存</strong> ：使用多少空间、只读还是读写等。一个 PVC 被创建后会且只会对应到一个 PV 。 PVC 从属于一个名称空间，并能被该名称空间下的 Pod 指定为一个 Volume 。</p>
<p>PV 与 PVC 这两种抽象是很必要的。试想一下用自己的物理机搭建一个 K8s 集群的场景。你会提前给物理机插上许多个储存硬件，这时你就需要用 PV 来描述这些硬件，之后才能在 K8s 里利用这些硬件的储存。而实际将应用部署到 K8s 中时，你才需要用 PVC 来描述 Pod 中需要怎么样的储存卷，然后 K8s 就会自动挑一个合适 PV 给这个 PVC 绑定上。这样实际部署应用的时候就不用再特意跑去机房给物理机插硬件了。</p>
<p>但是现在都云原生时代了，各供应商都有提供 API 可以直接创建一个块储存，还要想办法提前准备 PV 实在是太蠢了。于是便需要 Storage Class 这种资源。</p>
<p>使用 Storage Class 前需要先安装各种云供应商提供的插件（当然使用云服务提供的 K8s 的话一般已经准备好了），然后再创建一个 Storage Class 类型的资源（当然一般也已经准备好了）。下面是 AWS 上的 EKS 服务中默认自带的 Storage Class ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">storage.k8s.io/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">StorageClass</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  annotations</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    storageclass.kubernetes.io/is-default-class</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">true</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gp2</span></span>
<span data-line=""><span style="color:#E5C07B">provisioner</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kubernetes.io/aws-ebs</span></span>
<span data-line=""><span style="color:#E5C07B">parameters</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  fsType</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ext4</span></span>
<span data-line=""><span style="color:#E5C07B">  type</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gp2</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 当 PVC 被删除时会同时删除 PV</span></span>
<span data-line=""><span style="color:#E5C07B">reclaimPolicy</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Delete</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 只有当 PVC 被绑定为一个 Pod 的 Volume 时才会创建一个 PV</span></span>
<span data-line=""><span style="color:#E5C07B">volumeBindingMode</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">WaitForFirstConsumer</span></span></code></pre></figure>
<p>可以看到 EKS 自带的 gp2 提供了一些默认的选项，我们也可以类似地去定义自己的 Storage Class 。有了 gp2 这个 Storage Class ，我们创建一个 PVC 后 K8s 就会调用 AWS 的 API ，创建一个块储存接到我们的节点上，然后 K8s 再自动创建一个 PV 并绑定到 PVC 上。</p>
<p>例如，我们部署 Kafka 时会创建一个这样的 PVC ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">PersistentVolumeClaim</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">data-kafka-0</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  accessModes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#98C379">ReadWriteOnce</span></span>
<span data-line=""><span style="color:#E5C07B">  resources</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    requests</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      storage</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">10Gi</span></span>
<span data-line=""><span style="color:#E5C07B">  storageClassName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gp2</span></span></code></pre></figure>
<p>K8s 就会自动为我们创建出一个对应的 PV ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># `pvc-` 开头这个是 AWS 自动给我们起的名字。它虽然是 `pvc-` 开头，但他其实是一个 PV 。</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                                       CAPACITY</span><span style="color:#98C379">   ACCESS</span><span style="color:#98C379"> MODES</span><span style="color:#98C379">   RECLAIM</span><span style="color:#98C379"> POLICY</span><span style="color:#98C379">   STATUS</span><span style="color:#98C379">   CLAIM</span><span style="color:#98C379">                STORAGECLASS</span><span style="color:#98C379">   REASON</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">pvc-3614c15f-5697-4d66-a13c-6ddf7eb89998</span><span style="color:#98C379">   10Gi</span><span style="color:#98C379">       RWO</span><span style="color:#98C379">            Delete</span><span style="color:#98C379">           Bound</span><span style="color:#98C379">    kafka/data-kafka-0</span><span style="color:#98C379">   gp2</span><span style="color:#98C379">                     152d</span></span></code></pre></figure>
<p>要是打开 AWS Console 还会发现， K8s 调用了 AWS 的 API ，自动为我们创建了一个 EBS 块储存并绑定到了我们对应的宿主机上。</p>
<p>可以用下面这张图来表示 Pod 中的 Volume 、 PVC 、 PV 之间的关系：</p>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><style data-emotion="css 14awfyb animation-61bdi0">.css-14awfyb{display:inline-block;-webkit-animation:animation-61bdi0 1.4s linear infinite;animation:animation-61bdi0 1.4s linear infinite;color:#1976d2;}@-webkit-keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}</style><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><style data-emotion="css 4ejps8">.css-4ejps8{display:block;}</style><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><style data-emotion="css 13odlrs animation-1o38n3e">.css-13odlrs{stroke:currentColor;stroke-dasharray:80px,200px;stroke-dashoffset:0;-webkit-animation:animation-1o38n3e 1.4s ease-in-out infinite;animation:animation-1o38n3e 1.4s ease-in-out infinite;}@-webkit-keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}@keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}</style><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<p>而 Storage Class 在上图中则负责读取我们提交的 PVC ，然后创建 PV 与 EBS 。</p>
<h3 id="再说回-stateful-set"><a href="#再说回-stateful-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>再说回 Stateful Set</h3>
<p>之前我们提到 Stateful Set 时说到 Stateful Set 创建的 Pod 拥有固定的储存，到底是什么意思呢？跟 Deployment 的储存又有什么区别呢？</p>
<p>我们先来看看，如果要给 Deployment 创建出来的 Pod 挂载 PVC 需要怎么做。下面是一个部署 Nginx 的 Deployment 清单，其中 html 目录下的静态文件存放在 NFS 里，通过 PVC 挂载到 Pod 中：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 这里省略了 Service 相关的内容</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Deployment</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx-dpl-with-nfs-pvc</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">3</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx:alpine</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">containerPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">80</span></span>
<span data-line=""><span style="color:#E5C07B">          name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">web</span></span>
<span data-line=""><span style="color:#E5C07B">        volumeMounts</span><span style="color:#A9B2C3">: </span><span style="color:#5F6672;font-style:italic">#挂载容器中的目录到 pvc nfs 中的目录</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">www</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/usr/share/nginx/html</span></span>
<span data-line=""><span style="color:#E5C07B">      volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">www</span></span>
<span data-line=""><span style="color:#E5C07B">        persistentVolumeClaim</span><span style="color:#A9B2C3">: </span><span style="color:#5F6672;font-style:italic">#指定pvc</span></span>
<span data-line=""><span style="color:#E5C07B">          claimName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nfs-pvc-for-nginx</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">PersistentVolumeClaim</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nfs-pvc-for-nginx</span></span>
<span data-line=""><span style="color:#E5C07B">  namespace</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">default</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  storageclassname</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;&quot;</span><span style="color:#5F6672;font-style:italic"> # 指定使用现有 PV ，不使用 StorageClass 创建 PV</span></span>
<span data-line=""><span style="color:#E5C07B">  accessModes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#98C379">ReadWriteMany</span></span>
<span data-line=""><span style="color:#E5C07B">  resources</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    requests</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      storage</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">1Gi</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 这个例子中需要挂载 NFS 上的特定路径，所以手动定义了一个 PV</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 一般情况下我们不会手动创建 PV，而是使用 StorageClass 自动创建</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">PersistentVolume</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nfs-pv-for-nginx</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  capacity</span><span style="color:#A9B2C3">: </span></span>
<span data-line=""><span style="color:#E5C07B">    storage</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">1Gi</span></span>
<span data-line=""><span style="color:#E5C07B">  accessModes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#98C379">ReadWriteMany</span></span>
<span data-line=""><span style="color:#E5C07B">  persistentVolumeReclaimPolicy</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Retain</span></span>
<span data-line=""><span style="color:#E5C07B">  nfs</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/nfs/sharefolder/nginx</span></span>
<span data-line=""><span style="color:#E5C07B">    server</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">81.70.4.171</span></span></code></pre></figure>
<p>这份清单我们主要关注前两个资源，我们可以看到除了一个 Deployment 资源以外我们还单独定义了一个 PVC 资源。然后在 Deployment 的 Pod 模板中声明并绑定了这个 PVC 。</p>
<p>可这样 apply 了之后会发生什么情况呢？因为我们只声明了一份 PVC ，当然我们只会拥有一个 PVC 资源。但这个 Deployment 的副本数是 3 ，因此我们会有 3 个相同的 Pod 去绑定同一个 PVC 。也就是最终会在 3 个容器里访问同一个 NFS 的同一个目录。如果我们在其中一个容器里对这个目录作修改，也会影响到另外两个容器。</p>
<blockquote>
<p>注：这一现象不一定在任何情况下都适用。比如 AWS 的 EBS 卷只支持单个 AZ 内的绑定。如果 Pod 因为 Node Affinity 等设定被部署到了多个区，没法绑定同一个 EBS 卷，就会在 Scedule 的阶段报错。</p>
</blockquote>
<p>很多时候我们都不希望多个 Pod 绑定到同一 PVC 。比如我们部署一个 DB 集群的时候，如果好不容易部署出来的多个实例居然用的是同一份储存，就会显得很呆。 Stateful Set 就是为了解决这种情况，会为其管理下的每个 Pod 都部署一个专用的 PVC 。</p>
<p>下面是给 Stateful Set 创建出来的 Pod 挂载 PVC 的一份清单：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 这里省略了 Service 相关的内容</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">StatefulSet</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">web</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  serviceName</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">nginx</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">2</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">k8s.gcr.io/nginx-slim:0.8</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">containerPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">80</span></span>
<span data-line=""><span style="color:#E5C07B">          name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">web</span></span>
<span data-line=""><span style="color:#E5C07B">        volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">www</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/usr/share/nginx/html</span></span>
<span data-line=""><span style="color:#E5C07B">  volumeClaimTemplates</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">www</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      accessModes</span><span style="color:#A9B2C3">: [ </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">ReadWriteOnce</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3"> ]</span></span>
<span data-line=""><span style="color:#E5C07B">      resources</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        requests</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          storage</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">1Gi</span></span></code></pre></figure>
<p>我们可以看到，部署 Stateful Set 时我们不能另外单独定义一份 PVC 了，只能作为 Stateful Set 定义的一部分，在 volumeClaimTemplates 字段中定义 PVC 的模板。这样一来， Stateful Set 会根据这个模板，为每个 Pod 创建一个对应的 PVC ，并作为 Pod 的 Volume 绑定上：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="plastic"><code data-language="bash" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># Stateful Set 创建出来的 Pod ，名字都是按顺序的</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> pods</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app=nginx</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">      READY</span><span style="color:#98C379">     STATUS</span><span style="color:#98C379">    RESTARTS</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">web-0</span><span style="color:#98C379">     1/1</span><span style="color:#98C379">       Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">          1m</span></span>
<span data-line=""><span style="color:#B57EDC">web-1</span><span style="color:#98C379">     1/1</span><span style="color:#98C379">       Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">          1m</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># Stateful Set 创建出来的 PVC ，名字与 Pod 的名字一一对应</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> pvc</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app=nginx</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">        STATUS</span><span style="color:#98C379">    VOLUME</span><span style="color:#98C379">                                     CAPACITY</span><span style="color:#98C379">   ACCESSMODES</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">www-web-0</span><span style="color:#98C379">   Bound</span><span style="color:#98C379">     pvc-15c268c7-b507-11e6-932f-42010a800002</span><span style="color:#98C379">   1Gi</span><span style="color:#98C379">        RWO</span><span style="color:#98C379">           48s</span></span>
<span data-line=""><span style="color:#B57EDC">www-web-1</span><span style="color:#98C379">   Bound</span><span style="color:#98C379">     pvc-15c79307-b507-11e6-932f-42010a800002</span><span style="color:#98C379">   1Gi</span><span style="color:#98C379">        RWO</span><span style="color:#98C379">           48s</span></span></code></pre></figure>
<p>这样， Stateful Set 的多个 Pod 就会拥有自己的储存，不会相互打架了。另外，如果我们事先定义了 StorageClass ，还能根据 Stateful Set 的副本数动态配置 PV 。</p>
<h3 id="configmap-与-secret-挂载作为特殊的卷"><a href="#configmap-与-secret-挂载作为特殊的卷" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>ConfigMap 与 Secret 挂载作为特殊的卷</h3>
<p>有时候我们需要使用配置文件来配置应用（比如 Nginx 的配置文件），而且我们有时候会需要不重启 Pod 就热更新配置。如果用 PVC 来加载配置文件略微麻烦，这时候可以使用 Config Map 。</p>
<p>下面是 K8s 官网上 Config Map 的一个例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ConfigMap</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span></span>
<span data-line=""><span style="color:#E5C07B">data</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 一个 Key 可以对应一个值</span></span>
<span data-line=""><span style="color:#E5C07B">  player_initial_lives</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">3</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  ui_properties_file_name</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">user-interface.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 一个 Key 也可以对应一个文件的内容</span></span>
<span data-line=""><span style="color:#E5C07B">  game.properties</span><span style="color:#A9B2C3">: </span><span style="color:#E06C75">|</span></span>
<span data-line=""><span style="color:#98C379">    enemy.types=aliens,monsters</span></span>
<span data-line=""><span style="color:#98C379">    player.maximum-lives=5    </span></span>
<span data-line=""><span style="color:#E5C07B">  user-interface.properties</span><span style="color:#A9B2C3">: </span><span style="color:#E06C75">|</span></span>
<span data-line=""><span style="color:#98C379">    color.good=purple</span></span>
<span data-line=""><span style="color:#98C379">    color.bad=yellow</span></span>
<span data-line=""><span style="color:#98C379">    allow.textmode=true    </span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">configmap-demo-pod</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">demo</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">alpine</span></span>
<span data-line=""><span style="color:#E5C07B">      command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">sleep</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">3600</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">      env</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # ConfigMap 的 Key 可以作为环境变量引用</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">PLAYER_INITIAL_LIVES</span></span>
<span data-line=""><span style="color:#E5C07B">          valueFrom</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            configMapKeyRef</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">              name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span><span style="color:#5F6672;font-style:italic">           # 从这个 Config Map 里</span></span>
<span data-line=""><span style="color:#E5C07B">              key</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">player_initial_lives</span><span style="color:#5F6672;font-style:italic"> # 拿到这个 key 的值</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">UI_PROPERTIES_FILE_NAME</span></span>
<span data-line=""><span style="color:#E5C07B">          valueFrom</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            configMapKeyRef</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">              name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span></span>
<span data-line=""><span style="color:#E5C07B">              key</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ui_properties_file_name</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">config</span></span>
<span data-line=""><span style="color:#E5C07B">        mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">/config</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">        readOnly</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">  volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 定义 Pod 的 Volume ，种类为 configMap</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">config</span></span>
<span data-line=""><span style="color:#E5C07B">      configMap</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span><span style="color:#5F6672;font-style:italic"> # ConfigMap的名字</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 需要作为文件放入 Volume 的 Key</span></span>
<span data-line=""><span style="color:#E5C07B">        items</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">key</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">game.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">          path</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">game.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">key</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">user-interface.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">          path</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">user-interface.properties</span><span style="color:#A9B2C3">&quot;</span></span></code></pre></figure>
<p>我们可以看到 ConfigMap 里的 Key 可以作为文件或是环境变量加载到 Pod 中。另外，作为环境变量加载后其实还能作为命令行参数传入应用，实现各种配置方式。如果修改 Config map 的内容，也可以自动更新 Pod 中的文件。</p>
<p>然而， Config Map 的热更新有一些不太灵活的地方：</p>
<ol>
<li>作为环境变量加载的 Config Map 数据不会被热更新。想要更新这一部分数据需要重启 Pod。（当然，命令行参数也不能热更新）</li>
<li>由于 Kubelet 会先将 Config Map 内容加载到本地作为缓存，因此修改 Config Map 后新的内容不会第一时间加载到 Pod 中。而且在旧版本的 K8s 中， Config Map 被更新直到缓存被刷新的时间间隔还会很长，新版本的 K8s 这一部分有了优化，可以设定刷新时间，但会导致 API Server 的负担加重。（这其实是一个 Known Issue ，被诟病多年： <a href="https://github.com/kubernetes/kubernetes/issues/22368">https://github.com/kubernetes/kubernetes/issues/22368</a> ）</li>
</ol>
<p>除 Config Map 以外， K8s 还提供了一种叫 Secret 的资源，用法和 Config Map 几乎一样。对比 Config Map ，Secret 有以下几个特点：</p>
<ol>
<li>在 Pod 里， Secret 只会被加载到内存中，而永远不会被写到磁盘上。</li>
<li>用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl get</span></span></code></span> 之类的命令显示的 Secret 内容会被用 base64 编码。（不过， well ，众所周知 base64 可不算是什么加密）</li>
<li>可以通过 K8s 的 Service Account 等 RBAC 相关的资源来控制 Secret 的访问权限。</li>
</ol>
<p>不过，由于 Secret 也是以明文的形式被存储在 K8s 的主节点中的，因此需要保证 K8s 主节点的安全。</p>
<blockquote>
<p><strong>Downward API 挂载作为特殊的卷</strong></p>
<p>还有另外一种叫 Downward API 的东西，可以作为 Volume 或是环境变量被加载到 Pod 中。有一些参数我们很难事先在 Manifest 中定义（ e.g. Deployment 生成的 Pod 的名字），因此可以通过 Downward API 来实现。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">test-volume-pod</span></span>
<span data-line=""><span style="color:#E5C07B">    namespace</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kube-system</span></span>
<span data-line=""><span style="color:#E5C07B">    labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        k8s-app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">test-volume</span></span>
<span data-line=""><span style="color:#E5C07B">        node-env</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">test</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">test-volume-pod-container</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">busybox:latest</span></span>
<span data-line=""><span style="color:#E5C07B">      env</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">POD_NAME</span><span style="color:#5F6672;font-style:italic"> # 将 Pod 的名字作为环境变量 POD_NAME 加载到 Pod 中</span></span>
<span data-line=""><span style="color:#E5C07B">        valueFrom</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          fieldRef</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            fieldPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">metadata.name</span></span>
<span data-line=""><span style="color:#E5C07B">      command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">sh</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-c</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">      args</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#98C379">while true; do</span></span>
<span data-line=""><span style="color:#98C379">          cat /etc/podinfo/labels | echo;</span></span>
<span data-line=""><span style="color:#98C379">          env | sort | echo;</span></span>
<span data-line=""><span style="color:#98C379">          sleep 3600;</span></span>
<span data-line=""><span style="color:#98C379">        done;</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">podinfo</span></span>
<span data-line=""><span style="color:#E5C07B">        mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/etc/podinfo</span></span>
<span data-line=""><span style="color:#E5C07B">    volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">podinfo</span></span>
<span data-line=""><span style="color:#E5C07B">      downwardAPI</span><span style="color:#A9B2C3">: </span><span style="color:#5F6672;font-style:italic"># Downward API 类型的卷</span></span>
<span data-line=""><span style="color:#E5C07B">        items</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">path</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">labels</span><span style="color:#A9B2C3">&quot;</span><span style="color:#5F6672;font-style:italic"> # 将 Pod 的标签作为  labels 文件挂载到 Pod 中</span></span>
<span data-line=""><span style="color:#E5C07B">          fieldRef</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            fieldPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">metadata.labels</span></span></code></pre></figure>
</blockquote>
<h1 id="网络"><a href="#网络" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>网络</h1>
<p>其实 Pod 只要部署好了，就会被分配到一个集群内部的 IP 地址，流量就可以通过 IP 地址来访问 Pod 了。然而通过可能会有很大问题： <strong>Pod 随时会被杀死。</strong> 虽然通过用 Deployment 等资源可以在挂掉后重新创建一个 Pod ，但那毕竟是不同的 Pod ， IP 已经改变。</p>
<p>另外， Deployment 等资源的就是为了能更方便的做到多副本部署及任意缩容扩容而存在的。如果在 K8s 中访问 Pod 还需要小心翼翼地去找到 Pod 的 IP 地址，或是去寻找 Pod 是否部署了新副本， Deployment 等资源就几乎没有存在价值了。</p>
<blockquote>
<p>其实 Pod 部署好后不止会被分配 IP 地址，还会被分配到一个类似 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>&lt;pod-ip&gt;.&lt;namespace&gt;.pod.cluster.local</span></span></code></span> 的 DNS 记录。例如一个位于 default 名字空间，IP 地址为 172.17.0.3 的 Pod ，对应 DNS 记录为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>172-17-0-3.default.pod.cluster.local</span></span></code></span> 。</p>
</blockquote>
<h3 id="service"><a href="#service" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Service</h3>
<p>在古代，人们是通过注册中心、服务发现、负载均衡等中间件来解决上面这些问题的，但这样很不云原生。于是 K8s 引入了 Service 这种资源，来实现简易的服务发现、 DNS 功能。</p>
<p>下面是一个经典的例子，部署了一个 Service 和一个 Deployment：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Service</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth-service</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  type</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ClusterIP</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span><span style="color:#5F6672;font-style:italic"> # 指向 Deployment 创建的 Pod</span></span>
<span data-line=""><span style="color:#E5C07B">  ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">port</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">80</span><span style="color:#5F6672;font-style:italic"> # Service 暴露的端口</span></span>
<span data-line=""><span style="color:#E5C07B">    targetPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">8080</span><span style="color:#5F6672;font-style:italic"> # Pod 的端口</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Deployment</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">:  </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">2</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auth</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">xxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/auth:xxxxx</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">containerPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">8080</span></span></code></pre></figure>
<p>根据前面的知识我们知道，这份文件会部署 Deployment 会创建 2 个相同的 Pod 副本。另外还会部署一个名为 auth-service 的 Service 资源。这个 Service 暴露了一个 80 端口，并且指向那两个 Pod 的 8080 端口。</p>
<p>而这份文件部署后， Service 资源就会在集群中注册一个 DNS A 记录（或 AAAA 记录），集群内其他 Pod （为了辨别我们叫它 Client ）就可以通过相同的 DNS 名称来访问 Deployment 部署的这 2 个 Pod ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">curl</span><span style="color:#98C379"> http://auth-service.</span><span style="color:#E06C75">&lt;</span><span style="color:#98C379">namespac</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">.svc.cluster.local:80</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 或者省略掉后面的一大串</span></span>
<span data-line=""><span style="color:#B57EDC">curl</span><span style="color:#98C379"> http://auth-service.</span><span style="color:#E06C75">&lt;</span><span style="color:#98C379">namespac</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">:80</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 如果 Client 和 Service 在同一个 Namespace 中，还可以：</span></span>
<span data-line=""><span style="color:#B57EDC">curl</span><span style="color:#98C379"> http://auth-service:80</span></span></code></pre></figure>
<p>像这样 Client 通过 Service 来访问时，会随机访问到其中一个 Pod ，这样一来无论 Deployment 到底创建了多少个副本，只要副本的标签相同，就能通过同一个 DNS 名称来访问，还能自动实现一些简单的负载均衡。</p>
<blockquote>
<p><strong>为什么 DNS 名称可以简化？</strong></p>
<p>Pod 被部署时， kubelet 会为每个 Pod 注入一个类似如下的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>/etc/resolv.conf</span></span></code></span> 文件：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="plaintext" data-theme="plastic"><code data-language="plaintext" data-theme="plastic" style="display:grid"><span data-line=""><span>nameserver 10.32.0.10</span></span>
<span data-line=""><span>search &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.local</span></span>
<span data-line=""><span>options ndots:5</span></span></code></pre></figure>
<p>Pod 中进行 DNS 查询时，默认会先读取这个文件，然后按照 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>search</span></span></code></span> 选项中的内容展开 DNS 。例如，在 test 名称空间中的 Pod ，访问 data 时的查询可能被展开为 data.test.svc.cluster.local 。
更多关于 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>/etc/resolv.conf</span></span></code></span> 文件的内容可参考 <a href="https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html">https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html</a></p>
</blockquote>
<h3 id="service-的种类"><a href="#service-的种类" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Service 的种类</h3>
<p>我们上面的例子中，可以看到 Service 资源有个字段 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>type:ClusterIP</span></span></code></span> 。其实 Service 资源有以下几个种类：</p>
<table><thead><tr><th style="text-align:left">种类</th><th style="text-align:left">作用</th></tr></thead><tbody><tr><td style="text-align:left"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ClusterIP</span></span></code></span></td><td style="text-align:left">这个类型的 Service 会在集群内创建一条 DNS A 记录并通过一定方法将流量代理到其指向的 Pod 上。这种 Service 不会暴露到集群外。这是最基础的 Service 种类。</td></tr><tr><td style="text-align:left"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>NodePort</span></span></code></span></td><td style="text-align:left">这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并把端口的流量也代理到指向的 Pod 上。可以通过这种方法从集群外访问集群内的资源。</td></tr><tr><td style="text-align:left"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>LoadBalancer</span></span></code></span></td><td style="text-align:left">这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并在集群外创建一个负载均衡器来将外部流量路由到暴露的端口，再把流量代理到指向的 Pod 上。这种 Service 一般需要调用云服务提供的 API 或是额外安装的插件。如果什么插件都没安装的话，这种 Service 部署后会与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>NodePort</span></span></code></span> 的表现一样。</td></tr><tr><td style="text-align:left"><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>ExternalName</span></span></code></span></td><td style="text-align:left">这种 Service 不需要 selector 字段指定后端，而是用 externalName 字段指定一个外部 DNS 记录，然后将流量全部指向外部服务。如果打算将集群内的服务迁移到集群外、或是集群外迁移到集群内，这种类型的 Service 可以实现无缝迁移。</td></tr></tbody></table>
<h3 id="虚拟-ip-与-headless-service"><a href="#虚拟-ip-与-headless-service" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>虚拟 IP 与 Headless Service</h3>
<p>如果你在集群内尝试对 Service 对应的 DNS 记录进行域名解析，会发现返回来的 IP 地址与 Service 指向的任何一个 Pod 对应的 IP 地址都不相同。如果你还尝试了去 Ping 这个 IP 地址，会发现不能 Ping 通。为什么会这样呢？</p>
<p>原来，每个 Service 被部署后， K8s 都会给他分配一个集群内部的 IP 地址，也就是 Cluster IP （这也是最基础的 Service 种类会起名叫 Cluster IP 的原因）。</p>
<p>但是这个 Cluster IP 不会绑定任何的网卡，是一个虚拟 IP 。然后 K8s 中有一个叫 kube-proxy 的组件（这里叫他做组件，是因为 kube-proxy 与 Service 、 Deployment 等不一样，不是一种资源而是 K8s 的一部分）， kube-proxy 通过修改 iptables ，将虚拟 IP 的流量经过一定的负载均衡规则后代理到 Pod 上。</p>
<img src="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg" alt="K8s 官网上的虚拟 IP 图"/>
<blockquote>
<p><strong>为什么不使用 DNS 轮询？</strong></p>
<p>为什么 K8s 不配置多条 DNS A 记录，然后通过轮询名称来解析？为什么需要搞出虚拟 IP 这么复杂的东西？这个问题 K8s 官网上也有特别提到原因：</p>
<ul>
<li>DNS 实现的历史由来已久，它不遵守记录 TTL，并且在名称查找结果到期后对其进行缓存。</li>
<li>有些应用程序仅执行一次 DNS 查找，并无限期地缓存结果。</li>
<li>即使应用和库进行了适当的重新解析，DNS 记录上的 TTL 值低或为零也可能会给 DNS 带来高负载，从而使管理变得困难。</li>
</ul>
</blockquote>
<p>有些时候（比如想使用自己的服务发现机制或是自己的负载均衡机制时）我们确实也会想越过虚拟 IP ，直接获取背后 Pod 的 IP 地址。这时候我们可以将 Service 的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.clusterIP</span></span></code></span> 字段指定为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>None</span></span></code></span> ，这样 K8s 就不会给这个 Service 分配一个 Cluster IP 。这样的 Service 被称为 <strong>Headless Service</strong> 。</p>
<p>Headless Service 资源会创建一组 A 记录直接指向背后的 Pod ，可以通过 DNS 轮询等方式直接获得其中一个 Pod 的 IP 地址。另外更重要的一点， Headless Service 还会创建一组 SRV 记录，包含了指向各个 Pod 的 DNS 记录，可以通过 SRV 记录来发现所有 Pod 。</p>
<p>我们可以在集群里用 nsloopup 或 dig 命令去验证一下：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 在集群的 Pod 内部运行</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> nslookup</span><span style="color:#98C379"> kafka-headless.kafka.svc.cluster.local</span></span>
<span data-line=""><span style="color:#B57EDC">Server:</span><span style="color:#56B6C2">     10.96.0.10</span></span>
<span data-line=""><span style="color:#B57EDC">Address:</span><span style="color:#98C379">    10.96.0.10#53</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B57EDC">Name:</span><span style="color:#98C379">   kafka-headless.kafka.svc.cluster.local</span></span>
<span data-line=""><span style="color:#B57EDC">Address:</span><span style="color:#56B6C2"> 172.17.0.6</span></span>
<span data-line=""><span style="color:#B57EDC">Name:</span><span style="color:#98C379">   kafka-headless.kafka.svc.cluster.local</span></span>
<span data-line=""><span style="color:#B57EDC">Address:</span><span style="color:#56B6C2"> 172.17.0.5</span></span>
<span data-line=""><span style="color:#B57EDC">Name:</span><span style="color:#98C379">   kafka-headless.kafka.svc.cluster.local</span></span>
<span data-line=""><span style="color:#B57EDC">Address:</span><span style="color:#56B6C2"> 172.17.0.4</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> dig</span><span style="color:#98C379"> SRV</span><span style="color:#98C379"> kafka-headless.kafka.svc.cluster.local</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># .....</span></span>
<span data-line=""><span style="color:#A9B2C3">;; </span><span style="color:#B57EDC">ANSWER</span><span style="color:#98C379"> SECTION:</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2">      30</span><span style="color:#98C379">      IN</span><span style="color:#98C379">      SRV</span><span style="color:#56B6C2">     0</span><span style="color:#56B6C2"> 20</span><span style="color:#56B6C2"> 9092</span><span style="color:#98C379"> kafka-0.kafka-headless.kafka.svc.cluster.local.</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2">      30</span><span style="color:#98C379">      IN</span><span style="color:#98C379">      SRV</span><span style="color:#56B6C2">     0</span><span style="color:#56B6C2"> 20</span><span style="color:#56B6C2"> 9092</span><span style="color:#98C379"> kafka-1.kafka-headless.kafka.svc.cluster.local.</span></span>
<span data-line=""><span style="color:#B57EDC">kakfa-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2">      30</span><span style="color:#98C379">      IN</span><span style="color:#98C379">      SRV</span><span style="color:#56B6C2">     0</span><span style="color:#56B6C2"> 20</span><span style="color:#56B6C2"> 9092</span><span style="color:#98C379"> kafka-2.kafka-headless.kafka.svc.cluster.local.</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#A9B2C3">;; </span><span style="color:#B57EDC">ADDITIONAL</span><span style="color:#98C379"> SECTION:</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-0.kafka-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2"> 30</span><span style="color:#98C379"> IN</span><span style="color:#98C379"> A</span><span style="color:#56B6C2">  172.17.0.6</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-1.kafka-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2"> 30</span><span style="color:#98C379"> IN</span><span style="color:#98C379"> A</span><span style="color:#56B6C2">  172.17.0.5</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-2.kafka-headless.kafka.svc.cluster.local.</span><span style="color:#56B6C2"> 30</span><span style="color:#98C379"> IN</span><span style="color:#98C379"> A</span><span style="color:#56B6C2">  172.17.0.4</span></span></code></pre></figure>
<blockquote>
<p>拥有 Cluster IP 的 Service 其实也有 SRV 记录。但这种情况的 SRV 记录中对应的 Target 仍为 Service 自己的 FQDN 。</p>
</blockquote>
<h3 id="第三次回到-stateful-set"><a href="#第三次回到-stateful-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>第三次回到 Stateful Set</h3>
<p>在上面 Headless Service 的例子中，我们看到，各个 Pod 对应的 DNS A 记录格式为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>&lt;pod_name&gt;.&lt;svc_name&gt;.&lt;namespace&gt;.svc.cluster.local</span></span></code></span> 。不对啊，之前的小知识里不是说过 Pod 被分配的 DNS A 记录格式应该是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>172-17-0-3.default.pod.cluster.local</span></span></code></span> 的吗？</p>
<p>其实 Headless Service 还有一个众所周知的隐藏功能。 Pod 这种资源本身的参数中有 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>subdomain</span></span></code></span> 字段和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>hostname</span></span></code></span> 字段，如果设置了这两个字段，这个 Pod 就拥有了形如 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>&lt;hostname&gt;.&lt;subdomain&gt;.&lt;namespace&gt;.svc.cluster.local</span></span></code></span> 的 FQDN （全限定域名）。如果这时刚好在同一名称空间下有与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>subdomain</span></span></code></span> 同名的 Headless Service ， DNS 就会用为这个 Pod 用它的 FQDN 来创建一条 DNS A 记录。</p>
<p>比如 Pod1 在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka</span></span></code></span> 名称空间中， <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>hostname</span></span></code></span> 为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-1</span></span></code></span> ， <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>subdomain</span></span></code></span> 为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-headless</span></span></code></span> ，那么 Pod1 的 FQDN 就是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-1.kafka-headless.kakfa.svc.cluster.local</span></span></code></span> 。而同样在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka</span></span></code></span> 名称空间中，刚好又有一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-headless</span></span></code></span> 的 Headless Service ，那么 DNS 就会创建一条 A 记录，就可以通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-1.kafka-headless.kafka.svc.cluster.local</span></span></code></span> 来访问 Pod1 了。当然，由于 DNS 展开，也可以用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-1.kafka-headless.kafka</span></span></code></span> 甚至是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-1.kafka-headless</span></span></code></span> 来访问这个 Pod 。</p>
<p>其实这些 Pod 是用 Stateful Set 来部署的，这一部分其实是 Stateful Set 相关的功能。之前我们说到 Stateful Set 有唯一稳定的网络标识。我们现在就来详细讲讲，这“唯一稳定的网络标识”到底是在指什么。</p>
<p>我们来看一下这个 kafka Stateful Set 到底是怎么部署的：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Service</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-headless</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  clusterIP</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">None</span><span style="color:#5F6672;font-style:italic"> # 这是一个 headless service</span></span>
<span data-line=""><span style="color:#E5C07B">  ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">tcp-client</span></span>
<span data-line=""><span style="color:#E5C07B">    port</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">9092</span></span>
<span data-line=""><span style="color:#E5C07B">    protocol</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">TCP</span></span>
<span data-line=""><span style="color:#E5C07B">    targetPort</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-client</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    select-label</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-label</span></span>
<span data-line=""><span style="color:#E5C07B">  type</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ClusterIP</span></span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">StatefulSet</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">3</span></span>
<span data-line=""><span style="color:#E5C07B">  serviceName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-headless</span><span style="color:#5F6672;font-style:italic"> # 注意到这里有 serviceName 字段</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      select-label</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-label</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        select-label</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-label</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">docker.io/bitnami/kafka:3.1.0-debian-10-r52</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 接下来 Pod 相关部分省略</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 下面 Volume 相关部分也省略</span></span></code></pre></figure>
<p>我们看到， Stateful Set 的定义中必须要用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.serviceName</span></span></code></span> 字段指定一个 Headless Service 。 Stateful Set 创建 Pod 时，会自动给 Pod 指定 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>hostname</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>subdomain</span></span></code></span> 字段。这样一来，每个 Pod 才有了唯一固定的 hostname ，唯一固定的 FQDN ，以及通过与 Headless Service 共同部署而获得唯一固定的 A 记录。（此外，其实当 Pod 因为版本升级等原因被重新创建时，相同序号的 Pod 还会被分配到相同固定的集群内 IP 。）</p>
<blockquote>
<p><strong>关于 Stateful Set 中 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>serviceName</span></span></code></span> 字段的争议</strong></p>
<p>Stateful Set 中的 serviceName 字段是必填字段。这个字段唯一的作用其实就是给 Pod 指定 subdomain 。其实这样会有一些问题：</p>
<ol>
<li>Stateful Set 部署时不会检查是否真的存在这么一个 Headless Service 。如果 serviceName 乱填一个值，会导致虽然 Pod 的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>hostname</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>subdomain</span></span></code></span> 都指定了却没有创建 A 记录的情况。</li>
<li>有时 Stateful Set 的 Pod 不需要接收流量，也不需要相互发现，这时候还强行需要指定一个 serviceName 显得有点多余。</li>
</ol>
<p>在 GitHub 上有关于这个问题的 Issue ： <a href="https://github.com/kubernetes/kubernetes/issues/69608">https://github.com/kubernetes/kubernetes/issues/69608</a></p>
</blockquote>
<h3 id="从集群外部访问"><a href="#从集群外部访问" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>从集群外部访问</h3>
<p>在 K8s 集群里把应用部署好了，可是如何让集群外部的客户端访问我们集群中的应用呢？这可能是大家最关心的问题。</p>
<p>不过有认真听的同学估计已经有这个问题的答案了。之前我们讲过 NodePort 和 LoadBalancer 这两种 Service 类型。</p>
<p>其中 NodePort Service 只是简单地在节点机器上各开一个端口，而如何路由、如何负载均衡等则一概不管。</p>
<p>而 LoadBalancer Service 则是在 NodePort 的基础上再加一个一个负载均衡器，然后把节点暴露的端口注册到这个负载均衡器上。这样一来，集群外部的客户端就可以通过同一个 IP 来访问集群中的应用。但是要使用 LoadBalancer Service ，一般需要先安装云供应商提供的 Controller ，或是安装其他第三方的 Controller （比如 Nginx Controller ）。</p>
<p>在 Service 之外还另有一种资源类型叫 Ingress ，也可以用来实现集群外部访问集群内部应用的功能。 Ingress 其实也会在集群外创建一个负载均衡器，因此也需要预先安装云供应商的 Controller 。但 Ingress 与 Service 不同的是，它还会管理一定的路由逻辑，接收流量后可以根据路由来分配给不同的 Service 。</p>
<table><thead><tr><th style="text-align:left">类型</th><th style="text-align:left">OSI 模型工作层数</th><th style="text-align:left">依赖于云平台或其他插件</th></tr></thead><tbody><tr><td style="text-align:left">NodePort Service</td><td style="text-align:left">第四层</td><td style="text-align:left">否</td></tr><tr><td style="text-align:left">LoadBalancer Service</td><td style="text-align:left">第四层</td><td style="text-align:left">是</td></tr><tr><td style="text-align:left">Ingress</td><td style="text-align:left">第七层</td><td style="text-align:left">是</td></tr></tbody></table>
<p>特别再详细说一下 Ingress 这种资源。 Ingress 本身不会在集群内的 DNS 上创建记录，一般也不会主动去路由集群内的流量（除非你在集群内强行访问 Ingress 的负载均衡器…… 不过一般也没什么理由要这样做对吧）。但 Ingress 可以根据 HTTP 的 hostname 和 path 来路由流量，把流量分发到不同的 Service 上。 Ingress 也是 K8s 的原生资源里唯一能看到 OSI 第七层的资源。</p>
<p>下面是 AWS 的 EKS 服务中部署的一个 Ingress 的例子（集群中已安装 AWS Load Balancer Controller ）：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">networking.k8s.io/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Ingress</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  annotations</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    kubernetes.io/ingress.class</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">alb</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/scheme</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">internet-facing</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/target-type</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ip</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/backend-protocol-version</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">GRPC</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/listen-ports</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&#x27;</span><span style="color:#98C379">[{&quot;HTTPS&quot;:443}]</span><span style="color:#A9B2C3">&#x27;</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/healthcheck-path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/grpc.health.v1.Health/Check</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/healthcheck-protocol</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">HTTP</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/success-codes</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">0,12</span></span>
<span data-line=""><span style="color:#E5C07B">    alb.ingress.kubernetes.io/certificate-arn</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">arn:aws:acm:xxxxxxxxxx:certificate/xxxxxxxxxx</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#E5C07B">    external-dns.alpha.kubernetes.io/hostname</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">sample.example.com</span></span>
<span data-line=""><span style="color:#A9B2C3">  </span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-ingress</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  rules</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">host</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">sample.example.com</span></span>
<span data-line=""><span style="color:#E5C07B">    http</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      paths</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/grpc.health.v1.Health</span></span>
<span data-line=""><span style="color:#E5C07B">        pathType</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Prefix</span></span>
<span data-line=""><span style="color:#E5C07B">        backend</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          service</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">health-service</span></span>
<span data-line=""><span style="color:#E5C07B">            port</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">              number</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">50051</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/proto.sample.v1.Sample</span></span>
<span data-line=""><span style="color:#E5C07B">        pathType</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Prefix</span></span>
<span data-line=""><span style="color:#E5C07B">        backend</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          service</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">sample-service</span></span>
<span data-line=""><span style="color:#E5C07B">            port</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">              number</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">50051</span></span></code></pre></figure>
<p>可以看到， Ingress 资源可以通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.rules</span></span></code></span> 字段中定义各条规则，通过 hostname 或是 path 等第七层的信息来进行路由。 Ingress 部署下去后， AWS Load Balancer Controller 会读取会根据的配置，并在云上创建一个 AWS Application Load Balancer （ALB），而 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.rules</span></span></code></span> 会应用到 ALB 上，由 ALB 来负责流量的路由。</p>
<p>我们也会注意到，怎么 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>metadata.annotations</span></span></code></span> 里有这么多奇奇怪怪的字段！ Ingress 本身的功能都是 AWS Load Balancer Controller 调用 AWS 的 API 创建 ALB 来实现的。但 AWS 的 ALB 能实现的功能可不止 Ingress 字段定义的这些，比如安装 TLS 证书、 health check 等 spec 字段中描述不下的功能，就只能是通过 annotation 的形式来定义了。</p>
<blockquote>
<p>小彩蛋：可以看到例子中的 Ingress 资源 annotation 字段里还有一行 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>external-dns.alpha.kubernetes.io/hostname: sample.example.com</span></span></code></span> 。其实这个 K8s 集群中还安装了 external-dns 这个应用，它可以根据 annotation 来在外部 DNS 上直接创建 DNS 记录！有了这个插件我们可不用再慢慢打开公共 DNS 管理页面，再小心翼翼地记下 IP 地址去添加 A 记录了。</p>
</blockquote>
<h1 id="更高级的部署方式一"><a href="#更高级的部署方式一" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>更高级的部署方式（一）</h1>
<p>一路说道这里， K8s 中最基础的资源大部分都已经介绍了。但是，这么多资源之间又需要相互配合，只部署一种资源基本没什么生产能力。</p>
<p>比如只部署 Deployment 的话，我们确实是能在一组多副本的 Pod 里跑起可执行程序，但这组 Pod 却几乎没办法接受集群里其他 Pod 的流量（只能通过制定 Pod 的 IP 来访问，但 Pod 的 IP 是会变的）。因此一般来说一个 Deployment 都会搭配一个 Service 来使用。这还是最简单的一种搭配了。</p>
<p>假若我们现在要在自己的 K8s 里安装一个别人提供的应用。当然由于 K8s 是基于容器的，只要别人提供了他应用的 yaml 清单，我们只用把清单用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply -f</span></span></code></span> 提交给 K8s ，然后让 K8s 把清单中的镜像拉下来就能跑了。可如果我们需要根据环境来改一些参数呢？</p>
<p>如果别人提供的 yaml 文件比较简单还好说，改改对应的字段就好了。如果别人的应用比较复杂，那改 yaml 文件可就是一个大难题了。比如 AWS 的 Load Balancer Controller ，它的 yaml 清单文件可是多达 939 行！</p>
<p><a href="/blog-next/content/articles/2022-08-31-introduction-for-k8s-4/aws-elb-controller-lines.png">aws-elb-controller-lines.png</a></p>
<p>在这种复杂的场景下，我们就需要一些更高级的部署方式了。</p>
<h3 id="helm"><a href="#helm" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Helm</h3>
<p>首先来介绍的是 Helm 。 Helm 是一个包管理工具，可以类比一下 CentOS 中的 yum 工具。它可以把一组 K8s 资源发布成一个 Chart ，然后我们可以用 Helm 来安装这个 Chart ，并且可以通过参数设值来改变 Chart 中的部分资源。利用 Helm 安装 Chart 后还可以管理 Chart 的升级、回滚、卸载。</p>
<p>使用别人提供的 Helm Chart 前，需要先 add 一下 Chart 的仓库，然后再安装仓库里提供的 Chart 。比如我们要安装 bitnami 提供的 Kafka Chart 时：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="plastic"><code data-language="bash" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 添加 https://charts.bitnami.com/bitnami 这个仓库，命名为 bitnami</span></span>
<span data-line=""><span style="color:#B57EDC">helm</span><span style="color:#98C379"> repo</span><span style="color:#98C379"> add</span><span style="color:#98C379"> bitnami</span><span style="color:#98C379"> https://charts.bitnami.com/bitnami</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 在 kafka 名称空间里安装 bitnami 仓库里的 kafka Chart ，并通过参数设置为 3 个副本，并同时安装一个 3 副本的 Zookeeper</span></span>
<span data-line=""><span style="color:#B57EDC">helm</span><span style="color:#98C379"> install</span><span style="color:#98C379"> kafka</span><span style="color:#56B6C2"> -n</span><span style="color:#98C379"> kafka</span><span style="color:#56B6C2"> \</span></span>
<span data-line=""><span style="color:#56B6C2">  --set</span><span style="color:#98C379"> replicaCount=</span><span style="color:#56B6C2">3</span><span style="color:#56B6C2"> \</span></span>
<span data-line=""><span style="color:#56B6C2">  --set</span><span style="color:#98C379"> zookeeper.enabled=</span><span style="color:#56B6C2">true</span><span style="color:#56B6C2"> \</span></span>
<span data-line=""><span style="color:#56B6C2">  --set</span><span style="color:#98C379"> zookeeper.replicaCount=</span><span style="color:#56B6C2">3</span><span style="color:#56B6C2"> \</span></span>
<span data-line=""><span style="color:#98C379">  bitnami/kafka</span></span></code></pre></figure>
<p>命令执行后， helm 就会根据参数与 Chart 的内容，在 K8s 里安装 StatefulSet 、 Service 、 ConfigMap 等一切所需要的资源。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> k</span><span style="color:#56B6C2"> -n</span><span style="color:#98C379"> kafka</span><span style="color:#98C379"> get</span><span style="color:#98C379"> all,cm</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                    READY</span><span style="color:#98C379">   STATUS</span><span style="color:#98C379">    RESTARTS</span><span style="color:#98C379">      AGE</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-0</span><span style="color:#98C379">             1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   1</span><span style="color:#98C379">             46d</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-1</span><span style="color:#98C379">             1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   3</span><span style="color:#98C379">             46d</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-2</span><span style="color:#98C379">             1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   3</span><span style="color:#98C379">             46d</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-zookeeper-0</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">             46d</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-zookeeper-1</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">             46d</span></span>
<span data-line=""><span style="color:#B57EDC">pod/kafka-zookeeper-2</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">             46d</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                               TYPE</span><span style="color:#98C379">           CLUSTER-IP</span><span style="color:#98C379">       EXTERNAL-IP</span><span style="color:#98C379">      PORT</span><span style="color:#A9B2C3">(</span><span style="color:#B57EDC">S</span><span style="color:#A9B2C3">)                      </span><span style="color:#98C379">AGE</span></span>
<span data-line=""><span style="color:#B57EDC">service/kafka</span><span style="color:#98C379">                      ClusterIP</span><span style="color:#56B6C2">      172.20.1.196</span><span style="color:#E06C75">     &lt;</span><span style="color:#98C379">non</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">           9092/TCP</span><span style="color:#98C379">                     164d</span></span>
<span data-line=""><span style="color:#B57EDC">service/kafka-headless</span><span style="color:#98C379">             ClusterIP</span><span style="color:#98C379">      None</span><span style="color:#E06C75">             &lt;</span><span style="color:#98C379">non</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">           9092/TCP,9093/TCP</span><span style="color:#98C379">            164d</span></span>
<span data-line=""><span style="color:#B57EDC">service/kafka-zookeeper</span><span style="color:#98C379">            ClusterIP</span><span style="color:#56B6C2">      172.20.227.236</span><span style="color:#E06C75">   &lt;</span><span style="color:#98C379">non</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">           2181/TCP,2888/TCP,3888/TCP</span><span style="color:#98C379">   164d</span></span>
<span data-line=""><span style="color:#B57EDC">service/kafka-zookeeper-headless</span><span style="color:#98C379">   ClusterIP</span><span style="color:#98C379">      None</span><span style="color:#E06C75">             &lt;</span><span style="color:#98C379">non</span><span style="color:#A9B2C3">e</span><span style="color:#E06C75">&gt;</span><span style="color:#98C379">           2181/TCP,2888/TCP,3888/TCP</span><span style="color:#98C379">   164d</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                               READY</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">statefulset.apps/kafka</span><span style="color:#98C379">             3/3</span><span style="color:#98C379">     164d</span></span>
<span data-line=""><span style="color:#B57EDC">statefulset.apps/kafka-zookeeper</span><span style="color:#98C379">   3/3</span><span style="color:#98C379">     164d</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                                DATA</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">configmap/kafka-scripts</span><span style="color:#56B6C2">             2</span><span style="color:#98C379">      164d</span></span>
<span data-line=""><span style="color:#B57EDC">configmap/kafka-zookeeper-scripts</span><span style="color:#56B6C2">   2</span><span style="color:#98C379">      164d</span></span>
<span data-line=""><span style="color:#B57EDC">configmap/kube-root-ca.crt</span><span style="color:#56B6C2">          1</span><span style="color:#98C379">      165d</span></span></code></pre></figure>
<p>甚至， Helm 可以通过模板生成的 Pod 环境变量，来预先设置好 Kafka 的配置，让他找得到 Zookeeper 服务：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 略去无关信息</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">    command</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#98C379">/scripts/setup.sh</span></span>
<span data-line=""><span style="color:#E5C07B">    env</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">KAFKA_CFG_ZOOKEEPER_CONNECT</span></span>
<span data-line=""><span style="color:#E5C07B">      value</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-zookeeper</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # ...</span></span></code></pre></figure>
<p>通过设置 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>KAFKA_CFG_ZOOKEEPER_CONNECT</span></span></code></span> 这个环境变量，指定了 Kafka Broker 可以通过访问 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-zookeeper</span></span></code></span> 来找到 zookeeper 服务。（还记得 zookeeper 的 Service 名字是 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka-zookeeper</span></span></code></span> 吗？ zookeeper 与 kafka 部署在同一个名称空间里，因此可以直接通过 Service 名访问。）</p>
<p>如果我们打开这个 helm chart 对应的<a href="https://github.com/bitnami/charts/tree/master/bitnami/kafka">代码仓库</a>，会发现原来有一组 go template 文件，以及一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>values.yaml</span></span></code></span> 文件和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>Chart.yaml</span></span></code></span> 文件：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">.</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> Chart.lock</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> Chart.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> README.md</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> templates</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> NOTES.txt</span><span style="color:#5F6672;font-style:italic"> # 这里定义的是 helm 工具的命令行信息</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> _helpers.tpl</span><span style="color:#5F6672;font-style:italic"> # 这里面是一些定义好的 go template 代码块可以供其他模板使用</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> configmap.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> statefulset.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> svc-headless.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   ├──</span><span style="color:#98C379"> svc.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">│</span><span style="color:#98C379">   └──</span><span style="color:#5F6672;font-style:italic"> # 以下省略若干模板文件</span></span>
<span data-line=""><span style="color:#B57EDC">└──</span><span style="color:#98C379"> values.yaml</span></span></code></pre></figure>
<ul>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>Chart.yaml</span></span></code></span> 中定义了这个 Chart 的基本信息，包括名称、版本、描述、依赖等。</li>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>values.yaml</span></span></code></span> 中定义了这个 Chart 的默认参数，包括各种资源的默认配置、副本数量、镜像版本等。其中的值都可以通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>helm install</span></span></code></span> 命令的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>--set</span></span></code></span> 参数来覆盖。</li>
<li><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>templates/</span></span></code></span> 文件夹下的都是 go template 的模板文件。</li>
</ul>
<p><span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>helm install</span></span></code></span> 就是通过用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>values.yaml</span></span></code></span> 中预定义的参数，渲染 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>templates/</span></span></code></span> 文件夹下的 go template 文件，生成最终的 yaml 文件，然后再通过 kubectl apply -f 的方式，将 yaml 文件里的资源部署到 K8s 里。然后通过忘资源里注入一些特殊 annotation 的方式来记住自己部署了那些资源，进而提供 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>update</span></span></code></span> 、 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>uninstall</span></span></code></span> 等功能。</p>
<p>关于更多 Helm 的内容，可以参考<a href="https://helm.sh/docs/">官方文档</a>。</p>
<h3 id="kustomize"><a href="#kustomize" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Kustomize</h3>
<p>另一个部署工具是 Kustomize 。之前提到 Config Map 时的例子中，将配置文件的内容直接写进了 yaml 清单的一个字段里：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ConfigMap</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span></span>
<span data-line=""><span style="color:#E5C07B">data</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 一个 Key 可以对应一个值</span></span>
<span data-line=""><span style="color:#E5C07B">  player_initial_lives</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">3</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  ui_properties_file_name</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">user-interface.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 一个 Key 也可以对应一个文件的内容</span></span>
<span data-line=""><span style="color:#E5C07B">  game.properties</span><span style="color:#A9B2C3">: </span><span style="color:#E06C75">|</span></span>
<span data-line=""><span style="color:#98C379">    enemy.types=aliens,monsters</span></span>
<span data-line=""><span style="color:#98C379">    player.maximum-lives=5    </span></span>
<span data-line=""><span style="color:#E5C07B">  user-interface.properties</span><span style="color:#A9B2C3">: </span><span style="color:#E06C75">|</span></span>
<span data-line=""><span style="color:#98C379">    color.good=purple</span></span>
<span data-line=""><span style="color:#98C379">    color.bad=yellow</span></span>
<span data-line=""><span style="color:#98C379">    allow.textmode=true    </span></span></code></pre></figure>
<p>其实这样很不好，先不说这样写没办法在 IDE 里用配置文件自己的语法检查，每行还需要一定的缩进，如果配置文件有好几百行，你甚至会忘了这一行到底是哪个配置文件！此时我们就会自然而然的想把每个配置文件以单独文件的形式保存。</p>
<p>Kustomize 就是这样一个工具，它可以帮助我们把每个配置文件以单独文件的形式保存，然后再通过一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 文件，将这些配置文件组合起来，生成最终的 yaml 文件。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kustomize.config.k8s.io/v1beta1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Kustomization</span></span>
<span data-line=""><span style="color:#E5C07B">resources</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">  # 其他资源也可以单独使用一个文件定义</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#98C379">deployment.yaml</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 用 configMapGenerator 从文件中生成 ConfigMap</span></span>
<span data-line=""><span style="color:#E5C07B">configMapGenerator</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">game-demo</span></span>
<span data-line=""><span style="color:#E5C07B">    literals</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">ui_properties_file_name=user-interface.properties</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">player_initial_lives=3</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 从文件中读取内容</span></span>
<span data-line=""><span style="color:#E5C07B">    files</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#98C379">game.properties</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#98C379">user-interface.properties</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># 有多个 configMap 时，可以通过统一的 generatorOptions 来设置一些通用的选项</span></span>
<span data-line=""><span style="color:#E5C07B">generatorOptions</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  disableNameSuffixHash</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span></code></pre></figure>
<p>然后两个配置文件的内容可以单独用文件定义，此时可以结合 IDE 的语法检查，以及代码补全功能，来编写配置文件。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="properties" data-theme="plastic"><code data-language="properties" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># user-interface.properties</span></span>
<span data-line=""><span style="color:#E06C75">color.good</span><span style="color:#A9B2C3">=purple</span></span>
<span data-line=""><span style="color:#E06C75">color.bad</span><span style="color:#A9B2C3">=yellow</span></span>
<span data-line=""><span style="color:#E06C75">allow.textmode</span><span style="color:#A9B2C3">=true    </span></span></code></pre></figure>
<p>然后将 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 和其他所需的文件都放在同一个目录下：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="plastic"><code data-language="bash" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">.</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> kustomization.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> deployment.yaml</span></span>
<span data-line=""><span style="color:#B57EDC">├──</span><span style="color:#98C379"> game.properties</span></span>
<span data-line=""><span style="color:#B57EDC">└──</span><span style="color:#98C379"> user-interface.properties</span></span></code></pre></figure>
<p>然后就可以通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply -k ./</span></span></code></span> 来将整个 kustomize 文件夹转换为 yaml 清单直接部署到 K8s 中。
（没错，现在 Kustomize 已经成为 kubectl 中的内置功能！可以不用先 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomize build</span></span></code></span> 生成 yaml 文件再 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 两步走了！）</p>
<p>值得提醒的是，虽然 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 有 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>apiVersion</span></span></code></span> 和 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kind</span></span></code></span> 字段，长得很像一个资源清单，但其实 K8s 的 API server 并不认识他。 Kustomize 的工作原理其实是先根据 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 生成 K8s 认识的 yaml 资源清单，然后再通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 来部署。</p>
<p>除了可以直接将 ConfigMap 与 Secret 中的文件字段内容用单独的文件定义外， Kustomize 还有其他比如为部署的资源添加统一的名称前缀、添加统一字段等功能。这些大家可以阅读 Kustomize 的<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/">官方文档</a>来了解。</p>
<h3 id="各种工具的优缺点"><a href="#各种工具的优缺点" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>各种工具的优缺点</h3>
<p>我们目前已经知道有三种在 K8s 中部署资源的方式： <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span>、Helm 和 Kustomize 。</p>
<p>其中 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 的优缺点很明确，优点是最简单直接，缺点是会导致要么 yaml 清单过长，要么需要分多文件多次部署，使集群中产生中间状态。</p>
<p>而 Helm 与 Kustomize 我们上面也分析过，其实都是基于 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 的。 Helm 是通过 go template 先生成 yaml 文件再 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> ，而 Kustomize 是通过 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 中的定义用自己的一套逻辑生成 yaml 文件，然后再 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 。</p>
<p>Helm 的优点是 Helm Chart 安装时可以直接使用别人 Helm 仓库中已经上传好的 Chart ，只需要设置参数就可以使用。这也是 Kustomize 的缺点：如果想要使用别人提供的 Kustomization 而只修改其中的一些配置，必须要先把放 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kustomization.yaml</span></span></code></span> 的整个文件夹下载下来才能做修改。</p>
<p>而 Helm 的缺点也是明显的， Helm 依赖于往资源里注入特殊的 annotation 来管理 Chart 生成的资源，这可能会很难与集群中现有的一些系统（比如 Service Mesh 或是 GitOps 系统等）放一起管理。而 Kustomize 生成的 yaml 清单就是很干净的 K8s 资源，原先的 K8s 资源该是什么表现就是什么表现，与现有的系统兼容一般会比较好。</p>
<p>而另外，由于 Helm 与 Kustomize 都是基于 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 的，因此他们有共同的缺点，就是不能做 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 不能做的事情。</p>
<p>什么叫 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 不能做的事情呢？比如说我们要在 K8s 中部署 Redis 集群。聪明的你可能就想到要用 Stateful Set 、 PVC 、 Headless Service 来一套组合拳。这确实可以部署一个多节点、有状态的 Redis Cluster 。可是如果我们要往 Redis Cluster 里加一个节点呢？</p>
<p>你当然可以把 Stateful Set 中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>Replicas</span></span></code></span> 字段加个 1 然后用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 部署，可是这实际上只能增加一个一个 Redis 实例 —— 然后什么都没发生。其他节点不认识这个新的节点，访问这个新节点也不能拿到正确的数据。要知道往 Redis Cluster 里加节点，是要先让集群发现这个新节点，然后还要迁移 slot 的！ <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 可不会做这些事。</p>
<blockquote>
<p>Well, 其实这些也是可以通过增加 initContainer 、修改镜像增加启动脚本等方式，实现用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 部署的。可是，这会让整个 Pod 资源变得很难理解，也不好维护。而且，如果不是因为做不到，谁会想去修改别人的镜像呢？</p>
</blockquote>
<p>我们接下来会介绍 K8s 的核心架构，来理解我们之前讲的这些资源到底是怎么工作的。最后会引出一组新的概念： Operator 与自定义资源（ Custom Resource Definition ，简称 CRD ）。通过 Operator 与 CRD ，我们可以做到 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 所不能做到的事，包括 Redis Cluster 的扩容。</p>
<blockquote>
<p>DIO: <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 的能力是有限的……
越是部署复杂的应用，就越会发现 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 的能力是有极限的……除非超越 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 。</p>
<p>JOJO: 你到底想说什么？</p>
<p>DIO: 我不用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply</span></span></code></span> 了！ JOJO ！
（其实还是要用的）</p>
</blockquote></div><div class="w-96 text-gray-700 leading-none"><span class="!text-sm"><a class="!inline-block !p-0 !m-0 align-text-bottom" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" loading="lazy" width="88" height="31" decoding="async" data-nimg="1" class="!m-0 h-4 w-auto pr-1" style="color:transparent;border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/></a>This work is licensed under a<!-- --> <a class="underline" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</span></div><div class="TagsBox_tagsBox__WzhAf mt-4"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/kubernetes">#<!-- -->Kubernetes</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/devops">#<!-- -->DevOps</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/docker">#<!-- -->Docker</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/cloud-native">#<!-- -->Cloud Native</a></div><div class="mt-4 mb-4 flex justify-center"><div class="ml-0 mr-auto"><a href="/blog-next/articles/try-cursor-and-thinking">&lt;- 尝试 Cursor 的感想和一些思考</a></div><div class="mr-0 ml-auto"><a href="/blog-next/articles/introduction-for-k8s">Kubernetes 入门 （1） -&gt;</a></div></div><hr class="mt-4"/></article><div><h5 class="text-2xl font-bold pt-4">反向引用</h5><div class="flex-1 p-2 rounded-md hover:bg-bg-focus"><a class="flex items-center" href="/blog-next/ideas/blog-syntax"><div class="text-lg flex-grow h-fit overflow-ellipsis">博客语法渲染测试</div><div class="TagsBox_tagsBox__WzhAf py-4 md:py-1 flex-none"><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->Tag1</span><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->Tag2</span><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->单行Tag</span></div></a></div><hr class="mt-4"/></div><div class="w-full"><div></div><div class="text-center">Loading comments...</div></div></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"><div class="inset-0 w-full h-full flex items-center justify-center bg-transparent"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div></div><footer class="DefaultLayout_footer__aWV4u"><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="flex flex-row justify-center items-center"><div class="DefaultLayout_footerLeft__Qn_VV">© 2023 Ryo Jerry Yu. All rights reserved.</div><div class="DefaultLayout_footerRight__GlReP"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"introduction-for-k8s-2","tags":[{"tag":"Kubernetes","slug":"kubernetes","path":"/tags/kubernetes","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"DevOps","slug":"devops","path":"/tags/devops","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Docker","slug":"docker","path":"/tags/docker","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Cloud Native","slug":"cloud-native","path":"/tags/cloud-native","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]}],"source":{"compiledSource":"\"use strict\";\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = {\n    a: \"a\",\n    blockquote: \"blockquote\",\n    code: \"code\",\n    figure: \"figure\",\n    h1: \"h1\",\n    h3: \"h3\",\n    img: \"img\",\n    li: \"li\",\n    ol: \"ol\",\n    p: \"p\",\n    pre: \"pre\",\n    span: \"span\",\n    strong: \"strong\",\n    table: \"table\",\n    tbody: \"tbody\",\n    td: \"td\",\n    th: \"th\",\n    thead: \"thead\",\n    tr: \"tr\",\n    ul: \"ul\",\n    ..._provideComponents(),\n    ...props.components\n  }, {CodeBlockMermaid} = _components;\n  if (!CodeBlockMermaid) _missingMdxReference(\"CodeBlockMermaid\", true);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.p, {\n      children: \"我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。\"\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"储存\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#储存\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"储存\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"CSI: Container Storage Interface ，容器储存接口标准，是 K8s 提出的一种规范。不管是哪种储存引擎，只要编写一个对应的插件实现 CSI ，都可以在 K8s 中使用。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"k8s-中使用-volume-与可用的-volume-类型\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#k8s-中使用-volume-与可用的-volume-类型\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"K8s 中使用 Volume 与可用的 Volume 类型\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其实 K8s 中使用 Volume 的例子我们一开始就已经接触过了。还记得一开始介绍 Pod 时的 Nginx 例子吗？\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"simple-webapp\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"main-application\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/log/nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sidecar-container\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"busybox\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sh\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"while true; do cat /var/log/nginx/access.log; sleep 30; done\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/log/nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      emptyDir\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": {}\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这个 Pod 描述中声明了一个种类为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"emptyDir\"\n            })\n          })\n        })\n      }), \" 的，名为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"shared-logs\"\n            })\n          })\n        })\n      }), \" 的 Volume ，然后 Pod 中的两个容器都分别 Mount 了这个 Volume 。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"K8s 中默认提供了几种 Volume ，比如：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"emptyDir ：一个简单的空目录，一般用于储存临时数据或是 Pod 的容器之间共享数据。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"hostPath ：绑定到节点宿主机文件系统上的路径，一般在 Daemon Set 中使用。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"gitRepo ：这种 Volume 其实相当于 emptyDir ，不过在 Pod 启动时会从 Git 仓库 clone 一份内容作为默认数据。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"configMap 、 secret ：一般用于配置文件加载，需要与 configMap 、 secret 这两种资源一同使用。会将 configMap 、 secret 中对应的内容拷贝一份作为 Volume 绑到容器。（下一节中会展开讨论）\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"nfs 、 glusterfs 、 ……：可以通过各种网络存储协议直接挂载一个网络存储\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"(deprecated!) gcePersistentDisk 、 awsElasticBlockStore ……：可以调用各个云平台的 API ，创建一个块储存硬件挂载到宿主机上，再将那个硬件挂载到容器中。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"persistentVolumeClaim ：持久卷声明，用于把实际储存方式抽象化，使得 Pod 不需要关心具体的储存类型。这种类型会在下面详细介绍。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们可以注意到， Volume 的声明是 Pod 的一个属性，而不是一种单独的资源。 Volume 是 Pod 的一部分，因此不同的 Pod 之间永远不可能共享同一个 Volume 。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"但是 Volume 所指向的位置可以相同，比如 HostPath 类型的 Volume 就可以两个 Pod 可以绑定到宿主机上同一个路径，因此 Volume 里的数据还是能通过一定方式在 Pod 间共享。但当然 K8s 不推荐这么做。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"另外，由于 Volume 是 Pod 的一部分， Volume 的生命周期也是跟随 Pod 的，当一个 Pod 被销毁时， Volume 也会被销毁，因此最主要还是用于 Pod 内容器间的文件共享。如果需要持久化储存，需要使用 Persistent Volume 。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"Volume 会被销毁不代表 Volume 指向的内容会被销毁。比如 hostPath 、 NFS 等类型 Volume 中的内容就会继续保留在宿主机或是 NAS 上。下面提到的 Presistent Volume Claim 也是，拥有 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"persistentVolumeClaim\"\n              })\n            })\n          })\n        }), \" 类型 Volume 的 Pod 被删除后对应的 PVC 不一定会被删除。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"presistent-volume--presistent-volume-claim--storage-class\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#presistent-volume--presistent-volume-claim--storage-class\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Presistent Volume 、 Presistent Volume Claim 、 Storage Class\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果需要在 Pod 声明中直接指定 NFS 、 awsElasticBlockStore 之类的信息，就需要应用的开发人员对真实可用的储存结构有所理解，违背了 K8s 的理念。因此 K8s 就弄出了小标题中的三种资源来将储存抽象化。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"一个 Persistent Volume (PV) 对应云平台提供的一个块存储，或是 NAS 上的一个路径。可以简单地理解为 \", _jsx(_components.strong, {\n        children: \"PV 直接描述了一块可用的物理存储\"\n      }), \" 。因为 PV 直接对应到硬件，因此 PV 跟节点一样，是名称空间无关的。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"而一个 \", _jsx(_components.strong, {\n        children: \"Persistent Volume Claim (PVC) 则是描述了怎样去使用储存\"\n      }), \" ：使用多少空间、只读还是读写等。一个 PVC 被创建后会且只会对应到一个 PV 。 PVC 从属于一个名称空间，并能被该名称空间下的 Pod 指定为一个 Volume 。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"PV 与 PVC 这两种抽象是很必要的。试想一下用自己的物理机搭建一个 K8s 集群的场景。你会提前给物理机插上许多个储存硬件，这时你就需要用 PV 来描述这些硬件，之后才能在 K8s 里利用这些硬件的储存。而实际将应用部署到 K8s 中时，你才需要用 PVC 来描述 Pod 中需要怎么样的储存卷，然后 K8s 就会自动挑一个合适 PV 给这个 PVC 绑定上。这样实际部署应用的时候就不用再特意跑去机房给物理机插硬件了。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"但是现在都云原生时代了，各供应商都有提供 API 可以直接创建一个块储存，还要想办法提前准备 PV 实在是太蠢了。于是便需要 Storage Class 这种资源。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"使用 Storage Class 前需要先安装各种云供应商提供的插件（当然使用云服务提供的 K8s 的话一般已经准备好了），然后再创建一个 Storage Class 类型的资源（当然一般也已经准备好了）。下面是 AWS 上的 EKS 服务中默认自带的 Storage Class ：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"storage.k8s.io/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"StorageClass\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  annotations\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    storageclass.kubernetes.io/is-default-class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"true\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gp2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"provisioner\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kubernetes.io/aws-ebs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"parameters\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  fsType\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ext4\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gp2\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 当 PVC 被删除时会同时删除 PV\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"reclaimPolicy\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Delete\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 只有当 PVC 被绑定为一个 Pod 的 Volume 时才会创建一个 PV\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"volumeBindingMode\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"WaitForFirstConsumer\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以看到 EKS 自带的 gp2 提供了一些默认的选项，我们也可以类似地去定义自己的 Storage Class 。有了 gp2 这个 Storage Class ，我们创建一个 PVC 后 K8s 就会调用 AWS 的 API ，创建一个块储存接到我们的节点上，然后 K8s 再自动创建一个 PV 并绑定到 PVC 上。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"例如，我们部署 Kafka 时会创建一个这样的 PVC ：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"PersistentVolumeClaim\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"data-kafka-0\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  accessModes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReadWriteOnce\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  resources\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    requests\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      storage\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"10Gi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  storageClassName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gp2\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"K8s 就会自动为我们创建出一个对应的 PV ：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# `pvc-` 开头这个是 AWS 自动给我们起的名字。它虽然是 `pvc-` 开头，但他其实是一个 PV 。\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                                       CAPACITY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ACCESS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" MODES\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   RECLAIM\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" POLICY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   CLAIM\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                STORAGECLASS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   REASON\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pvc-3614c15f-5697-4d66-a13c-6ddf7eb89998\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   10Gi\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       RWO\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"            Delete\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           Bound\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    kafka/data-kafka-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   gp2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                     152d\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"要是打开 AWS Console 还会发现， K8s 调用了 AWS 的 API ，自动为我们创建了一个 EBS 块储存并绑定到了我们对应的宿主机上。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以用下面这张图来表示 Pod 中的 Volume 、 PVC 、 PV 之间的关系：\"\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"flowchart TD\\n\\nsubgraph Pod[Pod: Kafka-0]\\nsubgraph Container[Container: docker.io/bitnami/kafka:3.1.0]\\nvm[VolumeMount: /bitnami/kafka]\\nend\\nvolume[(Volume: data)]\\nvm --\u003e volume\\nend\\n\\npvc[pvc: data-kafka-0]\\npv[pv: pvc-3614c15f-5697-4d66-a13c-6ddf7eb89998]\\nebs[ebs: AWS 为我们创建的块储存硬件]\\n\\nvolume --\u003e pvc\\npvc --\u003e pv\\npv --\u003e ebs\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而 Storage Class 在上图中则负责读取我们提交的 PVC ，然后创建 PV 与 EBS 。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"再说回-stateful-set\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#再说回-stateful-set\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"再说回 Stateful Set\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"之前我们提到 Stateful Set 时说到 Stateful Set 创建的 Pod 拥有固定的储存，到底是什么意思呢？跟 Deployment 的储存又有什么区别呢？\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们先来看看，如果要给 Deployment 创建出来的 Pod 挂载 PVC 需要怎么做。下面是一个部署 Nginx 的 Deployment 清单，其中 html 目录下的静态文件存放在 NFS 里，通过 PVC 挂载到 Pod 中：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 这里省略了 Service 相关的内容\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Deployment\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx-dpl-with-nfs-pvc\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx:alpine\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"containerPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"80\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"web\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"#挂载容器中的目录到 pvc nfs 中的目录\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"www\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/usr/share/nginx/html\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"www\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        persistentVolumeClaim\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"#指定pvc\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          claimName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nfs-pvc-for-nginx\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"PersistentVolumeClaim\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nfs-pvc-for-nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  namespace\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"default\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  storageclassname\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 指定使用现有 PV ，不使用 StorageClass 创建 PV\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  accessModes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReadWriteMany\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  resources\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    requests\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      storage\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"1Gi\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 这个例子中需要挂载 NFS 上的特定路径，所以手动定义了一个 PV\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 一般情况下我们不会手动创建 PV，而是使用 StorageClass 自动创建\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"PersistentVolume\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nfs-pv-for-nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  capacity\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    storage\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"1Gi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  accessModes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReadWriteMany\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  persistentVolumeReclaimPolicy\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Retain\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  nfs\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/nfs/sharefolder/nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    server\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"81.70.4.171\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这份清单我们主要关注前两个资源，我们可以看到除了一个 Deployment 资源以外我们还单独定义了一个 PVC 资源。然后在 Deployment 的 Pod 模板中声明并绑定了这个 PVC 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可这样 apply 了之后会发生什么情况呢？因为我们只声明了一份 PVC ，当然我们只会拥有一个 PVC 资源。但这个 Deployment 的副本数是 3 ，因此我们会有 3 个相同的 Pod 去绑定同一个 PVC 。也就是最终会在 3 个容器里访问同一个 NFS 的同一个目录。如果我们在其中一个容器里对这个目录作修改，也会影响到另外两个容器。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"注：这一现象不一定在任何情况下都适用。比如 AWS 的 EBS 卷只支持单个 AZ 内的绑定。如果 Pod 因为 Node Affinity 等设定被部署到了多个区，没法绑定同一个 EBS 卷，就会在 Scedule 的阶段报错。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"很多时候我们都不希望多个 Pod 绑定到同一 PVC 。比如我们部署一个 DB 集群的时候，如果好不容易部署出来的多个实例居然用的是同一份储存，就会显得很呆。 Stateful Set 就是为了解决这种情况，会为其管理下的每个 Pod 都部署一个专用的 PVC 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是给 Stateful Set 创建出来的 Pod 挂载 PVC 的一份清单：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 这里省略了 Service 相关的内容\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"StatefulSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"web\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  serviceName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"k8s.gcr.io/nginx-slim:0.8\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"containerPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"80\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"web\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"www\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/usr/share/nginx/html\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumeClaimTemplates\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"www\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      accessModes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [ \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReadWriteOnce\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \" ]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      resources\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        requests\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          storage\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"1Gi\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们可以看到，部署 Stateful Set 时我们不能另外单独定义一份 PVC 了，只能作为 Stateful Set 定义的一部分，在 volumeClaimTemplates 字段中定义 PVC 的模板。这样一来， Stateful Set 会根据这个模板，为每个 Pod 创建一个对应的 PVC ，并作为 Pod 的 Volume 绑定上：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"bash\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# Stateful Set 创建出来的 Pod ，名字都是按顺序的\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" pods\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app=nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    RESTARTS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"web-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          1m\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"web-1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          1m\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# Stateful Set 创建出来的 PVC ，名字与 Pod 的名字一一对应\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" pvc\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app=nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"        STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    VOLUME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                                     CAPACITY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ACCESSMODES\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"www-web-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   Bound\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     pvc-15c268c7-b507-11e6-932f-42010a800002\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1Gi\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"        RWO\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           48s\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"www-web-1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   Bound\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     pvc-15c79307-b507-11e6-932f-42010a800002\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1Gi\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"        RWO\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           48s\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这样， Stateful Set 的多个 Pod 就会拥有自己的储存，不会相互打架了。另外，如果我们事先定义了 StorageClass ，还能根据 Stateful Set 的副本数动态配置 PV 。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"configmap-与-secret-挂载作为特殊的卷\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#configmap-与-secret-挂载作为特殊的卷\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"ConfigMap 与 Secret 挂载作为特殊的卷\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"有时候我们需要使用配置文件来配置应用（比如 Nginx 的配置文件），而且我们有时候会需要不重启 Pod 就热更新配置。如果用 PVC 来加载配置文件略微麻烦，这时候可以使用 Config Map 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是 K8s 官网上 Config Map 的一个例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ConfigMap\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"data\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 一个 Key 可以对应一个值\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  player_initial_lives\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ui_properties_file_name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 一个 Key 也可以对应一个文件的内容\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  game.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"|\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    enemy.types=aliens,monsters\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    player.maximum-lives=5    \"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"|\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    color.good=purple\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    color.bad=yellow\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    allow.textmode=true    \"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"configmap-demo-pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"demo\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"alpine\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sleep\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"3600\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      env\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # ConfigMap 的 Key 可以作为环境变量引用\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"PLAYER_INITIAL_LIVES\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          valueFrom\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            configMapKeyRef\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"           # 从这个 Config Map 里\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              key\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"player_initial_lives\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 拿到这个 key 的值\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"UI_PROPERTIES_FILE_NAME\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          valueFrom\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            configMapKeyRef\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              key\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ui_properties_file_name\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"config\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/config\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        readOnly\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 定义 Pod 的 Volume ，种类为 configMap\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"config\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      configMap\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # ConfigMap的名字\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 需要作为文件放入 Volume 的 Key\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        items\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"key\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"key\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们可以看到 ConfigMap 里的 Key 可以作为文件或是环境变量加载到 Pod 中。另外，作为环境变量加载后其实还能作为命令行参数传入应用，实现各种配置方式。如果修改 Config map 的内容，也可以自动更新 Pod 中的文件。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"然而， Config Map 的热更新有一些不太灵活的地方：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"作为环境变量加载的 Config Map 数据不会被热更新。想要更新这一部分数据需要重启 Pod。（当然，命令行参数也不能热更新）\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"由于 Kubelet 会先将 Config Map 内容加载到本地作为缓存，因此修改 Config Map 后新的内容不会第一时间加载到 Pod 中。而且在旧版本的 K8s 中， Config Map 被更新直到缓存被刷新的时间间隔还会很长，新版本的 K8s 这一部分有了优化，可以设定刷新时间，但会导致 API Server 的负担加重。（这其实是一个 Known Issue ，被诟病多年： \", _jsx(_components.a, {\n          href: \"https://github.com/kubernetes/kubernetes/issues/22368\",\n          children: \"https://github.com/kubernetes/kubernetes/issues/22368\"\n        }), \" ）\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"除 Config Map 以外， K8s 还提供了一种叫 Secret 的资源，用法和 Config Map 几乎一样。对比 Config Map ，Secret 有以下几个特点：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"在 Pod 里， Secret 只会被加载到内存中，而永远不会被写到磁盘上。\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl get\"\n              })\n            })\n          })\n        }), \" 之类的命令显示的 Secret 内容会被用 base64 编码。（不过， well ，众所周知 base64 可不算是什么加密）\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"可以通过 K8s 的 Service Account 等 RBAC 相关的资源来控制 Secret 的访问权限。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"不过，由于 Secret 也是以明文的形式被存储在 K8s 的主节点中的，因此需要保证 K8s 主节点的安全。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.strong, {\n          children: \"Downward API 挂载作为特殊的卷\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"还有另外一种叫 Downward API 的东西，可以作为 Volume 或是环境变量被加载到 Pod 中。有一些参数我们很难事先在 Manifest 中定义（ e.g. Deployment 生成的 Pod 的名字），因此可以通过 Downward API 来实现。\"\n      }), \"\\n\", _jsx(_components.figure, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.pre, {\n          tabIndex: \"0\",\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          children: _jsxs(_components.code, {\n            \"data-language\": \"yaml\",\n            \"data-theme\": \"plastic\",\n            style: {\n              display: \"grid\"\n            },\n            children: [_jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"apiVersion\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"v1\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"kind\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"Pod\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"metadata\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"    name\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"test-volume-pod\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"    namespace\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"kube-system\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"    labels\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"        k8s-app\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"test-volume\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"        node-env\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"test\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"spec\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"    containers\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"    - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"name\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"test-volume-pod-container\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      image\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"busybox:latest\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      env\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"      - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"name\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"POD_NAME\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#5F6672\",\n                  fontStyle: \"italic\"\n                },\n                children: \" # 将 Pod 的名字作为环境变量 POD_NAME 加载到 Pod 中\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"        valueFrom\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"          fieldRef\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"            fieldPath\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"metadata.name\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      command\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": [\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"sh\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \", \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"-c\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"]\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      args\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"      - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"while true; do\"\n              })]\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"          cat /etc/podinfo/labels | echo;\"\n              })\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"          env | sort | echo;\"\n              })\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"          sleep 3600;\"\n              })\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"        done;\"\n              })\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      volumeMounts\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"      - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"name\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"podinfo\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"        mountPath\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"/etc/podinfo\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"    volumes\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"    - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"name\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"podinfo\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"      downwardAPI\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#5F6672\",\n                  fontStyle: \"italic\"\n                },\n                children: \"# Downward API 类型的卷\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"        items\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"        - \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"path\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"labels\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \"\\\"\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#5F6672\",\n                  fontStyle: \"italic\"\n                },\n                children: \" # 将 Pod 的标签作为  labels 文件挂载到 Pod 中\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"          fieldRef\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \":\"\n              })]\n            }), \"\\n\", _jsxs(_components.span, {\n              \"data-line\": \"\",\n              children: [_jsx(_components.span, {\n                style: {\n                  color: \"#E5C07B\"\n                },\n                children: \"            fieldPath\"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#A9B2C3\"\n                },\n                children: \": \"\n              }), _jsx(_components.span, {\n                style: {\n                  color: \"#98C379\"\n                },\n                children: \"metadata.labels\"\n              })]\n            })]\n          })\n        })\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"网络\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#网络\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"网络\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"其实 Pod 只要部署好了，就会被分配到一个集群内部的 IP 地址，流量就可以通过 IP 地址来访问 Pod 了。然而通过可能会有很大问题： \", _jsx(_components.strong, {\n        children: \"Pod 随时会被杀死。\"\n      }), \" 虽然通过用 Deployment 等资源可以在挂掉后重新创建一个 Pod ，但那毕竟是不同的 Pod ， IP 已经改变。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"另外， Deployment 等资源的就是为了能更方便的做到多副本部署及任意缩容扩容而存在的。如果在 K8s 中访问 Pod 还需要小心翼翼地去找到 Pod 的 IP 地址，或是去寻找 Pod 是否部署了新副本， Deployment 等资源就几乎没有存在价值了。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"其实 Pod 部署好后不止会被分配 IP 地址，还会被分配到一个类似 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"\u003cpod-ip\u003e.\u003cnamespace\u003e.pod.cluster.local\"\n              })\n            })\n          })\n        }), \" 的 DNS 记录。例如一个位于 default 名字空间，IP 地址为 172.17.0.3 的 Pod ，对应 DNS 记录为 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"172-17-0-3.default.pod.cluster.local\"\n              })\n            })\n          })\n        }), \" 。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"service\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#service\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Service\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在古代，人们是通过注册中心、服务发现、负载均衡等中间件来解决上面这些问题的，但这样很不云原生。于是 K8s 引入了 Service 这种资源，来实现简易的服务发现、 DNS 功能。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是一个经典的例子，部署了一个 Service 和一个 Deployment：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth-service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ClusterIP\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 指向 Deployment 创建的 Pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"80\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # Service 暴露的端口\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    targetPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8080\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # Pod 的端口\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Deployment\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auth\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"xxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/auth:xxxxx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"containerPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"8080\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"根据前面的知识我们知道，这份文件会部署 Deployment 会创建 2 个相同的 Pod 副本。另外还会部署一个名为 auth-service 的 Service 资源。这个 Service 暴露了一个 80 端口，并且指向那两个 Pod 的 8080 端口。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而这份文件部署后， Service 资源就会在集群中注册一个 DNS A 记录（或 AAAA 记录），集群内其他 Pod （为了辨别我们叫它 Client ）就可以通过相同的 DNS 名称来访问 Deployment 部署的这 2 个 Pod ：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"curl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" http://auth-service.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"namespac\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \".svc.cluster.local:80\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 或者省略掉后面的一大串\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"curl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" http://auth-service.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"namespac\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \":80\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 如果 Client 和 Service 在同一个 Namespace 中，还可以：\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"curl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" http://auth-service:80\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"像这样 Client 通过 Service 来访问时，会随机访问到其中一个 Pod ，这样一来无论 Deployment 到底创建了多少个副本，只要副本的标签相同，就能通过同一个 DNS 名称来访问，还能自动实现一些简单的负载均衡。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.strong, {\n          children: \"为什么 DNS 名称可以简化？\"\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Pod 被部署时， kubelet 会为每个 Pod 注入一个类似如下的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"/etc/resolv.conf\"\n              })\n            })\n          })\n        }), \" 文件：\"]\n      }), \"\\n\", _jsx(_components.figure, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.pre, {\n          tabIndex: \"0\",\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsxs(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            style: {\n              display: \"grid\"\n            },\n            children: [_jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"nameserver 10.32.0.10\"\n              })\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"search \u003cnamespace\u003e.svc.cluster.local svc.cluster.local cluster.local\"\n              })\n            }), \"\\n\", _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"options ndots:5\"\n              })\n            })]\n          })\n        })\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"Pod 中进行 DNS 查询时，默认会先读取这个文件，然后按照 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"search\"\n              })\n            })\n          })\n        }), \" 选项中的内容展开 DNS 。例如，在 test 名称空间中的 Pod ，访问 data 时的查询可能被展开为 data.test.svc.cluster.local 。\\n更多关于 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"/etc/resolv.conf\"\n              })\n            })\n          })\n        }), \" 文件的内容可参考 \", _jsx(_components.a, {\n          href: \"https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html\",\n          children: \"https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"service-的种类\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#service-的种类\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Service 的种类\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们上面的例子中，可以看到 Service 资源有个字段 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"type:ClusterIP\"\n            })\n          })\n        })\n      }), \" 。其实 Service 资源有以下几个种类：\"]\n    }), \"\\n\", _jsxs(_components.table, {\n      children: [_jsx(_components.thead, {\n        children: _jsxs(_components.tr, {\n          children: [_jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"种类\"\n          }), _jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"作用\"\n          })]\n        })\n      }), _jsxs(_components.tbody, {\n        children: [_jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"ClusterIP\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"这个类型的 Service 会在集群内创建一条 DNS A 记录并通过一定方法将流量代理到其指向的 Pod 上。这种 Service 不会暴露到集群外。这是最基础的 Service 种类。\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"NodePort\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并把端口的流量也代理到指向的 Pod 上。可以通过这种方法从集群外访问集群内的资源。\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"LoadBalancer\"\n                  })\n                })\n              })\n            })\n          }), _jsxs(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: [\"这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并在集群外创建一个负载均衡器来将外部流量路由到暴露的端口，再把流量代理到指向的 Pod 上。这种 Service 一般需要调用云服务提供的 API 或是额外安装的插件。如果什么插件都没安装的话，这种 Service 部署后会与 \", _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"NodePort\"\n                  })\n                })\n              })\n            }), \" 的表现一样。\"]\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: _jsx(_components.span, {\n              \"data-rehype-pretty-code-figure\": \"\",\n              children: _jsx(_components.code, {\n                \"data-language\": \"plaintext\",\n                \"data-theme\": \"plastic\",\n                children: _jsx(_components.span, {\n                  \"data-line\": \"\",\n                  children: _jsx(_components.span, {\n                    children: \"ExternalName\"\n                  })\n                })\n              })\n            })\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"这种 Service 不需要 selector 字段指定后端，而是用 externalName 字段指定一个外部 DNS 记录，然后将流量全部指向外部服务。如果打算将集群内的服务迁移到集群外、或是集群外迁移到集群内，这种类型的 Service 可以实现无缝迁移。\"\n          })]\n        })]\n      })]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"虚拟-ip-与-headless-service\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#虚拟-ip-与-headless-service\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"虚拟 IP 与 Headless Service\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果你在集群内尝试对 Service 对应的 DNS 记录进行域名解析，会发现返回来的 IP 地址与 Service 指向的任何一个 Pod 对应的 IP 地址都不相同。如果你还尝试了去 Ping 这个 IP 地址，会发现不能 Ping 通。为什么会这样呢？\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"原来，每个 Service 被部署后， K8s 都会给他分配一个集群内部的 IP 地址，也就是 Cluster IP （这也是最基础的 Service 种类会起名叫 Cluster IP 的原因）。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"但是这个 Cluster IP 不会绑定任何的网卡，是一个虚拟 IP 。然后 K8s 中有一个叫 kube-proxy 的组件（这里叫他做组件，是因为 kube-proxy 与 Service 、 Deployment 等不一样，不是一种资源而是 K8s 的一部分）， kube-proxy 通过修改 iptables ，将虚拟 IP 的流量经过一定的负载均衡规则后代理到 Pod 上。\"\n    }), \"\\n\", _jsx(_components.img, {\n      src: \"https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg\",\n      alt: \"K8s 官网上的虚拟 IP 图\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.strong, {\n          children: \"为什么不使用 DNS 轮询？\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"为什么 K8s 不配置多条 DNS A 记录，然后通过轮询名称来解析？为什么需要搞出虚拟 IP 这么复杂的东西？这个问题 K8s 官网上也有特别提到原因：\"\n      }), \"\\n\", _jsxs(_components.ul, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"DNS 实现的历史由来已久，它不遵守记录 TTL，并且在名称查找结果到期后对其进行缓存。\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"有些应用程序仅执行一次 DNS 查找，并无限期地缓存结果。\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"即使应用和库进行了适当的重新解析，DNS 记录上的 TTL 值低或为零也可能会给 DNS 带来高负载，从而使管理变得困难。\"\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"有些时候（比如想使用自己的服务发现机制或是自己的负载均衡机制时）我们确实也会想越过虚拟 IP ，直接获取背后 Pod 的 IP 地址。这时候我们可以将 Service 的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.clusterIP\"\n            })\n          })\n        })\n      }), \" 字段指定为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"None\"\n            })\n          })\n        })\n      }), \" ，这样 K8s 就不会给这个 Service 分配一个 Cluster IP 。这样的 Service 被称为 \", _jsx(_components.strong, {\n        children: \"Headless Service\"\n      }), \" 。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Headless Service 资源会创建一组 A 记录直接指向背后的 Pod ，可以通过 DNS 轮询等方式直接获得其中一个 Pod 的 IP 地址。另外更重要的一点， Headless Service 还会创建一组 SRV 记录，包含了指向各个 Pod 的 DNS 记录，可以通过 SRV 记录来发现所有 Pod 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们可以在集群里用 nsloopup 或 dig 命令去验证一下：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 在集群的 Pod 内部运行\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" nslookup\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka-headless.kafka.svc.cluster.local\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Server:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"     10.96.0.10\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Address:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    10.96.0.10#53\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Name:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   kafka-headless.kafka.svc.cluster.local\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Address:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 172.17.0.6\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Name:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   kafka-headless.kafka.svc.cluster.local\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Address:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 172.17.0.5\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Name:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   kafka-headless.kafka.svc.cluster.local\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"Address:\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 172.17.0.4\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" dig\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" SRV\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka-headless.kafka.svc.cluster.local\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# .....\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \";; \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"ANSWER\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" SECTION:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"      30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      SRV\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"     0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 20\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 9092\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka-0.kafka-headless.kafka.svc.cluster.local.\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"      30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      SRV\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"     0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 20\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 9092\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka-1.kafka-headless.kafka.svc.cluster.local.\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kakfa-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"      30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      SRV\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"     0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 20\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 9092\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka-2.kafka-headless.kafka.svc.cluster.local.\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \";; \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"ADDITIONAL\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" SECTION:\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-0.kafka-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" A\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  172.17.0.6\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-1.kafka-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" A\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  172.17.0.5\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-2.kafka-headless.kafka.svc.cluster.local.\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" 30\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" IN\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" A\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  172.17.0.4\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"拥有 Cluster IP 的 Service 其实也有 SRV 记录。但这种情况的 SRV 记录中对应的 Target 仍为 Service 自己的 FQDN 。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"第三次回到-stateful-set\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#第三次回到-stateful-set\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"第三次回到 Stateful Set\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在上面 Headless Service 的例子中，我们看到，各个 Pod 对应的 DNS A 记录格式为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"\u003cpod_name\u003e.\u003csvc_name\u003e.\u003cnamespace\u003e.svc.cluster.local\"\n            })\n          })\n        })\n      }), \" 。不对啊，之前的小知识里不是说过 Pod 被分配的 DNS A 记录格式应该是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"172-17-0-3.default.pod.cluster.local\"\n            })\n          })\n        })\n      }), \" 的吗？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"其实 Headless Service 还有一个众所周知的隐藏功能。 Pod 这种资源本身的参数中有 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"subdomain\"\n            })\n          })\n        })\n      }), \" 字段和 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"hostname\"\n            })\n          })\n        })\n      }), \" 字段，如果设置了这两个字段，这个 Pod 就拥有了形如 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"\u003chostname\u003e.\u003csubdomain\u003e.\u003cnamespace\u003e.svc.cluster.local\"\n            })\n          })\n        })\n      }), \" 的 FQDN （全限定域名）。如果这时刚好在同一名称空间下有与 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"subdomain\"\n            })\n          })\n        })\n      }), \" 同名的 Headless Service ， DNS 就会用为这个 Pod 用它的 FQDN 来创建一条 DNS A 记录。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"比如 Pod1 在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka\"\n            })\n          })\n        })\n      }), \" 名称空间中， \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"hostname\"\n            })\n          })\n        })\n      }), \" 为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-1\"\n            })\n          })\n        })\n      }), \" ， \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"subdomain\"\n            })\n          })\n        })\n      }), \" 为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-headless\"\n            })\n          })\n        })\n      }), \" ，那么 Pod1 的 FQDN 就是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-1.kafka-headless.kakfa.svc.cluster.local\"\n            })\n          })\n        })\n      }), \" 。而同样在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka\"\n            })\n          })\n        })\n      }), \" 名称空间中，刚好又有一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-headless\"\n            })\n          })\n        })\n      }), \" 的 Headless Service ，那么 DNS 就会创建一条 A 记录，就可以通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-1.kafka-headless.kafka.svc.cluster.local\"\n            })\n          })\n        })\n      }), \" 来访问 Pod1 了。当然，由于 DNS 展开，也可以用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-1.kafka-headless.kafka\"\n            })\n          })\n        })\n      }), \" 甚至是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-1.kafka-headless\"\n            })\n          })\n        })\n      }), \" 来访问这个 Pod 。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其实这些 Pod 是用 Stateful Set 来部署的，这一部分其实是 Stateful Set 相关的功能。之前我们说到 Stateful Set 有唯一稳定的网络标识。我们现在就来详细讲讲，这“唯一稳定的网络标识”到底是在指什么。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们来看一下这个 kafka Stateful Set 到底是怎么部署的：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-headless\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  clusterIP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 这是一个 headless service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"tcp-client\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"9092\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    protocol\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"TCP\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    targetPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-client\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    select-label\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-label\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ClusterIP\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"StatefulSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  serviceName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-headless\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 注意到这里有 serviceName 字段\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      select-label\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-label\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        select-label\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-label\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"docker.io/bitnami/kafka:3.1.0-debian-10-r52\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 接下来 Pod 相关部分省略\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 下面 Volume 相关部分也省略\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们看到， Stateful Set 的定义中必须要用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.serviceName\"\n            })\n          })\n        })\n      }), \" 字段指定一个 Headless Service 。 Stateful Set 创建 Pod 时，会自动给 Pod 指定 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"hostname\"\n            })\n          })\n        })\n      }), \" 和 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"subdomain\"\n            })\n          })\n        })\n      }), \" 字段。这样一来，每个 Pod 才有了唯一固定的 hostname ，唯一固定的 FQDN ，以及通过与 Headless Service 共同部署而获得唯一固定的 A 记录。（此外，其实当 Pod 因为版本升级等原因被重新创建时，相同序号的 Pod 还会被分配到相同固定的集群内 IP 。）\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsxs(_components.strong, {\n          children: [\"关于 Stateful Set 中 \", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"serviceName\"\n                })\n              })\n            })\n          }), \" 字段的争议\"]\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Stateful Set 中的 serviceName 字段是必填字段。这个字段唯一的作用其实就是给 Pod 指定 subdomain 。其实这样会有一些问题：\"\n      }), \"\\n\", _jsxs(_components.ol, {\n        children: [\"\\n\", _jsxs(_components.li, {\n          children: [\"Stateful Set 部署时不会检查是否真的存在这么一个 Headless Service 。如果 serviceName 乱填一个值，会导致虽然 Pod 的 \", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"hostname\"\n                })\n              })\n            })\n          }), \" 和 \", _jsx(_components.span, {\n            \"data-rehype-pretty-code-figure\": \"\",\n            children: _jsx(_components.code, {\n              \"data-language\": \"plaintext\",\n              \"data-theme\": \"plastic\",\n              children: _jsx(_components.span, {\n                \"data-line\": \"\",\n                children: _jsx(_components.span, {\n                  children: \"subdomain\"\n                })\n              })\n            })\n          }), \" 都指定了却没有创建 A 记录的情况。\"]\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"有时 Stateful Set 的 Pod 不需要接收流量，也不需要相互发现，这时候还强行需要指定一个 serviceName 显得有点多余。\"\n        }), \"\\n\"]\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"在 GitHub 上有关于这个问题的 Issue ： \", _jsx(_components.a, {\n          href: \"https://github.com/kubernetes/kubernetes/issues/69608\",\n          children: \"https://github.com/kubernetes/kubernetes/issues/69608\"\n        })]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"从集群外部访问\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#从集群外部访问\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"从集群外部访问\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在 K8s 集群里把应用部署好了，可是如何让集群外部的客户端访问我们集群中的应用呢？这可能是大家最关心的问题。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"不过有认真听的同学估计已经有这个问题的答案了。之前我们讲过 NodePort 和 LoadBalancer 这两种 Service 类型。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其中 NodePort Service 只是简单地在节点机器上各开一个端口，而如何路由、如何负载均衡等则一概不管。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而 LoadBalancer Service 则是在 NodePort 的基础上再加一个一个负载均衡器，然后把节点暴露的端口注册到这个负载均衡器上。这样一来，集群外部的客户端就可以通过同一个 IP 来访问集群中的应用。但是要使用 LoadBalancer Service ，一般需要先安装云供应商提供的 Controller ，或是安装其他第三方的 Controller （比如 Nginx Controller ）。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在 Service 之外还另有一种资源类型叫 Ingress ，也可以用来实现集群外部访问集群内部应用的功能。 Ingress 其实也会在集群外创建一个负载均衡器，因此也需要预先安装云供应商的 Controller 。但 Ingress 与 Service 不同的是，它还会管理一定的路由逻辑，接收流量后可以根据路由来分配给不同的 Service 。\"\n    }), \"\\n\", _jsxs(_components.table, {\n      children: [_jsx(_components.thead, {\n        children: _jsxs(_components.tr, {\n          children: [_jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"类型\"\n          }), _jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"OSI 模型工作层数\"\n          }), _jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"依赖于云平台或其他插件\"\n          })]\n        })\n      }), _jsxs(_components.tbody, {\n        children: [_jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"NodePort Service\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"第四层\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"否\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"LoadBalancer Service\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"第四层\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"是\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"Ingress\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"第七层\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"是\"\n          })]\n        })]\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"特别再详细说一下 Ingress 这种资源。 Ingress 本身不会在集群内的 DNS 上创建记录，一般也不会主动去路由集群内的流量（除非你在集群内强行访问 Ingress 的负载均衡器…… 不过一般也没什么理由要这样做对吧）。但 Ingress 可以根据 HTTP 的 hostname 和 path 来路由流量，把流量分发到不同的 Service 上。 Ingress 也是 K8s 的原生资源里唯一能看到 OSI 第七层的资源。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是 AWS 的 EKS 服务中部署的一个 Ingress 的例子（集群中已安装 AWS Load Balancer Controller ）：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"networking.k8s.io/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Ingress\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  annotations\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    kubernetes.io/ingress.class\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"alb\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/scheme\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"internet-facing\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/target-type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ip\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/backend-protocol-version\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"GRPC\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/listen-ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"[{\\\"HTTPS\\\":443}]\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"'\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/healthcheck-path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/grpc.health.v1.Health/Check\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/healthcheck-protocol\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"HTTP\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/success-codes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"0,12\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    alb.ingress.kubernetes.io/certificate-arn\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"arn:aws:acm:xxxxxxxxxx:certificate/xxxxxxxxxx\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    external-dns.alpha.kubernetes.io/hostname\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sample.example.com\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  \"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-ingress\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  rules\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"host\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sample.example.com\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    http\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      paths\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/grpc.health.v1.Health\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        pathType\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Prefix\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        backend\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          service\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"health-service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              number\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"50051\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/proto.sample.v1.Sample\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        pathType\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Prefix\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        backend\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          service\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sample-service\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              number\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"50051\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"可以看到， Ingress 资源可以通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.rules\"\n            })\n          })\n        })\n      }), \" 字段中定义各条规则，通过 hostname 或是 path 等第七层的信息来进行路由。 Ingress 部署下去后， AWS Load Balancer Controller 会读取会根据的配置，并在云上创建一个 AWS Application Load Balancer （ALB），而 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.rules\"\n            })\n          })\n        })\n      }), \" 会应用到 ALB 上，由 ALB 来负责流量的路由。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们也会注意到，怎么 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"metadata.annotations\"\n            })\n          })\n        })\n      }), \" 里有这么多奇奇怪怪的字段！ Ingress 本身的功能都是 AWS Load Balancer Controller 调用 AWS 的 API 创建 ALB 来实现的。但 AWS 的 ALB 能实现的功能可不止 Ingress 字段定义的这些，比如安装 TLS 证书、 health check 等 spec 字段中描述不下的功能，就只能是通过 annotation 的形式来定义了。\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"小彩蛋：可以看到例子中的 Ingress 资源 annotation 字段里还有一行 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"external-dns.alpha.kubernetes.io/hostname: sample.example.com\"\n              })\n            })\n          })\n        }), \" 。其实这个 K8s 集群中还安装了 external-dns 这个应用，它可以根据 annotation 来在外部 DNS 上直接创建 DNS 记录！有了这个插件我们可不用再慢慢打开公共 DNS 管理页面，再小心翼翼地记下 IP 地址去添加 A 记录了。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"更高级的部署方式一\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#更高级的部署方式一\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"更高级的部署方式（一）\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"一路说道这里， K8s 中最基础的资源大部分都已经介绍了。但是，这么多资源之间又需要相互配合，只部署一种资源基本没什么生产能力。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"比如只部署 Deployment 的话，我们确实是能在一组多副本的 Pod 里跑起可执行程序，但这组 Pod 却几乎没办法接受集群里其他 Pod 的流量（只能通过制定 Pod 的 IP 来访问，但 Pod 的 IP 是会变的）。因此一般来说一个 Deployment 都会搭配一个 Service 来使用。这还是最简单的一种搭配了。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"假若我们现在要在自己的 K8s 里安装一个别人提供的应用。当然由于 K8s 是基于容器的，只要别人提供了他应用的 yaml 清单，我们只用把清单用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply -f\"\n            })\n          })\n        })\n      }), \" 提交给 K8s ，然后让 K8s 把清单中的镜像拉下来就能跑了。可如果我们需要根据环境来改一些参数呢？\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"如果别人提供的 yaml 文件比较简单还好说，改改对应的字段就好了。如果别人的应用比较复杂，那改 yaml 文件可就是一个大难题了。比如 AWS 的 Load Balancer Controller ，它的 yaml 清单文件可是多达 939 行！\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.a, {\n        href: \"/content/articles/2022-08-31-introduction-for-k8s-4/aws-elb-controller-lines.png\",\n        children: \"aws-elb-controller-lines.png\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在这种复杂的场景下，我们就需要一些更高级的部署方式了。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"helm\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#helm\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Helm\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"首先来介绍的是 Helm 。 Helm 是一个包管理工具，可以类比一下 CentOS 中的 yum 工具。它可以把一组 K8s 资源发布成一个 Chart ，然后我们可以用 Helm 来安装这个 Chart ，并且可以通过参数设值来改变 Chart 中的部分资源。利用 Helm 安装 Chart 后还可以管理 Chart 的升级、回滚、卸载。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"使用别人提供的 Helm Chart 前，需要先 add 一下 Chart 的仓库，然后再安装仓库里提供的 Chart 。比如我们要安装 bitnami 提供的 Kafka Chart 时：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"bash\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 添加 https://charts.bitnami.com/bitnami 这个仓库，命名为 bitnami\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"helm\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" repo\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" add\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" bitnami\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" https://charts.bitnami.com/bitnami\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 在 kafka 名称空间里安装 bitnami 仓库里的 kafka Chart ，并通过参数设置为 3 个副本，并同时安装一个 3 副本的 Zookeeper\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"helm\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" install\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -n\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" \\\\\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  --set\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" replicaCount=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" \\\\\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  --set\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" zookeeper.enabled=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" \\\\\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"  --set\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" zookeeper.replicaCount=\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" \\\\\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"  bitnami/kafka\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"命令执行后， helm 就会根据参数与 Chart 的内容，在 K8s 里安装 StatefulSet 、 Service 、 ConfigMap 等一切所需要的资源。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" k\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -n\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kafka\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" all,cm\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                    READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    RESTARTS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-zookeeper-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-zookeeper-1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"pod/kafka-zookeeper-2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             46d\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                               TYPE\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           CLUSTER-IP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       EXTERNAL-IP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      PORT\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"(\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"S\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \")                      \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"service/kafka\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                      ClusterIP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"      172.20.1.196\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"     \u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"non\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           9092/TCP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                     164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"service/kafka-headless\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             ClusterIP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"             \u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"non\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           9092/TCP,9093/TCP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"            164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"service/kafka-zookeeper\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"            ClusterIP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"      172.20.227.236\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"   \u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"non\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           2181/TCP,2888/TCP,3888/TCP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"service/kafka-zookeeper-headless\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ClusterIP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      None\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"             \u003c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"non\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"\u003e\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"           2181/TCP,2888/TCP,3888/TCP\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   164d\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                               READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"statefulset.apps/kafka\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"             3/3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"statefulset.apps/kafka-zookeeper\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   3/3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     164d\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                                DATA\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"configmap/kafka-scripts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"             2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"configmap/kafka-zookeeper-scripts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      164d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"configmap/kube-root-ca.crt\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"          1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      165d\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"甚至， Helm 可以通过模板生成的 Pod 环境变量，来预先设置好 Kafka 的配置，让他找得到 Zookeeper 服务：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Pod\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 略去无关信息\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/setup.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    env\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"KAFKA_CFG_ZOOKEEPER_CONNECT\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      value\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-zookeeper\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # ...\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"通过设置 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"KAFKA_CFG_ZOOKEEPER_CONNECT\"\n            })\n          })\n        })\n      }), \" 这个环境变量，指定了 Kafka Broker 可以通过访问 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-zookeeper\"\n            })\n          })\n        })\n      }), \" 来找到 zookeeper 服务。（还记得 zookeeper 的 Service 名字是 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka-zookeeper\"\n            })\n          })\n        })\n      }), \" 吗？ zookeeper 与 kafka 部署在同一个名称空间里，因此可以直接通过 Service 名访问。）\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"如果我们打开这个 helm chart 对应的\", _jsx(_components.a, {\n        href: \"https://github.com/bitnami/charts/tree/master/bitnami/kafka\",\n        children: \"代码仓库\"\n      }), \"，会发现原来有一组 go template 文件，以及一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"values.yaml\"\n            })\n          })\n        })\n      }), \" 文件和 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"Chart.yaml\"\n            })\n          })\n        })\n      }), \" 文件：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \".\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" Chart.lock\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" Chart.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" README.md\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" templates\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" NOTES.txt\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 这里定义的是 helm 工具的命令行信息\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" _helpers.tpl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 这里面是一些定义好的 go template 代码块可以供其他模板使用\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" configmap.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" statefulset.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" svc-headless.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   ├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" svc.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"│\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   └──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \" # 以下省略若干模板文件\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"└──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" values.yaml\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"Chart.yaml\"\n              })\n            })\n          })\n        }), \" 中定义了这个 Chart 的基本信息，包括名称、版本、描述、依赖等。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"values.yaml\"\n              })\n            })\n          })\n        }), \" 中定义了这个 Chart 的默认参数，包括各种资源的默认配置、副本数量、镜像版本等。其中的值都可以通过 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"helm install\"\n              })\n            })\n          })\n        }), \" 命令的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"--set\"\n              })\n            })\n          })\n        }), \" 参数来覆盖。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"templates/\"\n              })\n            })\n          })\n        }), \" 文件夹下的都是 go template 的模板文件。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"helm install\"\n            })\n          })\n        })\n      }), \" 就是通过用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"values.yaml\"\n            })\n          })\n        })\n      }), \" 中预定义的参数，渲染 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"templates/\"\n            })\n          })\n        })\n      }), \" 文件夹下的 go template 文件，生成最终的 yaml 文件，然后再通过 kubectl apply -f 的方式，将 yaml 文件里的资源部署到 K8s 里。然后通过忘资源里注入一些特殊 annotation 的方式来记住自己部署了那些资源，进而提供 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"update\"\n            })\n          })\n        })\n      }), \" 、 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"uninstall\"\n            })\n          })\n        })\n      }), \" 等功能。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"关于更多 Helm 的内容，可以参考\", _jsx(_components.a, {\n        href: \"https://helm.sh/docs/\",\n        children: \"官方文档\"\n      }), \"。\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"kustomize\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#kustomize\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Kustomize\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"另一个部署工具是 Kustomize 。之前提到 Config Map 时的例子中，将配置文件的内容直接写进了 yaml 清单的一个字段里：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ConfigMap\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"data\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 一个 Key 可以对应一个值\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  player_initial_lives\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ui_properties_file_name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 一个 Key 也可以对应一个文件的内容\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  game.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"|\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    enemy.types=aliens,monsters\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    player.maximum-lives=5    \"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"|\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    color.good=purple\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    color.bad=yellow\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    allow.textmode=true    \"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其实这样很不好，先不说这样写没办法在 IDE 里用配置文件自己的语法检查，每行还需要一定的缩进，如果配置文件有好几百行，你甚至会忘了这一行到底是哪个配置文件！此时我们就会自然而然的想把每个配置文件以单独文件的形式保存。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Kustomize 就是这样一个工具，它可以帮助我们把每个配置文件以单独文件的形式保存，然后再通过一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 文件，将这些配置文件组合起来，生成最终的 yaml 文件。\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kustomize.config.k8s.io/v1beta1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Kustomization\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"resources\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"  # 其他资源也可以单独使用一个文件定义\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"deployment.yaml\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 用 configMapGenerator 从文件中生成 ConfigMap\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"configMapGenerator\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game-demo\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    literals\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ui_properties_file_name=user-interface.properties\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"player_initial_lives=3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 从文件中读取内容\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    files\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"game.properties\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"user-interface.properties\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 有多个 configMap 时，可以通过统一的 generatorOptions 来设置一些通用的选项\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"generatorOptions\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  disableNameSuffixHash\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"然后两个配置文件的内容可以单独用文件定义，此时可以结合 IDE 的语法检查，以及代码补全功能，来编写配置文件。\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"properties\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"properties\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# user-interface.properties\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"color.good\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"=purple\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"color.bad\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"=yellow\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E06C75\"\n              },\n              children: \"allow.textmode\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"=true    \"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"然后将 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 和其他所需的文件都放在同一个目录下：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"bash\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \".\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kustomization.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" deployment.yaml\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"├──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" game.properties\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"└──\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" user-interface.properties\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"然后就可以通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply -k ./\"\n            })\n          })\n        })\n      }), \" 来将整个 kustomize 文件夹转换为 yaml 清单直接部署到 K8s 中。\\n（没错，现在 Kustomize 已经成为 kubectl 中的内置功能！可以不用先 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomize build\"\n            })\n          })\n        })\n      }), \" 生成 yaml 文件再 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 两步走了！）\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"值得提醒的是，虽然 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 有 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"apiVersion\"\n            })\n          })\n        })\n      }), \" 和 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kind\"\n            })\n          })\n        })\n      }), \" 字段，长得很像一个资源清单，但其实 K8s 的 API server 并不认识他。 Kustomize 的工作原理其实是先根据 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 生成 K8s 认识的 yaml 资源清单，然后再通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 来部署。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"除了可以直接将 ConfigMap 与 Secret 中的文件字段内容用单独的文件定义外， Kustomize 还有其他比如为部署的资源添加统一的名称前缀、添加统一字段等功能。这些大家可以阅读 Kustomize 的\", _jsx(_components.a, {\n        href: \"https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/\",\n        children: \"官方文档\"\n      }), \"来了解。\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"各种工具的优缺点\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#各种工具的优缺点\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"各种工具的优缺点\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们目前已经知道有三种在 K8s 中部署资源的方式： \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \"、Helm 和 Kustomize 。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"其中 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 的优缺点很明确，优点是最简单直接，缺点是会导致要么 yaml 清单过长，要么需要分多文件多次部署，使集群中产生中间状态。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"而 Helm 与 Kustomize 我们上面也分析过，其实都是基于 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 的。 Helm 是通过 go template 先生成 yaml 文件再 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" ，而 Kustomize 是通过 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 中的定义用自己的一套逻辑生成 yaml 文件，然后再 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Helm 的优点是 Helm Chart 安装时可以直接使用别人 Helm 仓库中已经上传好的 Chart ，只需要设置参数就可以使用。这也是 Kustomize 的缺点：如果想要使用别人提供的 Kustomization 而只修改其中的一些配置，必须要先把放 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kustomization.yaml\"\n            })\n          })\n        })\n      }), \" 的整个文件夹下载下来才能做修改。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而 Helm 的缺点也是明显的， Helm 依赖于往资源里注入特殊的 annotation 来管理 Chart 生成的资源，这可能会很难与集群中现有的一些系统（比如 Service Mesh 或是 GitOps 系统等）放一起管理。而 Kustomize 生成的 yaml 清单就是很干净的 K8s 资源，原先的 K8s 资源该是什么表现就是什么表现，与现有的系统兼容一般会比较好。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"而另外，由于 Helm 与 Kustomize 都是基于 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 的，因此他们有共同的缺点，就是不能做 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 不能做的事情。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"什么叫 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 不能做的事情呢？比如说我们要在 K8s 中部署 Redis 集群。聪明的你可能就想到要用 Stateful Set 、 PVC 、 Headless Service 来一套组合拳。这确实可以部署一个多节点、有状态的 Redis Cluster 。可是如果我们要往 Redis Cluster 里加一个节点呢？\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"你当然可以把 Stateful Set 中的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"Replicas\"\n            })\n          })\n        })\n      }), \" 字段加个 1 然后用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 部署，可是这实际上只能增加一个一个 Redis 实例 —— 然后什么都没发生。其他节点不认识这个新的节点，访问这个新节点也不能拿到正确的数据。要知道往 Redis Cluster 里加节点，是要先让集群发现这个新节点，然后还要迁移 slot 的！ \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 可不会做这些事。\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"Well, 其实这些也是可以通过增加 initContainer 、修改镜像增加启动脚本等方式，实现用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl apply\"\n              })\n            })\n          })\n        }), \" 部署的。可是，这会让整个 Pod 资源变得很难理解，也不好维护。而且，如果不是因为做不到，谁会想去修改别人的镜像呢？\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们接下来会介绍 K8s 的核心架构，来理解我们之前讲的这些资源到底是怎么工作的。最后会引出一组新的概念： Operator 与自定义资源（ Custom Resource Definition ，简称 CRD ）。通过 Operator 与 CRD ，我们可以做到 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply\"\n            })\n          })\n        })\n      }), \" 所不能做到的事，包括 Redis Cluster 的扩容。\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsxs(_components.p, {\n        children: [\"DIO: \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl apply\"\n              })\n            })\n          })\n        }), \" 的能力是有限的……\\n越是部署复杂的应用，就越会发现 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl apply\"\n              })\n            })\n          })\n        }), \" 的能力是有极限的……除非超越 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl apply\"\n              })\n            })\n          })\n        }), \" 。\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"JOJO: 你到底想说什么？\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"DIO: 我不用 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"kubectl apply\"\n              })\n            })\n          })\n        }), \" 了！ JOJO ！\\n（其实还是要用的）\"]\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = {\n    ..._provideComponents(),\n    ...props.components\n  };\n  return MDXLayout ? _jsx(MDXLayout, {\n    ...props,\n    children: _jsx(_createMdxContent, {\n      ...props\n    })\n  }) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error(\"Expected \" + (component ? \"component\" : \"object\") + \" `\" + id + \"` to be defined: you likely forgot to import, pass, or provide it.\");\n}\n","frontmatter":{},"scope":{}},"meta":{"content":"\n我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。\n\n# 储存\n\n其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？\n\n在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。\n\n\u003e CSI: Container Storage Interface ，容器储存接口标准，是 K8s 提出的一种规范。不管是哪种储存引擎，只要编写一个对应的插件实现 CSI ，都可以在 K8s 中使用。\n\n### K8s 中使用 Volume 与可用的 Volume 类型\n\n其实 K8s 中使用 Volume 的例子我们一开始就已经接触过了。还记得一开始介绍 Pod 时的 Nginx 例子吗？\n\n```yaml\nmetadata:\n  name: simple-webapp\nspec:\n  containers:\n    - name: main-application\n      image: nginx\n      volumeMounts:\n        - name: shared-logs\n          mountPath: /var/log/nginx\n    - name: sidecar-container\n      image: busybox\n      command: [\"sh\",\"-c\",\"while true; do cat /var/log/nginx/access.log; sleep 30; done\"]\n      volumeMounts:\n        - name: shared-logs\n          mountPath: /var/log/nginx\n  volumes:\n    - name: shared-logs\n      emptyDir: {}\n```\n\n这个 Pod 描述中声明了一个种类为 `emptyDir` 的，名为 `shared-logs` 的 Volume ，然后 Pod 中的两个容器都分别 Mount 了这个 Volume 。\n\nK8s 中默认提供了几种 Volume ，比如：\n\n- emptyDir ：一个简单的空目录，一般用于储存临时数据或是 Pod 的容器之间共享数据。\n- hostPath ：绑定到节点宿主机文件系统上的路径，一般在 Daemon Set 中使用。\n- gitRepo ：这种 Volume 其实相当于 emptyDir ，不过在 Pod 启动时会从 Git 仓库 clone 一份内容作为默认数据。\n- configMap 、 secret ：一般用于配置文件加载，需要与 configMap 、 secret 这两种资源一同使用。会将 configMap 、 secret 中对应的内容拷贝一份作为 Volume 绑到容器。（下一节中会展开讨论）\n- nfs 、 glusterfs 、 ……：可以通过各种网络存储协议直接挂载一个网络存储\n- (deprecated!) gcePersistentDisk 、 awsElasticBlockStore ……：可以调用各个云平台的 API ，创建一个块储存硬件挂载到宿主机上，再将那个硬件挂载到容器中。\n- persistentVolumeClaim ：持久卷声明，用于把实际储存方式抽象化，使得 Pod 不需要关心具体的储存类型。这种类型会在下面详细介绍。\n\n我们可以注意到， Volume 的声明是 Pod 的一个属性，而不是一种单独的资源。 Volume 是 Pod 的一部分，因此不同的 Pod 之间永远不可能共享同一个 Volume 。\n\n\u003e 但是 Volume 所指向的位置可以相同，比如 HostPath 类型的 Volume 就可以两个 Pod 可以绑定到宿主机上同一个路径，因此 Volume 里的数据还是能通过一定方式在 Pod 间共享。但当然 K8s 不推荐这么做。\n\n另外，由于 Volume 是 Pod 的一部分， Volume 的生命周期也是跟随 Pod 的，当一个 Pod 被销毁时， Volume 也会被销毁，因此最主要还是用于 Pod 内容器间的文件共享。如果需要持久化储存，需要使用 Persistent Volume 。\n\n\u003e Volume 会被销毁不代表 Volume 指向的内容会被销毁。比如 hostPath 、 NFS 等类型 Volume 中的内容就会继续保留在宿主机或是 NAS 上。下面提到的 Presistent Volume Claim 也是，拥有 `persistentVolumeClaim` 类型 Volume 的 Pod 被删除后对应的 PVC 不一定会被删除。\n\n### Presistent Volume 、 Presistent Volume Claim 、 Storage Class\n\n如果需要在 Pod 声明中直接指定 NFS 、 awsElasticBlockStore 之类的信息，就需要应用的开发人员对真实可用的储存结构有所理解，违背了 K8s 的理念。因此 K8s 就弄出了小标题中的三种资源来将储存抽象化。\n\n一个 Persistent Volume (PV) 对应云平台提供的一个块存储，或是 NAS 上的一个路径。可以简单地理解为 **PV 直接描述了一块可用的物理存储** 。因为 PV 直接对应到硬件，因此 PV 跟节点一样，是名称空间无关的。\n\n而一个 **Persistent Volume Claim (PVC) 则是描述了怎样去使用储存** ：使用多少空间、只读还是读写等。一个 PVC 被创建后会且只会对应到一个 PV 。 PVC 从属于一个名称空间，并能被该名称空间下的 Pod 指定为一个 Volume 。\n\nPV 与 PVC 这两种抽象是很必要的。试想一下用自己的物理机搭建一个 K8s 集群的场景。你会提前给物理机插上许多个储存硬件，这时你就需要用 PV 来描述这些硬件，之后才能在 K8s 里利用这些硬件的储存。而实际将应用部署到 K8s 中时，你才需要用 PVC 来描述 Pod 中需要怎么样的储存卷，然后 K8s 就会自动挑一个合适 PV 给这个 PVC 绑定上。这样实际部署应用的时候就不用再特意跑去机房给物理机插硬件了。\n\n但是现在都云原生时代了，各供应商都有提供 API 可以直接创建一个块储存，还要想办法提前准备 PV 实在是太蠢了。于是便需要 Storage Class 这种资源。\n\n使用 Storage Class 前需要先安装各种云供应商提供的插件（当然使用云服务提供的 K8s 的话一般已经准备好了），然后再创建一个 Storage Class 类型的资源（当然一般也已经准备好了）。下面是 AWS 上的 EKS 服务中默认自带的 Storage Class ：\n\n```yaml\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  annotations:\n    storageclass.kubernetes.io/is-default-class: \"true\"\n  name: gp2\nprovisioner: kubernetes.io/aws-ebs\nparameters:\n  fsType: ext4\n  type: gp2\n# 当 PVC 被删除时会同时删除 PV\nreclaimPolicy: Delete\n# 只有当 PVC 被绑定为一个 Pod 的 Volume 时才会创建一个 PV\nvolumeBindingMode: WaitForFirstConsumer\n```\n\n可以看到 EKS 自带的 gp2 提供了一些默认的选项，我们也可以类似地去定义自己的 Storage Class 。有了 gp2 这个 Storage Class ，我们创建一个 PVC 后 K8s 就会调用 AWS 的 API ，创建一个块储存接到我们的节点上，然后 K8s 再自动创建一个 PV 并绑定到 PVC 上。\n\n例如，我们部署 Kafka 时会创建一个这样的 PVC ：\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: data-kafka-0\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 10Gi\n  storageClassName: gp2\n```\n\nK8s 就会自动为我们创建出一个对应的 PV ：\n\n```sh\n# `pvc-` 开头这个是 AWS 自动给我们起的名字。它虽然是 `pvc-` 开头，但他其实是一个 PV 。\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE\npvc-3614c15f-5697-4d66-a13c-6ddf7eb89998   10Gi       RWO            Delete           Bound    kafka/data-kafka-0   gp2                     152d\n```\n\n要是打开 AWS Console 还会发现， K8s 调用了 AWS 的 API ，自动为我们创建了一个 EBS 块储存并绑定到了我们对应的宿主机上。\n\n可以用下面这张图来表示 Pod 中的 Volume 、 PVC 、 PV 之间的关系：\n\n```mermaid\nflowchart TD\n\nsubgraph Pod[Pod: Kafka-0]\nsubgraph Container[Container: docker.io/bitnami/kafka:3.1.0]\nvm[VolumeMount: /bitnami/kafka]\nend\nvolume[(Volume: data)]\nvm --\u003e volume\nend\n\npvc[pvc: data-kafka-0]\npv[pv: pvc-3614c15f-5697-4d66-a13c-6ddf7eb89998]\nebs[ebs: AWS 为我们创建的块储存硬件]\n\nvolume --\u003e pvc\npvc --\u003e pv\npv --\u003e ebs\n```\n\n而 Storage Class 在上图中则负责读取我们提交的 PVC ，然后创建 PV 与 EBS 。\n\n### 再说回 Stateful Set\n\n之前我们提到 Stateful Set 时说到 Stateful Set 创建的 Pod 拥有固定的储存，到底是什么意思呢？跟 Deployment 的储存又有什么区别呢？\n\n我们先来看看，如果要给 Deployment 创建出来的 Pod 挂载 PVC 需要怎么做。下面是一个部署 Nginx 的 Deployment 清单，其中 html 目录下的静态文件存放在 NFS 里，通过 PVC 挂载到 Pod 中：\n\n```yaml\n# 这里省略了 Service 相关的内容\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-dpl-with-nfs-pvc\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:alpine\n        ports:\n        - containerPort: 80\n          name: web\n        volumeMounts: #挂载容器中的目录到 pvc nfs 中的目录\n        - name: www\n          mountPath: /usr/share/nginx/html\n      volumes:\n      - name: www\n        persistentVolumeClaim: #指定pvc\n          claimName: nfs-pvc-for-nginx\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: nfs-pvc-for-nginx\n  namespace: default\nspec:\n  storageclassname: \"\" # 指定使用现有 PV ，不使用 StorageClass 创建 PV\n  accessModes:\n  - ReadWriteMany\n  resources:\n    requests:\n      storage: 1Gi\n---\n# 这个例子中需要挂载 NFS 上的特定路径，所以手动定义了一个 PV\n# 一般情况下我们不会手动创建 PV，而是使用 StorageClass 自动创建\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-pv-for-nginx\nspec:\n  capacity: \n    storage: 1Gi\n  accessModes:\n  - ReadWriteMany\n  persistentVolumeReclaimPolicy: Retain\n  nfs:\n    path: /nfs/sharefolder/nginx\n    server: 81.70.4.171\n```\n\n这份清单我们主要关注前两个资源，我们可以看到除了一个 Deployment 资源以外我们还单独定义了一个 PVC 资源。然后在 Deployment 的 Pod 模板中声明并绑定了这个 PVC 。\n\n可这样 apply 了之后会发生什么情况呢？因为我们只声明了一份 PVC ，当然我们只会拥有一个 PVC 资源。但这个 Deployment 的副本数是 3 ，因此我们会有 3 个相同的 Pod 去绑定同一个 PVC 。也就是最终会在 3 个容器里访问同一个 NFS 的同一个目录。如果我们在其中一个容器里对这个目录作修改，也会影响到另外两个容器。\n\n\u003e 注：这一现象不一定在任何情况下都适用。比如 AWS 的 EBS 卷只支持单个 AZ 内的绑定。如果 Pod 因为 Node Affinity 等设定被部署到了多个区，没法绑定同一个 EBS 卷，就会在 Scedule 的阶段报错。\n\n很多时候我们都不希望多个 Pod 绑定到同一 PVC 。比如我们部署一个 DB 集群的时候，如果好不容易部署出来的多个实例居然用的是同一份储存，就会显得很呆。 Stateful Set 就是为了解决这种情况，会为其管理下的每个 Pod 都部署一个专用的 PVC 。\n\n下面是给 Stateful Set 创建出来的 Pod 挂载 PVC 的一份清单：\n\n```yaml\n# 这里省略了 Service 相关的内容\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: web\nspec:\n  serviceName: \"nginx\"\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx\n  template:\n    metadata:\n      labels:\n        app: nginx\n    spec:\n      containers:\n      - name: nginx\n        image: k8s.gcr.io/nginx-slim:0.8\n        ports:\n        - containerPort: 80\n          name: web\n        volumeMounts:\n        - name: www\n          mountPath: /usr/share/nginx/html\n  volumeClaimTemplates:\n  - metadata:\n      name: www\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 1Gi\n```\n\n我们可以看到，部署 Stateful Set 时我们不能另外单独定义一份 PVC 了，只能作为 Stateful Set 定义的一部分，在 volumeClaimTemplates 字段中定义 PVC 的模板。这样一来， Stateful Set 会根据这个模板，为每个 Pod 创建一个对应的 PVC ，并作为 Pod 的 Volume 绑定上：\n\n```bash\n# Stateful Set 创建出来的 Pod ，名字都是按顺序的\n$ kubectl get pods -l app=nginx\nNAME      READY     STATUS    RESTARTS   AGE\nweb-0     1/1       Running   0          1m\nweb-1     1/1       Running   0          1m\n\n# Stateful Set 创建出来的 PVC ，名字与 Pod 的名字一一对应\n$ kubectl get pvc -l app=nginx\nNAME        STATUS    VOLUME                                     CAPACITY   ACCESSMODES   AGE\nwww-web-0   Bound     pvc-15c268c7-b507-11e6-932f-42010a800002   1Gi        RWO           48s\nwww-web-1   Bound     pvc-15c79307-b507-11e6-932f-42010a800002   1Gi        RWO           48s\n```\n\n这样， Stateful Set 的多个 Pod 就会拥有自己的储存，不会相互打架了。另外，如果我们事先定义了 StorageClass ，还能根据 Stateful Set 的副本数动态配置 PV 。\n\n### ConfigMap 与 Secret 挂载作为特殊的卷\n\n有时候我们需要使用配置文件来配置应用（比如 Nginx 的配置文件），而且我们有时候会需要不重启 Pod 就热更新配置。如果用 PVC 来加载配置文件略微麻烦，这时候可以使用 Config Map 。\n\n下面是 K8s 官网上 Config Map 的一个例子：\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: game-demo\ndata:\n  # 一个 Key 可以对应一个值\n  player_initial_lives: \"3\"\n  ui_properties_file_name: \"user-interface.properties\"\n\n  # 一个 Key 也可以对应一个文件的内容\n  game.properties: |\n    enemy.types=aliens,monsters\n    player.maximum-lives=5    \n  user-interface.properties: |\n    color.good=purple\n    color.bad=yellow\n    allow.textmode=true    \n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: configmap-demo-pod\nspec:\n  containers:\n    - name: demo\n      image: alpine\n      command: [\"sleep\", \"3600\"]\n      env:\n        # ConfigMap 的 Key 可以作为环境变量引用\n        - name: PLAYER_INITIAL_LIVES\n          valueFrom:\n            configMapKeyRef:\n              name: game-demo           # 从这个 Config Map 里\n              key: player_initial_lives # 拿到这个 key 的值\n        - name: UI_PROPERTIES_FILE_NAME\n          valueFrom:\n            configMapKeyRef:\n              name: game-demo\n              key: ui_properties_file_name\n      volumeMounts:\n      - name: config\n        mountPath: \"/config\"\n        readOnly: true\n  volumes:\n    # 定义 Pod 的 Volume ，种类为 configMap\n    - name: config\n      configMap:\n        name: game-demo # ConfigMap的名字\n        # 需要作为文件放入 Volume 的 Key\n        items:\n        - key: \"game.properties\"\n          path: \"game.properties\"\n        - key: \"user-interface.properties\"\n          path: \"user-interface.properties\"\n```\n\n我们可以看到 ConfigMap 里的 Key 可以作为文件或是环境变量加载到 Pod 中。另外，作为环境变量加载后其实还能作为命令行参数传入应用，实现各种配置方式。如果修改 Config map 的内容，也可以自动更新 Pod 中的文件。\n\n然而， Config Map 的热更新有一些不太灵活的地方：\n\n1. 作为环境变量加载的 Config Map 数据不会被热更新。想要更新这一部分数据需要重启 Pod。（当然，命令行参数也不能热更新）\n2. 由于 Kubelet 会先将 Config Map 内容加载到本地作为缓存，因此修改 Config Map 后新的内容不会第一时间加载到 Pod 中。而且在旧版本的 K8s 中， Config Map 被更新直到缓存被刷新的时间间隔还会很长，新版本的 K8s 这一部分有了优化，可以设定刷新时间，但会导致 API Server 的负担加重。（这其实是一个 Known Issue ，被诟病多年： https://github.com/kubernetes/kubernetes/issues/22368 ）\n\n除 Config Map 以外， K8s 还提供了一种叫 Secret 的资源，用法和 Config Map 几乎一样。对比 Config Map ，Secret 有以下几个特点：\n\n1. 在 Pod 里， Secret 只会被加载到内存中，而永远不会被写到磁盘上。\n2. 用 `kubectl get` 之类的命令显示的 Secret 内容会被用 base64 编码。（不过， well ，众所周知 base64 可不算是什么加密）\n3. 可以通过 K8s 的 Service Account 等 RBAC 相关的资源来控制 Secret 的访问权限。\n\n不过，由于 Secret 也是以明文的形式被存储在 K8s 的主节点中的，因此需要保证 K8s 主节点的安全。\n\n\u003e **Downward API 挂载作为特殊的卷**\n\u003e \n\u003e 还有另外一种叫 Downward API 的东西，可以作为 Volume 或是环境变量被加载到 Pod 中。有一些参数我们很难事先在 Manifest 中定义（ e.g. Deployment 生成的 Pod 的名字），因此可以通过 Downward API 来实现。\n\u003e \n\u003e ```yaml\n\u003e apiVersion: v1\n\u003e kind: Pod\n\u003e metadata:\n\u003e     name: test-volume-pod\n\u003e     namespace: kube-system\n\u003e     labels:\n\u003e         k8s-app: test-volume\n\u003e         node-env: test\n\u003e spec:\n\u003e     containers:\n\u003e     - name: test-volume-pod-container\n\u003e       image: busybox:latest\n\u003e       env:\n\u003e       - name: POD_NAME # 将 Pod 的名字作为环境变量 POD_NAME 加载到 Pod 中\n\u003e         valueFrom:\n\u003e           fieldRef:\n\u003e             fieldPath: metadata.name\n\u003e       command: [\"sh\", \"-c\"]\n\u003e       args:\n\u003e       - while true; do\n\u003e           cat /etc/podinfo/labels | echo;\n\u003e           env | sort | echo;\n\u003e           sleep 3600;\n\u003e         done;\n\u003e       volumeMounts:\n\u003e       - name: podinfo\n\u003e         mountPath: /etc/podinfo\n\u003e     volumes:\n\u003e     - name: podinfo\n\u003e       downwardAPI: # Downward API 类型的卷\n\u003e         items:\n\u003e         - path: \"labels\" # 将 Pod 的标签作为  labels 文件挂载到 Pod 中\n\u003e           fieldRef:\n\u003e             fieldPath: metadata.labels\n\u003e ```\n\n\n\n# 网络\n\n其实 Pod 只要部署好了，就会被分配到一个集群内部的 IP 地址，流量就可以通过 IP 地址来访问 Pod 了。然而通过可能会有很大问题： **Pod 随时会被杀死。** 虽然通过用 Deployment 等资源可以在挂掉后重新创建一个 Pod ，但那毕竟是不同的 Pod ， IP 已经改变。\n\n另外， Deployment 等资源的就是为了能更方便的做到多副本部署及任意缩容扩容而存在的。如果在 K8s 中访问 Pod 还需要小心翼翼地去找到 Pod 的 IP 地址，或是去寻找 Pod 是否部署了新副本， Deployment 等资源就几乎没有存在价值了。\n\n\u003e 其实 Pod 部署好后不止会被分配 IP 地址，还会被分配到一个类似 `\u003cpod-ip\u003e.\u003cnamespace\u003e.pod.cluster.local` 的 DNS 记录。例如一个位于 default 名字空间，IP 地址为 172.17.0.3 的 Pod ，对应 DNS 记录为 `172-17-0-3.default.pod.cluster.local` 。\n\n### Service\n\n在古代，人们是通过注册中心、服务发现、负载均衡等中间件来解决上面这些问题的，但这样很不云原生。于是 K8s 引入了 Service 这种资源，来实现简易的服务发现、 DNS 功能。\n\n下面是一个经典的例子，部署了一个 Service 和一个 Deployment：\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: auth-service\n  labels:\n    app: auth\nspec:\n  type: ClusterIP\n  selector:\n    app: auth # 指向 Deployment 创建的 Pod\n  ports:\n  - port: 80 # Service 暴露的端口\n    targetPort: 8080 # Pod 的端口\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name:  auth\n  labels:\n    app: auth\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: auth\n  template:\n    metadata:\n      name: auth\n      labels:\n        app: auth\n    spec:\n      containers:\n      - name: auth\n        image: xxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/auth:xxxxx\n        ports:\n        - containerPort: 8080\n```\n\n根据前面的知识我们知道，这份文件会部署 Deployment 会创建 2 个相同的 Pod 副本。另外还会部署一个名为 auth-service 的 Service 资源。这个 Service 暴露了一个 80 端口，并且指向那两个 Pod 的 8080 端口。\n\n而这份文件部署后， Service 资源就会在集群中注册一个 DNS A 记录（或 AAAA 记录），集群内其他 Pod （为了辨别我们叫它 Client ）就可以通过相同的 DNS 名称来访问 Deployment 部署的这 2 个 Pod ：\n\n```sh\ncurl http://auth-service.\u003cnamespace\u003e.svc.cluster.local:80\n# 或者省略掉后面的一大串\ncurl http://auth-service.\u003cnamespace\u003e:80\n# 如果 Client 和 Service 在同一个 Namespace 中，还可以：\ncurl http://auth-service:80\n```\n\n像这样 Client 通过 Service 来访问时，会随机访问到其中一个 Pod ，这样一来无论 Deployment 到底创建了多少个副本，只要副本的标签相同，就能通过同一个 DNS 名称来访问，还能自动实现一些简单的负载均衡。\n\n\u003e **为什么 DNS 名称可以简化？**\n\u003e \n\u003e Pod 被部署时， kubelet 会为每个 Pod 注入一个类似如下的 `/etc/resolv.conf` 文件：\n\u003e \n\u003e ```\n\u003e nameserver 10.32.0.10\n\u003e search \u003cnamespace\u003e.svc.cluster.local svc.cluster.local cluster.local\n\u003e options ndots:5\n\u003e ```\n\u003e \n\u003e Pod 中进行 DNS 查询时，默认会先读取这个文件，然后按照 `search` 选项中的内容展开 DNS 。例如，在 test 名称空间中的 Pod ，访问 data 时的查询可能被展开为 data.test.svc.cluster.local 。\n\u003e 更多关于 `/etc/resolv.conf` 文件的内容可参考 https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html\n\n### Service 的种类\n\n我们上面的例子中，可以看到 Service 资源有个字段 `type:ClusterIP` 。其实 Service 资源有以下几个种类：\n\n| 种类           | 作用                                                                                                                                                                                                                                                                                             |\n| :------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n| `ClusterIP`    | 这个类型的 Service 会在集群内创建一条 DNS A 记录并通过一定方法将流量代理到其指向的 Pod 上。这种 Service 不会暴露到集群外。这是最基础的 Service 种类。                                                                                                                                            |\n| `NodePort`     | 这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并把端口的流量也代理到指向的 Pod 上。可以通过这种方法从集群外访问集群内的资源。                                                                                                                                                |\n| `LoadBalancer` | 这种 Service 会在 ClusterIP 的基础上，在所有节点上各暴露一个端口，并在集群外创建一个负载均衡器来将外部流量路由到暴露的端口，再把流量代理到指向的 Pod 上。这种 Service 一般需要调用云服务提供的 API 或是额外安装的插件。如果什么插件都没安装的话，这种 Service 部署后会与 `NodePort` 的表现一样。 |\n| `ExternalName` | 这种 Service 不需要 selector 字段指定后端，而是用 externalName 字段指定一个外部 DNS 记录，然后将流量全部指向外部服务。如果打算将集群内的服务迁移到集群外、或是集群外迁移到集群内，这种类型的 Service 可以实现无缝迁移。                                                                          |\n\n### 虚拟 IP 与 Headless Service\n\n如果你在集群内尝试对 Service 对应的 DNS 记录进行域名解析，会发现返回来的 IP 地址与 Service 指向的任何一个 Pod 对应的 IP 地址都不相同。如果你还尝试了去 Ping 这个 IP 地址，会发现不能 Ping 通。为什么会这样呢？\n\n原来，每个 Service 被部署后， K8s 都会给他分配一个集群内部的 IP 地址，也就是 Cluster IP （这也是最基础的 Service 种类会起名叫 Cluster IP 的原因）。\n\n但是这个 Cluster IP 不会绑定任何的网卡，是一个虚拟 IP 。然后 K8s 中有一个叫 kube-proxy 的组件（这里叫他做组件，是因为 kube-proxy 与 Service 、 Deployment 等不一样，不是一种资源而是 K8s 的一部分）， kube-proxy 通过修改 iptables ，将虚拟 IP 的流量经过一定的负载均衡规则后代理到 Pod 上。\n\n![K8s 官网上的虚拟 IP 图](https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg)\n\n\u003e **为什么不使用 DNS 轮询？**\n\u003e \n\u003e 为什么 K8s 不配置多条 DNS A 记录，然后通过轮询名称来解析？为什么需要搞出虚拟 IP 这么复杂的东西？这个问题 K8s 官网上也有特别提到原因：\n\u003e \n\u003e - DNS 实现的历史由来已久，它不遵守记录 TTL，并且在名称查找结果到期后对其进行缓存。\n\u003e - 有些应用程序仅执行一次 DNS 查找，并无限期地缓存结果。\n\u003e - 即使应用和库进行了适当的重新解析，DNS 记录上的 TTL 值低或为零也可能会给 DNS 带来高负载，从而使管理变得困难。\n\n有些时候（比如想使用自己的服务发现机制或是自己的负载均衡机制时）我们确实也会想越过虚拟 IP ，直接获取背后 Pod 的 IP 地址。这时候我们可以将 Service 的 `spec.clusterIP` 字段指定为 `None` ，这样 K8s 就不会给这个 Service 分配一个 Cluster IP 。这样的 Service 被称为 **Headless Service** 。\n\nHeadless Service 资源会创建一组 A 记录直接指向背后的 Pod ，可以通过 DNS 轮询等方式直接获得其中一个 Pod 的 IP 地址。另外更重要的一点， Headless Service 还会创建一组 SRV 记录，包含了指向各个 Pod 的 DNS 记录，可以通过 SRV 记录来发现所有 Pod 。\n\n我们可以在集群里用 nsloopup 或 dig 命令去验证一下：\n\n```sh\n# 在集群的 Pod 内部运行\n$ nslookup kafka-headless.kafka.svc.cluster.local\nServer:     10.96.0.10\nAddress:    10.96.0.10#53\n\nName:   kafka-headless.kafka.svc.cluster.local\nAddress: 172.17.0.6\nName:   kafka-headless.kafka.svc.cluster.local\nAddress: 172.17.0.5\nName:   kafka-headless.kafka.svc.cluster.local\nAddress: 172.17.0.4\n\n$ dig SRV kafka-headless.kafka.svc.cluster.local\n# .....\n;; ANSWER SECTION:\nkafka-headless.kafka.svc.cluster.local.      30      IN      SRV     0 20 9092 kafka-0.kafka-headless.kafka.svc.cluster.local.\nkafka-headless.kafka.svc.cluster.local.      30      IN      SRV     0 20 9092 kafka-1.kafka-headless.kafka.svc.cluster.local.\nkakfa-headless.kafka.svc.cluster.local.      30      IN      SRV     0 20 9092 kafka-2.kafka-headless.kafka.svc.cluster.local.\n\n;; ADDITIONAL SECTION:\nkafka-0.kafka-headless.kafka.svc.cluster.local. 30 IN A  172.17.0.6\nkafka-1.kafka-headless.kafka.svc.cluster.local. 30 IN A  172.17.0.5\nkafka-2.kafka-headless.kafka.svc.cluster.local. 30 IN A  172.17.0.4\n```\n\n\u003e 拥有 Cluster IP 的 Service 其实也有 SRV 记录。但这种情况的 SRV 记录中对应的 Target 仍为 Service 自己的 FQDN 。\n\n### 第三次回到 Stateful Set\n\n在上面 Headless Service 的例子中，我们看到，各个 Pod 对应的 DNS A 记录格式为 `\u003cpod_name\u003e.\u003csvc_name\u003e.\u003cnamespace\u003e.svc.cluster.local` 。不对啊，之前的小知识里不是说过 Pod 被分配的 DNS A 记录格式应该是 `172-17-0-3.default.pod.cluster.local` 的吗？\n\n其实 Headless Service 还有一个众所周知的隐藏功能。 Pod 这种资源本身的参数中有 `subdomain` 字段和 `hostname` 字段，如果设置了这两个字段，这个 Pod 就拥有了形如 `\u003chostname\u003e.\u003csubdomain\u003e.\u003cnamespace\u003e.svc.cluster.local` 的 FQDN （全限定域名）。如果这时刚好在同一名称空间下有与 `subdomain` 同名的 Headless Service ， DNS 就会用为这个 Pod 用它的 FQDN 来创建一条 DNS A 记录。\n\n比如 Pod1 在 `kafka` 名称空间中， `hostname` 为 `kafka-1` ， `subdomain` 为 `kafka-headless` ，那么 Pod1 的 FQDN 就是 `kafka-1.kafka-headless.kakfa.svc.cluster.local` 。而同样在 `kafka` 名称空间中，刚好又有一个 `kafka-headless` 的 Headless Service ，那么 DNS 就会创建一条 A 记录，就可以通过 `kafka-1.kafka-headless.kafka.svc.cluster.local` 来访问 Pod1 了。当然，由于 DNS 展开，也可以用 `kafka-1.kafka-headless.kafka` 甚至是 `kafka-1.kafka-headless` 来访问这个 Pod 。\n\n其实这些 Pod 是用 Stateful Set 来部署的，这一部分其实是 Stateful Set 相关的功能。之前我们说到 Stateful Set 有唯一稳定的网络标识。我们现在就来详细讲讲，这“唯一稳定的网络标识”到底是在指什么。\n\n我们来看一下这个 kafka Stateful Set 到底是怎么部署的：\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: kafka-headless\nspec:\n  clusterIP: None # 这是一个 headless service\n  ports:\n  - name: tcp-client\n    port: 9092\n    protocol: TCP\n    targetPort: kafka-client\n  selector:\n    select-label: kafka-label\n  type: ClusterIP\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: kafka\nspec:\n  replicas: 3\n  serviceName: kafka-headless # 注意到这里有 serviceName 字段\n  selector:\n    matchLabels:\n      select-label: kafka-label\n  template:\n    metadata:\n      labels:\n        select-label: kafka-label\n    spec:\n      containers:\n      - name: kafka\n        image: docker.io/bitnami/kafka:3.1.0-debian-10-r52\n        # 接下来 Pod 相关部分省略\n  # 下面 Volume 相关部分也省略\n```\n\n我们看到， Stateful Set 的定义中必须要用 `spec.serviceName` 字段指定一个 Headless Service 。 Stateful Set 创建 Pod 时，会自动给 Pod 指定 `hostname` 和 `subdomain` 字段。这样一来，每个 Pod 才有了唯一固定的 hostname ，唯一固定的 FQDN ，以及通过与 Headless Service 共同部署而获得唯一固定的 A 记录。（此外，其实当 Pod 因为版本升级等原因被重新创建时，相同序号的 Pod 还会被分配到相同固定的集群内 IP 。）\n\n\u003e **关于 Stateful Set 中 `serviceName` 字段的争议**\n\u003e \n\u003e Stateful Set 中的 serviceName 字段是必填字段。这个字段唯一的作用其实就是给 Pod 指定 subdomain 。其实这样会有一些问题：\n\u003e \n\u003e 1. Stateful Set 部署时不会检查是否真的存在这么一个 Headless Service 。如果 serviceName 乱填一个值，会导致虽然 Pod 的 `hostname` 和 `subdomain` 都指定了却没有创建 A 记录的情况。\n\u003e 2. 有时 Stateful Set 的 Pod 不需要接收流量，也不需要相互发现，这时候还强行需要指定一个 serviceName 显得有点多余。\n\u003e \n\u003e 在 GitHub 上有关于这个问题的 Issue ： https://github.com/kubernetes/kubernetes/issues/69608\n\n### 从集群外部访问\n\n在 K8s 集群里把应用部署好了，可是如何让集群外部的客户端访问我们集群中的应用呢？这可能是大家最关心的问题。\n\n不过有认真听的同学估计已经有这个问题的答案了。之前我们讲过 NodePort 和 LoadBalancer 这两种 Service 类型。\n\n其中 NodePort Service 只是简单地在节点机器上各开一个端口，而如何路由、如何负载均衡等则一概不管。\n\n而 LoadBalancer Service 则是在 NodePort 的基础上再加一个一个负载均衡器，然后把节点暴露的端口注册到这个负载均衡器上。这样一来，集群外部的客户端就可以通过同一个 IP 来访问集群中的应用。但是要使用 LoadBalancer Service ，一般需要先安装云供应商提供的 Controller ，或是安装其他第三方的 Controller （比如 Nginx Controller ）。\n\n在 Service 之外还另有一种资源类型叫 Ingress ，也可以用来实现集群外部访问集群内部应用的功能。 Ingress 其实也会在集群外创建一个负载均衡器，因此也需要预先安装云供应商的 Controller 。但 Ingress 与 Service 不同的是，它还会管理一定的路由逻辑，接收流量后可以根据路由来分配给不同的 Service 。\n\n| 类型                 | OSI 模型工作层数 | 依赖于云平台或其他插件 |\n| :------------------- | :--------------- | :--------------------- |\n| NodePort Service     | 第四层           | 否                     |\n| LoadBalancer Service | 第四层           | 是                     |\n| Ingress              | 第七层           | 是                     |\n\n特别再详细说一下 Ingress 这种资源。 Ingress 本身不会在集群内的 DNS 上创建记录，一般也不会主动去路由集群内的流量（除非你在集群内强行访问 Ingress 的负载均衡器…… 不过一般也没什么理由要这样做对吧）。但 Ingress 可以根据 HTTP 的 hostname 和 path 来路由流量，把流量分发到不同的 Service 上。 Ingress 也是 K8s 的原生资源里唯一能看到 OSI 第七层的资源。\n\n下面是 AWS 的 EKS 服务中部署的一个 Ingress 的例子（集群中已安装 AWS Load Balancer Controller ）：\n\n```yaml\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: alb\n    alb.ingress.kubernetes.io/scheme: internet-facing\n    alb.ingress.kubernetes.io/target-type: ip\n    alb.ingress.kubernetes.io/backend-protocol-version: GRPC\n    alb.ingress.kubernetes.io/listen-ports: '[{\"HTTPS\":443}]'\n    alb.ingress.kubernetes.io/healthcheck-path: /grpc.health.v1.Health/Check\n    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP\n    alb.ingress.kubernetes.io/success-codes: 0,12\n    alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:xxxxxxxxxx:certificate/xxxxxxxxxx\n\n    external-dns.alpha.kubernetes.io/hostname: sample.example.com\n  \n  name: gateway-ingress\nspec:\n  rules:\n  - host: sample.example.com\n    http:\n      paths:\n      - path: /grpc.health.v1.Health\n        pathType: Prefix\n        backend:\n          service:\n            name: health-service\n            port:\n              number: 50051\n      - path: /proto.sample.v1.Sample\n        pathType: Prefix\n        backend:\n          service:\n            name: sample-service\n            port:\n              number: 50051\n```\n\n可以看到， Ingress 资源可以通过 `spec.rules` 字段中定义各条规则，通过 hostname 或是 path 等第七层的信息来进行路由。 Ingress 部署下去后， AWS Load Balancer Controller 会读取会根据的配置，并在云上创建一个 AWS Application Load Balancer （ALB），而 `spec.rules` 会应用到 ALB 上，由 ALB 来负责流量的路由。\n\n我们也会注意到，怎么 `metadata.annotations` 里有这么多奇奇怪怪的字段！ Ingress 本身的功能都是 AWS Load Balancer Controller 调用 AWS 的 API 创建 ALB 来实现的。但 AWS 的 ALB 能实现的功能可不止 Ingress 字段定义的这些，比如安装 TLS 证书、 health check 等 spec 字段中描述不下的功能，就只能是通过 annotation 的形式来定义了。\n\n\u003e 小彩蛋：可以看到例子中的 Ingress 资源 annotation 字段里还有一行 `external-dns.alpha.kubernetes.io/hostname: sample.example.com` 。其实这个 K8s 集群中还安装了 external-dns 这个应用，它可以根据 annotation 来在外部 DNS 上直接创建 DNS 记录！有了这个插件我们可不用再慢慢打开公共 DNS 管理页面，再小心翼翼地记下 IP 地址去添加 A 记录了。\n\n# 更高级的部署方式（一）\n\n一路说道这里， K8s 中最基础的资源大部分都已经介绍了。但是，这么多资源之间又需要相互配合，只部署一种资源基本没什么生产能力。\n\n比如只部署 Deployment 的话，我们确实是能在一组多副本的 Pod 里跑起可执行程序，但这组 Pod 却几乎没办法接受集群里其他 Pod 的流量（只能通过制定 Pod 的 IP 来访问，但 Pod 的 IP 是会变的）。因此一般来说一个 Deployment 都会搭配一个 Service 来使用。这还是最简单的一种搭配了。\n\n假若我们现在要在自己的 K8s 里安装一个别人提供的应用。当然由于 K8s 是基于容器的，只要别人提供了他应用的 yaml 清单，我们只用把清单用 `kubectl apply -f` 提交给 K8s ，然后让 K8s 把清单中的镜像拉下来就能跑了。可如果我们需要根据环境来改一些参数呢？\n\n如果别人提供的 yaml 文件比较简单还好说，改改对应的字段就好了。如果别人的应用比较复杂，那改 yaml 文件可就是一个大难题了。比如 AWS 的 Load Balancer Controller ，它的 yaml 清单文件可是多达 939 行！\n\n[[aws-elb-controller-lines.png]]\n\n在这种复杂的场景下，我们就需要一些更高级的部署方式了。\n\n### Helm\n\n首先来介绍的是 Helm 。 Helm 是一个包管理工具，可以类比一下 CentOS 中的 yum 工具。它可以把一组 K8s 资源发布成一个 Chart ，然后我们可以用 Helm 来安装这个 Chart ，并且可以通过参数设值来改变 Chart 中的部分资源。利用 Helm 安装 Chart 后还可以管理 Chart 的升级、回滚、卸载。\n\n使用别人提供的 Helm Chart 前，需要先 add 一下 Chart 的仓库，然后再安装仓库里提供的 Chart 。比如我们要安装 bitnami 提供的 Kafka Chart 时：\n\n```bash\n# 添加 https://charts.bitnami.com/bitnami 这个仓库，命名为 bitnami\nhelm repo add bitnami https://charts.bitnami.com/bitnami\n\n# 在 kafka 名称空间里安装 bitnami 仓库里的 kafka Chart ，并通过参数设置为 3 个副本，并同时安装一个 3 副本的 Zookeeper\nhelm install kafka -n kafka \\\n  --set replicaCount=3 \\\n  --set zookeeper.enabled=true \\\n  --set zookeeper.replicaCount=3 \\\n  bitnami/kafka\n```\n\n命令执行后， helm 就会根据参数与 Chart 的内容，在 K8s 里安装 StatefulSet 、 Service 、 ConfigMap 等一切所需要的资源。\n\n```sh\n$ k -n kafka get all,cm\nNAME                    READY   STATUS    RESTARTS      AGE\npod/kafka-0             1/1     Running   1             46d\npod/kafka-1             1/1     Running   3             46d\npod/kafka-2             1/1     Running   3             46d\npod/kafka-zookeeper-0   1/1     Running   0             46d\npod/kafka-zookeeper-1   1/1     Running   0             46d\npod/kafka-zookeeper-2   1/1     Running   0             46d\n\nNAME                               TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)                      AGE\nservice/kafka                      ClusterIP      172.20.1.196     \u003cnone\u003e           9092/TCP                     164d\nservice/kafka-headless             ClusterIP      None             \u003cnone\u003e           9092/TCP,9093/TCP            164d\nservice/kafka-zookeeper            ClusterIP      172.20.227.236   \u003cnone\u003e           2181/TCP,2888/TCP,3888/TCP   164d\nservice/kafka-zookeeper-headless   ClusterIP      None             \u003cnone\u003e           2181/TCP,2888/TCP,3888/TCP   164d\n\nNAME                               READY   AGE\nstatefulset.apps/kafka             3/3     164d\nstatefulset.apps/kafka-zookeeper   3/3     164d\n\nNAME                                DATA   AGE\nconfigmap/kafka-scripts             2      164d\nconfigmap/kafka-zookeeper-scripts   2      164d\nconfigmap/kube-root-ca.crt          1      165d\n```\n\n甚至， Helm 可以通过模板生成的 Pod 环境变量，来预先设置好 Kafka 的配置，让他找得到 Zookeeper 服务：\n\n```yaml\napiVersion: v1\nkind: Pod\n# 略去无关信息\nspec:\n  containers:\n  - name: kafka\n    command:\n    - /scripts/setup.sh\n    env:\n    - name: KAFKA_CFG_ZOOKEEPER_CONNECT\n      value: kafka-zookeeper\n    # ...\n```\n\n通过设置 `KAFKA_CFG_ZOOKEEPER_CONNECT` 这个环境变量，指定了 Kafka Broker 可以通过访问 `kafka-zookeeper` 来找到 zookeeper 服务。（还记得 zookeeper 的 Service 名字是 `kafka-zookeeper` 吗？ zookeeper 与 kafka 部署在同一个名称空间里，因此可以直接通过 Service 名访问。）\n\n如果我们打开这个 helm chart 对应的[代码仓库](https://github.com/bitnami/charts/tree/master/bitnami/kafka)，会发现原来有一组 go template 文件，以及一个 `values.yaml` 文件和 `Chart.yaml` 文件：\n\n```sh\n.\n├── Chart.lock\n├── Chart.yaml\n├── README.md\n├── templates\n│   ├── NOTES.txt # 这里定义的是 helm 工具的命令行信息\n│   ├── _helpers.tpl # 这里面是一些定义好的 go template 代码块可以供其他模板使用\n│   ├── configmap.yaml\n│   ├── statefulset.yaml\n│   ├── svc-headless.yaml\n│   ├── svc.yaml\n│   └── # 以下省略若干模板文件\n└── values.yaml\n```\n\n- `Chart.yaml` 中定义了这个 Chart 的基本信息，包括名称、版本、描述、依赖等。\n- `values.yaml` 中定义了这个 Chart 的默认参数，包括各种资源的默认配置、副本数量、镜像版本等。其中的值都可以通过 `helm install` 命令的 `--set` 参数来覆盖。\n- `templates/` 文件夹下的都是 go template 的模板文件。\n\n`helm install` 就是通过用 `values.yaml` 中预定义的参数，渲染 `templates/` 文件夹下的 go template 文件，生成最终的 yaml 文件，然后再通过 kubectl apply -f 的方式，将 yaml 文件里的资源部署到 K8s 里。然后通过忘资源里注入一些特殊 annotation 的方式来记住自己部署了那些资源，进而提供 `update` 、 `uninstall` 等功能。\n\n关于更多 Helm 的内容，可以参考[官方文档](https://helm.sh/docs/)。\n\n### Kustomize\n\n另一个部署工具是 Kustomize 。之前提到 Config Map 时的例子中，将配置文件的内容直接写进了 yaml 清单的一个字段里：\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: game-demo\ndata:\n  # 一个 Key 可以对应一个值\n  player_initial_lives: \"3\"\n  ui_properties_file_name: \"user-interface.properties\"\n\n  # 一个 Key 也可以对应一个文件的内容\n  game.properties: |\n    enemy.types=aliens,monsters\n    player.maximum-lives=5    \n  user-interface.properties: |\n    color.good=purple\n    color.bad=yellow\n    allow.textmode=true    \n```\n\n其实这样很不好，先不说这样写没办法在 IDE 里用配置文件自己的语法检查，每行还需要一定的缩进，如果配置文件有好几百行，你甚至会忘了这一行到底是哪个配置文件！此时我们就会自然而然的想把每个配置文件以单独文件的形式保存。\n\nKustomize 就是这样一个工具，它可以帮助我们把每个配置文件以单独文件的形式保存，然后再通过一个 `kustomization.yaml` 文件，将这些配置文件组合起来，生成最终的 yaml 文件。\n\n```yaml\napiVersion: kustomize.config.k8s.io/v1beta1\nkind: Kustomization\nresources:\n  # 其他资源也可以单独使用一个文件定义\n  - deployment.yaml\n\n# 用 configMapGenerator 从文件中生成 ConfigMap\nconfigMapGenerator:\n  - name: game-demo\n    literals:\n      - \"ui_properties_file_name=user-interface.properties\"\n      - \"player_initial_lives=3\"\n    # 从文件中读取内容\n    files:\n      - game.properties\n      - user-interface.properties\n# 有多个 configMap 时，可以通过统一的 generatorOptions 来设置一些通用的选项\ngeneratorOptions:\n  disableNameSuffixHash: true\n```\n\n然后两个配置文件的内容可以单独用文件定义，此时可以结合 IDE 的语法检查，以及代码补全功能，来编写配置文件。\n\n```properties\n# user-interface.properties\ncolor.good=purple\ncolor.bad=yellow\nallow.textmode=true    \n```\n\n然后将 `kustomization.yaml` 和其他所需的文件都放在同一个目录下：\n\n```bash\n.\n├── kustomization.yaml\n├── deployment.yaml\n├── game.properties\n└── user-interface.properties\n```\n\n然后就可以通过 `kubectl apply -k ./` 来将整个 kustomize 文件夹转换为 yaml 清单直接部署到 K8s 中。\n（没错，现在 Kustomize 已经成为 kubectl 中的内置功能！可以不用先 `kustomize build` 生成 yaml 文件再 `kubectl apply` 两步走了！）\n\n值得提醒的是，虽然 `kustomization.yaml` 有 `apiVersion` 和 `kind` 字段，长得很像一个资源清单，但其实 K8s 的 API server 并不认识他。 Kustomize 的工作原理其实是先根据 `kustomization.yaml` 生成 K8s 认识的 yaml 资源清单，然后再通过 `kubectl apply` 来部署。\n\n除了可以直接将 ConfigMap 与 Secret 中的文件字段内容用单独的文件定义外， Kustomize 还有其他比如为部署的资源添加统一的名称前缀、添加统一字段等功能。这些大家可以阅读 Kustomize 的[官方文档](https://kubernetes.io/docs/tasks/manage-kubernetes-objects/kustomization/)来了解。\n\n### 各种工具的优缺点\n\n我们目前已经知道有三种在 K8s 中部署资源的方式： `kubectl apply`、Helm 和 Kustomize 。\n\n其中 `kubectl apply` 的优缺点很明确，优点是最简单直接，缺点是会导致要么 yaml 清单过长，要么需要分多文件多次部署，使集群中产生中间状态。\n\n而 Helm 与 Kustomize 我们上面也分析过，其实都是基于 `kubectl apply` 的。 Helm 是通过 go template 先生成 yaml 文件再 `kubectl apply` ，而 Kustomize 是通过 `kustomization.yaml` 中的定义用自己的一套逻辑生成 yaml 文件，然后再 `kubectl apply` 。\n\nHelm 的优点是 Helm Chart 安装时可以直接使用别人 Helm 仓库中已经上传好的 Chart ，只需要设置参数就可以使用。这也是 Kustomize 的缺点：如果想要使用别人提供的 Kustomization 而只修改其中的一些配置，必须要先把放 `kustomization.yaml` 的整个文件夹下载下来才能做修改。\n\n而 Helm 的缺点也是明显的， Helm 依赖于往资源里注入特殊的 annotation 来管理 Chart 生成的资源，这可能会很难与集群中现有的一些系统（比如 Service Mesh 或是 GitOps 系统等）放一起管理。而 Kustomize 生成的 yaml 清单就是很干净的 K8s 资源，原先的 K8s 资源该是什么表现就是什么表现，与现有的系统兼容一般会比较好。\n\n而另外，由于 Helm 与 Kustomize 都是基于 `kubectl apply` 的，因此他们有共同的缺点，就是不能做 `kubectl apply` 不能做的事情。\n\n什么叫 `kubectl apply` 不能做的事情呢？比如说我们要在 K8s 中部署 Redis 集群。聪明的你可能就想到要用 Stateful Set 、 PVC 、 Headless Service 来一套组合拳。这确实可以部署一个多节点、有状态的 Redis Cluster 。可是如果我们要往 Redis Cluster 里加一个节点呢？\n\n你当然可以把 Stateful Set 中的 `Replicas` 字段加个 1 然后用 `kubectl apply` 部署，可是这实际上只能增加一个一个 Redis 实例 —— 然后什么都没发生。其他节点不认识这个新的节点，访问这个新节点也不能拿到正确的数据。要知道往 Redis Cluster 里加节点，是要先让集群发现这个新节点，然后还要迁移 slot 的！ `kubectl apply` 可不会做这些事。\n\n\u003e Well, 其实这些也是可以通过增加 initContainer 、修改镜像增加启动脚本等方式，实现用 `kubectl apply` 部署的。可是，这会让整个 Pod 资源变得很难理解，也不好维护。而且，如果不是因为做不到，谁会想去修改别人的镜像呢？\n\n我们接下来会介绍 K8s 的核心架构，来理解我们之前讲的这些资源到底是怎么工作的。最后会引出一组新的概念： Operator 与自定义资源（ Custom Resource Definition ，简称 CRD ）。通过 Operator 与 CRD ，我们可以做到 `kubectl apply` 所不能做到的事，包括 Redis Cluster 的扩容。\n\n\u003e DIO: `kubectl apply` 的能力是有限的……\n\u003e 越是部署复杂的应用，就越会发现 `kubectl apply` 的能力是有极限的……除非超越 `kubectl apply` 。\n\u003e \n\u003e JOJO: 你到底想说什么？\n\u003e \n\u003e DIO: 我不用 `kubectl apply` 了！ JOJO ！\n\u003e （其实还是要用的）\n\n","title":"Kubernetes 入门 （2）","abstract":"我们之前说的都是用于部署 Pod 的资源，我们接下来介绍与创建 Pod 不相关的资源：储存与网络。\n其实我们之前已经接触过储存相关的内容了：在讲 Stateful Set 时我们提过 Stateful Set 创建出来的 Pod 都会有相互独立的储存；而讲 Daemon Set 时我们提到 K8s 推荐只在 Daemon Set 的 Pod 中访问宿主机磁盘。但独立的储存具体指什么？除了访问宿主机磁盘以外还有什么其他的储存？\n在 Docker 中，我们可以把宿主机磁盘上的一个路径作为一个 Volume 来给容器绑定，或者直接使用 Docker Engine 管理的 Volume 来提供持久化存储或是容器间共享文件。在 K8s 里面也沿用了 Volume 这个概念，可以通过 Mount 绑定到容器内的路径，并通过实现 CSI 的各种引擎来提供更多样的存储。","length":875,"created_at":"2022-08-20T21:56:52.000Z","updated_at":"2022-08-20T14:02:18.000Z","tags":["Kubernetes","DevOps","Docker","Cloud Native"],"license":true,"headingTrees":[{"key":"储存","href":"#储存","heading":1,"title":"储存","children":[{"key":"k8s-中使用-volume-与可用的-volume-类型","href":"#k8s-中使用-volume-与可用的-volume-类型","heading":3,"title":"K8s 中使用 Volume 与可用的 Volume 类型","children":[],"id":"k8s-中使用-volume-与可用的-volume-类型"},{"key":"presistent-volume--presistent-volume-claim--storage-class","href":"#presistent-volume--presistent-volume-claim--storage-class","heading":3,"title":"Presistent Volume 、 Presistent Volume Claim 、 Storage Class","children":[],"id":"presistent-volume--presistent-volume-claim--storage-class"},{"key":"再说回-stateful-set","href":"#再说回-stateful-set","heading":3,"title":"再说回 Stateful Set","children":[],"id":"再说回-stateful-set"},{"key":"configmap-与-secret-挂载作为特殊的卷","href":"#configmap-与-secret-挂载作为特殊的卷","heading":3,"title":"ConfigMap 与 Secret 挂载作为特殊的卷","children":[],"id":"configmap-与-secret-挂载作为特殊的卷"}],"id":"储存"},{"key":"网络","href":"#网络","heading":1,"title":"网络","children":[{"key":"service","href":"#service","heading":3,"title":"Service","children":[],"id":"service"},{"key":"service-的种类","href":"#service-的种类","heading":3,"title":"Service 的种类","children":[],"id":"service-的种类"},{"key":"虚拟-ip-与-headless-service","href":"#虚拟-ip-与-headless-service","heading":3,"title":"虚拟 IP 与 Headless Service","children":[],"id":"虚拟-ip-与-headless-service"},{"key":"第三次回到-stateful-set","href":"#第三次回到-stateful-set","heading":3,"title":"第三次回到 Stateful Set","children":[],"id":"第三次回到-stateful-set"},{"key":"从集群外部访问","href":"#从集群外部访问","heading":3,"title":"从集群外部访问","children":[],"id":"从集群外部访问"}],"id":"网络"},{"key":"更高级的部署方式一","href":"#更高级的部署方式一","heading":1,"title":"更高级的部署方式（一）","children":[{"key":"helm","href":"#helm","heading":3,"title":"Helm","children":[],"id":"helm"},{"key":"kustomize","href":"#kustomize","heading":3,"title":"Kustomize","children":[],"id":"kustomize"},{"key":"各种工具的优缺点","href":"#各种工具的优缺点","heading":3,"title":"各种工具的优缺点","children":[],"id":"各种工具的优缺点"}],"id":"更高级的部署方式一"}],"wikiRefAliases":["aws-elb-controller-lines.png"],"richRefAliases":[]},"prevNextInfo":{"prevInfo":{"pathMapping":{"pagePath":"/articles/try-cursor-and-thinking","filePath":"public/content/articles/2024-11-16-try-cursor-and-thinking.md"},"meta":{"title":"尝试 Cursor 的感想和一些思考","created_at":"2024-11-16T15:42:00.000Z","updated_at":"2024-11-16T15:42:00.000Z"}},"nextInfo":{"pathMapping":{"pagePath":"/articles/introduction-for-k8s","filePath":"public/content/articles/2022-08-13-introduction-for-k8s.md"},"meta":{"title":"Kubernetes 入门 （1）","created_at":"2022-08-13T17:45:31.000Z","updated_at":"2022-08-20T14:02:18.000Z"}}},"backRefResources":[{"pathMapping":{"filePath":"public/content/ideas/blog-syntax.md","pagePath":"/ideas/blog-syntax","slug":"blog-syntax"},"meta":{"content":"\n# 一级标题\n\n## 二级标题\n\n### 三级标题\n\n#### 四级标题\n\n##### 五级标题\n\n###### 六级标题\n\n**加粗**\n\n*斜体*\n\n_斜体2_\n\n***加粗斜体***\n\n**_加粗斜体2_**\n\n~~删除线~~\n\n==高亮==\n\n\u003e 引用\n\n# 其他 MD 语法\n\n## 代码块\n\n`行内代码`\n\n代码块高亮：\n\n```python\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n大围栏\n\n````markdown\n```\ndef func_echo(s: str):\n    print(s)\n```\n````\n\n行内反引号围栏： `` ` `` 或者 ``` `` ``` 的模式\n\n```markdown\n`段落反引号内的行内反引号`\n```\n\n#### Rehype Pretty 语法：\n\n名称显示，captions 显示：\n\n```python title=\"main.py\" caption=\"这是一段描述\"\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n高亮\n\n```python {1-3,5}#a {4}#b {7} /printer/#c \"Callable\"#a /func_echo/#1\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n行号\n\n```python showLineNumbers{998}\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n```\n\n## 列表\n\n- 无序列表\n  - 无序列表\n    - 无序列表\n    - 无序列表\n\n1. 有序列表\n2. 有序列表\n3. 有序列表\n   1. 有序列表\n   2. 有序列表\n      1. 有序列表\n      2. 有序列表\n\n- [ ] 未完成\n- [x] 已完成\n  - [x] 已完成\n    - [ ] 未完成\n\n- 交叉嵌套\n  - [ ] 未完成\n  - [x] 已完成\n    1. 有序列表\n    2. 有序列表\n\n- [ ] 交叉嵌套 2\n  1. 有序列表\n  2. 有序列表\n     - 无序列表\n     - 无序列表\n\n1. 交叉嵌套\n2. 交叉嵌套\n   - 无序列表\n   - 无序列表\n     - [ ] 未完成\n     - [x] 已完成\n\n## Quote Block\n\n\u003e 这是一个 Quote Block\n\u003e\n\u003e 里面可以有多行数据\n\n## 链接\n\n[链接](https://blog.ryo-okami.xyz)\n\n[站内链接](/ideas/using-chart-js)\n\n## 图片\n\n图片：\n\n![图片](https://blog.ryo-okami.xyz/content/articles/2022-07-31-why-homogeneous/OnOneLineWillStillOneLine_ManimCE_v0.16.0.post0.gif)\n\n站内图片：\n\n![站内图片](/content/articles/2022-07-31-why-homogeneous/OnOneLineWillStillOneLine_ManimCE_v0.16.0.post0.gif)\n\n## 表格\n\n| 表头     | 表头     | 表头     |\n| -------- | -------- | -------- |\n| ~~删除~~ | ==高亮== | **加粗** |\n| 单元     | 单元     | _斜体_   |\n\n## 脚注\n\n下标[^1]\n\n[^1]: 注释\n\n# 插件\n\n## Katex\n\n行间公式\n\n$$\n\\begin{aligned}\n\\dot{x} \u0026 = \\sigma(y-x) \\\\\n\\dot{y} \u0026 = \\rho x - y - xz \\\\\n\\dot{z} \u0026 = -\\beta z + xy\n\\end{aligned}\n$$\n\n行内公式 $E=mc^2$\n\n## Mermaid\n\nmermaid 流程图\n\n```mermaid\ngraph LR\n  A[方形] --\u003e B(圆角)\n  B --\u003e C{条件}\n  C --\u003e|a=1| D[结果1]\n  C --\u003e|a=2| E[结果2]\n  C --\u003e|a=3| F[结果3]\n```\n\n另一个 mermaid 流程图，同样类型不会冲突\n\n```mermaid\ngraph TD\n  A((圆)) --\u003e B([圆边])\n  B --\u003e C[(DB)]\n```\n\nmermaid 时序图\n\n```mermaid\nsequenceDiagram\n  participant Alice\n  participant Bob\n  Alice-\u003e\u003eJohn: Hello John, how are you?\n  loop Healthcheck\n    John-\u003e\u003eJohn: Fight against hypochondria\n  end\n  Note right of John: Rational thoughts \u003cbr/\u003eprevail...\n  John--\u003e\u003eAlice: Great!\n  John-\u003e\u003eBob: How about you?\n  Bob--\u003e\u003eJohn: Jolly good!\n```\n\n## Jessie Code 几何图形\n\n简单 Jessie Code\n\n```jessiecode\nA = point(1, 0);\nB = point(-1, 0);\nC = point(0.2, 1.5);\nL_AB = line(A, B);\nL_AC = line(A, C);\nK_ABC = circle(A, B, C);\n```\n\n可以有多个 Jessie Code 代码块\n\n```jessiecode\n$board.setView([-1.5, 2, 1.5, -1]);\n\n// Triangle ABC\nA = point(1, 0);\nB = point(-1, 0);\nC = point(0.2, 1.5);\npol = polygon(A,B,C) \u003c\u003c\n        fillColor: '#FFFF00',\n        borders: \u003c\u003c\n            strokeWidth: 1,\n            strokeColor: '#C0C000'\n        \u003e\u003e\n    \u003e\u003e;\n \n// Perpendiculars and orthocenter i1\npABC = perpendicular(pol.borders[0], C) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\npBCA = perpendicular(pol.borders[1], A) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\npCAB = perpendicular(pol.borders[2], B) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\ni1 = intersection(pABC, pCAB, 0);\n\n// Midpoints of segments\nmAB = midpoint(A, B);\nmBC = midpoint(B, C);\nmCA = midpoint(C, A);\n \n// Line bisectors and centroid i2\nma = segment(mBC, A) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\nmb = segment(mCA, B) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\nmc = segment(mAB, C) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\ni2 = intersection(ma, mc, 0);\n \n// Circum circle and circum center\nc = circumcircle(A, B, C) \u003c\u003c\n        strokeColor: '#000000',\n        dash: 3,\n        strokeWidth: 1,\n        center: \u003c\u003c\n            name: 'i_3',\n            withlabel:true,\n            visible: true\n        \u003e\u003e\n    \u003e\u003e;\n \n// Euler line \neuler = line(i1, i2) \u003c\u003c\n        strokeWidth: 2,\n        strokeColor:'#C01B37'\n    \u003e\u003e;\n```\n\nFunction Graph 也可在 Jessie Code 中使用\n\n```jessiecode\nFFunc = function(x) {\n    return sin(x);\n};\nF = functiongraph(FFunc, -10, 10);\n\nP1 = point(0, 0);\nP2 = point(1, 2);\n\na = function () {\n    return P2.X() - P1.X();\n};\n\nb = function () {\n    return P2.Y() - P1.Y();\n};\n\nGFunc = function(x) {\n    return b() * sin(PI * ( x - P1.X() ) / 2 / a() ) + P1.Y();\n};\nG = functiongraph(GFunc, -10, 10);\n\n\nInterFunc = function(i, x) {\n  return FFunc(x) * i / 10 + GFunc(x) * (1 - i / 10);\n};\n\nH1 = functiongraph(function(x) {\n  return InterFunc(1, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH2 = functiongraph(function(x) {\n  return InterFunc(2, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH3 = functiongraph(function(x) {\n  return InterFunc(3, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH4 = functiongraph(function(x) {\n  return InterFunc(4, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH5 = functiongraph(function(x) {\n  return InterFunc(5, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH6 = functiongraph(function(x) {\n  return InterFunc(6, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH7 = functiongraph(function(x) {\n  return InterFunc(7, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH8 = functiongraph(function(x) {\n  return InterFunc(8, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH9 = functiongraph(function(x) {\n  return InterFunc(9, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n```\n\n可以以 frontmatter 形式指定 board 参数\n\n```jessiecode\n---\nboundingbox: [-1, 2, 2, -1]\ngrid: true\naxis: false\n---\nA = point(0, 0);\nB = point(1, 0);\nC = point(0, 1);\nL_AB = line(A, B);\nL_AC = line(A, C);\nK_ABC = circle(A, B, C);\n```\n\n## Heading 引用\n\n点击能够跳转：\n\n[文章内标题引用](#一级标题)\n\n[跨文章标题引用](/ideas/using-chart-js#react-chartjs-2)\n\n# Obsidian\n\n## Wikilink\n\n### 站内短引用\n\n[[2022-08-13-introduction-for-k8s]]\n\n可以去掉路径中的日期 [[introduction-for-k8s]] 作为 page path 引用\n\n带 label [[2022-08-13-introduction-for-k8s|其他文章]]\n\n带 fragment [[2022-08-13-introduction-for-k8s#部署一个-pod|其他文章]]\n\n带路径 [[articles/2022-08-13-introduction-for-k8s|其他文章]]\n\nPage path 全路径 [[/articles/introduction-for-k8s|其他文章]]\n\nfile path 全路径 [[public/content/articles/2022-08-13-introduction-for-k8s|其他文章]]\n\n一行多个 [[2022-08-13-introduction-for-k8s|其他文章]] [[2022-08-20-introduction-for-k8s-2|其他文章2]]\n\n\u003e 目前未实现 Obsidian Anchor 直接引用到块或标题\n\n## Rich Content 短引用\n\n### 图片短引用\n\n短引用图片，纯文件名\n\n![[test-img-show-image.png]]\n\n短引用图片，带注释\n\n![[test-img-show-image.png|这是一张图片]]\n\n短引用图片，带路径\n\n![[blog-syntax/test-img-show-image.png]]\n\n短引用图片，带路径和注释\n\n![[blog-syntax/test-img-show-image.png|这是一张图片]]\n\n短引用图片，全路径\n\n![[/content/ideas/blog-syntax/test-img-show-image.png]]\n\n### Excalidraw 短引用\n\n短引用 Excalidraw\n\n![[Drawing 2024-04-13 17.33.27.excalidraw]]\n\n## Callouts\n\n\u003e [!note]\n\u003e\n\u003e Note 级\n\n\u003e [!info]\n\u003e\n\u003e Callout 里是正常的 markdown 语法\n\u003e ```markdown\n\u003e \u003e [!info]\n\u003e \u003e\n\u003e \u003e Callout 里是正常的 markdown 语法\n\u003e ```\n\n\u003e [!tip] 标题\n\u003e\n\u003e Tip 级带标题\n\n\u003e [!faq]- 可折叠 Callout\n\u003e\n\u003e 是的，这是 faq 级 callout 。可折叠 Callout 在折叠时隐藏内容。\n\n\u003e [!faq]+ 默认打开的可折叠 Callout\n\u003e\n\u003e 可折叠 Callout 也可以设置为默认打开。\n\n\u003e [!question] 可以嵌套吗？\n\u003e\n\u003e \u003e [!todo] 是的，可以。\n\u003e \u003e \u003e [!example] 你可以使用多层嵌套。\n\u003e \u003e \u003e 在最里面也可以使用 markdown 语法\n\u003e\n\u003e \u003e [!tip]- 还可以嵌套其他 Obsidian 语法\n\u003e \u003e 比如==高亮==，也可以嵌套 wikilink [[introduction-for-k8s]]\n\u003e \u003e\n\u003e \u003e 或者嵌套 Embeded 图片\n\u003e \u003e\n\u003e \u003e ![[test-img-show-image.png]]\n\u003e \u003e\n\u003e \u003e 也可以嵌套 mermaid 图表\n\u003e \u003e\n\u003e \u003e ```mermaid\n\u003e \u003e graph TD\n\u003e \u003e A[Start] --\u003e B[Process]\n\u003e \u003e B --\u003e C[End]\n\u003e \u003e ```\n\u003e \u003e\n\u003e \u003e 也可以嵌套 Excalidraw\n\u003e \u003e\n\u003e \u003e ![[Drawing 2024-04-13 17.33.27.excalidraw]]\n\u003e \u003e\n\u003e \u003e 也可以是 Tag #Tag1 #Tag2\n\u003e \u003e\n\u003e \u003e #单行Tag\n\u003e\n\n\u003e [!abstract]-\n\u003e Abstract 级\n\n\u003e [!summary]-\n\u003e Summary 级, 是 abstract 的 alias\n\n\u003e [!tldr]-\n\u003e TL;DR 级, 是 summary 的 alias\n\n\u003e [!info]-\n\u003e Info 级\n\n\u003e [!todo]-\n\u003e Todo 级\n\n\u003e [!tip]-\n\u003e Tip 级\n\n\u003e [!hint]-\n\u003e Hint 级, 是 tip 的 alias\n\n\u003e [!important]-\n\u003e Important 级, 是 tip 的 alias\n\n\u003e [!success]-\n\u003e Success 级\n\n\u003e [!check]-\n\u003e Check 级, 是 success 的 alias\n\n\u003e [!done]-\n\u003e Done 级, 是 success 的 alias\n\n\u003e [!question]-\n\u003e Question 级\n\n\u003e [!help]-\n\u003e Help 级, 是 question 的 alias\n\n\u003e [!faq]-\n\u003e Faq 级, 是 question 的 alias\n\n\u003e [!warning]-\n\u003e Warning 级\n\n\u003e [!caution]-\n\u003e Caution 级, 是 warning 的 alias\n\n\u003e [!attention]-\n\u003e Attention 级, 是 caution 的 alias\n\n\u003e [!failure]-\n\u003e Failure 级\n\n\u003e [!fail]-\n\u003e Fail 级, 是 failure 的 alias\n\n\u003e [!missing]-\n\u003e Missing 级, 是 failure 的 alias\n\n\u003e [!danger]-\n\u003e Danger 级\n\n\u003e [!error]-\n\u003e Error 级, 是 danger 的 alias\n\n\u003e [!bug]-\n\u003e Bug 级\n\n\u003e [!example]-\n\u003e Example 级\n\n\u003e [!quote]-\n\u003e Quote 级\n\n\u003e [!cite]-\n\u003e Cite 级, 是 quote 的 alias\n\n自定义 callout 类型\n\n\u003e [!reasoning]\n\u003e LLM Reasoning\n\n\u003e [!query]\n\u003e User Query\n\n\u003e [!ai]\n\u003e AI Generated Content\n\n\u003e [!think]\n\u003e Further thinking by writer\n\n\u003e [!idea]\n\u003e Idea 级, 是 think 的 alias\n\n## 标签\n\n文字里可以有 #Tag ， 会被渲染成标签。\n\n#Tag\n\n一行可以有多个 #Tag/Tag2 #Tag3 如果存在于 Tag 索引，则可点击 #Linux\n\n\u003e [!info] Tag 可以与其他组件结合\n\u003e 就像 #Tag 这样\n","title":"博客语法渲染测试","abstract":"**加粗**\n*斜体*\n_斜体2_","length":627,"created_at":"2024-04-14T11:41:29.000Z","updated_at":"2025-04-30T03:48:16.000Z","tags":["Tag1","Tag2","单行Tag","Tag","Tag/Tag2","Tag3","Linux","Blog","Nextjs"],"license":false,"headingTrees":[{"key":"一级标题","href":"#一级标题","heading":1,"title":"一级标题","children":[{"key":"二级标题","href":"#二级标题","heading":2,"title":"二级标题","children":[{"key":"三级标题","href":"#三级标题","heading":3,"title":"三级标题","children":[{"key":"四级标题","href":"#四级标题","heading":4,"title":"四级标题","children":[{"key":"五级标题","href":"#五级标题","heading":5,"title":"五级标题","children":[{"key":"六级标题","href":"#六级标题","heading":6,"title":"六级标题","children":[],"id":"六级标题"}],"id":"五级标题"}],"id":"四级标题"}],"id":"三级标题"}],"id":"二级标题"}],"id":"一级标题"},{"key":"其他-md-语法","href":"#其他-md-语法","heading":1,"title":"其他 MD 语法","children":[{"key":"代码块","href":"#代码块","heading":2,"title":"代码块","children":[{"key":"rehype-pretty-语法","href":"#rehype-pretty-语法","heading":4,"title":"Rehype Pretty 语法：","children":[],"id":"rehype-pretty-语法"}],"id":"代码块"},{"key":"列表","href":"#列表","heading":2,"title":"列表","children":[],"id":"列表"},{"key":"quote-block","href":"#quote-block","heading":2,"title":"Quote Block","children":[],"id":"quote-block"},{"key":"链接","href":"#链接","heading":2,"title":"链接","children":[],"id":"链接"},{"key":"图片","href":"#图片","heading":2,"title":"图片","children":[],"id":"图片"},{"key":"表格","href":"#表格","heading":2,"title":"表格","children":[],"id":"表格"},{"key":"脚注","href":"#脚注","heading":2,"title":"脚注","children":[],"id":"脚注"}],"id":"其他-md-语法"},{"key":"插件","href":"#插件","heading":1,"title":"插件","children":[{"key":"katex","href":"#katex","heading":2,"title":"Katex","children":[],"id":"katex"},{"key":"mermaid","href":"#mermaid","heading":2,"title":"Mermaid","children":[],"id":"mermaid"},{"key":"jessie-code-几何图形","href":"#jessie-code-几何图形","heading":2,"title":"Jessie Code 几何图形","children":[],"id":"jessie-code-几何图形"},{"key":"heading-引用","href":"#heading-引用","heading":2,"title":"Heading 引用","children":[],"id":"heading-引用"}],"id":"插件"},{"key":"obsidian","href":"#obsidian","heading":1,"title":"Obsidian","children":[{"key":"wikilink","href":"#wikilink","heading":2,"title":"Wikilink","children":[{"key":"站内短引用","href":"#站内短引用","heading":3,"title":"站内短引用","children":[],"id":"站内短引用"}],"id":"wikilink"},{"key":"rich-content-短引用","href":"#rich-content-短引用","heading":2,"title":"Rich Content 短引用","children":[{"key":"图片短引用","href":"#图片短引用","heading":3,"title":"图片短引用","children":[],"id":"图片短引用"},{"key":"excalidraw-短引用","href":"#excalidraw-短引用","heading":3,"title":"Excalidraw 短引用","children":[],"id":"excalidraw-短引用"}],"id":"rich-content-短引用"},{"key":"callouts","href":"#callouts","heading":2,"title":"Callouts","children":[],"id":"callouts"},{"key":"标签","href":"#标签","heading":2,"title":"标签","children":[],"id":"标签"},{"key":"footnote-label","href":"#footnote-label","heading":2,"title":"Footnotes","children":[],"id":"footnote-label"}],"id":"obsidian"}],"wikiRefAliases":["2022-08-13-introduction-for-k8s","introduction-for-k8s","2022-08-13-introduction-for-k8s","2022-08-13-introduction-for-k8s#部署一个-pod","articles/2022-08-13-introduction-for-k8s","/articles/introduction-for-k8s","public/content/articles/2022-08-13-introduction-for-k8s","2022-08-13-introduction-for-k8s","2022-08-20-introduction-for-k8s-2","introduction-for-k8s"],"richRefAliases":["test-img-show-image.png","test-img-show-image.png","blog-syntax/test-img-show-image.png","blog-syntax/test-img-show-image.png","/content/ideas/blog-syntax/test-img-show-image.png","Drawing 2024-04-13 17.33.27.excalidraw","test-img-show-image.png","Drawing 2024-04-13 17.33.27.excalidraw"]}}],"hyperProps":{"withSEO":true,"withComments":true}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"introduction-for-k8s-2"},"buildId":"2bZ63KvBkpjc51_BACkni","assetPrefix":"/blog-next","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>