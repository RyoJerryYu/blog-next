<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta property="og:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta name="twitter:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta property="og:url" content="https://blog.ryo-okami.xyz/articles/introduction-for-k8s" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@ryo_okami" data-next-head=""/><meta name="twitter:creator" content="@ryo_okami" data-next-head=""/><link rel="icon" href="/blog-next/favicon.ico" data-next-head=""/><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" data-next-head=""/><title data-next-head="">Kubernetes 入门 （1） | Ryo&#x27;s Blog</title><meta property="og:title" content="Kubernetes 入门 （1）" data-next-head=""/><meta property="og:site_name" content="Ryo&#x27;s Blog" data-next-head=""/><meta name="twitter:title" content="Kubernetes 入门 （1） | Ryo&#x27;s Blog" data-next-head=""/><meta name="description" content="我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？
&gt; 要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》
&quot;Write once, run anywhere&quot; 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。" data-next-head=""/><meta property="og:description" content="我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？
&gt; 要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》
&quot;Write once, run anywhere&quot; 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。" data-next-head=""/><meta name="twitter:description" content="我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？
&gt; 要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》
&quot;Write once, run anywhere&quot; 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2022-08-13T17:45:31.000Z" data-next-head=""/><meta property="article:modified_time" content="2022-08-20T14:02:18.000Z" data-next-head=""/><meta property="article:tag" content="Kubernetes" data-next-head=""/><meta property="article:tag" content="DevOps" data-next-head=""/><meta property="article:tag" content="Docker" data-next-head=""/><meta property="article:tag" content="Cloud Native" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" as="style"/><link rel="preload" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" as="style"/><link rel="stylesheet" href="/blog-next/_next/static/css/7cdbda104a0532c1.css" data-n-g=""/><link rel="stylesheet" href="/blog-next/_next/static/css/6fa7810a66b4dbc0.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/blog-next/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/blog-next/_next/static/chunks/webpack-63b01344875cd2b5.js" defer=""></script><script src="/blog-next/_next/static/chunks/framework-0907bc41f77e1d3c.js" defer=""></script><script src="/blog-next/_next/static/chunks/main-f6bb73538570e395.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/_app-46f15a352f2e34a5.js" defer=""></script><script src="/blog-next/_next/static/chunks/6d2b60a9-beef439121ada977.js" defer=""></script><script src="/blog-next/_next/static/chunks/52d06cd5-18d657cfd06e973c.js" defer=""></script><script src="/blog-next/_next/static/chunks/4130-4f55663d0ffc3327.js" defer=""></script><script src="/blog-next/_next/static/chunks/4587-ad3e00575945688a.js" defer=""></script><script src="/blog-next/_next/static/chunks/366-e7aa9bf3cae7308c.js" defer=""></script><script src="/blog-next/_next/static/chunks/7564-2d1adbbf02956a78.js" defer=""></script><script src="/blog-next/_next/static/chunks/8494-d96a947715d36e05.js" defer=""></script><script src="/blog-next/_next/static/chunks/pages/articles/%5Bslug%5D-4759ef57d55fd17a.js" defer=""></script><script src="/blog-next/_next/static/vYRJvhoXUtHmZ0dOUV_ci/_buildManifest.js" defer=""></script><script src="/blog-next/_next/static/vYRJvhoXUtHmZ0dOUV_ci/_ssgManifest.js" defer=""></script></head><body><link rel="preload" as="image" href="http://icyfenix.cn/assets/img/kubernetes.495f9eae.png"/><div id="__next"><style data-emotion="css czlpqi">.css-czlpqi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-czlpqi{position:absolute;}}</style><style data-emotion="css 1cmpeoq">.css-1cmpeoq{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:var(--Paper-shadow);background-image:var(--Paper-overlay);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-1cmpeoq{position:absolute;}}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionFixed mui-fixed css-1cmpeoq" style="--Paper-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"><style data-emotion="css 1guk29">@media (min-width:0px){.css-1guk29{display:none;}}@media (min-width:900px){.css-1guk29{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="ml-2 w-24 mr-4 MuiBox-root css-1guk29"><a class="DefaultLayout_textlink__W55gl" href="/blog-next">Ryo&#x27;s Blog</a></div><style data-emotion="css 1m04nb5">@media (min-width:0px){.css-1m04nb5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:900px){.css-1m04nb5{display:none;}}</style><div class="ml-2 mr-4 MuiBox-root css-1m04nb5"><a title="Ryo&#x27;s Blog" href="/blog-next"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium h-6 w-6 text-gray-300 hover:text-white css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></a></div><style data-emotion="css nznm6s">.css-nznm6s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="MuiBox-root css-nznm6s"><div class="DefaultLayoutMenu bg-transparent min-w-full"><ul class="rc-menu-overflow rc-menu rc-menu-root rc-menu-horizontal" role="menu" tabindex="0" data-menu-list="true"><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:0" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/articles">Articles</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:1" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/learn_from_ai">Learn from AI</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:2" role="menuitem" tabindex="-1"><a class="DefaultLayout_textlink__W55gl" href="/blog-next/tags">Tags</a></li><li class="rc-menu-overflow-item rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:1;order:3" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span class="DefaultLayout_textlink__W55gl">More</span><i class="rc-menu-submenu-arrow"></i></div></li><li class="rc-menu-overflow-item rc-menu-overflow-item-rest rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" title="..." aria-expanded="false" aria-haspopup="true">...<i class="rc-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></div></div><style data-emotion="css k008qs">.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="MuiBox-root css-k008qs"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></header><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"></div><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="DefaultLayout_contentHeight__RDRZE"><article class="Post_post__acRqJ"><h1 class="Post_postTitle__N1NIA">Kubernetes 入门 （1）</h1><div class="Post_postDate__SQx7A"><time dateTime="2022-08-13T17:45:31.000Z">2022-08-13</time></div><div class="TagsBox_tagsBox__WzhAf mt-2"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/kubernetes">#<!-- -->Kubernetes</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/devops">#<!-- -->DevOps</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/docker">#<!-- -->Docker</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/cloud-native">#<!-- -->Cloud Native</a></div><div class="post-body Post_postContent__mJ_Ju"><h1 id="容器-docker-与-k8s"><a href="#容器-docker-与-k8s" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>容器， Docker 与 K8s</h1>
<p>我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？</p>
<h3 id="关于容器虚拟化"><a href="#关于容器虚拟化" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>关于容器虚拟化</h3>
<blockquote>
<p>要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》</p>
</blockquote>
<p>&quot;Write once, run anywhere&quot; 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。</p>
<p>要保证程序拉下来就能跑，最好的方法就是把程序和依赖打包到一起，然后将外部环境隔离起来。容器虚拟化技术就是为了解决这个。</p>
<p>与常说的虚拟机不同， Docker 等各类容器是用隔离名称空间的方式进行资源隔离的。 Linux 系统的内核直接提供了名称空间隔离的能力，是针对进程设计的访问隔离机制，可以进行一些资源封装。</p>
<table><thead><tr><th style="text-align:left">名称空间</th><th style="text-align:left">隔离内容</th><th style="text-align:left">内核版本</th></tr></thead><tbody><tr><td style="text-align:left">Mount</td><td style="text-align:left">文件系统与路径等</td><td style="text-align:left">2.4.19</td></tr><tr><td style="text-align:left">UTS</td><td style="text-align:left">主机的Hostname、Domain names</td><td style="text-align:left">2.6.19</td></tr><tr><td style="text-align:left">IPC</td><td style="text-align:left">进程间通信管道</td><td style="text-align:left">2.6.19</td></tr><tr><td style="text-align:left">PID</td><td style="text-align:left">独立的进程编号空间</td><td style="text-align:left">2.6.24</td></tr><tr><td style="text-align:left">Network</td><td style="text-align:left">网卡、IP 地址、端口等网络资源</td><td style="text-align:left">2.6.29</td></tr><tr><td style="text-align:left">User</td><td style="text-align:left">进程独立的用户和用户组</td><td style="text-align:left">3.8</td></tr><tr><td style="text-align:left">Cgroup</td><td style="text-align:left">CPU 时间片，内存分页等</td><td style="text-align:left">4.6</td></tr><tr><td style="text-align:left">Time &lt;- New!</td><td style="text-align:left">进程独立的系统时间</td><td style="text-align:left">5.6</td></tr></tbody></table>
<p>值得注目的是， Linux 系统提供了 Cgroup 名称空间隔离的支持。通过隔离 Cgroup ，可以给单独一个进程分配 CPU 占用比率、内存大小、外设 I/O 访问权限等。再配合 IPC 、 PID 等的隔离，可以让被隔离的进程看不到同一实体机中其他进程的信息，就像是独享一整台机器一样。</p>
<p>由于容器虚拟化技术直接利用了宿主机操作系统内核，因此远远要比虚拟机更轻量，也更适合用来给单个程序进行隔离。但也同样由于依赖了宿主机内核，在不同的架构、不同种类的操作系统间容器可能不能移植。</p>
<h3 id="关于-docker"><a href="#关于-docker" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>关于 Docker</h3>
<p>在介绍 K8s 之前，我们要先搞清楚 Docker 是什么。或者说，我们平时说的“ Docker ”是什么？</p>
<p>我们平时说的 Docker ，可能是以下几个东西：</p>
<ul>
<li>Docker Engine: 在宿主机上跑的一个进程，专门用来管理各个容器的生命周期、网络连接等，还暴露出一些 API 供外部调用。有时会被称为 Docker Daemon 或是 dockerd 。</li>
<li>Docker Client: 命令行中的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>docker</span></span></code></span> 命令，其实只会跟 Docker Server 通信，不会直接创建销毁一个容器进程。</li>
<li>Docker Container: 宿主机上运行的一组被资源隔离的进程，在容器中看来像是独占了一台虚拟的机器，不需要考虑外部依赖。</li>
<li>Docker Image: 是一个打包好的文件系统，可以从一个 Image 运行出复数个 Container 。 Image 内部包含了程序运行所需的所有文件、库依赖，以及运行时的环境变量等。</li>
<li>Docker 容器运行时: 是 Docker Engine 中专门管理容器状态、生命周期等的那个组件，原来名为 libcontainer 。<a href="https://en.wikipedia.org/wiki/Open_Container_Initiative">《开放容器交互标准》</a>制定后， Docker 公司将此部分重构为 <a href="https://github.com/opencontainers/runc">runC 项目</a>，交给 Linux 基金会管理。而 Docker Engine 中与运行时进行交互的部分则抽象出来成为 <a href="https://containerd.io/">containerd 项目</a>，捐献给了 CNCF 。</li>
</ul>
<p>我们平时在 linux 机上运行 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>yum install docker</span></span></code></span> 之类的命令，安装的其实是 Docker Engine + Docker Client 。（而在 Windows 或 MacOS 上安装的 Docker Desktop 其实是一个定制过的 linux 虚拟机。）下面说的 Docker 的功能其实都是指 Docker Engine 的功能。</p>
<p>而 Docker 提供给我们的功能，除了最基础的运行和销毁容器外，还包括了一些容器网络编排、重启策略、文件路径映射、端口映射等功能。</p>
<p>而我认为 Docker 最大的贡献，还是容器的镜像与镜像仓库。有了镜像与镜像仓库，人们就可以把自己的程序与执行环境直接打包成镜像发布，也可以直接拿打包好的镜像来运行容器进行部署，而不需要额外下载或是安装一些东西，也不需要担心程序会与已经跑起来的其他程序冲突。</p>
<h3 id="为什么要用-k8s-"><a href="#为什么要用-k8s-" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>为什么要用 K8s ？</h3>
<p>其实 Docker 有一个很强大的工具叫 docker-compose ，可以通过一个 manifest 对多个容器组成的网络进行编排。那为什么我们还需要 K8s 呢？换句话说，有什么事是 Docker 不能做的？而 K8s 设计出来的目标是为了解决什么问题？</p>
<p>首先， Docker 做不到以下的功能：</p>
<ol>
<li><strong>Docker 不能做跨多主机的容器编排。</strong> docker-compose 再方便，他也只能编排单台主机上的容器。对跨主机的集群编排无能为力。（实际上，用了 Docker-Swarm 后是可以多主机编排的，但一来 Docker-Swarm 出现的比 K8s 晚，而来 Docker-Swarm 功能不如 K8s ，因此用的人很少，我们下面就默认 Docker-Swarm 不存在了。）</li>
<li><strong>Docker 提供的容器部署管理功能不够丰富。</strong> Docker 有一些简单的容器重启策略，但也只是简单的失败后重启之类的，没有完整的应用状态检查等功能。同时，版本升级、缩扩容等策略选择的余地也不多。</li>
<li><strong>Docker 缺乏高级网络功能。</strong> 要让 Docker 的容器间进行网络通信，也只能是说把容器放到同一个网络下，然后再通过各自的 Hostname 来找到对方。但实际上，我们更会想要一些负载均衡、自定义域名、选择某些容器端口不暴露之类的功能。</li>
</ol>
<p>and more...</p>
<p>总的来说， Docker 更关注单台主机上容器怎么跑，而对部署管理的功能则支持不多。而最大的痛点，就是 Docker 对多主机的集群部署支持的实再很差。然而，为了实现多区可用、负载均衡等功能，多主机集群的容器编排又是必不可少的。</p>
<p>K8s 的出现，主要就是为了解决多主机集群上的容器编排问题。</p>
<ol>
<li><strong>K8s 可以进行多主机调度。</strong> 用户只需要描述自己需要运行怎样的应用， K8s 就可以自己选择一个合适的节点进行部署，用户不需要关心自己的应用部署到哪个节点上。</li>
<li><strong>K8s 中一切皆资源。</strong> K8s 有完善的抽象资源机制，用户几乎不需要知道磁盘、网络等任何硬件信息，只需要对着统一的抽象资源进行操作。</li>
<li><strong>K8s 能保证较强的可用性。</strong> 除了能跨多主机调度实现多区可用外， K8s 还提供了很完善的缩扩容机制、健康检查机制以及自动恢复机制。</li>
</ol>
<p>可以说， K8s 是容器编排工具的主流选择。</p>
<h3 id="k8s-与-docker-的关系"><a href="#k8s-与-docker-的关系" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>K8s 与 Docker 的关系</h3>
<p>K8s 与 Docker 关系很复杂，是一个逐渐变化的过程。</p>
<p>一开始 K8s 是完全依赖于 Docker Engine 进行容器启动与销毁的。后来<a href="https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/">容器运行时接口（CRI）</a>、 <a href="https://github.com/cri-o/cri-o">CRI-O 标准</a>、开放容器交互标准（OCI）等标准逐渐建立，可替代 Docker Engine 的工具越来越多， K8s 中已经完全可以不使用 Docker Engine 了。</p>
<p><a href="http://icyfenix.cn/">《凤凰架构》</a>一书中有下面这样一张图来描述 K8s 与 Docker Engine 的关系：</p>
<img src="http://icyfenix.cn/assets/img/kubernetes.495f9eae.png" alt="K8s 与 Docker Engine 的关系"/>
<p>《凤凰架构》书中<a href="http://icyfenix.cn/immutable-infrastructure/container/history.html#%E5%B0%81%E8%A3%85%E9%9B%86%E7%BE%A4%EF%BC%9Akubernetes">这一章节</a>详细介绍了 K8s 与 Docker 的历史，我这里就不再赘述。</p>
<h1 id="部署一个-pod"><a href="#部署一个-pod" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>部署一个 Pod</h1>
<p>上面说了一堆概念，我们接下来实际上会怎样应用 K8s 。</p>
<h3 id="pod-示例"><a href="#pod-示例" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Pod 示例</h3>
<blockquote>
<p>Pod 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。
Pod 是一组容器；Pod 中的内容总是一同调度，在共享的上下文中运行。 Pod 中包含一个或多个应用容器，这些容器相对紧密地耦合在一起。在非云环境中，在相同的物理机或虚拟机上运行的应用类似于在同一逻辑主机上运行的云应用。
—— Kubernetes 官方文档</p>
</blockquote>
<p>Pod 是 K8s 的最小部署单位。</p>
<p>因为 K8s 将硬件资源都抽象化了，用户不需要知道自己的应用部署到哪台机上。但是有些场景下两个主进程之间又必须相互协作才能完成任务，如果两个进程不确定会不会部署到同一个节点上会变得很麻烦。因此才需要 Pod 这种资源。</p>
<p>下面是一个 Nginx Pod 的示例（这是 K8s manifest 文件，可以用 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kubectl apply -f &lt;filepath&gt;</span></span></code></span> 进行部署）：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">simple-webapp</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">main-application</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">nginx</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/log/nginx</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">sidecar-container</span></span>
<span data-line=""><span style="color:#E5C07B">      image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">busybox</span></span>
<span data-line=""><span style="color:#E5C07B">      command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">sh</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-c</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">while true; do cat /var/log/nginx/access.log; sleep 30; done</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">      volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/log/nginx</span></span>
<span data-line=""><span style="color:#E5C07B">  volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared-logs</span></span>
<span data-line=""><span style="color:#E5C07B">      emptyDir</span><span style="color:#A9B2C3">: {}</span></span></code></pre></figure>
<p>可以看到， Pod 中可以包含多个容器，这组容器总是以一定的逻辑一起部署，且总是部署在同一个节点。对 K8s 操作时，不能说只部署 Pod 中一个特定的容器，也不能说把 Pod 中一个容器部署在这个节点，另一个容器部署在另一个节点上。</p>
<p>在上面这个例子中，我们看到 Pod 中除了 Nginx 容器以外还有一个 Sidecar 容器负责将 Nginx 的 access.log 日志输出到控制台。两个容器可以通过 mount 同一个路径来实现文件共享。这种场景下，单独跑一个 Sidecar 容器没有意义，而我们也不会希望两个容器部署在不同的节点上。 <strong>两个容器同生共死</strong> ，这样的模式被称为 <strong>Sidecar 模式</strong> 。 Jaeger Agent ，或是 Service Mesh 中常见的 Envoy Sidecar 都可以通过这种模式部署，这样业务容器中就可以不考虑 tracing 或是流量控制相关的问题。</p>
<p>此外，由于同一个 Pod 中的容器默认共享了相同的 network 和 UTS 名称空间，不管是在 Pod 的内部还是外部来看，他们一定程度上就像是真的部署在同一主机上一样，有相同的 Hostname 与 ip 地址，在一个容器中也可以通过 localhost 来访问零一个容器的端口。</p>
<p>另外 Pod 中可以定义若干个 initContainer ，这些容器会比 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.containers</span></span></code></span> 中的容器先运行，并且是顺序运行。下面是通过安装 bitnami 的 Kafka Helm Chart 得到的一个 Kafka Broker Pod （有所简化）:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-0</span></span>
<span data-line=""><span style="color:#E5C07B">  namespace</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">    image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">docker.io/bitnami/kafka:3.1.0-debian-10-r52</span></span>
<span data-line=""><span style="color:#E5C07B">    command</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#98C379">/scripts/setup.sh</span></span>
<span data-line=""><span style="color:#E5C07B">    volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">scripts</span></span>
<span data-line=""><span style="color:#E5C07B">      mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/scripts/setup.sh</span></span>
<span data-line=""><span style="color:#E5C07B">      subPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">setup.sh</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared</span></span>
<span data-line=""><span style="color:#E5C07B">      mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/shared</span></span>
<span data-line=""><span style="color:#E5C07B">  initContainers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auto-discovery</span></span>
<span data-line=""><span style="color:#E5C07B">    image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">docker.io/bitnami/kubectl:1.23.5-debian-10-r1</span></span>
<span data-line=""><span style="color:#E5C07B">    command</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#98C379">/scripts/auto-discovery.sh</span></span>
<span data-line=""><span style="color:#E5C07B">    volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared</span></span>
<span data-line=""><span style="color:#E5C07B">      mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/shared</span></span>
<span data-line=""><span style="color:#A9B2C3">    - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">scripts</span></span>
<span data-line=""><span style="color:#E5C07B">      mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/scripts/auto-discovery.sh</span></span>
<span data-line=""><span style="color:#E5C07B">      subPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">auto-discovery.sh</span></span>
<span data-line=""><span style="color:#E5C07B">  volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">scripts</span></span>
<span data-line=""><span style="color:#E5C07B">    configMap</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      defaultMode</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">493</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-scripts</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">shared</span></span>
<span data-line=""><span style="color:#E5C07B">    emptyDir</span><span style="color:#A9B2C3">: {}</span></span></code></pre></figure>
<p>可以看到，在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka</span></span></code></span> pod 启动前会先启动一个名为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>auto-discovery</span></span></code></span> 的 initContainer ，负责获得集群信息等准备工作。准备工作完成后，会将信息写入 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>/shared</span></span></code></span> 目录下，然后再启动 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>kafka</span></span></code></span> 容器 Mount 同一目录，就可以获取准备好的信息。</p>
<p><strong>这样运行容器进行 Pod 初始化就叫 initContainer 模式</strong> 。每个 initContainer 会运行到成功退出为止，如果有一个 initContainer 启动失败，则整个 Pod 启动失败，触发 K8s 的 Pod 重启策略。</p>
<h1 id="部署更多-pod"><a href="#部署更多-pod" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>部署更多 Pod</h1>
<h3 id="replica-set"><a href="#replica-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Replica Set</h3>
<p>可是上面说了这么多，还只是单个 Pod 的部署，但我们希望能做多副本部署。</p>
<p>其实，只要把 Pod 的 manifest 改一下 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>metadata.name</span></span></code></span> 再部署一次，就能得到一模一样的两个 Pod ，就是一个简单的多副本部署了。（必须改 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>metadata.name</span></span></code></span> ，不然 K8s 会以为你是想修改同一个 Pod ）</p>
<p>可是这样做会有很多问题：</p>
<ul>
<li>要复制一下还要改名字多麻烦啊，我想用同一份模板，只定义一下副本数就能得到对应数量的 Pod 。</li>
<li>缩容扩容还要对着 Pod 操作很危险，我想直接修改副本数就能缩容扩容。</li>
<li>如果其中一些 Pod 挂掉了不能重启，现在是什么都不会做。我希望能自动建一些新的 Pod 顶上，来保证副本数不变。</li>
</ul>
<p>为了实现这些需求，就出现了 Replica Set 这种资源。下面是实际应用中一个 Replica Set 的例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ReplicaSet</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">2</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">xxxxxxxx.amazonaws.com/gateway:xxxxxxx</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">containerPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">50051</span></span>
<span data-line=""><span style="color:#E5C07B">          protocol</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">TCP</span></span>
<span data-line=""><span style="color:#E5C07B">        readinessProbe</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          initialDelaySeconds</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">5</span></span>
<span data-line=""><span style="color:#E5C07B">          tcpSocket</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            port</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">50051</span></span>
<span data-line=""><span style="color:#E5C07B">        startupProbe</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          failureThreshold</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">60</span></span>
<span data-line=""><span style="color:#E5C07B">          tcpSocket</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">            port</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">50051</span></span>
<span data-line=""><span style="color:#E5C07B">      affinity</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        podAntiAffinity</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          preferredDuringSchedulingIgnoredDuringExecution</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">          - </span><span style="color:#E5C07B">podAffinityTerm</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">              labelSelector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">                matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">                  app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">              topologyKey</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">topology.kubernetes.io/zone</span></span>
<span data-line=""><span style="color:#E5C07B">            weight</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">80</span></span></code></pre></figure>
<p>我们可以看到， <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.template</span></span></code></span> 中就是我们要的 Pod 的模板，在 metadata 里带上了 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>app:gateway</span></span></code></span> 标签。而在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.replicas</span></span></code></span> 中定义了我们需要的 Pod 数量， <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.selector</span></span></code></span> 中描述了我们要对带 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>app:gateway</span></span></code></span> 标签的 Pod 进行控制。把这份 manifest 部署后，我们就会得到除名字以外几乎一摸一样的两个 Pod ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  generateName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658-</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    pod-template-hash</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">9dc546658</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658-6c9qs</span></span>
<span data-line=""><span style="color:#E5C07B">  ownerReferences</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">    blockOwnerDeletion</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">    controller</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">    kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ReplicaSet</span></span>
<span data-line=""><span style="color:#E5C07B">    name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658</span></span>
<span data-line=""><span style="color:#E5C07B">    uid</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">6633f89c-377c-4c90-bd08-3be5bc7b21bd</span></span>
<span data-line=""><span style="color:#E5C07B">  resourceVersion</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">49793842</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  uid</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">f927db88-a39a-4623-852d-4f150a6d853b</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">xxxxxxxx.amazonaws.com/gateway:xxxxxxx</span></span>
<span data-line=""><span style="color:#E5C07B">    ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 后续省略</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D19A66">---</span></span>
<span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Pod</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  annotations</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    kubernetes.io/psp</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">eks.privileged</span></span>
<span data-line=""><span style="color:#E5C07B">  creationTimestamp</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">2022-08-09T08:51:25Z</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  generateName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658-</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    pod-template-hash</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">9dc546658</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658-8trcs</span></span>
<span data-line=""><span style="color:#E5C07B">  ownerReferences</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">    blockOwnerDeletion</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">    controller</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">    kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">ReplicaSet</span></span>
<span data-line=""><span style="color:#E5C07B">    name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway-9dc546658</span></span>
<span data-line=""><span style="color:#E5C07B">    uid</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">6633f89c-377c-4c90-bd08-3be5bc7b21bd</span></span>
<span data-line=""><span style="color:#E5C07B">  resourceVersion</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">49793745</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  uid</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">0918e3ed-2965-4237-8828-421a7831c9ed</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">xxxxxxxx.amazonaws.com/gateway:xxxxxxx</span></span>
<span data-line=""><span style="color:#E5C07B">    name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">    # 后续省略</span></span></code></pre></figure>
<p>可以看到，创建出来的 Pod 自动生成了两个后缀（ <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>6c9qs</span></span></code></span> 与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>8trcs</span></span></code></span> ），带上了 Replica Set 的信息（在 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>metadata.ownerReferences</span></span></code></span> ），其他部分基本一模一样。如果其中一个 Pod 挂掉了， K8s 会帮我们从模板中重新创建一个 Pod 。而且由于我们在 Pod 模板定义了 affinity ， K8s 还会按照我们的要求自动筛选合适的节点。例如在上面 Replica Set 的例子中，创建出来的 Pod 就会尽量部署在不同的节点上。</p>
<blockquote>
<p><strong>K8s 中对 Pod 的生存状态检查机制</strong></p>
<p>除了线程直接错误退出以外，还有出现死锁等等各种可能性使得容器中的应用不能正常工作。这些情况下虽然是不健康状态，但容器却不一定会挂掉。因此 K8s 提供了一些探针检查的机制来判断 Pod 是否健康。
K8s 主要提供了三种探针：</p>
<ol>
<li><strong>存活探针（ liveness probe ）</strong> : Pod 运行时 K8s 会循环执行 liveness probe 检查容器是否健康。如果检查失败， K8s 会认为这个容器不健康，就会尝试重启容器。</li>
<li><strong>就绪探针（ readiness probe ）</strong> : 程序可能会有一段时间不能提供服务（比如正在加载数据等）。这时可能既不想杀死应用，也不想给它发送请求，这时就需要 readiness probe 。如果 readiness probe 检查失败， K8s 就会将这个 Pod 从 Service 上摘下来，直到 readiness probe 成功重新加入 Service 。</li>
<li><strong>启动探针（ startup probe ）</strong> : 有些程序会有非常长的启动时间，会有较长时间不能提供服务。这时如果 liveness probe 失败了导致重启毫无必要，此时就需要 startup probe 。 startup probe 只会在容器启动时检查直到第一次成功。直到 startup probe 成功为止， liveness probe 与 readiness probe 都不会开始执行检查。</li>
</ol>
<p>而检测方式主要有：</p>
<ol>
<li>httpGet: 对指定的端口路径执行 HTTP GET 请求，如果返回 2xx 或 3xx 就是成功。</li>
<li>tcpSocket: 尝试与容器的端口建立连接，如果不能成功建立连接就是失败。</li>
<li>exec: 在容器内执行一段命令，如果退出时状态码不为 0 就是失败。</li>
<li>grpc (New!): K8s 1.24 新出的检查方式，直接用 <a href="https://github.com/grpc/grpc/blob/master/doc/health-checking.md">GRPC Health Checking Protocol</a> 对 GRPC Server 进行检查。</li>
</ol>
</blockquote>
<p>此外， Replica Set 还提供了简易的缩容扩容功能。 kubectl 中提供了 scale 命令：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="plastic"><code data-language="bash" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">kubectl</span><span style="color:#98C379"> scale</span><span style="color:#98C379"> replicaset</span><span style="color:#98C379"> gateway</span><span style="color:#56B6C2"> --replicas=10</span></span></code></pre></figure>
<p>执行上述命令，就可以将名为 gateway 的 Replica Set 对应的副本数扩容到 10 份。当然，你也可以直接修改 Replica Set 的 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>spec.replicas</span></span></code></span> 字段来实现缩容扩容。</p>
<p>然而， Replica Set 的功能还是有限的。实际上， Replica Set 只关心跟它的 selector 匹配的 Pod 的数量。而至于匹配的 Pod 是否真的是跟 template 字段中描述的一样， Replica Set 就不关心了。因此如果单用 Replica Set ，更新 Pod 就会变得究极麻烦。</p>
<h3 id="deployment"><a href="#deployment" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Deployment</h3>
<p>为了解决 Pod 的更新问题，我们需要有 Deployment 这种资源。实际上， Replica Set 的主要用途是提供给 Deployment 作为控制 Pod 数量，以及创建、删除 Pod 的一种机制。我们一般不会直接使用 Replica Set 。</p>
<p>下面是实际应用中一个 Deployment 的例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Deployment</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">2</span></span>
<span data-line=""><span style="color:#E5C07B">  revisionHistoryLimit</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">10</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gateway</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">xxxxxxxx.amazonaws.com/gateway:xxxxxxx</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#5F6672;font-style:italic">        # 下略</span></span></code></pre></figure>
<p>可以看到 Deployment 的 manifest 跟 Replica Set 很像。但实际上， Deployment 不会直接创建 Pod ，而是创建出一个 Replica Set ，再由 Replica Set 来创建 Pod ：</p>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><style data-emotion="css 14awfyb animation-61bdi0">.css-14awfyb{display:inline-block;-webkit-animation:animation-61bdi0 1.4s linear infinite;animation:animation-61bdi0 1.4s linear infinite;color:#1976d2;}@-webkit-keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}</style><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><style data-emotion="css 4ejps8">.css-4ejps8{display:block;}</style><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><style data-emotion="css 13odlrs animation-1o38n3e">.css-13odlrs{stroke:currentColor;stroke-dasharray:80px,200px;stroke-dashoffset:0;-webkit-animation:animation-1o38n3e 1.4s ease-in-out infinite;animation:animation-1o38n3e 1.4s ease-in-out infinite;}@-webkit-keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}@keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}</style><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<p>比如在上面的例子中，名为 gateway 的 Deployment 创建后，就会有如下 ReplicaSet 和 Pod ：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># Replica Set:</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> rc</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app=gateway</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                 DESIRED</span><span style="color:#98C379">   CURRENT</span><span style="color:#98C379">   READY</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-9dc546658</span><span style="color:#56B6C2">    2</span><span style="color:#56B6C2">         2</span><span style="color:#56B6C2">         2</span><span style="color:#98C379">       5d3h</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#5F6672;font-style:italic"># Pod:</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> po</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app=gateway</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                      READY</span><span style="color:#98C379">   STATUS</span><span style="color:#98C379">    RESTARTS</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-9dc546658-6c9qs</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">          5d3h</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-9dc546658-8trcs</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   0</span><span style="color:#98C379">          5d3h</span></span></code></pre></figure>
<p>可以看到，gateway Deployment 创建了一个 Replica Set ，然后随机给了它一个 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>9dc546658</span></span></code></span> 后缀。然后 gateway-9dc546658 这个 Replica Set 又根据 template 中创建了两个 Pod ，再在自己名字的基础上加上两个后缀 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>6c9qs</span></span></code></span> 与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>8trcs</span></span></code></span> 。</p>
<p>接下来就是 Deployment 的重点了： Replica Set 只会根据 template 创建出 Pod ，而不管匹配的 Pod 到底是不是跟 template 中描述的一样。而 <strong>Deployment 则会专门关注 template 的内容变更。</strong></p>
<p>假如我们现在更新了 Deployment 的 template 中的内容提交给 K8s ， Deployment 就会感知到 template 被修改了， Pod 需要更新。
感知到更新之后， Deployment 就会创建一个新的 Replica Set 。然后逐渐将旧的 Replica Set 缩容到 0 ，并同时将新的 Replica Set 扩容到目标值。最后，所有旧版本的 Pod 将会被更新成新版本的 Pod 。如下图所示：</p>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<p>整个过程完成后， Deployment 还不会将旧的 Replica Set 删除掉。我们注意到 Deployment 的声明中有这么一个字段： <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>revisionHistoryLimit: 10</span></span></code></span> ，表示 Deployment 会保留历史中 最近的 10 个 Replica Set ，这样在必要的时候可以立刻将 Deployment 回滚到上个版本。而超出 10 个的 Replica Set 才会被从 K8s 中删除。</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#5F6672;font-style:italic"># 实际中被 scale 到 0 但还没被删除的 Replica Set</span></span>
<span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> rs</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app=gateway</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">                 DESIRED</span><span style="color:#98C379">   CURRENT</span><span style="color:#98C379">   READY</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-5c4cdf957d</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       5d4h</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-5c56f6d487</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       17d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-65857cfc78</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       10d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-6bddbdd85f</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       16d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-6cc9bb5b4c</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       13d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-6f4664bc65</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       17d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-7bd667cb79</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       9d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-7d658d57f5</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       13d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-84df97d4c8</span><span style="color:#56B6C2">   0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       6d4h</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-9998f4689</span><span style="color:#56B6C2">    0</span><span style="color:#56B6C2">         0</span><span style="color:#56B6C2">         0</span><span style="color:#98C379">       13d</span></span>
<span data-line=""><span style="color:#B57EDC">gateway-9dc546658</span><span style="color:#56B6C2">    2</span><span style="color:#56B6C2">         2</span><span style="color:#56B6C2">         2</span><span style="color:#98C379">       5d4h</span></span></code></pre></figure>
<h3 id="stateful-set"><a href="#stateful-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Stateful Set</h3>
<p>Deployment 中默认了我们不关心自己访问的是哪个 Pod ，因为各个 Pod 的功能是一样的，访问哪个没有差别。</p>
<p>实际上这也符合大多数情况：试想一个 HTTP Server ，如果其所有数据都存放到同一个的数据库中，那这个 HTTP Server 不管部署在哪台主机、不管有多少个实例、不管你访问的是哪个实例，都察觉不出有什么差别。而有了这种默认，我们就能更放心地对 Pod 进行负载均衡、缩扩容等操作。</p>
<p>但实际上我们总会遇到需要保存自己状态的 Pod 。比如我们在 K8s 里部署一个 Kafka 集群，每个 Kafka broker 都需要保存自己的分区数据，而且还要往 Zookeeper 里写入自己的名字来实现选举等功能。如果简单地用 Deployment 来部署， broker 之间可能就会分不清到底哪块是自己的分区，而且由 Deployment 生成出来的 Pod 名字是随机的，升级后 Pod 的名字会变，导致 Kafka 升级后名字与 Zookeeper 里的名字不一致，被以为是一个新的 broker 。</p>
<p>Stateful Set 就是为了解决有状态应用的部署而出现的。下面是 用 bitnami 的 Kafka Helm Chart 部署的一个 Kafka Stateful Set 的例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">StatefulSet</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  replicas</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">3</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">  serviceName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-headless</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">docker.io/bitnami/kafka:3.1.0-debian-10-r52</span></span>
<span data-line=""><span style="color:#E5C07B">        command</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#98C379">/scripts/setup.sh</span></span>
<span data-line=""><span style="color:#E5C07B">        ports</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">containerPort</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">9092</span></span>
<span data-line=""><span style="color:#E5C07B">          name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">kafka-client</span></span>
<span data-line=""><span style="color:#E5C07B">          protocol</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">TCP</span></span>
<span data-line=""><span style="color:#E5C07B">        volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/bitnami/kafka</span></span>
<span data-line=""><span style="color:#E5C07B">          name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">data</span></span>
<span data-line=""><span style="color:#E5C07B">  volumeClaimTemplates</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">  - </span><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">v1</span></span>
<span data-line=""><span style="color:#E5C07B">    kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">PersistentVolumeClaim</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">data</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      resources</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        requests</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          storage</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">10Gi</span></span>
<span data-line=""><span style="color:#E5C07B">      storageClassName</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">gp2</span></span></code></pre></figure>
<p>可以看到其实 Stateful Set 类似 Deployment ，也可以通过 replicas 字段定义实例数，如果更新 template 部分， Stateful Set 也会以一定的策略对 Pod 进行更新。</p>
<p>而其创建出来的 Pod 如下所示：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="sh" data-theme="plastic"><code data-language="sh" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#B57EDC">$</span><span style="color:#98C379"> kubectl</span><span style="color:#98C379"> get</span><span style="color:#98C379"> po</span><span style="color:#56B6C2"> -l</span><span style="color:#98C379"> app.kubernetes.io/name=kafka</span></span>
<span data-line=""><span style="color:#B57EDC">NAME</span><span style="color:#98C379">      READY</span><span style="color:#98C379">   STATUS</span><span style="color:#98C379">    RESTARTS</span><span style="color:#98C379">   AGE</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-0</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   1</span><span style="color:#98C379">          26d</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-1</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   3</span><span style="color:#98C379">          26d</span></span>
<span data-line=""><span style="color:#B57EDC">kafka-2</span><span style="color:#98C379">   1/1</span><span style="color:#98C379">     Running</span><span style="color:#56B6C2">   3</span><span style="color:#98C379">          26d</span></span></code></pre></figure>
<p>与 Replica Set 创建出来的 Pod 相比名字上会有很大差别。 Stateful Set 创建出来的 Pod 会固定的以 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>-0</span></span></code></span> 、 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>-1</span></span></code></span> 、 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>-2</span></span></code></span> 结尾而不是随机生成：</p>
<div class="relative h-[600px] my-4"><div class="inset-0 w-full h-full flex items-center justify-center bg-bg-focus2"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div>
<p>这样一来，更新时将 Pod 更换之后，新的 Pod 仍能够跟旧的 Pod 保持相同的名字。此外，与 Deployment 相比， Stateful Set 更新后同名的 Pod 仍能保持原来的 IP ，拿到同一个持久化卷，而且不同的 Pod 还能通过独立的 DNS 记录相互区分。这些内容后面还会详细介绍。</p>
<blockquote>
<p><strong>宠物与牛（ Cattle vs Pets ）的比喻</strong></p>
<p>Deployment 更倾向于将 Pod 看作是牛：我们不会去关心每一个 Pod 个体，如果有一个 Pod 出现了问题，我们只需要把他杀掉并替换成新的 Pod 就好。</p>
<p>但 Stateful Set 更倾向于将 Pod 看作是宠物：弄来一直完全一模一样的宠物并不是容易的事，我们对待这些宠物必须小心翼翼。我们要给他们各自一个专属的名字，替换掉一只宠物时，必须要保证它的花色、名字、行为举止都与之前那只宠物一模一样。</p>
</blockquote>
<h3 id="daemon-set"><a href="#daemon-set" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Daemon Set</h3>
<p>不管是 Deployment 还是 Stateful Set ，一般都不会在意自己的 Pod 部署到哪个节点。而假如你不在意自己 Pod 的数量，但需要保证每个节点上都运行一个 Pod 时，就需要 Daemon Set 了。</p>
<p>需要保证每个节点上有且只有一个 Pod 在运行这种情况，经常会在基础结构相关的操作中出现。比如我需要在集群中部署 fluentd 采集 log ，一般来说需要在 Pod 里直接挂载节点磁盘上的文件路径。这种时候如果有一个节点上没有运行 Pod ，那个节点的 log 就采集不到；另一方面，一个节点上运行多个 Pod 毫无意义，而且可能还会导致 log 重复等冲突。</p>
<p>这种需求下简单地使用 Replica Set 或是 Stateful Set 都是不能达到要求的，这两种资源都只能通过亲和性达到“尽量不部署在同一个节点”，做不到绝对。而且当节点数有变更时还需要手动更改设置。</p>
<p>下面是一个用 fluent-bit helm chart 部署的 fluent-bit Daemon Set 的例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">apps/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">DaemonSet</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    app.kubernetes.io/instance</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">    app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">  namespace</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  selector</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    matchLabels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      app.kubernetes.io/instance</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">      app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      labels</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        app.kubernetes.io/instance</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">        app.kubernetes.io/name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">fluent-bit</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">cr.fluentbit.io/fluent/fluent-bit:1.9.5</span></span>
<span data-line=""><span style="color:#E5C07B">        volumeMounts</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">varlibdockercontainers</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/lib/docker/containers</span></span>
<span data-line=""><span style="color:#E5C07B">          readOnly</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#A9B2C3">        - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">etcmachineid</span></span>
<span data-line=""><span style="color:#E5C07B">          mountPath</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/etc/machine-id</span></span>
<span data-line=""><span style="color:#E5C07B">          readOnly</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">true</span></span>
<span data-line=""><span style="color:#E5C07B">      volumes</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">varlibdockercontainers</span></span>
<span data-line=""><span style="color:#E5C07B">        hostPath</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/var/lib/docker/containers</span></span>
<span data-line=""><span style="color:#E5C07B">          type</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;&quot;</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">etcmachineid</span></span>
<span data-line=""><span style="color:#E5C07B">        hostPath</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          path</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">/etc/machine-id</span></span>
<span data-line=""><span style="color:#E5C07B">          type</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">File</span></span></code></pre></figure>
<p>Selector 之类的都是一样的了，而 Daemon Set 不能指定 replicas 。另外可以看到一个比较刺激的地方： Volume 里使用了 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>hostPath</span></span></code></span> 这种 Volume ，在 Pod 里直接指定了宿主机磁盘上的路径。</p>
<p>K8s 认为经过抽象后， Pod 不应该去关心自己在哪台宿主机上，一般来说是不推荐在 Pod 里直接访问宿主机路径的（不过也没有强制禁止）。不过 Daemon Set 是个特例，由于 Daemon Set 生成的 Pod 与节点强相关， K8s 十分推荐在且仅在 Daemon Set 的 Pod 中访问宿主机路径。</p>
<h3 id="job-与-cronjob"><a href="#job-与-cronjob" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Job 与 CronJob</h3>
<p>Replica Set ， Stateful Set ， Daemon Set 的 Pod 中运行的一般是持续运行的程序，因此这些 Pod 运行终止后会有相应的机制重启这些 Pod 。而 Job 与 Cron Job 这两种资源则专门负责调度不会持续运行的程序。</p>
<p>下面是 《Kubernetes in Action》 书中的一个例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">batch/v1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Job</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">pi</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  completions</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">5</span></span>
<span data-line=""><span style="color:#E5C07B">  parallelism</span><span style="color:#A9B2C3">: </span><span style="color:#56B6C2">2</span></span>
<span data-line=""><span style="color:#E5C07B">  template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">      - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">pi</span></span>
<span data-line=""><span style="color:#E5C07B">        image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">perl:5.34.0</span></span>
<span data-line=""><span style="color:#E5C07B">        command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">perl</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,  </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-Mbignum=bpi</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-wle</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">print bpi(2000)</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">      restartPolicy</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Never</span></span></code></pre></figure>
<p>可以看到，这个 Job 描述了一个会输出 PI 小数点后 2000 位的 Pod 模板。这个 Job 部署后，一共会以这个模板跑完 5 个 Pod ，其中最多并行跑 2 个，并在其中一个成功终止后再跑剩下的 Pod 。可以通过调整 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>completions</span></span></code></span> 与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>parallelism</span></span></code></span> 字段调整并行与穿行数量。</p>
<p>顺带一提，在 Job 定义中一般不会出现 selector ，但其实 Job 有 selector 字段，一般会由 K8s 为每个 Job 生成一个 uuid 作为 selector 。</p>
<p>另外，可以通过部署 CronJob 这种资源来定时执行 Job 。下面是 《Kubernetes in Action》 书中关于 CronJob 的例子：</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="yaml" data-theme="plastic"><code data-language="yaml" data-theme="plastic" style="display:grid"><span data-line=""><span style="color:#E5C07B">apiVersion</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">batch/v1beta1</span></span>
<span data-line=""><span style="color:#E5C07B">kind</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">CronJob</span></span>
<span data-line=""><span style="color:#E5C07B">metadata</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">pi</span></span>
<span data-line=""><span style="color:#E5C07B">spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">  schedule</span><span style="color:#A9B2C3">: </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">0 0 * * *</span><span style="color:#A9B2C3">&quot;</span></span>
<span data-line=""><span style="color:#E5C07B">  jobTemplate</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">    spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">      template</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">        spec</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#E5C07B">          containers</span><span style="color:#A9B2C3">:</span></span>
<span data-line=""><span style="color:#A9B2C3">          - </span><span style="color:#E5C07B">name</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">pi</span></span>
<span data-line=""><span style="color:#E5C07B">            image</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">perl:5.34.0</span></span>
<span data-line=""><span style="color:#E5C07B">            command</span><span style="color:#A9B2C3">: [</span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">perl</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">,  </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-Mbignum=bpi</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">-wle</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">, </span><span style="color:#A9B2C3">&quot;</span><span style="color:#98C379">print bpi(2000)</span><span style="color:#A9B2C3">&quot;</span><span style="color:#A9B2C3">]</span></span>
<span data-line=""><span style="color:#E5C07B">          restartPolicy</span><span style="color:#A9B2C3">: </span><span style="color:#98C379">Never</span></span></code></pre></figure>
<p>这个例子中， CronJob 会在每天的 0 点创建一个只运行一个 Pod 的 Job 。 CronJob 不会直接创建 Pod ，而是创建一个 Job ，再由 Job 创建 Pod （就像 Deployment 与 Replica Set 的关系）。另外， CronJob 创建的 Job 会限制 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>completions</span></span></code></span> 与 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>parallelism</span></span></code></span> 都只能等于 1 。</p>
<blockquote>
<p>关于资源的名称空间</p>
<p>在 K8s 中，各资源都是不能重名的。不能部署两个都叫 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>gateway</span></span></code></span> 的 Pod ，资源之间有可能因为名字冲突而导致部署不成功。（部署一个叫 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>gateway</span></span></code></span> 的 Pod 和一个叫 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>gateway</span></span></code></span> 的 Deployment 倒是可以，因为 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>gateway</span></span></code></span> 不是他们两个的全名，他们的全名分别叫 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>pod/gateway</span></span></code></span> 及 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>deployment/gateway</span></span></code></span> 。）
另外我们已经知道 Deployment 等资源一般会通过标签等来管理自己创建的资源，那两份不相关的应用完全有可能会撞标签，这时候部署逻辑就有可能会出问题。</p>
<p>K8s 中提供了名称空间这种资源，用于进行资源隔离。K8s 中大部分资源都从属于一个且仅从属于一个名称空间， Deployment 等资源一般只能控制在同一名称空间下的资源，而不会影响其他名称空间。</p>
<p>另外，也有一些资源是名称空间无关的，比如节点 <span data-rehype-pretty-code-figure=""><code data-language="plaintext" data-theme="plastic"><span data-line=""><span>Node</span></span></code></span> 。</p>
</blockquote></div><div class="w-96 text-gray-700 leading-none"><span class="!text-sm"><a class="!inline-block !p-0 !m-0 align-text-bottom" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" loading="lazy" width="88" height="31" decoding="async" data-nimg="1" class="!m-0 h-4 w-auto pr-1" style="color:transparent;border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/></a>This work is licensed under a<!-- --> <a class="underline" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</span></div><div class="TagsBox_tagsBox__WzhAf mt-4"><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/kubernetes">#<!-- -->Kubernetes</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/devops">#<!-- -->DevOps</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/docker">#<!-- -->Docker</a><a class="tag-word TagsBox_tag__Rk32C" href="/blog-next/tags/cloud-native">#<!-- -->Cloud Native</a></div><div class="mt-4 mb-4 flex justify-center"><div class="ml-0 mr-auto"><a href="/blog-next/articles/introduction-for-k8s-2">&lt;- Kubernetes 入门 （2）</a></div><div class="mr-0 ml-auto"><a href="/blog-next/articles/why-homogeneous">为什么使用在齐次坐标下矩阵乘法能表示点平移？ -&gt;</a></div></div><hr class="mt-4"/></article><div><h5 class="text-2xl font-bold pt-4">反向引用</h5><div class="flex-1 p-2 rounded-md hover:bg-bg-focus"><a class="flex items-center" href="/blog-next/ideas/blog-syntax"><div class="text-lg flex-grow h-fit overflow-ellipsis">博客语法渲染测试</div><div class="TagsBox_tagsBox__WzhAf py-4 md:py-1 flex-none"><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->Tag1</span><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->Tag2</span><span class="tag-word TagsBox_tag__Rk32C">#<!-- -->单行Tag</span></div></a></div><hr class="mt-4"/></div><div class="w-full"><div></div><div class="text-center">Loading comments...</div></div></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"><div class="inset-0 w-full h-full flex items-center justify-center bg-transparent"><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorPrimary css-14awfyb" style="width:40px;height:40px" role="progressbar"><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20.2" fill="none" stroke-width="3.6"></circle></svg></span></div></div></div><footer class="DefaultLayout_footer__aWV4u"><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="flex flex-row justify-center items-center"><div class="DefaultLayout_footerLeft__Qn_VV">© 2023 Ryo Jerry Yu. All rights reserved.</div><div class="DefaultLayout_footerRight__GlReP"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></div><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"introduction-for-k8s","tags":[{"tag":"Kubernetes","slug":"kubernetes","path":"/tags/kubernetes","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"DevOps","slug":"devops","path":"/tags/devops","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Docker","slug":"docker","path":"/tags/docker","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Cloud Native","slug":"cloud-native","path":"/tags/cloud-native","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]}],"source":{"compiledSource":"\"use strict\";\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = {\n    a: \"a\",\n    blockquote: \"blockquote\",\n    code: \"code\",\n    figure: \"figure\",\n    h1: \"h1\",\n    h3: \"h3\",\n    img: \"img\",\n    li: \"li\",\n    ol: \"ol\",\n    p: \"p\",\n    pre: \"pre\",\n    span: \"span\",\n    strong: \"strong\",\n    table: \"table\",\n    tbody: \"tbody\",\n    td: \"td\",\n    th: \"th\",\n    thead: \"thead\",\n    tr: \"tr\",\n    ul: \"ul\",\n    ..._provideComponents(),\n    ...props.components\n  }, {CodeBlockMermaid} = _components;\n  if (!CodeBlockMermaid) _missingMdxReference(\"CodeBlockMermaid\", true);\n  return _jsxs(_Fragment, {\n    children: [_jsxs(_components.h1, {\n      id: \"容器-docker-与-k8s\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#容器-docker-与-k8s\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"容器， Docker 与 K8s\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"关于容器虚拟化\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#关于容器虚拟化\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"关于容器虚拟化\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"\\\"Write once, run anywhere\\\" 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"要保证程序拉下来就能跑，最好的方法就是把程序和依赖打包到一起，然后将外部环境隔离起来。容器虚拟化技术就是为了解决这个。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"与常说的虚拟机不同， Docker 等各类容器是用隔离名称空间的方式进行资源隔离的。 Linux 系统的内核直接提供了名称空间隔离的能力，是针对进程设计的访问隔离机制，可以进行一些资源封装。\"\n    }), \"\\n\", _jsxs(_components.table, {\n      children: [_jsx(_components.thead, {\n        children: _jsxs(_components.tr, {\n          children: [_jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"名称空间\"\n          }), _jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"隔离内容\"\n          }), _jsx(_components.th, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"内核版本\"\n          })]\n        })\n      }), _jsxs(_components.tbody, {\n        children: [_jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"Mount\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"文件系统与路径等\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"2.4.19\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"UTS\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"主机的Hostname、Domain names\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"2.6.19\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"IPC\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"进程间通信管道\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"2.6.19\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"PID\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"独立的进程编号空间\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"2.6.24\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"Network\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"网卡、IP 地址、端口等网络资源\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"2.6.29\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"User\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"进程独立的用户和用户组\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"3.8\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"Cgroup\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"CPU 时间片，内存分页等\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"4.6\"\n          })]\n        }), _jsxs(_components.tr, {\n          children: [_jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"Time \u003c- New!\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"进程独立的系统时间\"\n          }), _jsx(_components.td, {\n            style: {\n              textAlign: \"left\"\n            },\n            children: \"5.6\"\n          })]\n        })]\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"值得注目的是， Linux 系统提供了 Cgroup 名称空间隔离的支持。通过隔离 Cgroup ，可以给单独一个进程分配 CPU 占用比率、内存大小、外设 I/O 访问权限等。再配合 IPC 、 PID 等的隔离，可以让被隔离的进程看不到同一实体机中其他进程的信息，就像是独享一整台机器一样。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"由于容器虚拟化技术直接利用了宿主机操作系统内核，因此远远要比虚拟机更轻量，也更适合用来给单个程序进行隔离。但也同样由于依赖了宿主机内核，在不同的架构、不同种类的操作系统间容器可能不能移植。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"关于-docker\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#关于-docker\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"关于 Docker\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"在介绍 K8s 之前，我们要先搞清楚 Docker 是什么。或者说，我们平时说的“ Docker ”是什么？\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"我们平时说的 Docker ，可能是以下几个东西：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"Docker Engine: 在宿主机上跑的一个进程，专门用来管理各个容器的生命周期、网络连接等，还暴露出一些 API 供外部调用。有时会被称为 Docker Daemon 或是 dockerd 。\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Docker Client: 命令行中的 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"docker\"\n              })\n            })\n          })\n        }), \" 命令，其实只会跟 Docker Server 通信，不会直接创建销毁一个容器进程。\"]\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Docker Container: 宿主机上运行的一组被资源隔离的进程，在容器中看来像是独占了一台虚拟的机器，不需要考虑外部依赖。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"Docker Image: 是一个打包好的文件系统，可以从一个 Image 运行出复数个 Container 。 Image 内部包含了程序运行所需的所有文件、库依赖，以及运行时的环境变量等。\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"Docker 容器运行时: 是 Docker Engine 中专门管理容器状态、生命周期等的那个组件，原来名为 libcontainer 。\", _jsx(_components.a, {\n          href: \"https://en.wikipedia.org/wiki/Open_Container_Initiative\",\n          children: \"《开放容器交互标准》\"\n        }), \"制定后， Docker 公司将此部分重构为 \", _jsx(_components.a, {\n          href: \"https://github.com/opencontainers/runc\",\n          children: \"runC 项目\"\n        }), \"，交给 Linux 基金会管理。而 Docker Engine 中与运行时进行交互的部分则抽象出来成为 \", _jsx(_components.a, {\n          href: \"https://containerd.io/\",\n          children: \"containerd 项目\"\n        }), \"，捐献给了 CNCF 。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们平时在 linux 机上运行 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"yum install docker\"\n            })\n          })\n        })\n      }), \" 之类的命令，安装的其实是 Docker Engine + Docker Client 。（而在 Windows 或 MacOS 上安装的 Docker Desktop 其实是一个定制过的 linux 虚拟机。）下面说的 Docker 的功能其实都是指 Docker Engine 的功能。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而 Docker 提供给我们的功能，除了最基础的运行和销毁容器外，还包括了一些容器网络编排、重启策略、文件路径映射、端口映射等功能。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而我认为 Docker 最大的贡献，还是容器的镜像与镜像仓库。有了镜像与镜像仓库，人们就可以把自己的程序与执行环境直接打包成镜像发布，也可以直接拿打包好的镜像来运行容器进行部署，而不需要额外下载或是安装一些东西，也不需要担心程序会与已经跑起来的其他程序冲突。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"为什么要用-k8s-\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#为什么要用-k8s-\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"为什么要用 K8s ？\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"其实 Docker 有一个很强大的工具叫 docker-compose ，可以通过一个 manifest 对多个容器组成的网络进行编排。那为什么我们还需要 K8s 呢？换句话说，有什么事是 Docker 不能做的？而 K8s 设计出来的目标是为了解决什么问题？\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"首先， Docker 做不到以下的功能：\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Docker 不能做跨多主机的容器编排。\"\n        }), \" docker-compose 再方便，他也只能编排单台主机上的容器。对跨主机的集群编排无能为力。（实际上，用了 Docker-Swarm 后是可以多主机编排的，但一来 Docker-Swarm 出现的比 K8s 晚，而来 Docker-Swarm 功能不如 K8s ，因此用的人很少，我们下面就默认 Docker-Swarm 不存在了。）\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Docker 提供的容器部署管理功能不够丰富。\"\n        }), \" Docker 有一些简单的容器重启策略，但也只是简单的失败后重启之类的，没有完整的应用状态检查等功能。同时，版本升级、缩扩容等策略选择的余地也不多。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"Docker 缺乏高级网络功能。\"\n        }), \" 要让 Docker 的容器间进行网络通信，也只能是说把容器放到同一个网络下，然后再通过各自的 Hostname 来找到对方。但实际上，我们更会想要一些负载均衡、自定义域名、选择某些容器端口不暴露之类的功能。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"and more...\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"总的来说， Docker 更关注单台主机上容器怎么跑，而对部署管理的功能则支持不多。而最大的痛点，就是 Docker 对多主机的集群部署支持的实再很差。然而，为了实现多区可用、负载均衡等功能，多主机集群的容器编排又是必不可少的。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"K8s 的出现，主要就是为了解决多主机集群上的容器编排问题。\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"K8s 可以进行多主机调度。\"\n        }), \" 用户只需要描述自己需要运行怎样的应用， K8s 就可以自己选择一个合适的节点进行部署，用户不需要关心自己的应用部署到哪个节点上。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"K8s 中一切皆资源。\"\n        }), \" K8s 有完善的抽象资源机制，用户几乎不需要知道磁盘、网络等任何硬件信息，只需要对着统一的抽象资源进行操作。\"]\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [_jsx(_components.strong, {\n          children: \"K8s 能保证较强的可用性。\"\n        }), \" 除了能跨多主机调度实现多区可用外， K8s 还提供了很完善的缩扩容机制、健康检查机制以及自动恢复机制。\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以说， K8s 是容器编排工具的主流选择。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"k8s-与-docker-的关系\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#k8s-与-docker-的关系\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"K8s 与 Docker 的关系\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"K8s 与 Docker 关系很复杂，是一个逐渐变化的过程。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"一开始 K8s 是完全依赖于 Docker Engine 进行容器启动与销毁的。后来\", _jsx(_components.a, {\n        href: \"https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/\",\n        children: \"容器运行时接口（CRI）\"\n      }), \"、 \", _jsx(_components.a, {\n        href: \"https://github.com/cri-o/cri-o\",\n        children: \"CRI-O 标准\"\n      }), \"、开放容器交互标准（OCI）等标准逐渐建立，可替代 Docker Engine 的工具越来越多， K8s 中已经完全可以不使用 Docker Engine 了。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.a, {\n        href: \"http://icyfenix.cn/\",\n        children: \"《凤凰架构》\"\n      }), \"一书中有下面这样一张图来描述 K8s 与 Docker Engine 的关系：\"]\n    }), \"\\n\", _jsx(_components.img, {\n      src: \"http://icyfenix.cn/assets/img/kubernetes.495f9eae.png\",\n      alt: \"K8s 与 Docker Engine 的关系\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"《凤凰架构》书中\", _jsx(_components.a, {\n        href: \"http://icyfenix.cn/immutable-infrastructure/container/history.html#%E5%B0%81%E8%A3%85%E9%9B%86%E7%BE%A4%EF%BC%9Akubernetes\",\n        children: \"这一章节\"\n      }), \"详细介绍了 K8s 与 Docker 的历史，我这里就不再赘述。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"部署一个-pod\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#部署一个-pod\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"部署一个 Pod\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"上面说了一堆概念，我们接下来实际上会怎样应用 K8s 。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"pod-示例\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#pod-示例\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Pod 示例\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"Pod 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。\\nPod 是一组容器；Pod 中的内容总是一同调度，在共享的上下文中运行。 Pod 中包含一个或多个应用容器，这些容器相对紧密地耦合在一起。在非云环境中，在相同的物理机或虚拟机上运行的应用类似于在同一逻辑主机上运行的云应用。\\n—— Kubernetes 官方文档\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Pod 是 K8s 的最小部署单位。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"因为 K8s 将硬件资源都抽象化了，用户不需要知道自己的应用部署到哪台机上。但是有些场景下两个主进程之间又必须相互协作才能完成任务，如果两个进程不确定会不会部署到同一个节点上会变得很麻烦。因此才需要 Pod 这种资源。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"下面是一个 Nginx Pod 的示例（这是 K8s manifest 文件，可以用 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kubectl apply -f \u003cfilepath\u003e\"\n            })\n          })\n        })\n      }), \" 进行部署）：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"simple-webapp\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"main-application\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/log/nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sidecar-container\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"busybox\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"sh\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"while true; do cat /var/log/nginx/access.log; sleep 30; done\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/log/nginx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared-logs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      emptyDir\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": {}\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以看到， Pod 中可以包含多个容器，这组容器总是以一定的逻辑一起部署，且总是部署在同一个节点。对 K8s 操作时，不能说只部署 Pod 中一个特定的容器，也不能说把 Pod 中一个容器部署在这个节点，另一个容器部署在另一个节点上。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"在上面这个例子中，我们看到 Pod 中除了 Nginx 容器以外还有一个 Sidecar 容器负责将 Nginx 的 access.log 日志输出到控制台。两个容器可以通过 mount 同一个路径来实现文件共享。这种场景下，单独跑一个 Sidecar 容器没有意义，而我们也不会希望两个容器部署在不同的节点上。 \", _jsx(_components.strong, {\n        children: \"两个容器同生共死\"\n      }), \" ，这样的模式被称为 \", _jsx(_components.strong, {\n        children: \"Sidecar 模式\"\n      }), \" 。 Jaeger Agent ，或是 Service Mesh 中常见的 Envoy Sidecar 都可以通过这种模式部署，这样业务容器中就可以不考虑 tracing 或是流量控制相关的问题。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"此外，由于同一个 Pod 中的容器默认共享了相同的 network 和 UTS 名称空间，不管是在 Pod 的内部还是外部来看，他们一定程度上就像是真的部署在同一主机上一样，有相同的 Hostname 与 ip 地址，在一个容器中也可以通过 localhost 来访问零一个容器的端口。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"另外 Pod 中可以定义若干个 initContainer ，这些容器会比 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.containers\"\n            })\n          })\n        })\n      }), \" 中的容器先运行，并且是顺序运行。下面是通过安装 bitnami 的 Kafka Helm Chart 得到的一个 Kafka Broker Pod （有所简化）:\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-0\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  namespace\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"docker.io/bitnami/kafka:3.1.0-debian-10-r52\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/setup.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"scripts\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/setup.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      subPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"setup.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/shared\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  initContainers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auto-discovery\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"docker.io/bitnami/kubectl:1.23.5-debian-10-r1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/auto-discovery.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/shared\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"    - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"scripts\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/auto-discovery.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      subPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"auto-discovery.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"scripts\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    configMap\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      defaultMode\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"493\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-scripts\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"shared\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    emptyDir\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": {}\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"可以看到，在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka\"\n            })\n          })\n        })\n      }), \" pod 启动前会先启动一个名为 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"auto-discovery\"\n            })\n          })\n        })\n      }), \" 的 initContainer ，负责获得集群信息等准备工作。准备工作完成后，会将信息写入 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"/shared\"\n            })\n          })\n        })\n      }), \" 目录下，然后再启动 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"kafka\"\n            })\n          })\n        })\n      }), \" 容器 Mount 同一目录，就可以获取准备好的信息。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [_jsx(_components.strong, {\n        children: \"这样运行容器进行 Pod 初始化就叫 initContainer 模式\"\n      }), \" 。每个 initContainer 会运行到成功退出为止，如果有一个 initContainer 启动失败，则整个 Pod 启动失败，触发 K8s 的 Pod 重启策略。\"]\n    }), \"\\n\", _jsxs(_components.h1, {\n      id: \"部署更多-pod\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#部署更多-pod\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"部署更多 Pod\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"replica-set\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#replica-set\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Replica Set\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可是上面说了这么多，还只是单个 Pod 的部署，但我们希望能做多副本部署。\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"其实，只要把 Pod 的 manifest 改一下 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"metadata.name\"\n            })\n          })\n        })\n      }), \" 再部署一次，就能得到一模一样的两个 Pod ，就是一个简单的多副本部署了。（必须改 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"metadata.name\"\n            })\n          })\n        })\n      }), \" ，不然 K8s 会以为你是想修改同一个 Pod ）\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可是这样做会有很多问题：\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"要复制一下还要改名字多麻烦啊，我想用同一份模板，只定义一下副本数就能得到对应数量的 Pod 。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"缩容扩容还要对着 Pod 操作很危险，我想直接修改副本数就能缩容扩容。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"如果其中一些 Pod 挂掉了不能重启，现在是什么都不会做。我希望能自动建一些新的 Pod 顶上，来保证副本数不变。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"为了实现这些需求，就出现了 Replica Set 这种资源。下面是实际应用中一个 Replica Set 的例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReplicaSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"xxxxxxxx.amazonaws.com/gateway:xxxxxxx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"containerPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"50051\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          protocol\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"TCP\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        readinessProbe\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          initialDelaySeconds\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"5\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          tcpSocket\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"50051\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        startupProbe\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          failureThreshold\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"60\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          tcpSocket\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            port\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"50051\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      affinity\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        podAntiAffinity\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          preferredDuringSchedulingIgnoredDuringExecution\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"          - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"podAffinityTerm\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              labelSelector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"                matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"                  app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"              topologyKey\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"topology.kubernetes.io/zone\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            weight\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"80\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"我们可以看到， \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.template\"\n            })\n          })\n        })\n      }), \" 中就是我们要的 Pod 的模板，在 metadata 里带上了 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"app:gateway\"\n            })\n          })\n        })\n      }), \" 标签。而在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.replicas\"\n            })\n          })\n        })\n      }), \" 中定义了我们需要的 Pod 数量， \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.selector\"\n            })\n          })\n        })\n      }), \" 中描述了我们要对带 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"app:gateway\"\n            })\n          })\n        })\n      }), \" 标签的 Pod 进行控制。把这份 manifest 部署后，我们就会得到除名字以外几乎一摸一样的两个 Pod ：\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  generateName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658-\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    pod-template-hash\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"9dc546658\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658-6c9qs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ownerReferences\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    blockOwnerDeletion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    controller\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReplicaSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    uid\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"6633f89c-377c-4c90-bd08-3be5bc7b21bd\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  resourceVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"49793842\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  uid\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"f927db88-a39a-4623-852d-4f150a6d853b\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"xxxxxxxx.amazonaws.com/gateway:xxxxxxx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 后续省略\"\n            })\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#D19A66\"\n              },\n              children: \"---\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Pod\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  annotations\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    kubernetes.io/psp\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"eks.privileged\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  creationTimestamp\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"2022-08-09T08:51:25Z\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  generateName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658-\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    pod-template-hash\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"9dc546658\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658-8trcs\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  ownerReferences\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    blockOwnerDeletion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    controller\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"ReplicaSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway-9dc546658\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    uid\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"6633f89c-377c-4c90-bd08-3be5bc7b21bd\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  resourceVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"49793745\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  uid\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"0918e3ed-2965-4237-8828-421a7831c9ed\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"xxxxxxxx.amazonaws.com/gateway:xxxxxxx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"    # 后续省略\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"可以看到，创建出来的 Pod 自动生成了两个后缀（ \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"6c9qs\"\n            })\n          })\n        })\n      }), \" 与 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"8trcs\"\n            })\n          })\n        })\n      }), \" ），带上了 Replica Set 的信息（在 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"metadata.ownerReferences\"\n            })\n          })\n        })\n      }), \" ），其他部分基本一模一样。如果其中一个 Pod 挂掉了， K8s 会帮我们从模板中重新创建一个 Pod 。而且由于我们在 Pod 模板定义了 affinity ， K8s 还会按照我们的要求自动筛选合适的节点。例如在上面 Replica Set 的例子中，创建出来的 Pod 就会尽量部署在不同的节点上。\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.strong, {\n          children: \"K8s 中对 Pod 的生存状态检查机制\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"除了线程直接错误退出以外，还有出现死锁等等各种可能性使得容器中的应用不能正常工作。这些情况下虽然是不健康状态，但容器却不一定会挂掉。因此 K8s 提供了一些探针检查的机制来判断 Pod 是否健康。\\nK8s 主要提供了三种探针：\"\n      }), \"\\n\", _jsxs(_components.ol, {\n        children: [\"\\n\", _jsxs(_components.li, {\n          children: [_jsx(_components.strong, {\n            children: \"存活探针（ liveness probe ）\"\n          }), \" : Pod 运行时 K8s 会循环执行 liveness probe 检查容器是否健康。如果检查失败， K8s 会认为这个容器不健康，就会尝试重启容器。\"]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [_jsx(_components.strong, {\n            children: \"就绪探针（ readiness probe ）\"\n          }), \" : 程序可能会有一段时间不能提供服务（比如正在加载数据等）。这时可能既不想杀死应用，也不想给它发送请求，这时就需要 readiness probe 。如果 readiness probe 检查失败， K8s 就会将这个 Pod 从 Service 上摘下来，直到 readiness probe 成功重新加入 Service 。\"]\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [_jsx(_components.strong, {\n            children: \"启动探针（ startup probe ）\"\n          }), \" : 有些程序会有非常长的启动时间，会有较长时间不能提供服务。这时如果 liveness probe 失败了导致重启毫无必要，此时就需要 startup probe 。 startup probe 只会在容器启动时检查直到第一次成功。直到 startup probe 成功为止， liveness probe 与 readiness probe 都不会开始执行检查。\"]\n        }), \"\\n\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"而检测方式主要有：\"\n      }), \"\\n\", _jsxs(_components.ol, {\n        children: [\"\\n\", _jsx(_components.li, {\n          children: \"httpGet: 对指定的端口路径执行 HTTP GET 请求，如果返回 2xx 或 3xx 就是成功。\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"tcpSocket: 尝试与容器的端口建立连接，如果不能成功建立连接就是失败。\"\n        }), \"\\n\", _jsx(_components.li, {\n          children: \"exec: 在容器内执行一段命令，如果退出时状态码不为 0 就是失败。\"\n        }), \"\\n\", _jsxs(_components.li, {\n          children: [\"grpc (New!): K8s 1.24 新出的检查方式，直接用 \", _jsx(_components.a, {\n            href: \"https://github.com/grpc/grpc/blob/master/doc/health-checking.md\",\n            children: \"GRPC Health Checking Protocol\"\n          }), \" 对 GRPC Server 进行检查。\"]\n        }), \"\\n\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"此外， Replica Set 还提供了简易的缩容扩容功能。 kubectl 中提供了 scale 命令：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"bash\",\n        \"data-theme\": \"plastic\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"bash\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" scale\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" replicaset\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" gateway\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" --replicas=10\"\n            })]\n          })\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"执行上述命令，就可以将名为 gateway 的 Replica Set 对应的副本数扩容到 10 份。当然，你也可以直接修改 Replica Set 的 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"spec.replicas\"\n            })\n          })\n        })\n      }), \" 字段来实现缩容扩容。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"然而， Replica Set 的功能还是有限的。实际上， Replica Set 只关心跟它的 selector 匹配的 Pod 的数量。而至于匹配的 Pod 是否真的是跟 template 字段中描述的一样， Replica Set 就不关心了。因此如果单用 Replica Set ，更新 Pod 就会变得究极麻烦。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"deployment\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#deployment\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Deployment\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"为了解决 Pod 的更新问题，我们需要有 Deployment 这种资源。实际上， Replica Set 的主要用途是提供给 Deployment 作为控制 Pod 数量，以及创建、删除 Pod 的一种机制。我们一般不会直接使用 Replica Set 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是实际应用中一个 Deployment 的例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Deployment\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  revisionHistoryLimit\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"10\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"xxxxxxxx.amazonaws.com/gateway:xxxxxxx\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"        # 下略\"\n            })\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以看到 Deployment 的 manifest 跟 Replica Set 很像。但实际上， Deployment 不会直接创建 Pod ，而是创建出一个 Replica Set ，再由 Replica Set 来创建 Pod ：\"\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"flowchart TB\\n\\nDeployment1[Deployment]\\nReplicaSet11[Replica Set]\\nPod11[Pod1]\\nPod12[Pod2]\\nDeployment1 --\u003e ReplicaSet11\\nReplicaSet11 --\u003e Pod11\\nReplicaSet11 --\u003e Pod12\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"比如在上面的例子中，名为 gateway 的 Deployment 创建后，就会有如下 ReplicaSet 和 Pod ：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# Replica Set:\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" rc\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app=gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                 DESIRED\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   CURRENT\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-9dc546658\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"    2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       5d3h\"\n            })]\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: \" \"\n          }), \"\\n\", _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# Pod:\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" po\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app=gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                      READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    RESTARTS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-9dc546658-6c9qs\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          5d3h\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-9dc546658-8trcs\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          5d3h\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"可以看到，gateway Deployment 创建了一个 Replica Set ，然后随机给了它一个 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"9dc546658\"\n            })\n          })\n        })\n      }), \" 后缀。然后 gateway-9dc546658 这个 Replica Set 又根据 template 中创建了两个 Pod ，再在自己名字的基础上加上两个后缀 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"6c9qs\"\n            })\n          })\n        })\n      }), \" 与 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"8trcs\"\n            })\n          })\n        })\n      }), \" 。\"]\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"接下来就是 Deployment 的重点了： Replica Set 只会根据 template 创建出 Pod ，而不管匹配的 Pod 到底是不是跟 template 中描述的一样。而 \", _jsx(_components.strong, {\n        children: \"Deployment 则会专门关注 template 的内容变更。\"\n      })]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"假如我们现在更新了 Deployment 的 template 中的内容提交给 K8s ， Deployment 就会感知到 template 被修改了， Pod 需要更新。\\n感知到更新之后， Deployment 就会创建一个新的 Replica Set 。然后逐渐将旧的 Replica Set 缩容到 0 ，并同时将新的 Replica Set 扩容到目标值。最后，所有旧版本的 Pod 将会被更新成新版本的 Pod 。如下图所示：\"\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"flowchart TB\\n\\nsubgraph A\\ndirection TB\\nDeployment1[Deployment]\\nReplicaSet11[Replica Set]\\nReplicaSet12[New Replica Set]\\nPod11[Pod1]\\nPod12[Pod2]\\nDeployment1 --\u003e ReplicaSet11\\nDeployment1 --\u003e ReplicaSet12\\nReplicaSet11 --\u003e Pod11\\nReplicaSet11 --\u003e Pod12\\nend\\n\\nsubgraph B\\ndirection TB\\nDeployment2[Deployment]\\nReplicaSet21[Replica Set]\\nReplicaSet22[New Replica Set]\\nPod21[New Pod1]\\nPod22[Pod2]\\nDeployment2 --\u003e ReplicaSet21\\nDeployment2 --\u003e ReplicaSet22\\nReplicaSet21 --\u003e Pod22\\nReplicaSet22 --\u003e Pod21\\nend\\n\\nsubgraph C\\ndirection TB\\nDeployment3[Deployment]\\nReplicaSet31[Replica Set]\\nReplicaSet32[New Replica Set]\\nPod31[New Pod1]\\nPod32[New Pod2]\\nDeployment3 --\u003e ReplicaSet31\\nDeployment3 --\u003e ReplicaSet32\\nReplicaSet32 --\u003e Pod31\\nReplicaSet32 --\u003e Pod32\\nend\\n\\nA --\u003e B --\u003e C\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"整个过程完成后， Deployment 还不会将旧的 Replica Set 删除掉。我们注意到 Deployment 的声明中有这么一个字段： \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"revisionHistoryLimit: 10\"\n            })\n          })\n        })\n      }), \" ，表示 Deployment 会保留历史中 最近的 10 个 Replica Set ，这样在必要的时候可以立刻将 Deployment 回滚到上个版本。而超出 10 个的 Replica Set 才会被从 K8s 中删除。\"]\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              style: {\n                color: \"#5F6672\",\n                fontStyle: \"italic\"\n              },\n              children: \"# 实际中被 scale 到 0 但还没被删除的 Replica Set\"\n            })\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" rs\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app=gateway\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"                 DESIRED\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   CURRENT\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-5c4cdf957d\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       5d4h\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-5c56f6d487\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       17d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-65857cfc78\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       10d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-6bddbdd85f\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       16d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-6cc9bb5b4c\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       13d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-6f4664bc65\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       17d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-7bd667cb79\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       9d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-7d658d57f5\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       13d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-84df97d4c8\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       6d4h\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-9998f4689\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"    0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       13d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"gateway-9dc546658\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"    2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"         2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"       5d4h\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"stateful-set\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#stateful-set\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Stateful Set\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Deployment 中默认了我们不关心自己访问的是哪个 Pod ，因为各个 Pod 的功能是一样的，访问哪个没有差别。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"实际上这也符合大多数情况：试想一个 HTTP Server ，如果其所有数据都存放到同一个的数据库中，那这个 HTTP Server 不管部署在哪台主机、不管有多少个实例、不管你访问的是哪个实例，都察觉不出有什么差别。而有了这种默认，我们就能更放心地对 Pod 进行负载均衡、缩扩容等操作。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"但实际上我们总会遇到需要保存自己状态的 Pod 。比如我们在 K8s 里部署一个 Kafka 集群，每个 Kafka broker 都需要保存自己的分区数据，而且还要往 Zookeeper 里写入自己的名字来实现选举等功能。如果简单地用 Deployment 来部署， broker 之间可能就会分不清到底哪块是自己的分区，而且由 Deployment 生成出来的 Pod 名字是随机的，升级后 Pod 的名字会变，导致 Kafka 升级后名字与 Zookeeper 里的名字不一致，被以为是一个新的 broker 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Stateful Set 就是为了解决有状态应用的部署而出现的。下面是 用 bitnami 的 Kafka Helm Chart 部署的一个 Kafka Stateful Set 的例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"StatefulSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  replicas\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"3\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  serviceName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-headless\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"docker.io/bitnami/kafka:3.1.0-debian-10-r52\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/scripts/setup.sh\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        ports\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"containerPort\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"9092\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"kafka-client\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          protocol\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"TCP\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/bitnami/kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"data\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  volumeClaimTemplates\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"  - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"PersistentVolumeClaim\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"data\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      resources\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        requests\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          storage\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"10Gi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      storageClassName\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"gp2\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"可以看到其实 Stateful Set 类似 Deployment ，也可以通过 replicas 字段定义实例数，如果更新 template 部分， Stateful Set 也会以一定的策略对 Pod 进行更新。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"而其创建出来的 Pod 如下所示：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"sh\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"sh\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"$\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" kubectl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" get\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" po\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \" -l\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \" app.kubernetes.io/name=kafka\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"NAME\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"      READY\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   STATUS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"    RESTARTS\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   AGE\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-0\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          26d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          26d\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#B57EDC\"\n              },\n              children: \"kafka-2\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"   1/1\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"     Running\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"   3\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"          26d\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"与 Replica Set 创建出来的 Pod 相比名字上会有很大差别。 Stateful Set 创建出来的 Pod 会固定的以 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"-0\"\n            })\n          })\n        })\n      }), \" 、 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"-1\"\n            })\n          })\n        })\n      }), \" 、 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"-2\"\n            })\n          })\n        })\n      }), \" 结尾而不是随机生成：\"]\n    }), \"\\n\", _jsx(CodeBlockMermaid, {\n      lang: \"mermaid\",\n      value: \"flowchart TB\\nrs[Replica Set A]\\nrs --\u003e A-qwert\\nrs --\u003e A-asdfg\\nrs --\u003e A-zxcvb\\n\\nss[Stateful Set A]\\nss --\u003e A-0\\nss --\u003e A-1\\nss --\u003e A-2\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这样一来，更新时将 Pod 更换之后，新的 Pod 仍能够跟旧的 Pod 保持相同的名字。此外，与 Deployment 相比， Stateful Set 更新后同名的 Pod 仍能保持原来的 IP ，拿到同一个持久化卷，而且不同的 Pod 还能通过独立的 DNS 记录相互区分。这些内容后面还会详细介绍。\"\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: _jsx(_components.strong, {\n          children: \"宠物与牛（ Cattle vs Pets ）的比喻\"\n        })\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"Deployment 更倾向于将 Pod 看作是牛：我们不会去关心每一个 Pod 个体，如果有一个 Pod 出现了问题，我们只需要把他杀掉并替换成新的 Pod 就好。\"\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"但 Stateful Set 更倾向于将 Pod 看作是宠物：弄来一直完全一模一样的宠物并不是容易的事，我们对待这些宠物必须小心翼翼。我们要给他们各自一个专属的名字，替换掉一只宠物时，必须要保证它的花色、名字、行为举止都与之前那只宠物一模一样。\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"daemon-set\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#daemon-set\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Daemon Set\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"不管是 Deployment 还是 Stateful Set ，一般都不会在意自己的 Pod 部署到哪个节点。而假如你不在意自己 Pod 的数量，但需要保证每个节点上都运行一个 Pod 时，就需要 Daemon Set 了。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"需要保证每个节点上有且只有一个 Pod 在运行这种情况，经常会在基础结构相关的操作中出现。比如我需要在集群中部署 fluentd 采集 log ，一般来说需要在 Pod 里直接挂载节点磁盘上的文件路径。这种时候如果有一个节点上没有运行 Pod ，那个节点的 log 就采集不到；另一方面，一个节点上运行多个 Pod 毫无意义，而且可能还会导致 log 重复等冲突。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"这种需求下简单地使用 Replica Set 或是 Stateful Set 都是不能达到要求的，这两种资源都只能通过亲和性达到“尽量不部署在同一个节点”，做不到绝对。而且当节点数有变更时还需要手动更改设置。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是一个用 fluent-bit helm chart 部署的 fluent-bit Daemon Set 的例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"apps/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"DaemonSet\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app.kubernetes.io/instance\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  namespace\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  selector\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    matchLabels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app.kubernetes.io/instance\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      labels\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app.kubernetes.io/instance\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        app.kubernetes.io/name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"fluent-bit\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"cr.fluentbit.io/fluent/fluent-bit:1.9.5\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        volumeMounts\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"varlibdockercontainers\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/lib/docker/containers\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          readOnly\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"        - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"etcmachineid\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          mountPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/etc/machine-id\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          readOnly\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"true\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      volumes\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"varlibdockercontainers\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        hostPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/var/lib/docker/containers\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"etcmachineid\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        hostPath\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          path\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"/etc/machine-id\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          type\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"File\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Selector 之类的都是一样的了，而 Daemon Set 不能指定 replicas 。另外可以看到一个比较刺激的地方： Volume 里使用了 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"hostPath\"\n            })\n          })\n        })\n      }), \" 这种 Volume ，在 Pod 里直接指定了宿主机磁盘上的路径。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"K8s 认为经过抽象后， Pod 不应该去关心自己在哪台宿主机上，一般来说是不推荐在 Pod 里直接访问宿主机路径的（不过也没有强制禁止）。不过 Daemon Set 是个特例，由于 Daemon Set 生成的 Pod 与节点强相关， K8s 十分推荐在且仅在 Daemon Set 的 Pod 中访问宿主机路径。\"\n    }), \"\\n\", _jsxs(_components.h3, {\n      id: \"job-与-cronjob\",\n      children: [_jsx(_components.a, {\n        \"aria-hidden\": \"true\",\n        tabIndex: \"-1\",\n        href: \"#job-与-cronjob\",\n        children: _jsx(_components.span, {\n          className: \"icon icon-link\"\n        })\n      }), \"Job 与 CronJob\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"Replica Set ， Stateful Set ， Daemon Set 的 Pod 中运行的一般是持续运行的程序，因此这些 Pod 运行终止后会有相应的机制重启这些 Pod 。而 Job 与 Cron Job 这两种资源则专门负责调度不会持续运行的程序。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"下面是 《Kubernetes in Action》 书中的一个例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"batch/v1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Job\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"pi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  completions\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"5\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  parallelism\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#56B6C2\"\n              },\n              children: \"2\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"      - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"pi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"perl:5.34.0\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"perl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-Mbignum=bpi\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-wle\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"print bpi(2000)\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      restartPolicy\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Never\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"可以看到，这个 Job 描述了一个会输出 PI 小数点后 2000 位的 Pod 模板。这个 Job 部署后，一共会以这个模板跑完 5 个 Pod ，其中最多并行跑 2 个，并在其中一个成功终止后再跑剩下的 Pod 。可以通过调整 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"completions\"\n            })\n          })\n        })\n      }), \" 与 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"parallelism\"\n            })\n          })\n        })\n      }), \" 字段调整并行与穿行数量。\"]\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"顺带一提，在 Job 定义中一般不会出现 selector ，但其实 Job 有 selector 字段，一般会由 K8s 为每个 Job 生成一个 uuid 作为 selector 。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"另外，可以通过部署 CronJob 这种资源来定时执行 Job 。下面是 《Kubernetes in Action》 书中关于 CronJob 的例子：\"\n    }), \"\\n\", _jsx(_components.figure, {\n      \"data-rehype-pretty-code-figure\": \"\",\n      children: _jsx(_components.pre, {\n        tabIndex: \"0\",\n        \"data-language\": \"yaml\",\n        \"data-theme\": \"plastic\",\n        children: _jsxs(_components.code, {\n          \"data-language\": \"yaml\",\n          \"data-theme\": \"plastic\",\n          style: {\n            display: \"grid\"\n          },\n          children: [_jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"apiVersion\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"batch/v1beta1\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"kind\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"CronJob\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"metadata\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"pi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  schedule\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"0 0 * * *\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"  jobTemplate\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"    spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"      template\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"        spec\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          containers\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \":\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"          - \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"name\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"pi\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            image\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"perl:5.34.0\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"            command\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": [\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"perl\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \",  \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-Mbignum=bpi\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"-wle\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \", \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"print bpi(2000)\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"\\\"\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \"]\"\n            })]\n          }), \"\\n\", _jsxs(_components.span, {\n            \"data-line\": \"\",\n            children: [_jsx(_components.span, {\n              style: {\n                color: \"#E5C07B\"\n              },\n              children: \"          restartPolicy\"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#A9B2C3\"\n              },\n              children: \": \"\n            }), _jsx(_components.span, {\n              style: {\n                color: \"#98C379\"\n              },\n              children: \"Never\"\n            })]\n          })]\n        })\n      })\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"这个例子中， CronJob 会在每天的 0 点创建一个只运行一个 Pod 的 Job 。 CronJob 不会直接创建 Pod ，而是创建一个 Job ，再由 Job 创建 Pod （就像 Deployment 与 Replica Set 的关系）。另外， CronJob 创建的 Job 会限制 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"completions\"\n            })\n          })\n        })\n      }), \" 与 \", _jsx(_components.span, {\n        \"data-rehype-pretty-code-figure\": \"\",\n        children: _jsx(_components.code, {\n          \"data-language\": \"plaintext\",\n          \"data-theme\": \"plastic\",\n          children: _jsx(_components.span, {\n            \"data-line\": \"\",\n            children: _jsx(_components.span, {\n              children: \"parallelism\"\n            })\n          })\n        })\n      }), \" 都只能等于 1 。\"]\n    }), \"\\n\", _jsxs(_components.blockquote, {\n      children: [\"\\n\", _jsx(_components.p, {\n        children: \"关于资源的名称空间\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"在 K8s 中，各资源都是不能重名的。不能部署两个都叫 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"gateway\"\n              })\n            })\n          })\n        }), \" 的 Pod ，资源之间有可能因为名字冲突而导致部署不成功。（部署一个叫 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"gateway\"\n              })\n            })\n          })\n        }), \" 的 Pod 和一个叫 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"gateway\"\n              })\n            })\n          })\n        }), \" 的 Deployment 倒是可以，因为 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"gateway\"\n              })\n            })\n          })\n        }), \" 不是他们两个的全名，他们的全名分别叫 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"pod/gateway\"\n              })\n            })\n          })\n        }), \" 及 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"deployment/gateway\"\n              })\n            })\n          })\n        }), \" 。）\\n另外我们已经知道 Deployment 等资源一般会通过标签等来管理自己创建的资源，那两份不相关的应用完全有可能会撞标签，这时候部署逻辑就有可能会出问题。\"]\n      }), \"\\n\", _jsx(_components.p, {\n        children: \"K8s 中提供了名称空间这种资源，用于进行资源隔离。K8s 中大部分资源都从属于一个且仅从属于一个名称空间， Deployment 等资源一般只能控制在同一名称空间下的资源，而不会影响其他名称空间。\"\n      }), \"\\n\", _jsxs(_components.p, {\n        children: [\"另外，也有一些资源是名称空间无关的，比如节点 \", _jsx(_components.span, {\n          \"data-rehype-pretty-code-figure\": \"\",\n          children: _jsx(_components.code, {\n            \"data-language\": \"plaintext\",\n            \"data-theme\": \"plastic\",\n            children: _jsx(_components.span, {\n              \"data-line\": \"\",\n              children: _jsx(_components.span, {\n                children: \"Node\"\n              })\n            })\n          })\n        }), \" 。\"]\n      }), \"\\n\"]\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = {\n    ..._provideComponents(),\n    ...props.components\n  };\n  return MDXLayout ? _jsx(MDXLayout, {\n    ...props,\n    children: _jsx(_createMdxContent, {\n      ...props\n    })\n  }) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\nfunction _missingMdxReference(id, component) {\n  throw new Error(\"Expected \" + (component ? \"component\" : \"object\") + \" `\" + id + \"` to be defined: you likely forgot to import, pass, or provide it.\");\n}\n","frontmatter":{},"scope":{}},"meta":{"content":"\n# 容器， Docker 与 K8s\n\n我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？\n\n### 关于容器虚拟化\n\n\u003e 要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》\n\n\"Write once, run anywhere\" 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。\n\n要保证程序拉下来就能跑，最好的方法就是把程序和依赖打包到一起，然后将外部环境隔离起来。容器虚拟化技术就是为了解决这个。\n\n与常说的虚拟机不同， Docker 等各类容器是用隔离名称空间的方式进行资源隔离的。 Linux 系统的内核直接提供了名称空间隔离的能力，是针对进程设计的访问隔离机制，可以进行一些资源封装。\n\n| 名称空间     | 隔离内容                      | 内核版本 |\n| :----------- | :---------------------------- | :------- |\n| Mount        | 文件系统与路径等              | 2.4.19   |\n| UTS          | 主机的Hostname、Domain names  | 2.6.19   |\n| IPC          | 进程间通信管道                | 2.6.19   |\n| PID          | 独立的进程编号空间            | 2.6.24   |\n| Network      | 网卡、IP 地址、端口等网络资源 | 2.6.29   |\n| User         | 进程独立的用户和用户组        | 3.8      |\n| Cgroup       | CPU 时间片，内存分页等        | 4.6      |\n| Time \\\u003c- New! | 进程独立的系统时间            | 5.6      |\n\n值得注目的是， Linux 系统提供了 Cgroup 名称空间隔离的支持。通过隔离 Cgroup ，可以给单独一个进程分配 CPU 占用比率、内存大小、外设 I/O 访问权限等。再配合 IPC 、 PID 等的隔离，可以让被隔离的进程看不到同一实体机中其他进程的信息，就像是独享一整台机器一样。\n\n由于容器虚拟化技术直接利用了宿主机操作系统内核，因此远远要比虚拟机更轻量，也更适合用来给单个程序进行隔离。但也同样由于依赖了宿主机内核，在不同的架构、不同种类的操作系统间容器可能不能移植。\n\n### 关于 Docker\n\n在介绍 K8s 之前，我们要先搞清楚 Docker 是什么。或者说，我们平时说的“ Docker ”是什么？\n\n我们平时说的 Docker ，可能是以下几个东西：\n\n- Docker Engine: 在宿主机上跑的一个进程，专门用来管理各个容器的生命周期、网络连接等，还暴露出一些 API 供外部调用。有时会被称为 Docker Daemon 或是 dockerd 。\n- Docker Client: 命令行中的 `docker` 命令，其实只会跟 Docker Server 通信，不会直接创建销毁一个容器进程。\n- Docker Container: 宿主机上运行的一组被资源隔离的进程，在容器中看来像是独占了一台虚拟的机器，不需要考虑外部依赖。\n- Docker Image: 是一个打包好的文件系统，可以从一个 Image 运行出复数个 Container 。 Image 内部包含了程序运行所需的所有文件、库依赖，以及运行时的环境变量等。\n- Docker 容器运行时: 是 Docker Engine 中专门管理容器状态、生命周期等的那个组件，原来名为 libcontainer 。[《开放容器交互标准》](https://en.wikipedia.org/wiki/Open_Container_Initiative)制定后， Docker 公司将此部分重构为 [runC 项目](https://github.com/opencontainers/runc)，交给 Linux 基金会管理。而 Docker Engine 中与运行时进行交互的部分则抽象出来成为 [containerd 项目](https://containerd.io/)，捐献给了 CNCF 。\n\n我们平时在 linux 机上运行 `yum install docker` 之类的命令，安装的其实是 Docker Engine + Docker Client 。（而在 Windows 或 MacOS 上安装的 Docker Desktop 其实是一个定制过的 linux 虚拟机。）下面说的 Docker 的功能其实都是指 Docker Engine 的功能。\n\n而 Docker 提供给我们的功能，除了最基础的运行和销毁容器外，还包括了一些容器网络编排、重启策略、文件路径映射、端口映射等功能。\n\n而我认为 Docker 最大的贡献，还是容器的镜像与镜像仓库。有了镜像与镜像仓库，人们就可以把自己的程序与执行环境直接打包成镜像发布，也可以直接拿打包好的镜像来运行容器进行部署，而不需要额外下载或是安装一些东西，也不需要担心程序会与已经跑起来的其他程序冲突。\n\n### 为什么要用 K8s ？\n\n其实 Docker 有一个很强大的工具叫 docker-compose ，可以通过一个 manifest 对多个容器组成的网络进行编排。那为什么我们还需要 K8s 呢？换句话说，有什么事是 Docker 不能做的？而 K8s 设计出来的目标是为了解决什么问题？\n\n首先， Docker 做不到以下的功能：\n\n1. **Docker 不能做跨多主机的容器编排。** docker-compose 再方便，他也只能编排单台主机上的容器。对跨主机的集群编排无能为力。（实际上，用了 Docker-Swarm 后是可以多主机编排的，但一来 Docker-Swarm 出现的比 K8s 晚，而来 Docker-Swarm 功能不如 K8s ，因此用的人很少，我们下面就默认 Docker-Swarm 不存在了。）\n2. **Docker 提供的容器部署管理功能不够丰富。** Docker 有一些简单的容器重启策略，但也只是简单的失败后重启之类的，没有完整的应用状态检查等功能。同时，版本升级、缩扩容等策略选择的余地也不多。\n3. **Docker 缺乏高级网络功能。** 要让 Docker 的容器间进行网络通信，也只能是说把容器放到同一个网络下，然后再通过各自的 Hostname 来找到对方。但实际上，我们更会想要一些负载均衡、自定义域名、选择某些容器端口不暴露之类的功能。\n\nand more...\n\n总的来说， Docker 更关注单台主机上容器怎么跑，而对部署管理的功能则支持不多。而最大的痛点，就是 Docker 对多主机的集群部署支持的实再很差。然而，为了实现多区可用、负载均衡等功能，多主机集群的容器编排又是必不可少的。\n\nK8s 的出现，主要就是为了解决多主机集群上的容器编排问题。\n\n1. **K8s 可以进行多主机调度。** 用户只需要描述自己需要运行怎样的应用， K8s 就可以自己选择一个合适的节点进行部署，用户不需要关心自己的应用部署到哪个节点上。\n2. **K8s 中一切皆资源。** K8s 有完善的抽象资源机制，用户几乎不需要知道磁盘、网络等任何硬件信息，只需要对着统一的抽象资源进行操作。\n3. **K8s 能保证较强的可用性。** 除了能跨多主机调度实现多区可用外， K8s 还提供了很完善的缩扩容机制、健康检查机制以及自动恢复机制。\n\n可以说， K8s 是容器编排工具的主流选择。\n\n### K8s 与 Docker 的关系\n\nK8s 与 Docker 关系很复杂，是一个逐渐变化的过程。\n\n一开始 K8s 是完全依赖于 Docker Engine 进行容器启动与销毁的。后来[容器运行时接口（CRI）](https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/)、 [CRI-O 标准](https://github.com/cri-o/cri-o)、开放容器交互标准（OCI）等标准逐渐建立，可替代 Docker Engine 的工具越来越多， K8s 中已经完全可以不使用 Docker Engine 了。\n\n[《凤凰架构》](http://icyfenix.cn/)一书中有下面这样一张图来描述 K8s 与 Docker Engine 的关系：\n\n![K8s 与 Docker Engine 的关系](http://icyfenix.cn/assets/img/kubernetes.495f9eae.png)\n\n《凤凰架构》书中[这一章节](http://icyfenix.cn/immutable-infrastructure/container/history.html#%E5%B0%81%E8%A3%85%E9%9B%86%E7%BE%A4%EF%BC%9Akubernetes)详细介绍了 K8s 与 Docker 的历史，我这里就不再赘述。\n\n# 部署一个 Pod\n\n上面说了一堆概念，我们接下来实际上会怎样应用 K8s 。\n\n### Pod 示例\n\n\u003e Pod 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。\n\u003e Pod 是一组容器；Pod 中的内容总是一同调度，在共享的上下文中运行。 Pod 中包含一个或多个应用容器，这些容器相对紧密地耦合在一起。在非云环境中，在相同的物理机或虚拟机上运行的应用类似于在同一逻辑主机上运行的云应用。\n\u003e —— Kubernetes 官方文档\n\nPod 是 K8s 的最小部署单位。\n\n因为 K8s 将硬件资源都抽象化了，用户不需要知道自己的应用部署到哪台机上。但是有些场景下两个主进程之间又必须相互协作才能完成任务，如果两个进程不确定会不会部署到同一个节点上会变得很麻烦。因此才需要 Pod 这种资源。\n\n下面是一个 Nginx Pod 的示例（这是 K8s manifest 文件，可以用 `kubectl apply -f \u003cfilepath\u003e` 进行部署）：\n\n```yaml\nmetadata:\n  name: simple-webapp\nspec:\n  containers:\n    - name: main-application\n      image: nginx\n      volumeMounts:\n        - name: shared-logs\n          mountPath: /var/log/nginx\n    - name: sidecar-container\n      image: busybox\n      command: [\"sh\",\"-c\",\"while true; do cat /var/log/nginx/access.log; sleep 30; done\"]\n      volumeMounts:\n        - name: shared-logs\n          mountPath: /var/log/nginx\n  volumes:\n    - name: shared-logs\n      emptyDir: {}\n```\n\n可以看到， Pod 中可以包含多个容器，这组容器总是以一定的逻辑一起部署，且总是部署在同一个节点。对 K8s 操作时，不能说只部署 Pod 中一个特定的容器，也不能说把 Pod 中一个容器部署在这个节点，另一个容器部署在另一个节点上。\n\n在上面这个例子中，我们看到 Pod 中除了 Nginx 容器以外还有一个 Sidecar 容器负责将 Nginx 的 access.log 日志输出到控制台。两个容器可以通过 mount 同一个路径来实现文件共享。这种场景下，单独跑一个 Sidecar 容器没有意义，而我们也不会希望两个容器部署在不同的节点上。 **两个容器同生共死** ，这样的模式被称为 **Sidecar 模式** 。 Jaeger Agent ，或是 Service Mesh 中常见的 Envoy Sidecar 都可以通过这种模式部署，这样业务容器中就可以不考虑 tracing 或是流量控制相关的问题。\n\n此外，由于同一个 Pod 中的容器默认共享了相同的 network 和 UTS 名称空间，不管是在 Pod 的内部还是外部来看，他们一定程度上就像是真的部署在同一主机上一样，有相同的 Hostname 与 ip 地址，在一个容器中也可以通过 localhost 来访问零一个容器的端口。\n\n另外 Pod 中可以定义若干个 initContainer ，这些容器会比 `spec.containers` 中的容器先运行，并且是顺序运行。下面是通过安装 bitnami 的 Kafka Helm Chart 得到的一个 Kafka Broker Pod （有所简化）:\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  name: kafka-0\n  namespace: kafka\nspec:\n  containers:\n  - name: kafka\n    image: docker.io/bitnami/kafka:3.1.0-debian-10-r52\n    command:\n    - /scripts/setup.sh\n    volumeMounts:\n    - name: scripts\n      mountPath: /scripts/setup.sh\n      subPath: setup.sh\n    - name: shared\n      mountPath: /shared\n  initContainers:\n  - name: auto-discovery\n    image: docker.io/bitnami/kubectl:1.23.5-debian-10-r1\n    command:\n    - /scripts/auto-discovery.sh\n    volumeMounts:\n    - name: shared\n      mountPath: /shared\n    - name: scripts\n      mountPath: /scripts/auto-discovery.sh\n      subPath: auto-discovery.sh\n  volumes:\n  - name: scripts\n    configMap:\n      defaultMode: 493\n      name: kafka-scripts\n  - name: shared\n    emptyDir: {}\n```\n\n可以看到，在 `kafka` pod 启动前会先启动一个名为 `auto-discovery` 的 initContainer ，负责获得集群信息等准备工作。准备工作完成后，会将信息写入 `/shared` 目录下，然后再启动 `kafka` 容器 Mount 同一目录，就可以获取准备好的信息。\n\n**这样运行容器进行 Pod 初始化就叫 initContainer 模式** 。每个 initContainer 会运行到成功退出为止，如果有一个 initContainer 启动失败，则整个 Pod 启动失败，触发 K8s 的 Pod 重启策略。\n\n\n# 部署更多 Pod\n\n### Replica Set\n\n可是上面说了这么多，还只是单个 Pod 的部署，但我们希望能做多副本部署。\n\n其实，只要把 Pod 的 manifest 改一下 `metadata.name` 再部署一次，就能得到一模一样的两个 Pod ，就是一个简单的多副本部署了。（必须改 `metadata.name` ，不然 K8s 会以为你是想修改同一个 Pod ）\n\n可是这样做会有很多问题：\n\n- 要复制一下还要改名字多麻烦啊，我想用同一份模板，只定义一下副本数就能得到对应数量的 Pod 。\n- 缩容扩容还要对着 Pod 操作很危险，我想直接修改副本数就能缩容扩容。\n- 如果其中一些 Pod 挂掉了不能重启，现在是什么都不会做。我希望能自动建一些新的 Pod 顶上，来保证副本数不变。\n\n为了实现这些需求，就出现了 Replica Set 这种资源。下面是实际应用中一个 Replica Set 的例子：\n\n```yaml\napiVersion: apps/v1\nkind: ReplicaSet\nmetadata:\n  labels:\n    app: gateway\n  name: gateway-9dc546658\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: gateway\n  template:\n    metadata:\n      labels:\n        app: gateway\n      name: gateway\n    spec:\n      containers:\n        name: gateway\n        image: xxxxxxxx.amazonaws.com/gateway:xxxxxxx\n        ports:\n        - containerPort: 50051\n          protocol: TCP\n        readinessProbe:\n          initialDelaySeconds: 5\n          tcpSocket:\n            port: 50051\n        startupProbe:\n          failureThreshold: 60\n          tcpSocket:\n            port: 50051\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - podAffinityTerm:\n              labelSelector:\n                matchLabels:\n                  app: gateway\n              topologyKey: topology.kubernetes.io/zone\n            weight: 80\n```\n\n我们可以看到， `spec.template` 中就是我们要的 Pod 的模板，在 metadata 里带上了 `app:gateway` 标签。而在 `spec.replicas` 中定义了我们需要的 Pod 数量， `spec.selector` 中描述了我们要对带 `app:gateway` 标签的 Pod 进行控制。把这份 manifest 部署后，我们就会得到除名字以外几乎一摸一样的两个 Pod ：\n\n```yaml\napiVersion: v1\nkind: Pod\nmetadata:\n  generateName: gateway-9dc546658-\n  labels:\n    app: gateway\n    pod-template-hash: 9dc546658\n  name: gateway-9dc546658-6c9qs\n  ownerReferences:\n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: ReplicaSet\n    name: gateway-9dc546658\n    uid: 6633f89c-377c-4c90-bd08-3be5bc7b21bd\n  resourceVersion: \"49793842\"\n  uid: f927db88-a39a-4623-852d-4f150a6d853b\nspec:\n  containers:\n    name: gateway\n    image: xxxxxxxx.amazonaws.com/gateway:xxxxxxx\n    ports:\n    # 后续省略\n\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  annotations:\n    kubernetes.io/psp: eks.privileged\n  creationTimestamp: \"2022-08-09T08:51:25Z\"\n  generateName: gateway-9dc546658-\n  labels:\n    app: gateway\n    pod-template-hash: 9dc546658\n  name: gateway-9dc546658-8trcs\n  ownerReferences:\n  - apiVersion: apps/v1\n    blockOwnerDeletion: true\n    controller: true\n    kind: ReplicaSet\n    name: gateway-9dc546658\n    uid: 6633f89c-377c-4c90-bd08-3be5bc7b21bd\n  resourceVersion: \"49793745\"\n  uid: 0918e3ed-2965-4237-8828-421a7831c9ed\nspec:\n  containers:\n    image: xxxxxxxx.amazonaws.com/gateway:xxxxxxx\n    name: gateway\n    ports:\n    # 后续省略\n```\n\n可以看到，创建出来的 Pod 自动生成了两个后缀（ `6c9qs` 与 `8trcs` ），带上了 Replica Set 的信息（在 `metadata.ownerReferences` ），其他部分基本一模一样。如果其中一个 Pod 挂掉了， K8s 会帮我们从模板中重新创建一个 Pod 。而且由于我们在 Pod 模板定义了 affinity ， K8s 还会按照我们的要求自动筛选合适的节点。例如在上面 Replica Set 的例子中，创建出来的 Pod 就会尽量部署在不同的节点上。\n\n\u003e **K8s 中对 Pod 的生存状态检查机制**\n\u003e \n\u003e 除了线程直接错误退出以外，还有出现死锁等等各种可能性使得容器中的应用不能正常工作。这些情况下虽然是不健康状态，但容器却不一定会挂掉。因此 K8s 提供了一些探针检查的机制来判断 Pod 是否健康。\n\u003e K8s 主要提供了三种探针：\n\u003e 1. **存活探针（ liveness probe ）** : Pod 运行时 K8s 会循环执行 liveness probe 检查容器是否健康。如果检查失败， K8s 会认为这个容器不健康，就会尝试重启容器。\n\u003e 2. **就绪探针（ readiness probe ）** : 程序可能会有一段时间不能提供服务（比如正在加载数据等）。这时可能既不想杀死应用，也不想给它发送请求，这时就需要 readiness probe 。如果 readiness probe 检查失败， K8s 就会将这个 Pod 从 Service 上摘下来，直到 readiness probe 成功重新加入 Service 。\n\u003e 3. **启动探针（ startup probe ）** : 有些程序会有非常长的启动时间，会有较长时间不能提供服务。这时如果 liveness probe 失败了导致重启毫无必要，此时就需要 startup probe 。 startup probe 只会在容器启动时检查直到第一次成功。直到 startup probe 成功为止， liveness probe 与 readiness probe 都不会开始执行检查。\n\u003e \n\u003e 而检测方式主要有：\n\u003e 1. httpGet: 对指定的端口路径执行 HTTP GET 请求，如果返回 2xx 或 3xx 就是成功。\n\u003e 2. tcpSocket: 尝试与容器的端口建立连接，如果不能成功建立连接就是失败。\n\u003e 3. exec: 在容器内执行一段命令，如果退出时状态码不为 0 就是失败。\n\u003e 4. grpc (New!): K8s 1.24 新出的检查方式，直接用 [GRPC Health Checking Protocol](https://github.com/grpc/grpc/blob/master/doc/health-checking.md) 对 GRPC Server 进行检查。\n\n此外， Replica Set 还提供了简易的缩容扩容功能。 kubectl 中提供了 scale 命令：\n\n```bash\nkubectl scale replicaset gateway --replicas=10\n```\n\n执行上述命令，就可以将名为 gateway 的 Replica Set 对应的副本数扩容到 10 份。当然，你也可以直接修改 Replica Set 的 `spec.replicas` 字段来实现缩容扩容。\n\n然而， Replica Set 的功能还是有限的。实际上， Replica Set 只关心跟它的 selector 匹配的 Pod 的数量。而至于匹配的 Pod 是否真的是跟 template 字段中描述的一样， Replica Set 就不关心了。因此如果单用 Replica Set ，更新 Pod 就会变得究极麻烦。\n\n### Deployment\n\n为了解决 Pod 的更新问题，我们需要有 Deployment 这种资源。实际上， Replica Set 的主要用途是提供给 Deployment 作为控制 Pod 数量，以及创建、删除 Pod 的一种机制。我们一般不会直接使用 Replica Set 。\n\n下面是实际应用中一个 Deployment 的例子：\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: gateway\n  name: gateway\nspec:\n  replicas: 2\n  revisionHistoryLimit: 10\n  selector:\n    matchLabels:\n      app: gateway\n  template:\n    metadata:\n      labels:\n        app: gateway\n      name: gateway\n    spec:\n      containers:\n        name: gateway\n        image: xxxxxxxx.amazonaws.com/gateway:xxxxxxx\n        ports:\n        # 下略\n```\n\n可以看到 Deployment 的 manifest 跟 Replica Set 很像。但实际上， Deployment 不会直接创建 Pod ，而是创建出一个 Replica Set ，再由 Replica Set 来创建 Pod ：\n\n\n```mermaid\nflowchart TB\n\nDeployment1[Deployment]\nReplicaSet11[Replica Set]\nPod11[Pod1]\nPod12[Pod2]\nDeployment1 --\u003e ReplicaSet11\nReplicaSet11 --\u003e Pod11\nReplicaSet11 --\u003e Pod12\n```\n\n比如在上面的例子中，名为 gateway 的 Deployment 创建后，就会有如下 ReplicaSet 和 Pod ：\n\n```sh\n# Replica Set:\n$ kubectl get rc -l app=gateway\nNAME                 DESIRED   CURRENT   READY   AGE\ngateway-9dc546658    2         2         2       5d3h\n\n# Pod:\n$ kubectl get po -l app=gateway\nNAME                      READY   STATUS    RESTARTS   AGE\ngateway-9dc546658-6c9qs   1/1     Running   0          5d3h\ngateway-9dc546658-8trcs   1/1     Running   0          5d3h\n```\n\n可以看到，gateway Deployment 创建了一个 Replica Set ，然后随机给了它一个 `9dc546658` 后缀。然后 gateway-9dc546658 这个 Replica Set 又根据 template 中创建了两个 Pod ，再在自己名字的基础上加上两个后缀 `6c9qs` 与 `8trcs` 。\n\n接下来就是 Deployment 的重点了： Replica Set 只会根据 template 创建出 Pod ，而不管匹配的 Pod 到底是不是跟 template 中描述的一样。而 **Deployment 则会专门关注 template 的内容变更。**\n\n假如我们现在更新了 Deployment 的 template 中的内容提交给 K8s ， Deployment 就会感知到 template 被修改了， Pod 需要更新。\n感知到更新之后， Deployment 就会创建一个新的 Replica Set 。然后逐渐将旧的 Replica Set 缩容到 0 ，并同时将新的 Replica Set 扩容到目标值。最后，所有旧版本的 Pod 将会被更新成新版本的 Pod 。如下图所示：\n\n```mermaid\nflowchart TB\n\nsubgraph A\ndirection TB\nDeployment1[Deployment]\nReplicaSet11[Replica Set]\nReplicaSet12[New Replica Set]\nPod11[Pod1]\nPod12[Pod2]\nDeployment1 --\u003e ReplicaSet11\nDeployment1 --\u003e ReplicaSet12\nReplicaSet11 --\u003e Pod11\nReplicaSet11 --\u003e Pod12\nend\n\nsubgraph B\ndirection TB\nDeployment2[Deployment]\nReplicaSet21[Replica Set]\nReplicaSet22[New Replica Set]\nPod21[New Pod1]\nPod22[Pod2]\nDeployment2 --\u003e ReplicaSet21\nDeployment2 --\u003e ReplicaSet22\nReplicaSet21 --\u003e Pod22\nReplicaSet22 --\u003e Pod21\nend\n\nsubgraph C\ndirection TB\nDeployment3[Deployment]\nReplicaSet31[Replica Set]\nReplicaSet32[New Replica Set]\nPod31[New Pod1]\nPod32[New Pod2]\nDeployment3 --\u003e ReplicaSet31\nDeployment3 --\u003e ReplicaSet32\nReplicaSet32 --\u003e Pod31\nReplicaSet32 --\u003e Pod32\nend\n\nA --\u003e B --\u003e C\n```\n\n整个过程完成后， Deployment 还不会将旧的 Replica Set 删除掉。我们注意到 Deployment 的声明中有这么一个字段： `revisionHistoryLimit: 10` ，表示 Deployment 会保留历史中 最近的 10 个 Replica Set ，这样在必要的时候可以立刻将 Deployment 回滚到上个版本。而超出 10 个的 Replica Set 才会被从 K8s 中删除。\n\n```sh\n# 实际中被 scale 到 0 但还没被删除的 Replica Set\n$ kubectl get rs -l app=gateway\nNAME                 DESIRED   CURRENT   READY   AGE\ngateway-5c4cdf957d   0         0         0       5d4h\ngateway-5c56f6d487   0         0         0       17d\ngateway-65857cfc78   0         0         0       10d\ngateway-6bddbdd85f   0         0         0       16d\ngateway-6cc9bb5b4c   0         0         0       13d\ngateway-6f4664bc65   0         0         0       17d\ngateway-7bd667cb79   0         0         0       9d\ngateway-7d658d57f5   0         0         0       13d\ngateway-84df97d4c8   0         0         0       6d4h\ngateway-9998f4689    0         0         0       13d\ngateway-9dc546658    2         2         2       5d4h\n```\n\n### Stateful Set\n\nDeployment 中默认了我们不关心自己访问的是哪个 Pod ，因为各个 Pod 的功能是一样的，访问哪个没有差别。\n\n实际上这也符合大多数情况：试想一个 HTTP Server ，如果其所有数据都存放到同一个的数据库中，那这个 HTTP Server 不管部署在哪台主机、不管有多少个实例、不管你访问的是哪个实例，都察觉不出有什么差别。而有了这种默认，我们就能更放心地对 Pod 进行负载均衡、缩扩容等操作。\n\n但实际上我们总会遇到需要保存自己状态的 Pod 。比如我们在 K8s 里部署一个 Kafka 集群，每个 Kafka broker 都需要保存自己的分区数据，而且还要往 Zookeeper 里写入自己的名字来实现选举等功能。如果简单地用 Deployment 来部署， broker 之间可能就会分不清到底哪块是自己的分区，而且由 Deployment 生成出来的 Pod 名字是随机的，升级后 Pod 的名字会变，导致 Kafka 升级后名字与 Zookeeper 里的名字不一致，被以为是一个新的 broker 。\n\nStateful Set 就是为了解决有状态应用的部署而出现的。下面是 用 bitnami 的 Kafka Helm Chart 部署的一个 Kafka Stateful Set 的例子：\n\n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app.kubernetes.io/name: kafka\n  name: kafka\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kafka\n  serviceName: kafka-headless\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/name: kafka\n    spec:\n      containers:\n      - name: kafka\n        image: docker.io/bitnami/kafka:3.1.0-debian-10-r52\n        command:\n        - /scripts/setup.sh\n        ports:\n        - containerPort: 9092\n          name: kafka-client\n          protocol: TCP\n        volumeMounts:\n        - mountPath: /bitnami/kafka\n          name: data\n  volumeClaimTemplates:\n  - apiVersion: v1\n    kind: PersistentVolumeClaim\n    metadata:\n      name: data\n    spec:\n      resources:\n        requests:\n          storage: 10Gi\n      storageClassName: gp2\n```\n\n可以看到其实 Stateful Set 类似 Deployment ，也可以通过 replicas 字段定义实例数，如果更新 template 部分， Stateful Set 也会以一定的策略对 Pod 进行更新。\n\n而其创建出来的 Pod 如下所示：\n```sh\n$ kubectl get po -l app.kubernetes.io/name=kafka\nNAME      READY   STATUS    RESTARTS   AGE\nkafka-0   1/1     Running   1          26d\nkafka-1   1/1     Running   3          26d\nkafka-2   1/1     Running   3          26d\n```\n\n与 Replica Set 创建出来的 Pod 相比名字上会有很大差别。 Stateful Set 创建出来的 Pod 会固定的以 `-0` 、 `-1` 、 `-2` 结尾而不是随机生成：\n\n```mermaid\nflowchart TB\nrs[Replica Set A]\nrs --\u003e A-qwert\nrs --\u003e A-asdfg\nrs --\u003e A-zxcvb\n\nss[Stateful Set A]\nss --\u003e A-0\nss --\u003e A-1\nss --\u003e A-2\n```\n\n这样一来，更新时将 Pod 更换之后，新的 Pod 仍能够跟旧的 Pod 保持相同的名字。此外，与 Deployment 相比， Stateful Set 更新后同名的 Pod 仍能保持原来的 IP ，拿到同一个持久化卷，而且不同的 Pod 还能通过独立的 DNS 记录相互区分。这些内容后面还会详细介绍。\n\n\u003e **宠物与牛（ Cattle vs Pets ）的比喻**\n\u003e \n\u003e Deployment 更倾向于将 Pod 看作是牛：我们不会去关心每一个 Pod 个体，如果有一个 Pod 出现了问题，我们只需要把他杀掉并替换成新的 Pod 就好。\n\u003e \n\u003e 但 Stateful Set 更倾向于将 Pod 看作是宠物：弄来一直完全一模一样的宠物并不是容易的事，我们对待这些宠物必须小心翼翼。我们要给他们各自一个专属的名字，替换掉一只宠物时，必须要保证它的花色、名字、行为举止都与之前那只宠物一模一样。\n\n### Daemon Set\n\n不管是 Deployment 还是 Stateful Set ，一般都不会在意自己的 Pod 部署到哪个节点。而假如你不在意自己 Pod 的数量，但需要保证每个节点上都运行一个 Pod 时，就需要 Daemon Set 了。\n\n需要保证每个节点上有且只有一个 Pod 在运行这种情况，经常会在基础结构相关的操作中出现。比如我需要在集群中部署 fluentd 采集 log ，一般来说需要在 Pod 里直接挂载节点磁盘上的文件路径。这种时候如果有一个节点上没有运行 Pod ，那个节点的 log 就采集不到；另一方面，一个节点上运行多个 Pod 毫无意义，而且可能还会导致 log 重复等冲突。\n\n这种需求下简单地使用 Replica Set 或是 Stateful Set 都是不能达到要求的，这两种资源都只能通过亲和性达到“尽量不部署在同一个节点”，做不到绝对。而且当节点数有变更时还需要手动更改设置。\n\n下面是一个用 fluent-bit helm chart 部署的 fluent-bit Daemon Set 的例子：\n\n```yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app.kubernetes.io/instance: fluent-bit\n    app.kubernetes.io/name: fluent-bit\n  name: fluent-bit\n  namespace: fluent-bit\nspec:\n  selector:\n    matchLabels:\n      app.kubernetes.io/instance: fluent-bit\n      app.kubernetes.io/name: fluent-bit\n  template:\n    metadata:\n      labels:\n        app.kubernetes.io/instance: fluent-bit\n        app.kubernetes.io/name: fluent-bit\n    spec:\n      containers:\n      - image: cr.fluentbit.io/fluent/fluent-bit:1.9.5\n        volumeMounts:\n        - name: varlibdockercontainers\n          mountPath: /var/lib/docker/containers\n          readOnly: true\n        - name: etcmachineid\n          mountPath: /etc/machine-id\n          readOnly: true\n      volumes:\n      - name: varlibdockercontainers\n        hostPath:\n          path: /var/lib/docker/containers\n          type: \"\"\n      - name: etcmachineid\n        hostPath:\n          path: /etc/machine-id\n          type: File\n```\n\nSelector 之类的都是一样的了，而 Daemon Set 不能指定 replicas 。另外可以看到一个比较刺激的地方： Volume 里使用了 `hostPath` 这种 Volume ，在 Pod 里直接指定了宿主机磁盘上的路径。\n\nK8s 认为经过抽象后， Pod 不应该去关心自己在哪台宿主机上，一般来说是不推荐在 Pod 里直接访问宿主机路径的（不过也没有强制禁止）。不过 Daemon Set 是个特例，由于 Daemon Set 生成的 Pod 与节点强相关， K8s 十分推荐在且仅在 Daemon Set 的 Pod 中访问宿主机路径。\n\n### Job 与 CronJob\n\nReplica Set ， Stateful Set ， Daemon Set 的 Pod 中运行的一般是持续运行的程序，因此这些 Pod 运行终止后会有相应的机制重启这些 Pod 。而 Job 与 Cron Job 这两种资源则专门负责调度不会持续运行的程序。\n\n下面是 《Kubernetes in Action》 书中的一个例子：\n\n```yaml\napiVersion: batch/v1\nkind: Job\nmetadata:\n  name: pi\nspec:\n  completions: 5\n  parallelism: 2\n  template:\n    spec:\n      containers:\n      - name: pi\n        image: perl:5.34.0\n        command: [\"perl\",  \"-Mbignum=bpi\", \"-wle\", \"print bpi(2000)\"]\n      restartPolicy: Never\n```\n\n可以看到，这个 Job 描述了一个会输出 PI 小数点后 2000 位的 Pod 模板。这个 Job 部署后，一共会以这个模板跑完 5 个 Pod ，其中最多并行跑 2 个，并在其中一个成功终止后再跑剩下的 Pod 。可以通过调整 `completions` 与 `parallelism` 字段调整并行与穿行数量。\n\n顺带一提，在 Job 定义中一般不会出现 selector ，但其实 Job 有 selector 字段，一般会由 K8s 为每个 Job 生成一个 uuid 作为 selector 。\n\n另外，可以通过部署 CronJob 这种资源来定时执行 Job 。下面是 《Kubernetes in Action》 书中关于 CronJob 的例子：\n\n```yaml\napiVersion: batch/v1beta1\nkind: CronJob\nmetadata:\n  name: pi\nspec:\n  schedule: \"0 0 * * *\"\n  jobTemplate:\n    spec:\n      template:\n        spec:\n          containers:\n          - name: pi\n            image: perl:5.34.0\n            command: [\"perl\",  \"-Mbignum=bpi\", \"-wle\", \"print bpi(2000)\"]\n          restartPolicy: Never\n```\n\n这个例子中， CronJob 会在每天的 0 点创建一个只运行一个 Pod 的 Job 。 CronJob 不会直接创建 Pod ，而是创建一个 Job ，再由 Job 创建 Pod （就像 Deployment 与 Replica Set 的关系）。另外， CronJob 创建的 Job 会限制 `completions` 与 `parallelism` 都只能等于 1 。\n\n\u003e 关于资源的名称空间\n\u003e \n\u003e 在 K8s 中，各资源都是不能重名的。不能部署两个都叫 `gateway` 的 Pod ，资源之间有可能因为名字冲突而导致部署不成功。（部署一个叫 `gateway` 的 Pod 和一个叫 `gateway` 的 Deployment 倒是可以，因为 `gateway` 不是他们两个的全名，他们的全名分别叫 `pod/gateway` 及 `deployment/gateway` 。）\n\u003e 另外我们已经知道 Deployment 等资源一般会通过标签等来管理自己创建的资源，那两份不相关的应用完全有可能会撞标签，这时候部署逻辑就有可能会出问题。\n\u003e \n\u003e K8s 中提供了名称空间这种资源，用于进行资源隔离。K8s 中大部分资源都从属于一个且仅从属于一个名称空间， Deployment 等资源一般只能控制在同一名称空间下的资源，而不会影响其他名称空间。\n\u003e \n\u003e 另外，也有一些资源是名称空间无关的，比如节点 `Node` 。\n\n\n","title":"Kubernetes 入门 （1）","abstract":"我们知道 K8s 利用了容器虚拟化技术。而说到容器虚拟化就要说 Docker 。可是，容器到底是什么？ Docker 又为我们做了些什么？我们又为什么要用 K8s ？\n\u003e 要把一个不知道打过多少个升级补丁，不知道经历了多少任管理员的系统迁移到其他机器上，毫无疑问会是一场灾难。 —— Chad Fowler 《Trash Your Servers and Burn Your Code》\n\"Write once, run anywhere\" 是 Java 曾经的口号。 Java 企图通过 JVM 虚拟机来实现一个可执行程序在多平台间的移植性。但我们现在知道， Java 语言并没能实现他的目标，会在操作系统调用、第三方依赖丢失、两个程序间依赖的冲突等各方面出现问题。","length":644,"created_at":"2022-08-13T17:45:31.000Z","updated_at":"2022-08-20T14:02:18.000Z","tags":["Kubernetes","DevOps","Docker","Cloud Native"],"license":true,"headingTrees":[{"key":"容器-docker-与-k8s","href":"#容器-docker-与-k8s","heading":1,"title":"容器， Docker 与 K8s","children":[{"key":"关于容器虚拟化","href":"#关于容器虚拟化","heading":3,"title":"关于容器虚拟化","children":[],"id":"关于容器虚拟化"},{"key":"关于-docker","href":"#关于-docker","heading":3,"title":"关于 Docker","children":[],"id":"关于-docker"},{"key":"为什么要用-k8s-","href":"#为什么要用-k8s-","heading":3,"title":"为什么要用 K8s ？","children":[],"id":"为什么要用-k8s-"},{"key":"k8s-与-docker-的关系","href":"#k8s-与-docker-的关系","heading":3,"title":"K8s 与 Docker 的关系","children":[],"id":"k8s-与-docker-的关系"}],"id":"容器-docker-与-k8s"},{"key":"部署一个-pod","href":"#部署一个-pod","heading":1,"title":"部署一个 Pod","children":[{"key":"pod-示例","href":"#pod-示例","heading":3,"title":"Pod 示例","children":[],"id":"pod-示例"}],"id":"部署一个-pod"},{"key":"部署更多-pod","href":"#部署更多-pod","heading":1,"title":"部署更多 Pod","children":[{"key":"replica-set","href":"#replica-set","heading":3,"title":"Replica Set","children":[],"id":"replica-set"},{"key":"deployment","href":"#deployment","heading":3,"title":"Deployment","children":[],"id":"deployment"},{"key":"stateful-set","href":"#stateful-set","heading":3,"title":"Stateful Set","children":[],"id":"stateful-set"},{"key":"daemon-set","href":"#daemon-set","heading":3,"title":"Daemon Set","children":[],"id":"daemon-set"},{"key":"job-与-cronjob","href":"#job-与-cronjob","heading":3,"title":"Job 与 CronJob","children":[],"id":"job-与-cronjob"}],"id":"部署更多-pod"}],"wikiRefAliases":[],"richRefAliases":[]},"prevNextInfo":{"prevInfo":{"pathMapping":{"pagePath":"/articles/introduction-for-k8s-2","filePath":"public/content/articles/2022-08-20-introduction-for-k8s-2.md"},"meta":{"title":"Kubernetes 入门 （2）","created_at":"2022-08-20T21:56:52.000Z","updated_at":"2022-08-20T14:02:18.000Z"}},"nextInfo":{"pathMapping":{"pagePath":"/articles/why-homogeneous","filePath":"public/content/articles/2022-07-31-why-homogeneous.md"},"meta":{"title":"为什么使用在齐次坐标下矩阵乘法能表示点平移？","created_at":"2022-07-31T15:35:17.000Z","updated_at":"2022-08-05T17:45:09.000Z"}}},"backRefResources":[{"pathMapping":{"filePath":"public/content/ideas/blog-syntax.md","pagePath":"/ideas/blog-syntax","slug":"blog-syntax"},"meta":{"content":"\n# 一级标题\n\n## 二级标题\n\n### 三级标题\n\n#### 四级标题\n\n##### 五级标题\n\n###### 六级标题\n\n**加粗**\n\n*斜体*\n\n_斜体2_\n\n***加粗斜体***\n\n**_加粗斜体2_**\n\n~~删除线~~\n\n==高亮==\n\n\u003e 引用\n\n# 其他 MD 语法\n\n## 代码块\n\n`行内代码`\n\n代码块高亮：\n\n```python\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n大围栏\n\n````markdown\n```\ndef func_echo(s: str):\n    print(s)\n```\n````\n\n行内反引号围栏： `` ` `` 或者 ``` `` ``` 的模式\n\n```markdown\n`段落反引号内的行内反引号`\n```\n\n#### Rehype Pretty 语法：\n\n名称显示，captions 显示：\n\n```python title=\"main.py\" caption=\"这是一段描述\"\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n高亮\n\n```python {1-3,5}#a {4}#b {7} /printer/#c \"Callable\"#a /func_echo/#1\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n\nclass HelloPrinter:\n    printer: Callable[[str]]\n\n    def __init__(self, printer: Callable[[str]]):\n        self.printer = printer\n\n    def call(self, s: str):\n        self.printer(s)\n\n\np = HelloPrinter(func_echo)\np.call(\"hello world!\")\n```\n\n行号\n\n```python showLineNumbers{998}\n# 代码块\ndef func_echo(s: str):\n    print(s)\n\n```\n\n## 列表\n\n- 无序列表\n  - 无序列表\n    - 无序列表\n    - 无序列表\n\n1. 有序列表\n2. 有序列表\n3. 有序列表\n   1. 有序列表\n   2. 有序列表\n      1. 有序列表\n      2. 有序列表\n\n- [ ] 未完成\n- [x] 已完成\n  - [x] 已完成\n    - [ ] 未完成\n\n- 交叉嵌套\n  - [ ] 未完成\n  - [x] 已完成\n    1. 有序列表\n    2. 有序列表\n\n- [ ] 交叉嵌套 2\n  1. 有序列表\n  2. 有序列表\n     - 无序列表\n     - 无序列表\n\n1. 交叉嵌套\n2. 交叉嵌套\n   - 无序列表\n   - 无序列表\n     - [ ] 未完成\n     - [x] 已完成\n\n## Quote Block\n\n\u003e 这是一个 Quote Block\n\u003e\n\u003e 里面可以有多行数据\n\n## 链接\n\n[链接](https://blog.ryo-okami.xyz)\n\n[站内链接](/ideas/using-chart-js)\n\n## 图片\n\n图片：\n\n![图片](https://blog.ryo-okami.xyz/content/articles/2022-07-31-why-homogeneous/OnOneLineWillStillOneLine_ManimCE_v0.16.0.post0.gif)\n\n站内图片：\n\n![站内图片](/content/articles/2022-07-31-why-homogeneous/OnOneLineWillStillOneLine_ManimCE_v0.16.0.post0.gif)\n\n## 表格\n\n| 表头     | 表头     | 表头     |\n| -------- | -------- | -------- |\n| ~~删除~~ | ==高亮== | **加粗** |\n| 单元     | 单元     | _斜体_   |\n\n## 脚注\n\n下标[^1]\n\n[^1]: 注释\n\n# 插件\n\n## Katex\n\n行间公式\n\n$$\n\\begin{aligned}\n\\dot{x} \u0026 = \\sigma(y-x) \\\\\n\\dot{y} \u0026 = \\rho x - y - xz \\\\\n\\dot{z} \u0026 = -\\beta z + xy\n\\end{aligned}\n$$\n\n行内公式 $E=mc^2$\n\n## Mermaid\n\nmermaid 流程图\n\n```mermaid\ngraph LR\n  A[方形] --\u003e B(圆角)\n  B --\u003e C{条件}\n  C --\u003e|a=1| D[结果1]\n  C --\u003e|a=2| E[结果2]\n  C --\u003e|a=3| F[结果3]\n```\n\n另一个 mermaid 流程图，同样类型不会冲突\n\n```mermaid\ngraph TD\n  A((圆)) --\u003e B([圆边])\n  B --\u003e C[(DB)]\n```\n\nmermaid 时序图\n\n```mermaid\nsequenceDiagram\n  participant Alice\n  participant Bob\n  Alice-\u003e\u003eJohn: Hello John, how are you?\n  loop Healthcheck\n    John-\u003e\u003eJohn: Fight against hypochondria\n  end\n  Note right of John: Rational thoughts \u003cbr/\u003eprevail...\n  John--\u003e\u003eAlice: Great!\n  John-\u003e\u003eBob: How about you?\n  Bob--\u003e\u003eJohn: Jolly good!\n```\n\n## Jessie Code 几何图形\n\n简单 Jessie Code\n\n```jessiecode\nA = point(1, 0);\nB = point(-1, 0);\nC = point(0.2, 1.5);\nL_AB = line(A, B);\nL_AC = line(A, C);\nK_ABC = circle(A, B, C);\n```\n\n可以有多个 Jessie Code 代码块\n\n```jessiecode\n$board.setView([-1.5, 2, 1.5, -1]);\n\n// Triangle ABC\nA = point(1, 0);\nB = point(-1, 0);\nC = point(0.2, 1.5);\npol = polygon(A,B,C) \u003c\u003c\n        fillColor: '#FFFF00',\n        borders: \u003c\u003c\n            strokeWidth: 1,\n            strokeColor: '#C0C000'\n        \u003e\u003e\n    \u003e\u003e;\n \n// Perpendiculars and orthocenter i1\npABC = perpendicular(pol.borders[0], C) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\npBCA = perpendicular(pol.borders[1], A) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\npCAB = perpendicular(pol.borders[2], B) \u003c\u003c dash: 2, strokeWidth: 1, strokeColor: '#560092' \u003e\u003e;\ni1 = intersection(pABC, pCAB, 0);\n\n// Midpoints of segments\nmAB = midpoint(A, B);\nmBC = midpoint(B, C);\nmCA = midpoint(C, A);\n \n// Line bisectors and centroid i2\nma = segment(mBC, A) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\nmb = segment(mCA, B) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\nmc = segment(mAB, C) \u003c\u003c strokeWidth: 1, strokeColor: '#009256' \u003e\u003e;\ni2 = intersection(ma, mc, 0);\n \n// Circum circle and circum center\nc = circumcircle(A, B, C) \u003c\u003c\n        strokeColor: '#000000',\n        dash: 3,\n        strokeWidth: 1,\n        center: \u003c\u003c\n            name: 'i_3',\n            withlabel:true,\n            visible: true\n        \u003e\u003e\n    \u003e\u003e;\n \n// Euler line \neuler = line(i1, i2) \u003c\u003c\n        strokeWidth: 2,\n        strokeColor:'#C01B37'\n    \u003e\u003e;\n```\n\nFunction Graph 也可在 Jessie Code 中使用\n\n```jessiecode\nFFunc = function(x) {\n    return sin(x);\n};\nF = functiongraph(FFunc, -10, 10);\n\nP1 = point(0, 0);\nP2 = point(1, 2);\n\na = function () {\n    return P2.X() - P1.X();\n};\n\nb = function () {\n    return P2.Y() - P1.Y();\n};\n\nGFunc = function(x) {\n    return b() * sin(PI * ( x - P1.X() ) / 2 / a() ) + P1.Y();\n};\nG = functiongraph(GFunc, -10, 10);\n\n\nInterFunc = function(i, x) {\n  return FFunc(x) * i / 10 + GFunc(x) * (1 - i / 10);\n};\n\nH1 = functiongraph(function(x) {\n  return InterFunc(1, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH2 = functiongraph(function(x) {\n  return InterFunc(2, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH3 = functiongraph(function(x) {\n  return InterFunc(3, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH4 = functiongraph(function(x) {\n  return InterFunc(4, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH5 = functiongraph(function(x) {\n  return InterFunc(5, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH6 = functiongraph(function(x) {\n  return InterFunc(6, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH7 = functiongraph(function(x) {\n  return InterFunc(7, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH8 = functiongraph(function(x) {\n  return InterFunc(8, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n\nH9 = functiongraph(function(x) {\n  return InterFunc(9, x);\n}, -10, 10) \u003c\u003c strokeOpacity: 0.5 \u003e\u003e;\n```\n\n可以以 frontmatter 形式指定 board 参数\n\n```jessiecode\n---\nboundingbox: [-1, 2, 2, -1]\ngrid: true\naxis: false\n---\nA = point(0, 0);\nB = point(1, 0);\nC = point(0, 1);\nL_AB = line(A, B);\nL_AC = line(A, C);\nK_ABC = circle(A, B, C);\n```\n\n## Heading 引用\n\n点击能够跳转：\n\n[文章内标题引用](#一级标题)\n\n[跨文章标题引用](/ideas/using-chart-js#react-chartjs-2)\n\n# Obsidian\n\n## Wikilink\n\n### 站内短引用\n\n[[2022-08-13-introduction-for-k8s]]\n\n可以去掉路径中的日期 [[introduction-for-k8s]] 作为 page path 引用\n\n带 label [[2022-08-13-introduction-for-k8s|其他文章]]\n\n带 fragment [[2022-08-13-introduction-for-k8s#部署一个-pod|其他文章]]\n\n带路径 [[articles/2022-08-13-introduction-for-k8s|其他文章]]\n\nPage path 全路径 [[/articles/introduction-for-k8s|其他文章]]\n\nfile path 全路径 [[public/content/articles/2022-08-13-introduction-for-k8s|其他文章]]\n\n一行多个 [[2022-08-13-introduction-for-k8s|其他文章]] [[2022-08-20-introduction-for-k8s-2|其他文章2]]\n\n\u003e 目前未实现 Obsidian Anchor 直接引用到块或标题\n\n## Rich Content 短引用\n\n### 图片短引用\n\n短引用图片，纯文件名\n\n![[test-img-show-image.png]]\n\n短引用图片，带注释\n\n![[test-img-show-image.png|这是一张图片]]\n\n短引用图片，带路径\n\n![[blog-syntax/test-img-show-image.png]]\n\n短引用图片，带路径和注释\n\n![[blog-syntax/test-img-show-image.png|这是一张图片]]\n\n短引用图片，全路径\n\n![[/content/ideas/blog-syntax/test-img-show-image.png]]\n\n### Excalidraw 短引用\n\n短引用 Excalidraw\n\n![[Drawing 2024-04-13 17.33.27.excalidraw]]\n\n## Callouts\n\n\u003e [!note]\n\u003e\n\u003e Note 级\n\n\u003e [!info]\n\u003e\n\u003e Callout 里是正常的 markdown 语法\n\u003e ```markdown\n\u003e \u003e [!info]\n\u003e \u003e\n\u003e \u003e Callout 里是正常的 markdown 语法\n\u003e ```\n\n\u003e [!tip] 标题\n\u003e\n\u003e Tip 级带标题\n\n\u003e [!faq]- 可折叠 Callout\n\u003e\n\u003e 是的，这是 faq 级 callout 。可折叠 Callout 在折叠时隐藏内容。\n\n\u003e [!faq]+ 默认打开的可折叠 Callout\n\u003e\n\u003e 可折叠 Callout 也可以设置为默认打开。\n\n\u003e [!question] 可以嵌套吗？\n\u003e\n\u003e \u003e [!todo] 是的，可以。\n\u003e \u003e \u003e [!example] 你可以使用多层嵌套。\n\u003e \u003e \u003e 在最里面也可以使用 markdown 语法\n\u003e\n\u003e \u003e [!tip]- 还可以嵌套其他 Obsidian 语法\n\u003e \u003e 比如==高亮==，也可以嵌套 wikilink [[introduction-for-k8s]]\n\u003e \u003e\n\u003e \u003e 或者嵌套 Embeded 图片\n\u003e \u003e\n\u003e \u003e ![[test-img-show-image.png]]\n\u003e \u003e\n\u003e \u003e 也可以嵌套 mermaid 图表\n\u003e \u003e\n\u003e \u003e ```mermaid\n\u003e \u003e graph TD\n\u003e \u003e A[Start] --\u003e B[Process]\n\u003e \u003e B --\u003e C[End]\n\u003e \u003e ```\n\u003e \u003e\n\u003e \u003e 也可以嵌套 Excalidraw\n\u003e \u003e\n\u003e \u003e ![[Drawing 2024-04-13 17.33.27.excalidraw]]\n\u003e \u003e\n\u003e \u003e 也可以是 Tag #Tag1 #Tag2\n\u003e \u003e\n\u003e \u003e #单行Tag\n\u003e\n\n\u003e [!abstract]-\n\u003e Abstract 级\n\n\u003e [!summary]-\n\u003e Summary 级, 是 abstract 的 alias\n\n\u003e [!tldr]-\n\u003e TL;DR 级, 是 summary 的 alias\n\n\u003e [!info]-\n\u003e Info 级\n\n\u003e [!todo]-\n\u003e Todo 级\n\n\u003e [!tip]-\n\u003e Tip 级\n\n\u003e [!hint]-\n\u003e Hint 级, 是 tip 的 alias\n\n\u003e [!important]-\n\u003e Important 级, 是 tip 的 alias\n\n\u003e [!success]-\n\u003e Success 级\n\n\u003e [!check]-\n\u003e Check 级, 是 success 的 alias\n\n\u003e [!done]-\n\u003e Done 级, 是 success 的 alias\n\n\u003e [!question]-\n\u003e Question 级\n\n\u003e [!help]-\n\u003e Help 级, 是 question 的 alias\n\n\u003e [!faq]-\n\u003e Faq 级, 是 question 的 alias\n\n\u003e [!warning]-\n\u003e Warning 级\n\n\u003e [!caution]-\n\u003e Caution 级, 是 warning 的 alias\n\n\u003e [!attention]-\n\u003e Attention 级, 是 caution 的 alias\n\n\u003e [!failure]-\n\u003e Failure 级\n\n\u003e [!fail]-\n\u003e Fail 级, 是 failure 的 alias\n\n\u003e [!missing]-\n\u003e Missing 级, 是 failure 的 alias\n\n\u003e [!danger]-\n\u003e Danger 级\n\n\u003e [!error]-\n\u003e Error 级, 是 danger 的 alias\n\n\u003e [!bug]-\n\u003e Bug 级\n\n\u003e [!example]-\n\u003e Example 级\n\n\u003e [!quote]-\n\u003e Quote 级\n\n\u003e [!cite]-\n\u003e Cite 级, 是 quote 的 alias\n\n自定义 callout 类型\n\n\u003e [!reasoning]\n\u003e LLM Reasoning\n\n\u003e [!query]\n\u003e User Query\n\n\u003e [!ai]\n\u003e AI Generated Content\n\n\u003e [!think]\n\u003e Further thinking by writer\n\n\u003e [!idea]\n\u003e Idea 级, 是 think 的 alias\n\n## 标签\n\n文字里可以有 #Tag ， 会被渲染成标签。\n\n#Tag\n\n一行可以有多个 #Tag/Tag2 #Tag3 如果存在于 Tag 索引，则可点击 #Linux\n\n\u003e [!info] Tag 可以与其他组件结合\n\u003e 就像 #Tag 这样\n","title":"博客语法渲染测试","abstract":"**加粗**\n*斜体*\n_斜体2_","length":627,"created_at":"2024-04-14T11:41:29.000Z","updated_at":"2025-04-30T03:48:16.000Z","tags":["Tag1","Tag2","单行Tag","Tag","Tag/Tag2","Tag3","Linux","Blog","Nextjs"],"license":false,"headingTrees":[{"key":"一级标题","href":"#一级标题","heading":1,"title":"一级标题","children":[{"key":"二级标题","href":"#二级标题","heading":2,"title":"二级标题","children":[{"key":"三级标题","href":"#三级标题","heading":3,"title":"三级标题","children":[{"key":"四级标题","href":"#四级标题","heading":4,"title":"四级标题","children":[{"key":"五级标题","href":"#五级标题","heading":5,"title":"五级标题","children":[{"key":"六级标题","href":"#六级标题","heading":6,"title":"六级标题","children":[],"id":"六级标题"}],"id":"五级标题"}],"id":"四级标题"}],"id":"三级标题"}],"id":"二级标题"}],"id":"一级标题"},{"key":"其他-md-语法","href":"#其他-md-语法","heading":1,"title":"其他 MD 语法","children":[{"key":"代码块","href":"#代码块","heading":2,"title":"代码块","children":[{"key":"rehype-pretty-语法","href":"#rehype-pretty-语法","heading":4,"title":"Rehype Pretty 语法：","children":[],"id":"rehype-pretty-语法"}],"id":"代码块"},{"key":"列表","href":"#列表","heading":2,"title":"列表","children":[],"id":"列表"},{"key":"quote-block","href":"#quote-block","heading":2,"title":"Quote Block","children":[],"id":"quote-block"},{"key":"链接","href":"#链接","heading":2,"title":"链接","children":[],"id":"链接"},{"key":"图片","href":"#图片","heading":2,"title":"图片","children":[],"id":"图片"},{"key":"表格","href":"#表格","heading":2,"title":"表格","children":[],"id":"表格"},{"key":"脚注","href":"#脚注","heading":2,"title":"脚注","children":[],"id":"脚注"}],"id":"其他-md-语法"},{"key":"插件","href":"#插件","heading":1,"title":"插件","children":[{"key":"katex","href":"#katex","heading":2,"title":"Katex","children":[],"id":"katex"},{"key":"mermaid","href":"#mermaid","heading":2,"title":"Mermaid","children":[],"id":"mermaid"},{"key":"jessie-code-几何图形","href":"#jessie-code-几何图形","heading":2,"title":"Jessie Code 几何图形","children":[],"id":"jessie-code-几何图形"},{"key":"heading-引用","href":"#heading-引用","heading":2,"title":"Heading 引用","children":[],"id":"heading-引用"}],"id":"插件"},{"key":"obsidian","href":"#obsidian","heading":1,"title":"Obsidian","children":[{"key":"wikilink","href":"#wikilink","heading":2,"title":"Wikilink","children":[{"key":"站内短引用","href":"#站内短引用","heading":3,"title":"站内短引用","children":[],"id":"站内短引用"}],"id":"wikilink"},{"key":"rich-content-短引用","href":"#rich-content-短引用","heading":2,"title":"Rich Content 短引用","children":[{"key":"图片短引用","href":"#图片短引用","heading":3,"title":"图片短引用","children":[],"id":"图片短引用"},{"key":"excalidraw-短引用","href":"#excalidraw-短引用","heading":3,"title":"Excalidraw 短引用","children":[],"id":"excalidraw-短引用"}],"id":"rich-content-短引用"},{"key":"callouts","href":"#callouts","heading":2,"title":"Callouts","children":[],"id":"callouts"},{"key":"标签","href":"#标签","heading":2,"title":"标签","children":[],"id":"标签"},{"key":"footnote-label","href":"#footnote-label","heading":2,"title":"Footnotes","children":[],"id":"footnote-label"}],"id":"obsidian"}],"wikiRefAliases":["2022-08-13-introduction-for-k8s","introduction-for-k8s","2022-08-13-introduction-for-k8s","2022-08-13-introduction-for-k8s#部署一个-pod","articles/2022-08-13-introduction-for-k8s","/articles/introduction-for-k8s","public/content/articles/2022-08-13-introduction-for-k8s","2022-08-13-introduction-for-k8s","2022-08-20-introduction-for-k8s-2","introduction-for-k8s"],"richRefAliases":["test-img-show-image.png","test-img-show-image.png","blog-syntax/test-img-show-image.png","blog-syntax/test-img-show-image.png","/content/ideas/blog-syntax/test-img-show-image.png","Drawing 2024-04-13 17.33.27.excalidraw","test-img-show-image.png","Drawing 2024-04-13 17.33.27.excalidraw"]}}],"hyperProps":{"withSEO":true,"withComments":true}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"introduction-for-k8s"},"buildId":"vYRJvhoXUtHmZ0dOUV_ci","assetPrefix":"/blog-next","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>