<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1" data-next-head=""/><meta name="description" content="The blog owned by Ryo, about Programing, Painting, and Gaming." data-next-head=""/><meta property="og:description" content="The blog owned by Ryo, about Programing, Painting, and Gaming." data-next-head=""/><meta name="twitter:description" content="The blog owned by Ryo, about Programing, Painting, and Gaming." data-next-head=""/><meta property="og:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta name="twitter:image" content="https://ryojerryyu.github.io/blog-next/img/home-bg-kasumi-hanabi.jpg" data-next-head=""/><meta property="og:type" content="website" data-next-head=""/><meta property="og:url" content="https://blog.ryo-okami.xyz/tags/å­¦ä¹ ç¬”è®°" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:site" content="@ryo_okami" data-next-head=""/><meta name="twitter:creator" content="@ryo_okami" data-next-head=""/><link rel="icon" href="/blog-next/favicon.ico" data-next-head=""/><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" data-next-head=""/><title data-next-head="">å­¦ä¹ ç¬”è®° | Ryo&#x27;s Blog</title><meta property="og:title" content="å­¦ä¹ ç¬”è®°" data-next-head=""/><meta property="og:site_name" content="Ryo&#x27;s Blog" data-next-head=""/><meta name="twitter:title" content="å­¦ä¹ ç¬”è®° | Ryo&#x27;s Blog" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png"/><link rel="manifest" href="/site.webmanifest"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="theme-color" content="#ffffff"/><link data-next-font="" rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/blog-next/_next/static/chunks/ace62dceef69c795.css" as="style"/><link rel="preload" href="/blog-next/_next/static/chunks/a2020d7ea2add2f2.css" as="style"/><link rel="preload" href="/blog-next/_next/static/chunks/53c99afcbdf7d98c.css" as="style"/><link rel="stylesheet" href="/blog-next/_next/static/chunks/ace62dceef69c795.css" data-n-g=""/><link rel="stylesheet" href="/blog-next/_next/static/chunks/a2020d7ea2add2f2.css" data-n-p=""/><link rel="stylesheet" href="/blog-next/_next/static/chunks/53c99afcbdf7d98c.css" data-n-p=""/><noscript data-n-css=""></noscript><script src="/blog-next/_next/static/chunks/8971e58fb2fd5b8f.js" defer=""></script><script src="/blog-next/_next/static/chunks/a3e9f1432d54ea55.js" defer=""></script><script src="/blog-next/_next/static/chunks/0207c8977e5b26f5.js" defer=""></script><script src="/blog-next/_next/static/chunks/4deda5b57bac675a.js" defer=""></script><script src="/blog-next/_next/static/chunks/4deec91ab8209f2c.js" defer=""></script><script src="/blog-next/_next/static/chunks/12d481071a046fa2.js" defer=""></script><script src="/blog-next/_next/static/chunks/3f40b1c63d4ad419.js" defer=""></script><script src="/blog-next/_next/static/chunks/turbopack-8f50356730318d52.js" defer=""></script><script src="/blog-next/_next/static/chunks/7655e08bb17d1f93.js" defer=""></script><script src="/blog-next/_next/static/chunks/35a88c1b79911188.js" defer=""></script><script src="/blog-next/_next/static/chunks/e1f193677456a9d4.js" defer=""></script><script src="/blog-next/_next/static/chunks/2d722e5896c9e657.js" defer=""></script><script src="/blog-next/_next/static/chunks/17f2b15942376494.js" defer=""></script><script src="/blog-next/_next/static/chunks/turbopack-ccdcc96261d98f7a.js" defer=""></script><script src="/blog-next/_next/static/C8wT_gaFm6V74l2wBJOmN/_ssgManifest.js" defer=""></script><script src="/blog-next/_next/static/C8wT_gaFm6V74l2wBJOmN/_buildManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css czlpqi">.css-czlpqi{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-czlpqi{position:absolute;}}</style><style data-emotion="css 1cmpeoq">.css-1cmpeoq{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:var(--Paper-shadow);background-image:var(--Paper-overlay);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:fixed;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#1976d2;--AppBar-color:#fff;background-color:var(--AppBar-background);color:var(--AppBar-color);background-color:rgba(15, 23, 42, 0.75);}@media print{.css-1cmpeoq{position:absolute;}}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionFixed mui-fixed css-1cmpeoq" style="--Paper-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12)"><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"><style data-emotion="css 1guk29">@media (min-width:0px){.css-1guk29{display:none;}}@media (min-width:900px){.css-1guk29{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}</style><div class="ml-2 w-24 mr-4 MuiBox-root css-1guk29"><a class="DefaultLayout-module-scss-module__geuMnW__textlink" href="/blog-next">Ryo&#x27;s Blog</a></div><style data-emotion="css 1m04nb5">@media (min-width:0px){.css-1m04nb5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}}@media (min-width:900px){.css-1m04nb5{display:none;}}</style><div class="ml-2 mr-2 MuiBox-root css-1m04nb5"><a title="Ryo&#x27;s Blog" href="/blog-next"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium h-6 w-6 text-gray-300 hover:text-white css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></a></div><style data-emotion="css nznm6s">.css-nznm6s{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1;-ms-flex:1;flex:1;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="MuiBox-root css-nznm6s"><div class="DefaultLayoutMenu bg-transparent min-w-full"><ul class="rc-menu-overflow rc-menu rc-menu-root rc-menu-horizontal" role="menu" tabindex="0" data-menu-list="true"><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:0" role="menuitem" tabindex="-1"><a class="DefaultLayout-module-scss-module__geuMnW__textlink" href="/blog-next/articles">Articles</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:1" role="menuitem" tabindex="-1"><a class="DefaultLayout-module-scss-module__geuMnW__textlink" href="/blog-next/learn_from_ai">Learn from AI</a></li><li class="rc-menu-overflow-item rc-menu-item" style="opacity:1;order:2" role="menuitem" tabindex="-1"><a class="DefaultLayout-module-scss-module__geuMnW__textlink" href="/blog-next/tags">Tags</a></li><li class="rc-menu-overflow-item rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:1;order:3" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" aria-expanded="false" aria-haspopup="true"><span class="DefaultLayout-module-scss-module__geuMnW__textlink">More</span><i class="rc-menu-submenu-arrow"></i></div></li><li class="rc-menu-overflow-item rc-menu-overflow-item-rest rc-menu-submenu rc-menu-submenu-horizontal" style="opacity:0;height:0;overflow-y:hidden;order:9007199254740991;pointer-events:none;position:absolute" aria-hidden="true" role="none"><div role="menuitem" class="rc-menu-submenu-title" tabindex="-1" title="..." aria-expanded="false" aria-haspopup="true">...<i class="rc-menu-submenu-arrow"></i></div></li></ul><div style="display:none" aria-hidden="true"></div></div></div><style data-emotion="css k008qs">.css-k008qs{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;}</style><div class="MuiBox-root css-k008qs"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white mx-1 sm:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></header><style data-emotion="css awgou1">.css-awgou1{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-awgou1{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-awgou1{min-height:48px;}}}@media (min-width:600px){.css-awgou1{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-awgou1"></div><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"><style data-emotion="css uwwqev">.css-uwwqev{width:100%;height:100%;}</style><div class="MuiBox-root css-uwwqev"></div></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="DefaultLayout-module-scss-module__geuMnW__contentHeight"><div class="p-2"><div class="TagsBox-module-scss-module__voMczG__tagsBox"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%9D%82%E6%8A%80">#<!-- -->æ‚æŠ€</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/blog">#<!-- -->Blog</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%9D%82%E8%B0%88">#<!-- -->æ‚è°ˆ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/c++">#<!-- -->C++</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/python">#<!-- -->Python</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">#<!-- -->æ•°æ®ç»“æ„</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%AE%97%E6%B3%95">#<!-- -->ç®—æ³•</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%8E%92%E5%BA%8F">#<!-- -->æ’åº</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%AE%97%E6%B3%95%E7%AB%9E%E8%B5%9B">#<!-- -->ç®—æ³•ç«èµ›</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">#<!-- -->è®¾è®¡æ¨¡å¼</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%AC%94%E8%AE%B0">#<!-- -->ç¬”è®°</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/github">#<!-- -->GitHub</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/aws">#<!-- -->AWS</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/ci-cd">#<!-- -->CI/CD</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/iac">#<!-- -->IaC</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/devops">#<!-- -->DevOps</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/vscode">#<!-- -->VSCode</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/hexo">#<!-- -->Hexo</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/javascript">#<!-- -->JavaScript</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/kubernetes">#<!-- -->Kubernetes</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/docker">#<!-- -->Docker</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/cloud-native">#<!-- -->Cloud Native</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/cursor">#<!-- -->Cursor</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B8%B8%E6%88%8F%E7%8E%8B">#<!-- -->æ¸¸æˆç‹</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B8%B8%E6%88%8F%E7%8E%8Bmd">#<!-- -->æ¸¸æˆç‹MD</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B8%B8%E6%88%8F%E7%8E%8B%E5%A4%A7%E5%B8%88%E5%86%B3%E6%96%97">#<!-- -->æ¸¸æˆç‹å¤§å¸ˆå†³æ–—</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/p%E5%89%8D%E9%93%B6%E9%87%91%EF%BC%88%E6%9A%9747%E5%9E%8B%EF%BC%89">#<!-- -->På‰é“¶é‡‘ï¼ˆæš—47å‹ï¼‰</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/linux">#<!-- -->Linux</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/systemctl">#<!-- -->systemctl</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/journalctl">#<!-- -->journalctl</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/timedatectl">#<!-- -->timedatectl</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/basicknowledge">#<!-- -->BasicKnowledge</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/operation">#<!-- -->Operation</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/signal">#<!-- -->Signal</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/memory">#<!-- -->memory</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/schedule">#<!-- -->schedule</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%AF%E8%A7%86%E5%8C%96">#<!-- -->å¯è§†åŒ–</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%95%B0%E5%AD%A6">#<!-- -->æ•°å­¦</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%B7%A5%E5%85%B7">#<!-- -->å·¥å…·</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/nextjs">#<!-- -->Nextjs</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/tag1">#<!-- -->Tag1</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/tag2">#<!-- -->Tag2</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8D%95%E8%A1%8Ctag">#<!-- -->å•è¡ŒTag</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/tag">#<!-- -->Tag</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/tag-tag2">#<!-- -->Tag/Tag2</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/tag3">#<!-- -->Tag3</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/cloud-computing">#<!-- -->Cloud Computing</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/pytorch">#<!-- -->PyTorch</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/onnx">#<!-- -->ONNX</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2">#<!-- -->æ¨¡å‹éƒ¨ç½²</a><a class="tag-word TagsBox-module-scss-module__voMczG__highlightedTag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/opencv">#<!-- -->OpenCV</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86">#<!-- -->å›¾åƒå¤„ç†</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/rust">#<!-- -->Rust</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80">#<!-- -->ç¼–ç¨‹è¯­è¨€</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/windows">#<!-- -->Windows</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/macos">#<!-- -->macOS</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6">#<!-- -->å¯æ‰§è¡Œæ–‡ä»¶</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->å‚æ•°é«˜æ•ˆå¾®è°ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->æ¨¡å‹è®­ç»ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD">#<!-- -->åå‘ä¼ æ’­</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86">#<!-- -->è‡ªåŠ¨å¾®åˆ†</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/golang">#<!-- -->GoLang</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/memory-management">#<!-- -->Memory Management</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/deep-learning">#<!-- -->Deep Learning</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/model-management">#<!-- -->Model Management</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/neural-networks">#<!-- -->Neural Networks</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/resnet">#<!-- -->ResNet</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/mathematics">#<!-- -->Mathematics</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8D%8F%E8%AE%AE">#<!-- -->åè®®</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/iot">#<!-- -->IoT</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%89%A9%E8%81%94%E7%BD%91">#<!-- -->ç‰©è”ç½‘</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">#<!-- -->æ¶ˆæ¯é˜Ÿåˆ—</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/stable-diffusion">#<!-- -->Stable Diffusion</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/concurrency">#<!-- -->Concurrency</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/scheduler">#<!-- -->Scheduler</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/goroutine">#<!-- -->Goroutine</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0">#<!-- -->çº¿æ€§ä»£æ•°</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%BE%A4%E8%AE%BA">#<!-- -->ç¾¤è®º</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/test">#<!-- -->test</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/wiki">#<!-- -->wiki</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/page1">#<!-- -->page1</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/page3">#<!-- -->page3</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/subpage1">#<!-- -->subpage1</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/subpage2">#<!-- -->subpage2</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/subpage3">#<!-- -->subpage3</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/page2">#<!-- -->page2</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/subpage34">#<!-- -->subpage34</a></div></div><div class="PostList-module-scss-module__sd7qbq__postList"><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/stable-diffusion-lora-training-methods"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">PyTorch å®ç° Stable Diffusion LoRA è®­ç»ƒè„šæœ¬ï¼šä»æ•°æ®é¢„å¤„ç†åˆ°æ¨¡å‹ä¿®æ”¹ä¸è®­ç»ƒå¾ªç¯</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2025-03-29T02:00:00.000Z">2025-03-29</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ PyTorch ä»é›¶å¼€å§‹ç¼–å†™ Stable Diffusion LoRA è®­ç»ƒè„šæœ¬ï¼ŒåŒ…æ‹¬æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹ä¿®æ”¹ã€è®­ç»ƒå¾ªç¯ã€å‚æ•°ä¿å­˜ä¸åŠ è½½ç­‰å…³é”®æ­¥éª¤ã€‚ç‰¹åˆ«å¼ºè°ƒäº† LoRA å±‚çš„æ‰‹åŠ¨å®ç°å’Œåœ¨ UNet çš„ Cross-Attention å±‚æ³¨å…¥ LoRA çš„åŸå› ï¼Œä»¥åŠåœ¨å…¶ä»–å±‚åº”ç”¨ LoRA çš„å¯èƒ½æ€§å’Œæ³¨æ„äº‹é¡¹ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº†ä»£ç ç¤ºä¾‹å’Œå‚æ•°æ•ˆç‡çš„è®¨è®ºï¼Œå¸®åŠ©è¯»è€…æ·±å…¥ç†è§£ LoRA åœ¨ Stable Diffusion å¾®è°ƒä¸­çš„åº”ç”¨ã€‚</p><p class="py-1">&gt; [!reasoning]-</p><p class="py-1">&gt;</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/stable-diffusion">#<!-- -->Stable Diffusion</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->å‚æ•°é«˜æ•ˆå¾®è°ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->æ¨¡å‹è®­ç»ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/mqtt-protocol-principles-applications"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">è¯¦ç»†ä»‹ç» MQTT åè®®çš„å†…å®¹ï¼ŒåŸç†ï¼Œåº”ç”¨åœºæ™¯</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2025-03-28T06:35:00.000Z">2025-03-28</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† MQTTï¼ˆMessage Queuing Telemetry Transportï¼‰åè®®çš„æ ¸å¿ƒå†…å®¹ã€å·¥ä½œåŸç†åŠå…¶åœ¨ç‰©è”ç½‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨åœºæ™¯ã€‚æ–‡ç« åˆ†æäº† MQTT åè®®çš„ç‰¹ç‚¹ã€æ¶ˆæ¯è´¨é‡ç­‰çº§ã€ä¸»é¢˜è®¾è®¡ä»¥åŠå®‰å…¨æœºåˆ¶ï¼Œå¸®åŠ©è¯»è€…å…¨é¢äº†è§£è¿™ä¸€è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…åè®®å¦‚ä½•æ”¯æŒèµ„æºå—é™è®¾å¤‡çš„å¯é é€šä¿¡ã€‚</p><p class="py-1">MQTTï¼ˆMessage Queuing Telemetry Transportï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„ã€åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œä¸“ä¸ºå—é™è®¾å¤‡å’Œä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸å¯é çš„ç½‘ç»œç¯å¢ƒè®¾è®¡ã€‚å®ƒç”± Andy Stanford-Clarkï¼ˆIBMï¼‰å’Œ Arlen Nipperï¼ˆCirrus Linkï¼‰äº 1999 å¹´ä¸ºè¿æ¥çŸ³æ²¹ç®¡é“çš„ SCADA ç³»ç»Ÿè€Œå¼€å‘ï¼Œç°å·²å‘å±•æˆä¸ºç‰©è”ç½‘ï¼ˆIoTï¼‰é€šä¿¡çš„æ ‡å‡†åè®®ä¹‹ä¸€ã€‚</p><p class="py-1">MQTT åè®®å·¥ä½œåœ¨ TCP/IP åè®®æ ˆä¸Šï¼Œä½¿ç”¨äº†æœ€å°åŒ–çš„åè®®å¼€é”€ï¼Œå¯ä»¥åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šå®ç°é«˜æ•ˆé€šä¿¡ã€‚å®ƒé‡‡ç”¨å‘å¸ƒ/è®¢é˜…çš„æ¶ˆæ¯æ¨¡å¼ï¼Œè€Œéä¼ ç»Ÿçš„å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¨¡å¼ï¼Œè¿™ä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆæ„å»ºå¯æ‰©å±•çš„ç‰©è”ç½‘åº”ç”¨ã€‚</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8D%8F%E8%AE%AE">#<!-- -->åè®®</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/iot">#<!-- -->IoT</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E7%89%A9%E8%81%94%E7%BD%91">#<!-- -->ç‰©è”ç½‘</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97">#<!-- -->æ¶ˆæ¯é˜Ÿåˆ—</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/stable-diffusion-unet-structure"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">Stable Diffusion UNet å†…éƒ¨ç»“æ„</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2025-03-28T02:00:00.000Z">2025-03-28</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; [!summary]</p><p class="py-1">&gt; ä»¥ä¸‹å†…å®¹ä¸º Cursor ä¸­æ‹¥æœ‰ codebase ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ä¸ claude-3.7-sonnet çš„å¯¹è¯è®°å½•</p><p class="py-1">åœ¨ `train_text_to_image_lora.py` è„šæœ¬ä¸­ï¼ŒLoRAï¼ˆLow-Rank Adaptationï¼‰é€šè¿‡åœ¨æ¨¡å‹çš„ç‰¹å®šå±‚ä¸­æ’å…¥ä½ç§©çŸ©é˜µæ¥å®ç°å¾®è°ƒã€‚è¿™ç§æ–¹æ³•é€šè¿‡æ·»åŠ ä¸¤ä¸ªä½ç§©çŸ©é˜µæ¥è°ƒæ•´æ¨¡å‹çš„æƒé‡ï¼Œè€Œä¸æ”¹å˜åŸå§‹æƒé‡ï¼Œä»è€Œå®ç°å‚æ•°é«˜æ•ˆçš„å¾®è°ƒã€‚</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/stable-diffusion">#<!-- -->Stable Diffusion</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->å‚æ•°é«˜æ•ˆå¾®è°ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->æ¨¡å‹è®­ç»ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/pytorch-backpropagation-mechanism"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">PyTorch è‡ªåŠ¨å¾®åˆ†ä¸åå‘ä¼ æ’­æœºåˆ¶åŸç†è§£æ</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2025-03-06T15:50:00.000Z">2025-03-06</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬æ–‡ä¸ºç”¨æˆ·ä¸ DeepSeek çš„é—®ç­”ã€‚ä¸»é¢˜ä¸º PyTorch çš„åå‘ä¼ æ’­æœºåˆ¶ã€‚æœ¬æ–‡ä»æ•°å­¦åŸç†ã€è®¡ç®—å›¾æœºåˆ¶å’Œå®é™…éœ€æ±‚ä¸‰ä¸ªæ–¹é¢æ·±å…¥è§£é‡Šå…¶å·¥ä½œåŸç†ï¼Œå¹¶ç»“åˆ PyTorch çš„è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰ç³»ç»Ÿè¿›è¡Œè¯´æ˜ã€‚</p><p class="py-1">&gt; [!query]</p><p class="py-1">&gt;</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/pytorch">#<!-- -->PyTorch</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%8D%E5%90%91%E4%BC%A0%E6%92%AD">#<!-- -->åå‘ä¼ æ’­</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E8%87%AA%E5%8A%A8%E5%BE%AE%E5%88%86">#<!-- -->è‡ªåŠ¨å¾®åˆ†</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/lora-matrix-initialization-strategy"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">LoRAå¾®è°ƒä¸­çš„çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥ï¼šAéšæœºä¸Bé›¶åˆå§‹åŒ–</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2025-03-05T02:00:00.000Z">2025-03-05</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬æ–‡æ˜¯ä¸ Deepseek-R1 æ¨¡å‹+Search çš„å¯¹è¯è®°å½•ï¼Œè¯¦ç»†æ¢è®¨äº† LoRAï¼ˆä½ç§©é€‚åº”ï¼‰å¾®è°ƒæŠ€æœ¯ä¸­çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥çš„æ•°å­¦åŸç†ã€‚æ–‡ç« åˆ†æäº†ä¸ºä»€ä¹ˆåœ¨ LoRA ä¸­çŸ©é˜µ A é‡‡ç”¨éšæœºåˆå§‹åŒ–è€ŒçŸ©é˜µ B é‡‡ç”¨é›¶åˆå§‹åŒ–çš„åŸå› ï¼ŒåŒ…æ‹¬ä¿æŒåˆå§‹æ¨¡å‹ç¨³å®šæ€§ã€ç¡®ä¿æ¢¯åº¦æ›´æ–°æœ‰æ•ˆæ€§ã€å®ç°é€æ­¥å­¦ä¹ çš„ä½ç§©æ›´æ–°ç­‰æ–¹é¢ã€‚åŒæ—¶ï¼Œæ–‡ç« ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåå‘åˆå§‹åŒ–ç­–ç•¥ï¼ˆBéšæœºè€ŒAä¸ºé›¶ï¼‰åœ¨ç†è®ºä¸Šå­˜åœ¨é—®é¢˜ï¼Œä¼šå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±å’Œè®­ç»ƒæ•ˆç‡ä¸‹é™ã€‚è¿™äº›åˆ†ææœ‰åŠ©äºç†è§£æ·±åº¦å­¦ä¹ ä¸­å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯çš„è®¾è®¡åŸç†ã€‚</p><p class="py-1">&gt; [!reasoning]-</p><p class="py-1">&gt; å—¯ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºLoRAï¼ˆä½ç§©é€‚åº”ï¼‰åˆå§‹åŒ–çš„ã€‚ä¸ºä»€ä¹ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒçŸ©é˜µAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œè€ŒçŸ©é˜µBæ˜¯é›¶åˆå§‹åŒ–çš„å‘¢ï¼Ÿæˆ‘éœ€è¦ä»”ç»†æ€è€ƒä¸€ä¸‹ã€‚</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/lora">#<!-- -->LoRA</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%82%E6%95%B0%E9%AB%98%E6%95%88%E5%BE%AE%E8%B0%83">#<!-- -->å‚æ•°é«˜æ•ˆå¾®è°ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83">#<!-- -->æ¨¡å‹è®­ç»ƒ</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/executable-file-formats"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å¯¹æ¯”ï¼šELFã€PEã€Mach-Oç­‰</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2024-12-08T02:00:00.000Z">2024-12-08</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬æ–‡ä»‹ç»äº†å‡ ç§ä¸»è¦çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ŒåŒ…æ‹¬Linuxç³»ç»Ÿä½¿ç”¨çš„ELFæ ¼å¼ã€Windowsç³»ç»Ÿä½¿ç”¨çš„PEæ ¼å¼ã€ä»¥åŠmacOSç³»ç»Ÿä½¿ç”¨çš„Mach-Oæ ¼å¼ç­‰ã€‚æ–‡ç« è¯¦ç»†è®¨è®ºäº†æ¯ç§æ ¼å¼çš„ç‰¹ç‚¹ã€ä½¿ç”¨å¹³å°å’Œå†å²æ¼”å˜ï¼Œå¸®åŠ©è¯»è€…ç†è§£ä¸åŒæ“ä½œç³»ç»Ÿä¸­äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„å·®å¼‚ã€‚</p><p class="py-1">ELFï¼ˆExecutable and Linkable Formatï¼‰æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸€ç§ç”¨äºLinuxå’Œç±»Unixæ“ä½œç³»ç»Ÿçš„æ ‡å‡†äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ã€‚å®ƒåŒ…å«äº†å¯æ‰§è¡Œç¨‹åºã€å…±äº«åº“ã€ç›®æ ‡æ–‡ä»¶å’Œæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚ELFæ–‡ä»¶æ ¼å¼è®¾è®¡çµæ´»ã€å¯æ‰©å±•ï¼Œå¹¶ä¸”å¯ç§»æ¤ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä»£ç çš„åŠ è½½å’Œæ‰§è¡Œæ–¹å¼ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ç­‰ã€‚æ“ä½œç³»ç»Ÿæ ¹æ®ELFæ–‡ä»¶ä¸­çš„è¿™äº›ä¿¡æ¯æ¥å’Œæ‰§è¡Œç¨‹åºã€‚ELFæ ¼å¼ä¹Ÿå…è®¸ç¨‹åºå…±äº«åº“ï¼Œå³å¤šä¸ªç¨‹åºå¯ä»¥å…±äº«åŒä¸€æ®µä»£ç ï¼Œä»è€Œå‡å°‘å†…å­˜å ç”¨å¹¶æé«˜æ•ˆç‡ã€‚åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒELFæ–‡ä»¶ä½œä¸ºç›®æ ‡æ–‡ä»¶æ ¼å¼åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œå¹¶æœ€ç»ˆç”±é“¾æ¥å™¨ç»„åˆå½¢æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ã€‚</p><p class="py-1">æ˜¯çš„ï¼Œé™¤äº†ELFï¼ˆExecutable and Linking Formatï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–å‡ ç§å¸¸è§çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œå¹³å°ä¸Šè¢«å¹¿æ³›ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼š</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/linux">#<!-- -->Linux</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/windows">#<!-- -->Windows</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/macos">#<!-- -->macOS</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6">#<!-- -->å¯æ‰§è¡Œæ–‡ä»¶</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/opencv-coordinate-system-conventions"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">OpenCV åæ ‡è¡¨ç¤ºï¼šç†è§£ (y, x) ä¸ (x, y) çš„åŒºåˆ«</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2024-11-29T03:00:00.000Z">2024-11-29</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; ğŸ“ æœ¬æ–‡æ˜¯æˆ‘åœ¨å­¦ä¹  OpenCV æ—¶é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚é—®é¢˜çš„è§£ç­”å’Œä¸­æ–‡ç¿»è¯‘å‡ç”± AI ç”Ÿæˆã€‚</p><p class="py-1">Why sometimes opencv represent a point coordinate as (y,x) (e.g. the result of cv2.findContours) , and sometimes it represent as (x, y) (e.g. the arg `center` of cv2.circle)?</p><p class="py-1">&gt; ä¸ºä»€ä¹ˆ OpenCV æœ‰æ—¶ç”¨ (y,x) è¡¨ç¤ºåæ ‡ç‚¹ï¼ˆæ¯”å¦‚ cv2.findContours çš„è¿”å›å€¼ï¼‰ï¼Œæœ‰æ—¶åˆç”¨ (x,y) è¡¨ç¤ºï¼ˆæ¯”å¦‚ cv2.circle å‡½æ•°çš„ `center` å‚æ•°ï¼‰ï¼Ÿ</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/opencv">#<!-- -->OpenCV</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86">#<!-- -->å›¾åƒå¤„ç†</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div><div class="PostList-module-scss-module__sd7qbq__postListElement"><a href="/blog-next/learn_from_ai/deep-learning-model-formats"><h6 class="PostList-module-scss-module__sd7qbq__postTitle">æ·±åº¦å­¦ä¹ æ¨¡å‹æ–‡ä»¶æ ¼å¼å¯¹æ¯”ï¼špthã€safetensor ä¸ onnx</h6><div class="PostList-module-scss-module__sd7qbq__postDate"><time dateTime="2024-11-29T02:00:00.000Z">2024-11-29</time></div><div class="PostList-module-scss-module__sd7qbq__postAbstract"><p class="py-1">&gt; æœ¬é¡µé¢ä»‹ç»äº†ä¸‰ç§æœºå™¨å­¦ä¹ æ¨¡å‹æ–‡ä»¶æ ¼å¼ï¼š.pthã€.safetensor å’Œ .onnxã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬æ¯ç§æ ¼å¼çš„å®šä¹‰ã€ä¿å­˜çš„å†…å®¹ã€ç”¨é€”ä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å’Œè½¬æ¢æ–¹æ³•ã€‚</p><p class="py-1">PyTorch ä¸­çš„`.pth`æ–‡ä»¶é€šå¸¸ç”¨äºä¿å­˜æ¨¡å‹çš„æƒé‡ï¼ˆparametersï¼‰å’Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆoptimizer stateï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ª`.pth`æ–‡ä»¶å¯èƒ½åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><p class="py-1">1. **æ¨¡å‹çŠ¶æ€å­—å…¸ï¼ˆModel state dictionaryï¼‰**ï¼š</p></div></a><div class="TagsBox-module-scss-module__voMczG__tagsBox py-4 md:py-1"><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/pytorch">#<!-- -->PyTorch</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/onnx">#<!-- -->ONNX</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">#<!-- -->æ·±åº¦å­¦ä¹ </a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2">#<!-- -->æ¨¡å‹éƒ¨ç½²</a><a class="tag-word TagsBox-module-scss-module__voMczG__tag" href="/blog-next/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0">#<!-- -->å­¦ä¹ ç¬”è®°</a></div></div></div></div></div><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div></div><footer class="DefaultLayout-module-scss-module__geuMnW__footer"><style data-emotion="css vktxal">.css-vktxal{--Grid-columns:12;--Grid-columnSpacing:0px;--Grid-rowSpacing:0px;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;min-width:0;box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;gap:var(--Grid-rowSpacing) var(--Grid-columnSpacing);width:100%;max-width:80rem;margin-left:auto;margin-right:auto;padding:0.5rem;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-vktxal >*{--Grid-parent-columns:12;}.css-vktxal >*{--Grid-parent-columnSpacing:0px;}.css-vktxal >*{--Grid-parent-rowSpacing:0px;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-row css-vktxal"><style data-emotion="css vkdybf">.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 3 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 3) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-vkdybf{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-3 MuiGrid-grid-lg-2 css-vkdybf"><style data-emotion="css uwwqev">.css-uwwqev{width:100%;height:100%;}</style><div class="MuiBox-root css-uwwqev"></div></div><style data-emotion="css 9h67uz">.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 12 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 12) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 9 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 9) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9h67uz{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 8 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 8) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-12 MuiGrid-grid-md-9 MuiGrid-grid-lg-8 css-9h67uz"><div class="flex flex-row justify-center items-center"><div class="DefaultLayout-module-scss-module__geuMnW__footerLeft">Â© 2023 Ryo Jerry Yu. All rights reserved.</div><div class="DefaultLayout-module-scss-module__geuMnW__footerRight"><a title="Twitter" href="https://twitter.com/ryo_okami"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a title="GitHub" href="https://github.com/RyoJerryYu"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a title="Pixiv" href="https://www.pixiv.net/users/9159893"><svg class="h-6 w-6 fill-gray-300 hover:fill-white transition-all ease-in-out mx-1 md:mx-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4.935 0A4.924 4.924 0 0 0 0 4.935v14.13A4.924 4.924 0 0 0 4.935 24h14.13A4.924 4.924 0 0 0 24 19.065V4.935A4.924 4.924 0 0 0 19.065 0zm7.81 4.547c2.181 0 4.058.676 5.399 1.847a6.118 6.118 0 0 1 2.116 4.66c.005 1.854-.88 3.476-2.257 4.563-1.375 1.092-3.225 1.697-5.258 1.697-2.314 0-4.46-.842-4.46-.842v2.718c.397.116 1.048.365.635.779H5.79c-.41-.41.19-.65.644-.779V7.666c-1.053.81-1.593 1.51-1.868 2.031.32 1.02-.284.969-.284.969l-1.09-1.73s3.868-4.39 9.553-4.39zm-.19.971c-1.423-.003-3.184.473-4.27 1.244v8.646c.988.487 2.484.832 4.26.832h.01c1.596 0 2.98-.593 3.93-1.533.952-.948 1.486-2.183 1.492-3.683-.005-1.54-.504-2.864-1.42-3.86-.918-.992-2.274-1.645-4.002-1.646Z"></path></svg></a></div></div></div><style data-emotion="css 9gdssj">.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));min-width:0;box-sizing:border-box;}@media (min-width:900px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 0 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 0) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}@media (min-width:1200px){.css-9gdssj{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-basis:auto;-ms-flex-preferred-size:auto;flex-basis:auto;width:calc(100% * 2 / var(--Grid-parent-columns) - (var(--Grid-parent-columns) - 2) * (var(--Grid-parent-columnSpacing) / var(--Grid-parent-columns)));}}</style><div class="MuiGrid-root MuiGrid-direction-xs-row MuiGrid-grid-xs-0 MuiGrid-grid-md-0 MuiGrid-grid-lg-2 css-9gdssj"></div></div></footer><div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"allTagInfos":[{"tag":"æ‚æŠ€","slug":"æ‚æŠ€","path":"/tags/æ‚æŠ€","postSlugs":[{"postType":"articles","postPagePath":"/articles/Building-this-blog"},{"postType":"articles","postPagePath":"/articles/hello-world"},{"postType":"articles","postPagePath":"/articles/the-using-in-cpp"}]},{"tag":"Blog","slug":"blog","path":"/tags/blog","postSlugs":[{"postType":"articles","postPagePath":"/articles/Building-this-blog"},{"postType":"articles","postPagePath":"/articles/init-a-new-hexo-project"},{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"},{"postType":"articles","postPagePath":"/articles/use-paste-image-and-vscode-memo"},{"postType":"ideas","postPagePath":"/ideas/blog-in-next"},{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"æ‚è°ˆ","slug":"æ‚è°ˆ","path":"/tags/æ‚è°ˆ","postSlugs":[{"postType":"articles","postPagePath":"/articles/hello-world"},{"postType":"articles","postPagePath":"/articles/try-cursor-and-thinking"},{"postType":"articles","postPagePath":"/articles/ygomd-synchro-cup-crystron"},{"postType":"articles","postPagePath":"/articles/ygomd-chronicle-cup-six-samurai"}]},{"tag":"C++","slug":"c++","path":"/tags/c++","postSlugs":[{"postType":"articles","postPagePath":"/articles/the-using-in-cpp"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/cpp-rvo-and-rust-move-semantics"}]},{"tag":"Python","slug":"python","path":"/tags/python","postSlugs":[{"postType":"articles","postPagePath":"/articles/python-dict"}]},{"tag":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","path":"/tags/æ•°æ®ç»“æ„","postSlugs":[{"postType":"articles","postPagePath":"/articles/python-dict"},{"postType":"articles","postPagePath":"/articles/Sort-algorithm"},{"postType":"articles","postPagePath":"/articles/Handy-heap-cheat-sheet"}]},{"tag":"ç®—æ³•","slug":"ç®—æ³•","path":"/tags/ç®—æ³•","postSlugs":[{"postType":"articles","postPagePath":"/articles/Sort-algorithm"},{"postType":"articles","postPagePath":"/articles/Handy-heap-cheat-sheet"}]},{"tag":"æ’åº","slug":"æ’åº","path":"/tags/æ’åº","postSlugs":[{"postType":"articles","postPagePath":"/articles/Sort-algorithm"}]},{"tag":"ç®—æ³•ç«èµ›","slug":"ç®—æ³•ç«èµ›","path":"/tags/ç®—æ³•ç«èµ›","postSlugs":[{"postType":"articles","postPagePath":"/articles/Handy-heap-cheat-sheet"}]},{"tag":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","path":"/tags/è®¾è®¡æ¨¡å¼","postSlugs":[{"postType":"articles","postPagePath":"/articles/The-beauty-of-design-parten"}]},{"tag":"ç¬”è®°","slug":"ç¬”è®°","path":"/tags/ç¬”è®°","postSlugs":[{"postType":"articles","postPagePath":"/articles/The-beauty-of-design-parten"}]},{"tag":"GitHub","slug":"github","path":"/tags/github","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"}]},{"tag":"AWS","slug":"aws","path":"/tags/aws","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"}]},{"tag":"CI/CD","slug":"ci-cd","path":"/tags/ci-cd","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"}]},{"tag":"IaC","slug":"iac","path":"/tags/iac","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"}]},{"tag":"DevOps","slug":"devops","path":"/tags/devops","postSlugs":[{"postType":"articles","postPagePath":"/articles/create-blog-cicd-by-github"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"VSCode","slug":"vscode","path":"/tags/vscode","postSlugs":[{"postType":"articles","postPagePath":"/articles/use-paste-image-and-vscode-memo"}]},{"tag":"Hexo","slug":"hexo","path":"/tags/hexo","postSlugs":[{"postType":"articles","postPagePath":"/articles/use-paste-image-and-vscode-memo"}]},{"tag":"JavaScript","slug":"javascript","path":"/tags/javascript","postSlugs":[{"postType":"articles","postPagePath":"/articles/use-paste-image-and-vscode-memo"}]},{"tag":"Kubernetes","slug":"kubernetes","path":"/tags/kubernetes","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Docker","slug":"docker","path":"/tags/docker","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Cloud Native","slug":"cloud-native","path":"/tags/cloud-native","postSlugs":[{"postType":"articles","postPagePath":"/articles/introduction-for-k8s"},{"postType":"articles","postPagePath":"/articles/introduction-for-k8s-2"},{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"Cursor","slug":"cursor","path":"/tags/cursor","postSlugs":[{"postType":"articles","postPagePath":"/articles/try-cursor-and-thinking"}]},{"tag":"æ¸¸æˆç‹","slug":"æ¸¸æˆç‹","path":"/tags/æ¸¸æˆç‹","postSlugs":[{"postType":"articles","postPagePath":"/articles/ygomd-synchro-cup-crystron"},{"postType":"articles","postPagePath":"/articles/ygomd-chronicle-cup-six-samurai"}]},{"tag":"æ¸¸æˆç‹MD","slug":"æ¸¸æˆç‹md","path":"/tags/æ¸¸æˆç‹md","postSlugs":[{"postType":"articles","postPagePath":"/articles/ygomd-synchro-cup-crystron"},{"postType":"articles","postPagePath":"/articles/ygomd-chronicle-cup-six-samurai"}]},{"tag":"æ¸¸æˆç‹å¤§å¸ˆå†³æ–—","slug":"æ¸¸æˆç‹å¤§å¸ˆå†³æ–—","path":"/tags/æ¸¸æˆç‹å¤§å¸ˆå†³æ–—","postSlugs":[{"postType":"articles","postPagePath":"/articles/ygomd-synchro-cup-crystron"},{"postType":"articles","postPagePath":"/articles/ygomd-chronicle-cup-six-samurai"}]},{"tag":"På‰é“¶é‡‘ï¼ˆæš—47å‹ï¼‰","slug":"på‰é“¶é‡‘ï¼ˆæš—47å‹ï¼‰","path":"/tags/på‰é“¶é‡‘ï¼ˆæš—47å‹ï¼‰","postSlugs":[{"postType":"articles","postPagePath":"/articles/ygomd-pendulum-evolution-zarc-anaconda"}]},{"tag":"Linux","slug":"linux","path":"/tags/linux","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"},{"postType":"ideas","postPagePath":"/ideas/Linux ä¿¡å·å¤„ç† â€”â€” Signal"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å†…å­˜åˆ†é¡µã€åˆ†æ®µ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å †å’Œæ ˆ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” è™šæ‹Ÿå†…å­˜"},{"postType":"ideas","postPagePath":"/ideas/Linux è°ƒåº¦ â€”â€” è¿›ç¨‹ä¸çº¿ç¨‹"},{"postType":"ideas","postPagePath":"/ideas/blog-syntax"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"}]},{"tag":"systemctl","slug":"systemctl","path":"/tags/systemctl","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"}]},{"tag":"journalctl","slug":"journalctl","path":"/tags/journalctl","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"}]},{"tag":"timedatectl","slug":"timedatectl","path":"/tags/timedatectl","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"}]},{"tag":"BasicKnowledge","slug":"basicknowledge","path":"/tags/basicknowledge","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"},{"postType":"ideas","postPagePath":"/ideas/Linux ä¿¡å·å¤„ç† â€”â€” Signal"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å†…å­˜åˆ†é¡µã€åˆ†æ®µ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å †å’Œæ ˆ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” è™šæ‹Ÿå†…å­˜"},{"postType":"ideas","postPagePath":"/ideas/Linux è°ƒåº¦ â€”â€” è¿›ç¨‹ä¸çº¿ç¨‹"}]},{"tag":"Operation","slug":"operation","path":"/tags/operation","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux Systemd"},{"postType":"ideas","postPagePath":"/ideas/Linux ä¿¡å·å¤„ç† â€”â€” Signal"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å†…å­˜åˆ†é¡µã€åˆ†æ®µ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” è™šæ‹Ÿå†…å­˜"}]},{"tag":"Signal","slug":"signal","path":"/tags/signal","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux ä¿¡å·å¤„ç† â€”â€” Signal"}]},{"tag":"memory","slug":"memory","path":"/tags/memory","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å†…å­˜åˆ†é¡µã€åˆ†æ®µ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” å †å’Œæ ˆ"},{"postType":"ideas","postPagePath":"/ideas/Linux å†…å­˜ â€”â€” è™šæ‹Ÿå†…å­˜"}]},{"tag":"schedule","slug":"schedule","path":"/tags/schedule","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/Linux è°ƒåº¦ â€”â€” è¿›ç¨‹ä¸çº¿ç¨‹"}]},{"tag":"å¯è§†åŒ–","slug":"å¯è§†åŒ–","path":"/tags/å¯è§†åŒ–","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog ç”»å›¾ Iframe æµ‹è¯•"}]},{"tag":"æ•°å­¦","slug":"æ•°å­¦","path":"/tags/æ•°å­¦","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog ç”»å›¾ Iframe æµ‹è¯•"}]},{"tag":"å·¥å…·","slug":"å·¥å…·","path":"/tags/å·¥å…·","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog ç”»å›¾ Iframe æµ‹è¯•"}]},{"tag":"Nextjs","slug":"nextjs","path":"/tags/nextjs","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-in-next"},{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Tag1","slug":"tag1","path":"/tags/tag1","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Tag2","slug":"tag2","path":"/tags/tag2","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"å•è¡ŒTag","slug":"å•è¡Œtag","path":"/tags/å•è¡Œtag","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Tag","slug":"tag","path":"/tags/tag","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Tag/Tag2","slug":"tag-tag2","path":"/tags/tag-tag2","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Tag3","slug":"tag3","path":"/tags/tag3","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/blog-syntax"}]},{"tag":"Cloud Computing","slug":"cloud-computing","path":"/tags/cloud-computing","postSlugs":[{"postType":"ideas","postPagePath":"/ideas/newest"}]},{"tag":"PyTorch","slug":"pytorch","path":"/tags/pytorch","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-model-save-and-load"}]},{"tag":"ONNX","slug":"onnx","path":"/tags/onnx","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"}]},{"tag":"æ·±åº¦å­¦ä¹ ","slug":"æ·±åº¦å­¦ä¹ ","path":"/tags/æ·±åº¦å­¦ä¹ ","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"æ¨¡å‹éƒ¨ç½²","slug":"æ¨¡å‹éƒ¨ç½²","path":"/tags/æ¨¡å‹éƒ¨ç½²","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"}]},{"tag":"å­¦ä¹ ç¬”è®°","slug":"å­¦ä¹ ç¬”è®°","path":"/tags/å­¦ä¹ ç¬”è®°","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/opencv-coordinate-system-conventions"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"OpenCV","slug":"opencv","path":"/tags/opencv","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/opencv-coordinate-system-conventions"}]},{"tag":"å›¾åƒå¤„ç†","slug":"å›¾åƒå¤„ç†","path":"/tags/å›¾åƒå¤„ç†","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/opencv-coordinate-system-conventions"}]},{"tag":"Rust","slug":"rust","path":"/tags/rust","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/cpp-rvo-and-rust-move-semantics"}]},{"tag":"ç¼–ç¨‹è¯­è¨€","slug":"ç¼–ç¨‹è¯­è¨€","path":"/tags/ç¼–ç¨‹è¯­è¨€","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/cpp-rvo-and-rust-move-semantics"}]},{"tag":"Windows","slug":"windows","path":"/tags/windows","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"}]},{"tag":"macOS","slug":"macos","path":"/tags/macos","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"}]},{"tag":"å¯æ‰§è¡Œæ–‡ä»¶","slug":"å¯æ‰§è¡Œæ–‡ä»¶","path":"/tags/å¯æ‰§è¡Œæ–‡ä»¶","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"}]},{"tag":"LoRA","slug":"lora","path":"/tags/lora","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"å‚æ•°é«˜æ•ˆå¾®è°ƒ","slug":"å‚æ•°é«˜æ•ˆå¾®è°ƒ","path":"/tags/å‚æ•°é«˜æ•ˆå¾®è°ƒ","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"æ¨¡å‹è®­ç»ƒ","slug":"æ¨¡å‹è®­ç»ƒ","path":"/tags/æ¨¡å‹è®­ç»ƒ","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"åå‘ä¼ æ’­","slug":"åå‘ä¼ æ’­","path":"/tags/åå‘ä¼ æ’­","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"}]},{"tag":"è‡ªåŠ¨å¾®åˆ†","slug":"è‡ªåŠ¨å¾®åˆ†","path":"/tags/è‡ªåŠ¨å¾®åˆ†","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"}]},{"tag":"GoLang","slug":"golang","path":"/tags/golang","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-new-and-memory-management"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-scheduler-preemption"}]},{"tag":"Memory Management","slug":"memory-management","path":"/tags/memory-management","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-new-and-memory-management"}]},{"tag":"Deep Learning","slug":"deep-learning","path":"/tags/deep-learning","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-model-save-and-load"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/resnet-math-and-gradient-vanishing"}]},{"tag":"Model Management","slug":"model-management","path":"/tags/model-management","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-model-save-and-load"}]},{"tag":"Neural Networks","slug":"neural-networks","path":"/tags/neural-networks","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/resnet-math-and-gradient-vanishing"}]},{"tag":"ResNet","slug":"resnet","path":"/tags/resnet","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/resnet-math-and-gradient-vanishing"}]},{"tag":"Mathematics","slug":"mathematics","path":"/tags/mathematics","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/resnet-math-and-gradient-vanishing"}]},{"tag":"åè®®","slug":"åè®®","path":"/tags/åè®®","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"}]},{"tag":"IoT","slug":"iot","path":"/tags/iot","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"}]},{"tag":"ç‰©è”ç½‘","slug":"ç‰©è”ç½‘","path":"/tags/ç‰©è”ç½‘","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"}]},{"tag":"æ¶ˆæ¯é˜Ÿåˆ—","slug":"æ¶ˆæ¯é˜Ÿåˆ—","path":"/tags/æ¶ˆæ¯é˜Ÿåˆ—","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"}]},{"tag":"Stable Diffusion","slug":"stable-diffusion","path":"/tags/stable-diffusion","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},{"tag":"Concurrency","slug":"concurrency","path":"/tags/concurrency","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-scheduler-preemption"}]},{"tag":"Scheduler","slug":"scheduler","path":"/tags/scheduler","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-scheduler-preemption"}]},{"tag":"Goroutine","slug":"goroutine","path":"/tags/goroutine","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/golang-scheduler-preemption"}]},{"tag":"çº¿æ€§ä»£æ•°","slug":"çº¿æ€§ä»£æ•°","path":"/tags/çº¿æ€§ä»£æ•°","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-1"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-2"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-3"}]},{"tag":"ç¾¤è®º","slug":"ç¾¤è®º","path":"/tags/ç¾¤è®º","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-1"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-2"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/products-for-vector-in-space-3"}]},{"tag":"test","slug":"test","path":"/tags/test","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page1"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage1"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3/subpage34"},{"postType":"testwiki","postPagePath":"/testwiki/page1/subpage1"}]},{"tag":"wiki","slug":"wiki","path":"/tags/wiki","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page1"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage1"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3/subpage34"},{"postType":"testwiki","postPagePath":"/testwiki/page1/subpage1"}]},{"tag":"page1","slug":"page1","path":"/tags/page1","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page1"},{"postType":"testwiki","postPagePath":"/testwiki/page1/subpage1"}]},{"tag":"page3","slug":"page3","path":"/tags/page3","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage1"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage3"}]},{"tag":"subpage1","slug":"subpage1","path":"/tags/subpage1","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage1"},{"postType":"testwiki","postPagePath":"/testwiki/page1/subpage1"}]},{"tag":"subpage2","slug":"subpage2","path":"/tags/subpage2","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage2"}]},{"tag":"subpage3","slug":"subpage3","path":"/tags/subpage3","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page3/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3/subpage34"}]},{"tag":"page2","slug":"page2","path":"/tags/page2","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage2"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3"},{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3/subpage34"}]},{"tag":"subpage34","slug":"subpage34","path":"/tags/subpage34","postSlugs":[{"postType":"testwiki","postPagePath":"/testwiki/page2/subpage3/subpage34"}]}],"selectedTagInfo":{"tag":"å­¦ä¹ ç¬”è®°","slug":"å­¦ä¹ ç¬”è®°","path":"/tags/å­¦ä¹ ç¬”è®°","postSlugs":[{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/deep-learning-model-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/opencv-coordinate-system-conventions"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/executable-file-formats"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/lora-matrix-initialization-strategy"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/pytorch-backpropagation-mechanism"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/mqtt-protocol-principles-applications"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-unet-structure"},{"postType":"learn_from_ai","postPagePath":"/learn_from_ai/stable-diffusion-lora-training-methods"}]},"posts":[{"pathMapping":{"filePath":"public/content/learn_from_ai/2025-03-29-stable-diffusion-lora-training-methods.md","pagePath":"/learn_from_ai/stable-diffusion-lora-training-methods","slug":"stable-diffusion-lora-training-methods"},"meta":{"content":"\n\u003e æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ PyTorch ä»é›¶å¼€å§‹ç¼–å†™ Stable Diffusion LoRA è®­ç»ƒè„šæœ¬ï¼ŒåŒ…æ‹¬æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹ä¿®æ”¹ã€è®­ç»ƒå¾ªç¯ã€å‚æ•°ä¿å­˜ä¸åŠ è½½ç­‰å…³é”®æ­¥éª¤ã€‚ç‰¹åˆ«å¼ºè°ƒäº† LoRA å±‚çš„æ‰‹åŠ¨å®ç°å’Œåœ¨ UNet çš„ Cross-Attention å±‚æ³¨å…¥ LoRA çš„åŸå› ï¼Œä»¥åŠåœ¨å…¶ä»–å±‚åº”ç”¨ LoRA çš„å¯èƒ½æ€§å’Œæ³¨æ„äº‹é¡¹ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº†ä»£ç ç¤ºä¾‹å’Œå‚æ•°æ•ˆç‡çš„è®¨è®ºï¼Œå¸®åŠ©è¯»è€…æ·±å…¥ç†è§£ LoRA åœ¨ Stable Diffusion å¾®è°ƒä¸­çš„åº”ç”¨ã€‚\n\n## Q: è®­ç»ƒä¸€ä¸ª Stable Diffusion çš„ LoRA æ¨¡å‹ï¼Œè¦æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å¥½çš„ï¼Œç”¨æˆ·é—®çš„æ˜¯è®­ç»ƒ Stable Diffusion çš„ LoRA æ¨¡å‹éœ€è¦å“ªäº›æ­¥éª¤ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦å›å¿†ä¸€ä¸‹ LoRA çš„åŸºæœ¬æ¦‚å¿µã€‚LoRA æ˜¯ä½ç§©é€‚åº”ï¼Œä¸€ç§ç”¨äºå¾®è°ƒå¤§æ¨¡å‹çš„æŠ€æœ¯ï¼Œå¯ä»¥åœ¨ä¿æŒåŸæ¨¡å‹å‚æ•°ä¸å˜çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ·»åŠ é¢å¤–çš„ä½ç§©çŸ©é˜µæ¥è°ƒæ•´æ¨¡å‹è¾“å‡ºã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯èŠ‚çœè®¡ç®—èµ„æºå’Œå­˜å‚¨ç©ºé—´ï¼Œå› ä¸ºä¸éœ€è¦è®­ç»ƒæ•´ä¸ªæ¨¡å‹ã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œç”¨æˆ·å¯èƒ½å·²ç»äº†è§£ Stable Diffusion çš„åŸºæœ¬åŸç†ï¼Œä½†éœ€è¦å…·ä½“æ­¥éª¤ã€‚æˆ‘éœ€è¦åˆ†è§£è®­ç»ƒæµç¨‹ï¼Œä»å‡†å¤‡æ•°æ®åˆ°æœ€ç»ˆæ¨ç†ã€‚é¦–å…ˆï¼Œæ•°æ®å‡†å¤‡æ˜¯å…³é”®ã€‚ç”¨æˆ·éœ€è¦æ”¶é›†é«˜è´¨é‡å›¾ç‰‡ï¼Œå¯èƒ½è¿˜éœ€è¦æ ‡æ³¨ã€‚è¿™é‡Œéœ€è¦æ³¨æ„å›¾ç‰‡çš„å¤šæ ·æ€§å’Œæ•°é‡ï¼Œä»¥åŠæ­£ç¡®çš„æ ‡æ³¨æ ¼å¼ï¼Œæ¯”å¦‚ TXT æ–‡ä»¶ã€‚\n\u003e\n\u003e ç„¶åæ˜¯ç¯å¢ƒé…ç½®ã€‚ç”¨æˆ·å¯èƒ½éœ€è¦å®‰è£… PyTorchã€Diffusers åº“ã€Transformers åº“ï¼Œè¿˜æœ‰ LoRA ç›¸å…³çš„åº“ï¼Œæ¯”å¦‚ peftã€‚å¦‚æœç”¨æˆ·ä¸ç†Ÿæ‚‰è¿™äº›å·¥å…·ï¼Œå¯èƒ½éœ€è¦ç»™å‡ºå®‰è£…å‘½ä»¤ç¤ºä¾‹ï¼Œæ¯”å¦‚ pip installã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥æ˜¯æ¨¡å‹å‡†å¤‡ï¼Œé€‰æ‹©é€‚åˆçš„ Stable Diffusion ç‰ˆæœ¬ï¼Œå¦‚ SD 1.5 æˆ– 2.1ã€‚éœ€è¦ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹ï¼Œå¹¶é…ç½® LoRA å‚æ•°ï¼Œæ¯”å¦‚ rank å€¼ã€‚è¿™é‡Œå¯èƒ½éœ€è¦è§£é‡Š rank çš„æ„ä¹‰ï¼Œå¦‚ä½•é€‰æ‹©åˆé€‚çš„å€¼ï¼Œæ¯”å¦‚ 8 åˆ° 64 ä¹‹é—´ï¼Œæ ¹æ®ä»»åŠ¡å¤æ‚åº¦è°ƒæ•´ã€‚\n\u003e\n\u003e ç„¶åæ˜¯è®­ç»ƒé…ç½®ï¼Œè®¾ç½®å­¦ä¹ ç‡ã€æ‰¹æ¬¡å¤§å°ã€epoch æ•°ç­‰è¶…å‚æ•°ã€‚éœ€è¦æé†’ç”¨æˆ·å­¦ä¹ ç‡ä¸å®œè¿‡é«˜ï¼Œä½¿ç”¨é¢„çƒ­å’Œè¡°å‡ç­–ç•¥ã€‚å¯èƒ½è¿˜è¦æåˆ°ä¼˜åŒ–å™¨çš„é€‰æ‹©ï¼Œæ¯”å¦‚ AdamWï¼Œä»¥åŠæ··åˆç²¾åº¦è®­ç»ƒä»¥èŠ‚çœæ˜¾å­˜ã€‚\n\u003e\n\u003e è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦ç›‘æ§ loss å’Œç”Ÿæˆæ•ˆæœï¼Œè°ƒæ•´å‚æ•°ã€‚ä¿å­˜æ£€æŸ¥ç‚¹ä¹Ÿæ˜¯é‡è¦çš„ï¼Œé˜²æ­¢è®­ç»ƒä¸­æ–­ã€‚è¿™éƒ¨åˆ†éœ€è¦å¼ºè°ƒè€å¿ƒå’Œå¤šæ¬¡å®éªŒï¼Œå› ä¸ºå¾®è°ƒå¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•ã€‚\n\u003e\n\u003e è®­ç»ƒå®Œæˆåï¼Œåˆå¹¶ LoRA æƒé‡åˆ°åŸæ¨¡å‹ï¼Œæˆ–è€…ç›´æ¥åŠ è½½è¿›è¡Œæ¨ç†ã€‚éœ€è¦ç»™å‡ºç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•åŠ è½½å¹¶ä½¿ç”¨ LoRA æ¨¡å‹ç”Ÿæˆå›¾ç‰‡ã€‚\n\u003e\n\u003e æœ€åï¼Œå¸¸è§é—®é¢˜éƒ¨åˆ†è¦è€ƒè™‘ç”¨æˆ·å¯èƒ½é‡åˆ°çš„å›°éš¾ï¼Œæ¯”å¦‚éœ€è¦å¤šå°‘æ•°æ®ï¼Œæ˜¯å¦éœ€è¦é«˜è´¨é‡æ ‡æ³¨ï¼Œè®­ç»ƒæ—¶é—´ï¼Œä»¥åŠæ˜¯å¦éœ€è¦é«˜ç«¯ GPUã€‚è¿™äº›æ˜¯å®é™…è®­ç»ƒä¸­å¸¸è§çš„é—®é¢˜ï¼Œæå‰è§£ç­”èƒ½å¸®åŠ©ç”¨æˆ·æ›´å¥½å‡†å¤‡ã€‚\n\u003e\n\u003e ç”¨æˆ·å¯èƒ½çš„æ·±å±‚éœ€æ±‚æ˜¯å¸Œæœ›æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ­¥éª¤æŒ‡å—ï¼Œé¿å…é—æ¼å…³é”®ç¯èŠ‚ã€‚å¯èƒ½ä»–ä»¬ä¹‹å‰å°è¯•è¿‡ä½†é‡åˆ°é—®é¢˜ï¼Œæˆ–è€…åˆšå…¥é—¨éœ€è¦ä»é›¶å¼€å§‹çš„æŒ‡å¯¼ã€‚å› æ­¤ï¼Œæ­¥éª¤è¦è¯¦ç»†ï¼Œä½†ä¸è¿‡äºæŠ€æœ¯åŒ–ï¼Œä¿æŒæ˜“æ‡‚ã€‚åŒæ—¶ï¼Œå¼ºè°ƒæ•°æ®è´¨é‡å’Œå‚æ•°è°ƒæ•´çš„é‡è¦æ€§ï¼Œå› ä¸ºè¿™æ˜¯å½±å“ç»“æœçš„å…³é”®å› ç´ ã€‚\n\nè®­ç»ƒ Stable Diffusion çš„ LoRAï¼ˆLow-Rank Adaptationï¼‰æ¨¡å‹æ˜¯ä¸€ç§é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ï¼Œå¯ä»¥åœ¨ä¿ç•™åŸæ¨¡å‹å¤§éƒ¨åˆ†å‚æ•°çš„åŒæ—¶ï¼Œé€šè¿‡ä½ç§©çŸ©é˜µè°ƒæ•´æ¨¡å‹è¡Œä¸ºã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„æ­¥éª¤æŒ‡å—ï¼š\n\n---\n\n### **1. æ•°æ®å‡†å¤‡**\n\n- **æ”¶é›†æ•°æ®é›†**:\n  - éœ€è¦ä¸ç›®æ ‡é£æ ¼/ä¸»é¢˜ç›¸å…³çš„é«˜è´¨é‡å›¾ç‰‡ï¼ˆå»ºè®®è‡³å°‘ **100-200 å¼ **ï¼Œæ•°é‡è¶Šå¤šæ•ˆæœè¶Šå¥½ï¼‰ã€‚\n  - å›¾ç‰‡æ ¼å¼é€šå¸¸ä¸º `.jpg` æˆ– `.png`ï¼Œåˆ†è¾¨ç‡å»ºè®®ä¸ Stable Diffusion çš„åŸºç¡€æ¨¡å‹å¯¹é½ï¼ˆå¦‚ 512x512ï¼‰ã€‚\n- **æ ‡æ³¨æ•°æ®**:\n  - æ¯å¼ å›¾ç‰‡éœ€æ­é…æ–‡æœ¬æè¿°ï¼ˆ`.txt` æ–‡ä»¶ï¼‰ï¼Œæè¿°éœ€æ¸…æ™°ç®€æ´ï¼ˆå¦‚ `\"a photo of a [keyword], [style], [details]\"`ï¼‰ã€‚\n  - è‹¥è®­ç»ƒç‰¹å®šå¯¹è±¡ï¼ˆå¦‚äººç‰©ã€ç”»é£ï¼‰ï¼Œç¡®ä¿æè¿°ä¸­**ç»Ÿä¸€ä½¿ç”¨è§¦å‘è¯**ï¼ˆå¦‚ `\"my_cat_v1\"`ï¼‰ã€‚\n\n---\n\n### **2. ç¯å¢ƒé…ç½®**\n\n- **å®‰è£…ä¾èµ–åº“**:\n\n  ```bash\n  # åŸºç¡€ç¯å¢ƒ\n  pip install torch torchvision --extra-index-url https://download.pytorch.org/whl/cu117\n  pip install diffusers transformers accelerate peft\n  pip install datasets huggingface_hub\n  # å¯é€‰ï¼šxformers ä¼˜åŒ–ï¼ˆAå¡éœ€è°ƒæ•´ï¼‰\n  pip install xformers\n  ```\n\n- **ç¡¬ä»¶è¦æ±‚**:\n  - GPU æ˜¾å­˜è‡³å°‘ **8GB**ï¼ˆå¦‚ RTX 3060/4090ï¼‰ï¼Œ24GB å¯æ”¯æŒæ›´å¤§æ‰¹æ¬¡ã€‚\n  - ä½¿ç”¨ `accelerate` åº“é…ç½®åˆ†å¸ƒå¼è®­ç»ƒï¼ˆå¯é€‰ï¼‰ã€‚\n\n---\n\n### **3. æ¨¡å‹å‡†å¤‡**\n\n- **é€‰æ‹©åŸºç¡€æ¨¡å‹**:\n\n  - å¸¸ç”¨æ¨¡å‹ï¼š`runwayml/stable-diffusion-v1-5`ã€`stabilityai/stable-diffusion-2-1`ã€‚\n  - ä» Hugging Face ä¸‹è½½å¹¶ç¼“å­˜æ¨¡å‹ï¼š\n    ```python\n    from diffusers import StableDiffusionPipeline\n    pipeline = StableDiffusionPipeline.from_pretrained(\"runwayml/stable-diffusion-v1-5\")\n    ```\n\n- **é…ç½® LoRA å‚æ•°**:\n  - **Rankï¼ˆç§©ï¼‰**: æ§åˆ¶ä½ç§©çŸ©é˜µçš„ç»´åº¦ï¼ˆå…¸å‹å€¼ï¼š4-64ï¼Œè¶Šå¤§æ‹Ÿåˆèƒ½åŠ›è¶Šå¼ºï¼Œä½†å¯èƒ½è¿‡æ‹Ÿåˆï¼‰ã€‚\n  - åœ¨è®­ç»ƒè„šæœ¬ä¸­è®¾ç½® LoRA å±‚ï¼ˆé€šå¸¸ä½œç”¨äº Cross-Attention æ¨¡å—ï¼‰ï¼š\n    ```python\n    from peft import LoraConfig\n    lora_config = LoraConfig(\n        r=8,                # Rank å€¼\n        target_modules=[\"to_k\", \"to_q\", \"to_v\", \"to_out.0\"],  # æ³¨å…¥çš„æ¨¡å—\n        init_lora_weights=\"gaussian\",\n    )\n    ```\n\n---\n\n### **4. è®­ç»ƒé…ç½®**\n\n- **è¶…å‚æ•°è®¾ç½®**:\n\n  ```yaml\n  batch_size: 1-4ï¼ˆæ ¹æ®æ˜¾å­˜è°ƒæ•´ï¼‰\n  learning_rate: 1e-5 åˆ° 1e-4ï¼ˆå¸¸ç”¨ 1e-4ï¼‰\n  num_epochs: 50-200ï¼ˆè§‚å¯Ÿ loss è°ƒæ•´ï¼‰\n  optimizer: AdamWï¼ˆå¸¦æƒé‡è¡°å‡ï¼‰\n  mixed_precision: fp16ï¼ˆèŠ‚çœæ˜¾å­˜ï¼‰\n  gradient_checkpointing: Trueï¼ˆè¿›ä¸€æ­¥çœæ˜¾å­˜ï¼‰\n  ```\n\n- **è®­ç»ƒè„šæœ¬**:\n  - ä½¿ç”¨ `diffusers` çš„ `train_text_to_image.py` æˆ–è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯ã€‚\n  - å…³é”®ä»£ç ç‰‡æ®µï¼š\n    ```python\n    from diffusers import DDPMScheduler\n    scheduler = DDPMScheduler.from_pretrained(model_id, subfolder=\"scheduler\")\n    trainer = StableDiffusionTrainer(\n        model=pipeline.unet,\n        args=training_args,\n        data_collator=collate_fn,\n        train_dataset=dataset,\n        scheduler=scheduler,\n    )\n    trainer.add_callback(LoRACallback(lora_config))  # æ³¨å…¥ LoRA\n    ```\n\n---\n\n### **5. è®­ç»ƒè¿‡ç¨‹**\n\n- **ç›‘æ§ä¸è°ƒè¯•**:\n\n  - è§‚å¯Ÿ Loss æ›²çº¿ï¼ˆç†æƒ³æƒ…å†µåº”ç¨³æ­¥ä¸‹é™åè¶‹äºå¹³ç¨³ï¼‰ã€‚\n  - å®šæœŸç”Ÿæˆæµ‹è¯•å›¾ç‰‡ï¼ˆå¦‚æ¯ 100 æ­¥ï¼‰æ£€æŸ¥è¿‡æ‹Ÿåˆ/æ¬ æ‹Ÿåˆã€‚\n  - è°ƒæ•´ç­–ç•¥ï¼š\n    - Loss ä¸é™ï¼šæé«˜å­¦ä¹ ç‡ã€å¢åŠ  Rank å€¼ã€‚\n    - Loss éœ‡è¡ï¼šé™ä½å­¦ä¹ ç‡ã€å¢å¤§æ‰¹æ¬¡å¤§å°ã€‚\n\n- **ä¿å­˜æ£€æŸ¥ç‚¹**:\n  - æ¯éš”ä¸€å®šæ­¥æ•°ä¿å­˜ä¸­é—´æ¨¡å‹ï¼ˆå¦‚ `./output/checkpoint-500`ï¼‰ã€‚\n  - æœ€ç»ˆæ¨¡å‹ä¿å­˜ä¸º `.safetensors` æˆ–åˆå¹¶åˆ°åŸæ¨¡å‹ã€‚\n\n---\n\n### **6. æ¨ç†ä¸éƒ¨ç½²**\n\n- **åŠ è½½ LoRA æƒé‡**:\n\n  ```python\n  from diffusers import StableDiffusionPipeline\n  pipeline = StableDiffusionPipeline.from_pretrained(\"runwayml/stable-diffusion-v1-5\")\n  pipeline.unet.load_attn_procs(\"path/to/lora_weights.safetensors\")\n  ```\n\n- **ç”Ÿæˆå›¾ç‰‡**:\n  ```python\n  prompt = \"A photo of my_cat_v1 sitting on a sofa, best quality\"\n  image = pipeline(prompt, num_inference_steps=50).images[0]\n  image.save(\"output.png\")\n  ```\n\n---\n\n### **å¸¸è§é—®é¢˜**\n\n- **Q**: éœ€è¦å¤šå°‘æ•°æ®ï¼Ÿ\n\n  - **A**: ç®€å•é£æ ¼/ç‰©ä½“çº¦ 100 å¼ ï¼Œå¤æ‚æ¦‚å¿µéœ€ 500+ å¼ ã€‚\n\n- **Q**: è®­ç»ƒæ—¶é—´å¤šä¹…ï¼Ÿ\n\n  - **A**: å• GPU çº¦ 1-6 å°æ—¶ï¼ˆå–å†³äºæ•°æ®é‡å’Œå‚æ•°ï¼‰ã€‚\n\n- **Q**: èƒ½å¦ç”¨ Colab å…è´¹ç‰ˆï¼Ÿ\n  - **A**: å¯ä»¥ï¼Œä½†éœ€å¯ç”¨ `fp16` å’Œæ¢¯åº¦æ£€æŸ¥ç‚¹ï¼Œæ‰¹æ¬¡è®¾ä¸º 1ã€‚\n\n---\n\né€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å¯ä»¥é«˜æ•ˆåœ°è®­ç»ƒå‡ºé’ˆå¯¹ç‰¹å®šä»»åŠ¡çš„ LoRA æ¨¡å‹ï¼Œæ˜¾è‘—é™ä½èµ„æºæ¶ˆè€—åŒæ—¶ä¿æŒç”Ÿæˆè´¨é‡ã€‚\n\n\u003e [!info] å…³äºæ•°æ®é‡çš„ç–‘é—®\n\u003e\n\u003e \u003e [!query]\n\u003e \u003e ä½ ç¡®å®šè®­ç»ƒä¸€ä¸ª LoRA éœ€è¦ 100 å¤šå¼ å›¾å—ï¼Ÿ\n\u003e\n\u003e Reasoning è¿‡ç¨‹çœç•¥\n\u003e\n\u003e \u003e [!ai]\n\u003e \u003e è®­ç»ƒ LoRA æ¨¡å‹æ‰€éœ€çš„å›¾ç‰‡æ•°é‡å¹¶éå›ºå®šï¼Œå…·ä½“å–å†³äºè®­ç»ƒç›®æ ‡ã€æ•°æ®è´¨é‡å’Œå‚æ•°è®¾ç½®ã€‚æ ¹æ®å¤šä¸ªæ¥æºçš„å»ºè®®ï¼Œæœ€ä½å¯æ¥å—æ•°é‡ä¸º 10-20 å¼ é«˜è´¨é‡å›¾ç‰‡ï¼Œè€Œå¤æ‚åœºæ™¯æˆ–é«˜ç²¾åº¦éœ€æ±‚å¯èƒ½éœ€è¦ 50 å¼ ä»¥ä¸Šã€‚\n\u003e \u003e ...\n\n## Q: æˆ‘æœ‰ Python ä¸ PyTorch åŸºç¡€ã€‚éœ€è¦è‡ªå·±å†™ä¸€ä¸ª LoRA è®­ç»ƒè„šæœ¬ï¼Œåº”å¦‚ä½•å†™ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·ä¹‹å‰é—®è¿‡å¦‚ä½•è®­ç»ƒ Stable Diffusion çš„ LoRA æ¨¡å‹ï¼Œç°åœ¨ä»–æœ‰äº† Python å’Œ PyTorch åŸºç¡€ï¼Œæƒ³è‡ªå·±å†™ä¸€ä¸ª LoRA è®­ç»ƒè„šæœ¬ã€‚æˆ‘éœ€è¦ä»”ç»†åˆ†æä»–çš„éœ€æ±‚ã€‚é¦–å…ˆï¼Œä»–å¯èƒ½å·²ç»äº†è§£äº† LoRA çš„åŸºæœ¬æ­¥éª¤ï¼Œç°åœ¨éœ€è¦å…·ä½“çš„ä»£ç æŒ‡å¯¼å’Œå®ç°ç»†èŠ‚ã€‚ç”¨æˆ·å¯èƒ½å¸Œæœ›ä»é›¶å¼€å§‹æ„å»ºè®­ç»ƒè„šæœ¬ï¼Œè€Œä¸ä»…ä»…æ˜¯ä½¿ç”¨ç°æœ‰çš„åº“ï¼Œæ¯”å¦‚ diffusers æˆ–è€… peftã€‚ä¸è¿‡ï¼Œä¹Ÿæœ‰å¯èƒ½ä»–å¸Œæœ›ç»“åˆè¿™äº›åº“æ¥ç®€åŒ–æµç¨‹ã€‚éœ€è¦æ˜ç¡®ä»–çš„æ„å›¾ã€‚\n\u003e\n\u003e ç”¨æˆ·æåˆ°â€œè‡ªå·±å†™ä¸€ä¸ªâ€ï¼Œå¯èƒ½æ„å‘³ç€ä»–å¸Œæœ›ç†è§£åº•å±‚å®ç°ï¼Œè€Œä¸ä»…ä»…æ˜¯è°ƒç”¨é«˜çº§ APIã€‚ä¸è¿‡ï¼ŒLoRA çš„å®ç°æ¶‰åŠåˆ°ä¿®æ”¹æ¨¡å‹çš„æ³¨æ„åŠ›å±‚ï¼Œè¿™éƒ¨åˆ†å¦‚æœå®Œå…¨ä»é›¶å¼€å§‹å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ã€‚éœ€è¦å¹³è¡¡ä»£ç çš„å¤æ‚æ€§å’Œå¯ç†è§£æ€§ã€‚å¯èƒ½éœ€è¦ç»“åˆ PyTorch çš„åŸºç¡€æ“ä½œå’Œç°æœ‰çš„åº“ï¼Œæ¯”å¦‚ huggingface çš„ transformers æˆ– diffusersï¼Œæ¥æ„å»ºè„šæœ¬ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œç¡®å®šç”¨æˆ·çš„åŸºç¡€ï¼šæœ‰ Python å’Œ PyTorch åŸºç¡€ï¼Œå¯èƒ½å¯¹æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒæœ‰åŸºæœ¬äº†è§£ï¼Œä½†å¯¹ LoRA çš„å…·ä½“å®ç°ä¸ç†Ÿæ‚‰ã€‚éœ€è¦åˆ†æ­¥éª¤è§£é‡Šå¦‚ä½•å°† LoRA åº”ç”¨åˆ° Stable Diffusion çš„ UNet æ¨¡å‹ä¸­ï¼Œç‰¹åˆ«æ˜¯æ³¨æ„åŠ›å±‚éƒ¨åˆ†ã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œå¯èƒ½éœ€è¦è€ƒè™‘ä»¥ä¸‹å‡ ç‚¹ï¼š\n\u003e\n\u003e 1. æ•°æ®å‡†å¤‡éƒ¨åˆ†ï¼šç”¨æˆ·éœ€è¦åŠ è½½æ•°æ®é›†ï¼Œå¯èƒ½å·²ç»å‡†å¤‡å¥½äº†å›¾ç‰‡å’Œå¯¹åº”çš„æ–‡æœ¬æè¿°ï¼Œéœ€è¦å°†å…¶è½¬æ¢ä¸ºæ¨¡å‹å¯æ¥å—çš„è¾“å…¥æ ¼å¼ï¼Œæ¯”å¦‚ tokenized çš„æ–‡æœ¬å’Œå›¾åƒç¼–ç åçš„æ½œåœ¨è¡¨ç¤ºã€‚\n\u003e\n\u003e 2. æ¨¡å‹åŠ è½½ï¼šéœ€è¦åŠ è½½é¢„è®­ç»ƒçš„ Stable Diffusion æ¨¡å‹ï¼Œç‰¹åˆ«æ˜¯ UNet éƒ¨åˆ†ï¼Œå¹¶ä¿®æ”¹å…¶æ³¨æ„åŠ›å±‚ä»¥åŠ å…¥ LoRA å‚æ•°ã€‚\n\u003e\n\u003e 3. LoRA å±‚çš„å®ç°ï¼šå¦‚ä½•åœ¨ PyTorch ä¸­ä¸ºçº¿æ€§å±‚æ·»åŠ  LoRA é€‚é…å™¨ï¼Œå¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å—ï¼Œå°†åŸå§‹æƒé‡å†»ç»“ï¼Œå¹¶æ·»åŠ ä½ç§©çŸ©é˜µ A å’Œ Bã€‚\n\u003e\n\u003e 4. è®­ç»ƒå¾ªç¯çš„è®¾ç½®ï¼šåŒ…æ‹¬æŸå¤±å‡½æ•°ï¼ˆå¦‚ MSE æŸå¤±ï¼‰ã€ä¼˜åŒ–å™¨ï¼ˆå¦‚ AdamWï¼‰ã€å­¦ä¹ ç‡è°ƒåº¦ç­‰ã€‚\n\u003e\n\u003e 5. å‚æ•°æ›´æ–°ï¼šç¡®ä¿åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­åªæ›´æ–° LoRA çš„å‚æ•°ï¼Œè€ŒåŸå§‹æ¨¡å‹å‚æ•°ä¿æŒå†»ç»“ã€‚\n\u003e\n\u003e 6. ä¿å­˜å’ŒåŠ è½½ LoRA æƒé‡ï¼šè®­ç»ƒå®Œæˆåå¦‚ä½•æå– LoRA çš„å‚æ•°ï¼Œå¹¶åœ¨æ¨ç†æ—¶åŠ è½½å®ƒä»¬ã€‚\n\u003e\n\u003e å¯èƒ½è¿˜éœ€è¦è€ƒè™‘æ··åˆç²¾åº¦è®­ç»ƒã€æ¢¯åº¦æ£€æŸ¥ç‚¹ç­‰ä¼˜åŒ–æŠ€æœ¯ï¼Œä»¥èŠ‚çœæ˜¾å­˜ã€‚åŒæ—¶ï¼Œç”¨æˆ·å¯èƒ½åœ¨èµ„æºæœ‰é™çš„ç¯å¢ƒä¸‹è®­ç»ƒï¼Œæ¯”å¦‚ä½¿ç”¨ Colabï¼Œæ‰€ä»¥éœ€è¦ä»£ç å°½å¯èƒ½é«˜æ•ˆã€‚\n\u003e\n\u003e å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½åœ¨ä¹‹å‰çš„å›ç­”ä¸­å·²ç»çœ‹åˆ°äº†ä½¿ç”¨ peft åº“çš„ç¤ºä¾‹ï¼Œä½†ç°åœ¨ä»–å¸Œæœ›è‡ªå·±å®ç°ï¼Œæ‰€ä»¥éœ€è¦é¿å…ç›´æ¥ä½¿ç”¨ peftï¼Œè€Œæ˜¯æ‰‹åŠ¨æ·»åŠ  LoRA å±‚ã€‚è¿™éœ€è¦è¯¦ç»†è§£é‡Š LoRA çš„åŸç†ï¼Œæ¯”å¦‚ä½ç§©åˆ†è§£ï¼Œå¦‚ä½•å°†åŸå§‹æƒé‡ W æ›¿æ¢ä¸º W + BAï¼Œå…¶ä¸­ A å’Œ B æ˜¯ä½ç§©çŸ©é˜µã€‚\n\u003e\n\u003e éœ€è¦ç¡®ä¿ä»£ç ç¤ºä¾‹æ¸…æ™°ï¼Œæ­¥éª¤æ˜ç¡®ï¼Œå¹¶ä¸”æŒ‡å‡ºå…³é”®éƒ¨åˆ†ï¼Œæ¯”å¦‚å¦‚ä½•ä¿®æ”¹æ³¨æ„åŠ›å±‚çš„çº¿æ€§å±‚ï¼Œå¦‚ä½•å†»ç»“åŸå§‹å‚æ•°ï¼Œå¦‚ä½•åªè®­ç»ƒ LoRA çš„å‚æ•°ã€‚åŒæ—¶ï¼Œå¯èƒ½éœ€è¦ç»™å‡ºæ•°æ®é¢„å¤„ç†çš„å…·ä½“ç¤ºä¾‹ï¼Œæ¯”å¦‚ä½¿ç”¨ Autoencoder å°†å›¾åƒç¼–ç ä¸ºæ½œåœ¨ç©ºé—´ï¼Œä»¥åŠä½¿ç”¨ CLIP æ–‡æœ¬ç¼–ç å™¨å¤„ç†æ–‡æœ¬è¾“å…¥ã€‚\n\u003e\n\u003e å¯èƒ½è¿˜éœ€è¦å¤„ç†å­¦ä¹ ç‡çš„è®¾ç½®ï¼Œå› ä¸ºå¾®è°ƒé€šå¸¸ä½¿ç”¨è¾ƒä½çš„å­¦ä¹ ç‡ï¼Œä»¥åŠå¦‚ä½•ç›‘æ§è®­ç»ƒè¿‡ç¨‹ï¼Œæ¯”å¦‚æŸå¤±å€¼çš„ä¸‹é™å’Œç”Ÿæˆæ ·æœ¬çš„è´¨é‡æ£€æŸ¥ã€‚\n\u003e\n\u003e æœ€åï¼Œéœ€è¦æé†’ç”¨æˆ·æ³¨æ„å¸¸è§é—®é¢˜ï¼Œæ¯”å¦‚è¿‡æ‹Ÿåˆã€è®­ç»ƒæ—¶é—´ã€è¶…å‚æ•°è°ƒæ•´ç­‰ï¼Œå¹¶æä¾›è°ƒè¯•å»ºè®®ã€‚å¯èƒ½è¿˜éœ€è¦æ¯”è¾ƒæ‰‹åŠ¨å®ç°å’Œä½¿ç”¨ç°æœ‰åº“çš„ä¼˜ç¼ºç‚¹ï¼Œå¸®åŠ©ç”¨æˆ·åšå‡ºé€‰æ‹©ã€‚\n\u003e\n\u003e æ€»ç»“ï¼Œå›ç­”éœ€è¦åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š\n\u003e\n\u003e 1. LoRA å±‚çš„ PyTorch å®ç°\n\u003e\n\u003e 2. ä¿®æ”¹ Stable Diffusion çš„ UNet æ¨¡å‹ä»¥åŠ å…¥ LoRA\n\u003e\n\u003e 3. æ•°æ®é¢„å¤„ç†æµç¨‹\n\u003e\n\u003e 4. è®­ç»ƒå¾ªç¯çš„æ„å»º\n\u003e\n\u003e 5. å‚æ•°ä¿å­˜ä¸åŠ è½½\n\u003e\n\u003e 6. ç¤ºä¾‹ä»£ç å’Œå…³é”®è§£é‡Š\n\u003e\n\u003e 7. å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–å»ºè®®\n\u003e\n\u003e éœ€è¦ç¡®ä¿ä»£ç ç¤ºä¾‹æ­£ç¡®ï¼Œå¹¶ä¸”ç”¨æˆ·èƒ½å¤Ÿæ ¹æ®æ­¥éª¤é€æ­¥å®ç°ï¼ŒåŒæ—¶è§£é‡Šæ¯ä¸€æ­¥çš„ç›®çš„å’ŒåŸç†ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è€Œä¸ä»…ä»…æ˜¯å¤åˆ¶ä»£ç ã€‚\n\nä»¥ä¸‹æ˜¯åŸºäº PyTorch å®ç° Stable Diffusion LoRA è®­ç»ƒè„šæœ¬çš„å®Œæ•´æŒ‡å—ï¼Œä»åº•å±‚åŸç†åˆ°ä»£ç å®ç°é€æ­¥è§£æã€‚å‡è®¾ä½ å·²å‡†å¤‡å¥½æ•°æ®é›†ï¼ˆå›¾ç‰‡+æ–‡æœ¬æè¿°ï¼‰ï¼Œæˆ‘ä»¬å°†ä»¥ **æ‰‹åŠ¨å®ç° LoRA å±‚** ä¸ºæ ¸å¿ƒï¼Œä¸ä¾èµ– `peft` åº“ã€‚\n\n---\n\n### 1. **LoRA å±‚çš„åŸç†ä¸å®ç°**\n\nLoRA çš„æ ¸å¿ƒæ€æƒ³ï¼šåœ¨åŸå§‹æƒé‡çŸ©é˜µæ—å¢åŠ ä¸€ä¸ªä½ç§©çŸ©é˜µï¼Œåªè®­ç»ƒè¿™éƒ¨åˆ†å‚æ•°ã€‚\n\n```python\nimport torch\nimport torch.nn as nn\n\nclass LoRALayer(nn.Module):\n    def __init__(self, original_layer, rank=8, alpha=16):\n        super().__init__()\n        self.original = original_layer  # åŸå§‹çº¿æ€§å±‚ (e.g., nn.Linear)\n        self.original.requires_grad_(False)  # å†»ç»“åŸå§‹å‚æ•°\n\n        in_dim = original_layer.in_features\n        out_dim = original_layer.out_features\n        self.rank = rank\n        self.alpha = alpha\n\n        # åˆå§‹åŒ–ä½ç§©çŸ©é˜µ A å’Œ B\n        self.A = nn.Parameter(torch.randn(in_dim, rank))\n        self.B = nn.Parameter(torch.zeros(rank, out_dim))\n\n    def forward(self, x):\n        # åŸå§‹è¾“å‡º + ä½ç§©å¢é‡\n        orig_out = self.original(x)\n        lora_out = x @ self.A @ self.B  # [batch, out_dim]\n        return orig_out + self.alpha * lora_out\n```\n\n---\n\n### 2. **ä¿®æ”¹ Stable Diffusion çš„ UNet**\n\néœ€å°† LoRA æ³¨å…¥åˆ° UNet çš„ **Cross-Attention å±‚**ï¼ˆå…³é”®æ­¥éª¤ï¼‰ï¼š\n\n```python\nfrom diffusers import UNet2DConditionModel\n\ndef inject_lora(unet, rank=8, alpha=16):\n    # éå† UNet çš„æ‰€æœ‰æ³¨æ„åŠ›å±‚\n    for name, module in unet.named_modules():\n        if \"attn2\" in name and \"to_\" in name:  # å®šä½ Cross-Attention çš„ Q/K/V/Out å±‚\n            if isinstance(module, nn.Linear):\n                # æ›¿æ¢åŸå§‹ Linear å±‚ä¸º LoRA å±‚\n                lora_layer = LoRALayer(module, rank=rank, alpha=alpha)\n                # é€šè¿‡å­—ç¬¦ä¸²è·¯å¾„æ›¿æ¢æ¨¡å— (éœ€è¦è§£æå±‚çº§ç»“æ„)\n                parent = unet\n                parts = name.split('.')\n                for part in parts[:-1]:\n                    parent = getattr(parent, part)\n                setattr(parent, parts[-1], lora_layer)\n    return unet\n\n# åŠ è½½åŸå§‹ UNet å¹¶æ³¨å…¥ LoRA\nunet = UNet2DConditionModel.from_pretrained(\"runwayml/stable-diffusion-v1-5\", subfolder=\"unet\")\nunet = inject_lora(unet, rank=8)\n```\n\n---\n\n### 3. **æ•°æ®é¢„å¤„ç†**\n\nå°†å›¾ç‰‡å’Œæ–‡æœ¬è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥ï¼š\n\n```python\nfrom torchvision import transforms\nfrom transformers import CLIPTokenizer, CLIPTextModel\n\n# åŠ è½½ Stable Diffusion çš„æ–‡æœ¬ç¼–ç å™¨\ntokenizer = CLIPTokenizer.from_pretrained(\"openai/clip-vit-large-patch14\")\ntext_encoder = CLIPTextModel.from_pretrained(\"openai/clip-vit-large-patch14\")\n\n# å›¾åƒé¢„å¤„ç†ï¼ˆè½¬æ¢ä¸ºæ½œåœ¨ç©ºé—´ï¼‰\nvae = AutoencoderKL.from_pretrained(\"runwayml/stable-diffusion-v1-5\", subfolder=\"vae\")\ndef preprocess_image(image_path):\n    image = Image.open(image_path).convert(\"RGB\")\n    transform = transforms.Compose([\n        transforms.Resize(512),\n        transforms.CenterCrop(512),\n        transforms.ToTensor(),\n    ])\n    image = transform(image).unsqueeze(0)  # [1, 3, 512, 512]\n    with torch.no_grad():\n        latents = vae.encode(image).latent_dist.sample() * 0.18215  # [1, 4, 64, 64]\n    return latents\n\n# æ–‡æœ¬ç¼–ç \ndef encode_text(text):\n    inputs = tokenizer(text, return_tensors=\"pt\", padding=\"max_length\", max_length=77, truncation=True)\n    with torch.no_grad():\n        text_embeddings = text_encoder(inputs.input_ids)[0]  # [1, 77, 768]\n    return text_embeddings\n```\n\n---\n\n### 4. **è®­ç»ƒå¾ªç¯**\n\n```python\nimport torch.optim as optim\nfrom diffusers import DDPMScheduler\n\n# åˆå§‹åŒ–å™ªå£°è°ƒåº¦å™¨\nnoise_scheduler = DDPMScheduler(\n    num_train_timesteps=1000,\n    beta_start=0.0001,\n    beta_end=0.02,\n    beta_schedule=\"linear\"\n)\n\n# ä¼˜åŒ–å™¨ï¼ˆä»…è®­ç»ƒ LoRA å‚æ•°ï¼‰\noptimizer = optim.AdamW(\n    filter(lambda p: p.requires_grad, unet.parameters()),  # åªé€‰æ‹©å¯è®­ç»ƒå‚æ•°\n    lr=1e-4,\n    weight_decay=1e-4\n)\n\n# è®­ç»ƒå¾ªç¯\nfor epoch in range(num_epochs):\n    for batch in dataloader:\n        # åŠ è½½æ•°æ®\n        images, texts = batch\n        latents = preprocess_image(images)\n        text_embeds = encode_text(texts)\n\n        # æ·»åŠ å™ªå£°\n        noise = torch.randn_like(latents)\n        timesteps = torch.randint(0, noise_scheduler.num_train_timesteps, (latents.shape[0],))\n        noisy_latents = noise_scheduler.add_noise(latents, noise, timesteps)\n\n        # å‰å‘ä¼ æ’­\n        noise_pred = unet(noisy_latents, timesteps, text_embeds).sample\n\n        # è®¡ç®—æŸå¤±\n        loss = nn.functional.mse_loss(noise_pred, noise)\n\n        # åå‘ä¼ æ’­\n        optimizer.zero_grad()\n        loss.backward()\n        optimizer.step()\n\n    print(f\"Epoch {epoch}, Loss: {loss.item()}\")\n```\n\n---\n\n### 5. **ä¿å­˜ LoRA æƒé‡**\n\n```python\ndef save_lora_weights(unet, save_path):\n    lora_state_dict = {}\n    for name, module in unet.named_modules():\n        if isinstance(module, LoRALayer):\n            # ä¿å­˜ A å’Œ B çŸ©é˜µ\n            lora_state_dict[f\"{name}.A\"] = module.A\n            lora_state_dict[f\"{name}.B\"] = module.B\n    torch.save(lora_state_dict, save_path)\n\nsave_lora_weights(unet, \"lora_weights.pth\")\n```\n\n---\n\n### 6. **æ¨ç†æ—¶åŠ è½½ LoRA**\n\n```python\n# åŠ è½½åŸå§‹æ¨¡å‹\npipeline = StableDiffusionPipeline.from_pretrained(\"runwayml/stable-diffusion-v1-5\")\n\n# æ³¨å…¥ LoRA\ninject_lora(pipeline.unet, rank=8)\npipeline.unet.load_state_dict(torch.load(\"lora_weights.pth\"), strict=False)  # ä»…åŠ è½½ LoRA å‚æ•°\n\n# ç”Ÿæˆå›¾ç‰‡\nimage = pipeline(\"A photo of [your trigger word]\").images[0]\n```\n\n---\n\n### **å…³é”®æ³¨æ„äº‹é¡¹**\n\n1. **å‚æ•°å†»ç»“**ï¼šç¡®ä¿åŸå§‹æ¨¡å‹çš„å‚æ•°è¢«å†»ç»“ï¼Œåªè®­ç»ƒ LoRA çš„ `A` å’Œ `B` çŸ©é˜µã€‚\n2. **Rank é€‰æ‹©**ï¼šé€šå¸¸ `rank=8` è¶³å¤Ÿï¼Œå¤æ‚ä»»åŠ¡å¯å°è¯• `rank=16-64`ã€‚\n3. **æ··åˆç²¾åº¦è®­ç»ƒ**ï¼šæ·»åŠ  `with torch.autocast(\"cuda\")` åŠ é€Ÿè®­ç»ƒå¹¶å‡å°‘æ˜¾å­˜ã€‚\n4. **æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼šå¯¹ `unet.enable_gradient_checkpointing()` ä»¥å‡å°‘æ˜¾å­˜å ç”¨ã€‚\n5. **å­¦ä¹ ç‡è°ƒæ•´**ï¼šLoRA å­¦ä¹ ç‡é€šå¸¸æ¯”å…¨æ¨¡å‹å¾®è°ƒå¤§ï¼ˆä¾‹å¦‚ `1e-4` vs `1e-5`ï¼‰ã€‚\n\né€šè¿‡æ­¤è„šæœ¬ï¼Œä½ å¯ä»¥å®Œå…¨æ§åˆ¶ LoRA çš„å®ç°ç»†èŠ‚ï¼Œé€‚ç”¨äºå®šåˆ¶åŒ–éœ€æ±‚æˆ–ç ”ç©¶åœºæ™¯ã€‚è‹¥è¿½æ±‚å¿«é€Ÿå¼€å‘ï¼Œä»æ¨èä½¿ç”¨ `peft` åº“çš„å°è£…ã€‚\n\n## Q: ä½ è¯´â€œéœ€å°† LoRA æ³¨å…¥åˆ° UNet çš„ Cross-Attention å±‚â€ï¼Œ LoRA åªèƒ½åŠ åˆ° CrossAttention å±‚å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·ä¹‹å‰é—®è¿‡å¦‚ä½•è®­ç»ƒ Stable Diffusion çš„ LoRA æ¨¡å‹ï¼Œç„¶åæ¥ç€é—®å¦‚ä½•è‡ªå·±å†™è®­ç»ƒè„šæœ¬ã€‚ç°åœ¨ä»–ä»¬åˆè¿›ä¸€æ­¥æ·±å…¥ï¼Œé—®åˆ°æ˜¯å¦ LoRA åªèƒ½åŠ åˆ° CrossAttention å±‚ï¼Œä»¥åŠåŸå› ã€‚æˆ‘éœ€è¦ä»”ç»†åˆ†æè¿™ä¸ªé—®é¢˜ï¼Œç¡®ä¿å›ç­”å‡†ç¡®ä¸”æœ‰æ·±åº¦ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œå›é¡¾ä¸€ä¸‹ä¹‹å‰çš„å¯¹è¯ã€‚ç”¨æˆ·å·²ç»å…·å¤‡ä¸€å®šçš„ PyTorch åŸºç¡€ï¼Œå¹¶ä¸”å¯¹ LoRA çš„å®ç°æœ‰åˆæ­¥äº†è§£ã€‚ä»–ä»¬åœ¨ä¹‹å‰çš„å›ç­”ä¸­å·²ç»çœ‹åˆ°äº†å¦‚ä½•æ‰‹åŠ¨å°† LoRA æ³¨å…¥åˆ° UNet çš„ Cross-Attention å±‚ï¼Œç°åœ¨å¯èƒ½å¯¹ LoRA çš„åº”ç”¨èŒƒå›´äº§ç”Ÿäº†ç–‘é—®ï¼Œæƒ³çŸ¥é“æ˜¯å¦ä»…é™äºè¿™äº›å±‚ã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æ€è€ƒ LoRA çš„å·¥ä½œåŸç†ã€‚LoRA é€šè¿‡åœ¨åŸå§‹æƒé‡æ—æ·»åŠ ä½ç§©çŸ©é˜µæ¥å¾®è°ƒæ¨¡å‹ï¼Œé€šå¸¸ç”¨äºå‡å°‘è®­ç»ƒå‚æ•°ã€‚åœ¨ Stable Diffusion ä¸­ï¼ŒUNet çš„ Cross-Attention å±‚æ˜¯æ–‡æœ¬æ¡ä»¶ä¸å›¾åƒç”Ÿæˆäº¤äº’çš„å…³é”®éƒ¨åˆ†ï¼Œå› æ­¤è°ƒæ•´è¿™äº›å±‚èƒ½æœ‰æ•ˆå½±å“ç”Ÿæˆç»“æœã€‚ä½†ç”¨æˆ·çš„é—®é¢˜æ˜¯å…³äºæ˜¯å¦åªèƒ½åœ¨è¿™äº›å±‚åº”ç”¨ LoRAï¼Œæˆ‘éœ€è¦ç¡®è®¤å…¶ä»–å±‚æ˜¯å¦ä¹Ÿèƒ½åº”ç”¨ï¼Œæˆ–è€…æ˜¯å¦æœ‰å…¶ä»–è€ƒè™‘å› ç´ ã€‚\n\u003e\n\u003e å¯èƒ½çš„è¯¯åŒºæ˜¯ç”¨æˆ·å¯èƒ½è®¤ä¸º LoRA åªèƒ½ç”¨äº Cross-Attention å±‚ï¼Œä½†å®é™…ä¸Šï¼Œç†è®ºä¸Šå¯ä»¥åº”ç”¨åˆ°ä»»ä½•çº¿æ€§å±‚ã€‚ä½†å®è·µä¸­ï¼Œé€‰æ‹©ç‰¹å®šå±‚æ˜¯ä¸ºäº†æ•ˆç‡å’Œæ•ˆæœã€‚éœ€è¦è§£é‡Šä¸ºä»€ä¹ˆåœ¨ Stable Diffusion ä¸­æ¨èè¿™æ ·åšï¼ŒåŒæ—¶è¯´æ˜å…¶ä»–å¯èƒ½æ€§ã€‚\n\u003e\n\u003e éœ€è¦éªŒè¯çš„ä¿¡æ¯åŒ…æ‹¬ï¼šStable Diffusion çš„ UNet ç»“æ„ï¼Œç‰¹åˆ«æ˜¯ä¸åŒå±‚çš„ä½œç”¨ï¼›LoRA åœ¨ä¸åŒå±‚åº”ç”¨çš„æ•ˆæœå·®å¼‚ï¼›ç›¸å…³ç ”ç©¶æˆ–å®è·µç»éªŒã€‚ä¾‹å¦‚ï¼ŒDiffusers åº“çš„æ–‡æ¡£æˆ–ç›¸å…³è®ºæ–‡å¯èƒ½æåˆ°æœ€ä½³å®è·µã€‚\n\u003e\n\u003e ç”¨æˆ·å¯èƒ½çš„æ·±å±‚éœ€æ±‚æ˜¯å¸Œæœ›çµæ´»åº”ç”¨ LoRAï¼Œäº†è§£å…¶é™åˆ¶å’Œå¯èƒ½æ€§ï¼Œä»¥ä¾¿åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­åšè°ƒæ•´ã€‚ä»–ä»¬å¯èƒ½æƒ³çŸ¥é“æ˜¯å¦å¯ä»¥åœ¨å…¶ä»–å±‚ï¼ˆå¦‚è‡ªæ³¨æ„åŠ›å±‚æˆ– FFNï¼‰æ·»åŠ  LoRAï¼Œä»¥åŠæ•ˆæœå¦‚ä½•ã€‚\n\u003e\n\u003e å›ç­”æ—¶éœ€è¦åˆ†ç‚¹è¯´æ˜ï¼Œé¦–å…ˆæŒ‡å‡º LoRA ç†è®ºä¸Šå¯ä»¥åº”ç”¨äºä»»ä½•å±‚ï¼Œä½†åœ¨å®é™…åº”ç”¨ä¸­ Cross-Attention å±‚æ›´ä¸ºå…³é”®ï¼Œç„¶åè§£é‡ŠåŸå› ï¼ŒåŒ…æ‹¬å‚æ•°æ•ˆç‡ã€æ–‡æœ¬æ§åˆ¶çš„é‡è¦æ€§ï¼Œä»¥åŠå®è·µä¸­çš„æ•ˆæœã€‚åŒæ—¶ï¼Œè¡¥å……å…¶ä»–å¯èƒ½çš„åº”ç”¨åœºæ™¯ï¼Œè®©ç”¨æˆ·æœ‰å…¨é¢çš„äº†è§£ã€‚\n\u003e\n\u003e éœ€è¦ç¡®ä¿è¯­è¨€æ¸…æ™°ï¼Œé¿å…æœ¯è¯­æ··ä¹±ï¼ŒåŒæ—¶æä¾›è¶³å¤Ÿçš„ä¾‹å­å’Œè§£é‡Šï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£ã€‚å¯èƒ½è¿˜éœ€è¦æåˆ°ç›¸å…³ç ”ç©¶ï¼Œæ¯”å¦‚ LoRA æœ€åˆçš„åº”ç”¨åœºæ™¯ï¼Œæˆ–è€…åœ¨ Stable Diffusion ä¸­çš„å…·ä½“è°ƒæ•´æ¡ˆä¾‹ï¼Œä»¥å¢å¼ºè¯´æœåŠ›ã€‚\n\u003e\n\u003e æœ€åï¼Œæ€»ç»“æ—¶å¼ºè°ƒé€‰æ‹© Cross-Attention å±‚çš„åŸå› ï¼Œä½†é¼“åŠ±ç”¨æˆ·æ ¹æ®éœ€æ±‚å°è¯•å…¶ä»–å±‚ï¼Œå¹¶æŒ‡å‡ºå¯èƒ½çš„æ•ˆæœå·®å¼‚å’Œèµ„æºæ¶ˆè€—ã€‚è¿™æ ·æ—¢è§£ç­”äº†é—®é¢˜ï¼Œåˆæä¾›äº†è¿›ä¸€æ­¥æ¢ç´¢çš„æ–¹å‘ã€‚\n\nä½ çš„é—®é¢˜éå¸¸å…³é”®ï¼**LoRA å¹¶ä¸åªèƒ½åŠ åˆ° Cross-Attention å±‚**ï¼Œä½†åœ¨ Stable Diffusion å¾®è°ƒä¸­ï¼Œ**Cross-Attention å±‚æ˜¯æœ€å…³é”®çš„ç›®æ ‡**ã€‚ä»¥ä¸‹æ˜¯æ·±åº¦è§£æï¼š\n\n---\n\n### **1. ç†è®ºå±‚é¢ï¼šLoRA å¯ä»¥åŠ åœ¨å“ªé‡Œï¼Ÿ**\n\nä»æ•°å­¦åŸç†ä¸Šï¼ŒLoRA æ˜¯ä¸€ç§é€šç”¨çš„å‚æ•°é«˜æ•ˆå¾®è°ƒæ–¹æ³•ï¼Œ**å¯åº”ç”¨äºä»»ä½•çº¿æ€§å±‚**ï¼ˆå¦‚ `nn.Linear` æˆ–ç­‰æ•ˆçš„çŸ©é˜µè¿ç®—ï¼‰ã€‚ä¾‹å¦‚ï¼š\n\n- **Self-Attention ä¸­çš„ Q/K/V å±‚**ï¼ˆå¤„ç†å›¾åƒè‡ªèº«ç‰¹å¾ï¼‰\n- **Feed-Forward Network (FFN) çš„ä¸­é—´å±‚**\n- **ç”šè‡³ VAE æˆ– Text Encoder çš„æŸäº›å±‚**ï¼ˆä½†è¾ƒå°‘è§ï¼‰\n\nä½†å®é™…åº”ç”¨ä¸­ï¼Œ**é€‰æ‹©æ³¨å…¥ä½ç½®éœ€æƒè¡¡æ•ˆæœä¸æ•ˆç‡**ã€‚\n\n---\n\n### **2. ä¸ºä»€ä¹ˆ Stable Diffusion ä¼˜å…ˆé€‰æ‹© Cross-Attention å±‚ï¼Ÿ**\n\n#### **(1) æ–‡æœ¬-å›¾åƒå¯¹é½çš„æ ¸å¿ƒæ¢çº½**\n\n- **Cross-Attention å±‚**æ˜¯ UNet ä¸­**æ–‡æœ¬æ¡ä»¶ï¼ˆText Embeddingï¼‰ä¸å›¾åƒç‰¹å¾äº¤äº’çš„å”¯ä¸€é€šé“**ã€‚\n- ä¿®æ”¹è¿™äº›å±‚èƒ½ç›´æ¥æ§åˆ¶ç”Ÿæˆå†…å®¹å¦‚ä½•å“åº”æ–‡æœ¬æç¤ºï¼ˆPromptï¼‰ï¼Œä¾‹å¦‚ï¼š\n  - å­¦ä¹ æ–°æ¦‚å¿µï¼ˆå¦‚ç‰¹å®šç‰©ä½“ `my_cat_v1`ï¼‰\n  - è°ƒæ•´é£æ ¼ï¼ˆå¦‚æ²¹ç”»é£ `van gogh style`ï¼‰\n\n#### **(2) å‚æ•°æ•ˆç‡æœ€å¤§åŒ–**\n\n- Stable Diffusion çš„ UNet å‚æ•°é‡å·¨å¤§ï¼ˆçº¦ 860Mï¼‰ï¼Œä½† **Cross-Attention å±‚ä»…å çº¦ 10% çš„å‚æ•°é‡**ã€‚\n- ä»…å¾®è°ƒè¿™éƒ¨åˆ†ï¼Œå³å¯ç”¨ **0.1%~1% çš„å‚æ•°é‡è¾¾åˆ°æ¥è¿‘å…¨å‚æ•°å¾®è°ƒçš„æ•ˆæœ**ï¼Œæ€§ä»·æ¯”æé«˜ã€‚\n\n#### **(3) å®è·µç»éªŒéªŒè¯**\n\n- å¤§é‡å®éªŒè¡¨æ˜ï¼Œ**è°ƒæ•´ Cross-Attention å±‚å¯¹ç”Ÿæˆç»“æœå½±å“æœ€æ˜¾è‘—**ã€‚\n- è‹¥åŒæ—¶å¾®è°ƒ Self-Attention æˆ– FFN å±‚ï¼Œå¯èƒ½å¼•å…¥å™ªå£°ï¼ˆå¦‚ç ´åé¢„è®­ç»ƒæ¨¡å‹çš„æ„å›¾èƒ½åŠ›ï¼‰ã€‚\n\n---\n\n### **3. å…¶ä»–å¯èƒ½çš„ç›®æ ‡å±‚**\n\n#### **(1) Self-Attention å±‚**\n\n- **ä½œç”¨**ï¼šæ§åˆ¶å›¾åƒå†…éƒ¨ç»“æ„ï¼ˆå¦‚ç‰©ä½“å½¢çŠ¶ã€å¸ƒå±€ï¼‰ã€‚\n- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦ä¿®æ”¹ç”Ÿæˆå›¾åƒçš„æ„å›¾è§„åˆ™ï¼ˆå¦‚å¼ºåˆ¶å¯¹ç§°æ€§ï¼‰ã€‚\n- **é£é™©**ï¼šå®¹æ˜“å¯¼è‡´æ¨¡å‹é—å¿˜é¢„è®­ç»ƒçŸ¥è¯†ï¼ˆå¦‚å¤±å»å¤šæ ·æ€§ï¼‰ã€‚\n\n#### **(2) FFN å±‚**\n\n- **ä½œç”¨**ï¼šéçº¿æ€§ç‰¹å¾å˜æ¢ã€‚\n- **é€‚ç”¨åœºæ™¯**ï¼šè°ƒæ•´é¢œè‰²ã€çº¹ç†ç­‰ä½çº§ç‰¹å¾ã€‚\n- **ç¼ºç‚¹**ï¼šå‚æ•°é‡å¤§ï¼Œæ•ˆç‡è¾ƒä½ã€‚\n\n#### **(3) ç»„åˆç­–ç•¥**\n\n- åŒæ—¶å¾®è°ƒ **Cross-Attention + éƒ¨åˆ† Self-Attention**ï¼Œå¯å¹³è¡¡æ§åˆ¶åŠ›ä¸ç¨³å®šæ€§ï¼Œä½†éœ€æ›´å¤šæ˜¾å­˜å’Œè®­ç»ƒæ•°æ®ã€‚\n\n---\n\n### **4. ä»£ç ç¤ºä¾‹ï¼šæ³¨å…¥åˆ° Self-Attention**\n\nåªéœ€ä¿®æ”¹ `inject_lora` å‡½æ•°ä¸­çš„ç›®æ ‡æ¨¡å—ç­›é€‰æ¡ä»¶ï¼š\n\n```python\ndef inject_lora(unet, rank=8):\n    for name, module in unet.named_modules():\n        # å®šä½ Self-Attention çš„ Q/K/V å±‚ï¼ˆ\"attn1\" è¡¨ç¤º Self-Attentionï¼‰\n        if \"attn1\" in name and \"to_\" in name:\n            if isinstance(module, nn.Linear):\n                # æ›¿æ¢ä¸º LoRALayer\n                ...\n    return unet\n```\n\n---\n\n### **5. å¦‚ä½•é€‰æ‹©æ³¨å…¥ä½ç½®ï¼Ÿ**\n\n| **ç›®æ ‡å±‚ç±»å‹**      | **å‚æ•°é‡å æ¯”** | **å½±å“èŒƒå›´**       | **æ¨èåœºæ™¯**                |\n| ------------------- | -------------- | ------------------ | --------------------------- |\n| **Cross-Attention** | ~10%           | æ–‡æœ¬æ§åˆ¶ã€æ¦‚å¿µå­¦ä¹  | å­¦ä¹ æ–°ç‰©ä½“/é£æ ¼ï¼ˆä¸»æµé€‰æ‹©ï¼‰ |\n| **Self-Attention**  | ~20%           | å›¾åƒç»“æ„ã€å¸ƒå±€     | ç‰¹æ®Šæ„å›¾éœ€æ±‚                |\n| **FFN**             | ~70%           | é¢œè‰²ã€çº¹ç†         | ä½çº§ç‰¹å¾å¾®è°ƒ                |\n\n---\n\n### **6. ç»ˆæå»ºè®®**\n\n- **ä¼˜å…ˆ Cross-Attention**ï¼š95% çš„åœºæ™¯åªéœ€è°ƒæ•´è¿™é‡Œã€‚\n- **è°¨æ…æ·»åŠ å…¶ä»–å±‚**ï¼šä»…åœ¨æ•°æ®å……è¶³ä¸”ä»»åŠ¡ç‰¹æ®Šæ—¶å°è¯•ï¼ˆå¦‚åŒ»å­¦å›¾åƒç”Ÿæˆéœ€ç²¾ç¡®å½¢çŠ¶æ§åˆ¶ï¼‰ã€‚\n- **ç›‘æ§è¿‡æ‹Ÿåˆ**ï¼šæ·»åŠ æ›´å¤šå¯è®­ç»ƒå‚æ•°ä¼šå¢åŠ è¿‡æ‹Ÿåˆé£é™©ï¼Œéœ€é…åˆæ•°æ®å¢å¼º/æ—©åœæ³•ã€‚\n\n\u003e [!think] äº®æ›°ï¼š\n\u003e\n\u003e `UNet2DConditionModel` çš„æ•´ä¸ªæµç¨‹ä¸­ï¼Œ Cross-Attention ä¸»è¦ä½œç”¨åœ¨ä¸‹é‡‡æ ·ã€ä¸­é—´å—ã€ä¸Šé‡‡æ ·ä¸‰ä¸ªæ­¥éª¤ä¸­ã€‚åœ¨ `__init__` å‚æ•°ä¸­ä¼ å…¥æ¯ä¸ªæ­¥éª¤ä¸­ç”¨çš„ Module ï¼Œå…¶ä¸­ç”¨ `CrossAttnDownBlock2D` ç­‰ Module `self.has_cross_attention` ä¸º true ï¼Œèƒ½å¤„ç† cross_attention_mask ç­‰å‚æ•°ã€‚å…¶ä¸­çš„ attentions å±‚å³ä¸ºäº¤å‰æ³¨æ„åŠ›å±‚ã€‚æ¨æµ‹ï¼Œæ˜¯é€šè¿‡ Attentions å±‚å¯¹ä¸‹é‡‡æ ·å±‚å…¥å‚åšå¤„ç†ï¼Œå¹¶åˆ—çš„ ResNet åº”è¯¥æ˜¯ä¸ºäº†æå‡æ³¨æ„åŠ›å±‚çš„è®­ç»ƒæ€§èƒ½ã€‚\n\n## UNet ä»£ç ä¸­çš„ Cross-Attension å±‚\n\n\u003e ä»¥ä¸‹ä¸ºåœ¨ Cursor ä¸­æœ‰ diffusers ä»£ç ä¸Šä¸‹æ–‡æ—¶ä¸ claude-3.7-sonnet çš„å¯¹è¯å†…å®¹ã€‚\n\n\u003e [!query]\n\u003e UNet ä¸­ Cross-Attension æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå…·ä½“åˆ°ä»£ç é‡Œå¦‚ä½•ä½œç”¨ï¼Ÿ @unet_2d_condition.py\n\n\u003e [!reasoning]-\n\u003e\n\u003e è¿™ä¸ªé—®é¢˜æ˜¯å…³äº UNet ä¸­ Cross-Attention æœºåˆ¶çš„ä½œç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨ UNet2DConditionModel ä¸­çš„å®ç°å’Œä½œç”¨ã€‚æˆ‘éœ€è¦æŸ¥æ‰¾å’Œåˆ†æä»£ç ä¸­ä¸ Cross-Attention ç›¸å…³çš„éƒ¨åˆ†ã€‚\n\u003e\n\u003e ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼ŒUNet2DConditionModel æ˜¯ä¸€ä¸ªæ¡ä»¶å¼çš„ 2D UNet æ¨¡å‹ï¼Œå®ƒé€šå¸¸ç”¨äºæ‰©æ•£æ¨¡å‹ä¸­ï¼Œæ¥æ”¶å™ªå£°å›¾åƒæ ·æœ¬ã€æ¡ä»¶çŠ¶æ€å’Œæ—¶é—´æ­¥é•¿ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›å¤„ç†åçš„æ ·æœ¬ã€‚\n\u003e\n\u003e åœ¨æ‰©æ•£æ¨¡å‹ï¼ˆå¦‚ Stable Diffusionï¼‰ä¸­ï¼ŒCross-Attention æ˜¯ä¸€ç§éå¸¸é‡è¦çš„æœºåˆ¶ï¼Œå®ƒå…è®¸ UNet å¤„ç†ä¸¤ç§ä¸åŒç±»å‹çš„ä¿¡æ¯ï¼š\n\u003e\n\u003e ç©ºé—´ä¿¡æ¯ï¼ˆå›¾åƒç‰¹å¾ï¼‰\n\u003e\n\u003e ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆé€šå¸¸æ˜¯æ–‡æœ¬ç¼–ç æˆ–å…¶ä»–æ¡ä»¶ç¼–ç ï¼‰\n\u003e\n\u003e è®©æˆ‘æŸ¥çœ‹ä»£ç ä¸­ä¸ Cross-Attention ç›¸å…³çš„å…³é”®éƒ¨åˆ†ï¼š\n\u003e\n\u003e æ¨¡å‹åœ¨åˆå§‹åŒ–æ—¶ï¼Œè®¾ç½®äº†ä¸€äº›ä¸ Cross-Attention ç›¸å…³çš„å‚æ•°ï¼Œå¦‚ cross_attention_dimï¼Œonly_cross_attention ç­‰ã€‚\n\u003e\n\u003e åœ¨ forward æ–¹æ³•ä¸­ï¼Œencoder_hidden_states å‚æ•°é€šå¸¸æ˜¯ä»æ–‡æœ¬ç¼–ç å™¨è·å¾—çš„è¡¨ç¤ºï¼Œå®ƒè¢«ä¼ é€’ç»™å…·æœ‰ cross-attention åŠŸèƒ½çš„ä¸‹é‡‡æ ·ã€ä¸­é—´å’Œä¸Šé‡‡æ ·å—ã€‚\n\u003e\n\u003e æ¨¡å‹ä½¿ç”¨äº†æŸç§æ³¨æ„åŠ›å¤„ç†å™¨ï¼ˆAttentionProcessorï¼‰ï¼Œå¯èƒ½æ˜¯ä¸ºäº†ä¼˜åŒ–æ³¨æ„åŠ›è®¡ç®—ã€‚\n\u003e\n\u003e è®©æˆ‘ä»”ç»†æŸ¥çœ‹ down_blocks å’Œ up_blocks ä¸­çš„ Cross-Attention å®ç°ï¼Œä»¥åŠå®ƒä»¬æ˜¯å¦‚ä½•ä¸ encoder_hidden_states äº¤äº’çš„ã€‚\n\nCross-Attention åœ¨ UNet ä¸­ä¸»è¦ç”¨äºå°†æ¡ä»¶ä¿¡æ¯ï¼ˆå¦‚æ–‡æœ¬ç‰¹å¾ï¼‰å¼•å…¥åˆ°å›¾åƒç”Ÿæˆè¿‡ç¨‹ä¸­ã€‚ä»ä»£ç æ¥çœ‹ï¼Œä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\n\n1. **æ•°æ®æµå‘**ï¼š\n\n   - UNet æ¥æ”¶å›¾åƒç‰¹å¾(`sample`)å’Œæ¡ä»¶ç¼–ç (`encoder_hidden_states`)\n   - `encoder_hidden_states`é€šå¸¸æ˜¯æ–‡æœ¬ç¼–ç å™¨è¾“å‡ºçš„ç‰¹å¾\n   - æ¡ä»¶ä¿¡æ¯é€šè¿‡ Cross-Attention åœ¨ UNet çš„ä¸åŒå±‚çº§ä¸å›¾åƒç‰¹å¾äº¤äº’\n\n2. **ä»£ç å®ç°**ï¼š\n\n   ```py 837:844:src/diffusers/models/unets/unet_2d_condition.py\n   if hasattr(downsample_block, \"has_cross_attention\") and downsample_block.has_cross_attention:\n       sample, res_samples = downsample_block(\n           hidden_states=sample,\n           temb=emb,\n           encoder_hidden_states=encoder_hidden_states,\n           attention_mask=attention_mask,\n           cross_attention_kwargs=cross_attention_kwargs,\n           encoder_attention_mask=encoder_attention_mask,\n           **additional_residuals,\n       )\n   ```\n\n3. **æ ¸å¿ƒç»„ä»¶**ï¼š\n\n   - åœ¨ä¸‹é‡‡æ ·ã€ä¸­é—´å—å’Œä¸Šé‡‡æ ·é˜¶æ®µéƒ½å¯èƒ½ä½¿ç”¨ Cross-Attention\n   - é€šè¿‡`has_cross_attention`å±æ€§åˆ¤æ–­å—æ˜¯å¦éœ€è¦ä½¿ç”¨ Cross-Attention\n   - å½“ä½¿ç”¨ Cross-Attention æ—¶ï¼Œ`encoder_hidden_states`ä¼šä½œä¸ºé¢å¤–è¾“å…¥ä¼ é€’\n\n4. **å‚æ•°æ§åˆ¶**ï¼š\n   - `only_cross_attention`å‚æ•°æ§åˆ¶æ˜¯å¦åªä½¿ç”¨ Cross-Attention è€Œä¸ä½¿ç”¨ Self-Attention\n   - `cross_attention_dim`æŒ‡å®šäº†æ¡ä»¶ç¼–ç çš„ç»´åº¦å¤§å°\n   - `transformer_layers_per_block`æ§åˆ¶æ¯ä¸ªå—ä¸­ Transformer å±‚çš„æ•°é‡\n\nCross-Attention å…è®¸æ¨¡å‹åœ¨ä¿æŒå›¾åƒç©ºé—´ç»“æ„çš„åŒæ—¶ï¼Œæ ¹æ®æ–‡æœ¬æˆ–å…¶ä»–æ¡ä»¶è°ƒæ•´ç”Ÿæˆå†…å®¹ï¼Œå®ç°äº†æ¡ä»¶ç”Ÿæˆçš„æ ¸å¿ƒæœºåˆ¶ã€‚\n\n\u003e [!query]\n\u003e TransformerBlock å…·ä½“æ˜¯åœ¨@transformer_2d.py é‡Œå®ç°å—ï¼Ÿå¦‚ä½•ä½“ç° Self-Attention ä¸ Cross-Attention ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e è®©æˆ‘æ¥åˆ†æä¸€ä¸‹ TransformerBlock çš„å®ç°ä»¥åŠ Self-Attention å’Œ Cross-Attention çš„å…·ä½“ä½“ç°ã€‚\n\u003e\n\u003e åœ¨ transformer_2d.py æ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ° Transformer2DModel ç±»ï¼Œä½† TransformerBlock çš„å…·ä½“å®ç°ä¼¼ä¹æ˜¯å¼•ç”¨è‡ªå…¶ä»–åœ°æ–¹ã€‚æ³¨æ„åˆ°ä»¥ä¸‹å¯¼å…¥:\n\u003e\n\u003e è¿™è¡¨æ˜ BasicTransformerBlock ç±»å®é™…ä¸Šæ˜¯åœ¨ attention.py æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨ transformer_2d.py ä¸­ã€‚\n\u003e\n\u003e åœ¨ transformer_2d.py ä¸­ï¼ŒBasicTransformerBlock è¢«ç”¨åœ¨ä»¥ä¸‹ä½ç½®:\n\u003e\n\u003e ä»è¿™æ®µä»£ç ä¸­å¯ä»¥çœ‹å‡º:\n\u003e\n\u003e BasicTransformerBlock æ˜¯æ¥æ”¶ self-attention å’Œ cross-attention ç›¸å…³å‚æ•°çš„ï¼ŒåŒ…æ‹¬:\n\u003e\n\u003e cross_attention_dim: äº¤å‰æ³¨æ„åŠ›çš„ç»´åº¦\n\u003e\n\u003e only_cross_attention: æ˜¯å¦åªä½¿ç”¨äº¤å‰æ³¨æ„åŠ›è€Œä¸ä½¿ç”¨è‡ªæ³¨æ„åŠ›\n\u003e\n\u003e double_self_attention: æ˜¯å¦ä½¿ç”¨åŒé‡è‡ªæ³¨æ„åŠ›\n\u003e\n\u003e åœ¨è½¬å‘(forward)å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä½•ä¼ é€’æ³¨æ„åŠ›ç›¸å…³çš„å‚æ•°:\n\u003e\n\u003e è¿™é‡Œçš„å…³é”®å‚æ•°æ˜¯:\n\u003e\n\u003e hidden_states: è¾“å…¥éšè—çŠ¶æ€ï¼Œç”¨äº Self-Attention\n\u003e\n\u003e encoder_hidden_states: ç¼–ç å™¨éšè—çŠ¶æ€ï¼Œç”¨äº Cross-Attention\n\u003e\n\u003e attention_mask: è‡ªæ³¨æ„åŠ›çš„æ©ç \n\u003e\n\u003e encoder_attention_mask: äº¤å‰æ³¨æ„åŠ›çš„æ©ç \n\u003e\n\u003e è™½ç„¶æˆ‘ä»¬å¯ä»¥ä»è¿™äº›ä»£ç æ¨æ–­å‡º BasicTransformerBlock ä¸­å¦‚ä½•å®ç°è‡ªæ³¨æ„åŠ›å’Œäº¤å‰æ³¨æ„åŠ›ï¼Œä½†ç”±äºå®é™…å®ç°ä¸åœ¨ transformer_2d.py æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ attention.py æ–‡ä»¶æ‰èƒ½äº†è§£å®Œæ•´çš„å®ç°ç»†èŠ‚ã€‚\n\u003e\n\u003e åŸºäºç°æœ‰çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­:\n\u003e\n\u003e Self-Attention æ˜¯ä½¿ç”¨ hidden_states å¯¹è‡ªèº«è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—\n\u003e\n\u003e Cross-Attention æ˜¯å°† hidden_states ä½œä¸ºæŸ¥è¯¢(query)ï¼Œå°† encoder_hidden_states ä½œä¸ºé”®(key)å’Œå€¼(value)è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—\n\u003e\n\u003e å¯ä»¥é€šè¿‡ only_cross_attention å‚æ•°æ§åˆ¶æ˜¯å¦åªä½¿ç”¨ Cross-Attention è€Œä¸ä½¿ç”¨ Self-Attention\n\nTransformerBlock çš„æ ¸å¿ƒå®ç°æ˜¯åœ¨`attention.py`ä¸­çš„`BasicTransformerBlock`ç±»ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨`transformer_2d.py`ä¸­ã€‚åœ¨`transformer_2d.py`ä¸­åªæ˜¯è°ƒç”¨äº†è¿™ä¸ªç±»æ¥æ„å»º Transformer æ¨¡å‹ã€‚\n\nä»`transformer_2d.py`ä»£ç ä¸­å¯ä»¥çœ‹åˆ° Self-Attention å’Œ Cross-Attention çš„å‡ ä¸ªå…³é”®ç‰¹ç‚¹ï¼š\n\n1. **å®ä¾‹åŒ– transformer å—æ—¶**:\n\n   ```156:169:src/diffusers/models/transformers/transformer_2d.py\n   BasicTransformerBlock(\n       self.inner_dim,\n       self.config.num_attention_heads,\n       self.config.attention_head_dim,\n       dropout=self.config.dropout,\n       cross_attention_dim=self.config.cross_attention_dim,\n       activation_fn=self.config.activation_fn,\n       num_embeds_ada_norm=self.config.num_embeds_ada_norm,\n       attention_bias=self.config.attention_bias,\n       only_cross_attention=self.config.only_cross_attention,\n       double_self_attention=self.config.double_self_attention,\n       ...\n   )\n   ```\n\n2. **è°ƒç”¨æ—¶çš„æ•°æ®æµ**:\n   ```386:396:src/diffusers/models/transformers/transformer_2d.py\n   hidden_states = block(\n       hidden_states,\n       attention_mask=attention_mask,\n       encoder_hidden_states=encoder_hidden_states,\n       encoder_attention_mask=encoder_attention_mask,\n       timestep=timestep,\n       cross_attention_kwargs=cross_attention_kwargs,\n       class_labels=class_labels,\n   )\n   ```\n\næ ¸å¿ƒåŒºåˆ«ï¼š\n\n- **Self-Attention**: ä½¿ç”¨`hidden_states`è‡ªèº«è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ï¼Œ`attention_mask`ä½œä¸ºæ©ç \n- **Cross-Attention**: ä½¿ç”¨`hidden_states`ä½œä¸º queryï¼Œ`encoder_hidden_states`ä½œä¸º key å’Œ valueï¼Œ`encoder_attention_mask`ä½œä¸ºæ©ç \n\né…ç½®é€‰é¡¹ï¼š\n\n- `only_cross_attention`: å¦‚æœä¸º Trueï¼Œåªä½¿ç”¨ Cross-Attention è€Œè·³è¿‡ Self-Attention\n- `double_self_attention`: å¦‚æœä¸º Trueï¼Œä½¿ç”¨ä¸¤æ¬¡ Self-Attention\n- `cross_attention_dim`: æŒ‡å®š Cross-Attention çš„ç»´åº¦å¤§å°\n\nåœ¨å®é™…è¿è¡Œæ—¶ï¼ŒBasicTransformerBlock å†…éƒ¨ä¼šå…ˆè¿›è¡Œ Self-Attention æ“ä½œï¼Œç„¶åè¿›è¡Œ Cross-Attention æ“ä½œï¼ˆå¦‚æœæä¾›äº†`encoder_hidden_states`ï¼‰ã€‚è¿™æ ·å°±å®ç°äº† UNet ä¸­æ–‡æœ¬æ¡ä»¶å¯¹å›¾åƒç”Ÿæˆçš„å½±å“ã€‚\n\n\u003e [!query]\n\u003e @attention.py ä¸­ BasicTransformerBlock å¦‚ä½•ä½“ç° Self-Attention ä¸ Cross-Attention ?\n\n\u003e [!reasoning]\n\u003e\n\u003e è®©æˆ‘çœ‹çœ‹ attention.py ä¸­çš„ BasicTransformerBlock ç±»ï¼Œç‰¹åˆ«æ˜¯å®ƒå¦‚ä½•å®ç° Self-Attention å’Œ Cross-Attention çš„éƒ¨åˆ†ã€‚\n\u003e\n\u003e ä»ä»£ç ä¸­ï¼Œæˆ‘å¯ä»¥çœ‹åˆ° BasicTransformerBlock ç±»åŒ…å«äº†ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š\n\u003e\n\u003e åˆå§‹åŒ–å‡½æ•°ä¸­ï¼Œå®ƒè®¾ç½®äº†å¤šä¸ª Attention æ¨¡å—å’Œæ ‡å‡†åŒ–å±‚ï¼š\n\u003e\n\u003e self.norm1 å’Œ self.attn1 ç”¨äº Self-Attention\n\u003e\n\u003e self.norm2 å’Œ self.attn2 ç”¨äº Cross-Attentionï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰\n\u003e\n\u003e self.norm3 å’Œ self.ff ç”¨äºå‰é¦ˆç½‘ç»œ\n\u003e\n\u003e åœ¨ forward å‡½æ•°ä¸­ï¼Œå¤„ç†æµç¨‹å¦‚ä¸‹ï¼š\n\u003e\n\u003e é¦–å…ˆå¯¹è¾“å…¥è¿›è¡Œ normalization\n\u003e\n\u003e ç„¶ååº”ç”¨ Self-Attentionï¼ˆself.attn1ï¼‰\n\u003e\n\u003e å¦‚æœæœ‰ cross_attention_dim æˆ– double_self_attentionï¼Œåˆ™åº”ç”¨ Cross-Attentionï¼ˆself.attn2ï¼‰\n\u003e\n\u003e æœ€åæ˜¯ Feed-Forward ç½‘ç»œ\n\u003e\n\u003e ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº Self-Attention å’Œ Cross-Attention çš„åŒºåˆ«ï¼š\n\u003e\n\u003e Self-Attentionï¼šä½¿ç”¨ self.attn1ï¼Œåªä½¿ç”¨ hidden_states ä½œä¸ºè¾“å…¥ï¼Œåœ¨ only_cross_attention ä¸º True æ—¶å¯èƒ½ä½¿ç”¨ encoder_hidden_statesã€‚\n\u003e\n\u003e Cross-Attentionï¼šä½¿ç”¨ self.attn2ï¼Œhidden_states ä½œä¸º queryï¼Œencoder_hidden_states ä½œä¸º key å’Œ valueã€‚\n\u003e\n\u003e åœ¨ forward æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçœ‹åˆ°è¿™ä¸€ç‚¹ï¼š\n\u003e\n\u003e å¯¹äº Self-Attentionï¼Œattn_output = self.attn1(norm_hidden_states, ...)\n\u003e\n\u003e å¯¹äº Cross-Attentionï¼Œattn_output = self.attn2(norm_hidden_states, encoder_hidden_states=encoder_hidden_states, ...)\n\u003e\n\u003e æˆ‘ä¼šé‡ç‚¹å…³æ³¨ forward æ–¹æ³•ä¸­å®ç° Self-Attention å’Œ Cross-Attention çš„å…³é”®éƒ¨åˆ†ã€‚\n\nåœ¨`attention.py`ä¸­ï¼Œ`BasicTransformerBlock`ç±»é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°äº† Self-Attention å’Œ Cross-Attentionï¼š\n\n### 1. æ¶æ„è®¾è®¡\n\n```py 326:361:src/diffusers/models/attention.py\n# 1. Self-Attn\nself.attn1 = Attention(\n    query_dim=dim,\n    heads=num_attention_heads,\n    dim_head=attention_head_dim,\n    dropout=dropout,\n    bias=attention_bias,\n    cross_attention_dim=cross_attention_dim if only_cross_attention else None,\n    upcast_attention=upcast_attention,\n    out_bias=attention_out_bias,\n)\n\n# 2. Cross-Attn\nif cross_attention_dim is not None or double_self_attention:\n    self.norm2 = nn.LayerNorm(dim, norm_eps, norm_elementwise_affine)\n\n    self.attn2 = Attention(\n        query_dim=dim,\n        cross_attention_dim=cross_attention_dim if not double_self_attention else None,\n        heads=num_attention_heads,\n        dim_head=attention_head_dim,\n        dropout=dropout,\n        bias=attention_bias,\n        upcast_attention=upcast_attention,\n        out_bias=attention_out_bias,\n    )\n```\n\n### 2. å‰å‘ä¼ æ’­è¿‡ç¨‹\n\n```py 500:525:src/diffusers/models/attention.py\n# 1. Self-Attention\nnorm_hidden_states = self.norm1(hidden_states)\nattn_output = self.attn1(\n    norm_hidden_states,\n    encoder_hidden_states=encoder_hidden_states if self.only_cross_attention else None,\n    attention_mask=attention_mask,\n    **cross_attention_kwargs,\n)\n\n# ... (å¤„ç†è¾“å‡º)\nhidden_states = attn_output + hidden_states\n\n# 2. Cross-Attention\nif self.attn2 is not None:\n    norm_hidden_states = self.norm2(hidden_states)\n    attn_output = self.attn2(\n        norm_hidden_states,\n        encoder_hidden_states=encoder_hidden_states,\n        attention_mask=encoder_attention_mask,\n        **cross_attention_kwargs,\n    )\n    hidden_states = attn_output + hidden_states\n```\n\n### 3. å…³é”®åŒºåˆ«\n\n- **Self-Attention (attn1)**ï¼š\n\n  - é»˜è®¤æƒ…å†µä¸‹åªä½¿ç”¨`hidden_states`ä½œä¸ºè¾“å…¥ï¼ˆquery, key, value éƒ½æ¥è‡ªåŒä¸€æºï¼‰\n  - åªæœ‰å½“`only_cross_attention=True`æ—¶æ‰ä¼šç”¨`encoder_hidden_states`\n  - ä½¿ç”¨`attention_mask`ä½œä¸ºæ©ç \n\n- **Cross-Attention (attn2)**ï¼š\n  - `norm_hidden_states`ä½œä¸º query\n  - `encoder_hidden_states`ä½œä¸º key å’Œ value\n  - ä½¿ç”¨`encoder_attention_mask`ä½œä¸ºæ©ç \n  - å½“`encoder_hidden_states=None`æ—¶ä¼šé€€åŒ–ä¸º Self-Attention\n\n### 4. é…ç½®æ§åˆ¶\n\n- `only_cross_attention`ï¼šæ˜¯å¦åœ¨ attn1 ä¸­ä½¿ç”¨ cross-attention\n- `double_self_attention`ï¼šæ˜¯å¦å°† attn2 é…ç½®ä¸ºå¦ä¸€ä¸ª self-attention å±‚\n- `cross_attention_dim`ï¼šæŒ‡å®šæ¡ä»¶ç¼–ç çš„ç»´åº¦\n\nè¿™ç§è®¾è®¡å…è®¸ UNet æ¨¡å‹åœ¨ä¸åŒå±‚çº§çµæ´»ç»„åˆ Self-Attention å’Œ Cross-Attentionï¼Œå®ç°å¯¹å›¾åƒç‰¹å¾çš„å†…éƒ¨å¤„ç†å’Œå¯¹æ¡ä»¶ä¿¡æ¯çš„æ•´åˆã€‚\n\n\u003e [!query]\n\u003e æˆ‘æ³¨æ„åˆ° @attention.py ä¸­åœ¨ Attention å±‚å‰éƒ½ä¼šæœ‰ä¸€ä¸ª LayerNorm å±‚ã€‚è¿™æ˜¯å¿…é¡»è¦æœ‰çš„å—ï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e è¿™ä¸ªé—®é¢˜è¯¢é—®çš„æ˜¯å…³äºåœ¨ Attention å±‚å‰ä½¿ç”¨ LayerNorm çš„å¿…è¦æ€§å’Œä½œç”¨ã€‚æˆ‘éœ€è¦è§£é‡Š LayerNorm åœ¨ Transformer ç»“æ„ä¸­çš„é‡è¦æ€§ã€‚\n\u003e åœ¨ attention.py ä¸­çš„ BasicTransformerBlock å®ç°ä¸­ï¼Œæ¯ä¸ª Attention æ“ä½œå‰ç¡®å®éƒ½æœ‰ä¸€ä¸ª normalization å±‚ï¼ˆé€šå¸¸æ˜¯ LayerNormï¼‰ï¼Œæˆ‘åº”è¯¥åˆ†æè¿™ç§è®¾è®¡çš„åŸå› ã€‚\n\næ˜¯çš„ï¼Œåœ¨`attention.py`çš„`BasicTransformerBlock`ä¸­ï¼Œæ¯ä¸ª Attention å±‚å‰éƒ½æœ‰ä¸€ä¸ªå½’ä¸€åŒ–å±‚ï¼ˆé€šå¸¸æ˜¯ LayerNormï¼‰ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„è®¾è®¡ï¼š\n\n### LayerNorm çš„å¿…è¦æ€§\n\n1. **è®­ç»ƒç¨³å®šæ€§**ï¼š\n\n   ```py 453:460:src/diffusers/models/attention.py\n   # åœ¨Self-Attentionå‰åº”ç”¨å½’ä¸€åŒ–\n   if self.norm_type == \"ada_norm\":\n       norm_hidden_states = self.norm1(hidden_states, timestep)\n   elif self.norm_type == \"ada_norm_zero\":\n       norm_hidden_states, gate_msa, shift_mlp, scale_mlp, gate_mlp = self.norm1(\n           hidden_states, timestep, class_labels, hidden_dtype=hidden_states.dtype\n       )\n   elif self.norm_type in [\"layer_norm\", \"layer_norm_i2vgen\"]:\n       norm_hidden_states = self.norm1(hidden_states)\n   ```\n\n2. **æ¢¯åº¦æµåŠ¨**ï¼š\n   - å½’ä¸€åŒ–å±‚å°†æ•°æ®åˆ†å¸ƒæ ‡å‡†åŒ–ï¼Œé˜²æ­¢æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸\n   - ç‰¹åˆ«æ˜¯åœ¨æ·±å±‚ç½‘ç»œä¸­ï¼Œä¿æŒæ¢¯åº¦æµåŠ¨å¯¹è®­ç»ƒè‡³å…³é‡è¦\n\n### LayerNorm çš„ä½œç”¨\n\n1. **ç‰¹å¾åˆ†å¸ƒç¨³å®š**ï¼š\n\n   - å°†ç‰¹å¾å½’ä¸€åŒ–åˆ°ç›¸åŒå°ºåº¦ï¼Œå‡å°‘æ‰¹æ¬¡é—´å·®å¼‚\n   - ä½¿ç½‘ç»œå¯¹è¾“å…¥å˜åŒ–æ›´åŠ é²æ£’ï¼Œæé«˜æ³›åŒ–èƒ½åŠ›\n\n2. **æ®‹å·®è¿æ¥çš„é…åˆ**ï¼š\n\n   ```py 510:511:src/diffusers/models/attention.py\n   # åº”ç”¨æ®‹å·®è¿æ¥\n   hidden_states = attn_output + hidden_states\n   ```\n\n   - Pre-LayerNorm ç»“æ„ï¼ˆå…ˆå½’ä¸€åŒ–å Attentionï¼‰ä¸æ®‹å·®è¿æ¥é…åˆä½¿ç”¨\n   - è¿™ç§\"å½’ä¸€åŒ– â†’ æ“ä½œ â†’ æ®‹å·®\"çš„æ¨¡å¼æ˜¯ Transformer æ¶æ„çš„åŸºæœ¬ç»„æˆéƒ¨åˆ†\n\n3. **å¤šç§å½’ä¸€åŒ–é€‰æ‹©**ï¼š\n   ```py 454:461:src/diffusers/models/attention.py\n   # ä¸åŒç±»å‹çš„å½’ä¸€åŒ–å±‚\n   if self.norm_type == \"ada_norm\":\n       norm_hidden_states = self.norm1(hidden_states, timestep)\n   elif self.norm_type == \"ada_norm_zero\":\n       # ...\n   elif self.norm_type in [\"layer_norm\", \"layer_norm_i2vgen\"]:\n       # ...\n   ```\n   - åŸºæœ¬çš„ LayerNorm\n   - å¸¦æ¡ä»¶çš„ AdaLayerNormï¼ˆä½¿ç”¨ timestep ä¿¡æ¯è°ƒæ•´ï¼‰\n   - å…¶ä»–ç‰¹æ®Šå½’ä¸€åŒ–å˜ä½“ï¼Œé€‚åº”ä¸åŒåœºæ™¯\n\næ€»ä¹‹ï¼ŒLayerNorm åœ¨ Attention å±‚å‰æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå®ƒæ˜¯ä¿è¯ Transformer ç»“æ„æœ‰æ•ˆè®­ç»ƒå’Œè‰¯å¥½æ€§èƒ½çš„å…³é”®ç»„ä»¶ï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿæˆæ¨¡å‹è¿™æ ·éœ€è¦å¤„ç†å¤§é‡å¤æ‚ç‰¹å¾çš„æ·±åº¦ç½‘ç»œä¸­ã€‚\n","title":"PyTorch å®ç° Stable Diffusion LoRA è®­ç»ƒè„šæœ¬ï¼šä»æ•°æ®é¢„å¤„ç†åˆ°æ¨¡å‹ä¿®æ”¹ä¸è®­ç»ƒå¾ªç¯","abstract":"\u003e æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ PyTorch ä»é›¶å¼€å§‹ç¼–å†™ Stable Diffusion LoRA è®­ç»ƒè„šæœ¬ï¼ŒåŒ…æ‹¬æ•°æ®é¢„å¤„ç†ã€æ¨¡å‹ä¿®æ”¹ã€è®­ç»ƒå¾ªç¯ã€å‚æ•°ä¿å­˜ä¸åŠ è½½ç­‰å…³é”®æ­¥éª¤ã€‚ç‰¹åˆ«å¼ºè°ƒäº† LoRA å±‚çš„æ‰‹åŠ¨å®ç°å’Œåœ¨ UNet çš„ Cross-Attention å±‚æ³¨å…¥ LoRA çš„åŸå› ï¼Œä»¥åŠåœ¨å…¶ä»–å±‚åº”ç”¨ LoRA çš„å¯èƒ½æ€§å’Œæ³¨æ„äº‹é¡¹ã€‚æ­¤å¤–ï¼Œè¿˜æä¾›äº†ä»£ç ç¤ºä¾‹å’Œå‚æ•°æ•ˆç‡çš„è®¨è®ºï¼Œå¸®åŠ©è¯»è€…æ·±å…¥ç†è§£ LoRA åœ¨ Stable Diffusion å¾®è°ƒä¸­çš„åº”ç”¨ã€‚\n\u003e [!reasoning]-\n\u003e","length":883,"created_at":"2025-03-29T02:00:00.000Z","updated_at":"2025-03-29T02:00:00.000Z","tags":["æ·±åº¦å­¦ä¹ ","Stable Diffusion","LoRA","å‚æ•°é«˜æ•ˆå¾®è°ƒ","æ¨¡å‹è®­ç»ƒ","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-è®­ç»ƒä¸€ä¸ª-stable-diffusion-çš„-lora-æ¨¡å‹è¦æœ‰å“ªäº›æ­¥éª¤","href":"#q-è®­ç»ƒä¸€ä¸ª-stable-diffusion-çš„-lora-æ¨¡å‹è¦æœ‰å“ªäº›æ­¥éª¤","heading":2,"title":"Q: è®­ç»ƒä¸€ä¸ª Stable Diffusion çš„ LoRA æ¨¡å‹ï¼Œè¦æœ‰å“ªäº›æ­¥éª¤ï¼Ÿ","children":[{"key":"1-æ•°æ®å‡†å¤‡","href":"#1-æ•°æ®å‡†å¤‡","heading":3,"title":"1. æ•°æ®å‡†å¤‡","children":[],"id":"1-æ•°æ®å‡†å¤‡"},{"key":"2-ç¯å¢ƒé…ç½®","href":"#2-ç¯å¢ƒé…ç½®","heading":3,"title":"2. ç¯å¢ƒé…ç½®","children":[],"id":"2-ç¯å¢ƒé…ç½®"},{"key":"3-æ¨¡å‹å‡†å¤‡","href":"#3-æ¨¡å‹å‡†å¤‡","heading":3,"title":"3. æ¨¡å‹å‡†å¤‡","children":[],"id":"3-æ¨¡å‹å‡†å¤‡"},{"key":"4-è®­ç»ƒé…ç½®","href":"#4-è®­ç»ƒé…ç½®","heading":3,"title":"4. è®­ç»ƒé…ç½®","children":[],"id":"4-è®­ç»ƒé…ç½®"},{"key":"5-è®­ç»ƒè¿‡ç¨‹","href":"#5-è®­ç»ƒè¿‡ç¨‹","heading":3,"title":"5. è®­ç»ƒè¿‡ç¨‹","children":[],"id":"5-è®­ç»ƒè¿‡ç¨‹"},{"key":"6-æ¨ç†ä¸éƒ¨ç½²","href":"#6-æ¨ç†ä¸éƒ¨ç½²","heading":3,"title":"6. æ¨ç†ä¸éƒ¨ç½²","children":[],"id":"6-æ¨ç†ä¸éƒ¨ç½²"},{"key":"å¸¸è§é—®é¢˜","href":"#å¸¸è§é—®é¢˜","heading":3,"title":"å¸¸è§é—®é¢˜","children":[],"id":"å¸¸è§é—®é¢˜"}],"id":"q-è®­ç»ƒä¸€ä¸ª-stable-diffusion-çš„-lora-æ¨¡å‹è¦æœ‰å“ªäº›æ­¥éª¤"},{"key":"q-æˆ‘æœ‰-python-ä¸-pytorch-åŸºç¡€éœ€è¦è‡ªå·±å†™ä¸€ä¸ª-lora-è®­ç»ƒè„šæœ¬åº”å¦‚ä½•å†™","href":"#q-æˆ‘æœ‰-python-ä¸-pytorch-åŸºç¡€éœ€è¦è‡ªå·±å†™ä¸€ä¸ª-lora-è®­ç»ƒè„šæœ¬åº”å¦‚ä½•å†™","heading":2,"title":"Q: æˆ‘æœ‰ Python ä¸ PyTorch åŸºç¡€ã€‚éœ€è¦è‡ªå·±å†™ä¸€ä¸ª LoRA è®­ç»ƒè„šæœ¬ï¼Œåº”å¦‚ä½•å†™ï¼Ÿ","children":[{"key":"1-lora-å±‚çš„åŸç†ä¸å®ç°","href":"#1-lora-å±‚çš„åŸç†ä¸å®ç°","heading":3,"title":"1. LoRA å±‚çš„åŸç†ä¸å®ç°","children":[],"id":"1-lora-å±‚çš„åŸç†ä¸å®ç°"},{"key":"2-ä¿®æ”¹-stable-diffusion-çš„-unet","href":"#2-ä¿®æ”¹-stable-diffusion-çš„-unet","heading":3,"title":"2. ä¿®æ”¹ Stable Diffusion çš„ UNet","children":[],"id":"2-ä¿®æ”¹-stable-diffusion-çš„-unet"},{"key":"3-æ•°æ®é¢„å¤„ç†","href":"#3-æ•°æ®é¢„å¤„ç†","heading":3,"title":"3. æ•°æ®é¢„å¤„ç†","children":[],"id":"3-æ•°æ®é¢„å¤„ç†"},{"key":"4-è®­ç»ƒå¾ªç¯","href":"#4-è®­ç»ƒå¾ªç¯","heading":3,"title":"4. è®­ç»ƒå¾ªç¯","children":[],"id":"4-è®­ç»ƒå¾ªç¯"},{"key":"5-ä¿å­˜-lora-æƒé‡","href":"#5-ä¿å­˜-lora-æƒé‡","heading":3,"title":"5. ä¿å­˜ LoRA æƒé‡","children":[],"id":"5-ä¿å­˜-lora-æƒé‡"},{"key":"6-æ¨ç†æ—¶åŠ è½½-lora","href":"#6-æ¨ç†æ—¶åŠ è½½-lora","heading":3,"title":"6. æ¨ç†æ—¶åŠ è½½ LoRA","children":[],"id":"6-æ¨ç†æ—¶åŠ è½½-lora"},{"key":"å…³é”®æ³¨æ„äº‹é¡¹","href":"#å…³é”®æ³¨æ„äº‹é¡¹","heading":3,"title":"å…³é”®æ³¨æ„äº‹é¡¹","children":[],"id":"å…³é”®æ³¨æ„äº‹é¡¹"}],"id":"q-æˆ‘æœ‰-python-ä¸-pytorch-åŸºç¡€éœ€è¦è‡ªå·±å†™ä¸€ä¸ª-lora-è®­ç»ƒè„šæœ¬åº”å¦‚ä½•å†™"},{"key":"q-ä½ è¯´éœ€å°†-lora-æ³¨å…¥åˆ°-unet-çš„-cross-attention-å±‚-lora-åªèƒ½åŠ åˆ°-crossattention-å±‚å—ä¸ºä»€ä¹ˆ","href":"#q-ä½ è¯´éœ€å°†-lora-æ³¨å…¥åˆ°-unet-çš„-cross-attention-å±‚-lora-åªèƒ½åŠ åˆ°-crossattention-å±‚å—ä¸ºä»€ä¹ˆ","heading":2,"title":"Q: ä½ è¯´â€œéœ€å°† LoRA æ³¨å…¥åˆ° UNet çš„ Cross-Attention å±‚â€ï¼Œ LoRA åªèƒ½åŠ åˆ° CrossAttention å±‚å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ","children":[{"key":"1-ç†è®ºå±‚é¢lora-å¯ä»¥åŠ åœ¨å“ªé‡Œ","href":"#1-ç†è®ºå±‚é¢lora-å¯ä»¥åŠ åœ¨å“ªé‡Œ","heading":3,"title":"1. ç†è®ºå±‚é¢ï¼šLoRA å¯ä»¥åŠ åœ¨å“ªé‡Œï¼Ÿ","children":[],"id":"1-ç†è®ºå±‚é¢lora-å¯ä»¥åŠ åœ¨å“ªé‡Œ"},{"key":"2-ä¸ºä»€ä¹ˆ-stable-diffusion-ä¼˜å…ˆé€‰æ‹©-cross-attention-å±‚","href":"#2-ä¸ºä»€ä¹ˆ-stable-diffusion-ä¼˜å…ˆé€‰æ‹©-cross-attention-å±‚","heading":3,"title":"2. ä¸ºä»€ä¹ˆ Stable Diffusion ä¼˜å…ˆé€‰æ‹© Cross-Attention å±‚ï¼Ÿ","children":[{"key":"1-æ–‡æœ¬-å›¾åƒå¯¹é½çš„æ ¸å¿ƒæ¢çº½","href":"#1-æ–‡æœ¬-å›¾åƒå¯¹é½çš„æ ¸å¿ƒæ¢çº½","heading":4,"title":"(1) æ–‡æœ¬-å›¾åƒå¯¹é½çš„æ ¸å¿ƒæ¢çº½","children":[],"id":"1-æ–‡æœ¬-å›¾åƒå¯¹é½çš„æ ¸å¿ƒæ¢çº½"},{"key":"2-å‚æ•°æ•ˆç‡æœ€å¤§åŒ–","href":"#2-å‚æ•°æ•ˆç‡æœ€å¤§åŒ–","heading":4,"title":"(2) å‚æ•°æ•ˆç‡æœ€å¤§åŒ–","children":[],"id":"2-å‚æ•°æ•ˆç‡æœ€å¤§åŒ–"},{"key":"3-å®è·µç»éªŒéªŒè¯","href":"#3-å®è·µç»éªŒéªŒè¯","heading":4,"title":"(3) å®è·µç»éªŒéªŒè¯","children":[],"id":"3-å®è·µç»éªŒéªŒè¯"}],"id":"2-ä¸ºä»€ä¹ˆ-stable-diffusion-ä¼˜å…ˆé€‰æ‹©-cross-attention-å±‚"},{"key":"3-å…¶ä»–å¯èƒ½çš„ç›®æ ‡å±‚","href":"#3-å…¶ä»–å¯èƒ½çš„ç›®æ ‡å±‚","heading":3,"title":"3. å…¶ä»–å¯èƒ½çš„ç›®æ ‡å±‚","children":[{"key":"1-self-attention-å±‚","href":"#1-self-attention-å±‚","heading":4,"title":"(1) Self-Attention å±‚","children":[],"id":"1-self-attention-å±‚"},{"key":"2-ffn-å±‚","href":"#2-ffn-å±‚","heading":4,"title":"(2) FFN å±‚","children":[],"id":"2-ffn-å±‚"},{"key":"3-ç»„åˆç­–ç•¥","href":"#3-ç»„åˆç­–ç•¥","heading":4,"title":"(3) ç»„åˆç­–ç•¥","children":[],"id":"3-ç»„åˆç­–ç•¥"}],"id":"3-å…¶ä»–å¯èƒ½çš„ç›®æ ‡å±‚"},{"key":"4-ä»£ç ç¤ºä¾‹æ³¨å…¥åˆ°-self-attention","href":"#4-ä»£ç ç¤ºä¾‹æ³¨å…¥åˆ°-self-attention","heading":3,"title":"4. ä»£ç ç¤ºä¾‹ï¼šæ³¨å…¥åˆ° Self-Attention","children":[],"id":"4-ä»£ç ç¤ºä¾‹æ³¨å…¥åˆ°-self-attention"},{"key":"5-å¦‚ä½•é€‰æ‹©æ³¨å…¥ä½ç½®","href":"#5-å¦‚ä½•é€‰æ‹©æ³¨å…¥ä½ç½®","heading":3,"title":"5. å¦‚ä½•é€‰æ‹©æ³¨å…¥ä½ç½®ï¼Ÿ","children":[],"id":"5-å¦‚ä½•é€‰æ‹©æ³¨å…¥ä½ç½®"},{"key":"6-ç»ˆæå»ºè®®","href":"#6-ç»ˆæå»ºè®®","heading":3,"title":"6. ç»ˆæå»ºè®®","children":[],"id":"6-ç»ˆæå»ºè®®"}],"id":"q-ä½ è¯´éœ€å°†-lora-æ³¨å…¥åˆ°-unet-çš„-cross-attention-å±‚-lora-åªèƒ½åŠ åˆ°-crossattention-å±‚å—ä¸ºä»€ä¹ˆ"},{"key":"unet-ä»£ç ä¸­çš„-cross-attension-å±‚","href":"#unet-ä»£ç ä¸­çš„-cross-attension-å±‚","heading":2,"title":"UNet ä»£ç ä¸­çš„ Cross-Attension å±‚","children":[{"key":"1-æ¶æ„è®¾è®¡","href":"#1-æ¶æ„è®¾è®¡","heading":3,"title":"1. æ¶æ„è®¾è®¡","children":[],"id":"1-æ¶æ„è®¾è®¡"},{"key":"2-å‰å‘ä¼ æ’­è¿‡ç¨‹","href":"#2-å‰å‘ä¼ æ’­è¿‡ç¨‹","heading":3,"title":"2. å‰å‘ä¼ æ’­è¿‡ç¨‹","children":[],"id":"2-å‰å‘ä¼ æ’­è¿‡ç¨‹"},{"key":"3-å…³é”®åŒºåˆ«","href":"#3-å…³é”®åŒºåˆ«","heading":3,"title":"3. å…³é”®åŒºåˆ«","children":[],"id":"3-å…³é”®åŒºåˆ«"},{"key":"4-é…ç½®æ§åˆ¶","href":"#4-é…ç½®æ§åˆ¶","heading":3,"title":"4. é…ç½®æ§åˆ¶","children":[],"id":"4-é…ç½®æ§åˆ¶"},{"key":"layernorm-çš„å¿…è¦æ€§","href":"#layernorm-çš„å¿…è¦æ€§","heading":3,"title":"LayerNorm çš„å¿…è¦æ€§","children":[],"id":"layernorm-çš„å¿…è¦æ€§"},{"key":"layernorm-çš„ä½œç”¨","href":"#layernorm-çš„ä½œç”¨","heading":3,"title":"LayerNorm çš„ä½œç”¨","children":[],"id":"layernorm-çš„ä½œç”¨"}],"id":"unet-ä»£ç ä¸­çš„-cross-attension-å±‚"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2025-03-28-mqtt-protocol-principles-applications.md","pagePath":"/learn_from_ai/mqtt-protocol-principles-applications","slug":"mqtt-protocol-principles-applications"},"meta":{"content":"\n\u003e æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† MQTTï¼ˆMessage Queuing Telemetry Transportï¼‰åè®®çš„æ ¸å¿ƒå†…å®¹ã€å·¥ä½œåŸç†åŠå…¶åœ¨ç‰©è”ç½‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨åœºæ™¯ã€‚æ–‡ç« åˆ†æäº† MQTT åè®®çš„ç‰¹ç‚¹ã€æ¶ˆæ¯è´¨é‡ç­‰çº§ã€ä¸»é¢˜è®¾è®¡ä»¥åŠå®‰å…¨æœºåˆ¶ï¼Œå¸®åŠ©è¯»è€…å…¨é¢äº†è§£è¿™ä¸€è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…åè®®å¦‚ä½•æ”¯æŒèµ„æºå—é™è®¾å¤‡çš„å¯é é€šä¿¡ã€‚\n\n## Q: ä»€ä¹ˆæ˜¯ MQTT åè®®ï¼Ÿ\n\nMQTTï¼ˆMessage Queuing Telemetry Transportï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„ã€åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œä¸“ä¸ºå—é™è®¾å¤‡å’Œä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸å¯é çš„ç½‘ç»œç¯å¢ƒè®¾è®¡ã€‚å®ƒç”± Andy Stanford-Clarkï¼ˆIBMï¼‰å’Œ Arlen Nipperï¼ˆCirrus Linkï¼‰äº 1999 å¹´ä¸ºè¿æ¥çŸ³æ²¹ç®¡é“çš„ SCADA ç³»ç»Ÿè€Œå¼€å‘ï¼Œç°å·²å‘å±•æˆä¸ºç‰©è”ç½‘ï¼ˆIoTï¼‰é€šä¿¡çš„æ ‡å‡†åè®®ä¹‹ä¸€ã€‚\n\nMQTT åè®®å·¥ä½œåœ¨ TCP/IP åè®®æ ˆä¸Šï¼Œä½¿ç”¨äº†æœ€å°åŒ–çš„åè®®å¼€é”€ï¼Œå¯ä»¥åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šå®ç°é«˜æ•ˆé€šä¿¡ã€‚å®ƒé‡‡ç”¨å‘å¸ƒ/è®¢é˜…çš„æ¶ˆæ¯æ¨¡å¼ï¼Œè€Œéä¼ ç»Ÿçš„å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¨¡å¼ï¼Œè¿™ä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆæ„å»ºå¯æ‰©å±•çš„ç‰©è”ç½‘åº”ç”¨ã€‚\n\n## Q: MQTT åè®®çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ\n\nMQTT åè®®åŸºäºå‘å¸ƒ/è®¢é˜…çš„æ¶ˆæ¯æ¨¡å¼å·¥ä½œï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ï¼š\n\n1. **å®¢æˆ·ç«¯ï¼ˆClientï¼‰**ï¼šä»»ä½•è¿è¡Œ MQTT åº“å¹¶é€šè¿‡ç½‘ç»œè¿æ¥åˆ° MQTT æœåŠ¡å™¨çš„è®¾å¤‡ã€‚å®¢æˆ·ç«¯å¯ä»¥ï¼š\n\n   - å‘å¸ƒæ¶ˆæ¯åˆ°ç‰¹å®šä¸»é¢˜\n   - è®¢é˜…æ„Ÿå…´è¶£çš„ä¸»é¢˜ä»¥æ¥æ”¶æ¶ˆæ¯\n   - å–æ¶ˆè®¢é˜…ä¸»é¢˜\n   - ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥\n\n2. **ä»£ç†/æœåŠ¡å™¨ï¼ˆBrokerï¼‰**ï¼šè´Ÿè´£æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ï¼Œè¿‡æ»¤æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯åˆ†å‘ç»™è®¢é˜…ç‰¹å®šä¸»é¢˜çš„å®¢æˆ·ç«¯ã€‚ä»£ç†æ˜¯ MQTT ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±ã€‚\n\n3. **ä¸»é¢˜ï¼ˆTopicï¼‰**ï¼šæ¶ˆæ¯çš„åˆ†ç±»å’Œè·¯ç”±æœºåˆ¶ã€‚ä¸»é¢˜ä½¿ç”¨å±‚æ¬¡ç»“æ„ç»„ç»‡ï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼ˆå¦‚ `home/kitchen/temperature`ï¼‰ã€‚\n\n4. **æ¶ˆæ¯ï¼ˆMessageï¼‰**ï¼šåŒ…å«æœ‰æ•ˆè½½è·ï¼ˆpayloadï¼‰çš„æ•°æ®åŒ…ï¼Œç”±å‘å¸ƒè€…å‘é€ï¼Œé€šè¿‡ä»£ç†åˆ†å‘ç»™è®¢é˜…ç›¸åº”ä¸»é¢˜çš„å®¢æˆ·ç«¯ã€‚\n\nå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š\n\n1. å®¢æˆ·ç«¯è¿æ¥åˆ° MQTT ä»£ç†\n2. å®¢æˆ·ç«¯å¯ä»¥å‘å¸ƒæ¶ˆæ¯åˆ°ä¸€ä¸ªä¸»é¢˜\n3. å…¶ä»–å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…è¯¥ä¸»é¢˜\n4. ä»£ç†å°†æ¶ˆæ¯è½¬å‘ç»™æ‰€æœ‰è®¢é˜…è¯¥ä¸»é¢˜çš„å®¢æˆ·ç«¯\n5. å½“å®¢æˆ·ç«¯ä¸å†éœ€è¦è¿æ¥æ—¶ï¼Œå®ƒä¼šä¸ä»£ç†æ–­å¼€è¿æ¥\n\n## Q: MQTT åè®®çš„ä¸»è¦ç‰¹æ€§æœ‰å“ªäº›ï¼Ÿ\n\nMQTT åè®®å…·æœ‰ä»¥ä¸‹ä¸»è¦ç‰¹æ€§ï¼š\n\n1. **è½»é‡çº§**ï¼šåè®®å¤´éƒ¨æå°ï¼Œé€‚åˆåœ¨å¸¦å®½å—é™çš„ç½‘ç»œä¸Šä¼ è¾“ã€‚\n\n2. **å‘å¸ƒ/è®¢é˜…æ¨¡å¼**ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´å®Œå…¨è§£è€¦ï¼Œä¸éœ€è¦ç›´æ¥é€šä¿¡ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€‚\n\n3. **QoSï¼ˆQuality of Serviceï¼‰**ï¼šæä¾›ä¸‰ç§æ¶ˆæ¯ä¼ é€’è´¨é‡ç­‰çº§ï¼š\n\n   - QoS 0ï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰ï¼šæ¶ˆæ¯å‘é€åä¸ä¿è¯åˆ°è¾¾ï¼Œä¹Ÿä¸ä¼šé‡è¯•\n   - QoS 1ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰ï¼šä¿è¯æ¶ˆæ¯è‡³å°‘åˆ°è¾¾ä¸€æ¬¡ï¼Œå¯èƒ½é‡å¤\n   - QoS 2ï¼ˆæ°å¥½ä¸€æ¬¡ï¼‰ï¼šä¿è¯æ¶ˆæ¯åªåˆ°è¾¾ä¸€æ¬¡ï¼Œä¸ä¼šä¸¢å¤±ä¹Ÿä¸ä¼šé‡å¤\n\n4. **ä¿ç•™æ¶ˆæ¯**ï¼šä»£ç†å¯ä»¥ä¿å­˜ç‰¹å®šä¸»é¢˜çš„æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œæ–°è®¢é˜…è€…è¿æ¥æ—¶ç«‹å³æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯ã€‚\n\n5. **æŒä¹…ä¼šè¯**ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥åï¼Œä»£ç†å¯ä»¥ä¿å­˜å…¶è®¢é˜…ä¿¡æ¯å’Œæœªå‘é€çš„æ¶ˆæ¯ã€‚\n\n6. **é—å˜±æ¶ˆæ¯ï¼ˆLast Will and Testamentï¼‰**ï¼šå®¢æˆ·ç«¯æ„å¤–æ–­å¼€è¿æ¥æ—¶ï¼Œä»£ç†å¯ä»¥è‡ªåŠ¨å‘å¸ƒé¢„è®¾çš„æ¶ˆæ¯ã€‚\n\n7. **å°å‹å®¢æˆ·ç«¯ä»£ç **ï¼šå®¢æˆ·ç«¯å®ç°ç®€å•ï¼Œå ç”¨èµ„æºå°‘ï¼Œé€‚åˆåµŒå…¥å¼è®¾å¤‡ã€‚\n\n8. **å®‰å…¨æ€§**ï¼šæ”¯æŒ TLS/SSL åŠ å¯†å’Œç”¨æˆ·å/å¯†ç è®¤è¯ã€‚\n\n## Q: MQTT æœ‰å“ªäº›ç‰ˆæœ¬ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ\n\nMQTT åè®®ç»å†äº†å¤šæ¬¡è¿­ä»£ï¼Œä¸»è¦ç‰ˆæœ¬åŒ…æ‹¬ï¼š\n\n1. **MQTT 3.1**ï¼šæœ€æ—©çš„å¹¿æ³›ä½¿ç”¨ç‰ˆæœ¬ã€‚\n\n2. **MQTT 3.1.1**ï¼š2014 å¹´æˆä¸º OASIS æ ‡å‡†ï¼Œä¿®å¤äº†ä¸€äº›é—®é¢˜ï¼Œæ”¹è¿›äº†åè®®è§„èŒƒï¼Œæ˜¯å½“å‰åº”ç”¨æœ€å¹¿æ³›çš„ç‰ˆæœ¬ã€‚ä¸»è¦ç‰¹æ€§åŒ…æ‹¬ï¼š\n\n   - æ”¹è¿›è¿æ¥é”™è¯¯å¤„ç†\n   - å®šä¹‰äº†æ›´æ¸…æ™°çš„ä¼šè¯çŠ¶æ€è§„åˆ™\n   - æ”¯æŒ WebSocket ä¼ è¾“\n\n3. **MQTT 5.0**ï¼š2018 å¹´å‘å¸ƒçš„æœ€æ–°æ ‡å‡†ç‰ˆæœ¬ï¼Œå¼•å…¥äº†è®¸å¤šæ–°åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š\n\n   - æ¶ˆæ¯è¿‡æœŸæœºåˆ¶\n   - ä¸»é¢˜åˆ«åï¼ˆå‡å°‘ç½‘ç»œæµé‡ï¼‰\n   - ç”¨æˆ·å±æ€§ï¼ˆæ”¯æŒè‡ªå®šä¹‰å…ƒæ•°æ®ï¼‰\n   - å…±äº«è®¢é˜…ï¼ˆæ”¯æŒè´Ÿè½½å‡è¡¡ï¼‰\n   - è¯·æ±‚/å“åº”æ¨¡å¼æ”¯æŒ\n   - æœåŠ¡å™¨æ–­å¼€é‡å®šå‘\n   - å¢å¼ºçš„é”™è¯¯æŠ¥å‘Š\n   - æµé‡æ§åˆ¶æœºåˆ¶\n\n4. **MQTT-SNï¼ˆMQTT for Sensor Networksï¼‰**ï¼šä¸ºé TCP/IP ç½‘ç»œï¼ˆå¦‚ ZigBeeï¼‰è®¾è®¡çš„å˜ä½“ï¼Œé€‚ç”¨äºæ›´å—é™çš„è®¾å¤‡å’Œç½‘ç»œã€‚\n\nä¸»è¦åŒºåˆ«åœ¨äºåŠŸèƒ½é›†çš„ä¸°å¯Œç¨‹åº¦å’Œé€‚ç”¨åœºæ™¯ã€‚MQTT 5.0 æä¾›äº†æ›´å¤šçš„ä¼ä¸šçº§åŠŸèƒ½å’Œæ‰©å±•æ€§ï¼Œè€Œæ—©æœŸç‰ˆæœ¬åˆ™æ›´ç®€å•ï¼Œå®ç°æˆæœ¬æ›´ä½ã€‚\n\n## Q: MQTT åè®®çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ\n\nMQTT åè®®å¹¿æ³›åº”ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š\n\n1. **ç‰©è”ç½‘ï¼ˆIoTï¼‰è®¾å¤‡é€šä¿¡**ï¼š\n\n   - æ™ºèƒ½å®¶å±…è®¾å¤‡ï¼ˆæ™ºèƒ½ç¯æ³¡ã€æ’æ¸©å™¨ã€é—¨é”ç­‰ï¼‰\n   - ç©¿æˆ´è®¾å¤‡ä¸æ‰‹æœº/äº‘æœåŠ¡çš„é€šä¿¡\n   - è¿œç¨‹ä¼ æ„Ÿå™¨æ•°æ®æ”¶é›†ï¼ˆç¯å¢ƒç›‘æµ‹ã€å†œä¸šã€å·¥ä¸šç­‰ï¼‰\n\n2. **å·¥ä¸šç‰©è”ç½‘ï¼ˆIIoTï¼‰**ï¼š\n\n   - å·¥å‚è®¾å¤‡ç›‘æ§ä¸æ§åˆ¶\n   - é¢„æµ‹æ€§ç»´æŠ¤ç³»ç»Ÿ\n   - SCADAï¼ˆç›‘æ§ä¸æ•°æ®é‡‡é›†ï¼‰ç³»ç»Ÿ\n\n3. **æ±½è½¦ä¸äº¤é€šç³»ç»Ÿ**ï¼š\n\n   - è½¦è”ç½‘åº”ç”¨\n   - è½¦é˜Ÿç®¡ç†ç³»ç»Ÿ\n   - äº¤é€šç›‘æ§ç³»ç»Ÿ\n\n4. **èƒ½æºç®¡ç†**ï¼š\n\n   - æ™ºèƒ½ç”µç½‘\n   - èƒ½æºæ¶ˆè€—ç›‘æ§\n   - åˆ†å¸ƒå¼èƒ½æºç³»ç»Ÿ\n\n5. **åŒ»ç–—å¥åº·**ï¼š\n\n   - è¿œç¨‹æ‚£è€…ç›‘æ§\n   - åŒ»ç–—è®¾å¤‡äº’è¿\n   - å¥åº·æ•°æ®æ”¶é›†ä¸åˆ†æ\n\n6. **æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ**ï¼š\n\n   - ç§»åŠ¨åº”ç”¨æ¨é€é€šçŸ¥\n   - å®æ—¶é€šä¿¡åº”ç”¨\n   - ç¤¾äº¤åª’ä½“æ›´æ–°\n\n7. **é‡‘èæœåŠ¡**ï¼š\n\n   - å®æ—¶äº¤æ˜“æ•°æ®\n   - åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„æ¶ˆæ¯ä¼ é€’\n\n8. **ç”µå­å•†åŠ¡**ï¼š\n   - åº“å­˜ç®¡ç†\n   - ç‰©æµè·Ÿè¸ª\n   - è®¢å•å¤„ç†\n\nMQTT ç‰¹åˆ«é€‚åˆéœ€è¦å®æ—¶æ€§ã€å¯é æ€§åŒæ—¶åˆå—é™äºå¸¦å®½æˆ–è®¾å¤‡èƒ½åŠ›çš„åº”ç”¨åœºæ™¯ã€‚\n\n## Q: MQTT çš„å®‰å…¨æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ\n\nMQTT æä¾›å¤šå±‚å®‰å…¨æœºåˆ¶æ¥ä¿æŠ¤æ¶ˆæ¯ä¼ è¾“å’Œç³»ç»Ÿè®¿é—®ï¼š\n\n1. **ä¼ è¾“å±‚å®‰å…¨**ï¼š\n\n   - TLS/SSL åŠ å¯†ï¼šä¿æŠ¤å®¢æˆ·ç«¯å’Œä»£ç†ä¹‹é—´çš„é€šä¿¡\n   - è¯ä¹¦éªŒè¯ï¼šé˜²æ­¢ä¸­é—´äººæ”»å‡»\n\n2. **è®¤è¯æœºåˆ¶**ï¼š\n\n   - ç”¨æˆ·å/å¯†ç è®¤è¯ï¼šéªŒè¯å®¢æˆ·ç«¯èº«ä»½\n   - X.509 å®¢æˆ·ç«¯è¯ä¹¦ï¼šæä¾›æ›´å¼ºçš„èº«ä»½éªŒè¯\n   - OAuth æˆ–è‡ªå®šä¹‰è®¤è¯æœºåˆ¶ï¼ˆMQTT 5.0ï¼‰\n\n3. **æˆæƒæ§åˆ¶**ï¼š\n\n   - ä¸»é¢˜çº§åˆ«çš„è®¿é—®æ§åˆ¶ï¼šé™åˆ¶å®¢æˆ·ç«¯å¯ä»¥å‘å¸ƒ/è®¢é˜…çš„ä¸»é¢˜\n   - æƒé™ç®¡ç†ï¼šå®šä¹‰ä¸åŒç”¨æˆ·çš„è¯»å†™æƒé™\n\n4. **æœ‰æ•ˆè½½è·åŠ å¯†**ï¼š\n\n   - åº”ç”¨å±‚åŠ å¯†ï¼šå¯¹æ•æ„Ÿæ•°æ®è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†\n   - åŠ å¯†åº“é›†æˆï¼šå¦‚ AES ç”¨äºæ•°æ®åŠ å¯†\n\n5. **å®‰å…¨æœ€ä½³å®è·µ**ï¼š\n\n   - å”¯ä¸€å®¢æˆ·ç«¯ ID\n   - å®šæœŸè½®æ¢å‡­è¯\n   - æœ€å°æƒé™åŸåˆ™\n   - è¿æ¥ä¿æ´»å’Œè¶…æ—¶è®¾ç½®\n\n6. **MQTT ç‰¹æœ‰å®‰å…¨åŠŸèƒ½**ï¼š\n   - å®¢æˆ·ç«¯æ–­å¼€æ£€æµ‹ï¼ˆé€šè¿‡é—å˜±æ¶ˆæ¯ï¼‰\n   - ä¼šè¯æ¸…ç†æœºåˆ¶\n   - æ‹’ç»ä¸å®‰å…¨è¿æ¥çš„èƒ½åŠ›\n\nåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œé€šå¸¸éœ€è¦ç»“åˆå¤šç§å®‰å…¨æœºåˆ¶æ¥æ„å»ºå®Œæ•´çš„å®‰å…¨æ¡†æ¶ï¼Œæ ¹æ®åº”ç”¨çš„æ•æ„Ÿæ€§å’Œé£é™©çº§åˆ«é€‰æ‹©é€‚å½“çš„å®‰å…¨çº§åˆ«ã€‚\n\n## Q: ä¸»è¦çš„ MQTT ä»£ç†/æœåŠ¡å™¨å®ç°æœ‰å“ªäº›ï¼Ÿ\n\nå¸‚åœºä¸Šæœ‰å¤šç§ MQTT ä»£ç†å®ç°ï¼ŒåŒ…æ‹¬å¼€æºå’Œå•†ä¸šäº§å“ï¼š\n\n1. **å¼€æºä»£ç†**ï¼š\n\n   - **Mosquitto**ï¼šEclipse Foundation ç»´æŠ¤çš„è½»é‡çº§ä»£ç†ï¼Œæ˜¯æœ€æµè¡Œçš„å¼€æºå®ç°ä¹‹ä¸€\n   - **EMQ X**ï¼šé«˜åº¦å¯æ‰©å±•çš„ä¼ä¸šçº§ MQTT ä»£ç†ï¼Œæ”¯æŒç™¾ä¸‡çº§è¿æ¥\n   - **HiveMQ**ï¼šåŸºäº Java çš„ä»£ç†ï¼Œæä¾›å¼€æºç¤¾åŒºç‰ˆå’Œå•†ä¸šç‰ˆ\n   - **VerneMQ**ï¼šåŸºäº Erlang çš„é«˜æ€§èƒ½åˆ†å¸ƒå¼ MQTT ä»£ç†\n   - **RabbitMQ**ï¼šé€šè¿‡æ’ä»¶æ”¯æŒ MQTTï¼ŒåŒæ—¶æ”¯æŒå¤šç§æ¶ˆæ¯åè®®\n\n2. **äº‘æœåŠ¡æä¾›å•†çš„ MQTT æœåŠ¡**ï¼š\n\n   - **AWS IoT Core**ï¼šäºšé©¬é€Šäº‘çš„ MQTT æœåŠ¡\n   - **Azure IoT Hub**ï¼šå¾®è½¯äº‘çš„ IoT æ¶ˆæ¯æœåŠ¡ï¼Œæ”¯æŒ MQTT\n   - **Google Cloud IoT**ï¼šè°·æ­Œäº‘å¹³å°çš„ IoT æœåŠ¡\n   - **IBM Watson IoT Platform**ï¼šIBM çš„ IoT äº‘æœåŠ¡\n\n3. **åµŒå…¥å¼ä»£ç†**ï¼š\n   - **Mosquitto Embedded**ï¼šé€‚ç”¨äºåµŒå…¥å¼ç³»ç»Ÿçš„ Mosquitto ç‰ˆæœ¬\n   - **Moquette**ï¼šJava å®ç°çš„è½»é‡çº§ä»£ç†ï¼Œé€‚åˆåµŒå…¥åˆ°åº”ç”¨ä¸­\n\nè¿™äº›ä»£ç†åœ¨æ€§èƒ½ã€å¯æ‰©å±•æ€§ã€åŠŸèƒ½é›†å’Œæ˜“ç”¨æ€§æ–¹é¢æœ‰æ‰€ä¸åŒï¼Œé€‰æ‹©æ—¶éœ€è¦è€ƒè™‘å…·ä½“åº”ç”¨éœ€æ±‚ã€é¢„æœŸè¿æ¥æ•°é‡ã€æ¶ˆæ¯ååé‡ä»¥åŠéƒ¨ç½²ç¯å¢ƒç­‰å› ç´ ã€‚\n\n## Q: MQTT ä¸å…¶ä»–æ¶ˆæ¯åè®®ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼Ÿ\n\nMQTT ä¸å…¶ä»–æ¶ˆæ¯åè®®çš„å¯¹æ¯”ï¼š\n\n### ä¸ HTTP ç›¸æ¯”ï¼š\n\n**ä¼˜åŠ¿**ï¼š\n\n- æ›´å°çš„åè®®å¼€é”€ï¼Œé€‚åˆå¸¦å®½å—é™ç¯å¢ƒ\n- æ”¯æŒæ¨é€æ¨¡å‹ï¼Œå®æ—¶æ€§æ›´å¥½\n- æ›´ä½çš„åŠŸè€—ï¼Œé€‚åˆç”µæ± ä¾›ç”µè®¾å¤‡\n- æ”¯æŒæŒä¹…ä¼šè¯å’Œæ¶ˆæ¯è´¨é‡ä¿è¯\n\n**åŠ£åŠ¿**ï¼š\n\n- ä¸åƒ HTTP é‚£æ ·æ— å¤„ä¸åœ¨ï¼Œéœ€è¦ä¸“é—¨çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨\n- ç¼ºä¹ HTTP çš„å†…ç½®ç¼“å­˜å’Œä»£ç†æœºåˆ¶\n- åœ¨æµè§ˆå™¨ç¯å¢ƒéœ€è¦é€šè¿‡ WebSocket å®ç°\n\n### ä¸ CoAP ç›¸æ¯”ï¼š\n\n**ä¼˜åŠ¿**ï¼š\n\n- åŸºäº TCPï¼Œè¿æ¥å¯é æ€§æ›´é«˜\n- æ›´æˆç†Ÿçš„ç”Ÿæ€ç³»ç»Ÿå’Œå·¥å…·æ”¯æŒ\n- æ›´ä¸°å¯Œçš„ QoS é€‰é¡¹\n\n**åŠ£åŠ¿**ï¼š\n\n- CoAP åŸºäº UDPï¼Œåœ¨æŸäº›å—é™ç¯å¢ƒä¸­å¯èƒ½æ›´é«˜æ•ˆ\n- CoAP æ›´å¥½åœ°æ”¯æŒ RESTful æ¨¡å‹\n\n### ä¸ AMQP ç›¸æ¯”ï¼š\n\n**ä¼˜åŠ¿**ï¼š\n\n- æ›´è½»é‡çº§ï¼Œåè®®å¼€é”€æ›´å°\n- å®ç°æ›´ç®€å•ï¼Œé€‚åˆèµ„æºå—é™è®¾å¤‡\n- åŠŸè€—æ›´ä½\n\n**åŠ£åŠ¿**ï¼š\n\n- AMQP æä¾›æ›´ä¸°å¯Œçš„æ¶ˆæ¯è·¯ç”±åŠŸèƒ½\n- AMQP æœ‰æ›´å¼ºçš„äº‹åŠ¡æ”¯æŒ\n- AMQP æ”¯æŒæ›´å¤æ‚çš„é˜Ÿåˆ—æ¨¡å‹\n\n### ä¸ WebSocket ç›¸æ¯”ï¼š\n\n**ä¼˜åŠ¿**ï¼š\n\n- ä¸“ä¸ºæ¶ˆæ¯ä¼ é€’è®¾è®¡ï¼Œæœ‰å†…ç½®çš„å‘å¸ƒ/è®¢é˜…æ¨¡å‹\n- æ›´ä½çš„å¸¦å®½æ¶ˆè€—\n- æä¾›æ¶ˆæ¯è´¨é‡ä¿è¯\n\n**åŠ£åŠ¿**ï¼š\n\n- WebSocket æ˜¯æ›´é€šç”¨çš„åè®®ï¼Œå¯ä»¥ä¼ è¾“ä»»ä½•ç±»å‹çš„æ•°æ®\n- WebSocket åœ¨ Web ç¯å¢ƒä¸­æ›´åŸç”Ÿ\n\nMQTT çš„ä¸»è¦ä¼˜åŠ¿åœ¨äºå…¶è½»é‡çº§è®¾è®¡å’Œå¯¹èµ„æºå—é™ç¯å¢ƒçš„é€‚åº”æ€§ï¼Œç‰¹åˆ«é€‚åˆç‰©è”ç½‘åº”ç”¨ï¼›è€Œå…¶ä¸»è¦åŠ£åŠ¿æ˜¯åœ¨æŸäº›éœ€è¦å¤æ‚æ¶ˆæ¯è·¯ç”±æˆ–äº‹åŠ¡å¤„ç†çš„åœºæ™¯ä¸­åŠŸèƒ½ç›¸å¯¹ç®€å•ã€‚é€‰æ‹©åè®®æ—¶åº”æ ¹æ®å…·ä½“åº”ç”¨åœºæ™¯å’Œéœ€æ±‚è¿›è¡Œæƒè¡¡ã€‚\n\n## Q: è®¾è®¡åŸºäº MQTT çš„ç³»ç»Ÿæ—¶æœ‰å“ªäº›æœ€ä½³å®è·µï¼Ÿ\n\nè®¾è®¡å’Œå®ç°åŸºäº MQTT çš„ç³»ç»Ÿæ—¶ï¼Œä»¥ä¸‹æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©æé«˜ç³»ç»Ÿçš„å¯é æ€§ã€å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ï¼š\n\n### ä¸»é¢˜è®¾è®¡ï¼š\n\n1. **ä½¿ç”¨å±‚æ¬¡åŒ–ä¸»é¢˜ç»“æ„**ï¼šå¦‚ `location/device-type/device-id/measurement`\n2. **é¿å…è¿‡æ·±çš„ä¸»é¢˜å±‚æ¬¡**ï¼šè¿‡æ·±çš„å±‚æ¬¡ä¼šå¢åŠ å¤„ç†å¤æ‚æ€§\n3. **ä½¿ç”¨é€šé…ç¬¦è®¢é˜…è°¨æ…**ï¼šè¿‡äºå¹¿æ³›çš„é€šé…ç¬¦å¯èƒ½å¯¼è‡´æ¥æ”¶ä¸å¿…è¦çš„æ¶ˆæ¯\n4. **éµå¾ªä¸€è‡´çš„å‘½åçº¦å®š**ï¼šä½¿ä¸»é¢˜å‘½åç›´è§‚ä¸”å¯ç»´æŠ¤\n\n### QoS é€‰æ‹©ï¼š\n\n1. **ä¸ºå…³é”®æ•°æ®ä½¿ç”¨ QoS 1 æˆ– 2**ï¼šç¡®ä¿é‡è¦æ¶ˆæ¯çš„ä¼ é€’\n2. **éå…³é”®æ•°æ®å¯ä½¿ç”¨ QoS 0**ï¼šå‡å°‘ç½‘ç»œå¼€é”€ï¼Œæé«˜ååé‡\n3. **è€ƒè™‘ç”µæ± å¯¿å‘½å½±å“**ï¼šæ›´é«˜çš„ QoS æ„å‘³ç€æ›´å¤šçš„æ¶ˆæ¯äº¤æ¢å’Œæ›´é«˜çš„ç”µæ± æ¶ˆè€—\n\n### è¿æ¥ç®¡ç†ï¼š\n\n1. **å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶**ï¼šå¤„ç†ç½‘ç»œæ³¢åŠ¨\n2. **ä½¿ç”¨å”¯ä¸€çš„å®¢æˆ·ç«¯ ID**ï¼šé¿å…è¿æ¥å†²çª\n3. **è®¾ç½®åˆç†çš„ä¿æ´»é—´éš”**ï¼šå¹³è¡¡åŠæ—¶æ£€æµ‹æ–­å¼€è¿æ¥ä¸ç½‘ç»œå¼€é”€\n4. **åˆ©ç”¨\"é—å˜±\"æ¶ˆæ¯**ï¼šé€šçŸ¥å…¶ä»–è®¾å¤‡å®¢æˆ·ç«¯æ„å¤–æ–­å¼€\n\n### å®‰å…¨æœ€ä½³å®è·µï¼š\n\n1. **å§‹ç»ˆä½¿ç”¨ TLS/SSL**ï¼šåŠ å¯†æ‰€æœ‰é€šä¿¡\n2. **å®æ–½å¼ºè®¤è¯æœºåˆ¶**ï¼šè‡³å°‘ä½¿ç”¨ç”¨æˆ·å/å¯†ç ï¼Œæœ€å¥½ä½¿ç”¨è¯ä¹¦\n3. **å®æ–½ç»†ç²’åº¦æˆæƒ**ï¼šé™åˆ¶å®¢æˆ·ç«¯å¯ä»¥å‘å¸ƒ/è®¢é˜…çš„ä¸»é¢˜\n4. **åŠ å¯†æ•æ„Ÿè½½è·**ï¼šä¸ºæ•æ„Ÿæ•°æ®æ·»åŠ é¢å¤–çš„åŠ å¯†å±‚\n5. **å®šæœŸè½®æ¢å‡­è¯**ï¼šé™ä½å‡­è¯æ³„éœ²çš„é£é™©\n\n### æ€§èƒ½ä¸å¯æ‰©å±•æ€§ï¼š\n\n1. **ä¿æŒæ¶ˆæ¯çŸ­å°**ï¼šå‡å°‘å¸¦å®½ä½¿ç”¨\n2. **ä½¿ç”¨å…±äº«è®¢é˜…ï¼ˆMQTT 5.0ï¼‰**ï¼šå®ç°è´Ÿè½½å‡è¡¡\n3. **è€ƒè™‘æ¶ˆæ¯ä¿ç•™ç­–ç•¥**ï¼šæ˜æ™ºä½¿ç”¨ä¿ç•™æ¶ˆæ¯\n4. **è§„åˆ’ä»£ç†é›†ç¾¤**ï¼šå¯¹äºå¤§è§„æ¨¡éƒ¨ç½²ï¼Œä½¿ç”¨å¯é›†ç¾¤çš„ä»£ç†å®ç°\n5. **ç›‘æ§ç³»ç»Ÿæ€§èƒ½**ï¼šè·Ÿè¸ªè¿æ¥æ•°ã€æ¶ˆæ¯ååé‡ç­‰æŒ‡æ ‡\n\n### æ•°æ®è®¾è®¡ï¼š\n\n1. **ç»“æ„åŒ–æ¶ˆæ¯å†…å®¹**ï¼šä½¿ç”¨ JSONã€Protobuf ç­‰æ ‡å‡†æ ¼å¼\n2. **åŒ…å«æ—¶é—´æˆ³**ï¼šåŠ©äºæ•°æ®åˆ†æå’Œæ•…éšœæ’é™¤\n3. **è€ƒè™‘æ¶ˆæ¯ç‰ˆæœ¬æ§åˆ¶**ï¼šå…è®¸å®¢æˆ·ç«¯å’Œæ ¼å¼éšæ—¶é—´æ¼”åŒ–\n\n### æ•…éšœæ¢å¤ï¼š\n\n1. **å­˜å‚¨é‡è¦çŠ¶æ€**ï¼šä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨é‡æ–°è¿æ¥åæ¢å¤\n2. **å®ç°ç¦»çº¿ç¼“å†²**ï¼šä¸´æ—¶å­˜å‚¨æ— æ³•å‘é€çš„æ¶ˆæ¯\n3. **è®¾è®¡ä¼˜é›…çš„é™çº§ç­–ç•¥**ï¼šå½“éƒ¨åˆ†ç³»ç»Ÿä¸å¯ç”¨æ—¶ä¿æŒæ ¸å¿ƒåŠŸèƒ½\n\néµå¾ªè¿™äº›æœ€ä½³å®è·µå¯ä»¥å¸®åŠ©æ„å»ºæ›´åŠ å¥å£®ã€é«˜æ•ˆå’Œå®‰å…¨çš„ MQTT ç³»ç»Ÿï¼ŒåŒæ—¶ä¸ºæœªæ¥çš„æ‰©å±•å’Œç»´æŠ¤å¥ å®šåŸºç¡€ã€‚\n\n## Q: MQTT åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿å¦‚ä½•ï¼Ÿ\n\nMQTT åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿ä¸»è¦ä½“ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š\n\n1. **æ›´å¹¿æ³›çš„ MQTT 5.0 é‡‡ç”¨**ï¼š\n\n   - éšç€ç‰©è”ç½‘ç”Ÿæ€ç³»ç»Ÿçš„æˆç†Ÿï¼ŒMQTT 5.0 çš„é«˜çº§åŠŸèƒ½ï¼ˆå¦‚å…±äº«è®¢é˜…ã€æ¶ˆæ¯è¿‡æœŸç­‰ï¼‰å°†è·å¾—æ›´å¹¿æ³›çš„æ”¯æŒå’Œåº”ç”¨\n   - æ›´å¤šçš„ä»£ç†å’Œå®¢æˆ·ç«¯åº“å°†å®Œå…¨å®ç° MQTT 5.0 è§„èŒƒ\n\n2. **ä¸äº‘åŸç”ŸæŠ€æœ¯çš„æ·±åº¦é›†æˆ**ï¼š\n\n   - ä¸ Kubernetesã€æœåŠ¡ç½‘æ ¼ç­‰äº‘åŸç”ŸæŠ€æœ¯çš„æ— ç¼é›†æˆ\n   - åŸºäºå®¹å™¨çš„ MQTT ä»£ç†éƒ¨ç½²å°†æˆä¸ºæ ‡å‡†\n   - æ”¯æŒæ›´çµæ´»çš„æ°´å¹³æ‰©å±•å’Œè‡ªåŠ¨ä¼¸ç¼©èƒ½åŠ›\n\n3. **å¢å¼ºçš„å®‰å…¨æœºåˆ¶**ï¼š\n\n   - æ›´å¼ºå¤§çš„è®¤è¯æœºåˆ¶ï¼ŒåŒ…æ‹¬åŸºäºåŒºå—é“¾çš„å»ä¸­å¿ƒåŒ–èº«ä»½éªŒè¯\n   - æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶å’Œæƒé™ç®¡ç†\n   - ç«¯åˆ°ç«¯åŠ å¯†çš„æ ‡å‡†åŒ–å®ç°\n\n4. **è¾¹ç¼˜è®¡ç®—æ•´åˆ**ï¼š\n\n   - MQTT å°†æ›´ç´§å¯†åœ°ä¸è¾¹ç¼˜è®¡ç®—æ¡†æ¶é›†æˆ\n   - æ”¯æŒåœ¨ç½‘ç»œè¾¹ç¼˜è¿›è¡Œæ¶ˆæ¯è¿‡æ»¤ã€è½¬æ¢å’Œé¢„å¤„ç†\n   - å‡å°‘äº‘-è¾¹ç¼˜é€šä¿¡å»¶è¿Ÿå’Œå¸¦å®½ä½¿ç”¨\n\n5. **è·¨åè®®å…¼å®¹æ€§**ï¼š\n\n   - ä¸å…¶ä»–ç‰©è”ç½‘åè®®ï¼ˆå¦‚ AMQPã€HTTP/2ã€gRPCï¼‰çš„æ— ç¼æ¡¥æ¥\n   - ç»Ÿä¸€çš„ç‰©è”ç½‘æ¶ˆæ¯ç½‘å…³ï¼Œæ”¯æŒå¤šåè®®è½¬æ¢\n\n6. **å®æ—¶åˆ†æä¸æœºå™¨å­¦ä¹ é›†æˆ**ï¼š\n\n   - MQTT ä¸æµå¤„ç†å’Œå®æ—¶åˆ†æå¹³å°çš„ç´§å¯†é›†æˆ\n   - æ”¯æŒè®¾å¤‡é¥æµ‹æ•°æ®çš„å³æ—¶åˆ†æå’Œæœºå™¨å­¦ä¹ æ¨¡å‹åº”ç”¨\n\n7. **æ›´é«˜æ•ˆçš„èµ„æºåˆ©ç”¨**ï¼š\n\n   - æ›´ä¼˜åŒ–çš„åè®®å®ç°ï¼Œè¿›ä¸€æ­¥é™ä½å¸¦å®½å’Œèµ„æºæ¶ˆè€—\n   - é’ˆå¯¹è¶…ä½åŠŸè€—è®¾å¤‡çš„ä¸“ç”¨ä¼˜åŒ–\n\n8. **æ ‡å‡†åŒ–çš„è¯­ä¹‰äº’æ“ä½œæ€§**ï¼š\n\n   - æ•°æ®æ¨¡å‹å’Œå…ƒæ•°æ®æ ‡å‡†åŒ–\n   - åŸºäº MQTT çš„è®¾å¤‡ç®¡ç†å’Œè‡ªåŠ¨é…ç½®æ ‡å‡†\n\n9. **å·¥ä¸šç‰©è”ç½‘ä¸“ç”¨æ‰©å±•**ï¼š\n\n   - é’ˆå¯¹å·¥ä¸šæ§åˆ¶ç³»ç»Ÿçš„ç¡®å®šæ€§å’Œå®æ—¶æ€§æ‰©å±•\n   - ä¸ OPC UA ç­‰å·¥ä¸šæ ‡å‡†çš„ååŒå·¥ä½œ\n\n10. **æ›´ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿå·¥å…·**ï¼š\n    - æ›´å¼ºå¤§çš„ç›‘æ§ã€è°ƒè¯•å’Œå¯è§†åŒ–å·¥å…·\n    - è·¨å¹³å°å’Œè·¨è¯­è¨€çš„å¼€å‘æ¡†æ¶\n\néšç€ç‰©è”ç½‘å’Œè¾¹ç¼˜è®¡ç®—çš„æŒç»­å‘å±•ï¼ŒMQTT æœ‰æœ›ä¿æŒå…¶ä½œä¸ºè½»é‡çº§é€šä¿¡åè®®çš„ä¸»å¯¼åœ°ä½ï¼ŒåŒæ—¶ä¸æ–­æ¼”åŒ–ä»¥æ»¡è¶³æ–°å…´ç”¨ä¾‹å’ŒæŠ€æœ¯è¦æ±‚çš„éœ€æ±‚ã€‚\n\n## Q: è¯¦ç»†ä»‹ç» MQTT åè®®çš„å†…å®¹ï¼ŒåŸç†ï¼Œåº”ç”¨åœºæ™¯ï¼Œä»¥åŠåº”ç”¨ MQTT åè®®æ—¶è¦æ³¨æ„çš„äº‹é¡¹\n\n\u003e [!reasoning]-\n\u003e å—¯ï¼Œç”¨æˆ·è®©æˆ‘è¯¦ç»†ä»‹ç»ä¸€ä¸‹ MQTT åè®®çš„å†…å®¹ã€åŸç†ã€åº”ç”¨åœºæ™¯ä»¥åŠä½¿ç”¨æ—¶çš„æ³¨æ„äº‹é¡¹ã€‚æˆ‘éœ€è¦å…ˆå›å¿†ä¸€ä¸‹ MQTT çš„åŸºç¡€çŸ¥è¯†ï¼Œç¡®ä¿è‡ªå·±ç†è§£æ­£ç¡®ã€‚é¦–å…ˆï¼ŒMQTT æ˜¯ Message Queuing Telemetry Transport çš„ç¼©å†™ï¼Œæ˜¯ä¸€ç§è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œå¸¸ç”¨äºç‰©è”ç½‘è®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚\n\u003e\n\u003e å†…å®¹æ–¹é¢ï¼Œåº”è¯¥åŒ…æ‹¬åè®®çš„åŸºæœ¬æ¦‚å¿µï¼Œæ¯”å¦‚å®ƒæ˜¯åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å‹çš„ï¼Œä½¿ç”¨çš„ TCP/IP åè®®ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒã€‚ç„¶åï¼Œå¯èƒ½éœ€è¦æåˆ° MQTT çš„ä¸åŒç‰ˆæœ¬ï¼Œæ¯”å¦‚ 3.1.1 å’Œ 5.0ï¼Œä»¥åŠå®ƒä»¬çš„ä¸€äº›æ”¹è¿›ã€‚\n\u003e\n\u003e åŸç†éƒ¨åˆ†ï¼Œéœ€è¦è§£é‡Šå‘å¸ƒ/è®¢é˜…æœºåˆ¶çš„å·¥ä½œæµç¨‹ï¼Œå®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’ã€‚æ¯”å¦‚å®¢æˆ·ç«¯è¿æ¥åˆ°ä»£ç†åï¼Œå¯ä»¥å‘å¸ƒæ¶ˆæ¯åˆ°ç‰¹å®šçš„ä¸»é¢˜ï¼Œæˆ–è€…è®¢é˜…ä¸»é¢˜æ¥æ¥æ”¶æ¶ˆæ¯ã€‚è¿˜æœ‰ QoS ç­‰çº§ï¼Œä¸‰ä¸ªçº§åˆ«çš„æœåŠ¡è´¨é‡ï¼Œç¡®ä¿æ¶ˆæ¯ä¼ é€’çš„å¯é æ€§ã€‚å¦å¤–ï¼Œä¿ç•™æ¶ˆæ¯å’Œé—å˜±æ¶ˆæ¯ä¹Ÿæ˜¯é‡è¦çš„æ¦‚å¿µï¼Œéœ€è¦è¯¦ç»†è¯´æ˜ã€‚\n\u003e\n\u003e åº”ç”¨åœºæ™¯çš„è¯ï¼Œç‰©è”ç½‘è‚¯å®šæ˜¯ä¸»è¦çš„ï¼Œæ¯”å¦‚æ™ºèƒ½å®¶å±…ã€å·¥ä¸šä¼ æ„Ÿå™¨ã€è½¦è”ç½‘ç­‰ã€‚å¦å¤–ï¼Œç§»åŠ¨åº”ç”¨å’Œå³æ—¶é€šè®¯å¯èƒ½ä¹Ÿä¼šç”¨åˆ° MQTTï¼Œå› ä¸ºå®ƒåœ¨ä½åŠŸè€—å’Œå¼±ç½‘ç»œæ¡ä»¶ä¸‹çš„è¡¨ç°ä¸é”™ã€‚è¿˜æœ‰å¯èƒ½éœ€è¦æåˆ°è¿œç¨‹ç›‘æ§ã€åŒ»ç–—è®¾å¤‡ç­‰åœºæ™¯ã€‚\n\u003e\n\u003e æ³¨æ„äº‹é¡¹æ–¹é¢ï¼Œå®‰å…¨æ€§æ˜¯é¦–è¦çš„ï¼Œæ¯”å¦‚ä½¿ç”¨ TLS åŠ å¯†ï¼Œå®¢æˆ·ç«¯è®¤è¯æœºåˆ¶ã€‚ç„¶åæ˜¯ QoS çš„é€‰æ‹©ï¼Œä¸åŒçš„ç­‰çº§å¯¹æ€§èƒ½çš„å½±å“ï¼Œéœ€è¦æ ¹æ®åœºæ™¯æ¥æƒè¡¡ã€‚ä¸»é¢˜è®¾è®¡éœ€è¦é¿å…è¿‡äºå¤æ‚ï¼Œé˜²æ­¢æ€§èƒ½é—®é¢˜ã€‚è¿˜æœ‰å¿ƒè·³æœºåˆ¶å’Œä¼šè¯ä¿æŒï¼Œç¡®ä¿è¿æ¥çš„ç¨³å®šæ€§ã€‚æ­¤å¤–ï¼Œä»£ç†æœåŠ¡å™¨çš„æ€§èƒ½å’Œæ‰©å±•æ€§ä¹Ÿè¦è€ƒè™‘ï¼Œé¿å…æˆä¸ºç“¶é¢ˆã€‚\n\u003e\n\u003e ç”¨æˆ·å¯èƒ½å¯¹ MQTT çš„å…·ä½“å®ç°ç»†èŠ‚ä¸å¤ªæ¸…æ¥šï¼Œæ¯”å¦‚å¦‚ä½•é€‰æ‹© QoS ç­‰çº§ï¼Œæˆ–è€…å¦‚ä½•å¤„ç†æ¶ˆæ¯çš„æŒä¹…åŒ–ã€‚æ­¤å¤–ï¼Œç”¨æˆ·å¯èƒ½æƒ³çŸ¥é“åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šå¦‚ä½•ä¼˜åŒ–ä½¿ç”¨ MQTTï¼Œæ¯”å¦‚å‡å°‘æ•°æ®åŒ…å¤§å°ï¼Œä½¿ç”¨çŸ­ä¸»é¢˜åç­‰ã€‚å¯èƒ½è¿˜éœ€è¦æ¯”è¾ƒ MQTT å’Œå…¶ä»–åè®®å¦‚ HTTPã€CoAP çš„åŒºåˆ«ï¼Œä½†ç”¨æˆ·æ²¡æåˆ°è¿™ç‚¹ï¼Œæš‚æ—¶ä¸ç”¨å±•å¼€ã€‚\n\u003e\n\u003e è¦ç¡®ä¿è¦†ç›–æ‰€æœ‰ç”¨æˆ·æåˆ°çš„ç‚¹ï¼ŒåŒæ—¶ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡ŠæŠ€æœ¯æœ¯è¯­ï¼Œæ¯”å¦‚ QoS ç­‰çº§çš„å…·ä½“å«ä¹‰å’Œåº”ç”¨åœºæ™¯ã€‚æ¯”å¦‚ QoS 0 é€‚åˆä¼ æ„Ÿå™¨æ•°æ®ï¼Œä¸¢å¤±ä¸€ä¸¤æ¡æ²¡å…³ç³»ï¼›è€Œ QoS 2 é€‚åˆå…³é”®æŒ‡ä»¤ï¼Œå¿…é¡»ç¡®ä¿é€è¾¾ã€‚\n\u003e\n\u003e å¯èƒ½éœ€è¦æé†’ç”¨æˆ·æ³¨æ„åè®®ç‰ˆæœ¬çš„é€‰æ‹©ï¼Œæ¯”å¦‚ MQTT 5.0 çš„æ–°åŠŸèƒ½å¦‚åŸå› ç ã€å…±äº«è®¢é˜…ç­‰ï¼Œæ˜¯å¦é€‚ç”¨äºä»–ä»¬çš„é¡¹ç›®ã€‚å¦å¤–ï¼Œç½‘ç»œä¸ç¨³å®šæ—¶çš„å¤„ç†ï¼Œæ¯”å¦‚é—å˜±æ¶ˆæ¯çš„è®¾ç½®ï¼Œå¯ä»¥åœ¨è®¾å¤‡æ„å¤–æ–­å¼€æ—¶é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯ã€‚\n\u003e\n\u003e è¿˜è¦è€ƒè™‘ç”¨æˆ·çš„å®é™…åº”ç”¨ï¼Œæ¯”å¦‚å¦‚æœä»–ä»¬å¼€å‘æ™ºèƒ½å®¶å±…ç³»ç»Ÿï¼Œéœ€è¦æ³¨æ„ä¸»é¢˜å‘½åè§„èŒƒï¼Œé¿å…å†²çªï¼Œä½¿ç”¨å±‚æ¬¡ç»“æ„æ¥ç®¡ç†è®¾å¤‡ã€‚åŒæ—¶ï¼Œå®‰å…¨æ€§æ–¹é¢ï¼Œé™¤äº†åŠ å¯†ï¼Œè¿˜è¦æ³¨æ„å®¢æˆ·ç«¯ ID çš„ç®¡ç†ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚\n\u003e\n\u003e æœ€åï¼Œæ³¨æ„äº‹é¡¹éƒ¨åˆ†è¦å¼ºè°ƒå®é™…éƒ¨ç½²ä¸­çš„é—®é¢˜ï¼Œæ¯”å¦‚ä»£ç†æœåŠ¡å™¨çš„é€‰æ‹©ï¼ˆMosquittoã€EMQX ç­‰ï¼‰ï¼Œæ€§èƒ½è°ƒä¼˜ï¼Œä»¥åŠç›‘æ§å’Œæ—¥å¿—è®°å½•çš„é‡è¦æ€§ï¼Œå¸®åŠ©ç”¨æˆ·é¿å…å¸¸è§é™·é˜±ã€‚\n\n### MQTT åè®®è¯¦è§£\n\n**MQTT**ï¼ˆMessage Queuing Telemetry Transportï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„**å‘å¸ƒ/è®¢é˜…æ¨¡å¼**æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œä¸“ä¸ºä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸ç¨³å®šçš„ç½‘ç»œç¯å¢ƒè®¾è®¡ï¼Œå¹¿æ³›åº”ç”¨äºç‰©è”ç½‘ï¼ˆIoTï¼‰å’Œç§»åŠ¨è®¾å¤‡é€šä¿¡ã€‚\n\n---\n\n#### **ä¸€ã€åè®®å†…å®¹**\n\n1. **æ ¸å¿ƒç‰¹æ€§**ï¼š\n\n   - **è½»é‡çº§**ï¼šåè®®å¤´æœ€å°ä»… 2 å­—èŠ‚ï¼Œé€‚åˆèµ„æºå—é™çš„è®¾å¤‡ã€‚\n   - **åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å‹**ï¼šè§£è€¦æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œé€šè¿‡ä¸»é¢˜ï¼ˆTopicï¼‰è·¯ç”±æ¶ˆæ¯ã€‚\n   - **æ”¯æŒå¤šç§ QoS ç­‰çº§**ï¼šæä¾›ä¸‰ç§æ¶ˆæ¯ä¼ è¾“è´¨é‡ä¿è¯ï¼ˆQoS 0/1/2ï¼‰ã€‚\n   - **ä½åŠŸè€—**ï¼šé€‚åˆç”µæ± ä¾›ç”µçš„ç‰©è”ç½‘è®¾å¤‡ã€‚\n   - **è·¨å¹³å°æ€§**ï¼šåŸºäº TCP/IP åè®®ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œå¹³å°ã€‚\n\n2. **åè®®ç‰ˆæœ¬**ï¼š\n\n   - **MQTT 3.1.1**ï¼ˆä¸»æµç‰ˆæœ¬ï¼‰ï¼šæ ‡å‡†åŒ–åè®®ï¼Œå¹¿æ³›å…¼å®¹ã€‚\n   - **MQTT 5.0**ï¼ˆæ–°ç‰ˆæœ¬ï¼‰ï¼šæ–°å¢ä¼šè¯è¿‡æœŸã€åŸå› ç ã€å…±äº«è®¢é˜…ç­‰åŠŸèƒ½ã€‚\n\n3. **æ ¸å¿ƒç»„ä»¶**ï¼š\n   - **Brokerï¼ˆä»£ç†æœåŠ¡å™¨ï¼‰**ï¼šè´Ÿè´£æ¶ˆæ¯è·¯ç”±å’Œå®¢æˆ·ç«¯ç®¡ç†ï¼ˆå¦‚ Mosquittoã€EMQXï¼‰ã€‚\n   - **Clientï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼šå‘å¸ƒæˆ–è®¢é˜…æ¶ˆæ¯çš„è®¾å¤‡æˆ–åº”ç”¨ã€‚\n   - **Topicï¼ˆä¸»é¢˜ï¼‰**ï¼šåˆ†å±‚ç»“æ„ï¼ˆå¦‚`home/room1/temperature`ï¼‰ï¼Œæ”¯æŒé€šé…ç¬¦ï¼ˆ`+`å’Œ`#`ï¼‰ã€‚\n\n---\n\n#### **äºŒã€å·¥ä½œåŸç†**\n\n1. **è¿æ¥ä¸ä¼šè¯**ï¼š\n\n   - å®¢æˆ·ç«¯é€šè¿‡`CONNECT`æŠ¥æ–‡ä¸ Broker å»ºç«‹è¿æ¥ï¼Œæ”¯æŒç”¨æˆ·å/å¯†ç è®¤è¯ã€‚\n   - å¯è®¾ç½®`Clean Session`æ ‡å¿—å†³å®šæ˜¯å¦ä¿ç•™å†å²ä¼šè¯ã€‚\n\n2. **å‘å¸ƒä¸è®¢é˜…**ï¼š\n\n   - **è®¢é˜…**ï¼šå®¢æˆ·ç«¯å‘é€`SUBSCRIBE`æŠ¥æ–‡è®¢é˜…ç‰¹å®šä¸»é¢˜ã€‚\n   - **å‘å¸ƒ**ï¼šå®¢æˆ·ç«¯å‘ä¸»é¢˜å‘é€`PUBLISH`æŠ¥æ–‡ï¼ŒBroker å°†æ¶ˆæ¯è½¬å‘ç»™æ‰€æœ‰è®¢é˜…è€…ã€‚\n\n3. **QoS ç­‰çº§**ï¼š\n\n   - **QoS 0ï¼ˆæœ€å¤šä¸€æ¬¡ï¼‰**ï¼šæ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼Œé€‚ç”¨äºéå…³é”®æ•°æ®ï¼ˆå¦‚ä¼ æ„Ÿå™¨è¯»æ•°ï¼‰ã€‚\n   - **QoS 1ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰**ï¼šç¡®ä¿æ¶ˆæ¯åˆ°è¾¾ï¼Œä½†å¯èƒ½é‡å¤ï¼ˆéœ€ä¸šåŠ¡å»é‡ï¼‰ã€‚\n   - **QoS 2ï¼ˆæ°å¥½ä¸€æ¬¡ï¼‰**ï¼šé€šè¿‡å››æ¬¡æ¡æ‰‹ä¿è¯æ¶ˆæ¯ç²¾ç¡®ä¼ è¾“ï¼Œå¼€é”€æœ€å¤§ã€‚\n\n4. **å…¶ä»–æœºåˆ¶**ï¼š\n   - **ä¿ç•™æ¶ˆæ¯ï¼ˆRetained Messageï¼‰**ï¼šBroker ä¸ºæ¯ä¸ªä¸»é¢˜ä¿å­˜æœ€æ–°ä¸€æ¡æ¶ˆæ¯ï¼Œä¾›æ–°è®¢é˜…è€…è·å–ã€‚\n   - **é—å˜±æ¶ˆæ¯ï¼ˆLast Willï¼‰**ï¼šå®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€æ—¶ï¼ŒBroker è‡ªåŠ¨å‘å¸ƒé¢„è®¾æ¶ˆæ¯ã€‚\n\n---\n\n#### **ä¸‰ã€å…¸å‹åº”ç”¨åœºæ™¯**\n\n1. **ç‰©è”ç½‘ï¼ˆIoTï¼‰**ï¼š\n\n   - æ™ºèƒ½å®¶å±…ï¼ˆè®¾å¤‡çŠ¶æ€åŒæ­¥ï¼‰ã€å·¥ä¸šä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ã€‚\n   - è¿œç¨‹ç›‘æ§ï¼ˆå¦‚å†œä¸šæ¸©æ¹¿åº¦ç›‘æµ‹ã€èƒ½æºç®¡ç†ï¼‰ã€‚\n\n2. **ç§»åŠ¨åº”ç”¨**ï¼š\n\n   - å³æ—¶é€šè®¯ï¼ˆå¦‚èŠå¤©æ¶ˆæ¯æ¨é€ï¼‰ã€‚\n   - ç§»åŠ¨è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥ï¼ˆå¦‚ GPS ä½ç½®æ›´æ–°ï¼‰ã€‚\n\n3. **è½¦è”ç½‘**ï¼š\n\n   - è½¦è¾†çŠ¶æ€å®æ—¶ä¸ŠæŠ¥ï¼ˆç”µæ± ç”µé‡ã€æ•…éšœé¢„è­¦ï¼‰ã€‚\n   - è¿œç¨‹æ§åˆ¶ï¼ˆè½¦é—¨è§£é”ã€ç©ºè°ƒè°ƒèŠ‚ï¼‰ã€‚\n\n4. **åŒ»ç–—å¥åº·**ï¼š\n   - å¯ç©¿æˆ´è®¾å¤‡æ•°æ®ä¼ è¾“ï¼ˆå¿ƒç‡ã€æ­¥æ•°ï¼‰ã€‚\n   - è¿œç¨‹åŒ»ç–—è®¾å¤‡ç›‘æ§ã€‚\n\n---\n\n#### **å››ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹**\n\n1. **å®‰å…¨æ€§**ï¼š\n\n   - å¯ç”¨ TLS åŠ å¯†ï¼ˆMQTT over SSL/TLSï¼‰é˜²æ­¢æ•°æ®çªƒå¬ã€‚\n   - ä½¿ç”¨å®¢æˆ·ç«¯ ID/è¯ä¹¦è®¤è¯ï¼Œé¿å…æœªæˆæƒè®¿é—®ã€‚\n   - é¿å…æ•æ„Ÿä¿¡æ¯é€šè¿‡æ˜æ–‡ä¼ è¾“ã€‚\n\n2. **ä¸»é¢˜è®¾è®¡**ï¼š\n\n   - é‡‡ç”¨åˆ†å±‚ç»“æ„ï¼ˆå¦‚`country/city/deviceID`ï¼‰ï¼Œé¿å…ä¸»é¢˜çˆ†ç‚¸ã€‚\n   - æ…ç”¨é€šé…ç¬¦`#`ï¼Œé˜²æ­¢è®¢é˜…è¿‡å¤šæ— å…³æ¶ˆæ¯ã€‚\n\n3. **QoS é€‰æ‹©**ï¼š\n\n   - æ ¹æ®åœºæ™¯å¹³è¡¡å¯é æ€§ä¸æ€§èƒ½ï¼šQoS 2 å¯èƒ½å¯¼è‡´é«˜å»¶è¿Ÿã€‚\n   - è‹¥ç½‘ç»œç¨³å®šï¼Œä¼˜å…ˆä½¿ç”¨ QoS 0 æˆ– 1ã€‚\n\n4. **èµ„æºç®¡ç†**ï¼š\n\n   - è®¾å¤‡ç«¯ä¼˜åŒ–ï¼šç¼©çŸ­å¿ƒè·³é—´éš”ï¼ˆ`Keep Alive`ï¼‰ä»¥èŠ‚çœç”µé‡ã€‚\n   - Broker ç«¯é…ç½®è¿æ¥æ•°å’Œæ¶ˆæ¯ååé‡ä¸Šé™ï¼Œé˜²æ­¢è¿‡è½½ã€‚\n\n5. **ä¼šè¯ä¸æŒä¹…åŒ–**ï¼š\n\n   - éæŒä¹…ä¼šè¯ï¼ˆ`Clean Session=1`ï¼‰é€‚ç”¨äºä¸´æ—¶è®¾å¤‡ã€‚\n   - æŒä¹…ä¼šè¯éœ€ Broker æ”¯æŒæ¶ˆæ¯å­˜å‚¨ï¼Œé¿å…æ•°æ®ä¸¢å¤±ã€‚\n\n6. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼š\n   - æ–°é¡¹ç›®ä¼˜å…ˆé€‰æ‹© MQTT 5.0ï¼ˆåŠŸèƒ½æ›´ä¸°å¯Œï¼‰ã€‚\n   - æ—§è®¾å¤‡å¯èƒ½éœ€è¦é™çº§é€‚é… MQTT 3.1.1ã€‚\n\n---\n\n#### **äº”ã€å¸¸è§é—®é¢˜ä¸è§£å†³**\n\n- **æ¶ˆæ¯å †ç§¯**ï¼šBroker å†…å­˜ä¸è¶³æ—¶ï¼Œå¯å¯ç”¨æ¶ˆæ¯æŒä¹…åŒ–æˆ–é™åˆ¶ QoSã€‚\n- **ç½‘ç»œæ³¢åŠ¨**ï¼šè®¾ç½®åˆç†çš„`Keep Alive`æ—¶é—´ï¼ˆå¦‚ 60 ç§’ï¼‰ï¼ŒåŠæ—¶æ£€æµ‹æ–­çº¿ã€‚\n- **ä¸»é¢˜å†²çª**ï¼šé€šè¿‡å‘½åç©ºé—´éš”ç¦»ä¸åŒä¸šåŠ¡ï¼ˆå¦‚`companyA/device1`ï¼‰ã€‚\n\n---\n\n**æ€»ç»“**ï¼šMQTT å‡­å€Ÿå…¶è½»é‡ã€é«˜æ•ˆå’Œçµæ´»æ€§ï¼Œæˆä¸ºç‰©è”ç½‘é€šä¿¡çš„é¦–é€‰åè®®ã€‚åˆç†è®¾è®¡ä¸»é¢˜ã€é€‰æ‹© QoS ç­‰çº§ï¼Œå¹¶ç»“åˆå®‰å…¨æªæ–½ï¼Œå¯å……åˆ†å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚\n\n## Q: QoS æ˜¯ä¸ªä»€ä¹ˆæŒ‡æ ‡ï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å¥½çš„ï¼Œç”¨æˆ·ç°åœ¨é—®çš„æ˜¯ QoS æ˜¯ä»€ä¹ˆæŒ‡æ ‡ï¼Œä»¥åŠå¦‚ä½•ä¿è¯ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦å›å¿†ä¹‹å‰å…³äº MQTT çš„è®¨è®ºï¼Œç‰¹åˆ«æ˜¯å…³äº QoS çš„éƒ¨åˆ†ã€‚ä¹‹å‰å·²ç»è¯¦ç»†ä»‹ç»äº† MQTT åè®®çš„å†…å®¹ï¼ŒåŒ…æ‹¬ QoS çš„ä¸‰ä¸ªç­‰çº§ï¼Œå¯èƒ½ç”¨æˆ·ç°åœ¨æƒ³æ›´æ·±å…¥äº†è§£ QoS çš„æ¦‚å¿µå’Œå®ç°æœºåˆ¶ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œç”¨æˆ·å¯èƒ½å¯¹ QoS çš„å®šä¹‰ä¸å¤ªæ¸…æ¥šï¼Œè™½ç„¶ä¹‹å‰æåˆ°è¿‡ä¸‰ä¸ªç­‰çº§ï¼Œä½†éœ€è¦æ›´æ˜ç¡®åœ°è§£é‡Š QoS æ˜¯ä»€ä¹ˆï¼Œå…¨ç§°æ˜¯ä»€ä¹ˆã€‚QoS ä»£è¡¨æœåŠ¡è´¨é‡ï¼ˆQuality of Serviceï¼‰ï¼Œåœ¨ MQTT ä¸­ç”¨æ¥å®šä¹‰æ¶ˆæ¯ä¼ é€’çš„å¯é æ€§çº§åˆ«ã€‚è¿™ä¸€ç‚¹éœ€è¦å…ˆæ˜ç¡®ã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œç”¨æˆ·æƒ³çŸ¥é“å¦‚ä½•ä¿è¯ä¸åŒçš„ QoS ç­‰çº§ã€‚éœ€è¦åˆ†åˆ«è§£é‡Šæ¯ä¸ªç­‰çº§çš„å®ç°æœºåˆ¶ã€‚æ¯”å¦‚ QoS 0 æ˜¯â€œæœ€å¤šä¸€æ¬¡â€ï¼Œå®ƒåªæ˜¯å‘é€ä¸€æ¬¡ï¼Œä¸éœ€è¦ç¡®è®¤ï¼Œé€‚ç”¨äºä¸é‡è¦çš„æ•°æ®ã€‚QoS 1 æ˜¯â€œè‡³å°‘ä¸€æ¬¡â€ï¼Œéœ€è¦ç¡®è®¤ï¼Œå‘é€æ–¹ä¼šå­˜å‚¨æ¶ˆæ¯ç›´åˆ°æ”¶åˆ°ç¡®è®¤ï¼Œä½†å¯èƒ½å¯¼è‡´é‡å¤ã€‚QoS 2 æ˜¯â€œæ°å¥½ä¸€æ¬¡â€ï¼Œé€šè¿‡å››æ¬¡æ¡æ‰‹ç¡®ä¿æ¶ˆæ¯ä¸é‡å¤ä¸ä¸¢å¤±ã€‚\n\u003e\n\u003e ç„¶åï¼Œç”¨æˆ·å¯èƒ½çš„åº”ç”¨åœºæ™¯ä¼šå½±å“ä»–ä»¬é€‰æ‹© QoS ç­‰çº§ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦è¡¥å……ä¸åŒç­‰çº§é€‚ç”¨çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¼ æ„Ÿå™¨æ•°æ®ç”¨ QoS 0ï¼Œæ§åˆ¶æŒ‡ä»¤ç”¨ QoS 1 æˆ– 2ã€‚åŒæ—¶ï¼Œç”¨æˆ·å¯èƒ½å…³å¿ƒå®é™…åº”ç”¨ä¸­å¦‚ä½•é…ç½®è¿™äº›ç­‰çº§ï¼Œéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œæ¯”å¦‚ç½‘ç»œçŠ¶å†µã€èµ„æºæ¶ˆè€—ç­‰ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½å¯¹ QoS çš„å®ç°ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œæ¯”å¦‚ QoS 2 çš„å››æ­¥æ¡æ‰‹è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ PUBLISHã€PUBRECã€PUBRELã€PUBCOMPã€‚éœ€è¦ç®€æ˜æ‰¼è¦åœ°æè¿°è¿™äº›æ­¥éª¤ï¼Œä½†é¿å…è¿‡äºæŠ€æœ¯åŒ–ï¼Œä¿æŒæ˜“æ‡‚ã€‚\n\u003e\n\u003e è¿˜éœ€è¦è€ƒè™‘ç”¨æˆ·å¯èƒ½çš„è¯¯åŒºï¼Œæ¯”å¦‚è®¤ä¸ºé«˜ QoS æ€»æ˜¯æ›´å¥½ï¼Œä½†å®é™…ä¸Šé«˜ QoS ä¼šå¢åŠ å»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ï¼Œéœ€è¦æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡ã€‚å¯èƒ½è¿˜è¦æåˆ°å¦‚ä½•é€‰æ‹© QoS ç­‰çº§ï¼Œæ¯”å¦‚æ ¹æ®æ•°æ®çš„é‡è¦æ€§ã€ç½‘ç»œç¨³å®šæ€§ã€è®¾å¤‡èµ„æºæƒ…å†µæ¥å†³å®šã€‚\n\u003e\n\u003e æœ€åï¼Œè¦ç¡®ä¿å›ç­”ç»“æ„æ¸…æ™°ï¼Œåˆ†ç‚¹è¯´æ˜ï¼Œæ¯ä¸ª QoS ç­‰çº§çš„å®šä¹‰ã€å®ç°æœºåˆ¶ã€é€‚ç”¨åœºæ™¯å’Œæ³¨æ„äº‹é¡¹ã€‚å¯èƒ½è¿˜éœ€è¦æ€»ç»“å¦‚ä½•é€‰æ‹©ï¼Œå¸®åŠ©ç”¨æˆ·åšå‡ºå†³ç­–ã€‚\n\u003e\n\u003e æ£€æŸ¥æ˜¯å¦æœ‰é—æ¼ç‚¹ï¼Œæ¯”å¦‚ QoS çš„ç¡®è®¤æœºåˆ¶ã€æ¶ˆæ¯é‡ä¼ ã€å­˜å‚¨ç­‰ã€‚ç¡®ä¿æ¯ä¸ªéƒ¨åˆ†éƒ½è¦†ç›–åˆ°ï¼Œå¹¶ä¸”è¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆä¸åŒæŠ€æœ¯èƒŒæ™¯çš„è¯»è€…ã€‚\n\n### **QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰è¯¦è§£**\n\nQoSï¼ˆ**Quality of Service**ï¼‰æ˜¯ MQTT åè®®ä¸­ç”¨äºå®šä¹‰**æ¶ˆæ¯ä¼ è¾“å¯é æ€§ç­‰çº§**çš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œå®ƒå†³å®šäº†æ¶ˆæ¯åœ¨å®¢æˆ·ç«¯ä¸ Brokerï¼ˆä»£ç†æœåŠ¡å™¨ï¼‰ä¹‹é—´çš„ä¼ é€’æ–¹å¼å’Œå¯é æ€§ä¿éšœã€‚MQTT æ”¯æŒä¸‰ç§ QoS ç­‰çº§ï¼Œå¼€å‘è€…å¯æ ¹æ®åœºæ™¯éœ€æ±‚é€‰æ‹©ä¸åŒçš„ç­‰çº§ï¼Œä»¥å¹³è¡¡**å¯é æ€§ã€å»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—**ã€‚\n\n---\n\n### **ä¸€ã€QoS çš„ä¸‰ç§ç­‰çº§**\n\n#### **1. QoS 0ï¼ˆæœ€å¤šä¸€æ¬¡ï¼ŒAt Most Onceï¼‰**\n\n- **å®šä¹‰**ï¼š  \n  æ¶ˆæ¯ä»…å‘é€ä¸€æ¬¡ï¼Œä¸ä¿è¯æ¥æ”¶æ–¹æ˜¯å¦æ”¶åˆ°ï¼Œå¯èƒ½ä¸¢å¤±ã€‚\n- **å®ç°æœºåˆ¶**ï¼š\n  - å‘é€æ–¹ï¼ˆPublisherï¼‰ç›´æ¥å‘é€æ¶ˆæ¯ï¼Œä¸ç­‰å¾…ç¡®è®¤ï¼ˆACKï¼‰ã€‚\n  - Broker å’Œè®¢é˜…è€…ï¼ˆSubscriberï¼‰ä¸å­˜å‚¨æ¶ˆæ¯ï¼Œç›´æ¥ä¸¢å¼ƒå¤±è´¥çš„æ¶ˆæ¯ã€‚\n- **é€‚ç”¨åœºæ™¯**ï¼š  \n  éå…³é”®æ€§æ•°æ®ï¼ˆå¦‚å‘¨æœŸæ€§ä¼ æ„Ÿå™¨è¯»æ•°ã€ç¯å¢ƒç›‘æµ‹æ•°æ®ï¼‰ã€‚\n- **ä¼˜ç‚¹**ï¼š  \n  ä¼ è¾“æœ€å¿«ã€èµ„æºæ¶ˆè€—æœ€ä½ã€‚\n- **ç¼ºç‚¹**ï¼š  \n  æ— æ³•ä¿è¯æ¶ˆæ¯å¿…è¾¾ã€‚\n\n#### **2. QoS 1ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼ŒAt Least Onceï¼‰**\n\n- **å®šä¹‰**ï¼š  \n  ç¡®ä¿æ¶ˆæ¯è‡³å°‘è¢«æ¥æ”¶ä¸€æ¬¡ï¼Œä½†å¯èƒ½é‡å¤ã€‚\n- **å®ç°æœºåˆ¶**ï¼š\n  - å‘é€æ–¹å­˜å‚¨æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ° Broker çš„ç¡®è®¤ï¼ˆPUBACKï¼‰ã€‚\n  - è‹¥æœªæ”¶åˆ°ç¡®è®¤ï¼Œå‘é€æ–¹ä¼šé‡ä¼ æ¶ˆæ¯ï¼ˆå¯èƒ½å¯¼è‡´é‡å¤ï¼‰ã€‚\n  - Broker åŒæ ·ä¼šå‘è®¢é˜…è€…é‡ä¼ æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ°è®¢é˜…è€…çš„ç¡®è®¤ã€‚\n- **é€‚ç”¨åœºæ™¯**ï¼š  \n  éœ€è¦ç¡®ä¿æ¶ˆæ¯å¿…è¾¾ä½†å¯¹é‡å¤ä¸æ•æ„Ÿçš„åœºæ™¯ï¼ˆå¦‚æ§åˆ¶æŒ‡ä»¤ã€çŠ¶æ€æ›´æ–°ï¼‰ã€‚\n- **ä¼˜ç‚¹**ï¼š  \n  å¯é æ€§è¾ƒé«˜ï¼Œé€‚åˆä¸­ç­‰é‡è¦æ€§æ•°æ®ã€‚\n- **ç¼ºç‚¹**ï¼š  \n  å¯èƒ½é‡å¤ï¼Œéœ€ä¸šåŠ¡å±‚å»é‡ï¼ˆå¦‚é€šè¿‡æ¶ˆæ¯ ID è¿‡æ»¤ï¼‰ã€‚\n\n#### **3. QoS 2ï¼ˆæ°å¥½ä¸€æ¬¡ï¼ŒExactly Onceï¼‰**\n\n- **å®šä¹‰**ï¼š  \n  ç¡®ä¿æ¶ˆæ¯**ä»…è¢«ä¼ é€’ä¸€æ¬¡**ï¼Œæ—¢ä¸ä¼šä¸¢å¤±ä¹Ÿä¸ä¼šé‡å¤ã€‚\n- **å®ç°æœºåˆ¶**ï¼š  \n  é€šè¿‡**å››æ¬¡æ¡æ‰‹**ä¿è¯å¯é æ€§ï¼ˆä»¥å®¢æˆ·ç«¯åˆ° Broker ä¸ºä¾‹ï¼‰ï¼š\n  1. å‘é€æ–¹å‘é€ `PUBLISH` æ¶ˆæ¯å¹¶å­˜å‚¨ã€‚\n  2. Broker å›å¤ `PUBREC`ï¼ˆå·²æ¥æ”¶ç¡®è®¤ï¼‰ã€‚\n  3. å‘é€æ–¹æ”¶åˆ° `PUBREC` åå‘é€ `PUBREL`ï¼ˆé‡Šæ”¾æ¶ˆæ¯ï¼‰ã€‚\n  4. Broker å›å¤ `PUBCOMP`ï¼ˆå®Œæˆç¡®è®¤ï¼‰ï¼ŒåŒæ–¹åˆ é™¤æ¶ˆæ¯å‰¯æœ¬ã€‚\n- **é€‚ç”¨åœºæ™¯**ï¼š  \n  å…³é”®æ€§æ•°æ®ï¼ˆå¦‚æ”¯ä»˜æŒ‡ä»¤ã€è®¾å¤‡å›ºä»¶å‡çº§ï¼‰ã€‚\n- **ä¼˜ç‚¹**ï¼š  \n  é«˜å¯é æ€§ï¼Œæ— é‡å¤ã€‚\n- **ç¼ºç‚¹**ï¼š  \n  å»¶è¿Ÿé«˜ã€èµ„æºæ¶ˆè€—å¤§ï¼ˆéœ€å­˜å‚¨æ¶ˆæ¯å’Œå¤šæ¬¡äº¤äº’ï¼‰ã€‚\n\n---\n\n### **äºŒã€QoS çš„ä¿éšœæœºåˆ¶**\n\nMQTT é€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç° QoS çš„å¯é æ€§ä¿è¯ï¼š\n\n1. **æ¶ˆæ¯å­˜å‚¨ä¸é‡ä¼ **ï¼š\n   - QoS 1 å’Œ QoS 2 çš„å‘é€æ–¹å’Œ Broker ä¼šç¼“å­˜æ¶ˆæ¯ï¼Œç›´åˆ°æ”¶åˆ°ç¡®è®¤ã€‚\n   - è‹¥è¶…æ—¶æœªæ”¶åˆ°ç¡®è®¤ï¼Œè§¦å‘æ¶ˆæ¯é‡ä¼ ã€‚\n2. **å”¯ä¸€æ¶ˆæ¯æ ‡è¯†ç¬¦ï¼ˆMessage IDï¼‰**ï¼š\n   - æ¯ä¸ªæ¶ˆæ¯åˆ†é…å”¯ä¸€ IDï¼Œç”¨äºå»é‡ï¼ˆQoS 1ï¼‰å’ŒçŠ¶æ€è·Ÿè¸ªï¼ˆQoS 2ï¼‰ã€‚\n3. **çŠ¶æ€æœºç®¡ç†**ï¼š\n   - QoS 2 é€šè¿‡çŠ¶æ€æœºä¸¥æ ¼ç®¡ç†å››æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€‚\n\n---\n\n### **ä¸‰ã€å¦‚ä½•é€‰æ‹© QoS ç­‰çº§ï¼Ÿ**\n\n| **å› ç´ **       | **QoS 0**              | **QoS 1** | **QoS 2** |\n| -------------- | ---------------------- | --------- | --------- |\n| **ç½‘ç»œç¨³å®šæ€§** | é«˜                     | ä¸­        | ä½        |\n| **æ•°æ®é‡è¦æ€§** | ä½                     | ä¸­        | é«˜        |\n| **è®¾å¤‡èµ„æº**   | èµ„æºå—é™ï¼ˆå¦‚ç”µæ± ä¾›ç”µï¼‰ | èµ„æºé€‚ä¸­  | èµ„æºå……è¶³  |\n| **å…è®¸å»¶è¿Ÿ**   | ä½å»¶è¿Ÿ                 | ä¸­ç­‰å»¶è¿Ÿ  | é«˜å»¶è¿Ÿ    |\n\n**ç¤ºä¾‹åœºæ™¯**ï¼š\n\n- **æ™ºèƒ½å®¶å±…æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨**ï¼šQoS 0ï¼ˆæ•°æ®å‘¨æœŸæ€§ä¸ŠæŠ¥ï¼Œå…è®¸å¶å°”ä¸¢å¤±ï¼‰ã€‚\n- **æ™ºèƒ½é—¨é”å¼€é”æŒ‡ä»¤**ï¼šQoS 1ï¼ˆéœ€ç¡®ä¿æŒ‡ä»¤åˆ°è¾¾ï¼Œé‡å¤å¼€é”æ— é£é™©ï¼‰ã€‚\n- **åŒ»ç–—è®¾å¤‡ç´§æ€¥å‘Šè­¦**ï¼šQoS 2ï¼ˆå¿…é¡»ç²¾ç¡®ä¼ é€’ä¸€æ¬¡ï¼Œé¿å…è¯¯æŠ¥æˆ–æ¼æŠ¥ï¼‰ã€‚\n\n---\n\n### **å››ã€æ³¨æ„äº‹é¡¹**\n\n1. **ç«¯åˆ°ç«¯ QoS**ï¼š  \n   MQTT çš„ QoS ä»…ä¿è¯å®¢æˆ·ç«¯ä¸ Broker ä¹‹é—´çš„ä¼ è¾“ï¼Œ**ä¸ä¿è¯ Broker ä¸è®¢é˜…è€…ä¹‹é—´çš„ä¼ é€’**ã€‚\n   - è‹¥è®¢é˜…è€…ç¦»çº¿ï¼Œéœ€ç»“åˆ**æŒä¹…ä¼šè¯ï¼ˆClean Session=0ï¼‰** å’Œ Broker çš„æ¶ˆæ¯å­˜å‚¨åŠŸèƒ½ã€‚\n2. **æ€§èƒ½ä¸èµ„æºæ¶ˆè€—**ï¼š\n   - QoS 2 çš„å››æ¬¡æ¡æ‰‹ä¼šæ˜¾è‘—å¢åŠ å»¶è¿Ÿå’Œå†…å­˜å ç”¨ï¼Œéœ€è°¨æ…ä½¿ç”¨ã€‚\n3. **ä¸šåŠ¡å±‚å»é‡**ï¼š\n   - å³ä½¿ä½¿ç”¨ QoS 2ï¼ŒæŸäº›åœºæ™¯ä»éœ€ä¸šåŠ¡å±‚æ ¡éªŒï¼ˆå¦‚ Broker å®ç°ä¸ä¸€è‡´ï¼‰ã€‚\n\n---\n\n### **æ€»ç»“**\n\nQoS æ˜¯ MQTT åè®®çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œé€šè¿‡é€‰æ‹©ä¸åŒç­‰çº§ï¼Œå¼€å‘è€…å¯åœ¨**å¯é æ€§ã€å»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—**ä¹‹é—´çµæ´»æƒè¡¡ã€‚å®é™…åº”ç”¨ä¸­éœ€ç»“åˆå…·ä½“åœºæ™¯ï¼ˆå¦‚æ•°æ®é‡è¦æ€§ã€ç½‘ç»œæ¡ä»¶ã€è®¾å¤‡èµ„æºï¼‰é€‰æ‹©æœ€ä¼˜ç­–ç•¥ï¼Œå¿…è¦æ—¶é€šè¿‡ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚æ¶ˆæ¯å»é‡ï¼‰è¡¥å……åè®®å±‚çš„ä¿éšœã€‚\n\n## Q: æ˜¯å¦æœ‰å…¶ä»–åè®®èƒ½åšä¸ MQTT åè®®ç±»ä¼¼çš„åŠŸèƒ½ï¼Ÿä»–ä»¬è·Ÿ MQTT æœ‰ä½•å¼‚åŒï¼Œæœ‰ä½•ä¼˜åŠ£ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·é—®çš„æ˜¯æœ‰æ²¡æœ‰å…¶ä»–åè®®èƒ½å®ç°ç±»ä¼¼ MQTT çš„åŠŸèƒ½ï¼Œä»¥åŠå®ƒä»¬çš„å¼‚åŒå’Œä¼˜åŠ£ã€‚æˆ‘éœ€è¦å…ˆçœ‹çœ‹æœç´¢ç»“æœé‡Œçš„å†…å®¹ï¼Œçœ‹çœ‹æœ‰å“ªäº›åè®®è¢«æåˆ°è¿‡ã€‚ç½‘é¡µ 2 æåˆ°äº† AMQPã€STOMPã€CoAPã€XMPPï¼Œè¿™äº›éƒ½æ˜¯å’Œ MQTT ç±»ä¼¼çš„åè®®ã€‚ç½‘é¡µ 3 ä¹Ÿè®¨è®ºäº† MQTTã€XMPPã€WebSocketsã€AMQP ç­‰åè®®çš„é€‰å‹ã€‚ç½‘é¡µ 4 æ¯”è¾ƒäº† MQTTã€CoAPã€RESTful/HTTP å’Œ XMPPï¼Œå¯èƒ½æœ‰ç”¨ã€‚ç½‘é¡µ 7 æåˆ° NATS æ”¯æŒ MQTTï¼Œå¯èƒ½ä¹Ÿæ˜¯ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œæˆ‘éœ€è¦æ•´ç†è¿™äº›åè®®çš„åŸºæœ¬ä¿¡æ¯ã€‚æ¯”å¦‚ AMQP æ˜¯é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ”¯æŒå¤æ‚çš„æ¶ˆæ¯è·¯ç”±ï¼Œé€‚åˆä¼ä¸šåº”ç”¨ï¼Œä½†å¯èƒ½æ¯” MQTT é‡ã€‚STOMP æ˜¯åŸºäºæ–‡æœ¬çš„ï¼Œé€‚åˆç®€å•åœºæ™¯ï¼Œä½†æ€§èƒ½å¯èƒ½ä¸å¦‚äºŒè¿›åˆ¶åè®®ã€‚CoAP ä¸“ä¸ºå—é™è®¾å¤‡è®¾è®¡ï¼Œä½¿ç”¨ UDPï¼Œé€‚åˆä½åŠŸè€—ç‰©è”ç½‘ï¼Œä½†å¯é æ€§å¯èƒ½ä¸å¦‚åŸºäº TCP çš„ MQTTã€‚XMPP åŸºäº XMLï¼Œæ‰©å±•æ€§å¼ºï¼Œä½†å¼€é”€å¤§ï¼Œé€‚åˆå³æ—¶é€šè®¯ã€‚NATS æ”¯æŒ MQTTï¼Œå¯èƒ½åœ¨é«˜ååé‡å’Œä½å»¶è¿Ÿæ–¹é¢æœ‰ä¼˜åŠ¿ã€‚\n\u003e\n\u003e ç„¶åï¼Œæ¯”è¾ƒå®ƒä»¬çš„å¼‚åŒã€‚æ¯”å¦‚ä¼ è¾“å±‚ï¼ŒMQTT ç”¨ TCPï¼ŒCoAP ç”¨ UDPã€‚æ¶ˆæ¯æ¨¡å‹æ–¹é¢ï¼ŒMQTT æ˜¯å‘å¸ƒ/è®¢é˜…ï¼Œè€Œ CoAP æ˜¯è¯·æ±‚/å“åº”ï¼Œä½†ä¹Ÿèƒ½æ”¯æŒå‘å¸ƒ/è®¢é˜…ã€‚QoS æ–¹é¢ï¼ŒMQTT æœ‰ä¸åŒç­‰çº§ï¼ŒCoAP ä¹Ÿæœ‰ç±»ä¼¼çš„æœºåˆ¶ã€‚å®‰å…¨æ–¹é¢ï¼ŒMQTT æ”¯æŒ TLSï¼ŒCoAP ä½¿ç”¨ DTLSã€‚\n\u003e\n\u003e è¿˜è¦æ³¨æ„å„ä¸ªåè®®çš„åº”ç”¨åœºæ™¯ã€‚æ¯”å¦‚ MQTT é€‚åˆç‰©è”ç½‘è®¾å¤‡ï¼ŒAMQP é€‚åˆä¼ä¸šçº§æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒCoAP åœ¨èµ„æºå—é™è®¾å¤‡ä¸Šè¡¨ç°æ›´å¥½ï¼ŒXMPP é€‚åˆéœ€è¦æ‰©å±•æ€§çš„å³æ—¶é€šè®¯ã€‚åŒæ—¶ï¼Œæœç´¢ç»“æœé‡Œæåˆ° MQTT çš„ç¼ºç‚¹ï¼Œæ¯”å¦‚å¯æ‰©å±•æ€§æœ‰é™ï¼Œä¸æ”¯æŒè¯·æ±‚/å“åº”æ¨¡å¼ï¼Œè€Œå…¶ä»–åè®®å¯èƒ½å¼¥è¡¥è¿™äº›ä¸è¶³ã€‚\n\u003e\n\u003e éœ€è¦å¼•ç”¨ä¸åŒç½‘é¡µçš„ä¿¡æ¯ã€‚æ¯”å¦‚ç½‘é¡µ 2 æåˆ° AMQPã€STOMPã€CoAPã€XMPPï¼›ç½‘é¡µ 3 è¯¦ç»†æ¯”è¾ƒäº† MQTT å’Œå…¶ä»–åè®®çš„é€‚ç”¨åœºæ™¯ï¼›ç½‘é¡µ 4 çš„å¯¹æ¯”è¡¨æ ¼æœ‰åŠ©äºæ€»ç»“å„ä¸ªåè®®çš„ç‰¹æ€§ï¼›ç½‘é¡µ 6 æåˆ° MQTT çš„åŠ£åŠ¿ï¼Œå¦‚ä¸æ”¯æŒè¯·æ±‚/å“åº”ï¼›ç½‘é¡µ 7 æåˆ° NATS æ”¯æŒ MQTT åè®®ï¼Œå¯èƒ½ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆã€‚\n\u003e\n\u003e æœ€åï¼Œè¦ç¡®ä¿å›ç­”ç»“æ„æ¸…æ™°ï¼Œåˆ†ç‚¹åˆ—å‡ºå„ä¸ªåè®®ï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬çš„å¼‚åŒå’Œä¼˜åŠ£ï¼ŒåŒæ—¶å¼•ç”¨å¯¹åº”çš„æœç´¢ç»“æœç¼–å·ã€‚æ¯”å¦‚ AMQP åœ¨ç½‘é¡µ 2 å’Œ 3 éƒ½æœ‰æåˆ°ï¼ŒCoAP åœ¨ç½‘é¡µ 2ã€4ã€5ï¼ŒXMPP åœ¨ç½‘é¡µ 2ã€4ï¼ŒNATS åœ¨ç½‘é¡µ 7ã€‚éœ€è¦æ³¨æ„é¿å…é‡å¤å¼•ç”¨åŒä¸€ç½‘é¡µï¼Œæ¯ä¸ªè¦ç‚¹å°½é‡ç»¼åˆå¤šä¸ªç½‘é¡µçš„ä¿¡æ¯ã€‚\n\nä»¥ä¸‹æ˜¯å‡ ç§èƒ½å¤Ÿå®ç°ä¸ MQTT ç±»ä¼¼åŠŸèƒ½çš„åè®®åŠå…¶ä¸ MQTT çš„å¼‚åŒä¸ä¼˜åŠ£åˆ†æï¼š\n\n---\n\n### **1. AMQPï¼ˆAdvanced Message Queuing Protocolï¼‰**\n\n- **åŠŸèƒ½ç›¸ä¼¼æ€§**ï¼šæ”¯æŒå‘å¸ƒ/è®¢é˜…æ¨¡å‹å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæä¾›é«˜å¯é æ€§ä¼ è¾“ï¼Œé€‚åˆä¼ä¸šçº§æ¶ˆæ¯ç³»ç»Ÿã€‚\n- **å·®å¼‚ä¸ä¼˜åŠ£**ï¼š\n  - **åè®®å¤æ‚åº¦**ï¼šAMQP åŠŸèƒ½æ›´å¼ºå¤§ï¼Œæ”¯æŒäº‹åŠ¡ã€æ¶ˆæ¯æŒä¹…åŒ–ã€å¤æ‚è·¯ç”±è§„åˆ™ï¼ˆå¦‚ç›´æ¥/ä¸»é¢˜/æ‰‡å‡ºè·¯ç”±ï¼‰ï¼Œä½†åè®®å¼€é”€è¾ƒå¤§ï¼Œé€‚åˆéœ€è¦é«˜å¯é æ€§å’Œå¤æ‚æ¶ˆæ¯ç®¡ç†çš„åœºæ™¯ï¼ˆå¦‚é‡‘èç³»ç»Ÿï¼‰ã€‚\n  - **æ€§èƒ½**ï¼šç›¸æ¯” MQTTï¼ŒAMQP åœ¨ä½å¸¦å®½ç¯å¢ƒä¸­æ•ˆç‡è¾ƒä½ï¼Œä½†å¯¹å¤§è§„æ¨¡ä¼ä¸šçº§åº”ç”¨æ›´å‹å¥½ã€‚\n  - **é€‚ç”¨åœºæ™¯**ï¼šæ›´é€‚åˆä¼ ç»Ÿä¼ä¸šä¸­é—´ä»¶ï¼ˆå¦‚ RabbitMQï¼‰ï¼Œè€Œéç‰©è”ç½‘è®¾å¤‡ã€‚\n\n---\n\n### **2. CoAPï¼ˆConstrained Application Protocolï¼‰**\n\n- **åŠŸèƒ½ç›¸ä¼¼æ€§**ï¼šä¸“ä¸ºç‰©è”ç½‘è®¾å¤‡è®¾è®¡ï¼Œæ”¯æŒè½»é‡çº§è¯·æ±‚/å“åº”æ¨¡å‹ï¼Œç±»ä¼¼ HTTP çš„ RESTful é£æ ¼ï¼Œä½†åŸºäº UDPï¼Œé€‚åˆèµ„æºå—é™è®¾å¤‡ã€‚\n- **å·®å¼‚ä¸ä¼˜åŠ£**ï¼š\n  - **ä¼ è¾“å±‚**ï¼šCoAP ä½¿ç”¨ UDPï¼Œæ”¯æŒå¤šæ’­ï¼Œé€‚åˆä½åŠŸè€—è®¾å¤‡ï¼ˆå¦‚ä¼ æ„Ÿå™¨ï¼‰ï¼Œä½†éœ€ä¾èµ–åº”ç”¨å±‚å®ç°å¯é æ€§ï¼ˆå¦‚é‡ä¼ æœºåˆ¶ï¼‰ï¼›MQTT åŸºäº TCPï¼Œé»˜è®¤æ›´å¯é ã€‚\n  - **æ¶ˆæ¯æ¨¡å‹**ï¼šCoAP åŸç”Ÿæ”¯æŒè¯·æ±‚/å“åº”ï¼ŒMQTT éœ€é€šè¿‡å‘å¸ƒ/è®¢é˜…æ¨¡æ‹Ÿã€‚CoAP ä¹Ÿå¯é€šè¿‡æ‰©å±•å®ç°å‘å¸ƒ/è®¢é˜…ã€‚\n  - **é€‚ç”¨åœºæ™¯**ï¼šCoAP æ›´é€‚åˆä¸€å¯¹ä¸€æˆ–å°è§„æ¨¡è®¾å¤‡é€šä¿¡ï¼ˆå¦‚æ™ºèƒ½å®¶å±…ä¼ æ„Ÿå™¨ï¼‰ï¼Œè€Œ MQTT æ›´é€‚åˆå¤§è§„æ¨¡è®¾å¤‡è¿æ¥ã€‚\n\n---\n\n### **3. STOMPï¼ˆSimple Text Oriented Messaging Protocolï¼‰**\n\n- **åŠŸèƒ½ç›¸ä¼¼æ€§**ï¼šåŸºäºæ–‡æœ¬çš„åè®®ï¼Œæ”¯æŒå‘å¸ƒ/è®¢é˜…å’Œé˜Ÿåˆ—æ¨¡å‹ï¼Œè·¨è¯­è¨€å…¼å®¹æ€§å¥½ã€‚\n- **å·®å¼‚ä¸ä¼˜åŠ£**ï¼š\n  - **åè®®æ ¼å¼**ï¼šSTOMP ä¸ºæ–‡æœ¬åè®®ï¼Œå¯è¯»æ€§å¼ºä½†ä¼ è¾“æ•ˆç‡ä½äº MQTT çš„äºŒè¿›åˆ¶åè®®ã€‚\n  - **åŠŸèƒ½ç‰¹æ€§**ï¼šæ”¯æŒäº‹åŠ¡å’Œæ¶ˆæ¯ç¡®è®¤ï¼Œä½†ç¼ºä¹ MQTT çš„ QoS åˆ†çº§æœºåˆ¶ï¼Œå¯é æ€§ä¾èµ–ä¸­é—´ä»¶å®ç°ã€‚\n  - **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆéœ€è¦å¿«é€Ÿé›†æˆçš„ç®€å•åº”ç”¨ï¼ˆå¦‚æµè§ˆå™¨ä¸åç«¯é€šä¿¡ï¼‰ï¼Œè€Œéé«˜ååé‡ç‰©è”ç½‘åœºæ™¯ã€‚\n\n---\n\n### **4. XMPPï¼ˆExtensible Messaging and Presence Protocolï¼‰**\n\n- **åŠŸèƒ½ç›¸ä¼¼æ€§**ï¼šæ”¯æŒå³æ—¶é€šä¿¡å’Œå‘å¸ƒ/è®¢é˜…ï¼Œæ‰©å±•æ€§å¼ºï¼ˆåŸºäº XMLï¼‰ï¼Œå¸¸ç”¨äºèŠå¤©å’Œç¤¾äº¤åº”ç”¨ã€‚\n- **å·®å¼‚ä¸ä¼˜åŠ£**ï¼š\n  - **åè®®å¼€é”€**ï¼šXMPP çš„ XML æ ¼å¼å¯¼è‡´åè®®å¤´è¾ƒå¤§ï¼Œä¸é€‚åˆä½å¸¦å®½ç¯å¢ƒï¼›MQTT æ›´è½»é‡ã€‚\n  - **å®æ—¶æ€§**ï¼šXMPP æ”¯æŒåœ¨çº¿çŠ¶æ€ç®¡ç†å’Œå®æ—¶ä¼šè¯ï¼ŒMQTT æ›´ä¸“æ³¨äºå¼‚æ­¥æ¶ˆæ¯ä¼ è¾“ã€‚\n  - **é€‚ç”¨åœºæ™¯**ï¼šXMPP é€‚åˆéœ€è¦å¤æ‚äº¤äº’å’Œæ‰©å±•æ€§çš„å³æ—¶é€šä¿¡ï¼ˆå¦‚ä¼ä¸šåä½œå·¥å…·ï¼‰ï¼ŒMQTT æ›´é€‚åˆè®¾å¤‡æ•°æ®ä¸ŠæŠ¥ã€‚\n\n---\n\n### **5. NATSï¼ˆCloud Native Messaging Systemï¼‰**\n\n- **åŠŸèƒ½ç›¸ä¼¼æ€§**ï¼šæ”¯æŒå‘å¸ƒ/è®¢é˜…å’Œç‚¹å¯¹ç‚¹é€šä¿¡ï¼ŒNATS Server v2.2.0+ åŸç”Ÿå…¼å®¹ MQTT åè®®ï¼Œå¯æ›¿ä»£ MQTT ä»£ç†ã€‚\n- **å·®å¼‚ä¸ä¼˜åŠ£**ï¼š\n  - **æ€§èƒ½**ï¼šNATS ä»¥é«˜ååé‡å’Œä½å»¶è¿Ÿè‘—ç§°ï¼Œé€‚åˆäº‘åŸç”Ÿå’Œå¾®æœåŠ¡æ¶æ„ï¼ŒMQTT æ›´ä¾§é‡ç‰©è”ç½‘è®¾å¤‡å…¼å®¹æ€§ã€‚\n  - **åè®®æ‰©å±•**ï¼šNATS æ”¯æŒä¸ MQTT äº’é€šï¼Œå…è®¸æ··åˆéƒ¨ç½²ï¼Œä½†éœ€ä¾èµ–ç‰¹å®šä¸­é—´ä»¶å®ç°ï¼ˆå¦‚ NATS æœåŠ¡å™¨ï¼‰ã€‚\n  - **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆéœ€è¦ç»Ÿä¸€æ¶ˆæ¯æ€»çº¿ä¸”åŒæ—¶æ”¯æŒ MQTT å’Œ NATS åè®®çš„ç³»ç»Ÿã€‚\n\n---\n\n### **æ€»ç»“ï¼šåè®®é€‰å‹å»ºè®®**\n\n| **åœºæ™¯éœ€æ±‚**           | **æ¨èåè®®** | **å…³é”®ä¼˜åŠ¿**           |\n| ---------------------- | ------------ | ---------------------- |\n| å¤§è§„æ¨¡ç‰©è”ç½‘è®¾å¤‡è¿æ¥   | MQTT         | è½»é‡ã€ä½åŠŸè€—ã€QoS åˆ†çº§ |\n| ä¼ä¸šçº§å¤æ‚æ¶ˆæ¯è·¯ç”±     | AMQP         | é«˜å¯é æ€§ã€äº‹åŠ¡æ”¯æŒ     |\n| èµ„æºå—é™è®¾å¤‡ï¼ˆä½åŠŸè€—ï¼‰ | CoAP         | åŸºäº UDPã€æç®€åè®®å¤´   |\n| æµè§ˆå™¨ä¸åç«¯å®æ—¶é€šä¿¡   | STOMP        | æ–‡æœ¬åè®®ã€æ˜“é›†æˆ       |\n| å³æ—¶é€šä¿¡ä¸çŠ¶æ€ç®¡ç†     | XMPP         | æ‰©å±•æ€§å¼ºã€å®æ—¶äº¤äº’     |\n| äº‘åŸç”Ÿé«˜ååé‡ç³»ç»Ÿ     | NATS         | ä½å»¶è¿Ÿã€å…¼å®¹ MQTT      |\n\n**æ³¨**ï¼šå®é™…é€‰å‹éœ€ç»“åˆç½‘ç»œç¯å¢ƒã€è®¾å¤‡èµ„æºã€æ•°æ®å®‰å…¨ï¼ˆå¦‚æ˜¯å¦éœ€ TLS/DTLSï¼‰å’Œç”Ÿæ€æ”¯æŒï¼ˆå¦‚äº‘å¹³å°å…¼å®¹æ€§ï¼‰ç»¼åˆè€ƒé‡ã€‚\n","title":"è¯¦ç»†ä»‹ç» MQTT åè®®çš„å†…å®¹ï¼ŒåŸç†ï¼Œåº”ç”¨åœºæ™¯","abstract":"\u003e æœ¬æ–‡è¯¦ç»†ä»‹ç»äº† MQTTï¼ˆMessage Queuing Telemetry Transportï¼‰åè®®çš„æ ¸å¿ƒå†…å®¹ã€å·¥ä½œåŸç†åŠå…¶åœ¨ç‰©è”ç½‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨åœºæ™¯ã€‚æ–‡ç« åˆ†æäº† MQTT åè®®çš„ç‰¹ç‚¹ã€æ¶ˆæ¯è´¨é‡ç­‰çº§ã€ä¸»é¢˜è®¾è®¡ä»¥åŠå®‰å…¨æœºåˆ¶ï¼Œå¸®åŠ©è¯»è€…å…¨é¢äº†è§£è¿™ä¸€è½»é‡çº§çš„å‘å¸ƒ/è®¢é˜…åè®®å¦‚ä½•æ”¯æŒèµ„æºå—é™è®¾å¤‡çš„å¯é é€šä¿¡ã€‚\nMQTTï¼ˆMessage Queuing Telemetry Transportï¼‰æ˜¯ä¸€ç§è½»é‡çº§çš„ã€åŸºäºå‘å¸ƒ/è®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯ä¼ è¾“åè®®ï¼Œä¸“ä¸ºå—é™è®¾å¤‡å’Œä½å¸¦å®½ã€é«˜å»¶è¿Ÿæˆ–ä¸å¯é çš„ç½‘ç»œç¯å¢ƒè®¾è®¡ã€‚å®ƒç”± Andy Stanford-Clarkï¼ˆIBMï¼‰å’Œ Arlen Nipperï¼ˆCirrus Linkï¼‰äº 1999 å¹´ä¸ºè¿æ¥çŸ³æ²¹ç®¡é“çš„ SCADA ç³»ç»Ÿè€Œå¼€å‘ï¼Œç°å·²å‘å±•æˆä¸ºç‰©è”ç½‘ï¼ˆIoTï¼‰é€šä¿¡çš„æ ‡å‡†åè®®ä¹‹ä¸€ã€‚\nMQTT åè®®å·¥ä½œåœ¨ TCP/IP åè®®æ ˆä¸Šï¼Œä½¿ç”¨äº†æœ€å°åŒ–çš„åè®®å¼€é”€ï¼Œå¯ä»¥åœ¨èµ„æºå—é™çš„è®¾å¤‡ä¸Šå®ç°é«˜æ•ˆé€šä¿¡ã€‚å®ƒé‡‡ç”¨å‘å¸ƒ/è®¢é˜…çš„æ¶ˆæ¯æ¨¡å¼ï¼Œè€Œéä¼ ç»Ÿçš„å®¢æˆ·ç«¯/æœåŠ¡å™¨æ¨¡å¼ï¼Œè¿™ä½¿å¾—å®ƒç‰¹åˆ«é€‚åˆæ„å»ºå¯æ‰©å±•çš„ç‰©è”ç½‘åº”ç”¨ã€‚","length":722,"created_at":"2025-03-28T06:35:00.000Z","updated_at":"2025-03-28T06:35:00.000Z","tags":["åè®®","IoT","ç‰©è”ç½‘","æ¶ˆæ¯é˜Ÿåˆ—","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-ä»€ä¹ˆæ˜¯-mqtt-åè®®","href":"#q-ä»€ä¹ˆæ˜¯-mqtt-åè®®","heading":2,"title":"Q: ä»€ä¹ˆæ˜¯ MQTT åè®®ï¼Ÿ","children":[],"id":"q-ä»€ä¹ˆæ˜¯-mqtt-åè®®"},{"key":"q-mqtt-åè®®çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ","href":"#q-mqtt-åè®®çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ","heading":2,"title":"Q: MQTT åè®®çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ","children":[],"id":"q-mqtt-åè®®çš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆ"},{"key":"q-mqtt-åè®®çš„ä¸»è¦ç‰¹æ€§æœ‰å“ªäº›","href":"#q-mqtt-åè®®çš„ä¸»è¦ç‰¹æ€§æœ‰å“ªäº›","heading":2,"title":"Q: MQTT åè®®çš„ä¸»è¦ç‰¹æ€§æœ‰å“ªäº›ï¼Ÿ","children":[],"id":"q-mqtt-åè®®çš„ä¸»è¦ç‰¹æ€§æœ‰å“ªäº›"},{"key":"q-mqtt-æœ‰å“ªäº›ç‰ˆæœ¬å®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«","href":"#q-mqtt-æœ‰å“ªäº›ç‰ˆæœ¬å®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«","heading":2,"title":"Q: MQTT æœ‰å“ªäº›ç‰ˆæœ¬ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ","children":[],"id":"q-mqtt-æœ‰å“ªäº›ç‰ˆæœ¬å®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«"},{"key":"q-mqtt-åè®®çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›","href":"#q-mqtt-åè®®çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›","heading":2,"title":"Q: MQTT åè®®çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ","children":[],"id":"q-mqtt-åè®®çš„åº”ç”¨åœºæ™¯æœ‰å“ªäº›"},{"key":"q-mqtt-çš„å®‰å…¨æœºåˆ¶æœ‰å“ªäº›","href":"#q-mqtt-çš„å®‰å…¨æœºåˆ¶æœ‰å“ªäº›","heading":2,"title":"Q: MQTT çš„å®‰å…¨æœºåˆ¶æœ‰å“ªäº›ï¼Ÿ","children":[],"id":"q-mqtt-çš„å®‰å…¨æœºåˆ¶æœ‰å“ªäº›"},{"key":"q-ä¸»è¦çš„-mqtt-ä»£ç†æœåŠ¡å™¨å®ç°æœ‰å“ªäº›","href":"#q-ä¸»è¦çš„-mqtt-ä»£ç†æœåŠ¡å™¨å®ç°æœ‰å“ªäº›","heading":2,"title":"Q: ä¸»è¦çš„ MQTT ä»£ç†/æœåŠ¡å™¨å®ç°æœ‰å“ªäº›ï¼Ÿ","children":[],"id":"q-ä¸»è¦çš„-mqtt-ä»£ç†æœåŠ¡å™¨å®ç°æœ‰å“ªäº›"},{"key":"q-mqtt-ä¸å…¶ä»–æ¶ˆæ¯åè®®ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿","href":"#q-mqtt-ä¸å…¶ä»–æ¶ˆæ¯åè®®ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿","heading":2,"title":"Q: MQTT ä¸å…¶ä»–æ¶ˆæ¯åè®®ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼Ÿ","children":[{"key":"ä¸-http-ç›¸æ¯”","href":"#ä¸-http-ç›¸æ¯”","heading":3,"title":"ä¸ HTTP ç›¸æ¯”ï¼š","children":[],"id":"ä¸-http-ç›¸æ¯”"},{"key":"ä¸-coap-ç›¸æ¯”","href":"#ä¸-coap-ç›¸æ¯”","heading":3,"title":"ä¸ CoAP ç›¸æ¯”ï¼š","children":[],"id":"ä¸-coap-ç›¸æ¯”"},{"key":"ä¸-amqp-ç›¸æ¯”","href":"#ä¸-amqp-ç›¸æ¯”","heading":3,"title":"ä¸ AMQP ç›¸æ¯”ï¼š","children":[],"id":"ä¸-amqp-ç›¸æ¯”"},{"key":"ä¸-websocket-ç›¸æ¯”","href":"#ä¸-websocket-ç›¸æ¯”","heading":3,"title":"ä¸ WebSocket ç›¸æ¯”ï¼š","children":[],"id":"ä¸-websocket-ç›¸æ¯”"}],"id":"q-mqtt-ä¸å…¶ä»–æ¶ˆæ¯åè®®ç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿å’ŒåŠ£åŠ¿"},{"key":"q-è®¾è®¡åŸºäº-mqtt-çš„ç³»ç»Ÿæ—¶æœ‰å“ªäº›æœ€ä½³å®è·µ","href":"#q-è®¾è®¡åŸºäº-mqtt-çš„ç³»ç»Ÿæ—¶æœ‰å“ªäº›æœ€ä½³å®è·µ","heading":2,"title":"Q: è®¾è®¡åŸºäº MQTT çš„ç³»ç»Ÿæ—¶æœ‰å“ªäº›æœ€ä½³å®è·µï¼Ÿ","children":[{"key":"ä¸»é¢˜è®¾è®¡","href":"#ä¸»é¢˜è®¾è®¡","heading":3,"title":"ä¸»é¢˜è®¾è®¡ï¼š","children":[],"id":"ä¸»é¢˜è®¾è®¡"},{"key":"qos-é€‰æ‹©","href":"#qos-é€‰æ‹©","heading":3,"title":"QoS é€‰æ‹©ï¼š","children":[],"id":"qos-é€‰æ‹©"},{"key":"è¿æ¥ç®¡ç†","href":"#è¿æ¥ç®¡ç†","heading":3,"title":"è¿æ¥ç®¡ç†ï¼š","children":[],"id":"è¿æ¥ç®¡ç†"},{"key":"å®‰å…¨æœ€ä½³å®è·µ","href":"#å®‰å…¨æœ€ä½³å®è·µ","heading":3,"title":"å®‰å…¨æœ€ä½³å®è·µï¼š","children":[],"id":"å®‰å…¨æœ€ä½³å®è·µ"},{"key":"æ€§èƒ½ä¸å¯æ‰©å±•æ€§","href":"#æ€§èƒ½ä¸å¯æ‰©å±•æ€§","heading":3,"title":"æ€§èƒ½ä¸å¯æ‰©å±•æ€§ï¼š","children":[],"id":"æ€§èƒ½ä¸å¯æ‰©å±•æ€§"},{"key":"æ•°æ®è®¾è®¡","href":"#æ•°æ®è®¾è®¡","heading":3,"title":"æ•°æ®è®¾è®¡ï¼š","children":[],"id":"æ•°æ®è®¾è®¡"},{"key":"æ•…éšœæ¢å¤","href":"#æ•…éšœæ¢å¤","heading":3,"title":"æ•…éšœæ¢å¤ï¼š","children":[],"id":"æ•…éšœæ¢å¤"}],"id":"q-è®¾è®¡åŸºäº-mqtt-çš„ç³»ç»Ÿæ—¶æœ‰å“ªäº›æœ€ä½³å®è·µ"},{"key":"q-mqtt-åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿å¦‚ä½•","href":"#q-mqtt-åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿å¦‚ä½•","heading":2,"title":"Q: MQTT åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿å¦‚ä½•ï¼Ÿ","children":[],"id":"q-mqtt-åè®®çš„æœªæ¥å‘å±•è¶‹åŠ¿å¦‚ä½•"},{"key":"q-è¯¦ç»†ä»‹ç»-mqtt-åè®®çš„å†…å®¹åŸç†åº”ç”¨åœºæ™¯ä»¥åŠåº”ç”¨-mqtt-åè®®æ—¶è¦æ³¨æ„çš„äº‹é¡¹","href":"#q-è¯¦ç»†ä»‹ç»-mqtt-åè®®çš„å†…å®¹åŸç†åº”ç”¨åœºæ™¯ä»¥åŠåº”ç”¨-mqtt-åè®®æ—¶è¦æ³¨æ„çš„äº‹é¡¹","heading":2,"title":"Q: è¯¦ç»†ä»‹ç» MQTT åè®®çš„å†…å®¹ï¼ŒåŸç†ï¼Œåº”ç”¨åœºæ™¯ï¼Œä»¥åŠåº”ç”¨ MQTT åè®®æ—¶è¦æ³¨æ„çš„äº‹é¡¹","children":[{"key":"mqtt-åè®®è¯¦è§£","href":"#mqtt-åè®®è¯¦è§£","heading":3,"title":"MQTT åè®®è¯¦è§£","children":[{"key":"ä¸€åè®®å†…å®¹","href":"#ä¸€åè®®å†…å®¹","heading":4,"title":"ä¸€ã€åè®®å†…å®¹","children":[],"id":"ä¸€åè®®å†…å®¹"},{"key":"äºŒå·¥ä½œåŸç†","href":"#äºŒå·¥ä½œåŸç†","heading":4,"title":"äºŒã€å·¥ä½œåŸç†","children":[],"id":"äºŒå·¥ä½œåŸç†"},{"key":"ä¸‰å…¸å‹åº”ç”¨åœºæ™¯","href":"#ä¸‰å…¸å‹åº”ç”¨åœºæ™¯","heading":4,"title":"ä¸‰ã€å…¸å‹åº”ç”¨åœºæ™¯","children":[],"id":"ä¸‰å…¸å‹åº”ç”¨åœºæ™¯"},{"key":"å››ä½¿ç”¨æ³¨æ„äº‹é¡¹","href":"#å››ä½¿ç”¨æ³¨æ„äº‹é¡¹","heading":4,"title":"å››ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹","children":[],"id":"å››ä½¿ç”¨æ³¨æ„äº‹é¡¹"},{"key":"äº”å¸¸è§é—®é¢˜ä¸è§£å†³","href":"#äº”å¸¸è§é—®é¢˜ä¸è§£å†³","heading":4,"title":"äº”ã€å¸¸è§é—®é¢˜ä¸è§£å†³","children":[],"id":"äº”å¸¸è§é—®é¢˜ä¸è§£å†³"}],"id":"mqtt-åè®®è¯¦è§£"}],"id":"q-è¯¦ç»†ä»‹ç»-mqtt-åè®®çš„å†…å®¹åŸç†åº”ç”¨åœºæ™¯ä»¥åŠåº”ç”¨-mqtt-åè®®æ—¶è¦æ³¨æ„çš„äº‹é¡¹"},{"key":"q-qos-æ˜¯ä¸ªä»€ä¹ˆæŒ‡æ ‡å¦‚ä½•ä¿è¯","href":"#q-qos-æ˜¯ä¸ªä»€ä¹ˆæŒ‡æ ‡å¦‚ä½•ä¿è¯","heading":2,"title":"Q: QoS æ˜¯ä¸ªä»€ä¹ˆæŒ‡æ ‡ï¼Ÿå¦‚ä½•ä¿è¯ï¼Ÿ","children":[{"key":"qosæœåŠ¡è´¨é‡è¯¦è§£","href":"#qosæœåŠ¡è´¨é‡è¯¦è§£","heading":3,"title":"QoSï¼ˆæœåŠ¡è´¨é‡ï¼‰è¯¦è§£","children":[],"id":"qosæœåŠ¡è´¨é‡è¯¦è§£"},{"key":"ä¸€qos-çš„ä¸‰ç§ç­‰çº§","href":"#ä¸€qos-çš„ä¸‰ç§ç­‰çº§","heading":3,"title":"ä¸€ã€QoS çš„ä¸‰ç§ç­‰çº§","children":[{"key":"1-qos-0æœ€å¤šä¸€æ¬¡at-most-once","href":"#1-qos-0æœ€å¤šä¸€æ¬¡at-most-once","heading":4,"title":"1. QoS 0ï¼ˆæœ€å¤šä¸€æ¬¡ï¼ŒAt Most Onceï¼‰","children":[],"id":"1-qos-0æœ€å¤šä¸€æ¬¡at-most-once"},{"key":"2-qos-1è‡³å°‘ä¸€æ¬¡at-least-once","href":"#2-qos-1è‡³å°‘ä¸€æ¬¡at-least-once","heading":4,"title":"2. QoS 1ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼ŒAt Least Onceï¼‰","children":[],"id":"2-qos-1è‡³å°‘ä¸€æ¬¡at-least-once"},{"key":"3-qos-2æ°å¥½ä¸€æ¬¡exactly-once","href":"#3-qos-2æ°å¥½ä¸€æ¬¡exactly-once","heading":4,"title":"3. QoS 2ï¼ˆæ°å¥½ä¸€æ¬¡ï¼ŒExactly Onceï¼‰","children":[],"id":"3-qos-2æ°å¥½ä¸€æ¬¡exactly-once"}],"id":"ä¸€qos-çš„ä¸‰ç§ç­‰çº§"},{"key":"äºŒqos-çš„ä¿éšœæœºåˆ¶","href":"#äºŒqos-çš„ä¿éšœæœºåˆ¶","heading":3,"title":"äºŒã€QoS çš„ä¿éšœæœºåˆ¶","children":[],"id":"äºŒqos-çš„ä¿éšœæœºåˆ¶"},{"key":"ä¸‰å¦‚ä½•é€‰æ‹©-qos-ç­‰çº§","href":"#ä¸‰å¦‚ä½•é€‰æ‹©-qos-ç­‰çº§","heading":3,"title":"ä¸‰ã€å¦‚ä½•é€‰æ‹© QoS ç­‰çº§ï¼Ÿ","children":[],"id":"ä¸‰å¦‚ä½•é€‰æ‹©-qos-ç­‰çº§"},{"key":"å››æ³¨æ„äº‹é¡¹","href":"#å››æ³¨æ„äº‹é¡¹","heading":3,"title":"å››ã€æ³¨æ„äº‹é¡¹","children":[],"id":"å››æ³¨æ„äº‹é¡¹"},{"key":"æ€»ç»“","href":"#æ€»ç»“","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“"}],"id":"q-qos-æ˜¯ä¸ªä»€ä¹ˆæŒ‡æ ‡å¦‚ä½•ä¿è¯"},{"key":"q-æ˜¯å¦æœ‰å…¶ä»–åè®®èƒ½åšä¸-mqtt-åè®®ç±»ä¼¼çš„åŠŸèƒ½ä»–ä»¬è·Ÿ-mqtt-æœ‰ä½•å¼‚åŒæœ‰ä½•ä¼˜åŠ£","href":"#q-æ˜¯å¦æœ‰å…¶ä»–åè®®èƒ½åšä¸-mqtt-åè®®ç±»ä¼¼çš„åŠŸèƒ½ä»–ä»¬è·Ÿ-mqtt-æœ‰ä½•å¼‚åŒæœ‰ä½•ä¼˜åŠ£","heading":2,"title":"Q: æ˜¯å¦æœ‰å…¶ä»–åè®®èƒ½åšä¸ MQTT åè®®ç±»ä¼¼çš„åŠŸèƒ½ï¼Ÿä»–ä»¬è·Ÿ MQTT æœ‰ä½•å¼‚åŒï¼Œæœ‰ä½•ä¼˜åŠ£ï¼Ÿ","children":[{"key":"1-amqpadvanced-message-queuing-protocol","href":"#1-amqpadvanced-message-queuing-protocol","heading":3,"title":"1. AMQPï¼ˆAdvanced Message Queuing Protocolï¼‰","children":[],"id":"1-amqpadvanced-message-queuing-protocol"},{"key":"2-coapconstrained-application-protocol","href":"#2-coapconstrained-application-protocol","heading":3,"title":"2. CoAPï¼ˆConstrained Application Protocolï¼‰","children":[],"id":"2-coapconstrained-application-protocol"},{"key":"3-stompsimple-text-oriented-messaging-protocol","href":"#3-stompsimple-text-oriented-messaging-protocol","heading":3,"title":"3. STOMPï¼ˆSimple Text Oriented Messaging Protocolï¼‰","children":[],"id":"3-stompsimple-text-oriented-messaging-protocol"},{"key":"4-xmppextensible-messaging-and-presence-protocol","href":"#4-xmppextensible-messaging-and-presence-protocol","heading":3,"title":"4. XMPPï¼ˆExtensible Messaging and Presence Protocolï¼‰","children":[],"id":"4-xmppextensible-messaging-and-presence-protocol"},{"key":"5-natscloud-native-messaging-system","href":"#5-natscloud-native-messaging-system","heading":3,"title":"5. NATSï¼ˆCloud Native Messaging Systemï¼‰","children":[],"id":"5-natscloud-native-messaging-system"},{"key":"æ€»ç»“åè®®é€‰å‹å»ºè®®","href":"#æ€»ç»“åè®®é€‰å‹å»ºè®®","heading":3,"title":"æ€»ç»“ï¼šåè®®é€‰å‹å»ºè®®","children":[],"id":"æ€»ç»“åè®®é€‰å‹å»ºè®®"}],"id":"q-æ˜¯å¦æœ‰å…¶ä»–åè®®èƒ½åšä¸-mqtt-åè®®ç±»ä¼¼çš„åŠŸèƒ½ä»–ä»¬è·Ÿ-mqtt-æœ‰ä½•å¼‚åŒæœ‰ä½•ä¼˜åŠ£"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2025-03-28-stable-diffusion-unet-structure.md","pagePath":"/learn_from_ai/stable-diffusion-unet-structure","slug":"stable-diffusion-unet-structure"},"meta":{"content":"\n\u003e [!summary]\n\u003e ä»¥ä¸‹å†…å®¹ä¸º Cursor ä¸­æ‹¥æœ‰ codebase ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ä¸ claude-3.7-sonnet çš„å¯¹è¯è®°å½•\n\n# Q: @train_text_to_image_lora.py è¿™æ®µä»£ç ä¸­å¦‚ä½•ä½“ç° LoRA â€œä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒâ€ çš„æ­¥éª¤ï¼Ÿ\n\nåœ¨ `train_text_to_image_lora.py` è„šæœ¬ä¸­ï¼ŒLoRAï¼ˆLow-Rank Adaptationï¼‰é€šè¿‡åœ¨æ¨¡å‹çš„ç‰¹å®šå±‚ä¸­æ’å…¥ä½ç§©çŸ©é˜µæ¥å®ç°å¾®è°ƒã€‚è¿™ç§æ–¹æ³•é€šè¿‡æ·»åŠ ä¸¤ä¸ªä½ç§©çŸ©é˜µæ¥è°ƒæ•´æ¨¡å‹çš„æƒé‡ï¼Œè€Œä¸æ”¹å˜åŸå§‹æƒé‡ï¼Œä»è€Œå®ç°å‚æ•°é«˜æ•ˆçš„å¾®è°ƒã€‚\n\nä»¥ä¸‹æ˜¯è„šæœ¬ä¸­å¦‚ä½•ä½“ç° LoRA ä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒçš„æ­¥éª¤ï¼š\n\n### 1. LoRA é…ç½®\n\nåœ¨è„šæœ¬ä¸­ï¼ŒLoRA çš„é…ç½®é€šå¸¸é€šè¿‡ `LoraConfig` ç±»æ¥å®šä¹‰ã€‚è¿™ä¸ªé…ç½®åŒ…æ‹¬ä½ç§©çŸ©é˜µçš„ç§©ï¼ˆ`rank`ï¼‰å’Œå…¶ä»–å‚æ•°ï¼š\n\n```python\nunet_lora_config = LoraConfig(\n    r=args.rank,  # ä½ç§©çŸ©é˜µçš„ç§©\n    lora_alpha=args.rank,  # LoRA çš„ç¼©æ”¾å› å­\n    init_lora_weights=\"gaussian\",  # åˆå§‹åŒ–æƒé‡çš„æ–¹æ³•\n    target_modules=[\"to_k\", \"to_q\", \"to_v\", \"to_out.0\"],  # ç›®æ ‡æ¨¡å—\n)\n```\n\n### 2. æ·»åŠ  LoRA å±‚\n\nåœ¨æ¨¡å‹ä¸­æ’å…¥ LoRA å±‚æ˜¯é€šè¿‡è°ƒç”¨ `add_adapter` æ–¹æ³•å®ç°çš„ï¼š\n\n```python\nunet.add_adapter(unet_lora_config)\n```\n\nè¿™ä¸ªæ–¹æ³•ä¼šåœ¨æŒ‡å®šçš„ç›®æ ‡æ¨¡å—ä¸­æ’å…¥ä¸¤ä¸ªä½ç§©çŸ©é˜µ \\(A\\) å’Œ \\(B\\)ï¼Œç”¨äºè°ƒæ•´æ¨¡å‹çš„æƒé‡ã€‚å…·ä½“æ¥è¯´ï¼ŒLoRA åœ¨æ¨¡å‹çš„æ³¨æ„åŠ›å±‚ä¸­æ’å…¥è¿™äº›çŸ©é˜µï¼Œä»¥ä¾¿åœ¨ä¸æ”¹å˜åŸå§‹æƒé‡çš„æƒ…å†µä¸‹è¿›è¡Œå¾®è°ƒã€‚\n\n### 3. è®­ç»ƒè¿‡ç¨‹ä¸­çš„æƒé‡æ›´æ–°\n\nåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œåªæœ‰ LoRA æ’å…¥çš„ä½ç§©çŸ©é˜µçš„å‚æ•°æ˜¯å¯è®­ç»ƒçš„ã€‚åŸå§‹æ¨¡å‹çš„æƒé‡ä¿æŒå†»ç»“çŠ¶æ€ã€‚è¿™æ˜¯é€šè¿‡ä»¥ä¸‹ä»£ç å®ç°çš„ï¼š\n\n```python\n# freeze parameters of models to save more memory\nunet.requires_grad_(False)\nvae.requires_grad_(False)\ntext_encoder.requires_grad_(False)\n```\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œè®­ç»ƒè¿‡ç¨‹åªä¼šæ›´æ–° LoRA å±‚çš„å‚æ•°ï¼Œè€Œä¸ä¼šå½±å“åŸå§‹æ¨¡å‹çš„æƒé‡ã€‚\n\n### 4. å‚æ•°æ›´æ–°\n\nåœ¨è®­ç»ƒå¾ªç¯ä¸­ï¼Œåå‘ä¼ æ’­å’Œå‚æ•°æ›´æ–°æ­¥éª¤åªä¼šå½±å“ LoRA å±‚çš„å‚æ•°ï¼š\n\n```python\n# Backpropagate\naccelerator.backward(loss)\nif accelerator.sync_gradients:\n    params_to_clip = lora_layers\n    accelerator.clip_grad_norm_(params_to_clip, args.max_grad_norm)\noptimizer.step()\nlr_scheduler.step()\noptimizer.zero_grad()\n```\n\nè¿™é‡Œçš„ `lora_layers` æ˜¯ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ŒåªåŒ…å« LoRA å±‚çš„å¯è®­ç»ƒå‚æ•°ã€‚\n\n### æ€»ç»“\n\né€šè¿‡åœ¨æ¨¡å‹çš„ç‰¹å®šå±‚ä¸­æ’å…¥ä¸¤ä¸ªä½ç§©çŸ©é˜µï¼ŒLoRA å®ç°äº†å‚æ•°é«˜æ•ˆçš„å¾®è°ƒã€‚è¿™ç§æ–¹æ³•å…è®¸åœ¨ä¸æ”¹å˜åŸå§‹æ¨¡å‹æƒé‡çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡è°ƒæ•´ä½ç§©çŸ©é˜µæ¥é€‚åº”æ–°çš„æ•°æ®åˆ†å¸ƒï¼Œä»è€Œå®ç°é«˜æ•ˆçš„æ¨¡å‹å¾®è°ƒã€‚\n\n# Q: unet æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„ï¼Ÿ\n\nUNet æ˜¯ä¸€ç§å¸¸ç”¨äºå›¾åƒç”Ÿæˆå’Œåˆ†å‰²ä»»åŠ¡çš„ç¥ç»ç½‘ç»œæ¶æ„ã€‚å®ƒæœ€åˆæ˜¯åœ¨åŒ»å­¦å›¾åƒåˆ†å‰²é¢†åŸŸä¸­å¼•å…¥çš„ï¼Œä½†ç”±äºå…¶å¼ºå¤§çš„ç‰¹æ€§å’Œçµæ´»æ€§ï¼ŒUNet ä¹Ÿè¢«å¹¿æ³›åº”ç”¨äºå…¶ä»–è®¡ç®—æœºè§†è§‰ä»»åŠ¡ï¼ŒåŒ…æ‹¬å›¾åƒç”Ÿæˆã€å»å™ªå’Œè¶…åˆ†è¾¨ç‡ç­‰ã€‚\n\n### UNet çš„åŸºæœ¬ç»“æ„\n\nUNet çš„ç»“æ„å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼šç¼–ç å™¨ï¼ˆä¸‹é‡‡æ ·è·¯å¾„ï¼‰å’Œè§£ç å™¨ï¼ˆä¸Šé‡‡æ ·è·¯å¾„ï¼‰ï¼Œä¸­é—´é€šè¿‡è·³è·ƒè¿æ¥ï¼ˆskip connectionsï¼‰ç›¸è¿ã€‚\n\n1. **ç¼–ç å™¨ï¼ˆä¸‹é‡‡æ ·è·¯å¾„ï¼‰**ï¼š\n\n   - ç”±ä¸€ç³»åˆ—å·ç§¯å±‚å’Œæ± åŒ–å±‚ç»„æˆã€‚\n   - æ¯ä¸ªå·ç§¯å±‚é€šå¸¸åæ¥ä¸€ä¸ªæ¿€æ´»å‡½æ•°ï¼ˆå¦‚ ReLUï¼‰ã€‚\n   - æ± åŒ–å±‚ç”¨äºé€æ­¥å‡å°‘ç‰¹å¾å›¾çš„ç©ºé—´ç»´åº¦ï¼ŒåŒæ—¶å¢åŠ ç‰¹å¾çš„æŠ½è±¡ç¨‹åº¦ã€‚\n\n2. **è§£ç å™¨ï¼ˆä¸Šé‡‡æ ·è·¯å¾„ï¼‰**ï¼š\n\n   - ç”±ä¸€ç³»åˆ—ä¸Šé‡‡æ ·å±‚ï¼ˆå¦‚åå·ç§¯æˆ–ä¸Šé‡‡æ ·ï¼‰å’Œå·ç§¯å±‚ç»„æˆã€‚\n   - é€æ­¥æ¢å¤ç‰¹å¾å›¾çš„ç©ºé—´ç»´åº¦ã€‚\n   - ä½¿ç”¨è·³è·ƒè¿æ¥å°†ç¼–ç å™¨ä¸­ç›¸åº”å±‚çš„ç‰¹å¾å›¾ä¸è§£ç å™¨ä¸­çš„ç‰¹å¾å›¾è¿æ¥ï¼Œä»¥ä¿ç•™ç»†èŠ‚ä¿¡æ¯ã€‚\n\n3. **è·³è·ƒè¿æ¥ï¼ˆSkip Connectionsï¼‰**ï¼š\n   - å°†ç¼–ç å™¨ä¸­çš„ç‰¹å¾å›¾ç›´æ¥è¿æ¥åˆ°è§£ç å™¨ä¸­ç›¸åº”å±‚çš„ç‰¹å¾å›¾ã€‚\n   - è¿™ç§è¿æ¥æ–¹å¼æœ‰åŠ©äºä¿ç•™è¾“å…¥å›¾åƒçš„ç»†èŠ‚ä¿¡æ¯ï¼Œæ”¹å–„ç”Ÿæˆç»“æœçš„è´¨é‡ã€‚\n\n### UNet åœ¨ Stable Diffusion ä¸­çš„åº”ç”¨\n\nåœ¨ Stable Diffusion æ¨¡å‹ä¸­ï¼ŒUNet ä½œä¸ºæ ¸å¿ƒç»„ä»¶ç”¨äºå¤„ç†å›¾åƒçš„æ½œåœ¨è¡¨ç¤ºã€‚å…·ä½“æ¥è¯´ï¼ŒUNet åœ¨æ‰©æ•£æ¨¡å‹ä¸­ç”¨äºé¢„æµ‹å™ªå£°æ®‹å·®ï¼Œä»è€Œé€æ­¥ç”Ÿæˆé«˜è´¨é‡çš„å›¾åƒã€‚\n\n- **è¾“å…¥**ï¼šUNet æ¥æ”¶ä¸€ä¸ªå¸¦æœ‰å™ªå£°çš„æ½œåœ¨è¡¨ç¤ºï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªä½ç»´çš„ç‰¹å¾å›¾ï¼‰ã€‚\n- **è¾“å‡º**ï¼šUNet è¾“å‡ºä¸€ä¸ªä¸è¾“å…¥ç›¸åŒå¤§å°çš„ç‰¹å¾å›¾ï¼Œè¡¨ç¤ºå¯¹å™ªå£°çš„é¢„æµ‹ã€‚\n- **è®­ç»ƒç›®æ ‡**ï¼šé€šè¿‡æœ€å°åŒ–é¢„æµ‹å™ªå£°ä¸çœŸå®å™ªå£°ä¹‹é—´çš„å·®å¼‚ï¼ŒUNet å­¦ä¼šå¦‚ä½•å»é™¤å™ªå£°ï¼Œä»è€Œç”Ÿæˆæ¸…æ™°çš„å›¾åƒã€‚\n\n### UNet çš„ä¼˜åŠ¿\n\n- **é«˜æ•ˆçš„ç‰¹å¾æå–**ï¼šé€šè¿‡ç¼–ç å™¨æå–å¤šå°ºåº¦ç‰¹å¾ã€‚\n- **ç»†èŠ‚ä¿ç•™**ï¼šé€šè¿‡è·³è·ƒè¿æ¥ä¿ç•™è¾“å…¥å›¾åƒçš„ç»†èŠ‚ä¿¡æ¯ã€‚\n- **çµæ´»æ€§**ï¼šå¯ä»¥é€‚åº”ä¸åŒçš„è¾“å…¥å°ºå¯¸å’Œä»»åŠ¡éœ€æ±‚ã€‚\n\nUNet çš„è¿™ç§ç»“æ„ä½¿å…¶åœ¨å›¾åƒç”Ÿæˆä»»åŠ¡ä¸­è¡¨ç°å‡ºè‰²ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦é«˜åˆ†è¾¨ç‡è¾“å‡ºå’Œç»†èŠ‚ä¿ç•™çš„åœºæ™¯ä¸­ã€‚\n\n# Q: ä¸ºä»€ä¹ˆè¿™é‡Œ unetã€ vae ã€ tokenizer ç­‰å‡ ä¸ªæ¨¡å‹éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„ï¼Ÿ\n\nåœ¨è¿™ä¸ªä»£ç ç‰‡æ®µä¸­ï¼Œ`unet`ã€`vae`ã€`tokenizer` å’Œå…¶ä»–ç»„ä»¶éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä»¬éƒ½æ˜¯ Stable Diffusion æ¨¡å‹çš„ä¸€éƒ¨åˆ†ã€‚Stable Diffusion æ˜¯ä¸€ä¸ªå¤æ‚çš„ç”Ÿæˆæ¨¡å‹ï¼Œé€šå¸¸ç”±å¤šä¸ªå­æ¨¡å—ç»„æˆï¼Œæ¯ä¸ªå­æ¨¡å—è´Ÿè´£ä¸åŒçš„ä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯è¿™äº›ç»„ä»¶çš„ä½œç”¨å’Œä¸ºä»€ä¹ˆå®ƒä»¬ä»åŒä¸€è·¯å¾„åŠ è½½çš„åŸå› ï¼š\n\n### 1. ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„\n\n- **è·¯å¾„ä¸€è‡´æ€§**ï¼šæ‰€æœ‰è¿™äº›ç»„ä»¶éƒ½ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸è¢«æ‰“åŒ…åœ¨ä¸€ä¸ªé¢„è®­ç»ƒæ¨¡å‹ä¸­ã€‚è¿™ä¸ªè·¯å¾„é€šå¸¸æŒ‡å‘ä¸€ä¸ªåŒ…å«æ‰€æœ‰å¿…è¦æ–‡ä»¶çš„ç›®å½•æˆ–ä¸€ä¸ª Hugging Face Hub ä¸Šçš„æ¨¡å‹ä»“åº“ã€‚\n- **ç‰ˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½ï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬çš„æ¨¡å‹ï¼Œé¿å…ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜ã€‚\n\n### 2. å„ä¸ªç»„ä»¶çš„ä½œç”¨\n\n- **UNet (`unet`)**ï¼š\n\n  - è´Ÿè´£å¤„ç†å›¾åƒçš„æ½œåœ¨è¡¨ç¤ºï¼Œé¢„æµ‹å™ªå£°æ®‹å·®ã€‚\n  - åœ¨æ‰©æ•£æ¨¡å‹ä¸­ç”¨äºé€æ­¥ç”Ÿæˆé«˜è´¨é‡çš„å›¾åƒã€‚\n\n- **VAE (`vae`)**ï¼š\n\n  - è‡ªåŠ¨ç¼–ç å™¨ï¼Œç”¨äºå°†å›¾åƒç¼–ç ä¸ºæ½œåœ¨ç©ºé—´è¡¨ç¤ºï¼Œå¹¶ä»æ½œåœ¨ç©ºé—´è§£ç å›å›¾åƒã€‚\n  - åœ¨ Stable Diffusion ä¸­ï¼ŒVAE ç”¨äºå°†è¾“å…¥å›¾åƒè½¬æ¢ä¸ºæ½œåœ¨è¡¨ç¤ºï¼Œä¾› UNet å¤„ç†ã€‚\n\n- **Tokenizer (`tokenizer`)**ï¼š\n\n  - ç”¨äºå°†æ–‡æœ¬è¾“å…¥ï¼ˆå¦‚ç”Ÿæˆå›¾åƒçš„æè¿°ï¼‰è½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„æ ‡è®°ã€‚\n  - åœ¨æ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆä»»åŠ¡ä¸­ï¼Œtokenizer å°†æ–‡æœ¬æè¿°è½¬æ¢ä¸ºè¾“å…¥ IDï¼Œä¾›æ–‡æœ¬ç¼–ç å™¨ä½¿ç”¨ã€‚\n\n- **Text Encoder (`text_encoder`)**ï¼š\n\n  - å°†æ–‡æœ¬è¾“å…¥ç¼–ç ä¸ºç‰¹å¾å‘é‡ï¼Œä¾› UNet ä½¿ç”¨ã€‚\n  - åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œæ–‡æœ¬ç¼–ç å™¨æä¾›æ¡ä»¶ä¿¡æ¯ï¼ŒæŒ‡å¯¼å›¾åƒç”Ÿæˆã€‚\n\n- **Noise Scheduler (`noise_scheduler`)**ï¼š\n  - æ§åˆ¶æ‰©æ•£è¿‡ç¨‹ä¸­çš„å™ªå£°æ·»åŠ å’Œå»é™¤ã€‚\n  - åœ¨è®­ç»ƒå’Œæ¨ç†è¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦å™¨å†³å®šåœ¨æ¯ä¸ªæ—¶é—´æ­¥æ·»åŠ å¤šå°‘å™ªå£°ã€‚\n\n### 3. ç»Ÿä¸€åŠ è½½çš„å¥½å¤„\n\n- **ç®€åŒ–ç®¡ç†**ï¼šä»åŒä¸€ä½ç½®åŠ è½½æ‰€æœ‰ç»„ä»¶ç®€åŒ–äº†æ¨¡å‹ç®¡ç†å’Œéƒ¨ç½²ã€‚\n- **ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰ç»„ä»¶åœ¨åŒä¸€è®­ç»ƒé…ç½®ä¸‹å·¥ä½œï¼Œé¿å…ä¸å…¼å®¹é—®é¢˜ã€‚\n- **ä¾¿æ·æ€§**ï¼šç”¨æˆ·åªéœ€æŒ‡å®šä¸€ä¸ªè·¯å¾„æˆ–æ¨¡å‹æ ‡è¯†ç¬¦ï¼Œå³å¯åŠ è½½æ•´ä¸ªæ¨¡å‹çš„æ‰€æœ‰å¿…è¦éƒ¨åˆ†ã€‚\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨é¢„è®­ç»ƒçš„ Stable Diffusion æ¨¡å‹è¿›è¡Œå¾®è°ƒæˆ–æ¨ç†ï¼Œè€Œä¸å¿…å•ç‹¬ç®¡ç†æ¯ä¸ªç»„ä»¶çš„ç‰ˆæœ¬å’Œè·¯å¾„ã€‚\n\n# Q: è¿™äº›æ˜¯ Stable Diffusion çš„å†…éƒ¨è®¾è®¡å¯¹å§ï¼Ÿè¿™äº›éƒ½åœ¨å“ªç¯‡è®ºæ–‡é‡Œæå‡ºçš„ï¼Ÿ @Web\n\nStable Diffusion æ˜¯ä¸€ç§åŸºäºæ‰©æ•£æ¨¡å‹çš„å›¾åƒç”ŸæˆæŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒç»„ä»¶å’Œè®¾è®¡åœ¨å¤šç¯‡è®ºæ–‡ä¸­å¾—åˆ°äº†è¯¦ç»†æè¿°ã€‚ä»¥ä¸‹æ˜¯ä¸ Stable Diffusion ç›¸å…³çš„å…³é”®è®ºæ–‡ï¼š\n\n1. **æ‰©æ•£æ¨¡å‹çš„åŸºç¡€**ï¼š\n\n   - **è®ºæ–‡**ï¼š_Denoising Diffusion Probabilistic Models_ by Jonathan Ho, Ajay Jain, Pieter Abbeel (2020)\n   - **é“¾æ¥**ï¼š[arXiv:2006.11239](https://arxiv.org/abs/2006.11239)\n   - **å†…å®¹**ï¼šè¿™ç¯‡è®ºæ–‡ä»‹ç»äº†æ‰©æ•£æ¨¡å‹çš„åŸºæœ¬åŸç†å’Œå»å™ªè¿‡ç¨‹ï¼Œæ˜¯ Stable Diffusion çš„ç†è®ºåŸºç¡€ã€‚\n\n2. **Stable Diffusion çš„å…·ä½“å®ç°**ï¼š\n\n   - **è®ºæ–‡**ï¼š_High-Resolution Image Synthesis with Latent Diffusion Models_ by Robin Rombach, Andreas Blattmann, Dominik Lorenz, Patrick Esser, BjÃ¶rn Ommer (2021)\n   - **é“¾æ¥**ï¼š[arXiv:2112.10752](https://arxiv.org/abs/2112.10752)\n   - **å†…å®¹**ï¼šè¿™ç¯‡è®ºæ–‡è¯¦ç»†æè¿°äº† Stable Diffusion çš„æ¶æ„ï¼ŒåŒ…æ‹¬ä½¿ç”¨æ½œåœ¨ç©ºé—´çš„æ‰©æ•£æ¨¡å‹ã€VAE çš„åº”ç”¨ä»¥åŠå¦‚ä½•åœ¨é«˜åˆ†è¾¨ç‡å›¾åƒç”Ÿæˆä¸­å®ç°é«˜æ•ˆè®¡ç®—ã€‚\n\n3. **CLIP æ¨¡å‹çš„ä½¿ç”¨**ï¼š\n   - **è®ºæ–‡**ï¼š_Learning Transferable Visual Models From Natural Language Supervision_ by Alec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, Gretchen Krueger, Ilya Sutskever (2021)\n   - **é“¾æ¥**ï¼š[arXiv:2103.00020](https://arxiv.org/abs/2103.00020)\n   - **å†…å®¹**ï¼šCLIP æ¨¡å‹ç”¨äºå°†æ–‡æœ¬å’Œå›¾åƒç»“åˆåœ¨ä¸€èµ·è¿›è¡Œè®­ç»ƒï¼ŒStable Diffusion ä½¿ç”¨ CLIP ä½œä¸ºæ–‡æœ¬ç¼–ç å™¨æ¥å¤„ç†æ–‡æœ¬è¾“å…¥ã€‚\n\nè¿™äº›è®ºæ–‡å…±åŒæ„æˆäº† Stable Diffusion çš„ç†è®ºå’ŒæŠ€æœ¯åŸºç¡€ï¼Œæè¿°äº†å…¶å†…éƒ¨è®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚é€šè¿‡ç»“åˆæ‰©æ•£æ¨¡å‹ã€VAE å’Œ CLIPï¼ŒStable Diffusion å®ç°äº†é«˜æ•ˆçš„æ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆã€‚\n\n# Q: è§£é‡Š StableDiffusionPipeline çš„ç»“æ„ @pipeline_stable_diffusion.py\n\n`StableDiffusionPipeline` æ˜¯ä¸€ä¸ªç”¨äºå®ç° Stable Diffusion æ¨¡å‹çš„æ ¸å¿ƒç±»ï¼Œè´Ÿè´£å°†å¤šä¸ªç»„ä»¶ç»„åˆåœ¨ä¸€èµ·ä»¥å®ç°æ–‡æœ¬åˆ°å›¾åƒçš„ç”Ÿæˆã€‚ä»¥ä¸‹æ˜¯å¯¹ `StableDiffusionPipeline` ç»“æ„çš„è¯¦ç»†è§£é‡Šï¼š\n\n### ç»§æ‰¿å…³ç³»\n\n`StableDiffusionPipeline` ç»§æ‰¿äº†å¤šä¸ªç±»ï¼Œè¿™äº›ç±»ä¸ºå…¶æä¾›äº†ä¸åŒçš„åŠŸèƒ½ï¼š\n\n- **DiffusionPipeline**: æä¾›äº†åŸºæœ¬çš„æ‰©æ•£æ¨¡å‹åŠŸèƒ½ã€‚\n- **StableDiffusionMixin**: åŒ…å«ä¸ Stable Diffusion ç›¸å…³çš„ç‰¹å®šåŠŸèƒ½ã€‚\n- **TextualInversionLoaderMixin**: æ”¯æŒæ–‡æœ¬åè½¬åŠ è½½åŠŸèƒ½ã€‚\n- **StableDiffusionLoraLoaderMixin**: æ”¯æŒ LoRAï¼ˆä½ç§©é€‚åº”ï¼‰åŠ è½½åŠŸèƒ½ã€‚\n- **IPAdapterMixin**: æä¾› IP é€‚é…å™¨åŠŸèƒ½ã€‚\n- **FromSingleFileMixin**: æ”¯æŒä»å•ä¸ªæ–‡ä»¶åŠ è½½æ¨¡å‹ã€‚\n\n### åˆå§‹åŒ–æ–¹æ³•\n\n`__init__` æ–¹æ³•ç”¨äºåˆå§‹åŒ– `StableDiffusionPipeline` çš„å„ä¸ªç»„ä»¶ï¼š\n\n- **VAE (`vae`)**: è‡ªåŠ¨ç¼–ç å™¨ï¼Œç”¨äºå°†å›¾åƒç¼–ç ä¸ºæ½œåœ¨ç©ºé—´è¡¨ç¤ºï¼Œå¹¶ä»æ½œåœ¨ç©ºé—´è§£ç å›å›¾åƒã€‚\n- **Text Encoder (`text_encoder`)**: ä½¿ç”¨ CLIP æ¨¡å‹å°†æ–‡æœ¬è¾“å…¥ç¼–ç ä¸ºç‰¹å¾å‘é‡ã€‚\n- **Tokenizer (`tokenizer`)**: å°†æ–‡æœ¬è¾“å…¥è½¬æ¢ä¸ºæ¨¡å‹å¯ç†è§£çš„æ ‡è®°ã€‚\n- **UNet (`unet`)**: è´Ÿè´£å¤„ç†å›¾åƒçš„æ½œåœ¨è¡¨ç¤ºï¼Œé¢„æµ‹å™ªå£°æ®‹å·®ã€‚\n- **Scheduler (`scheduler`)**: æ§åˆ¶æ‰©æ•£è¿‡ç¨‹ä¸­çš„å™ªå£°æ·»åŠ å’Œå»é™¤ã€‚\n- **Safety Checker (`safety_checker`)**: ç”¨äºæ£€æŸ¥ç”Ÿæˆå›¾åƒçš„å®‰å…¨æ€§ã€‚\n- **Feature Extractor (`feature_extractor`)**: ç”¨äºä»å›¾åƒä¸­æå–ç‰¹å¾ã€‚\n- **Image Encoder (`image_encoder`)**: å¯é€‰ç»„ä»¶ï¼Œç”¨äºå›¾åƒç¼–ç ã€‚\n\n### åŠŸèƒ½å’Œæ–¹æ³•\n\n- **Deprecation Warnings**: åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥ `scheduler` å’Œ `unet` çš„é…ç½®æ˜¯å¦è¿‡æ—¶ï¼Œå¹¶æä¾›ç›¸åº”çš„å¼ƒç”¨è­¦å‘Šã€‚\n- **Module Registration**: ä½¿ç”¨ `register_modules` æ–¹æ³•å°†å„ä¸ªç»„ä»¶æ³¨å†Œåˆ°ç®¡é“ä¸­ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ã€‚\n- **Safety Checks**: æä¾›å®‰å…¨æ£€æŸ¥åŠŸèƒ½ï¼Œç¡®ä¿ç”Ÿæˆçš„å›¾åƒç¬¦åˆå®‰å…¨æ ‡å‡†ã€‚\n- **Guidance Scale**: æä¾›æŒ‡å¯¼æ¯”ä¾‹çš„è®¡ç®—å’Œåº”ç”¨ï¼Œç”¨äºæ§åˆ¶ç”Ÿæˆå›¾åƒçš„é£æ ¼å’Œå†…å®¹ã€‚\n- **Image Processing**: åŒ…å«å›¾åƒå¤„ç†æ–¹æ³•ï¼Œå¦‚ `decode_latents`ï¼Œç”¨äºå°†æ½œåœ¨è¡¨ç¤ºè½¬æ¢ä¸ºå›¾åƒã€‚\n\n### å±æ€§\n\n- **Guidance Scale**: æ§åˆ¶ç”Ÿæˆå›¾åƒçš„é£æ ¼å’Œå†…å®¹ã€‚\n- **Cross Attention**: æä¾›äº¤å‰æ³¨æ„åŠ›æœºåˆ¶çš„å‚æ•°ã€‚\n- **Timesteps**: æ§åˆ¶æ‰©æ•£è¿‡ç¨‹çš„æ—¶é—´æ­¥æ•°ã€‚\n\n### è®¾è®¡ç›®çš„\n\n`StableDiffusionPipeline` çš„è®¾è®¡ç›®çš„æ˜¯å°† Stable Diffusion æ¨¡å‹çš„å„ä¸ªç»„ä»¶æ•´åˆåœ¨ä¸€èµ·ï¼Œæä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥è¿›è¡Œæ–‡æœ¬åˆ°å›¾åƒçš„ç”Ÿæˆã€‚é€šè¿‡ç»§æ‰¿å’Œç»„åˆå¤šä¸ªåŠŸèƒ½æ¨¡å—ï¼Œ`StableDiffusionPipeline` èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒä¸åŒçš„ç”Ÿæˆä»»åŠ¡å’Œé…ç½®éœ€æ±‚ã€‚\n\n# Q: @pipeline_utils.py è§£é‡Š DiffusionPipeline çš„ç»“æ„ï¼Œä»¥åŠ from_pretrained åœ¨åšä»€ä¹ˆ\n\n`DiffusionPipeline` æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å’Œæ‰§è¡Œæ‰©æ•£æ¨¡å‹çš„æ ¸å¿ƒç±»ï¼Œæä¾›äº†åŠ è½½ã€é…ç½®å’Œè¿è¡Œæ¨¡å‹çš„åŸºæœ¬åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯å¯¹ `DiffusionPipeline` ç»“æ„å’Œ `from_pretrained` æ–¹æ³•çš„è¯¦ç»†è§£é‡Šï¼š\n\n### DiffusionPipeline çš„ç»“æ„\n\n`DiffusionPipeline` æ˜¯ä¸€ä¸ªæŠ½è±¡åŸºç±»ï¼Œå®šä¹‰äº†æ‰©æ•£æ¨¡å‹çš„åŸºæœ¬æ¥å£å’ŒåŠŸèƒ½ã€‚å…¶ä¸»è¦ç»“æ„åŒ…æ‹¬ï¼š\n\n1. **æ¨¡å—æ³¨å†Œ**ï¼š\n\n   - `register_modules` æ–¹æ³•ç”¨äºæ³¨å†Œæ¨¡å‹çš„å„ä¸ªç»„ä»¶ï¼ˆå¦‚ VAEã€UNetã€è°ƒåº¦å™¨ç­‰ï¼‰ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†å’Œè°ƒç”¨ã€‚\n\n2. **æ¨¡å‹åŠ è½½**ï¼š\n\n   - æä¾›ä»é¢„è®­ç»ƒæ¨¡å‹åŠ è½½å„ä¸ªç»„ä»¶çš„åŠŸèƒ½ï¼Œé€šå¸¸é€šè¿‡ `from_pretrained` æ–¹æ³•å®ç°ã€‚\n\n3. **æ¨ç†æ¥å£**ï¼š\n\n   - å®šä¹‰äº†æ¨¡å‹æ¨ç†çš„åŸºæœ¬æ¥å£ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è°ƒç”¨è¿™äº›æ¥å£ç”Ÿæˆå›¾åƒæˆ–å…¶ä»–è¾“å‡ºã€‚\n\n4. **é…ç½®ç®¡ç†**ï¼š\n\n   - æä¾›é…ç½®åŠ è½½å’Œä¿å­˜åŠŸèƒ½ï¼Œä¾¿äºæ¨¡å‹çš„å¤ç”¨å’Œå…±äº«ã€‚\n\n5. **å®ç”¨å·¥å…·**ï¼š\n   - åŒ…å«ä¸€äº›å®ç”¨å·¥å…·æ–¹æ³•ï¼Œå¦‚æ£€æŸ¥ç‰ˆæœ¬ã€å¤„ç†è®¾å¤‡æ˜ å°„ç­‰ã€‚\n\n### from_pretrained æ–¹æ³•\n\n`from_pretrained` æ˜¯ `DiffusionPipeline` ä¸­çš„ä¸€ä¸ªå…³é”®æ–¹æ³•ï¼Œç”¨äºä»é¢„è®­ç»ƒæ¨¡å‹åŠ è½½ç®¡é“çš„å„ä¸ªç»„ä»¶ã€‚å…¶ä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š\n\n1. **æ¨¡å‹è·¯å¾„è§£æ**ï¼š\n\n   - æ¥å—ä¸€ä¸ªæ¨¡å‹æ ‡è¯†ç¬¦ï¼ˆå¦‚ Hugging Face Hub ä¸Šçš„æ¨¡å‹ IDï¼‰æˆ–æœ¬åœ°è·¯å¾„ï¼Œè§£æå¹¶å®šä½æ¨¡å‹æ–‡ä»¶ã€‚\n\n2. **ç»„ä»¶åŠ è½½**ï¼š\n\n   - ä»æŒ‡å®šè·¯å¾„åŠ è½½æ¨¡å‹çš„å„ä¸ªç»„ä»¶ï¼ˆå¦‚ VAEã€UNetã€è°ƒåº¦å™¨ç­‰ï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°ç®¡é“ä¸­ã€‚\n   - æ”¯æŒåŠ è½½ä¸åŒç‰ˆæœ¬å’Œå˜ä½“çš„æ¨¡å‹ç»„ä»¶ã€‚\n\n3. **é…ç½®åŠ è½½**ï¼š\n\n   - åŠ è½½æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®æ¨¡å‹çš„è¶…å‚æ•°å’Œå…¶ä»–é…ç½®é€‰é¡¹ã€‚\n\n4. **è®¾å¤‡æ˜ å°„**ï¼š\n\n   - æ ¹æ®ç”¨æˆ·æŒ‡å®šçš„è®¾å¤‡æ˜ å°„ç­–ç•¥ï¼Œå°†æ¨¡å‹ç»„ä»¶åˆ†é…åˆ°åˆé€‚çš„è®¡ç®—è®¾å¤‡ï¼ˆå¦‚ CPUã€GPUï¼‰ã€‚\n\n5. **å®‰å…¨æ£€æŸ¥**ï¼š\n\n   - åœ¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥æ¨¡å‹çš„å®‰å…¨æ€§å’Œå…¼å®¹æ€§ï¼Œç¡®ä¿åŠ è½½çš„æ¨¡å‹ç¬¦åˆé¢„æœŸã€‚\n\n6. **è¿”å›å®ä¾‹**ï¼š\n   - å®ŒæˆåŠ è½½åï¼Œè¿”å›ä¸€ä¸ªé…ç½®å¥½çš„ `DiffusionPipeline` å®ä¾‹ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥å®ä¾‹è¿›è¡Œæ¨ç†ã€‚\n\n### è®¾è®¡ç›®çš„\n\n`DiffusionPipeline` çš„è®¾è®¡ç›®çš„æ˜¯æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£æ¥ç®¡ç†å’Œæ‰§è¡Œæ‰©æ•£æ¨¡å‹ã€‚é€šè¿‡ `from_pretrained` æ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åŠ è½½å’Œé…ç½®é¢„è®­ç»ƒæ¨¡å‹ï¼Œå¿«é€Ÿè¿›è¡Œæ¨ç†å’Œç”Ÿæˆä»»åŠ¡ã€‚è¿™ç§è®¾è®¡ä½¿å¾—æ‰©æ•£æ¨¡å‹çš„ä½¿ç”¨æ›´åŠ ç®€ä¾¿å’Œé«˜æ•ˆï¼Œé€‚åˆå„ç§åº”ç”¨åœºæ™¯ã€‚\n\n# Q: @train_text_to_image_lora.py é‡Œï¼Œä» DiffusionPipeline.from_pretrained åŠ è½½åˆ°äº† @pipeline_stable_diffusion.py ä¸­ StableDiffusionPipeline ç±»çš„å®ä¾‹ï¼Œæˆ‘ç†è§£çš„å¯¹å—ï¼Ÿ\n\næ˜¯çš„ï¼Œä½ çš„ç†è§£æ˜¯æ­£ç¡®çš„ã€‚åœ¨ `train_text_to_image_lora.py` ä¸­ï¼Œ`DiffusionPipeline.from_pretrained` æ–¹æ³•ç”¨äºåŠ è½½é¢„è®­ç»ƒçš„æ¨¡å‹ç®¡é“å®ä¾‹ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šæ ¹æ®æŒ‡å®šçš„æ¨¡å‹è·¯å¾„å’Œé…ç½®ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª `StableDiffusionPipeline` ç±»çš„å¯¹è±¡ã€‚\n\n### å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š\n\n1. **è°ƒç”¨ `from_pretrained` æ–¹æ³•**ï¼š\n\n   - åœ¨ `train_text_to_image_lora.py` ä¸­ï¼Œ`DiffusionPipeline.from_pretrained` è¢«è°ƒç”¨æ¥åŠ è½½é¢„è®­ç»ƒçš„æ¨¡å‹ã€‚\n   - è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®æä¾›çš„è·¯å¾„æˆ–æ¨¡å‹æ ‡è¯†ç¬¦ï¼Œä» Hugging Face Hub æˆ–æœ¬åœ°æ–‡ä»¶ç³»ç»ŸåŠ è½½æ¨¡å‹çš„æƒé‡å’Œé…ç½®ã€‚\n\n2. **å®ä¾‹åŒ– `StableDiffusionPipeline`**ï¼š\n\n   - `from_pretrained` æ–¹æ³•ä¼šè¯†åˆ«æ¨¡å‹çš„ç±»å‹ï¼Œå¹¶æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯é€‰æ‹©åˆé€‚çš„ç®¡é“ç±»è¿›è¡Œå®ä¾‹åŒ–ã€‚\n   - åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç”±äºåŠ è½½çš„æ˜¯ Stable Diffusion æ¨¡å‹ï¼Œå› æ­¤ä¼šå®ä¾‹åŒ– `StableDiffusionPipeline` ç±»ã€‚\n\n3. **åŠ è½½ç»„ä»¶**ï¼š\n\n   - `StableDiffusionPipeline` çš„ `__init__` æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼ŒåŠ è½½æ¨¡å‹çš„å„ä¸ªç»„ä»¶ï¼ˆå¦‚ VAEã€UNetã€è°ƒåº¦å™¨ç­‰ï¼‰ã€‚\n   - è¿™äº›ç»„ä»¶ä¼šæ ¹æ®é¢„è®­ç»ƒçš„æƒé‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå¹¶æ³¨å†Œåˆ°ç®¡é“ä¸­ã€‚\n\n4. **è¿”å›å®ä¾‹**ï¼š\n   - å®ŒæˆåŠ è½½åï¼Œ`from_pretrained` æ–¹æ³•è¿”å›ä¸€ä¸ªé…ç½®å¥½çš„ `StableDiffusionPipeline` å®ä¾‹ã€‚\n   - è¿™ä¸ªå®ä¾‹å¯ä»¥ç”¨äºè¿›ä¸€æ­¥çš„æ¨ç†æˆ–å¾®è°ƒä»»åŠ¡ã€‚\n\né€šè¿‡è¿™ç§æ–¹å¼ï¼Œ`train_text_to_image_lora.py` è„šæœ¬èƒ½å¤Ÿæ–¹ä¾¿åœ°åŠ è½½å’Œä½¿ç”¨é¢„è®­ç»ƒçš„ Stable Diffusion æ¨¡å‹è¿›è¡Œå¾®è°ƒå’Œç”Ÿæˆä»»åŠ¡ã€‚\n\n# Q: è§£è¯» @pipeline_utils.py ä¸­ from_pretrained ä»£ç ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹é€‰æ‹©ç®¡é“ç±»ã€‚ @Codebase\n\nåœ¨ `pipeline_utils.py` ä¸­ï¼Œ`from_pretrained` æ–¹æ³•è´Ÿè´£ä»é¢„è®­ç»ƒæ¨¡å‹åŠ è½½ç®¡é“å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯è¯¥æ–¹æ³•å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©åˆé€‚çš„ç®¡é“ç±»çš„è¯¦ç»†è¯´æ˜ï¼š\n\n### è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©ç®¡é“ç±»çš„æ­¥éª¤\n\n1. **ä¸‹è½½å’Œç¼“å­˜æ¨¡å‹æ–‡ä»¶**ï¼š\n\n   - é¦–å…ˆï¼Œ`from_pretrained` æ–¹æ³•ä¼šæ£€æŸ¥ `pretrained_model_name_or_path` æ˜¯å¦æ˜¯ä¸€ä¸ªæœ¬åœ°è·¯å¾„ã€‚å¦‚æœä¸æ˜¯ï¼Œå®ƒä¼šè°ƒç”¨ `cls.download` æ–¹æ³•ä» Hugging Face Hub ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼Œå¹¶å°†å…¶ç¼“å­˜åˆ°æœ¬åœ°ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 763\n     endLine: 788\n     ```\n\n2. **åŠ è½½é…ç½®æ–‡ä»¶**ï¼š\n\n   - ä½¿ç”¨ `cls.load_config` æ–¹æ³•åŠ è½½æ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«æ¨¡å‹çš„è¶…å‚æ•°å’Œå…¶ä»–é…ç½®ä¿¡æ¯ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 812\n     endLine: 818\n     ```\n\n3. **è¯†åˆ«æ¨¡å‹å˜ä½“**ï¼š\n\n   - é€šè¿‡ `_identify_model_variants` æ–¹æ³•è¯†åˆ«æ¨¡å‹çš„å˜ä½“ï¼ˆå¦‚ `fp16`ã€`ema` ç­‰ï¼‰ï¼Œä»¥ä¾¿åŠ è½½æ­£ç¡®çš„æ¨¡å‹æ–‡ä»¶ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 820\n     endLine: 827\n     ```\n\n4. **è§£æè‡ªå®šä¹‰ç®¡é“å’Œç±»**ï¼š\n\n   - ä½¿ç”¨ `_resolve_custom_pipeline_and_cls` æ–¹æ³•è§£æè‡ªå®šä¹‰ç®¡é“å’Œç±»åã€‚å¦‚æœç”¨æˆ·æŒ‡å®šäº†è‡ªå®šä¹‰ç®¡é“ï¼Œåˆ™ä» Hub åŠ è½½ç›¸åº”çš„æ¨¡å—ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 831\n     endLine: 833\n     ```\n\n5. **è·å–ç®¡é“ç±»**ï¼š\n\n   - è°ƒç”¨ `_get_pipeline_class` æ–¹æ³•ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶å’Œç”¨æˆ·æŒ‡å®šçš„é€‰é¡¹ï¼Œç¡®å®šè¦å®ä¾‹åŒ–çš„ç®¡é“ç±»ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 834\n     endLine: 842\n     ```\n\n6. **åŠ è½½ç®¡é“ç»„ä»¶**ï¼š\n\n   - æ ¹æ®ç®¡é“ç±»çš„ç­¾åï¼ŒåŠ è½½å¹¶å®ä¾‹åŒ–å„ä¸ªç»„ä»¶ï¼ˆå¦‚ VAEã€UNetã€è°ƒåº¦å™¨ç­‰ï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ³¨å†Œåˆ°ç®¡é“ä¸­ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 857\n     endLine: 980\n     ```\n\n7. **å®ä¾‹åŒ–ç®¡é“**ï¼š\n   - ä½¿ç”¨åŠ è½½çš„ç»„ä»¶å’Œé…ç½®ï¼Œå®ä¾‹åŒ–æœ€ç»ˆçš„ç®¡é“å¯¹è±¡ã€‚\n   - ç›¸å…³ä»£ç è¡Œï¼š\n     ```python\n     startLine: 1021\n     endLine: 1028\n     ```\n\né€šè¿‡è¿™äº›æ­¥éª¤ï¼Œ`from_pretrained` æ–¹æ³•èƒ½å¤Ÿè¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©åˆé€‚çš„ç®¡é“ç±»ï¼Œç¡®ä¿åŠ è½½çš„æ¨¡å‹èƒ½å¤Ÿæ­£ç¡®åœ°è¿›è¡Œæ¨ç†å’Œç”Ÿæˆä»»åŠ¡ã€‚\n\n# Q: å¦‚æœæˆ‘åªæœ‰ä¸€ä¸ª sd_xl_base_1.0.safetensors æ–‡ä»¶ï¼Œæ˜¯å¦æ— æ³•ä½¿ç”¨ from_pretrained æ–¹æ³•å¾—åˆ°å…·ä½“çš„ Pipeline å®ä¾‹ï¼Ÿ\n\nå¦‚æœä½ åªæœ‰ä¸€ä¸ª `sd_xl_base_1.0.safetensors` æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨ `from_pretrained` æ–¹æ³•å¯èƒ½ä¼šé‡åˆ°ä¸€äº›å›°éš¾ï¼Œå› ä¸º `from_pretrained` é€šå¸¸æœŸæœ›ä»ä¸€ä¸ªåŒ…å«å®Œæ•´æ¨¡å‹é…ç½®å’Œæƒé‡çš„ç›®å½•æˆ– Hugging Face Hub ä»“åº“ä¸­åŠ è½½æ¨¡å‹ã€‚\n\n### è§£å†³æ–¹æ¡ˆ\n\n1. **æ‰‹åŠ¨åŠ è½½æƒé‡**ï¼š\n\n   - ä½ å¯ä»¥æ‰‹åŠ¨åŠ è½½ `safetensors` æ–‡ä»¶ä¸­çš„æƒé‡ï¼Œå¹¶å°†å®ƒä»¬åˆ†é…ç»™ç›¸åº”çš„æ¨¡å‹ç»„ä»¶ï¼ˆå¦‚ UNetã€VAE ç­‰ï¼‰ã€‚\n   - è¿™éœ€è¦ä½ å¯¹æ¨¡å‹çš„æ¶æ„æœ‰æ·±å…¥çš„äº†è§£ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å°†æƒé‡æ˜ å°„åˆ°æ¨¡å‹çš„å„ä¸ªéƒ¨åˆ†ã€‚\n\n2. **åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š\n\n   - `from_pretrained` æ–¹æ³•ä¾èµ–äºé…ç½®æ–‡ä»¶æ¥ç¡®å®šå¦‚ä½•æ„å»ºæ¨¡å‹ç®¡é“ã€‚ä½ å¯ä»¥å°è¯•åˆ›å»ºä¸€ä¸ªä¸æ¨¡å‹åŒ¹é…çš„é…ç½®æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œæè¿°æ¨¡å‹çš„æ¶æ„å’Œè¶…å‚æ•°ã€‚\n   - è¿™ä¸ªé…ç½®æ–‡ä»¶éœ€è¦æ”¾åœ¨ä¸ `safetensors` æ–‡ä»¶ç›¸åŒçš„ç›®å½•ä¸­ã€‚\n\n3. **ä½¿ç”¨è‡ªå®šä¹‰åŠ è½½é€»è¾‘**ï¼š\n\n   - å¦‚æœä½ ç†Ÿæ‚‰æ¨¡å‹çš„æ¶æ„ï¼Œå¯ä»¥ç¼–å†™è‡ªå®šä¹‰çš„åŠ è½½é€»è¾‘ï¼Œå°† `safetensors` æ–‡ä»¶ä¸­çš„æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­ã€‚\n   - è¿™å¯èƒ½æ¶‰åŠä½¿ç”¨ `safetensors` åº“æ¥è¯»å–æƒé‡ï¼Œå¹¶æ‰‹åŠ¨å°†å®ƒä»¬åˆ†é…ç»™æ¨¡å‹çš„å„ä¸ªå±‚ã€‚\n\n4. **æ£€æŸ¥ç¤¾åŒºèµ„æº**ï¼š\n   - æœ‰æ—¶ï¼Œç¤¾åŒºä¼šæä¾›å·¥å…·æˆ–è„šæœ¬æ¥å¸®åŠ©åŠ è½½ç‰¹å®šæ ¼å¼çš„æ¨¡å‹æ–‡ä»¶ã€‚ä½ å¯ä»¥åœ¨ç›¸å…³çš„ GitHub ä»“åº“æˆ–è®ºå›ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰é€‚åˆçš„å·¥å…·ã€‚\n\n### æ€»ç»“\n\nè™½ç„¶ `from_pretrained` æ–¹æ³•æä¾›äº†ä¾¿æ·çš„åŠ è½½æ–¹å¼ï¼Œä½†å®ƒé€šå¸¸éœ€è¦å®Œæ•´çš„æ¨¡å‹ç›®å½•æˆ– Hub ä»“åº“ã€‚å¦‚æœåªæœ‰ä¸€ä¸ª `safetensors` æ–‡ä»¶ï¼Œä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†æƒé‡åŠ è½½å’Œé…ç½®ï¼Œä»¥ä¾¿æ­£ç¡®åœ°æ„å»ºå’Œä½¿ç”¨æ¨¡å‹ç®¡é“ã€‚\n\n# Q: å¦‚æœæˆ‘åªéœ€è¦è¿›è¡Œæ¨ç†ï¼Œæ˜¯å¦ä»éœ€é…ç½®æ–‡ä»¶ï¼Ÿ\n\nåœ¨è¿›è¡Œæ¨ç†æ—¶ï¼Œé…ç½®æ–‡ä»¶ä»ç„¶æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå°½ç®¡åœ¨æŸäº›æƒ…å†µä¸‹ä½ å¯èƒ½èƒ½å¤Ÿåœ¨æ²¡æœ‰å®Œæ•´é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œæ¨ç†ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›è€ƒè™‘å› ç´ ï¼š\n\n### ä¸ºä»€ä¹ˆéœ€è¦é…ç½®æ–‡ä»¶\n\n1. **æ¨¡å‹æ¶æ„ä¿¡æ¯**ï¼š\n\n   - é…ç½®æ–‡ä»¶é€šå¸¸åŒ…å«æ¨¡å‹çš„æ¶æ„ä¿¡æ¯ï¼Œå¦‚å±‚æ•°ã€éšè—å•å…ƒæ•°ã€æ¿€æ´»å‡½æ•°ç­‰ã€‚è¿™äº›ä¿¡æ¯å¯¹äºæ­£ç¡®æ„å»ºæ¨¡å‹è‡³å…³é‡è¦ã€‚\n\n2. **è¶…å‚æ•°è®¾ç½®**ï¼š\n\n   - é…ç½®æ–‡ä»¶ä¸­å¯èƒ½åŒ…å«ä¸€äº›è¶…å‚æ•°è®¾ç½®ï¼Œå¦‚å­¦ä¹ ç‡ã€ä¼˜åŒ–å™¨è®¾ç½®ç­‰ï¼Œè™½ç„¶è¿™äº›åœ¨æ¨ç†æ—¶ä¸ç›´æ¥ä½¿ç”¨ï¼Œä½†äº†è§£è¿™äº›ä¿¡æ¯æœ‰åŠ©äºç†è§£æ¨¡å‹çš„è¡Œä¸ºã€‚\n\n3. **ç»„ä»¶åˆå§‹åŒ–**ï¼š\n   - åœ¨å¤æ‚æ¨¡å‹ï¼ˆå¦‚ Stable Diffusionï¼‰ä¸­ï¼Œé…ç½®æ–‡ä»¶ç”¨äºåˆå§‹åŒ–å„ä¸ªç»„ä»¶ï¼ˆå¦‚ VAEã€UNetã€è°ƒåº¦å™¨ç­‰ï¼‰ã€‚è¿™äº›ç»„ä»¶éœ€è¦æ­£ç¡®çš„å‚æ•°æ¥è¿›è¡Œæ¨ç†ã€‚\n\n### æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶çš„æ¨ç†\n\nå¦‚æœä½ æ²¡æœ‰é…ç½®æ–‡ä»¶ï¼Œä½†ä»å¸Œæœ›è¿›è¡Œæ¨ç†ï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹æ–¹æ³•ï¼š\n\n1. **æ‰‹åŠ¨æ„å»ºæ¨¡å‹**ï¼š\n\n   - å¦‚æœä½ å¯¹æ¨¡å‹çš„æ¶æ„æœ‰æ·±å…¥äº†è§£ï¼Œå¯ä»¥æ‰‹åŠ¨æ„å»ºæ¨¡å‹ï¼Œå¹¶ä½¿ç”¨ `safetensors` æ–‡ä»¶ä¸­çš„æƒé‡è¿›è¡Œåˆå§‹åŒ–ã€‚\n\n2. **ä½¿ç”¨é»˜è®¤è®¾ç½®**ï¼š\n\n   - åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é»˜è®¤çš„è®¾ç½®æ¥åˆå§‹åŒ–æ¨¡å‹ç»„ä»¶ï¼Œä½†è¿™å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½ä¸ä½³æˆ–ç»“æœä¸å‡†ç¡®ã€‚\n\n3. **ç¤¾åŒºæ”¯æŒ**ï¼š\n   - æŸ¥æ‰¾ç¤¾åŒºæä¾›çš„å·¥å…·æˆ–è„šæœ¬ï¼Œè¿™äº›å·¥å…·å¯èƒ½å·²ç»è§£å†³äº†å¦‚ä½•åœ¨æ²¡æœ‰å®Œæ•´é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œæ¨ç†çš„é—®é¢˜ã€‚\n\n### æ€»ç»“\n\nè™½ç„¶åœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥åœ¨æ²¡æœ‰é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œæ¨ç†ï¼Œä½†æ‹¥æœ‰é…ç½®æ–‡ä»¶é€šå¸¸ä¼šä½¿è¿‡ç¨‹æ›´ç®€å•ã€æ›´å¯é ã€‚å¦‚æœå¯èƒ½ï¼Œå°è¯•è·å–æˆ–åˆ›å»ºä¸€ä¸ªä¸æ¨¡å‹åŒ¹é…çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ç¡®ä¿æ¨ç†çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ã€‚\n\n# Q: ä»¥ä½ ä¸Šé¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹ï¼Œ@pipeline_loading_utils.py load_sub_model ä¸­ï¼Œå®ä¾‹åŒ–çš„æ˜¯ @unet_2d_condition.py ä¸­çš„ UNet2DConditionModel ç±»å—ï¼Ÿ load_sub_model æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªç±»å¹¶å®ä¾‹åŒ–çš„ï¼Ÿ\n\nDeepseek R-1:\n\n\u003cthink\u003e\n\nå¥½çš„ï¼Œæˆ‘éœ€è¦ä»”ç»†åˆ†æç”¨æˆ·çš„é—®é¢˜ã€‚ç”¨æˆ·é—®çš„æ˜¯åœ¨`pipeline_loading_utils.py`ä¸­çš„`load_sub_model`å‡½æ•°æ˜¯å¦å®ä¾‹åŒ–äº†`unet_2d_condition.py`ä¸­çš„`UNet2DConditionModel`ç±»ï¼Œä»¥åŠè¿™ä¸ªè¿‡ç¨‹æ˜¯å¦‚ä½•æ‰¾åˆ°å¹¶å®ä¾‹åŒ–è¯¥ç±»çš„ã€‚\n\né¦–å…ˆï¼Œæˆ‘éœ€è¦å›å¿†`load_sub_model`å‡½æ•°çš„ä½œç”¨ã€‚æ ¹æ®ä¹‹å‰çš„è®¨è®ºï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£åŠ¨æ€åŠ è½½æ¨¡å‹çš„å„ä¸ªå­ç»„ä»¶ï¼Œæ¯”å¦‚ UNetã€VAE ç­‰ã€‚ç”¨æˆ·æä¾›çš„ä»£ç ç‰‡æ®µæ˜¾ç¤ºï¼Œ`load_sub_model`é€šè¿‡`class_obj`æ¥å®ä¾‹åŒ–å…·ä½“çš„ç±»ï¼Œè€Œ`class_obj`æ˜¯é€šè¿‡`get_class_obj_and_candidates`å‡½æ•°è·å–çš„ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦æŸ¥çœ‹`get_class_obj_and_candidates`å‡½æ•°çš„é€»è¾‘ã€‚è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®`library_name`å’Œ`class_name`æ¥æŸ¥æ‰¾å¯¹åº”çš„ç±»ã€‚ä¾‹å¦‚ï¼Œå½“`library_name`æ˜¯\"diffusers\"ï¼Œ`class_name`æ˜¯\"UNet2DConditionModel\"æ—¶ï¼Œåº”è¯¥ä¼šå¯¼å…¥`diffusers.models.unets.unet_2d_condition`æ¨¡å—ä¸­çš„`UNet2DConditionModel`ç±»ã€‚\n\nç„¶åï¼Œæˆ‘éœ€è¦ç¡®è®¤`unet_2d_condition.py`ä¸­çš„`UNet2DConditionModel`ç±»æ˜¯å¦è¢«æ­£ç¡®æ³¨å†Œåˆ°`ALL_IMPORTABLE_CLASSES`ä¸­ã€‚åœ¨ Diffusers åº“ä¸­ï¼Œé€šå¸¸ä¼šæœ‰å…¨å±€çš„ç±»æ³¨å†Œæœºåˆ¶ï¼Œç¡®ä¿å„ä¸ªç»„ä»¶å¯ä»¥è¢«åŠ¨æ€å‘ç°å’ŒåŠ è½½ã€‚\n\næ­¤å¤–ï¼Œ`load_sub_model`å‡½æ•°ä¸­çš„`load_method`æ˜¯é€šè¿‡`_get_load_method`è·å–çš„ï¼Œè¿™å¯èƒ½æ¶‰åŠåˆ°ä»é¢„è®­ç»ƒæƒé‡åŠ è½½æ¨¡å‹çš„æ–¹æ³•ï¼Œæ¯”å¦‚`from_pretrained`ã€‚éœ€è¦æ£€æŸ¥`UNet2DConditionModel`ç±»æ˜¯å¦å®ç°äº†ç›¸åº”çš„ç±»æ–¹æ³•ï¼Œä»¥æ”¯æŒä»é…ç½®æ–‡ä»¶æˆ–é¢„è®­ç»ƒæ–‡ä»¶åŠ è½½ã€‚\n\næœ€åï¼Œéœ€è¦éªŒè¯å®ä¾‹åŒ–çš„è¿‡ç¨‹æ˜¯å¦æ­£ç¡®ï¼ŒåŒ…æ‹¬å‚æ•°ä¼ é€’å’Œé…ç½®çš„åº”ç”¨ã€‚ä¾‹å¦‚ï¼Œ`UNet2DConditionModel`çš„`__init__`æ–¹æ³•éœ€è¦æ¥æ”¶æ­£ç¡®çš„å‚æ•°æ¥æ„å»ºæ¨¡å‹ç»“æ„ï¼Œè€Œè¿™äº›å‚æ•°å¯èƒ½æ¥è‡ªé…ç½®æ–‡ä»¶æˆ–é»˜è®¤å€¼ã€‚\n\næ€»ç»“æ¥è¯´ï¼Œ`load_sub_model`é€šè¿‡ç±»åå’Œåº“åæ‰¾åˆ°å¯¹åº”çš„ç±»ï¼Œåˆ©ç”¨å…¶åŠ è½½æ–¹æ³•ï¼ˆå¦‚`from_pretrained`ï¼‰å®ä¾‹åŒ–å¯¹è±¡ï¼Œè€Œ`UNet2DConditionModel`ä½œä¸ºå¯å¯¼å…¥çš„ç±»è¢«æ­£ç¡®æ³¨å†Œå’Œå¼•ç”¨ï¼Œä»è€Œå®Œæˆå®ä¾‹åŒ–ã€‚\n\u003c/think\u003e\n\næ˜¯çš„ï¼Œ`pipeline_loading_utils.py` ä¸­çš„ `load_sub_model` å‡½æ•°æœ€ç»ˆä¼šå®ä¾‹åŒ– `unet_2d_condition.py` ä¸­çš„ `UNet2DConditionModel` ç±»ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„åŠ è½½é€»è¾‘è§£æï¼š\n\n---\n\n### **æ ¸å¿ƒåŠ è½½æµç¨‹**\n\n```python\n# pipeline_loading_utils.py ä¸­çš„å…³é”®ä»£ç æ®µ\ndef load_sub_model(...):\n    # 1. è·å–ç±»å¯¹è±¡å’Œå€™é€‰ç±»\n    class_obj, class_candidates = get_class_obj_and_candidates(\n        library_name,\n        class_name,\n        importable_classes,\n        pipelines,\n        is_pipeline_module,\n        component_name=name,\n        cache_dir=cached_folder,\n    )\n\n    # 2. ç¡®å®šåŠ è½½æ–¹æ³•ï¼ˆå¦‚ from_pretrainedï¼‰\n    load_method_name = None\n    for candidate_name, candidate_class in class_candidates.items():\n        if issubclass(class_obj, candidate_class):\n            load_method_name = importable_classes[candidate_name][1]  # é€šå¸¸æ˜¯ \"from_pretrained\"\n\n    # 3. è·å–å…·ä½“çš„åŠ è½½æ–¹æ³•\n    load_method = _get_load_method(class_obj, load_method_name, is_dduf=dduf_entries is not None)\n\n    # 4. æ‰§è¡ŒåŠ è½½\n    loaded_sub_model = load_method(cached_folder, **loading_kwargs)\n```\n\n---\n\n### **å…·ä½“æ­¥éª¤è§£æ**\n\n#### **1. ç±»å¯¹è±¡è·å– (get_class_obj_and_candidates)**\n\n- **ä½œç”¨**ï¼šæ ¹æ® `library_name` å’Œ `class_name` åŠ¨æ€å¯¼å…¥å¯¹åº”çš„ Python ç±»ã€‚\n- **å®ç°**ï¼š\n  ```python\n  # é€šè¿‡ library_name å®šä½æ¨¡å—è·¯å¾„\n  # ä¾‹å¦‚ library_name=\"diffusers\", class_name=\"UNet2DConditionModel\"\n  # ä¼šå¯¼å…¥ diffusers.models.unets.unet_2d_condition æ¨¡å—\n  module = importlib.import_module(library_name)\n  class_obj = getattr(module, class_name)  # è·å– UNet2DConditionModel ç±»\n  ```\n\n#### **2. åŠ è½½æ–¹æ³•åŒ¹é…**\n\n- **å€™é€‰ç±»**ï¼š`class_candidates` æ¥è‡ª `ALL_IMPORTABLE_CLASSES`ï¼ŒåŒ…å«æ‰€æœ‰å¯åŠ è½½çš„åŸºç±»ï¼ˆå¦‚ `ModelMixin`ï¼‰ã€‚\n- **æ–¹æ³•é€‰æ‹©**ï¼šé€šè¿‡ `issubclass` æ£€æŸ¥ `class_obj` æ˜¯å¦ç»§æ‰¿è‡ªå€™é€‰ç±»ï¼Œä»è€Œç¡®å®šä½¿ç”¨å“ªä¸ªåŸºç±»çš„åŠ è½½æ–¹æ³•ï¼ˆå¦‚ `ModelMixin.from_pretrained`ï¼‰ã€‚\n\n#### **3. åŠ è½½æ–¹æ³•ç»‘å®š**\n\n- **åŠ¨æ€ç»‘å®š**ï¼š`_get_load_method` ä¼šå°† `class_obj.from_pretrained` æ–¹æ³•ç»‘å®šä¸ºå®é™…åŠ è½½å‡½æ•°ã€‚\n- **ç‰¹æ®Šå¤„ç†**ï¼šå¦‚æœæ˜¯ DDUF æ ¼å¼ï¼ˆHuggingFace çš„åˆ†å¸ƒå¼æ ¼å¼ï¼‰ï¼Œä¼šä½¿ç”¨ç‰¹å®šçš„åŠ è½½é€»è¾‘ã€‚\n\n#### **4. å®ä¾‹åŒ– UNet**\n\n- **å‚æ•°ä¼ é€’**ï¼š`loading_kwargs` åŒ…å«æ¨¡å‹è·¯å¾„ã€è®¾å¤‡æ˜ å°„ã€ç²¾åº¦è®¾ç½®ç­‰ã€‚\n- **æœ€ç»ˆè°ƒç”¨**ï¼š\n  ```python\n  # ç­‰æ•ˆäºæ‰§è¡Œï¼š\n  UNet2DConditionModel.from_pretrained(\n      pretrained_model_name_or_path=cached_folder,\n      subfolder=name,  # å¦‚ \"unet\"\n      torch_dtype=torch_dtype,\n      device_map=device_map,\n      ...\n  )\n  ```\n\n---\n\n### **UNet2DConditionModel çš„æ³¨å†Œæœºåˆ¶**\n\nåœ¨ `diffusers` çš„å…¨å±€æ³¨å†Œè¡¨ `ALL_IMPORTABLE_CLASSES` ä¸­ï¼Œ`UNet2DConditionModel` è¢«æ³¨å†Œä¸ºå¯å¯¼å…¥ç±»ï¼š\n\n```python\n# åœ¨æŸä¸ªåˆå§‹åŒ–æ¨¡å—ä¸­ï¼ˆå¦‚ src/diffusers/__init__.pyï¼‰\nALL_IMPORTABLE_CLASSES = {\n    \"UNet2DConditionModel\": (\"diffusers.models.unets.unet_2d_condition\", \"UNet2DConditionModel\"),\n    ...\n}\n```\n\nè¿™ä½¿å¾— `get_class_obj_and_candidates` èƒ½é€šè¿‡åç§°åŒ¹é…æ‰¾åˆ°è¯¥ç±»ã€‚\n\n---\n\n### **æ¶æ„å‚æ•°å¦‚ä½•ç”Ÿæ•ˆ**\n\nå½“è°ƒç”¨ `from_pretrained` æ—¶ï¼š\n\n1. **é…ç½®åŠ è½½**ï¼šä» `config.json` ä¸­è¯»å– `down_block_types`ã€`up_block_types` ç­‰å‚æ•°ã€‚\n2. **åŠ¨æ€æ„å»º**ï¼š`UNet2DConditionModel.__init__` æ ¹æ®è¿™äº›å‚æ•°ï¼Œé€šè¿‡ `get_down_block` å’Œ `get_up_block` åŠ¨æ€æ„å»ºç½‘ç»œå±‚ã€‚\n\nä¾‹å¦‚ï¼š\n\n```python\n# æ ¹æ® config.json ä¸­çš„ down_block_types åˆ›å»ºä¸‹é‡‡æ ·å—\ndown_block_type = \"CrossAttnDownBlock2D\"\ndown_block = get_down_block(\n    down_block_type,\n    num_layers=layers_per_block[i],\n    in_channels=input_channel,\n    out_channels=output_channel,\n    ...\n)\n```\n\n---\n\n### **æ€»ç»“æµç¨‹å›¾**\n\n```mermaid\ngraph TD\n    A[load_sub_model] --\u003e B[get_class_obj_and_candidates]\n    B --\u003e C{æ‰¾åˆ° UNet2DConditionModel ç±»}\n    C --\u003e D[ç¡®å®šåŠ è½½æ–¹æ³• from_pretrained]\n    D --\u003e E[è°ƒç”¨ UNet2DConditionModel.from_pretrained]\n    E --\u003e F[åŠ è½½ config.json]\n    F --\u003e G[æ ¹æ®é…ç½®åŠ¨æ€æ„å»ºç½‘ç»œå±‚]\n```\n\né€šè¿‡è¿™ç§åŠ¨æ€åŠ è½½æœºåˆ¶ï¼ŒDiffusers åº“å®ç°äº†é«˜åº¦æ¨¡å—åŒ–çš„æ¨¡å‹ç®¡ç†ï¼Œèƒ½å¤Ÿçµæ´»æ”¯æŒä¸åŒç»“æ„çš„ UNet å˜ä½“ã€‚\n\n\u003e [!info-å¤ªå²å…¬æ›°]\n\u003e åº”å½“ä¸æ˜¯ã€‚æ­£ç¡®æ¥è¯´ï¼Œæ˜¯ä¸Šå±‚ï¼ˆ `DiffusionPipeline.from_pretained` ï¼‰ä» importable_classes å‚æ•°ä¸­ä¼ å…¥ `ALL_IMPORTABLE_CLASSES` ï¼Œ `get_class_obj_and_candidates` ä¸­ä» `diffuser` ä¸­åŠ è½½åˆ° `ModelMixin` ï¼Œè°ƒç”¨ `ModelMixin.from_pretrained` æ‰å®ä¾‹åŒ– `UNet2DConditionModel` ç±»ã€‚\n\u003e\n\u003e å› æ­¤ä¼°è®¡å¾€ `load_sub_model` ä¸­ä¼ å…¥çš„æ˜¯ `diffuser` ä¸ `ModelMixin`\n\n# Q: è§£æä»£ç ï¼Œè¯¦è§£@modeling_utils.py çš„ from_pretrained å¦‚ä½•å®ä¾‹åŒ– @unet_2d_condition.py ä¸­çš„ `UNet2DConditionModel` ï¼Ÿ\n\n\u003cthink\u003e\næˆ‘éœ€è¦è¯¦ç»†è§£æ `modeling_utils.py` ä¸­çš„ `from_pretrained` æ–¹æ³•å¦‚ä½•å®ä¾‹åŒ– `UNet2DConditionModel`ã€‚æ ¹æ®æä¾›çš„ä»£ç ï¼Œæˆ‘å¯ä»¥çœ‹åˆ°æ•´ä¸ªåŠ è½½æµç¨‹ã€‚\n\né¦–å…ˆï¼Œ`from_pretrained` æ˜¯ `ModelMixin` ç±»çš„ä¸€ä¸ªç±»æ–¹æ³•ï¼Œè€Œ `UNet2DConditionModel` ç»§æ‰¿è‡ª `ModelMixin`ï¼Œæ‰€ä»¥å®ƒç»§æ‰¿äº†è¿™ä¸ªæ–¹æ³•ã€‚\n\nåŠ è½½æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\n\n1. é¦–å…ˆè·å–é…ç½®æ–‡ä»¶å’Œæ¨¡å‹æ–‡ä»¶è·¯å¾„\n2. åŠ è½½é…ç½®æ–‡ä»¶\n3. ä½¿ç”¨é…ç½®åˆ›å»ºæ¨¡å‹å®ä¾‹\n4. åŠ è½½æƒé‡åˆ°æ¨¡å‹ä¸­\n5. å¤„ç†è®¾å¤‡æ˜ å°„ç­‰é«˜çº§åŠŸèƒ½\n6. è¿”å›åŠ è½½å¥½çš„æ¨¡å‹\n\nå…·ä½“æ¥çœ‹ï¼Œ`from_pretrained` æ–¹æ³•é¦–å…ˆä¼šç¡®å®šæ¨¡å‹æ–‡ä»¶çš„ä½ç½®ï¼Œç„¶ååŠ è½½é…ç½®æ–‡ä»¶ã€‚æ¥ç€ï¼Œå®ƒä¼šä½¿ç”¨ `cls.from_config(config, **unused_kwargs)` åˆ›å»ºä¸€ä¸ªæ¨¡å‹å®ä¾‹ã€‚è¿™é‡Œçš„ `cls` å°±æ˜¯ `UNet2DConditionModel`ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯è°ƒç”¨ `UNet2DConditionModel.from_config` æ¥åˆ›å»ºæ¨¡å‹å®ä¾‹ã€‚\n\nç„¶åï¼Œå®ƒä¼šåŠ è½½æƒé‡æ–‡ä»¶ï¼Œå¹¶å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹é€šè¿‡ `_load_pretrained_model` æ–¹æ³•å®Œæˆã€‚æœ€åï¼Œå®ƒä¼šå¤„ç†è®¾å¤‡æ˜ å°„ç­‰é«˜çº§åŠŸèƒ½ï¼Œå¹¶è¿”å›åŠ è½½å¥½çš„æ¨¡å‹ã€‚\n\næˆ‘éœ€è¦è¯¦ç»†è§£é‡Šè¿™ä¸ªè¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•ä»é…ç½®åˆ›å»ºæ¨¡å‹å®ä¾‹ï¼Œä»¥åŠå¦‚ä½•åŠ è½½æƒé‡åˆ°æ¨¡å‹ä¸­ã€‚\n\u003c/think\u003e\n\n# `from_pretrained` å¦‚ä½•å®ä¾‹åŒ– UNet2DConditionModel çš„è¯¦ç»†æµç¨‹\n\n`modeling_utils.py` ä¸­çš„ `from_pretrained` æ–¹æ³•è´Ÿè´£å®ä¾‹åŒ– `UNet2DConditionModel`ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯åˆ†ä¸ºä»¥ä¸‹å…³é”®æ­¥éª¤ï¼š\n\n## 1. åŠ è½½é…ç½®æ–‡ä»¶\n\n```python\n# ç¡®å®šæ¨¡å‹è·¯å¾„å¹¶åŠ è½½é…ç½®\nconfig_dict = cls.load_config(\n    pretrained_model_name_or_path,\n    cache_dir=cache_dir,\n    force_download=force_download,\n    # å…¶ä»–å‚æ•°...\n)\n```\n\nè¿™ä¸€æ­¥ä»æ¨¡å‹ç›®å½•æˆ– Hub åŠ è½½ `config.json`ï¼ŒåŒ…å«äº† UNet çš„æ‰€æœ‰é…ç½®å‚æ•°ï¼ˆå¦‚é€šé“æ•°ã€æ³¨æ„åŠ›å¤´æ•°ç­‰ï¼‰ã€‚\n\n## 2. åˆ›å»ºç©ºæ¨¡å‹å®ä¾‹\n\n```python\n# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨åˆ›å»ºç©ºæ¨¡å‹\nwith ContextManagers(init_contexts):\n    model = cls.from_config(config, **unused_kwargs)\n```\n\nè¿™é‡Œçš„å…³é”®æ˜¯ `cls.from_config`ï¼Œå®ƒè°ƒç”¨ `UNet2DConditionModel.from_config` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”± `ConfigMixin` æä¾›ã€‚\n\n`from_config` ä¼šï¼š\n\n- è§£æé…ç½®å‚æ•°\n- è°ƒç”¨ `UNet2DConditionModel.__init__` æ„é€ å‡½æ•°\n- åˆ›å»ºæ‰€æœ‰å­æ¨¡å—ï¼ˆå¦‚ä¸‹é‡‡æ ·å—ã€ä¸Šé‡‡æ ·å—ã€æ³¨æ„åŠ›å±‚ç­‰ï¼‰\n\n## 3. åŠ è½½æƒé‡æ–‡ä»¶\n\n```python\n# åŠ è½½æƒé‡æ–‡ä»¶\nstate_dict = load_state_dict(resolved_model_file[0], disable_mmap=disable_mmap, dduf_entries=dduf_entries)\n```\n\nè¿™ä¸€æ­¥åŠ è½½é¢„è®­ç»ƒæƒé‡æ–‡ä»¶ï¼ˆå¦‚ `diffusion_pytorch_model.bin` æˆ– `.safetensors`ï¼‰ã€‚\n\n## 4. å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­\n\n```python\nmodel, missing_keys, unexpected_keys, mismatched_keys, offload_index, error_msgs = cls._load_pretrained_model(\n    model,\n    state_dict,\n    # å…¶ä»–å‚æ•°...\n)\n```\n\n`_load_pretrained_model` æ–¹æ³•è´Ÿè´£ï¼š\n\n- å°†æƒé‡æ˜ å°„åˆ°æ¨¡å‹å‚æ•°\n- å¤„ç†å¯èƒ½çš„å½¢çŠ¶ä¸åŒ¹é…\n- æ”¯æŒä½å†…å­˜åŠ è½½\n- å¤„ç†é‡åŒ–å’Œè®¾å¤‡æ˜ å°„\n\n## 5. è®¾å¤‡åˆ†é…å’Œåå¤„ç†\n\n```python\n# å¦‚æœæŒ‡å®šäº†è®¾å¤‡æ˜ å°„ï¼Œå°†æ¨¡å‹åˆ†é…åˆ°ä¸åŒè®¾å¤‡\nif device_map is not None:\n    dispatch_model(model, **device_map_kwargs)\n```\n\nè¿™ä¸€æ­¥å¤„ç†æ¨¡å‹åœ¨å¤š GPU æˆ– CPU/GPU æ··åˆç¯å¢ƒä¸‹çš„åˆ†é…ã€‚\n\n## 6. è¿”å›å®ä¾‹åŒ–çš„æ¨¡å‹\n\n```python\nmodel.eval()  # è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼\nreturn model\n```\n\næœ€ç»ˆè¿”å›å®Œå…¨åŠ è½½å¥½çš„ `UNet2DConditionModel` å®ä¾‹ã€‚\n\n## å…³é”®å®ç°ç»†èŠ‚\n\n1. **åŠ¨æ€ç±»å‹å¤„ç†**ï¼š\n\n   ```python\n   if torch_dtype is not None:\n       dtype_orig = cls._set_default_torch_dtype(torch_dtype)\n   ```\n\n   æ”¯æŒä¸åŒç²¾åº¦ï¼ˆå¦‚ fp16ã€bf16ï¼‰çš„æ¨¡å‹åŠ è½½\n\n2. **ä½å†…å­˜åŠ è½½**ï¼š\n\n   ```python\n   if low_cpu_mem_usage:\n       init_contexts.append(accelerate.init_empty_weights())\n   ```\n\n   é€šè¿‡ accelerate åº“å®ç°å¤§æ¨¡å‹çš„é«˜æ•ˆåŠ è½½\n\n3. **æƒé‡ä¿®å¤**ï¼š\n\n   ```python\n   model._fix_state_dict_keys_on_load(state_dict)\n   ```\n\n   å¤„ç†ä¸åŒç‰ˆæœ¬æ¨¡å‹é—´çš„é”®åå·®å¼‚\n\n4. **è®¾å¤‡æ˜ å°„**ï¼š\n   ```python\n   device_map = _determine_device_map(model, device_map, max_memory, ...)\n   ```\n   æ™ºèƒ½åˆ†é…æ¨¡å‹å±‚åˆ°ä¸åŒè®¾å¤‡\n\næ•´ä¸ªè¿‡ç¨‹å®ç°äº†ä»é¢„è®­ç»ƒæƒé‡åˆ°å¯ç”¨æ¨¡å‹å®ä¾‹çš„æ— ç¼è½¬æ¢ï¼ŒåŒæ—¶å¤„ç†äº†å„ç§é«˜çº§åŠŸèƒ½å¦‚è®¾å¤‡ç®¡ç†ã€ç²¾åº¦æ§åˆ¶å’Œå†…å­˜ä¼˜åŒ–ã€‚\n\n# Q: è¯¦ç»†è§£é‡Š @unet_2d_condition.py ä¸­ UNet2DConditionModel çš„ç»“æ„\n\n\u003cthink\u003e\n\nå—¯ï¼Œç”¨æˆ·æƒ³è®©æˆ‘è¯¦ç»†è§£é‡Š `unet_2d_condition.py` ä¸­çš„ `UNet2DConditionModel` ç»“æ„ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦å›å¿†ä¸€ä¸‹ UNet çš„åŸºæœ¬ç»“æ„ï¼Œç‰¹åˆ«æ˜¯ Stable Diffusion ä¸­çš„ UNetã€‚Stable Diffusion çš„ UNet æ˜¯ä¸€ä¸ªæ¡ä»¶æ¨¡å‹ï¼Œç»“åˆäº†æ–‡æœ¬åµŒå…¥ä½œä¸ºè¾“å…¥ï¼Œæ‰€ä»¥è¿™ä¸ª UNet2DConditionModel åº”è¯¥æ˜¯åœ¨ä¼ ç»Ÿ UNet çš„åŸºç¡€ä¸Šå¢åŠ äº†å¯¹æ¡ä»¶è¾“å…¥çš„å¤„ç†ï¼Œæ¯”å¦‚æ–‡æœ¬åµŒå…¥æˆ–æ—¶é—´æ­¥ä¿¡æ¯ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦è€ƒè™‘ç”¨æˆ·å¯èƒ½çš„èƒŒæ™¯ã€‚ç”¨æˆ·å¯èƒ½åœ¨ä½¿ç”¨æˆ–ä¿®æ”¹ Diffusers åº“ï¼Œæˆ–è€…åœ¨å°è¯•ç†è§£ Stable Diffusion çš„å·¥ä½œåŸç†ã€‚ä»–ä»¬å¯èƒ½é‡åˆ°äº†é—®é¢˜ï¼Œæ¯”å¦‚æ¨¡å‹åŠ è½½é”™è¯¯ï¼Œæˆ–è€…æƒ³è‡ªå®šä¹‰ UNet çš„ç»“æ„ï¼Œå› æ­¤éœ€è¦äº†è§£å…¶å†…éƒ¨ç»„ä»¶ã€‚ç”¨æˆ·å¯èƒ½å·²ç»çœ‹è¿‡ä»£ç ï¼Œä½†éœ€è¦æ›´æ¸…æ™°çš„è§£é‡Šï¼Œç‰¹åˆ«æ˜¯å„ä¸ªæ¨¡å—çš„ä½œç”¨å’Œè¿æ¥æ–¹å¼ã€‚\n\næˆ‘éœ€è¦æ£€æŸ¥ç”¨æˆ·æä¾›çš„ä»£ç ç‰‡æ®µï¼Œç‰¹åˆ«æ˜¯`UNet2DConditionModel`çš„`__init__`æ–¹æ³•ï¼Œçœ‹çœ‹æœ‰å“ªäº›ç»„ä»¶è¢«åˆå§‹åŒ–ã€‚æ¯”å¦‚ï¼Œ`conv_in`ã€`time_embedding`ã€`down_blocks`ã€`mid_block`ã€`up_blocks`ã€`conv_out`ç­‰ã€‚è¿™äº›éƒ¨åˆ†å¯¹åº”äº† UNet çš„ä¸åŒé˜¶æ®µï¼Œä¸‹é‡‡æ ·ã€ä¸­é—´å±‚ã€ä¸Šé‡‡æ ·ç­‰ã€‚\n\nç„¶åï¼Œæˆ‘éœ€è¦è€ƒè™‘å¦‚ä½•å°†è¿™äº›ç»„ä»¶ç»„ç»‡æˆä¸€ä¸ªè¿è´¯çš„ç»“æ„è§£é‡Šã€‚å¯èƒ½éœ€è¦åˆ†å—è®²è§£ï¼Œæ¯”å¦‚è¾“å…¥å¤„ç†ã€æ—¶é—´åµŒå…¥ã€ä¸‹é‡‡æ ·å—ã€ä¸­é—´å—ã€ä¸Šé‡‡æ ·å—ã€è¾“å‡ºå¤„ç†ç­‰ã€‚åŒæ—¶ï¼Œæ¡ä»¶è¾“å…¥ï¼ˆå¦‚æ–‡æœ¬åµŒå…¥ï¼‰æ˜¯å¦‚ä½•è¢«æ•´åˆåˆ°æ¨¡å‹ä¸­çš„ï¼Œæ¯”å¦‚é€šè¿‡äº¤å‰æ³¨æ„åŠ›æœºåˆ¶ã€‚\n\nå¦å¤–ï¼Œç”¨æˆ·å¯èƒ½å¯¹æŸäº›å‚æ•°æˆ–é…ç½®é€‰é¡¹æ„Ÿå…´è¶£ï¼Œæ¯”å¦‚`attention_head_dim`ã€`cross_attention_dim`ç­‰ï¼Œè¿™äº›å‚æ•°å¦‚ä½•å½±å“æ¨¡å‹ç»“æ„ã€‚éœ€è¦è§£é‡Šè¿™äº›å‚æ•°çš„ä½œç”¨ï¼Œä»¥åŠå®ƒä»¬åœ¨æ¨¡å‹ä¸­çš„å…·ä½“åº”ç”¨ä½ç½®ã€‚\n\nè¿˜è¦æ³¨æ„ä»£ç ä¸­çš„ä¸€äº›ç‰¹å®šå¤„ç†ï¼Œæ¯”å¦‚`class_embeddings_concat`å¦‚ä½•å¤„ç†ç±»åˆ«åµŒå…¥ï¼Œ`resnet_time_scale_shift`çš„ä¸åŒæ¨¡å¼å¯¹æ®‹å·®å—çš„å½±å“ï¼Œä»¥åŠ`attention_type`çš„é€‰æ‹©ï¼ˆå¦‚é»˜è®¤çš„äº¤å‰æ³¨æ„åŠ›æˆ–å…¶ä»–ç±»å‹ï¼‰ã€‚\n\næœ€åï¼Œå¯èƒ½éœ€è¦æä¾›ä¸€ä¸ªç»“æ„å›¾æˆ–æµç¨‹å›¾ï¼Œå¸®åŠ©ç”¨æˆ·æ›´ç›´è§‚åœ°ç†è§£æ•°æ®åœ¨æ¨¡å‹ä¸­çš„æµåŠ¨è·¯å¾„ï¼Œç‰¹åˆ«æ˜¯æ¡ä»¶ä¿¡æ¯å¦‚ä½•åœ¨ä¸åŒå±‚ä¸­è¢«æ•´åˆã€‚å¦‚æœç”¨æˆ·éœ€è¦è¿›ä¸€æ­¥çš„ä»£ç ç¤ºä¾‹æˆ–è°ƒè¯•å¸®åŠ©ï¼Œä¹Ÿéœ€è¦åœ¨è§£é‡Šä¸­æåŠå¯èƒ½çš„å¸¸è§é—®é¢˜æˆ–é…ç½®é”™è¯¯ã€‚\n\u003c/think\u003e\n\nä»¥ä¸‹æ˜¯ `UNet2DConditionModel` çš„è¯¦ç»†ç»“æ„è§£æï¼Œè¯¥æ¨¡å‹æ˜¯ Stable Diffusion çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å™ªå£°é¢„æµ‹å’Œæ¡ä»¶æ§åˆ¶ï¼š\n\n---\n\n### **æ•´ä½“æ¶æ„**\n\n```mermaid\ngraph TD\n    A[è¾“å…¥] --\u003e B[Conv2D_3x3]\n    B --\u003e C[æ—¶é—´åµŒå…¥]\n    C --\u003e D[ä¸‹é‡‡æ ·å— x4]\n    D --\u003e E[ä¸­é—´å—]\n    E --\u003e F[ä¸Šé‡‡æ ·å— x4]\n    F --\u003e G[Conv2D_3x3]\n    G --\u003e H[è¾“å‡º]\n    D --\u003e|è·³è·ƒè¿æ¥| F\n    C --\u003e|æ¡ä»¶æ³¨å…¥| D\n    C --\u003e|æ¡ä»¶æ³¨å…¥| E\n    C --\u003e|æ¡ä»¶æ³¨å…¥| F\n```\n\n---\n\n### **æ ¸å¿ƒç»„ä»¶**\n\n#### 1. è¾“å…¥å¤„ç†\n\n```python\nself.conv_in = nn.Conv2d(\n    in_channels,\n    block_out_channels[0],\n    kernel_size=3,\n    padding=1\n)\n```\n\n- ä½œç”¨ï¼šå°†è¾“å…¥å›¾åƒï¼ˆlatent spaceï¼‰æ˜ å°„åˆ°åˆå§‹ç‰¹å¾ç©ºé—´\n- å‚æ•°ï¼š\n  - `in_channels`ï¼šè¾“å…¥é€šé“æ•°ï¼ˆé€šå¸¸ä¸º 4ï¼‰\n  - `block_out_channels[0]`ï¼šé¦–å±‚è¾“å‡ºé€šé“æ•°ï¼ˆé€šå¸¸ä¸º 320ï¼‰\n\n---\n\n#### 2. æ—¶é—´åµŒå…¥ç³»ç»Ÿ\n\n```python\nself.time_embedding = TimestepEmbedding(\n    timestep_input_dim,  # æ—¶é—´æ­¥ç¼–ç ç»´åº¦\n    time_embed_dim,       # åµŒå…¥ç»´åº¦ï¼ˆé€šå¸¸1280ï¼‰\n    act_fn=act_fn         # æ¿€æ´»å‡½æ•°ï¼ˆå¦‚siluï¼‰\n)\n```\n\n- åŠŸèƒ½ï¼šå°†æ—¶é—´æ­¥ä¿¡æ¯ç¼–ç ä¸ºæ¡ä»¶å‘é‡\n- æµç¨‹ï¼š\n  1. é€šè¿‡æ­£å¼¦ä½ç½®ç¼–ç ç”Ÿæˆæ—¶é—´ç‰¹å¾\n  2. ç»è¿‡å…¨è¿æ¥å±‚å’Œéçº¿æ€§æ¿€æ´»\n  3. ä¸æ–‡æœ¬åµŒå…¥ç­‰æ¡ä»¶ä¿¡æ¯èåˆ\n\n---\n\n#### 3. ä¸‹é‡‡æ ·æ¨¡å—\n\n```python\nself.down_blocks = nn.ModuleList([\n    DownBlock2D(\n        in_channels=320,\n        out_channels=320,\n        temb_channels=1280,\n        num_layers=2,\n        resnet_eps=1e-5,\n        resnet_act_fn=\"silu\",\n        cross_attention_dim=768  # æ–‡æœ¬åµŒå…¥ç»´åº¦\n    ),\n    # å…¶ä»–ä¸‹é‡‡æ ·å—...\n])\n```\n\n- ç»“æ„ç‰¹ç‚¹ï¼š\n  - æ¯ä¸ªä¸‹é‡‡æ ·å—åŒ…å«ï¼š\n    - å¤šä¸ªæ®‹å·®å—ï¼ˆResNetï¼‰\n    - äº¤å‰æ³¨æ„åŠ›å±‚ï¼ˆå¤„ç†æ–‡æœ¬æ¡ä»¶ï¼‰\n    - å¯èƒ½çš„é™é‡‡æ ·å·ç§¯\n  - å…¸å‹é…ç½®ï¼š4 ä¸ªä¸‹é‡‡æ ·å—ï¼Œé€šé“æ•°é€çº§å¢åŠ ï¼ˆ320â†’640â†’1280â†’1280ï¼‰\n\n---\n\n#### 4. ä¸­é—´æ¨¡å—\n\n```python\nself.mid_block = UNetMidBlock2DCrossAttn(\n    in_channels=1280,\n    temb_channels=1280,\n    resnet_eps=1e-5,\n    resnet_act_fn=\"silu\",\n    attn_num_head_channels=8\n)\n```\n\n- æ ¸å¿ƒç»„æˆï¼š\n  - æ®‹å·®å—\n  - è‡ªæ³¨æ„åŠ›æœºåˆ¶\n  - äº¤å‰æ³¨æ„åŠ›æœºåˆ¶\n- ä½œç”¨ï¼šåœ¨æœ€ä½åˆ†è¾¨ç‡å±‚è¿›è¡Œå…¨å±€ç‰¹å¾æ•´åˆ\n\n---\n\n#### 5. ä¸Šé‡‡æ ·æ¨¡å—\n\n```python\nself.up_blocks = nn.ModuleList([\n    UpBlock2D(\n        in_channels=1280,\n        prev_output_channel=1280,\n        out_channels=1280,\n        temb_channels=1280,\n        num_layers=3,\n        resnet_eps=1e-5,\n        resnet_act_fn=\"silu\"\n    ),\n    # å…¶ä»–ä¸Šé‡‡æ ·å—...\n])\n```\n\n- å…³é”®ç‰¹æ€§ï¼š\n  - åŒ…å«æ®‹å·®å—å’Œäº¤å‰æ³¨æ„åŠ›å±‚\n  - é€šè¿‡è·³è·ƒè¿æ¥èåˆä¸‹é‡‡æ ·ç‰¹å¾\n  - ä½¿ç”¨è½¬ç½®å·ç§¯æˆ–æ’å€¼è¿›è¡Œä¸Šé‡‡æ ·\n\n---\n\n#### 6. è¾“å‡ºå¤„ç†\n\n```python\nself.conv_norm_out = nn.GroupNorm(32, 320)\nself.conv_act = nn.SiLU()\nself.conv_out = nn.Conv2d(320, 4, 3, padding=1)\n```\n\n- æµç¨‹ï¼š\n  1. å½’ä¸€åŒ–å¤„ç†\n  2. æ¿€æ´»å‡½æ•°\n  3. æœ€ç»ˆå·ç§¯å°†ç‰¹å¾æ˜ å°„åˆ°è¾“å‡ºç©ºé—´ï¼ˆ4 é€šé“ï¼‰\n\n---\n\n### **æ¡ä»¶æ§åˆ¶æœºåˆ¶**\n\n#### äº¤å‰æ³¨æ„åŠ›å±‚\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n        # è®¡ç®—æ³¨æ„åŠ›æƒé‡...\n        return output\n```\n\n- ä½œç”¨ï¼šå°†æ–‡æœ¬åµŒå…¥ï¼ˆcontextï¼‰æ³¨å…¥åˆ°å›¾åƒç‰¹å¾ä¸­\n- ä½ç½®ï¼šæ¯ä¸ªä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·å—ä¸­éƒ½åŒ…å«è¯¥å±‚\n\n---\n\n### **å…³é”®å‚æ•°è¯´æ˜**\n\n| å‚æ•°                      | å…¸å‹å€¼    | ä½œç”¨                                      |\n| ------------------------- | --------- | ----------------------------------------- |\n| `cross_attention_dim`     | 768       | æ–‡æœ¬åµŒå…¥çš„ç»´åº¦ï¼ˆCLIP æ–‡æœ¬ç¼–ç å™¨è¾“å‡ºç»´åº¦ï¼‰ |\n| `attention_head_dim`      | 8/16      | æ³¨æ„åŠ›å¤´çš„ç»´åº¦                            |\n| `layers_per_block`        | 2         | æ¯ä¸ªå—ä¸­çš„æ®‹å·®å±‚æ•°                        |\n| `num_attention_heads`     | 8         | æ³¨æ„åŠ›å¤´æ•°é‡                              |\n| `resnet_time_scale_shift` | \"default\" | æ—¶é—´æ¡ä»¶æ³¨å…¥æ–¹å¼ï¼ˆadd/scaleï¼‰             |\n\n---\n\n### **æ•°æ®æµåŠ¨ç¤ºä¾‹**\n\n```python\ndef forward(self, x, timestep, encoder_hidden_states):\n    # 1. è¾“å…¥å¤„ç†\n    x = self.conv_in(x)\n\n    # 2. æ—¶é—´åµŒå…¥\n    t_emb = self.time_embedding(timestep)\n\n    # 3. ä¸‹é‡‡æ ·\n    down_samples = []\n    for down_block in self.down_blocks:\n        x = down_block(x, t_emb, encoder_hidden_states)\n        down_samples.append(x)\n\n    # 4. ä¸­é—´å¤„ç†\n    x = self.mid_block(x, t_emb, encoder_hidden_states)\n\n    # 5. ä¸Šé‡‡æ ·\n    for up_block in self.up_blocks:\n        x = up_block(x, down_samples.pop(), t_emb, encoder_hidden_states)\n\n    # 6. è¾“å‡º\n    x = self.conv_norm_out(x)\n    x = self.conv_act(x)\n    return self.conv_out(x)\n```\n\nå¦‚æœéœ€è¦æ›´è¯¦ç»†çš„æŸä¸ªç»„ä»¶è§£æï¼ˆå¦‚ä¸‹é‡‡æ ·å—çš„å…·ä½“å®ç°ï¼‰ï¼Œå¯ä»¥è¿›ä¸€æ­¥å±•å¼€è¯´æ˜ã€‚\n\n# Q: è¯¦ç»†è§£é‡Šä¸‹é‡‡æ ·å¿«çš„ç»†èŠ‚\n\nå¥½çš„ï¼Œä¸‹é¢æ˜¯ `UNet2DConditionModel` ä¸­ä¸‹é‡‡æ ·å—çš„è¯¦ç»†ç»“æ„å’Œå®ç°ç»†èŠ‚ï¼š\n\n---\n\n### **ä¸‹é‡‡æ ·å—æ¦‚è¿°**\n\nä¸‹é‡‡æ ·å—çš„ä¸»è¦åŠŸèƒ½æ˜¯é€æ­¥é™ä½ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ï¼ŒåŒæ—¶å¢åŠ é€šé“æ•°ï¼Œä»¥ä¾¿åœ¨æ›´ä½çš„åˆ†è¾¨ç‡ä¸Šè¿›è¡Œæ›´å¤æ‚çš„ç‰¹å¾æå–ã€‚æ¯ä¸ªä¸‹é‡‡æ ·å—é€šå¸¸åŒ…å«å¤šä¸ªæ®‹å·®å—å’Œä¸€ä¸ªé™é‡‡æ ·æ“ä½œã€‚\n\n---\n\n### **ä¸‹é‡‡æ ·å—çš„ç»“æ„**\n\n#### 1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰\n\næ¯ä¸ªä¸‹é‡‡æ ·å—åŒ…å«å¤šä¸ªæ®‹å·®å—ï¼Œè´Ÿè´£ç‰¹å¾æå–å’Œéçº¿æ€§å˜æ¢ã€‚\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # æ—¶é—´åµŒå…¥æ³¨å…¥\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # æ®‹å·®è¿æ¥\n```\n\n- **ç‰¹å¾å½’ä¸€åŒ–**ï¼šä½¿ç”¨ `GroupNorm` è¿›è¡Œå½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚\n- **æ¿€æ´»å‡½æ•°**ï¼šé€šå¸¸ä½¿ç”¨ `SiLU` æˆ– `ReLU`ã€‚\n- **å·ç§¯å±‚**ï¼šä¸¤ä¸ª 3x3 å·ç§¯å±‚ï¼Œä¿æŒç‰¹å¾å›¾å¤§å°ä¸å˜ã€‚\n- **æ—¶é—´åµŒå…¥**ï¼šé€šè¿‡å…¨è¿æ¥å±‚å°†æ—¶é—´åµŒå…¥æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n#### 2. äº¤å‰æ³¨æ„åŠ›å±‚\n\nåœ¨å¤„ç†æ¡ä»¶è¾“å…¥ï¼ˆå¦‚æ–‡æœ¬åµŒå…¥ï¼‰æ—¶ï¼Œäº¤å‰æ³¨æ„åŠ›å±‚ç”¨äºå°†æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **æŸ¥è¯¢ã€é”®ã€å€¼**ï¼šé€šè¿‡çº¿æ€§å˜æ¢ç”ŸæˆæŸ¥è¯¢ã€é”®å’Œå€¼å‘é‡ã€‚\n- **æ³¨æ„åŠ›è®¡ç®—**ï¼šä½¿ç”¨ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ã€‚\n- **æ¡ä»¶æ³¨å…¥**ï¼šå°†æ–‡æœ¬åµŒå…¥ç­‰æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n#### 3. é™é‡‡æ ·æ“ä½œ\n\né€šå¸¸ä½¿ç”¨å·ç§¯æˆ–æ± åŒ–æ“ä½œæ¥é™ä½ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ã€‚\n\n```python\nclass Downsample(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv = nn.Conv2d(in_channels, out_channels, kernel_size=3, stride=2, padding=1)\n\n    def forward(self, x):\n        return self.conv(x)\n```\n\n- **å·ç§¯é™é‡‡æ ·**ï¼šé€šè¿‡æ­¥é•¿ä¸º 2 çš„å·ç§¯å®ç°é™é‡‡æ ·ï¼Œå‡å°‘ç‰¹å¾å›¾çš„å®½é«˜ã€‚\n- **é€šé“æ•°å¢åŠ **ï¼šé€šå¸¸åœ¨é™é‡‡æ ·æ—¶å¢åŠ é€šé“æ•°ï¼Œä»¥ä¾¿åœ¨æ›´ä½çš„åˆ†è¾¨ç‡ä¸Šè¿›è¡Œæ›´å¤æ‚çš„ç‰¹å¾æå–ã€‚\n\n---\n\n### **ä¸‹é‡‡æ ·å—çš„å®Œæ•´å®ç°**\n\n```python\nclass DownBlock2D(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, num_layers, resnet_eps, resnet_act_fn, cross_attention_dim):\n        super().__init__()\n        self.resnets = nn.ModuleList([\n            ResNetBlock(in_channels if i == 0 else out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\n            for i in range(num_layers)\n        ])\n        self.attention = CrossAttention(out_channels, cross_attention_dim)\n        self.downsample = Downsample(out_channels, out_channels)\n\n    def forward(self, x, temb, context):\n        for resnet in self.resnets:\n            x = resnet(x, temb)\n        x = self.attention(x, context)\n        x = self.downsample(x)\n        return x\n```\n\n- **æ®‹å·®å—**ï¼šå¤šä¸ªæ®‹å·®å—ä¸²è”ï¼Œè¿›è¡Œç‰¹å¾æå–ã€‚\n- **äº¤å‰æ³¨æ„åŠ›**ï¼šåœ¨ç‰¹å¾æå–åæ³¨å…¥æ¡ä»¶ä¿¡æ¯ã€‚\n- **é™é‡‡æ ·**ï¼šé™ä½ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ã€‚\n\n---\n\n### **æ€»ç»“**\n\nä¸‹é‡‡æ ·å—åœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„ç‰¹å¾æå–å’Œæ¡ä»¶æ³¨å…¥ï¼Œé€æ­¥å°†è¾“å…¥å›¾åƒçš„ç‰¹å¾å‹ç¼©åˆ°æ›´ä½çš„åˆ†è¾¨ç‡ï¼Œä¸ºåç»­çš„ä¸­é—´å—å’Œä¸Šé‡‡æ ·å—æä¾›ä¸°å¯Œçš„ç‰¹å¾ä¿¡æ¯ã€‚\n\n# Q: è¯¦ç»†è®²è§£ä¸Šé‡‡æ ·å—çš„ç»†èŠ‚\n\nå¥½çš„ï¼Œä¸‹é¢æ˜¯ `UNet2DConditionModel` ä¸­ä¸Šé‡‡æ ·å—çš„è¯¦ç»†ç»“æ„å’Œå®ç°ç»†èŠ‚ï¼š\n\n---\n\n### **ä¸Šé‡‡æ ·å—æ¦‚è¿°**\n\nä¸Šé‡‡æ ·å—çš„ä¸»è¦åŠŸèƒ½æ˜¯é€æ­¥æ¢å¤ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ï¼ŒåŒæ—¶ç»“åˆä¸‹é‡‡æ ·å—çš„ç‰¹å¾ï¼Œé€šè¿‡è·³è·ƒè¿æ¥ï¼ˆskip connectionsï¼‰å®ç°ç‰¹å¾çš„èåˆã€‚æ¯ä¸ªä¸Šé‡‡æ ·å—é€šå¸¸åŒ…å«å¤šä¸ªæ®‹å·®å—å’Œä¸€ä¸ªä¸Šé‡‡æ ·æ“ä½œã€‚\n\n---\n\n### **ä¸Šé‡‡æ ·å—çš„ç»“æ„**\n\n#### 1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰\n\næ¯ä¸ªä¸Šé‡‡æ ·å—åŒ…å«å¤šä¸ªæ®‹å·®å—ï¼Œè´Ÿè´£ç‰¹å¾æå–å’Œéçº¿æ€§å˜æ¢ã€‚\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # æ—¶é—´åµŒå…¥æ³¨å…¥\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # æ®‹å·®è¿æ¥\n```\n\n- **ç‰¹å¾å½’ä¸€åŒ–**ï¼šä½¿ç”¨ `GroupNorm` è¿›è¡Œå½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚\n- **æ¿€æ´»å‡½æ•°**ï¼šé€šå¸¸ä½¿ç”¨ `SiLU` æˆ– `ReLU`ã€‚\n- **å·ç§¯å±‚**ï¼šä¸¤ä¸ª 3x3 å·ç§¯å±‚ï¼Œä¿æŒç‰¹å¾å›¾å¤§å°ä¸å˜ã€‚\n- **æ—¶é—´åµŒå…¥**ï¼šé€šè¿‡å…¨è¿æ¥å±‚å°†æ—¶é—´åµŒå…¥æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n#### 2. äº¤å‰æ³¨æ„åŠ›å±‚\n\nåœ¨å¤„ç†æ¡ä»¶è¾“å…¥ï¼ˆå¦‚æ–‡æœ¬åµŒå…¥ï¼‰æ—¶ï¼Œäº¤å‰æ³¨æ„åŠ›å±‚ç”¨äºå°†æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **æŸ¥è¯¢ã€é”®ã€å€¼**ï¼šé€šè¿‡çº¿æ€§å˜æ¢ç”ŸæˆæŸ¥è¯¢ã€é”®å’Œå€¼å‘é‡ã€‚\n- **æ³¨æ„åŠ›è®¡ç®—**ï¼šä½¿ç”¨ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ã€‚\n- **æ¡ä»¶æ³¨å…¥**ï¼šå°†æ–‡æœ¬åµŒå…¥ç­‰æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n#### 3. ä¸Šé‡‡æ ·æ“ä½œ\n\né€šå¸¸ä½¿ç”¨è½¬ç½®å·ç§¯æˆ–æ’å€¼æ“ä½œæ¥å¢åŠ ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ã€‚\n\n```python\nclass Upsample(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv = nn.ConvTranspose2d(in_channels, out_channels, kernel_size=3, stride=2, padding=1, output_padding=1)\n\n    def forward(self, x):\n        return self.conv(x)\n```\n\n- **è½¬ç½®å·ç§¯ä¸Šé‡‡æ ·**ï¼šé€šè¿‡è½¬ç½®å·ç§¯å®ç°ä¸Šé‡‡æ ·ï¼Œå¢åŠ ç‰¹å¾å›¾çš„å®½é«˜ã€‚\n- **é€šé“æ•°å‡å°‘**ï¼šé€šå¸¸åœ¨ä¸Šé‡‡æ ·æ—¶å‡å°‘é€šé“æ•°ï¼Œä»¥ä¾¿æ¢å¤åˆ°è¾“å…¥å›¾åƒçš„é€šé“æ•°ã€‚\n\n---\n\n### **ä¸Šé‡‡æ ·å—çš„å®Œæ•´å®ç°**\n\n```python\nclass UpBlock2D(nn.Module):\n    def __init__(self, in_channels, prev_output_channel, out_channels, temb_channels, num_layers, resnet_eps, resnet_act_fn, cross_attention_dim):\n        super().__init__()\n        self.resnets = nn.ModuleList([\n            ResNetBlock(in_channels if i == 0 else out_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn)\n            for i in range(num_layers)\n        ])\n        self.attention = CrossAttention(out_channels, cross_attention_dim)\n        self.upsample = Upsample(out_channels, out_channels)\n\n    def forward(self, x, res_samples, temb, context):\n        for resnet in self.resnets:\n            x = resnet(x, temb)\n        x = self.attention(x, context)\n        x = self.upsample(x)\n        return x\n```\n\n- **æ®‹å·®å—**ï¼šå¤šä¸ªæ®‹å·®å—ä¸²è”ï¼Œè¿›è¡Œç‰¹å¾æå–ã€‚\n- **äº¤å‰æ³¨æ„åŠ›**ï¼šåœ¨ç‰¹å¾æå–åæ³¨å…¥æ¡ä»¶ä¿¡æ¯ã€‚\n- **ä¸Šé‡‡æ ·**ï¼šå¢åŠ ç‰¹å¾å›¾çš„ç©ºé—´åˆ†è¾¨ç‡ã€‚\n\n---\n\n### **æ€»ç»“**\n\nä¸Šé‡‡æ ·å—åœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„ç‰¹å¾æå–å’Œæ¡ä»¶æ³¨å…¥ï¼Œé€æ­¥å°†ç‰¹å¾å›¾çš„åˆ†è¾¨ç‡æ¢å¤åˆ°è¾“å…¥å›¾åƒçš„å¤§å°ï¼Œå¹¶ç»“åˆä¸‹é‡‡æ ·å—çš„ç‰¹å¾å®ç°ç‰¹å¾çš„èåˆã€‚\n\n# Q: è¯¦ç»†è®²è§£ä¸­é—´æ¨¡å—ç»†èŠ‚\n\nå¥½çš„ï¼Œä¸‹é¢æ˜¯ `UNet2DConditionModel` ä¸­ä¸­é—´æ¨¡å—ï¼ˆMid Blockï¼‰çš„è¯¦ç»†ç»“æ„å’Œå®ç°ç»†èŠ‚ï¼š\n\n---\n\n### **ä¸­é—´æ¨¡å—æ¦‚è¿°**\n\nä¸­é—´æ¨¡å—ä½äºä¸‹é‡‡æ ·å’Œä¸Šé‡‡æ ·å—ä¹‹é—´ï¼Œè´Ÿè´£åœ¨æœ€ä½åˆ†è¾¨ç‡çš„ç‰¹å¾å›¾ä¸Šè¿›è¡Œå…¨å±€ç‰¹å¾æ•´åˆã€‚å®ƒé€šå¸¸åŒ…å«æ®‹å·®å—å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼Œä»¥ä¾¿åœ¨ç‰¹å¾å›¾çš„æœ€å°ç©ºé—´ç»´åº¦ä¸Šè¿›è¡Œå¤æ‚çš„ç‰¹å¾äº¤äº’ã€‚\n\n---\n\n### **ä¸­é—´æ¨¡å—çš„ç»“æ„**\n\n#### 1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰\n\nä¸­é—´æ¨¡å—é€šå¸¸åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªæ®‹å·®å—ï¼Œç”¨äºç‰¹å¾æå–å’Œéçº¿æ€§å˜æ¢ã€‚\n\n```python\nclass ResNetBlock(nn.Module):\n    def __init__(self, in_channels, out_channels, temb_channels, resnet_eps, resnet_act_fn):\n        super().__init__()\n        self.norm1 = nn.GroupNorm(32, in_channels, eps=resnet_eps)\n        self.act1 = getattr(nn, resnet_act_fn)()\n        self.conv1 = nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1)\n\n        self.norm2 = nn.GroupNorm(32, out_channels, eps=resnet_eps)\n        self.act2 = getattr(nn, resnet_act_fn)()\n        self.conv2 = nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1)\n\n        self.temb_proj = nn.Linear(temb_channels, out_channels)\n\n    def forward(self, x, temb):\n        h = self.norm1(x)\n        h = self.act1(h)\n        h = self.conv1(h)\n\n        h = self.norm2(h)\n        h = self.act2(h)\n        h = self.conv2(h)\n\n        # æ—¶é—´åµŒå…¥æ³¨å…¥\n        h += self.temb_proj(temb)[:, :, None, None]\n\n        return h + x  # æ®‹å·®è¿æ¥\n```\n\n- **ç‰¹å¾å½’ä¸€åŒ–**ï¼šä½¿ç”¨ `GroupNorm` è¿›è¡Œå½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹ã€‚\n- **æ¿€æ´»å‡½æ•°**ï¼šé€šå¸¸ä½¿ç”¨ `SiLU` æˆ– `ReLU`ã€‚\n- **å·ç§¯å±‚**ï¼šä¸¤ä¸ª 3x3 å·ç§¯å±‚ï¼Œä¿æŒç‰¹å¾å›¾å¤§å°ä¸å˜ã€‚\n- **æ—¶é—´åµŒå…¥**ï¼šé€šè¿‡å…¨è¿æ¥å±‚å°†æ—¶é—´åµŒå…¥æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n#### 2. è‡ªæ³¨æ„åŠ›å±‚\n\nè‡ªæ³¨æ„åŠ›å±‚ç”¨äºåœ¨ç‰¹å¾å›¾çš„æœ€å°ç©ºé—´ç»´åº¦ä¸Šè¿›è¡Œå…¨å±€ç‰¹å¾äº¤äº’ã€‚\n\n```python\nclass SelfAttention(nn.Module):\n    def __init__(self, dim, heads=8):\n        super().__init__()\n        self.to_qkv = nn.Linear(dim, dim * 3, bias=False)\n        self.to_out = nn.Linear(dim, dim)\n        self.scale = dim ** -0.5\n\n    def forward(self, x):\n        b, n, _, h = *x.shape, self.heads\n        qkv = self.to_qkv(x).chunk(3, dim=-1)\n        q, k, v = map(lambda t: t.reshape(b, n, h, -1).transpose(1, 2), qkv)\n\n        dots = torch.einsum('bhid,bhjd-\u003ebhij', q, k) * self.scale\n        attn = dots.softmax(dim=-1)\n\n        out = torch.einsum('bhij,bhjd-\u003ebhid', attn, v)\n        out = out.transpose(1, 2).reshape(b, n, -1)\n        return self.to_out(out)\n```\n\n- **æŸ¥è¯¢ã€é”®ã€å€¼**ï¼šé€šè¿‡çº¿æ€§å˜æ¢ç”ŸæˆæŸ¥è¯¢ã€é”®å’Œå€¼å‘é‡ã€‚\n- **æ³¨æ„åŠ›è®¡ç®—**ï¼šä½¿ç”¨ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ã€‚\n- **å…¨å±€ç‰¹å¾äº¤äº’**ï¼šåœ¨ç‰¹å¾å›¾çš„æœ€å°ç©ºé—´ç»´åº¦ä¸Šè¿›è¡Œå…¨å±€ç‰¹å¾äº¤äº’ã€‚\n\n---\n\n#### 3. äº¤å‰æ³¨æ„åŠ›å±‚\n\nåœ¨å¤„ç†æ¡ä»¶è¾“å…¥ï¼ˆå¦‚æ–‡æœ¬åµŒå…¥ï¼‰æ—¶ï¼Œäº¤å‰æ³¨æ„åŠ›å±‚ç”¨äºå°†æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n```python\nclass CrossAttention(nn.Module):\n    def __init__(self, query_dim, context_dim, heads=8):\n        super().__init__()\n        self.to_q = nn.Linear(query_dim, query_dim)\n        self.to_k = nn.Linear(context_dim, query_dim)\n        self.to_v = nn.Linear(context_dim, query_dim)\n        self.scale = query_dim ** -0.5\n\n    def forward(self, x, context):\n        q = self.to_q(x)\n        k = self.to_k(context)\n        v = self.to_v(context)\n\n        attn_weights = torch.einsum('bqd,bkd-\u003ebqk', q, k) * self.scale\n        attn_weights = attn_weights.softmax(dim=-1)\n\n        out = torch.einsum('bqk,bvd-\u003ebqd', attn_weights, v)\n        return out\n```\n\n- **æŸ¥è¯¢ã€é”®ã€å€¼**ï¼šé€šè¿‡çº¿æ€§å˜æ¢ç”ŸæˆæŸ¥è¯¢ã€é”®å’Œå€¼å‘é‡ã€‚\n- **æ³¨æ„åŠ›è®¡ç®—**ï¼šä½¿ç”¨ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›æœºåˆ¶ã€‚\n- **æ¡ä»¶æ³¨å…¥**ï¼šå°†æ–‡æœ¬åµŒå…¥ç­‰æ¡ä»¶ä¿¡æ¯æ³¨å…¥åˆ°ç‰¹å¾å›¾ä¸­ã€‚\n\n---\n\n### **ä¸­é—´æ¨¡å—çš„å®Œæ•´å®ç°**\n\n```python\nclass UNetMidBlock2DCrossAttn(nn.Module):\n    def __init__(self, in_channels, temb_channels, resnet_eps, resnet_act_fn, attn_num_head_channels):\n        super().__init__()\n        self.resnet1 = ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\n        self.attn1 = SelfAttention(in_channels, heads=attn_num_head_channels)\n        self.cross_attn = CrossAttention(in_channels, in_channels)\n        self.resnet2 = ResNetBlock(in_channels, in_channels, temb_channels, resnet_eps, resnet_act_fn)\n\n    def forward(self, x, temb, encoder_hidden_states, attention_mask=None, cross_attention_kwargs=None):\n        x = self.resnet1(x, temb)\n        x = self.attn1(x)\n        x = self.cross_attn(x, encoder_hidden_states)\n        x = self.resnet2(x, temb)\n        return x\n```\n\n- **æ®‹å·®å—**ï¼šä¸¤ä¸ªæ®‹å·®å—ä¸²è”ï¼Œè¿›è¡Œç‰¹å¾æå–ã€‚\n- **è‡ªæ³¨æ„åŠ›**ï¼šåœ¨ç‰¹å¾å›¾çš„æœ€å°ç©ºé—´ç»´åº¦ä¸Šè¿›è¡Œå…¨å±€ç‰¹å¾äº¤äº’ã€‚\n- **äº¤å‰æ³¨æ„åŠ›**ï¼šåœ¨ç‰¹å¾æå–åæ³¨å…¥æ¡ä»¶ä¿¡æ¯ã€‚\n\n---\n\n### **æ€»ç»“**\n\nä¸­é—´æ¨¡å—åœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œé€šè¿‡å¤šå±‚æ¬¡çš„ç‰¹å¾æå–å’Œæ³¨æ„åŠ›æœºåˆ¶ï¼Œåœ¨æœ€ä½åˆ†è¾¨ç‡çš„ç‰¹å¾å›¾ä¸Šè¿›è¡Œå…¨å±€ç‰¹å¾æ•´åˆï¼Œä¸ºä¸Šé‡‡æ ·å—æä¾›ä¸°å¯Œçš„ç‰¹å¾ä¿¡æ¯ã€‚\n\n# Q: è¯¦ç»†è®²è§£è¾“å…¥å¤„ç†ä¸è¾“å‡ºå¤„ç†æ¨¡å—ç»†èŠ‚\n\nå¥½çš„ï¼Œä¸‹é¢æ˜¯ `UNet2DConditionModel` ä¸­è¾“å…¥å¤„ç†å’Œè¾“å‡ºå¤„ç†æ¨¡å—çš„è¯¦ç»†ç»“æ„å’Œå®ç°ç»†èŠ‚ï¼š\n\n---\n\n### **è¾“å…¥å¤„ç†æ¨¡å—**\n\nè¾“å…¥å¤„ç†æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†è¾“å…¥çš„å›¾åƒç‰¹å¾ï¼ˆé€šå¸¸æ˜¯æ½œåœ¨ç©ºé—´è¡¨ç¤ºï¼‰æ˜ å°„åˆ°æ¨¡å‹çš„åˆå§‹ç‰¹å¾ç©ºé—´ã€‚\n\n#### 1. è¾“å…¥å·ç§¯å±‚\n\n```python\nclass InputProcessing(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv_in = nn.Conv2d(\n            in_channels,\n            out_channels,\n            kernel_size=3,\n            padding=1\n        )\n\n    def forward(self, x):\n        return self.conv_in(x)\n```\n\n- **å·ç§¯å±‚**ï¼šä½¿ç”¨ä¸€ä¸ª 3x3 çš„å·ç§¯å±‚ï¼Œå°†è¾“å…¥çš„é€šé“æ•°æ˜ å°„åˆ°æ¨¡å‹çš„åˆå§‹é€šé“æ•°ã€‚\n- **ä½œç”¨**ï¼šå°†è¾“å…¥å›¾åƒçš„ç‰¹å¾æ˜ å°„åˆ°æ›´é«˜ç»´åº¦çš„ç‰¹å¾ç©ºé—´ï¼Œä»¥ä¾¿åç»­çš„ç‰¹å¾æå–ã€‚\n\n---\n\n### **è¾“å‡ºå¤„ç†æ¨¡å—**\n\nè¾“å‡ºå¤„ç†æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†æ¨¡å‹çš„æœ€ç»ˆç‰¹å¾å›¾æ˜ å°„å›è¾“å…¥çš„é€šé“æ•°ï¼Œé€šå¸¸æ˜¯ç”Ÿæˆå›¾åƒçš„æ½œåœ¨ç©ºé—´è¡¨ç¤ºã€‚\n\n#### 1. è¾“å‡ºå·ç§¯å±‚\n\n```python\nclass OutputProcessing(nn.Module):\n    def __init__(self, in_channels, out_channels):\n        super().__init__()\n        self.conv_norm_out = nn.GroupNorm(32, in_channels)\n        self.conv_act = nn.SiLU()\n        self.conv_out = nn.Conv2d(\n            in_channels,\n            out_channels,\n            kernel_size=3,\n            padding=1\n        )\n\n    def forward(self, x):\n        x = self.conv_norm_out(x)\n        x = self.conv_act(x)\n        return self.conv_out(x)\n```\n\n- **å½’ä¸€åŒ–å±‚**ï¼šä½¿ç”¨ `GroupNorm` å¯¹ç‰¹å¾å›¾è¿›è¡Œå½’ä¸€åŒ–ï¼Œç¨³å®šè¾“å‡ºã€‚\n- **æ¿€æ´»å‡½æ•°**ï¼šä½¿ç”¨ `SiLU` æ¿€æ´»å‡½æ•°ï¼Œå¢åŠ éçº¿æ€§ã€‚\n- **å·ç§¯å±‚**ï¼šä½¿ç”¨ä¸€ä¸ª 3x3 çš„å·ç§¯å±‚ï¼Œå°†ç‰¹å¾å›¾æ˜ å°„å›è¾“å…¥çš„é€šé“æ•°ã€‚\n\n---\n\n### **è¾“å…¥ä¸è¾“å‡ºå¤„ç†çš„å®Œæ•´å®ç°**\n\n```python\nclass UNet2DConditionModel(nn.Module):\n    def __init__(self, in_channels, out_channels, block_out_channels):\n        super().__init__()\n        # è¾“å…¥å¤„ç†\n        self.input_processing = InputProcessing(in_channels, block_out_channels[0])\n\n        # å…¶ä»–æ¨¡å—ï¼ˆä¸‹é‡‡æ ·ã€ä¸­é—´ã€ä¸Šé‡‡æ ·ï¼‰\n\n        # è¾“å‡ºå¤„ç†\n        self.output_processing = OutputProcessing(block_out_channels[-1], out_channels)\n\n    def forward(self, x):\n        # è¾“å…¥å¤„ç†\n        x = self.input_processing(x)\n\n        # å…¶ä»–æ¨¡å—å¤„ç†\n\n        # è¾“å‡ºå¤„ç†\n        x = self.output_processing(x)\n        return x\n```\n\n- **è¾“å…¥å¤„ç†**ï¼šå°†è¾“å…¥å›¾åƒçš„ç‰¹å¾æ˜ å°„åˆ°æ¨¡å‹çš„åˆå§‹ç‰¹å¾ç©ºé—´ã€‚\n- **è¾“å‡ºå¤„ç†**ï¼šå°†æ¨¡å‹çš„æœ€ç»ˆç‰¹å¾å›¾æ˜ å°„å›è¾“å…¥çš„é€šé“æ•°ã€‚\n\n---\n\n### **æ€»ç»“**\n\nè¾“å…¥å¤„ç†å’Œè¾“å‡ºå¤„ç†æ¨¡å—åœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œåˆ†åˆ«è´Ÿè´£å°†è¾“å…¥å›¾åƒçš„ç‰¹å¾æ˜ å°„åˆ°æ¨¡å‹çš„åˆå§‹ç‰¹å¾ç©ºé—´ï¼Œä»¥åŠå°†æ¨¡å‹çš„æœ€ç»ˆç‰¹å¾å›¾æ˜ å°„å›è¾“å…¥çš„é€šé“æ•°ã€‚è¿™ä¸¤ä¸ªæ¨¡å—é€šè¿‡ç®€å•çš„å·ç§¯æ“ä½œå®ç°äº†ç‰¹å¾çš„ç»´åº¦å˜æ¢ï¼Œä¸ºæ¨¡å‹çš„ç‰¹å¾æå–å’Œç”Ÿæˆæä¾›äº†åŸºç¡€ã€‚\n\n# Q: è¯¦ç»†è®²è§£æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»†èŠ‚\n\næ—¶é—´åµŒå…¥ç³»ç»Ÿåœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œå®ƒå°†æ—¶é—´æ­¥ä¿¡æ¯ç¼–ç ä¸ºæ¡ä»¶å‘é‡ï¼Œä»¥ä¾¿åœ¨æ¨¡å‹çš„å„ä¸ªé˜¶æ®µä¸­æ³¨å…¥æ—¶é—´ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„è¯¦ç»†ç»“æ„å’Œå®ç°ç»†èŠ‚ï¼š\n\n---\n\n### **æ—¶é—´åµŒå…¥ç³»ç»Ÿæ¦‚è¿°**\n\næ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ä¸»è¦åŠŸèƒ½æ˜¯å°†æ—¶é—´æ­¥ï¼ˆtimestepï¼‰ä¿¡æ¯è½¬æ¢ä¸ºé«˜ç»´å‘é‡ï¼Œè¿™äº›å‘é‡åœ¨æ¨¡å‹çš„æ®‹å·®å—ä¸­è¢«ç”¨ä½œæ¡ä»¶ä¿¡æ¯ï¼Œä»¥æŒ‡å¯¼æ¨¡å‹åœ¨ä¸åŒæ—¶é—´æ­¥çš„ç‰¹å¾æå–å’Œç”Ÿæˆè¿‡ç¨‹ã€‚\n\n---\n\n### **æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»“æ„**\n\n#### 1. æ­£å¼¦ä½ç½®ç¼–ç \n\næ—¶é—´åµŒå…¥ç³»ç»Ÿé€šå¸¸ä½¿ç”¨æ­£å¼¦ä½ç½®ç¼–ç æ¥ç”Ÿæˆåˆå§‹æ—¶é—´ç‰¹å¾ã€‚\n\n```python\ndef get_timestep_embedding(timesteps, embedding_dim):\n    half_dim = embedding_dim // 2\n    emb = math.log(10000) / (half_dim - 1)\n    emb = torch.exp(torch.arange(half_dim, dtype=torch.float32) * -emb)\n    emb = timesteps[:, None] * emb[None, :]\n    emb = torch.cat([torch.sin(emb), torch.cos(emb)], dim=-1)\n    return emb\n```\n\n- **æ­£å¼¦å’Œä½™å¼¦å‡½æ•°**ï¼šä½¿ç”¨æ­£å¼¦å’Œä½™å¼¦å‡½æ•°ç”Ÿæˆæ—¶é—´æ­¥çš„å‘¨æœŸæ€§è¡¨ç¤ºã€‚\n- **ç»´åº¦æ‰©å±•**ï¼šå°†æ—¶é—´æ­¥æ‰©å±•ä¸ºé«˜ç»´å‘é‡ï¼Œç»´åº¦ä¸º `embedding_dim`ã€‚\n\n---\n\n#### 2. æ—¶é—´åµŒå…¥å±‚\n\næ—¶é—´åµŒå…¥å±‚å°†æ­£å¼¦ä½ç½®ç¼–ç çš„è¾“å‡ºè¿›ä¸€æ­¥è½¬æ¢ä¸ºæ¨¡å‹æ‰€éœ€çš„é«˜ç»´æ¡ä»¶å‘é‡ã€‚\n\n```python\nclass TimestepEmbedding(nn.Module):\n    def __init__(self, timestep_input_dim, time_embed_dim, act_fn):\n        super().__init__()\n        self.linear1 = nn.Linear(timestep_input_dim, time_embed_dim)\n        self.act = getattr(nn, act_fn)()\n        self.linear2 = nn.Linear(time_embed_dim, time_embed_dim)\n\n    def forward(self, timesteps):\n        emb = get_timestep_embedding(timesteps, self.linear1.in_features)\n        emb = self.linear1(emb)\n        emb = self.act(emb)\n        emb = self.linear2(emb)\n        return emb\n```\n\n- **çº¿æ€§å˜æ¢**ï¼šä½¿ç”¨ä¸¤ä¸ªçº¿æ€§å±‚å°†æ—¶é—´æ­¥åµŒå…¥è½¬æ¢ä¸ºé«˜ç»´æ¡ä»¶å‘é‡ã€‚\n- **æ¿€æ´»å‡½æ•°**ï¼šé€šå¸¸ä½¿ç”¨ `SiLU` æˆ– `ReLU` æ¿€æ´»å‡½æ•°ï¼Œå¢åŠ éçº¿æ€§ã€‚\n\n---\n\n### **æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„å®Œæ•´å®ç°**\n\n```python\nclass UNet2DConditionModel(nn.Module):\n    def __init__(self, timestep_input_dim, time_embed_dim, act_fn):\n        super().__init__()\n        self.time_embedding = TimestepEmbedding(timestep_input_dim, time_embed_dim, act_fn)\n\n    def forward(self, x, timesteps):\n        # æ—¶é—´åµŒå…¥\n        t_emb = self.time_embedding(timesteps)\n\n        # å…¶ä»–æ¨¡å—å¤„ç†\n        return x\n```\n\n- **æ—¶é—´åµŒå…¥**ï¼šå°†æ—¶é—´æ­¥ä¿¡æ¯è½¬æ¢ä¸ºé«˜ç»´æ¡ä»¶å‘é‡ã€‚\n- **æ³¨å…¥åˆ°æ¨¡å‹**ï¼šæ—¶é—´åµŒå…¥è¢«æ³¨å…¥åˆ°æ¨¡å‹çš„å„ä¸ªé˜¶æ®µï¼ŒæŒ‡å¯¼ç‰¹å¾æå–å’Œç”Ÿæˆã€‚\n\n---\n\n### **æ€»ç»“**\n\næ—¶é—´åµŒå…¥ç³»ç»Ÿåœ¨ `UNet2DConditionModel` ä¸­èµ·åˆ°äº†å…³é”®ä½œç”¨ï¼Œé€šè¿‡å°†æ—¶é—´æ­¥ä¿¡æ¯ç¼–ç ä¸ºé«˜ç»´æ¡ä»¶å‘é‡ï¼ŒæŒ‡å¯¼æ¨¡å‹åœ¨ä¸åŒæ—¶é—´æ­¥çš„ç‰¹å¾æå–å’Œç”Ÿæˆè¿‡ç¨‹ã€‚è¿™ä¸€ç³»ç»Ÿé€šè¿‡æ­£å¼¦ä½ç½®ç¼–ç å’Œçº¿æ€§å˜æ¢å®ç°äº†æ—¶é—´ä¿¡æ¯çš„é«˜æ•ˆç¼–ç ï¼Œä¸ºæ¨¡å‹çš„æ—¶é—´æ¡ä»¶æ³¨å…¥æä¾›äº†åŸºç¡€ã€‚\n","title":"Stable Diffusion UNet å†…éƒ¨ç»“æ„","abstract":"\u003e [!summary]\n\u003e ä»¥ä¸‹å†…å®¹ä¸º Cursor ä¸­æ‹¥æœ‰ codebase ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ä¸ claude-3.7-sonnet çš„å¯¹è¯è®°å½•\nåœ¨ `train_text_to_image_lora.py` è„šæœ¬ä¸­ï¼ŒLoRAï¼ˆLow-Rank Adaptationï¼‰é€šè¿‡åœ¨æ¨¡å‹çš„ç‰¹å®šå±‚ä¸­æ’å…¥ä½ç§©çŸ©é˜µæ¥å®ç°å¾®è°ƒã€‚è¿™ç§æ–¹æ³•é€šè¿‡æ·»åŠ ä¸¤ä¸ªä½ç§©çŸ©é˜µæ¥è°ƒæ•´æ¨¡å‹çš„æƒé‡ï¼Œè€Œä¸æ”¹å˜åŸå§‹æƒé‡ï¼Œä»è€Œå®ç°å‚æ•°é«˜æ•ˆçš„å¾®è°ƒã€‚","length":1560,"created_at":"2025-03-28T02:00:00.000Z","updated_at":"2025-03-28T02:00:00.000Z","tags":["æ·±åº¦å­¦ä¹ ","Stable Diffusion","LoRA","å‚æ•°é«˜æ•ˆå¾®è°ƒ","æ¨¡å‹è®­ç»ƒ","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-train_text_to_image_lorapy-è¿™æ®µä»£ç ä¸­å¦‚ä½•ä½“ç°-lora-ä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒ-çš„æ­¥éª¤","href":"#q-train_text_to_image_lorapy-è¿™æ®µä»£ç ä¸­å¦‚ä½•ä½“ç°-lora-ä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒ-çš„æ­¥éª¤","heading":1,"title":"Q: @train_text_to_image_lora.py è¿™æ®µä»£ç ä¸­å¦‚ä½•ä½“ç° LoRA â€œä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒâ€ çš„æ­¥éª¤ï¼Ÿ","children":[{"key":"1-lora-é…ç½®","href":"#1-lora-é…ç½®","heading":3,"title":"1. LoRA é…ç½®","children":[],"id":"1-lora-é…ç½®"},{"key":"2-æ·»åŠ -lora-å±‚","href":"#2-æ·»åŠ -lora-å±‚","heading":3,"title":"2. æ·»åŠ  LoRA å±‚","children":[],"id":"2-æ·»åŠ -lora-å±‚"},{"key":"3-è®­ç»ƒè¿‡ç¨‹ä¸­çš„æƒé‡æ›´æ–°","href":"#3-è®­ç»ƒè¿‡ç¨‹ä¸­çš„æƒé‡æ›´æ–°","heading":3,"title":"3. è®­ç»ƒè¿‡ç¨‹ä¸­çš„æƒé‡æ›´æ–°","children":[],"id":"3-è®­ç»ƒè¿‡ç¨‹ä¸­çš„æƒé‡æ›´æ–°"},{"key":"4-å‚æ•°æ›´æ–°","href":"#4-å‚æ•°æ›´æ–°","heading":3,"title":"4. å‚æ•°æ›´æ–°","children":[],"id":"4-å‚æ•°æ›´æ–°"},{"key":"æ€»ç»“","href":"#æ€»ç»“","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“"}],"id":"q-train_text_to_image_lorapy-è¿™æ®µä»£ç ä¸­å¦‚ä½•ä½“ç°-lora-ä½¿ç”¨ä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œå¾®è°ƒ-çš„æ­¥éª¤"},{"key":"q-unet-æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„","href":"#q-unet-æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„","heading":1,"title":"Q: unet æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„ï¼Ÿ","children":[{"key":"unet-çš„åŸºæœ¬ç»“æ„","href":"#unet-çš„åŸºæœ¬ç»“æ„","heading":3,"title":"UNet çš„åŸºæœ¬ç»“æ„","children":[],"id":"unet-çš„åŸºæœ¬ç»“æ„"},{"key":"unet-åœ¨-stable-diffusion-ä¸­çš„åº”ç”¨","href":"#unet-åœ¨-stable-diffusion-ä¸­çš„åº”ç”¨","heading":3,"title":"UNet åœ¨ Stable Diffusion ä¸­çš„åº”ç”¨","children":[],"id":"unet-åœ¨-stable-diffusion-ä¸­çš„åº”ç”¨"},{"key":"unet-çš„ä¼˜åŠ¿","href":"#unet-çš„ä¼˜åŠ¿","heading":3,"title":"UNet çš„ä¼˜åŠ¿","children":[],"id":"unet-çš„ä¼˜åŠ¿"}],"id":"q-unet-æ˜¯ä¸ªä»€ä¹ˆæ ·çš„ç»“æ„"},{"key":"q-ä¸ºä»€ä¹ˆè¿™é‡Œ-unet-vae--tokenizer-ç­‰å‡ ä¸ªæ¨¡å‹éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„","href":"#q-ä¸ºä»€ä¹ˆè¿™é‡Œ-unet-vae--tokenizer-ç­‰å‡ ä¸ªæ¨¡å‹éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„","heading":1,"title":"Q: ä¸ºä»€ä¹ˆè¿™é‡Œ unetã€ vae ã€ tokenizer ç­‰å‡ ä¸ªæ¨¡å‹éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„ï¼Ÿ","children":[{"key":"1-ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„","href":"#1-ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„","heading":3,"title":"1. ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„","children":[],"id":"1-ç»Ÿä¸€çš„æ¨¡å‹è·¯å¾„"},{"key":"2-å„ä¸ªç»„ä»¶çš„ä½œç”¨","href":"#2-å„ä¸ªç»„ä»¶çš„ä½œç”¨","heading":3,"title":"2. å„ä¸ªç»„ä»¶çš„ä½œç”¨","children":[],"id":"2-å„ä¸ªç»„ä»¶çš„ä½œç”¨"},{"key":"3-ç»Ÿä¸€åŠ è½½çš„å¥½å¤„","href":"#3-ç»Ÿä¸€åŠ è½½çš„å¥½å¤„","heading":3,"title":"3. ç»Ÿä¸€åŠ è½½çš„å¥½å¤„","children":[],"id":"3-ç»Ÿä¸€åŠ è½½çš„å¥½å¤„"}],"id":"q-ä¸ºä»€ä¹ˆè¿™é‡Œ-unet-vae--tokenizer-ç­‰å‡ ä¸ªæ¨¡å‹éƒ½æ˜¯ä»åŒä¸€ä¸ªè·¯å¾„åŠ è½½çš„"},{"key":"q-è¿™äº›æ˜¯-stable-diffusion-çš„å†…éƒ¨è®¾è®¡å¯¹å§è¿™äº›éƒ½åœ¨å“ªç¯‡è®ºæ–‡é‡Œæå‡ºçš„-web","href":"#q-è¿™äº›æ˜¯-stable-diffusion-çš„å†…éƒ¨è®¾è®¡å¯¹å§è¿™äº›éƒ½åœ¨å“ªç¯‡è®ºæ–‡é‡Œæå‡ºçš„-web","heading":1,"title":"Q: è¿™äº›æ˜¯ Stable Diffusion çš„å†…éƒ¨è®¾è®¡å¯¹å§ï¼Ÿè¿™äº›éƒ½åœ¨å“ªç¯‡è®ºæ–‡é‡Œæå‡ºçš„ï¼Ÿ @Web","children":[],"id":"q-è¿™äº›æ˜¯-stable-diffusion-çš„å†…éƒ¨è®¾è®¡å¯¹å§è¿™äº›éƒ½åœ¨å“ªç¯‡è®ºæ–‡é‡Œæå‡ºçš„-web"},{"key":"q-è§£é‡Š-stablediffusionpipeline-çš„ç»“æ„-pipeline_stable_diffusionpy","href":"#q-è§£é‡Š-stablediffusionpipeline-çš„ç»“æ„-pipeline_stable_diffusionpy","heading":1,"title":"Q: è§£é‡Š StableDiffusionPipeline çš„ç»“æ„ @pipeline_stable_diffusion.py","children":[{"key":"ç»§æ‰¿å…³ç³»","href":"#ç»§æ‰¿å…³ç³»","heading":3,"title":"ç»§æ‰¿å…³ç³»","children":[],"id":"ç»§æ‰¿å…³ç³»"},{"key":"åˆå§‹åŒ–æ–¹æ³•","href":"#åˆå§‹åŒ–æ–¹æ³•","heading":3,"title":"åˆå§‹åŒ–æ–¹æ³•","children":[],"id":"åˆå§‹åŒ–æ–¹æ³•"},{"key":"åŠŸèƒ½å’Œæ–¹æ³•","href":"#åŠŸèƒ½å’Œæ–¹æ³•","heading":3,"title":"åŠŸèƒ½å’Œæ–¹æ³•","children":[],"id":"åŠŸèƒ½å’Œæ–¹æ³•"},{"key":"å±æ€§","href":"#å±æ€§","heading":3,"title":"å±æ€§","children":[],"id":"å±æ€§"},{"key":"è®¾è®¡ç›®çš„","href":"#è®¾è®¡ç›®çš„","heading":3,"title":"è®¾è®¡ç›®çš„","children":[],"id":"è®¾è®¡ç›®çš„"}],"id":"q-è§£é‡Š-stablediffusionpipeline-çš„ç»“æ„-pipeline_stable_diffusionpy"},{"key":"q-pipeline_utilspy-è§£é‡Š-diffusionpipeline-çš„ç»“æ„ä»¥åŠ-from_pretrained-åœ¨åšä»€ä¹ˆ","href":"#q-pipeline_utilspy-è§£é‡Š-diffusionpipeline-çš„ç»“æ„ä»¥åŠ-from_pretrained-åœ¨åšä»€ä¹ˆ","heading":1,"title":"Q: @pipeline_utils.py è§£é‡Š DiffusionPipeline çš„ç»“æ„ï¼Œä»¥åŠ from_pretrained åœ¨åšä»€ä¹ˆ","children":[{"key":"diffusionpipeline-çš„ç»“æ„","href":"#diffusionpipeline-çš„ç»“æ„","heading":3,"title":"DiffusionPipeline çš„ç»“æ„","children":[],"id":"diffusionpipeline-çš„ç»“æ„"},{"key":"from_pretrained-æ–¹æ³•","href":"#from_pretrained-æ–¹æ³•","heading":3,"title":"from_pretrained æ–¹æ³•","children":[],"id":"from_pretrained-æ–¹æ³•"},{"key":"è®¾è®¡ç›®çš„-1","href":"#è®¾è®¡ç›®çš„-1","heading":3,"title":"è®¾è®¡ç›®çš„","children":[],"id":"è®¾è®¡ç›®çš„-1"}],"id":"q-pipeline_utilspy-è§£é‡Š-diffusionpipeline-çš„ç»“æ„ä»¥åŠ-from_pretrained-åœ¨åšä»€ä¹ˆ"},{"key":"q-train_text_to_image_lorapy-é‡Œä»-diffusionpipelinefrom_pretrained-åŠ è½½åˆ°äº†-pipeline_stable_diffusionpy-ä¸­-stablediffusionpipeline-ç±»çš„å®ä¾‹æˆ‘ç†è§£çš„å¯¹å—","href":"#q-train_text_to_image_lorapy-é‡Œä»-diffusionpipelinefrom_pretrained-åŠ è½½åˆ°äº†-pipeline_stable_diffusionpy-ä¸­-stablediffusionpipeline-ç±»çš„å®ä¾‹æˆ‘ç†è§£çš„å¯¹å—","heading":1,"title":"Q: @train_text_to_image_lora.py é‡Œï¼Œä» DiffusionPipeline.from_pretrained åŠ è½½åˆ°äº† @pipeline_stable_diffusion.py ä¸­ StableDiffusionPipeline ç±»çš„å®ä¾‹ï¼Œæˆ‘ç†è§£çš„å¯¹å—ï¼Ÿ","children":[{"key":"å…·ä½“è¿‡ç¨‹å¦‚ä¸‹","href":"#å…·ä½“è¿‡ç¨‹å¦‚ä¸‹","heading":3,"title":"å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š","children":[],"id":"å…·ä½“è¿‡ç¨‹å¦‚ä¸‹"}],"id":"q-train_text_to_image_lorapy-é‡Œä»-diffusionpipelinefrom_pretrained-åŠ è½½åˆ°äº†-pipeline_stable_diffusionpy-ä¸­-stablediffusionpipeline-ç±»çš„å®ä¾‹æˆ‘ç†è§£çš„å¯¹å—"},{"key":"q-è§£è¯»-pipeline_utilspy-ä¸­-from_pretrained-ä»£ç è¯¦ç»†è¯´æ˜å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹é€‰æ‹©ç®¡é“ç±»-codebase","href":"#q-è§£è¯»-pipeline_utilspy-ä¸­-from_pretrained-ä»£ç è¯¦ç»†è¯´æ˜å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹é€‰æ‹©ç®¡é“ç±»-codebase","heading":1,"title":"Q: è§£è¯» @pipeline_utils.py ä¸­ from_pretrained ä»£ç ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹é€‰æ‹©ç®¡é“ç±»ã€‚ @Codebase","children":[{"key":"è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©ç®¡é“ç±»çš„æ­¥éª¤","href":"#è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©ç®¡é“ç±»çš„æ­¥éª¤","heading":3,"title":"è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©ç®¡é“ç±»çš„æ­¥éª¤","children":[],"id":"è¯†åˆ«æ¨¡å‹ç±»å‹å¹¶é€‰æ‹©ç®¡é“ç±»çš„æ­¥éª¤"}],"id":"q-è§£è¯»-pipeline_utilspy-ä¸­-from_pretrained-ä»£ç è¯¦ç»†è¯´æ˜å¦‚ä½•è¯†åˆ«æ¨¡å‹ç±»å‹é€‰æ‹©ç®¡é“ç±»-codebase"},{"key":"q-å¦‚æœæˆ‘åªæœ‰ä¸€ä¸ª-sd_xl_base_10safetensors-æ–‡ä»¶æ˜¯å¦æ— æ³•ä½¿ç”¨-from_pretrained-æ–¹æ³•å¾—åˆ°å…·ä½“çš„-pipeline-å®ä¾‹","href":"#q-å¦‚æœæˆ‘åªæœ‰ä¸€ä¸ª-sd_xl_base_10safetensors-æ–‡ä»¶æ˜¯å¦æ— æ³•ä½¿ç”¨-from_pretrained-æ–¹æ³•å¾—åˆ°å…·ä½“çš„-pipeline-å®ä¾‹","heading":1,"title":"Q: å¦‚æœæˆ‘åªæœ‰ä¸€ä¸ª sd_xl_base_1.0.safetensors æ–‡ä»¶ï¼Œæ˜¯å¦æ— æ³•ä½¿ç”¨ from_pretrained æ–¹æ³•å¾—åˆ°å…·ä½“çš„ Pipeline å®ä¾‹ï¼Ÿ","children":[{"key":"è§£å†³æ–¹æ¡ˆ","href":"#è§£å†³æ–¹æ¡ˆ","heading":3,"title":"è§£å†³æ–¹æ¡ˆ","children":[],"id":"è§£å†³æ–¹æ¡ˆ"},{"key":"æ€»ç»“-1","href":"#æ€»ç»“-1","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-1"}],"id":"q-å¦‚æœæˆ‘åªæœ‰ä¸€ä¸ª-sd_xl_base_10safetensors-æ–‡ä»¶æ˜¯å¦æ— æ³•ä½¿ç”¨-from_pretrained-æ–¹æ³•å¾—åˆ°å…·ä½“çš„-pipeline-å®ä¾‹"},{"key":"q-å¦‚æœæˆ‘åªéœ€è¦è¿›è¡Œæ¨ç†æ˜¯å¦ä»éœ€é…ç½®æ–‡ä»¶","href":"#q-å¦‚æœæˆ‘åªéœ€è¦è¿›è¡Œæ¨ç†æ˜¯å¦ä»éœ€é…ç½®æ–‡ä»¶","heading":1,"title":"Q: å¦‚æœæˆ‘åªéœ€è¦è¿›è¡Œæ¨ç†ï¼Œæ˜¯å¦ä»éœ€é…ç½®æ–‡ä»¶ï¼Ÿ","children":[{"key":"ä¸ºä»€ä¹ˆéœ€è¦é…ç½®æ–‡ä»¶","href":"#ä¸ºä»€ä¹ˆéœ€è¦é…ç½®æ–‡ä»¶","heading":3,"title":"ä¸ºä»€ä¹ˆéœ€è¦é…ç½®æ–‡ä»¶","children":[],"id":"ä¸ºä»€ä¹ˆéœ€è¦é…ç½®æ–‡ä»¶"},{"key":"æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶çš„æ¨ç†","href":"#æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶çš„æ¨ç†","heading":3,"title":"æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶çš„æ¨ç†","children":[],"id":"æ²¡æœ‰é…ç½®æ–‡ä»¶æ—¶çš„æ¨ç†"},{"key":"æ€»ç»“-2","href":"#æ€»ç»“-2","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-2"}],"id":"q-å¦‚æœæˆ‘åªéœ€è¦è¿›è¡Œæ¨ç†æ˜¯å¦ä»éœ€é…ç½®æ–‡ä»¶"},{"key":"q-ä»¥ä½ ä¸Šé¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹pipeline_loading_utilspy-load_sub_model-ä¸­å®ä¾‹åŒ–çš„æ˜¯-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-ç±»å—-load_sub_model-æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªç±»å¹¶å®ä¾‹åŒ–çš„","href":"#q-ä»¥ä½ ä¸Šé¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹pipeline_loading_utilspy-load_sub_model-ä¸­å®ä¾‹åŒ–çš„æ˜¯-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-ç±»å—-load_sub_model-æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªç±»å¹¶å®ä¾‹åŒ–çš„","heading":1,"title":"Q: ä»¥ä½ ä¸Šé¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹ï¼Œ@pipeline_loading_utils.py load_sub_model ä¸­ï¼Œå®ä¾‹åŒ–çš„æ˜¯ @unet_2d_condition.py ä¸­çš„ UNet2DConditionModel ç±»å—ï¼Ÿ load_sub_model æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªç±»å¹¶å®ä¾‹åŒ–çš„ï¼Ÿ","children":[{"key":"æ ¸å¿ƒåŠ è½½æµç¨‹","href":"#æ ¸å¿ƒåŠ è½½æµç¨‹","heading":3,"title":"æ ¸å¿ƒåŠ è½½æµç¨‹","children":[],"id":"æ ¸å¿ƒåŠ è½½æµç¨‹"},{"key":"å…·ä½“æ­¥éª¤è§£æ","href":"#å…·ä½“æ­¥éª¤è§£æ","heading":3,"title":"å…·ä½“æ­¥éª¤è§£æ","children":[{"key":"1-ç±»å¯¹è±¡è·å–-get_class_obj_and_candidates","href":"#1-ç±»å¯¹è±¡è·å–-get_class_obj_and_candidates","heading":4,"title":"1. ç±»å¯¹è±¡è·å– (get_class_obj_and_candidates)","children":[],"id":"1-ç±»å¯¹è±¡è·å–-get_class_obj_and_candidates"},{"key":"2-åŠ è½½æ–¹æ³•åŒ¹é…","href":"#2-åŠ è½½æ–¹æ³•åŒ¹é…","heading":4,"title":"2. åŠ è½½æ–¹æ³•åŒ¹é…","children":[],"id":"2-åŠ è½½æ–¹æ³•åŒ¹é…"},{"key":"3-åŠ è½½æ–¹æ³•ç»‘å®š","href":"#3-åŠ è½½æ–¹æ³•ç»‘å®š","heading":4,"title":"3. åŠ è½½æ–¹æ³•ç»‘å®š","children":[],"id":"3-åŠ è½½æ–¹æ³•ç»‘å®š"},{"key":"4-å®ä¾‹åŒ–-unet","href":"#4-å®ä¾‹åŒ–-unet","heading":4,"title":"4. å®ä¾‹åŒ– UNet","children":[],"id":"4-å®ä¾‹åŒ–-unet"}],"id":"å…·ä½“æ­¥éª¤è§£æ"},{"key":"unet2dconditionmodel-çš„æ³¨å†Œæœºåˆ¶","href":"#unet2dconditionmodel-çš„æ³¨å†Œæœºåˆ¶","heading":3,"title":"UNet2DConditionModel çš„æ³¨å†Œæœºåˆ¶","children":[],"id":"unet2dconditionmodel-çš„æ³¨å†Œæœºåˆ¶"},{"key":"æ¶æ„å‚æ•°å¦‚ä½•ç”Ÿæ•ˆ","href":"#æ¶æ„å‚æ•°å¦‚ä½•ç”Ÿæ•ˆ","heading":3,"title":"æ¶æ„å‚æ•°å¦‚ä½•ç”Ÿæ•ˆ","children":[],"id":"æ¶æ„å‚æ•°å¦‚ä½•ç”Ÿæ•ˆ"},{"key":"æ€»ç»“æµç¨‹å›¾","href":"#æ€»ç»“æµç¨‹å›¾","heading":3,"title":"æ€»ç»“æµç¨‹å›¾","children":[],"id":"æ€»ç»“æµç¨‹å›¾"}],"id":"q-ä»¥ä½ ä¸Šé¢ä¸¾çš„ä¾‹å­ä¸ºä¾‹pipeline_loading_utilspy-load_sub_model-ä¸­å®ä¾‹åŒ–çš„æ˜¯-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-ç±»å—-load_sub_model-æ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªç±»å¹¶å®ä¾‹åŒ–çš„"},{"key":"q-è§£æä»£ç è¯¦è§£modeling_utilspy-çš„-from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-","href":"#q-è§£æä»£ç è¯¦è§£modeling_utilspy-çš„-from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-","heading":1,"title":"Q: è§£æä»£ç ï¼Œè¯¦è§£@modeling_utils.py çš„ from_pretrained å¦‚ä½•å®ä¾‹åŒ– @unet_2d_condition.py ä¸­çš„ UNet2DConditionModel ï¼Ÿ","children":[],"id":"q-è§£æä»£ç è¯¦è§£modeling_utilspy-çš„-from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet_2d_conditionpy-ä¸­çš„-unet2dconditionmodel-"},{"key":"from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet2dconditionmodel-çš„è¯¦ç»†æµç¨‹","href":"#from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet2dconditionmodel-çš„è¯¦ç»†æµç¨‹","heading":1,"title":"from_pretrained å¦‚ä½•å®ä¾‹åŒ– UNet2DConditionModel çš„è¯¦ç»†æµç¨‹","children":[{"key":"1-åŠ è½½é…ç½®æ–‡ä»¶","href":"#1-åŠ è½½é…ç½®æ–‡ä»¶","heading":2,"title":"1. åŠ è½½é…ç½®æ–‡ä»¶","children":[],"id":"1-åŠ è½½é…ç½®æ–‡ä»¶"},{"key":"2-åˆ›å»ºç©ºæ¨¡å‹å®ä¾‹","href":"#2-åˆ›å»ºç©ºæ¨¡å‹å®ä¾‹","heading":2,"title":"2. åˆ›å»ºç©ºæ¨¡å‹å®ä¾‹","children":[],"id":"2-åˆ›å»ºç©ºæ¨¡å‹å®ä¾‹"},{"key":"3-åŠ è½½æƒé‡æ–‡ä»¶","href":"#3-åŠ è½½æƒé‡æ–‡ä»¶","heading":2,"title":"3. åŠ è½½æƒé‡æ–‡ä»¶","children":[],"id":"3-åŠ è½½æƒé‡æ–‡ä»¶"},{"key":"4-å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­","href":"#4-å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­","heading":2,"title":"4. å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­","children":[],"id":"4-å°†æƒé‡åŠ è½½åˆ°æ¨¡å‹ä¸­"},{"key":"5-è®¾å¤‡åˆ†é…å’Œåå¤„ç†","href":"#5-è®¾å¤‡åˆ†é…å’Œåå¤„ç†","heading":2,"title":"5. è®¾å¤‡åˆ†é…å’Œåå¤„ç†","children":[],"id":"5-è®¾å¤‡åˆ†é…å’Œåå¤„ç†"},{"key":"6-è¿”å›å®ä¾‹åŒ–çš„æ¨¡å‹","href":"#6-è¿”å›å®ä¾‹åŒ–çš„æ¨¡å‹","heading":2,"title":"6. è¿”å›å®ä¾‹åŒ–çš„æ¨¡å‹","children":[],"id":"6-è¿”å›å®ä¾‹åŒ–çš„æ¨¡å‹"},{"key":"å…³é”®å®ç°ç»†èŠ‚","href":"#å…³é”®å®ç°ç»†èŠ‚","heading":2,"title":"å…³é”®å®ç°ç»†èŠ‚","children":[],"id":"å…³é”®å®ç°ç»†èŠ‚"}],"id":"from_pretrained-å¦‚ä½•å®ä¾‹åŒ–-unet2dconditionmodel-çš„è¯¦ç»†æµç¨‹"},{"key":"q-è¯¦ç»†è§£é‡Š-unet_2d_conditionpy-ä¸­-unet2dconditionmodel-çš„ç»“æ„","href":"#q-è¯¦ç»†è§£é‡Š-unet_2d_conditionpy-ä¸­-unet2dconditionmodel-çš„ç»“æ„","heading":1,"title":"Q: è¯¦ç»†è§£é‡Š @unet_2d_condition.py ä¸­ UNet2DConditionModel çš„ç»“æ„","children":[{"key":"æ•´ä½“æ¶æ„","href":"#æ•´ä½“æ¶æ„","heading":3,"title":"æ•´ä½“æ¶æ„","children":[],"id":"æ•´ä½“æ¶æ„"},{"key":"æ ¸å¿ƒç»„ä»¶","href":"#æ ¸å¿ƒç»„ä»¶","heading":3,"title":"æ ¸å¿ƒç»„ä»¶","children":[{"key":"1-è¾“å…¥å¤„ç†","href":"#1-è¾“å…¥å¤„ç†","heading":4,"title":"1. è¾“å…¥å¤„ç†","children":[],"id":"1-è¾“å…¥å¤„ç†"},{"key":"2-æ—¶é—´åµŒå…¥ç³»ç»Ÿ","href":"#2-æ—¶é—´åµŒå…¥ç³»ç»Ÿ","heading":4,"title":"2. æ—¶é—´åµŒå…¥ç³»ç»Ÿ","children":[],"id":"2-æ—¶é—´åµŒå…¥ç³»ç»Ÿ"},{"key":"3-ä¸‹é‡‡æ ·æ¨¡å—","href":"#3-ä¸‹é‡‡æ ·æ¨¡å—","heading":4,"title":"3. ä¸‹é‡‡æ ·æ¨¡å—","children":[],"id":"3-ä¸‹é‡‡æ ·æ¨¡å—"},{"key":"4-ä¸­é—´æ¨¡å—","href":"#4-ä¸­é—´æ¨¡å—","heading":4,"title":"4. ä¸­é—´æ¨¡å—","children":[],"id":"4-ä¸­é—´æ¨¡å—"},{"key":"5-ä¸Šé‡‡æ ·æ¨¡å—","href":"#5-ä¸Šé‡‡æ ·æ¨¡å—","heading":4,"title":"5. ä¸Šé‡‡æ ·æ¨¡å—","children":[],"id":"5-ä¸Šé‡‡æ ·æ¨¡å—"},{"key":"6-è¾“å‡ºå¤„ç†","href":"#6-è¾“å‡ºå¤„ç†","heading":4,"title":"6. è¾“å‡ºå¤„ç†","children":[],"id":"6-è¾“å‡ºå¤„ç†"}],"id":"æ ¸å¿ƒç»„ä»¶"},{"key":"æ¡ä»¶æ§åˆ¶æœºåˆ¶","href":"#æ¡ä»¶æ§åˆ¶æœºåˆ¶","heading":3,"title":"æ¡ä»¶æ§åˆ¶æœºåˆ¶","children":[{"key":"äº¤å‰æ³¨æ„åŠ›å±‚","href":"#äº¤å‰æ³¨æ„åŠ›å±‚","heading":4,"title":"äº¤å‰æ³¨æ„åŠ›å±‚","children":[],"id":"äº¤å‰æ³¨æ„åŠ›å±‚"}],"id":"æ¡ä»¶æ§åˆ¶æœºåˆ¶"},{"key":"å…³é”®å‚æ•°è¯´æ˜","href":"#å…³é”®å‚æ•°è¯´æ˜","heading":3,"title":"å…³é”®å‚æ•°è¯´æ˜","children":[],"id":"å…³é”®å‚æ•°è¯´æ˜"},{"key":"æ•°æ®æµåŠ¨ç¤ºä¾‹","href":"#æ•°æ®æµåŠ¨ç¤ºä¾‹","heading":3,"title":"æ•°æ®æµåŠ¨ç¤ºä¾‹","children":[],"id":"æ•°æ®æµåŠ¨ç¤ºä¾‹"}],"id":"q-è¯¦ç»†è§£é‡Š-unet_2d_conditionpy-ä¸­-unet2dconditionmodel-çš„ç»“æ„"},{"key":"q-è¯¦ç»†è§£é‡Šä¸‹é‡‡æ ·å¿«çš„ç»†èŠ‚","href":"#q-è¯¦ç»†è§£é‡Šä¸‹é‡‡æ ·å¿«çš„ç»†èŠ‚","heading":1,"title":"Q: è¯¦ç»†è§£é‡Šä¸‹é‡‡æ ·å¿«çš„ç»†èŠ‚","children":[{"key":"ä¸‹é‡‡æ ·å—æ¦‚è¿°","href":"#ä¸‹é‡‡æ ·å—æ¦‚è¿°","heading":3,"title":"ä¸‹é‡‡æ ·å—æ¦‚è¿°","children":[],"id":"ä¸‹é‡‡æ ·å—æ¦‚è¿°"},{"key":"ä¸‹é‡‡æ ·å—çš„ç»“æ„","href":"#ä¸‹é‡‡æ ·å—çš„ç»“æ„","heading":3,"title":"ä¸‹é‡‡æ ·å—çš„ç»“æ„","children":[{"key":"1-æ®‹å·®å—resnet-block","href":"#1-æ®‹å·®å—resnet-block","heading":4,"title":"1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰","children":[],"id":"1-æ®‹å·®å—resnet-block"},{"key":"2-äº¤å‰æ³¨æ„åŠ›å±‚","href":"#2-äº¤å‰æ³¨æ„åŠ›å±‚","heading":4,"title":"2. äº¤å‰æ³¨æ„åŠ›å±‚","children":[],"id":"2-äº¤å‰æ³¨æ„åŠ›å±‚"},{"key":"3-é™é‡‡æ ·æ“ä½œ","href":"#3-é™é‡‡æ ·æ“ä½œ","heading":4,"title":"3. é™é‡‡æ ·æ“ä½œ","children":[],"id":"3-é™é‡‡æ ·æ“ä½œ"}],"id":"ä¸‹é‡‡æ ·å—çš„ç»“æ„"},{"key":"ä¸‹é‡‡æ ·å—çš„å®Œæ•´å®ç°","href":"#ä¸‹é‡‡æ ·å—çš„å®Œæ•´å®ç°","heading":3,"title":"ä¸‹é‡‡æ ·å—çš„å®Œæ•´å®ç°","children":[],"id":"ä¸‹é‡‡æ ·å—çš„å®Œæ•´å®ç°"},{"key":"æ€»ç»“-3","href":"#æ€»ç»“-3","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-3"}],"id":"q-è¯¦ç»†è§£é‡Šä¸‹é‡‡æ ·å¿«çš„ç»†èŠ‚"},{"key":"q-è¯¦ç»†è®²è§£ä¸Šé‡‡æ ·å—çš„ç»†èŠ‚","href":"#q-è¯¦ç»†è®²è§£ä¸Šé‡‡æ ·å—çš„ç»†èŠ‚","heading":1,"title":"Q: è¯¦ç»†è®²è§£ä¸Šé‡‡æ ·å—çš„ç»†èŠ‚","children":[{"key":"ä¸Šé‡‡æ ·å—æ¦‚è¿°","href":"#ä¸Šé‡‡æ ·å—æ¦‚è¿°","heading":3,"title":"ä¸Šé‡‡æ ·å—æ¦‚è¿°","children":[],"id":"ä¸Šé‡‡æ ·å—æ¦‚è¿°"},{"key":"ä¸Šé‡‡æ ·å—çš„ç»“æ„","href":"#ä¸Šé‡‡æ ·å—çš„ç»“æ„","heading":3,"title":"ä¸Šé‡‡æ ·å—çš„ç»“æ„","children":[{"key":"1-æ®‹å·®å—resnet-block-1","href":"#1-æ®‹å·®å—resnet-block-1","heading":4,"title":"1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰","children":[],"id":"1-æ®‹å·®å—resnet-block-1"},{"key":"2-äº¤å‰æ³¨æ„åŠ›å±‚-1","href":"#2-äº¤å‰æ³¨æ„åŠ›å±‚-1","heading":4,"title":"2. äº¤å‰æ³¨æ„åŠ›å±‚","children":[],"id":"2-äº¤å‰æ³¨æ„åŠ›å±‚-1"},{"key":"3-ä¸Šé‡‡æ ·æ“ä½œ","href":"#3-ä¸Šé‡‡æ ·æ“ä½œ","heading":4,"title":"3. ä¸Šé‡‡æ ·æ“ä½œ","children":[],"id":"3-ä¸Šé‡‡æ ·æ“ä½œ"}],"id":"ä¸Šé‡‡æ ·å—çš„ç»“æ„"},{"key":"ä¸Šé‡‡æ ·å—çš„å®Œæ•´å®ç°","href":"#ä¸Šé‡‡æ ·å—çš„å®Œæ•´å®ç°","heading":3,"title":"ä¸Šé‡‡æ ·å—çš„å®Œæ•´å®ç°","children":[],"id":"ä¸Šé‡‡æ ·å—çš„å®Œæ•´å®ç°"},{"key":"æ€»ç»“-4","href":"#æ€»ç»“-4","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-4"}],"id":"q-è¯¦ç»†è®²è§£ä¸Šé‡‡æ ·å—çš„ç»†èŠ‚"},{"key":"q-è¯¦ç»†è®²è§£ä¸­é—´æ¨¡å—ç»†èŠ‚","href":"#q-è¯¦ç»†è®²è§£ä¸­é—´æ¨¡å—ç»†èŠ‚","heading":1,"title":"Q: è¯¦ç»†è®²è§£ä¸­é—´æ¨¡å—ç»†èŠ‚","children":[{"key":"ä¸­é—´æ¨¡å—æ¦‚è¿°","href":"#ä¸­é—´æ¨¡å—æ¦‚è¿°","heading":3,"title":"ä¸­é—´æ¨¡å—æ¦‚è¿°","children":[],"id":"ä¸­é—´æ¨¡å—æ¦‚è¿°"},{"key":"ä¸­é—´æ¨¡å—çš„ç»“æ„","href":"#ä¸­é—´æ¨¡å—çš„ç»“æ„","heading":3,"title":"ä¸­é—´æ¨¡å—çš„ç»“æ„","children":[{"key":"1-æ®‹å·®å—resnet-block-2","href":"#1-æ®‹å·®å—resnet-block-2","heading":4,"title":"1. æ®‹å·®å—ï¼ˆResNet Blockï¼‰","children":[],"id":"1-æ®‹å·®å—resnet-block-2"},{"key":"2-è‡ªæ³¨æ„åŠ›å±‚","href":"#2-è‡ªæ³¨æ„åŠ›å±‚","heading":4,"title":"2. è‡ªæ³¨æ„åŠ›å±‚","children":[],"id":"2-è‡ªæ³¨æ„åŠ›å±‚"},{"key":"3-äº¤å‰æ³¨æ„åŠ›å±‚","href":"#3-äº¤å‰æ³¨æ„åŠ›å±‚","heading":4,"title":"3. äº¤å‰æ³¨æ„åŠ›å±‚","children":[],"id":"3-äº¤å‰æ³¨æ„åŠ›å±‚"}],"id":"ä¸­é—´æ¨¡å—çš„ç»“æ„"},{"key":"ä¸­é—´æ¨¡å—çš„å®Œæ•´å®ç°","href":"#ä¸­é—´æ¨¡å—çš„å®Œæ•´å®ç°","heading":3,"title":"ä¸­é—´æ¨¡å—çš„å®Œæ•´å®ç°","children":[],"id":"ä¸­é—´æ¨¡å—çš„å®Œæ•´å®ç°"},{"key":"æ€»ç»“-5","href":"#æ€»ç»“-5","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-5"}],"id":"q-è¯¦ç»†è®²è§£ä¸­é—´æ¨¡å—ç»†èŠ‚"},{"key":"q-è¯¦ç»†è®²è§£è¾“å…¥å¤„ç†ä¸è¾“å‡ºå¤„ç†æ¨¡å—ç»†èŠ‚","href":"#q-è¯¦ç»†è®²è§£è¾“å…¥å¤„ç†ä¸è¾“å‡ºå¤„ç†æ¨¡å—ç»†èŠ‚","heading":1,"title":"Q: è¯¦ç»†è®²è§£è¾“å…¥å¤„ç†ä¸è¾“å‡ºå¤„ç†æ¨¡å—ç»†èŠ‚","children":[{"key":"è¾“å…¥å¤„ç†æ¨¡å—","href":"#è¾“å…¥å¤„ç†æ¨¡å—","heading":3,"title":"è¾“å…¥å¤„ç†æ¨¡å—","children":[{"key":"1-è¾“å…¥å·ç§¯å±‚","href":"#1-è¾“å…¥å·ç§¯å±‚","heading":4,"title":"1. è¾“å…¥å·ç§¯å±‚","children":[],"id":"1-è¾“å…¥å·ç§¯å±‚"}],"id":"è¾“å…¥å¤„ç†æ¨¡å—"},{"key":"è¾“å‡ºå¤„ç†æ¨¡å—","href":"#è¾“å‡ºå¤„ç†æ¨¡å—","heading":3,"title":"è¾“å‡ºå¤„ç†æ¨¡å—","children":[{"key":"1-è¾“å‡ºå·ç§¯å±‚","href":"#1-è¾“å‡ºå·ç§¯å±‚","heading":4,"title":"1. è¾“å‡ºå·ç§¯å±‚","children":[],"id":"1-è¾“å‡ºå·ç§¯å±‚"}],"id":"è¾“å‡ºå¤„ç†æ¨¡å—"},{"key":"è¾“å…¥ä¸è¾“å‡ºå¤„ç†çš„å®Œæ•´å®ç°","href":"#è¾“å…¥ä¸è¾“å‡ºå¤„ç†çš„å®Œæ•´å®ç°","heading":3,"title":"è¾“å…¥ä¸è¾“å‡ºå¤„ç†çš„å®Œæ•´å®ç°","children":[],"id":"è¾“å…¥ä¸è¾“å‡ºå¤„ç†çš„å®Œæ•´å®ç°"},{"key":"æ€»ç»“-6","href":"#æ€»ç»“-6","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-6"}],"id":"q-è¯¦ç»†è®²è§£è¾“å…¥å¤„ç†ä¸è¾“å‡ºå¤„ç†æ¨¡å—ç»†èŠ‚"},{"key":"q-è¯¦ç»†è®²è§£æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»†èŠ‚","href":"#q-è¯¦ç»†è®²è§£æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»†èŠ‚","heading":1,"title":"Q: è¯¦ç»†è®²è§£æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»†èŠ‚","children":[{"key":"æ—¶é—´åµŒå…¥ç³»ç»Ÿæ¦‚è¿°","href":"#æ—¶é—´åµŒå…¥ç³»ç»Ÿæ¦‚è¿°","heading":3,"title":"æ—¶é—´åµŒå…¥ç³»ç»Ÿæ¦‚è¿°","children":[],"id":"æ—¶é—´åµŒå…¥ç³»ç»Ÿæ¦‚è¿°"},{"key":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»“æ„","href":"#æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»“æ„","heading":3,"title":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»“æ„","children":[{"key":"1-æ­£å¼¦ä½ç½®ç¼–ç ","href":"#1-æ­£å¼¦ä½ç½®ç¼–ç ","heading":4,"title":"1. æ­£å¼¦ä½ç½®ç¼–ç ","children":[],"id":"1-æ­£å¼¦ä½ç½®ç¼–ç "},{"key":"2-æ—¶é—´åµŒå…¥å±‚","href":"#2-æ—¶é—´åµŒå…¥å±‚","heading":4,"title":"2. æ—¶é—´åµŒå…¥å±‚","children":[],"id":"2-æ—¶é—´åµŒå…¥å±‚"}],"id":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»“æ„"},{"key":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„å®Œæ•´å®ç°","href":"#æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„å®Œæ•´å®ç°","heading":3,"title":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„å®Œæ•´å®ç°","children":[],"id":"æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„å®Œæ•´å®ç°"},{"key":"æ€»ç»“-7","href":"#æ€»ç»“-7","heading":3,"title":"æ€»ç»“","children":[],"id":"æ€»ç»“-7"}],"id":"q-è¯¦ç»†è®²è§£æ—¶é—´åµŒå…¥ç³»ç»Ÿçš„ç»†èŠ‚"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2025-03-06-pytorch-backpropagation-mechanism.md","pagePath":"/learn_from_ai/pytorch-backpropagation-mechanism","slug":"pytorch-backpropagation-mechanism"},"meta":{"content":"\n\u003e æœ¬æ–‡ä¸ºç”¨æˆ·ä¸ DeepSeek çš„é—®ç­”ã€‚ä¸»é¢˜ä¸º PyTorch çš„åå‘ä¼ æ’­æœºåˆ¶ã€‚æœ¬æ–‡ä»æ•°å­¦åŸç†ã€è®¡ç®—å›¾æœºåˆ¶å’Œå®é™…éœ€æ±‚ä¸‰ä¸ªæ–¹é¢æ·±å…¥è§£é‡Šå…¶å·¥ä½œåŸç†ï¼Œå¹¶ç»“åˆ PyTorch çš„è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰ç³»ç»Ÿè¿›è¡Œè¯´æ˜ã€‚\n\n## Q; æ·±å…¥è§£æ PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶\n\n\u003e [!query]\n\u003e\n\u003e æ·±å…¥è§£é‡Š torch ä¸­åå‘ä¼ æ’­æœºåˆ¶çš„æ•°å­¦åŸç†ä¸ä¸ºä½•éœ€è¦åå‘ä¼ æ’­æœºåˆ¶ã€‚æç¤ºï¼šä½ å¯ä»¥ä½¿ç”¨å…¬å¼ã€Mermaid å›¾è¡¨ã€è¡¨æ ¼ç­‰æ–¹å¼ä½¿å†…å®¹æ›´å®¹æ˜“ç†è§£ã€‚\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·è®©æˆ‘æ·±å…¥è§£é‡Š PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶çš„æ•°å­¦åŸç†ä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å®ƒã€‚å¥½çš„ï¼Œæˆ‘å¾—å…ˆå›å¿†ä¸€ä¸‹åå‘ä¼ æ’­çš„åŸºç¡€çŸ¥è¯†ï¼Œç„¶åç»“åˆ PyTorch çš„å…·ä½“å®ç°æ¥å±•å¼€ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œåå‘ä¼ æ’­æ˜¯ç¥ç»ç½‘ç»œè®­ç»ƒçš„æ ¸å¿ƒï¼Œç”¨äºè®¡ç®—æ¢¯åº¦ã€‚ç”¨æˆ·å¯èƒ½å·²ç»äº†è§£æ¢¯åº¦ä¸‹é™ï¼Œä½†éœ€è¦æ›´åº•å±‚çš„æ•°å­¦è§£é‡Šã€‚æˆ‘åº”è¯¥ä»è®¡ç®—å›¾å¼€å§‹ï¼Œå› ä¸º PyTorch ä½¿ç”¨åŠ¨æ€å›¾æœºåˆ¶ã€‚æ¯ä¸ªå¼ é‡çš„è¿ç®—éƒ½ä¼šè®°å½•åœ¨è®¡ç®—å›¾ä¸­ï¼Œè¿™æ ·åœ¨åå‘ä¼ æ’­æ—¶å¯ä»¥è‡ªåŠ¨è®¡ç®—æ¢¯åº¦ã€‚\n\u003e\n\u003e æ•°å­¦åŸç†æ–¹é¢ï¼Œå¾—å…ˆè®²é“¾å¼æ³•åˆ™ã€‚æ¯”å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œy = w*x + bï¼Œç„¶åæŸå¤±å‡½æ•°æ˜¯ L = (y - t)^2ã€‚é‚£ä¹ˆæ±‚ L å¯¹ w çš„æ¢¯åº¦å°±éœ€è¦é“¾å¼æ³•åˆ™ï¼šdL/dw = dL/dy * dy/dwã€‚åå‘ä¼ æ’­çš„è¿‡ç¨‹å°±æ˜¯ä»è¾“å‡ºå±‚å¼€å§‹ï¼Œé€å±‚åº”ç”¨é“¾å¼æ³•åˆ™ï¼Œå°†æ¢¯åº¦ä¼ æ’­å›å„å±‚çš„å‚æ•°ã€‚\n\u003e\n\u003e ç„¶åéœ€è¦è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦åå‘ä¼ æ’­ã€‚æ‰‹åŠ¨è®¡ç®—æ¢¯åº¦åœ¨å¤æ‚ç½‘ç»œä¸­ä¸ç°å®ï¼Œåå‘ä¼ æ’­è‡ªåŠ¨é«˜æ•ˆåœ°è®¡ç®—æ‰€æœ‰å‚æ•°çš„æ¢¯åº¦ï¼ŒèŠ‚çœäº†æ—¶é—´å’Œå‡å°‘é”™è¯¯ã€‚å¯èƒ½è¿˜éœ€è¦æ¯”è¾ƒå‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­çš„è®¡ç®—é‡ï¼Œæ¯”å¦‚åå‘ä¼ æ’­å¦‚ä½•å¤ç”¨å‰å‘çš„ä¸­é—´ç»“æœï¼Œæé«˜æ•ˆç‡ã€‚\n\u003e\n\u003e PyTorch ä¸­çš„ autograd æœºåˆ¶æ˜¯å…³é”®ã€‚æ¯ä¸ª Tensor çš„.grad_fn å±æ€§è®°å½•äº†åˆ›å»ºå®ƒçš„æ“ä½œï¼Œè¿™æ ·åœ¨è°ƒç”¨.backward()æ—¶ï¼Œä¼šæ²¿ç€è¿™äº›å‡½æ•°å½¢æˆçš„è®¡ç®—å›¾åå‘éå†ï¼Œåº”ç”¨é“¾å¼æ³•åˆ™ã€‚éœ€è¦ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚æ„å»ºä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ï¼Œç„¶åå±•ç¤ºæ¢¯åº¦è®¡ç®—çš„è¿‡ç¨‹ã€‚\n\u003e\n\u003e å¯èƒ½ç”¨æˆ·å¯¹è®¡ç®—å›¾çš„å…·ä½“å®ç°ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œæ¯”å¦‚ PyTorch çš„åŠ¨æ€å›¾ç‰¹æ€§ï¼Œæ¯æ¬¡å‰å‘ä¼ æ’­éƒ½ä¼šæ„å»ºæ–°çš„å›¾ï¼Œè¿™æ ·æ›´çµæ´»ã€‚ä½†æ•°å­¦åŸç†è¿˜æ˜¯é“¾å¼æ³•åˆ™ï¼Œä¸ç®¡å›¾çš„ç»“æ„å¦‚ä½•å˜åŒ–ï¼Œæ¢¯åº¦è®¡ç®—çš„æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œå¯èƒ½éœ€è¦æåˆ°ä¸ºä»€ä¹ˆä¸èƒ½åªç”¨æ•°å€¼æ–¹æ³•æ¥è¿‘ä¼¼æ¢¯åº¦ï¼Œæ¯”å¦‚è®¡ç®—èµ„æºçš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯é«˜ç»´å‚æ•°æ—¶ï¼Œæ•°å€¼æ¢¯åº¦è®¡ç®—é‡å¤ªå¤§ã€‚è€Œåå‘ä¼ æ’­é€šè¿‡è§£ææ³•é«˜æ•ˆè®¡ç®—ï¼Œé€‚åˆæ·±åº¦å­¦ä¹ çš„å¤§è§„æ¨¡å‚æ•°ã€‚\n\u003e\n\u003e è¿˜è¦æ³¨æ„è§£é‡Šå¶å­èŠ‚ç‚¹å’Œä¸­é—´èŠ‚ç‚¹çš„æ¢¯åº¦å­˜å‚¨æƒ…å†µï¼ŒPyTorch é»˜è®¤åªä¿ç•™å¶å­èŠ‚ç‚¹çš„æ¢¯åº¦ï¼Œä¸­é—´èŠ‚ç‚¹çš„æ¢¯åº¦ä¼šè¢«é‡Šæ”¾ä»¥èŠ‚çœå†…å­˜ã€‚è¿™å¯èƒ½åœ¨è®­ç»ƒå¤§æ¨¡å‹æ—¶å¾ˆé‡è¦ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦äº†è§£å¦‚ä½•æ§åˆ¶æ¢¯åº¦çš„ä¿ç•™ã€‚\n\u003e\n\u003e æˆ–è®¸ç”¨æˆ·å¯¹åå‘ä¼ æ’­çš„æ•°å­¦æ¨å¯¼æœ‰æ›´æ·±çš„éœ€æ±‚ï¼Œæ¯”å¦‚å¦‚ä½•æ‰©å±•åˆ°å¤šå±‚ç½‘ç»œï¼Œæˆ–è€…å¦‚ä½•å¤„ç†å¤æ‚çš„å±‚ç»“æ„å¦‚å·ç§¯å±‚ã€å¾ªç¯å±‚ã€‚ä½†æ ¹æ®é—®é¢˜ï¼Œå¯èƒ½åªéœ€è¦åŸºç¡€æ•°å­¦ï¼Œæ¯”å¦‚é“¾å¼æ³•åˆ™çš„å¤šæ¬¡åº”ç”¨ï¼Œä»¥åŠå¦‚ä½•ç´¯ç§¯å„å±‚çš„æ¢¯åº¦ã€‚\n\u003e\n\u003e æœ€åï¼Œæ€»ç»“åå‘ä¼ æ’­çš„å¿…è¦æ€§ï¼šè‡ªåŠ¨åŒ–ã€é«˜æ•ˆã€å‡†ç¡®è®¡ç®—æ¢¯åº¦ï¼Œä½¿å¾—è®­ç»ƒæ·±å±‚ç½‘ç»œå¯è¡Œã€‚è€Œ PyTorch çš„è‡ªåŠ¨å¾®åˆ†æœºåˆ¶è®©ç”¨æˆ·æ— éœ€æ‰‹åŠ¨å®ç°è¿™äº›å¤æ‚çš„è®¡ç®—ï¼Œåªéœ€å…³æ³¨æ¨¡å‹ç»“æ„ã€‚\n\u003e\n\u003e å¯èƒ½éœ€è¦ç”¨å…¬å¼æ¥å±•ç¤ºé“¾å¼æ³•åˆ™çš„åº”ç”¨ï¼Œæ¯”å¦‚å¤šå±‚çš„æ¢¯åº¦ç›¸ä¹˜ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä¸‰å±‚çš„ç½‘ç»œï¼Œæ¯ä¸€å±‚çš„æƒé‡æ¢¯åº¦å¦‚ä½•è®¡ç®—ã€‚åŒæ—¶ï¼Œç”¨ Mermaid å›¾å±•ç¤ºè®¡ç®—å›¾çš„ç»“æ„ï¼Œè¯´æ˜å‰å‘å’Œåå‘çš„è·¯å¾„ã€‚\n\u003e\n\u003e è¿˜æœ‰å¯èƒ½è¦è€ƒè™‘æ¿€æ´»å‡½æ•°çš„å¯¼æ•°ï¼Œæ¯”å¦‚ ReLU åœ¨åå‘ä¼ æ’­ä¸­çš„å¤„ç†ï¼Œè¿™æ ·åœ¨è®¡ç®—å›¾ä¸­å¦‚ä½•å¤„ç†ä¸å¯å¯¼ç‚¹ï¼Œä½† PyTorch çš„ autograd ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›ã€‚\n\u003e\n\u003e æ€»ä¹‹ï¼Œæˆ‘éœ€è¦ä»æ•°å­¦åŸç†ï¼ˆé“¾å¼æ³•åˆ™ï¼‰ã€è®¡ç®—å›¾çš„æ¦‚å¿µã€PyTorch çš„å®ç°æœºåˆ¶ï¼ˆåŠ¨æ€å›¾ã€autogradï¼‰ã€ä»¥åŠåå‘ä¼ æ’­çš„å¿…è¦æ€§ï¼ˆé«˜æ•ˆã€è‡ªåŠ¨ï¼‰è¿™å‡ ä¸ªæ–¹é¢æ¥ç»„ç»‡å†…å®¹ï¼Œå¹¶ç”¨å…¬å¼å’Œå›¾è¡¨è¾…åŠ©è¯´æ˜ã€‚\n\u003e\n\u003e æœ€åï¼Œæˆ‘éœ€è¦ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„ç¥ç»ç½‘ç»œï¼Œæ¥å±•ç¤ºåå‘ä¼ æ’­çš„æ•´ä¸ªè¿‡ç¨‹ï¼ŒåŒ…æ‹¬å‰å‘ä¼ æ’­ã€åå‘ä¼ æ’­ã€æ¢¯åº¦è®¡ç®—å’Œå‚æ•°æ›´æ–°ã€‚è¿™æ ·ç”¨æˆ·å¯ä»¥ç›´è§‚åœ°ç†è§£åå‘ä¼ æ’­çš„æ¯ä¸ªæ­¥éª¤ã€‚\n\u003e\n\u003e å¦‚æœç”¨æˆ·å¯¹ PyTorch çš„ä»£ç å®ç°æ„Ÿå…´è¶£ï¼Œæˆ‘ä¹Ÿå¯ä»¥æä¾›ä¸€äº›å…³é”®ä»£ç æ®µçš„è§£æï¼Œæ¯”å¦‚å¦‚ä½•å®šä¹‰è®¡ç®—å›¾ã€å¦‚ä½•è·Ÿè¸ªæ¢¯åº¦ã€å¦‚ä½•æ‰§è¡Œåå‘ä¼ æ’­ç­‰ã€‚\n\u003e\n\u003e æ€»ä¹‹ï¼Œæˆ‘éœ€è¦ç¡®ä¿è§£é‡Šæ¸…æ™°ï¼Œç»“åˆæ•°å­¦åŸç†å’Œä»£ç ç¤ºä¾‹ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£ PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶ã€‚\n\n### æ·±å…¥è§£æ PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶\n\nåå‘ä¼ æ’­ï¼ˆBackpropagationï¼‰æ˜¯ç¥ç»ç½‘ç»œè®­ç»ƒçš„æ ¸å¿ƒç®—æ³•ã€‚æœ¬æ–‡å°†ä»æ•°å­¦åŸç†ã€è®¡ç®—å›¾æœºåˆ¶å’Œå®é™…éœ€æ±‚ä¸‰ä¸ªæ–¹é¢æ·±å…¥è§£é‡Šå…¶å·¥ä½œåŸç†ï¼Œå¹¶ç»“åˆ PyTorch çš„è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰ç³»ç»Ÿè¿›è¡Œè¯´æ˜ã€‚\n\n---\n\n#### ä¸€ã€åå‘ä¼ æ’­çš„æ•°å­¦åŸç†\n\n##### 1. é“¾å¼æ³•åˆ™ï¼ˆChain Ruleï¼‰\n\nåå‘ä¼ æ’­æœ¬è´¨ä¸Šæ˜¯é“¾å¼æ³•åˆ™çš„é«˜æ•ˆå®ç°ã€‚å‡è®¾ç¥ç»ç½‘ç»œçš„è®¡ç®—æµç¨‹ä¸ºï¼š\n\n$$\nL = f(g(h(x)))\n$$\n\nå…¶ä¸­ï¼š\n\n- $$ h(x) = W_1x + b_1 $$\n- $$ g(z) = \\text{ReLU}(z) $$\n- $$ f(y) = \\frac{1}{2}(y - t)^2 $$ ï¼ˆå‡æ–¹è¯¯å·®æŸå¤±ï¼‰\n\nåˆ™æ¢¯åº¦è®¡ç®—ä¸ºï¼š\n\n$$\n\\frac{\\partial L}{\\partial W_1} = \\frac{\\partial L}{\\partial f} \\cdot \\frac{\\partial f}{\\partial g} \\cdot \\frac{\\partial g}{\\partial h} \\cdot \\frac{\\partial h}{\\partial W_1}\n$$\n\n##### 2. æ¢¯åº¦ç´¯ç§¯å…¬å¼\n\nå¯¹äºä»»æ„å‚æ•° $$ \\theta $$ï¼Œæ¢¯åº¦è®¡ç®—å¯è¡¨ç¤ºä¸ºï¼š\n\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\theta} = \\sum_{\\text{path } \\theta \\to \\mathcal{L}} \\left( \\prod_{i} \\frac{\\partial \\text{op}_i}{\\partial \\text{input}_i} \\right)\n$$\n\n---\n\n#### äºŒã€PyTorch çš„å®ç°æœºåˆ¶\n\n##### 1. åŠ¨æ€è®¡ç®—å›¾ï¼ˆDynamic Computation Graphï¼‰\n\nPyTorch åœ¨å‰å‘ä¼ æ’­æ—¶è‡ªåŠ¨æ„å»ºè®¡ç®—å›¾ï¼ŒèŠ‚ç‚¹ä¸ºå¼ é‡ï¼Œè¾¹ä¸ºè¿ç®—æ“ä½œï¼š\n\n```mermaid\ngraph LR\n  x((x)) --\u003e MatMul --\u003e h((h))\n  W1((W1)) --\u003e MatMul\n  b1((b1)) --\u003e Add --\u003e z((z))\n  h --\u003e Add\n  z --\u003e ReLU --\u003e y((y))\n  y --\u003e MSE --\u003e Loss((Loss))\n```\n\n##### 2. Autograd æ ¸å¿ƒç»„ä»¶\n\n| ç»„ä»¶                   | ä½œç”¨                                     |\n| ---------------------- | ---------------------------------------- |\n| `Tensor.requires_grad` | æ ‡è®°éœ€è¦è·Ÿè¸ªæ¢¯åº¦çš„å¼ é‡                   |\n| `Tensor.grad_fn`       | è®°å½•åˆ›å»ºè¯¥å¼ é‡çš„æ“ä½œï¼ˆå¦‚ `MulBackward`ï¼‰ |\n| `Tensor.grad`          | å­˜å‚¨è®¡ç®—å¾—åˆ°çš„æ¢¯åº¦                       |\n\n##### 3. åå‘ä¼ æ’­è¿‡ç¨‹\n\n```python\nimport torch\n\nx = torch.tensor([2.0], requires_grad=True)\nW = torch.tensor([3.0], requires_grad=True)\ny = W * x\ny.backward()\n\nprint(W.grad)  # è¾“å‡º: tensor([2.])\nprint(x.grad)  # è¾“å‡º: tensor([3.])\n```\n\n---\n\n#### ä¸‰ã€ä¸ºä½•éœ€è¦åå‘ä¼ æ’­ï¼Ÿ\n\n##### 1. æ‰‹åŠ¨è®¡ç®—ä¸å¯è¡Œæ€§\n\nå¯¹äºåŒ…å«ç™¾ä¸‡å‚æ•°çš„ç°ä»£ç¥ç»ç½‘ç»œï¼Œæ‰‹åŠ¨è®¡ç®—æ¢¯åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º $$ O(n^2) $$ ï¼Œè€Œåå‘ä¼ æ’­åªéœ€ $$ O(n) $$ ã€‚\n\n##### 2. è®¡ç®—æ•ˆç‡å¯¹æ¯”\n\n| æ–¹æ³•                 | æ—¶é—´å¤æ‚åº¦   | ç©ºé—´å¤æ‚åº¦ | æ•°å€¼ç¨³å®šæ€§ |\n| -------------------- | ------------ | ---------- | ---------- |\n| æ•°å€¼å¾®åˆ†             | $$ O(n^2) $$ | $$ O(1) $$ | å·®         |\n| ç¬¦å·å¾®åˆ†             | $$ O(1) $$   | $$ O(n) $$ | å¥½         |\n| è‡ªåŠ¨å¾®åˆ†ï¼ˆåå‘ä¼ æ’­ï¼‰ | $$ O(n) $$   | $$ O(n) $$ | ä¼˜ç§€       |\n\n##### 3. å†…å­˜ä¼˜åŒ–ç­–ç•¥\n\nPyTorch é‡‡ç”¨ä»¥ä¸‹æŠ€æœ¯é™ä½å†…å­˜å ç”¨ï¼š\n\n- **æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼šåªä¿ç•™å…³é”®èŠ‚ç‚¹çš„ä¸­é—´ç»“æœ\n- **å³æ—¶é‡Šæ”¾ä¸­é—´æ¢¯åº¦**ï¼šé»˜è®¤åªä¿ç•™å¶å­èŠ‚ç‚¹çš„æ¢¯åº¦\n\n---\n\n#### å››ã€åå‘ä¼ æ’­çš„æ•°å­¦æ‰©å±•\n\n##### 1. çŸ©é˜µæ±‚å¯¼ç¤ºä¾‹\n\nå¯¹äºå…¨è¿æ¥å±‚ $$ Y = XW + b $$ ï¼Œæ¢¯åº¦è®¡ç®—ä¸ºï¼š\n\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial W} = X^T \\cdot \\frac{\\partial \\mathcal{L}}{\\partial Y}\n$$\n\n##### 2. å¤æ‚è¿ç®—å¤„ç†\n\n```python\n# PyTorch è‡ªåŠ¨å¤„ç†ä¸å¯å¯¼ç‚¹\nx = torch.tensor([-1.0, 0.0, 2.0], requires_grad=True)\ny = torch.relu(x)\ny.backward(torch.tensor([1.0, 1.0, 1.0]))\nprint(x.grad)  # è¾“å‡º: tensor([0., 0., 1.])\n```\n\n---\n\n#### äº”ã€æ€»ç»“\n\n**åå‘ä¼ æ’­çš„å¿…è¦æ€§**ï¼š\n\n1. **è‡ªåŠ¨å¾®åˆ†**ï¼šé¿å…æ‰‹å·¥æ¨å¯¼å¤æ‚å¯¼æ•°\n2. **è®¡ç®—é«˜æ•ˆ**ï¼šåˆ©ç”¨é“¾å¼æ³•åˆ™çš„åˆ†è§£ç‰¹æ€§\n3. **å†…å­˜ä¼˜åŒ–**ï¼šåŠ¨æ€å›¾çš„å³æ—¶æ„å»ºä¸é”€æ¯\n4. **æ¡†æ¶æ”¯æ’‘**ï¼šæ”¯æŒä»»æ„å¤æ‚ç½‘ç»œç»“æ„\n\nPyTorch é€šè¿‡åŠ¨æ€è®¡ç®—å›¾å’Œ Autograd ç³»ç»Ÿï¼Œå°†åå‘ä¼ æ’­çš„æ•°å­¦åŸç†é«˜æ•ˆå®ç°ï¼Œä½¿å¾—æ·±åº¦å­¦ä¹ æ¨¡å‹çš„è®­ç»ƒå˜å¾—å¯è¡Œä¸”é«˜æ•ˆã€‚ç†è§£è¿™ä¸€æœºåˆ¶å¯¹äºè°ƒè¯•æ¨¡å‹ã€ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œå®ç°è‡ªå®šä¹‰ç®—å­è‡³å…³é‡è¦ã€‚\n\n## Q: å‚æ•°çš„æ¢¯åº¦ç´¯åŠ è®¡ç®—å…¬å¼\n\n\u003e [!query]\n\u003e\n\u003e ä½ æåˆ°å¯¹äºä»»æ„å‚æ•° $$ \\theta $$ï¼Œæ¢¯åº¦è®¡ç®—å¯è¡¨ç¤ºä¸ºï¼š\n\u003e\n\u003e $$\n\u003e \\frac{\\partial \\mathcal{L}}{\\partial \\theta} = \\sum_{\\text{path } \\theta \\to \\mathcal{L}} \\left( \\prod_{i} \\frac{\\partial \\text{op}_i}{\\partial \\text{input}_i} \\right)\n\u003e $$\n\u003e\n\u003e è¿™ä¸ªå…¬å¼æˆ‘æ²¡æ‡‚ï¼Œå†æ·±å…¥è§£é‡Šä¸€ä¸‹ã€‚æˆ‘åªæœ‰æœ¬ç§‘ç¨‹åº¦çš„é«˜ç­‰æ•°å­¦çŸ¥è¯†ä¸çº¿æ€§ä»£æ•°çŸ¥è¯†ï¼Œå»ºè®®ä¸€æ­¥ä¸€æ­¥è§£é‡Šæ¨ç†è¿‡ç¨‹ã€‚\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·é—®çš„æ˜¯å…³äºåå‘ä¼ æ’­ä¸­æ¢¯åº¦è®¡ç®—çš„å…¬å¼ï¼Œé‚£ä¸ªå…¬å¼çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œå¯¹å§ï¼Ÿè®©æˆ‘å…ˆä»”ç»†çœ‹çœ‹ç”¨æˆ·çš„é—®é¢˜ã€‚ä»–æåˆ°ï¼Œå¯¹äºä»»æ„å‚æ•° Î¸ï¼Œæ¢¯åº¦è®¡ç®—æ˜¯è·¯å¾„ Î¸ åˆ° L çš„å’Œï¼Œæ¯ä¸ªè·¯å¾„ä¸­çš„å„ä¸ªæ“ä½œçš„å¯¼æ•°ç›¸ä¹˜ã€‚ç”¨æˆ·æœ¬ç§‘æ•°å­¦å’Œçº¿æ€§ä»£æ•°åŸºç¡€ï¼Œå¯èƒ½éœ€è¦æ›´åŸºç¡€çš„è§£é‡Šã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œæˆ‘éœ€è¦ç¡®è®¤ç”¨æˆ·å¯¹è¿™ä¸ªå…¬å¼çš„ç†è§£ç¨‹åº¦ã€‚å…¬å¼é‡Œçš„æ±‚å’Œç¬¦å·å’Œè·¯å¾„å¯èƒ½è®©ä»–å›°æƒ‘ã€‚å¯èƒ½ç”¨æˆ·å¯¹é“¾å¼æ³•åˆ™æœ‰ä¸€å®šçš„äº†è§£ï¼Œä½†è·¯å¾„çš„æ¦‚å¿µä¸å¤ªæ¸…æ¥šã€‚æ¯”å¦‚ï¼Œåœ¨è®¡ç®—å›¾ä¸­ï¼Œå‚æ•° Î¸ åˆ°æŸå¤± L å¯èƒ½æœ‰å¤šä¸ªä¸åŒçš„è·¯å¾„ï¼Œæ¯ä¸ªè·¯å¾„å¯¹åº”ä¸€ä¸ªæ¢¯åº¦è´¡çŒ®ï¼Œæ‰€ä»¥æ¢¯åº¦æ˜¯è¿™äº›è·¯å¾„è´¡çŒ®çš„æ€»å’Œã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦ç”¨æ›´ç®€å•çš„æ–¹å¼æ¥è§£é‡Šè¿™ä¸ªå…¬å¼ã€‚æˆ–è®¸ç”¨ä¸€ä¸ªå…·ä½“çš„ä¾‹å­æ¥è¯´æ˜ä¼šæ›´å¥½ã€‚æ¯”å¦‚ï¼Œå‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ï¼Œå…¶ä¸­ Î¸ åˆ†ä¸¤ä¸ªè·¯å¾„å½±å“ Lï¼Œæ¯ä¸ªè·¯å¾„éƒ½éœ€è¦è®¡ç®—å¯¼æ•°çš„ä¹˜ç§¯ï¼Œç„¶åå°†å®ƒä»¬ç›¸åŠ ã€‚\n\u003e\n\u003e ç„¶åï¼Œæˆ‘åº”è¯¥åˆ†æ­¥éª¤è§£é‡Šé“¾å¼æ³•åˆ™ï¼Œä»¥åŠä¸ºä»€ä¹ˆéœ€è¦å°†ä¸åŒè·¯å¾„çš„æ¢¯åº¦ç›¸åŠ ã€‚å¯èƒ½éœ€è¦ç”¨å›¾ç¤ºæ¥è¾…åŠ©ï¼Œæ¯”å¦‚ç”»ä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ï¼Œå±•ç¤ºå¤šä¸ªåˆ†æ”¯çš„æƒ…å†µï¼Œæ¯ä¸ªåˆ†æ”¯å¯¹åº”ä¸€ä¸ªä¹˜ç§¯é¡¹ï¼Œæœ€åç›¸åŠ å¾—åˆ°æ€»çš„æ¢¯åº¦ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½å¯¹â€œè·¯å¾„â€è¿™ä¸ªè¯ä¸å¤ªç†è§£ï¼Œéœ€è¦æ˜ç¡®åœ¨è®¡ç®—å›¾ä¸­çš„è·¯å¾„æŒ‡çš„æ˜¯ä»€ä¹ˆã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå‚æ•°å¯èƒ½åœ¨å¤šä¸ªå±‚ä¸­ä½¿ç”¨ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä¸åŒçš„è·¯å¾„åˆ°æŸå¤±å‡½æ•°ï¼Œå› æ­¤æ¯ä¸ªè·¯å¾„çš„æ¢¯åº¦éƒ½éœ€è¦è¢«è®¡ç®—å¹¶ç´¯åŠ ã€‚\n\u003e\n\u003e è¿˜è¦æ³¨æ„ï¼Œç”¨æˆ·å¯èƒ½å¯¹ä¹˜ç§¯çš„éƒ¨åˆ†æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæ˜¯å„ä¸ªæ“ä½œçš„å¯¼æ•°ç›¸ä¹˜ã€‚è¿™æ—¶å€™éœ€è¦å›é¡¾é“¾å¼æ³•åˆ™çš„åŸºæœ¬åŸç†ï¼Œå³å¤åˆå‡½æ•°æ±‚å¯¼æ—¶ï¼Œå¤–å±‚å‡½æ•°çš„å¯¼æ•°å’Œå†…å±‚å‡½æ•°çš„å¯¼æ•°ç›¸ä¹˜ï¼Œè€Œå¦‚æœæœ‰å¤šä¸ªä¸­é—´æ­¥éª¤ï¼Œå°±éœ€è¦è¿ä¹˜è¿™äº›å¯¼æ•°ã€‚\n\u003e\n\u003e å¯èƒ½è¿˜éœ€è¦è§£é‡Šä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ªè·¯å¾„ï¼Œä¾‹å¦‚åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¸€ä¸ªå‚æ•°å¯èƒ½åœ¨å¤šä¸ªç¥ç»å…ƒä¸­è¢«ä½¿ç”¨ï¼Œæˆ–è€…åœ¨ä¸åŒçš„æ—¶é—´æ­¥ï¼ˆå¦‚ RNN ä¸­ï¼‰ï¼Œå¯¼è‡´æ¢¯åº¦éœ€è¦ä»å„ä¸ªè·¯å¾„åå‘ä¼ æ’­å›æ¥ï¼Œç„¶åç´¯åŠ èµ·æ¥ã€‚\n\u003e\n\u003e æœ€åï¼Œé€šè¿‡ä¸€ä¸ªå…·ä½“çš„æ•°å­¦ä¾‹å­ï¼Œé€æ­¥è®¡ç®—æ¯ä¸ªæ­¥éª¤çš„å¯¼æ•°ï¼Œå¹¶å°†å®ƒä»¬ç›¸ä¹˜ï¼Œæœ€åç›¸åŠ ï¼Œæ¥éªŒè¯è¿™ä¸ªå…¬å¼çš„æ­£ç¡®æ€§ã€‚è¿™æ ·ç”¨æˆ·å¯ä»¥é€šè¿‡å®é™…çš„è®¡ç®—è¿‡ç¨‹ç†è§£æŠ½è±¡çš„å…¬å¼ã€‚\n\u003e\n\u003e æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘éœ€è¦ç”¨å…·ä½“çš„ä¾‹å­ã€å›¾ç¤ºï¼Œåˆ†æ­¥éª¤è§£é‡Šé“¾å¼æ³•åˆ™åœ¨è®¡ç®—å›¾ä¸­çš„å¤šä¸ªè·¯å¾„ä¸­çš„åº”ç”¨ï¼Œä»¥åŠæ¢¯åº¦ç´¯åŠ çš„åŸå› ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£è¿™ä¸ªå…¬å¼çš„å«ä¹‰å’Œæ¨å¯¼è¿‡ç¨‹ã€‚\n\nå¥½çš„ï¼æˆ‘å°†ç”¨æœ€ç›´è§‚çš„æ–¹å¼ï¼Œé€šè¿‡ä¸€ä¸ªå…·ä½“ä¾‹å­é€æ­¥è§£é‡Šè¿™ä¸ªå…¬å¼çš„æ•°å­¦åŸç†ã€‚æˆ‘ä»¬ç»“åˆå›¾ç¤ºå’Œåˆ†æ­¥æ¨å¯¼æ¥ç†è§£é“¾å¼æ³•åˆ™åœ¨åå‘ä¼ æ’­ä¸­çš„åº”ç”¨ã€‚\n\n---\n\n### **ä¸€ã€é—®é¢˜åœºæ™¯è®¾å®š**\n\nå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ï¼Œå…¶ä¸­å‚æ•° $$\\theta$$ é€šè¿‡ä¸¤æ¡è·¯å¾„å½±å“æœ€ç»ˆæŸå¤± $$L$$ ï¼š\n\n```mermaid\ngraph LR\n    Î¸((Î¸)) --\u003e Op1 --\u003e A\n    Î¸ --\u003e Op2 --\u003e B\n    A --\u003e Op3 --\u003e L\n    B --\u003e Op3 --\u003e L\n```\n\n- **è·¯å¾„ 1**ï¼š$$\\theta \\xrightarrow{\\text{Op1}} A \\xrightarrow{\\text{Op3}} L$$\n- **è·¯å¾„ 2**ï¼š$$\\theta \\xrightarrow{\\text{Op2}} B \\xrightarrow{\\text{Op3}} L$$\n\nç›®æ ‡æ˜¯è®¡ç®— $$\\frac{\\partial L}{\\partial \\theta}$$ã€‚\n\n---\n\n### **äºŒã€åˆ†æ­¥æ¨å¯¼**\n\n#### **æ­¥éª¤ 1ï¼šå‰å‘ä¼ æ’­è¡¨è¾¾å¼**\n\nå‡è®¾å…·ä½“æ“ä½œä¸ºï¼š\n\n- $$A = \\theta^2$$ ï¼ˆOp1ï¼šå¹³æ–¹æ“ä½œï¼‰\n- $$B = 2\\theta$$ ï¼ˆOp2ï¼šçº¿æ€§æ“ä½œï¼‰\n- $$L = A + B$$ ï¼ˆOp3ï¼šåŠ æ³•æ“ä½œï¼‰\n\nåˆ™æœ€ç»ˆæŸå¤±ä¸ºï¼š\n\n$$\nL = \\theta^2 + 2\\theta\n$$\n\n#### **æ­¥éª¤ 2ï¼šç›´æ¥æ±‚å¯¼ï¼ˆå¯¹æ¯”éªŒè¯ï¼‰**\n\nç›´æ¥å¯¹ $$L$$ æ±‚å¯¼ï¼š\n\n$$\n\\frac{\\partial L}{\\partial \\theta} = 2\\theta + 2\n$$\n\n---\n\n#### **æ­¥éª¤ 3ï¼šåå‘ä¼ æ’­è§†è§’**\n\næ ¹æ®è®¡ç®—å›¾ï¼Œæ¢¯åº¦éœ€è¦æ²¿ç€ä¸¤æ¡è·¯å¾„åå‘ä¼ æ’­ï¼š\n\n##### **è·¯å¾„ 1 çš„æ¢¯åº¦è®¡ç®—ï¼ˆÎ¸ â†’ A â†’ Lï¼‰**\n\n1. $$A = \\theta^2 \\quad \\Rightarrow \\quad \\frac{\\partial A}{\\partial \\theta} = 2\\theta$$\n2. $$L = A + B \\quad \\Rightarrow \\quad \\frac{\\partial L}{\\partial A} = 1$$\n3. è·¯å¾„ 1 çš„æ¢¯åº¦è´¡çŒ®ï¼š\n   $$\n   \\frac{\\partial L}{\\partial \\theta} \\bigg|_{\\text{è·¯å¾„1}} = \\frac{\\partial L}{\\partial A} \\cdot \\frac{\\partial A}{\\partial \\theta} = 1 \\cdot 2\\theta = 2\\theta\n   $$\n\n##### **è·¯å¾„ 2 çš„æ¢¯åº¦è®¡ç®—ï¼ˆÎ¸ â†’ B â†’ Lï¼‰**\n\n1. $$B = 2\\theta \\quad \\Rightarrow \\quad \\frac{\\partial B}{\\partial \\theta} = 2$$\n2. $$L = A + B \\quad \\Rightarrow \\quad \\frac{\\partial L}{\\partial B} = 1$$\n3. è·¯å¾„ 2 çš„æ¢¯åº¦è´¡çŒ®ï¼š\n   $$\n   \\frac{\\partial L}{\\partial \\theta} \\bigg|_{\\text{è·¯å¾„2}} = \\frac{\\partial L}{\\partial B} \\cdot \\frac{\\partial B}{\\partial \\theta} = 1 \\cdot 2 = 2\n   $$\n\n##### **æ€»æ¢¯åº¦ = è·¯å¾„ 1 + è·¯å¾„ 2**\n\n$$\n\\frac{\\partial L}{\\partial \\theta} = 2\\theta + 2\n$$\n\n---\n\n### **ä¸‰ã€é€šç”¨å…¬å¼è§£æ**\n\nåŸå…¬å¼ï¼š\n\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\theta} = \\sum_{\\text{path } \\theta \\to \\mathcal{L}} \\left( \\prod_{i} \\frac{\\partial \\text{op}_i}{\\partial \\text{input}_i} \\right)\n$$\n\n#### **1. ç¬¦å·è§£é‡Š**\n\n- **è·¯å¾„ï¼ˆPathï¼‰**ï¼šå‚æ•° $$\\theta$$ åˆ°æŸå¤± $$\\mathcal{L}$$ çš„æ‰€æœ‰å¯èƒ½æ•°æ®æµåŠ¨è·¯å¾„ã€‚\n- **ä¹˜ç§¯é¡¹ $$\\prod$$**ï¼šæ²¿æŸæ¡è·¯å¾„çš„æ‰€æœ‰æ“ä½œï¼ˆopï¼‰çš„å¯¼æ•°è¿ä¹˜ï¼ˆé“¾å¼æ³•åˆ™ï¼‰ã€‚\n- **æ±‚å’Œé¡¹ $$\\sum$$**ï¼šå°†æ‰€æœ‰è·¯å¾„çš„æ¢¯åº¦è´¡çŒ®ç›¸åŠ ï¼ˆå¤šè·¯å¾„æ—¶æ¢¯åº¦ç´¯åŠ ï¼‰ã€‚\n\n#### **2. å…³é”®æ€§è´¨**\n\n- **é“¾å¼æ³•åˆ™**ï¼šå¤åˆå‡½æ•°çš„å¯¼æ•° = å¤–å±‚å¯¼æ•° Ã— å†…å±‚å¯¼æ•°ã€‚\n- **å¤šè·¯å¾„å åŠ **ï¼šå¦‚æœå‚æ•°å½±å“è¾“å‡ºçš„å¤šä¸ªåˆ†æ”¯ï¼Œæ¢¯åº¦æ˜¯å„åˆ†æ”¯è´¡çŒ®çš„æ€»å’Œã€‚\n\n---\n\n### **å››ã€å¤æ‚æ¡ˆä¾‹éªŒè¯**\n\nè€ƒè™‘ä¸€ä¸ªæ›´å¤æ‚çš„è®¡ç®—å›¾ï¼š\n\n```mermaid\ngraph LR\n    Î¸((Î¸)) --\u003e Op1 --\u003e C\n    Î¸ --\u003e Op2 --\u003e D\n    C --\u003e Op3 --\u003e E\n    D --\u003e Op4 --\u003e E\n    E --\u003e Op5 --\u003e L\n```\n\n#### **å‰å‘ä¼ æ’­è¡¨è¾¾å¼**\n\n- $$C = \\theta^3$$ï¼ˆOp1ï¼‰\n- $$D = \\sin(\\theta)$$ï¼ˆOp2ï¼‰\n- $$E = C \\cdot D$$ï¼ˆOp3ï¼‰\n- $$L = \\ln(E)$$ï¼ˆOp4ï¼‰\n\n#### **åå‘ä¼ æ’­è®¡ç®—**\n\n##### **è·¯å¾„ 1ï¼šÎ¸ â†’ C â†’ E â†’ L**\n\n$$\n\\frac{\\partial L}{\\partial \\theta} \\bigg|_{\\text{è·¯å¾„1}} = \\frac{\\partial L}{\\partial E} \\cdot \\frac{\\partial E}{\\partial C} \\cdot \\frac{\\partial C}{\\partial \\theta} = \\frac{1}{E} \\cdot D \\cdot 3\\theta^2\n$$\n\n##### **è·¯å¾„ 2ï¼šÎ¸ â†’ D â†’ E â†’ L**\n\n$$\n\\frac{\\partial L}{\\partial \\theta} \\bigg|_{\\text{è·¯å¾„2}} = \\frac{\\partial L}{\\partial E} \\cdot \\frac{\\partial E}{\\partial D} \\cdot \\frac{\\partial D}{\\partial \\theta} = \\frac{1}{E} \\cdot C \\cdot \\cos(\\theta)\n$$\n\n##### **æ€»æ¢¯åº¦**\n\n$$\n\\frac{\\partial L}{\\partial \\theta} = \\frac{D \\cdot 3\\theta^2 + C \\cdot \\cos(\\theta)}{E}\n$$\n\n---\n\n### **äº”ã€åå‘ä¼ æ’­çš„æœ¬è´¨**\n\n1. **è‡ªåŠ¨åŒ–çš„é“¾å¼æ³•åˆ™**ï¼šæ¡†æ¶é€šè¿‡è®¡ç®—å›¾è‡ªåŠ¨è¿½è¸ªæ“ä½œè·¯å¾„ã€‚\n2. **æ¢¯åº¦ç´¯åŠ è§„åˆ™**ï¼šå½“ä¸€ä¸ªå‚æ•°å½±å“å¤šä¸ªåˆ†æ”¯æ—¶ï¼Œæ¢¯åº¦æ˜¯æ‰€æœ‰è·¯å¾„è´¡çŒ®çš„æ€»å’Œã€‚\n3. **è®¡ç®—æ•ˆç‡**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ç½‘ç»œæ·±åº¦æˆçº¿æ€§å…³ç³»ï¼ˆ$$O(n)$$ï¼‰ã€‚\n\n---\n\n### **å…­ã€æ€»ç»“**\n\n- **ä¸ºä»€ä¹ˆéœ€è¦æ±‚å’Œï¼ˆ$$\\sum$$ï¼‰**ï¼šå› ä¸ºå‚æ•°å¯èƒ½é€šè¿‡å¤šä¸ªè·¯å¾„å½±å“æŸå¤±ï¼Œæ¯ä¸ªè·¯å¾„è´¡çŒ®ä¸€éƒ¨åˆ†æ¢¯åº¦ã€‚\n- **ä¸ºä»€ä¹ˆéœ€è¦è¿ä¹˜ï¼ˆ$$\\prod$$ï¼‰**ï¼šé“¾å¼æ³•åˆ™è¦æ±‚å°†è·¯å¾„ä¸Šçš„æ‰€æœ‰å±€éƒ¨å¯¼æ•°ç›¸ä¹˜ã€‚\n- **åå‘ä¼ æ’­çš„ä¼˜åŠ¿**ï¼šå°†å¤æ‚çš„å…¨å±€æ±‚å¯¼åˆ†è§£ä¸ºå±€éƒ¨å¯¼æ•°çš„è¿ä¹˜ä¸è·¯å¾„æ±‚å’Œï¼Œå¤§å¹…é™ä½è®¡ç®—å¤æ‚åº¦ã€‚\n\né€šè¿‡è¿™ç§åˆ†è·¯å¾„è®¡ç®—å†ç´¯åŠ çš„æ–¹å¼ï¼Œåå‘ä¼ æ’­å·§å¦™åœ°åˆ©ç”¨è®¡ç®—å›¾çš„ç»“æ„ä¿¡æ¯ï¼Œå®ç°äº†é«˜æ•ˆçš„æ¢¯åº¦è®¡ç®—ã€‚\n\n## Q: ä» PyTorch ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹ PyTorch çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°\n\n\u003e [!query]\n\u003e\n\u003e ä» PyTorch ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹ PyTorch çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°\n\n\u003e [!reasoning]-\n\u003e\n\u003e å—¯ï¼Œç”¨æˆ·ä¹‹å‰å·²ç»äº†è§£äº†åå‘ä¼ æ’­çš„æ•°å­¦åŸç†å’Œä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Œç°åœ¨ä»–ä»¬æƒ³ä» PyTorch ä»£ç å±‚é¢æ·±å…¥ç†è§£åå‘ä¼ æ’­çš„å®ç°ã€‚ç”¨æˆ·å¯èƒ½æœ‰ä¸€å®šçš„ç¼–ç¨‹åŸºç¡€ï¼Œä½†å¯èƒ½å¯¹ PyTorch çš„å†…éƒ¨æœºåˆ¶ä¸å¤ªç†Ÿæ‚‰ã€‚æˆ‘éœ€è¦ç¡®ä¿è§£é‡Šæ¸…æ™°ï¼Œç»“åˆä»£ç ç¤ºä¾‹ï¼ŒåŒæ—¶é¿å…è¿‡äºå¤æ‚çš„æœ¯è¯­ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œç”¨æˆ·æåˆ°äº†ä¹‹å‰çš„å…¬å¼ï¼Œå…³äºæ¢¯åº¦çš„è·¯å¾„æ±‚å’Œï¼Œç°åœ¨éœ€è¦å°†è¿™ä¸€æ•°å­¦æ¦‚å¿µä¸ PyTorch çš„å…·ä½“å®ç°è”ç³»èµ·æ¥ã€‚ä»–ä»¬å¯èƒ½æƒ³çŸ¥é“ PyTorch æ˜¯å¦‚ä½•åŠ¨æ€æ„å»ºè®¡ç®—å›¾çš„ï¼Œå¦‚ä½•è·Ÿè¸ªæ¢¯åº¦ï¼Œä»¥åŠ backward()æ–¹æ³•å…·ä½“åšäº†ä»€ä¹ˆã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œæˆ‘åº”è¯¥åˆ†æ­¥éª¤è§£é‡Š PyTorch çš„å…³é”®ç»„ä»¶ï¼Œæ¯”å¦‚ Tensor çš„ requires_grad å±æ€§ã€grad_fnã€grad å±æ€§ï¼Œä»¥åŠåŠ¨æ€è®¡ç®—å›¾çš„æ„å»ºè¿‡ç¨‹ã€‚éœ€è¦ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„è®¡ç®—å›¾ï¼Œå¹¶å±•ç¤ºæ¢¯åº¦æ˜¯å¦‚ä½•ç´¯ç§¯çš„ã€‚åŒæ—¶ï¼Œç”¨æˆ·å¯èƒ½å¯¹æ¢¯åº¦ç´¯ç§¯å’Œå†…å­˜ç®¡ç†æ„Ÿå…´è¶£ï¼Œæ¯”å¦‚ PyTorch å¦‚ä½•é‡Šæ”¾ä¸­é—´å˜é‡ï¼Œå¦‚ä½•é€šè¿‡ retain_grad()æ¥ä¿ç•™æ¢¯åº¦ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œç”¨æˆ·å¯èƒ½å¯¹å¤šè·¯å¾„æ¢¯åº¦ç´¯åŠ çš„æƒ…å†µæœ‰ç–‘é—®ï¼Œæ¯”å¦‚å½“å¤šä¸ªæ“ä½œå½±å“åŒä¸€ä¸ªå‚æ•°æ—¶ï¼Œæ¢¯åº¦æ˜¯å¦‚ä½•ç›¸åŠ çš„ã€‚è¿™æ—¶å€™éœ€è¦ä¸¾ä¾‹è¯´æ˜ï¼Œæ¯”å¦‚ä¸€ä¸ªå‚æ•°é€šè¿‡ä¸¤æ¡è·¯å¾„å½±å“æŸå¤±å‡½æ•°ï¼ŒPyTorch å¦‚ä½•å¤„ç†è¿™ç§æƒ…å†µã€‚\n\u003e\n\u003e è¿˜éœ€è¦æåˆ° Autograd å¼•æ“çš„å·¥ä½œåŸç†ï¼Œæ¯”å¦‚å¦‚ä½•éå†è®¡ç®—å›¾ï¼Œæ‰§è¡Œåå‘ä¼ æ’­ï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–è®¡ç®—æ•ˆç‡ã€‚å¯èƒ½è¿˜éœ€è¦è®¨è®ºä¸€äº›é«˜çº§è¯é¢˜ï¼Œæ¯”å¦‚ detach()çš„ä½œç”¨ï¼Œæˆ–è€…å¦‚ä½•è‡ªå®šä¹‰åå‘ä¼ æ’­å‡½æ•°ï¼Œä½†æ ¹æ®ç”¨æˆ·çš„çŸ¥è¯†æ°´å¹³ï¼Œå¯èƒ½éœ€è¦ä¿æŒåŸºç¡€ã€‚\n\u003e\n\u003e ç”¨æˆ·å¯èƒ½å­˜åœ¨çš„è¯¯åŒºæ˜¯è®¤ä¸º PyTorch ä¼šä¿å­˜æ‰€æœ‰ä¸­é—´å˜é‡çš„æ¢¯åº¦ï¼Œä½†å®é™…ä¸Šé»˜è®¤åªä¿ç•™å¶å­èŠ‚ç‚¹çš„æ¢¯åº¦ã€‚è¿™éœ€è¦ç‰¹åˆ«è¯´æ˜ï¼Œå¹¶è§£é‡Šå¦‚ä½•é€šè¿‡ retain_grad()æ¥æŸ¥çœ‹ä¸­é—´èŠ‚ç‚¹çš„æ¢¯åº¦ã€‚\n\u003e\n\u003e æœ€åï¼Œåº”è¯¥æ€»ç»“ PyTorch åå‘ä¼ æ’­çš„å…³é”®ç‚¹ï¼Œå¼ºè°ƒå…¶åŠ¨æ€è®¡ç®—å›¾çš„ä¼˜åŠ¿ï¼Œä»¥åŠå¦‚ä½•é«˜æ•ˆç®¡ç†å†…å­˜å’Œè®¡ç®—èµ„æºã€‚ç¡®ä¿ç”¨æˆ·ç†è§£ä¸ºä»€ä¹ˆ PyTorch é€‚åˆåŠ¨æ€å›¾æ¨¡å‹ï¼Œä»¥åŠåœ¨å®é™…è°ƒè¯•ä¸­å¦‚ä½•åˆ©ç”¨è¿™äº›æœºåˆ¶ã€‚\n\nä»¥ä¸‹æ˜¯å…³äº PyTorch åå‘ä¼ æ’­å®ç°æœºåˆ¶çš„ä»£ç çº§æ·±å…¥è§£æï¼Œç»“åˆå…³é”®ä»£ç æ®µå’Œåº•å±‚åŸç†è¯´æ˜ï¼š\n\n---\n\n### **ä¸€ã€PyTorch åå‘ä¼ æ’­çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶**\n\n#### **1. Tensor çš„æ¢¯åº¦è¿½è¸ªæœºåˆ¶**\n\n```python\nimport torch\n\n# åˆ›å»ºéœ€è¦æ¢¯åº¦è¿½è¸ªçš„å¼ é‡\nx = torch.tensor([2.0], requires_grad=True)  # å¶å­èŠ‚ç‚¹\nW = torch.tensor([3.0], requires_grad=True)  # å¶å­èŠ‚ç‚¹\n\n# æ‰§è¡Œè®¡ç®—ï¼ˆè‡ªåŠ¨è®°å½•æ“ä½œï¼‰\ny = W * x           # grad_fn=\u003cMulBackward0\u003e\nz = y + 1           # grad_fn=\u003cAddBackward0\u003e\nloss = z.mean()      # grad_fn=\u003cMeanBackward0\u003e\n\nprint(loss.grad_fn)  # è¾“å‡º: \u003cMeanBackward0 object\u003e\n```\n\n- **`requires_grad=True`**ï¼šæ ‡è®°éœ€è¦è¿½è¸ªæ¢¯åº¦çš„å¼ é‡ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰\n- **`grad_fn`**ï¼šè®°å½•åˆ›å»ºè¯¥å¼ é‡çš„æ“ä½œï¼ˆåå‘ä¼ æ’­æ—¶çŸ¥é“å¦‚ä½•è®¡ç®—æ¢¯åº¦ï¼‰\n\n#### **2. è®¡ç®—å›¾çš„åŠ¨æ€æ„å»º**\n\nPyTorch çš„è®¡ç®—å›¾æ˜¯**åŠ¨æ€æ„å»ºçš„**ï¼Œæ¯æ¬¡å‰å‘ä¼ æ’­éƒ½ä¼šæ–°å»ºä¸€ä¸ªå›¾ï¼š\n\n```python\n# ç¤ºä¾‹ï¼šåŠ¨æ€å›¾ç‰¹æ€§\ndef forward(x):\n    if x.sum() \u003e 0:\n        return x * 2\n    else:\n        return x * (-1)\n\nx = torch.tensor([3.0], requires_grad=True)\nout = forward(x)  # æ ¹æ®è¾“å…¥å€¼åŠ¨æ€åˆ›å»ºä¸åŒçš„è®¡ç®—å›¾\nout.backward()    # è‡ªåŠ¨é€‚åº”ä¸åŒçš„åˆ†æ”¯è·¯å¾„\n```\n\n#### **3. åå‘ä¼ æ’­å¼•æ“ï¼ˆAutograd Engineï¼‰**\n\nå½“è°ƒç”¨ `.backward()` æ—¶ï¼ŒPyTorch ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\n\n```python\nloss.backward()  # è§¦å‘åå‘ä¼ æ’­\n```\n\n- **åå‘éå†è®¡ç®—å›¾**ï¼šä» `loss` çš„ `grad_fn` å¼€å§‹ï¼Œæ²¿ç€ `next_functions` é€’å½’\n- **è®¡ç®—å±€éƒ¨æ¢¯åº¦**ï¼šåœ¨æ¯ä¸ªæ“ä½œèŠ‚ç‚¹è°ƒç”¨å·²æ³¨å†Œçš„ `backward()` æ–¹æ³•\n- **æ¢¯åº¦ç´¯åŠ **ï¼šå°†è®¡ç®—ç»“æœç´¯ç§¯åˆ°å¯¹åº”å¼ é‡çš„ `.grad` å±æ€§ä¸­\n\n---\n\n### **äºŒã€ä»£ç çº§åå‘ä¼ æ’­æµç¨‹åˆ†è§£**\n\n#### **æ­¥éª¤ 1ï¼šå‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾**\n\n```python\na = torch.tensor(2.0, requires_grad=True)\nb = torch.tensor(3.0, requires_grad=True)\nc = a * b      # grad_fn=\u003cMulBackward0\u003e\nd = c + 1      # grad_fn=\u003cAddBackward0\u003e\nloss = d**2    # grad_fn=\u003cPowBackward0\u003e\n```\n\næ­¤æ—¶çš„è®¡ç®—å›¾ç»“æ„ï¼š\n\n```mermaid\ngraph LR\n  a --\u003e Mul --\u003e c\n  b --\u003e Mul\n  c --\u003e Add --\u003e d\n  d --\u003e Pow --\u003e loss\n```\n\n#### **æ­¥éª¤ 2ï¼šæ‰§è¡Œåå‘ä¼ æ’­**\n\n```python\nloss.backward()  # è§¦å‘åå‘ä¼ æ’­\n```\n\n##### **åº•å±‚æ“ä½œåˆ†è§£**ï¼š\n\n1. **åˆå§‹åŒ–æ¢¯åº¦**ï¼šè®¾ç½® `loss.grad = 1.0`ï¼ˆæ ‡é‡æŸå¤±çš„é»˜è®¤æ¢¯åº¦ï¼‰\n2. **åå‘ä¼ æ’­åˆ° d**ï¼š\n   - è°ƒç”¨ `PowBackward0` çš„ `backward()` æ–¹æ³•ï¼š\n     ```python\n     d_grad = 2 * d  # å¯¼æ•°å…¬å¼ï¼šd(loss)/d(d) = 2d\n     ```\n3. **åå‘ä¼ æ’­åˆ° c**ï¼š\n   - è°ƒç”¨ `AddBackward0` çš„ `backward()` æ–¹æ³•ï¼š\n     ```python\n     c_grad = d_grad * 1  # åŠ æ³•æ“ä½œçš„å¯¼æ•°ä¸º1\n     ```\n4. **åå‘ä¼ æ’­åˆ° a å’Œ b**ï¼š\n   - è°ƒç”¨ `MulBackward0` çš„ `backward()` æ–¹æ³•ï¼š\n     ```python\n     a_grad = c_grad * b  # å¯¼æ•°å…¬å¼ï¼šd(c)/d(a) = b\n     b_grad = c_grad * a  # å¯¼æ•°å…¬å¼ï¼šd(c)/d(b) = a\n     ```\n5. **æ¢¯åº¦ç´¯åŠ **ï¼š\n   ```python\n   a.grad += a_grad  # å®é™…ä¸º in-place æ“ä½œ\n   b.grad += b_grad\n   ```\n\n#### **æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç»“æœ**\n\n```python\nprint(a.grad)  # è¾“å‡º: 2*d* b = 2*(2*3+1)*3 = 42\nprint(b.grad)  # è¾“å‡º: 2*d* a = 2*(2*3+1)*2 = 28\n```\n\n---\n\n### **ä¸‰ã€PyTorch åå‘ä¼ æ’­çš„å…³é”®å®ç°ç»†èŠ‚**\n\n#### **1. æ¢¯åº¦è®¡ç®—è§„åˆ™æ³¨å†Œ**\n\næ¯ä¸ª `torch` æ“ä½œéƒ½æœ‰é¢„å®šä¹‰çš„æ¢¯åº¦è®¡ç®—è§„åˆ™ï¼š\n\n```python\n# ç¤ºä¾‹ï¼šè‡ªå®šä¹‰æ“ä½œçš„æ¢¯åº¦è§„åˆ™\nclass MyAdd(torch.autograd.Function):\n    @staticmethod\n    def forward(ctx, x, y):\n        ctx.save_for_backward(x, y)  # ä¿å­˜å‰å‘ä¼ æ’­çš„è¾“å…¥\n        return x + y\n\n    @staticmethod\n    def backward(ctx, grad_output):\n        x, y = ctx.saved_tensors\n        return grad_output * 1, grad_output * 1  # åŠ æ³•æ“ä½œçš„å¯¼æ•°\n\n# ä½¿ç”¨è‡ªå®šä¹‰æ“ä½œ\na = torch.tensor(2.0, requires_grad=True)\nb = torch.tensor(3.0, requires_grad=True)\nc = MyAdd.apply(a, b)\nc.backward()\n```\n\n#### **2. æ¢¯åº¦ç´¯åŠ æœºåˆ¶**\n\nPyTorch é»˜è®¤ä¼š**ç´¯åŠ æ¢¯åº¦**ï¼Œå› æ­¤æ¯æ¬¡åå‘ä¼ æ’­å‰éœ€è¦æ‰‹åŠ¨æ¸…é›¶ï¼š\n\n```python\noptimizer.zero_grad()  # æ ‡å‡†è®­ç»ƒå¾ªç¯ä¸­çš„å¿…è¦æ“ä½œ\nloss.backward()        # æ¢¯åº¦ä¼šç´¯åŠ åˆ° .grad å±æ€§ä¸­\noptimizer.step()\n```\n\n#### **3. éæ ‡é‡å¼ é‡çš„åå‘ä¼ æ’­**\n\nå½“è¾“å‡ºä¸ºéæ ‡é‡æ—¶ï¼Œéœ€è¦æä¾› `gradient` å‚æ•°ï¼š\n\n```python\nx = torch.tensor([1.0, 2.0], requires_grad=True)\ny = x * 2\n\n# å‡è®¾ y æ˜¯å‘é‡ï¼Œéœ€è¦æä¾›æ¢¯åº¦åˆå§‹å€¼\ny.backward(gradient=torch.tensor([0.1, 0.2]))\nprint(x.grad)  # è¾“å‡º: tensor([0.2, 0.4])\n```\n\n#### **4. å†…å­˜ä¼˜åŒ–ç­–ç•¥**\n\n- **ä¸­é—´å˜é‡é‡Šæ”¾**ï¼šé»˜è®¤åªä¿ç•™å¶å­èŠ‚ç‚¹çš„æ¢¯åº¦\n- **æ¢¯åº¦æ£€æŸ¥ç‚¹**ï¼šé€šè¿‡ `torch.utils.checkpoint` å‡å°‘å†…å­˜å ç”¨\n- **ç¦ç”¨æ¢¯åº¦è®¡ç®—**ï¼šä½¿ç”¨ `with torch.no_grad():` æˆ– `@torch.inference_mode()`\n\n---\n\n### **å››ã€å¯è§†åŒ–åå‘ä¼ æ’­è¿‡ç¨‹**\n\n#### **ç¤ºä¾‹ä»£ç **\n\n```python\nimport torchviz\n\na = torch.tensor(3.0, requires_grad=True)\nb = torch.tensor(4.0, requires_grad=True)\nc = a * b\nd = c.sin()\nd.backward()\n\n# ç”Ÿæˆè®¡ç®—å›¾å¯è§†åŒ–\ntorchviz.make_dot(d, params={'a':a, 'b':b}).render(\"graph\")\n```\n\n#### **ç”Ÿæˆçš„è®¡ç®—å›¾ç»“æ„**\n\n```mermaid\ngraph LR\n  a((a)) --\u003e Mul --\u003e c\n  b((b)) --\u003e Mul\n  c --\u003e Sin --\u003e d((d))\n  d --\u003e Backward\n```\n\n---\n\n### **äº”ã€PyTorch åå‘ä¼ æ’­çš„æ€§èƒ½ä¼˜åŒ–**\n\n#### **1. å¼‚æ­¥æ‰§è¡Œ**\n\n```python\n# ä½¿ç”¨ CUDA æµå®ç°å¼‚æ­¥è®¡ç®—\nwith torch.cuda.stream(torch.cuda.Stream()):\n    loss.backward()  # åœ¨éé»˜è®¤æµä¸­æ‰§è¡Œåå‘ä¼ æ’­\n```\n\n#### **2. æ··åˆç²¾åº¦è®­ç»ƒ**\n\n```python\nscaler = torch.cuda.amp.GradScaler()\n\nwith torch.cuda.amp.autocast():\n    output = model(input)\n    loss = loss_fn(output, target)\n\nscaler.scale(loss).backward()  # è‡ªåŠ¨ç¼©æ”¾æ¢¯åº¦\nscaler.step(optimizer)\nscaler.update()\n```\n\n#### **3. æ¢¯åº¦è£å‰ª**\n\n```python\ntorch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=1.0)\n```\n\n---\n\n### **å…­ã€è°ƒè¯•æŠ€å·§**\n\n#### **1. æ£€æŸ¥æ¢¯åº¦æ˜¯å¦å­˜åœ¨**\n\n```python\nprint([p.requires_grad for p in model.parameters()])  # æ£€æŸ¥å‚æ•°æ˜¯å¦å¯ç”¨æ¢¯åº¦\n```\n\n#### **2. æ¢¯åº¦æ•°å€¼æ£€æŸ¥**\n\n```python\nfor name, param in model.named_parameters():\n    if param.grad is not None:\n        print(f\"{name} æ¢¯åº¦å‡å€¼: {param.grad.mean().item()}\")\n```\n\n#### **3. ä¿ç•™ä¸­é—´æ¢¯åº¦**\n\n```python\ny = x * 2\ny.retain_grad()  # å¼ºåˆ¶ä¿ç•™ä¸­é—´å˜é‡çš„æ¢¯åº¦\ny.backward()\nprint(y.grad)    # å¯ä»¥æŸ¥çœ‹ä¸­é—´æ¢¯åº¦\n```\n\n---\n\n### **ä¸ƒã€åº•å±‚å®ç°åŸç†**\n\n#### **1. C++ æ ¸å¿ƒå¼•æ“**\n\nPyTorch çš„åå‘ä¼ æ’­å¼•æ“ä¸»è¦ç”±ä»¥ä¸‹ C++ ç»„ä»¶æ„æˆï¼š\n\n- **`torch::autograd::Engine`**ï¼šç®¡ç†åå‘ä¼ æ’­ä»»åŠ¡çš„æ‰§è¡Œ\n- **`torch::autograd::Node`**ï¼šè¡¨ç¤ºè®¡ç®—å›¾ä¸­çš„æ“ä½œèŠ‚ç‚¹\n- **`torch::autograd::Edge`**ï¼šè¡¨ç¤ºèŠ‚ç‚¹ä¹‹é—´çš„è¿æ¥å…³ç³»\n\n#### **2. åå‘ä¼ æ’­ä»»åŠ¡è°ƒåº¦**\n\n```cpp\n// ä¼ªä»£ç ï¼šå¼•æ“æ‰§è¡Œæµç¨‹\nvoid Engine::execute(const EdgeList\u0026 roots) {\n    // 1. æ„å»ºä»»åŠ¡é˜Ÿåˆ—\n    // 2. ä½¿ç”¨çº¿ç¨‹æ± å¹¶è¡Œæ‰§è¡Œåå‘ä»»åŠ¡\n    // 3. å¤„ç†ä¾èµ–å…³ç³»ï¼ˆæ‹“æ‰‘æ’åºï¼‰\n    // 4. è°ƒç”¨æ¯ä¸ª Node çš„ apply() æ–¹æ³•\n}\n```\n\n---\n\n### **å…«ã€æ€»ç»“ï¼šPyTorch åå‘ä¼ æ’­çš„è®¾è®¡å“²å­¦**\n\n1. **åŠ¨æ€è®¡ç®—å›¾**ï¼šå³æ—¶æ„å»ºã€å³æ—¶é”€æ¯ï¼Œçµæ´»é€‚åº”å¯å˜ç½‘ç»œç»“æ„\n2. **å»¶è¿Ÿè®¡ç®—**ï¼šåªåœ¨éœ€è¦æ—¶æ‰§è¡Œæ¢¯åº¦è®¡ç®—ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨\n3. **åˆ†ç¦»å¼è®¾è®¡**ï¼šå‰å‘ä¼ æ’­è®°å½•æ“ä½œï¼Œåå‘ä¼ æ’­æ—¶æ‰§è¡Œå®é™…è®¡ç®—\n4. **å¯æ‰©å±•æ€§**ï¼šé€šè¿‡æ³¨å†Œè‡ªå®šä¹‰ Function æ”¯æŒä»»æ„å¤æ‚æ“ä½œ\n\nç†è§£è¿™äº›åº•å±‚æœºåˆ¶ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…ï¼š\n\n- æ›´é«˜æ•ˆåœ°è°ƒè¯•æ¢¯åº¦ç›¸å…³é—®é¢˜\n- åˆç†æ§åˆ¶å†…å­˜ä½¿ç”¨ï¼ˆå¦‚ä½¿ç”¨ `detach()` æˆªæ–­è®¡ç®—å›¾ï¼‰\n- å®ç°è‡ªå®šä¹‰ç¥ç»ç½‘ç»œå±‚å’ŒæŸå¤±å‡½æ•°\n- ä¼˜åŒ–è®­ç»ƒè¿‡ç¨‹çš„æ€§èƒ½\n\n## Q: æ·±å…¥è®²è§£å‡ ç§å¾®åˆ†æ–¹æ³•çš„å¤æ‚åº¦ä¸æ•°å€¼ç¨³å®šæ€§\n\n\u003e [!query]\n\u003e\n\u003e ä½ ä¹‹å‰æåˆ°æ•°å€¼å¾®åˆ†ã€ç¬¦å·å¾®åˆ†ã€è‡ªåŠ¨å¾®åˆ†çš„æ—¶é—´ç©ºé—´å¤æ‚åº¦ä»¥åŠæ•°å€¼ç¨³å®šæ€§çš„å¯¹æ¯”ã€‚è¿™äº›å¤æ‚åº¦æ˜¯å¦‚ä½•è®¡ç®—å‡ºçš„ç»“æœï¼Ÿæ•°å€¼ç¨³å®šæ€§åˆå¦‚ä½•è¯„ä¼°ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e\n\u003e å¥½çš„ï¼Œæˆ‘ç°åœ¨éœ€è¦ä»”ç»†ç†è§£ç”¨æˆ·çš„é—®é¢˜ã€‚ç”¨æˆ·ä¹‹å‰è¯¢é—®äº† PyTorch çš„åå‘ä¼ æ’­æœºåˆ¶ï¼Œç°åœ¨é’ˆå¯¹æ•°å€¼å¾®åˆ†ã€ç¬¦å·å¾®åˆ†å’Œè‡ªåŠ¨å¾®åˆ†çš„æ—¶é—´ç©ºé—´å¤æ‚åº¦ä»¥åŠæ•°å€¼ç¨³å®šæ€§å¯¹æ¯”æå‡ºç–‘é—®ï¼Œæƒ³çŸ¥é“è¿™äº›å¤æ‚åº¦æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Œä»¥åŠæ•°å€¼ç¨³å®šæ€§å¦‚ä½•è¯„ä¼°ã€‚ç”¨æˆ·å¯èƒ½åœ¨å­¦ä¹ è¿™äº›å¾®åˆ†æ–¹æ³•æ—¶ï¼Œå¯¹èƒŒåçš„æ•°å­¦åŸç†å’Œè¯„ä¼°æ–¹æ³•æ„Ÿåˆ°å›°æƒ‘ï¼Œéœ€è¦æ›´æ·±å…¥çš„è§£é‡Šã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œæˆ‘éœ€è¦å›å¿†æ•°å€¼å¾®åˆ†ã€ç¬¦å·å¾®åˆ†å’Œè‡ªåŠ¨å¾®åˆ†çš„åŸºæœ¬æ¦‚å¿µã€‚æ•°å€¼å¾®åˆ†æ˜¯é€šè¿‡æœ‰é™å·®åˆ†è¿‘ä¼¼å¯¼æ•°ï¼Œç¬¦å·å¾®åˆ†æ˜¯é€šè¿‡ä»£æ•°è§„åˆ™æ±‚å¯¼è¡¨è¾¾å¼ï¼Œè‡ªåŠ¨å¾®åˆ†ï¼ˆå¦‚åå‘ä¼ æ’­ï¼‰åˆ™æ˜¯é€šè¿‡åˆ†è§£è®¡ç®—è¿‡ç¨‹ï¼Œåˆ©ç”¨é“¾å¼æ³•åˆ™é«˜æ•ˆè®¡ç®—æ¢¯åº¦ã€‚ç”¨æˆ·å·²ç»çŸ¥é“å®ƒä»¬çš„å¤æ‚åº¦å¯¹æ¯”è¡¨æ ¼ï¼Œä½†éœ€è¦äº†è§£è¿™äº›å¤æ‚åº¦æ˜¯å¦‚ä½•å¾—å‡ºçš„ï¼Œä»¥åŠæ•°å€¼ç¨³å®šæ€§çš„è¯„ä¼°æ–¹æ³•ã€‚\n\u003e\n\u003e æ¥ä¸‹æ¥ï¼Œæ—¶é—´å¤æ‚åº¦çš„è®¡ç®—ã€‚å¯¹äºæ•°å€¼å¾®åˆ†ï¼Œå‡è®¾æœ‰ n ä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°éƒ½éœ€è¦å•ç‹¬è®¡ç®—æ¢¯åº¦ï¼Œæ¯æ¬¡è®¡ç®—éœ€è¦ä¸¤æ¬¡å‰å‘ä¼ æ’­ï¼ˆf(x+h)å’Œ f(x-h)ï¼‰ï¼Œæ‰€ä»¥æ€»çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)çš„å‰å‘è®¡ç®—ä¹˜ä»¥ n ä¸ªå‚æ•°ï¼Œå¾—åˆ° O(n^2)ã€‚è€Œè‡ªåŠ¨å¾®åˆ†åªéœ€è¦ä¸€æ¬¡å‰å‘å’Œä¸€æ¬¡åå‘ä¼ æ’­ï¼Œåå‘ä¼ æ’­çš„æ—¶é—´å¤æ‚åº¦ä¸å‰å‘ç›¸å½“ï¼Œæ‰€ä»¥æ€»çš„æ˜¯ O(n)ã€‚ç¬¦å·å¾®åˆ†åˆ™å¯èƒ½å› ä¸ºè¡¨è¾¾å¼è†¨èƒ€å¯¼è‡´æœ€åæƒ…å†µæŒ‡æ•°çº§å¤æ‚åº¦ï¼Œä½†é€šå¸¸æƒ…å†µæ˜¯çº¿æ€§çš„ï¼Œä½†éœ€è¦å­˜å‚¨æ•´ä¸ªè¡¨è¾¾å¼ï¼Œç©ºé—´å¤æ‚åº¦é«˜ã€‚è¿™äº›éœ€è¦è¯¦ç»†è§£é‡Šã€‚\n\u003e\n\u003e ç©ºé—´å¤æ‚åº¦æ–¹é¢ï¼Œæ•°å€¼å¾®åˆ†ä¸éœ€è¦å­˜å‚¨ä¸­é—´å˜é‡ï¼Œæ‰€ä»¥æ˜¯ O(1)ã€‚è‡ªåŠ¨å¾®åˆ†éœ€è¦å­˜å‚¨è®¡ç®—å›¾ä¸­çš„ä¸­é—´ç»“æœï¼Œæ‰€ä»¥æ˜¯ O(n)ã€‚ç¬¦å·å¾®åˆ†éœ€è¦å­˜å‚¨æ•´ä¸ªç¬¦å·è¡¨è¾¾å¼ï¼Œå¯èƒ½éšç€æ±‚å¯¼æ¬¡æ•°å¢åŠ è€Œè†¨èƒ€ï¼Œæ‰€ä»¥ç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ã€‚è¿™é‡Œå¯èƒ½éœ€è¦æ›´å…·ä½“çš„ä¾‹å­è¯´æ˜ã€‚\n\u003e\n\u003e æ•°å€¼ç¨³å®šæ€§æ–¹é¢ï¼Œæ•°å€¼å¾®åˆ†å› ä¸ºä½¿ç”¨äº†æœ‰é™å·®åˆ†ï¼Œå®¹æ˜“å—åˆ°èˆå…¥è¯¯å·®å½±å“ï¼Œå°¤å…¶æ˜¯å½“ h å¾ˆå°æ—¶ã€‚ç¬¦å·å¾®åˆ†å› ä¸ºæ˜¯ç²¾ç¡®æ±‚å¯¼ï¼Œç¨³å®šæ€§å¥½ã€‚è‡ªåŠ¨å¾®åˆ†é€šè¿‡é“¾å¼æ³•åˆ™è®¡ç®—ï¼Œç²¾åº¦ä¸æ•°å­¦æ¨å¯¼ç›¸åŒï¼Œæ‰€ä»¥ç¨³å®šæ€§ä¼˜ç§€ã€‚éœ€è¦è§£é‡Šä¸ºä»€ä¹ˆä¸åŒæ–¹æ³•ä¼šæœ‰ä¸åŒçš„ç¨³å®šæ€§ï¼Œæ¯”å¦‚èˆå…¥è¯¯å·®å’Œè¡¨è¾¾å¼è†¨èƒ€çš„å½±å“ã€‚\n\u003e\n\u003e ç”¨æˆ·å¯èƒ½æ²¡æœ‰å®Œå…¨ç†è§£è¿™äº›å¤æ‚åº¦æ˜¯å¦‚ä½•æ¨å¯¼å‡ºæ¥çš„ï¼Œæ¯”å¦‚ä¸ºä»€ä¹ˆè‡ªåŠ¨å¾®åˆ†çš„æ—¶é—´æ˜¯çº¿æ€§çš„ï¼Œæˆ–è€…ç¬¦å·å¾®åˆ†çš„ç©ºé—´å¤æ‚åº¦å¦‚ä½•ã€‚éœ€è¦åˆ†æ­¥éª¤è§£é‡Šï¼Œå¯èƒ½ç”¨å…·ä½“çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸€ä¸ªæœ‰ n ä¸ªå‚æ•°çš„å‡½æ•°ï¼Œå¦‚ä½•è®¡ç®—æ¯ç§æ–¹æ³•æ‰€éœ€çš„æ­¥éª¤æ•°ï¼Œä»è€Œå¾—å‡ºæ—¶é—´å¤æ‚åº¦ã€‚\n\u003e\n\u003e æ­¤å¤–ï¼Œç”¨æˆ·å¯èƒ½å¯¹æ•°å€¼ç¨³å®šæ€§çš„è¯„ä¼°æ–¹æ³•ä¸æ¸…æ¥šã€‚éœ€è¦è§£é‡Šæ•°å€¼ç¨³å®šæ€§é€šå¸¸é€šè¿‡è¯¯å·®åˆ†æï¼Œæ¯”å¦‚èˆå…¥è¯¯å·®å’Œæˆªæ–­è¯¯å·®çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œæ•°å€¼å¾®åˆ†çš„è¯¯å·®æ¥æºåŒ…æ‹¬é€‰æ‹© h çš„å¤§å°ï¼Œè¿‡å¤§ä¼šå¯¼è‡´æˆªæ–­è¯¯å·®ï¼Œè¿‡å°å¯¼è‡´èˆå…¥è¯¯å·®ã€‚è€Œç¬¦å·å¾®åˆ†æ²¡æœ‰æ•°å€¼è¯¯å·®ï¼Œè‡ªåŠ¨å¾®åˆ†åˆ™å› ä¸ºä½¿ç”¨æµ®ç‚¹è¿ç®—å¯èƒ½æœ‰èˆå…¥è¯¯å·®ï¼Œä½†ç›¸å¯¹äºæ•°å€¼å¾®åˆ†æ›´ç¨³å®šã€‚\n\u003e\n\u003e éœ€è¦æ³¨æ„ç”¨æˆ·çš„æ•°å­¦èƒŒæ™¯æ˜¯æœ¬ç§‘é«˜ç­‰æ•°å­¦å’Œçº¿æ€§ä»£æ•°ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä»–ä»¬èƒ½ç†è§£çš„è¯­è¨€ï¼Œé¿å…è¿‡äºå¤æ‚çš„æ•°å­¦æ¨å¯¼ï¼Œä½†åˆè¦è¶³å¤Ÿä¸¥è°¨ã€‚å¯èƒ½éœ€è¦ä½¿ç”¨å…·ä½“çš„ä¾‹å­ï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œæ¯”è¾ƒä¸‰ç§æ–¹æ³•åœ¨è®¡ç®—æ¢¯åº¦æ—¶çš„æ­¥éª¤ï¼Œä»è€Œè¯´æ˜æ—¶é—´å¤æ‚åº¦çš„å·®å¼‚ã€‚\n\u003e\n\u003e ä¾‹å¦‚ï¼Œè€ƒè™‘å‡½æ•° f(w)=w1*x1 + w2*x2 + ... + wn\\*xnï¼Œæœ‰ n ä¸ªå‚æ•° w1 åˆ° wnã€‚æ•°å€¼å¾®åˆ†éœ€è¦å¯¹æ¯ä¸ª wi è®¡ç®—ä¸¤æ¬¡ f çš„å€¼ï¼Œæ‰€ä»¥æ€»è®¡ç®—æ¬¡æ•°æ˜¯ 2n æ¬¡ï¼Œæ¯æ¬¡è®¡ç®—éœ€è¦ O(n)æ—¶é—´ï¼ˆå› ä¸ºè®¡ç®—ç‚¹ç§¯ï¼‰ï¼Œæ‰€ä»¥æ€»æ—¶é—´å¤æ‚åº¦æ˜¯ O(n^2)ã€‚è‡ªåŠ¨å¾®åˆ†åˆ™è®¡ç®—ä¸€æ¬¡å‰å‘ä¼ æ’­ï¼ˆO(n)æ—¶é—´ï¼‰ï¼Œåå‘ä¼ æ’­æ¯ä¸ªèŠ‚ç‚¹çš„æ¢¯åº¦è®¡ç®—æ˜¯ O(1)ï¼Œn ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æ€»æ—¶é—´æ˜¯ O(n)ã€‚ç¬¦å·å¾®åˆ†åˆ™ç”Ÿæˆå¯¼æ•°è¡¨è¾¾å¼ï¼Œå¯èƒ½æœ‰ n é¡¹ï¼Œæ¯ä¸ªé¡¹æ˜¯ xiï¼Œæ‰€ä»¥å¯¼æ•°æ˜¯ xiï¼Œå­˜å‚¨è¿™äº›éœ€è¦ O(n)ç©ºé—´ï¼Œä½†å¦‚æœæ˜¯æ›´å¤æ‚çš„å‡½æ•°ï¼Œæ¯”å¦‚å¤šå±‚å¤åˆå‡½æ•°ï¼Œç¬¦å·è¡¨è¾¾å¼å¯èƒ½è†¨èƒ€ï¼Œå¯¼è‡´ç©ºé—´å¢åŠ ã€‚\n\u003e\n\u003e åœ¨æ•°å€¼ç¨³å®šæ€§æ–¹é¢ï¼Œæ¯”å¦‚ç”¨æ•°å€¼å¾®åˆ†è®¡ç®— f(w)=sin(w)ï¼Œå½“ w å¾ˆå¤§æ—¶ï¼Œè®¡ç®—å¯¼æ•°æ—¶çš„å°å˜åŒ–å¯èƒ½å¯¼è‡´è¾ƒå¤§çš„èˆå…¥è¯¯å·®ã€‚è€Œè‡ªåŠ¨å¾®åˆ†ç›´æ¥è®¡ç®— cos(w)ï¼Œæ²¡æœ‰è¿™ç§è¯¯å·®ã€‚\n\u003e\n\u003e æ€»ç»“ï¼Œç”¨æˆ·éœ€è¦åˆ†æ­¥éª¤çš„å¤æ‚åº¦æ¨å¯¼è¿‡ç¨‹å’Œæ•°å€¼ç¨³å®šæ€§çš„è¯„ä¼°æ–¹æ³•ï¼Œç»“åˆå…·ä½“ä¾‹å­å’Œæ•°å­¦è§£é‡Šï¼Œç¡®ä¿ä»–ä»¬èƒ½ç†è§£ä¸ºä»€ä¹ˆä¸åŒæ–¹æ³•æœ‰ä¸åŒçš„å¤æ‚åº¦å’Œç¨³å®šæ€§ã€‚åŒæ—¶ï¼Œå¯èƒ½éœ€è¦æŒ‡å‡ºè¿™äº›å¤æ‚åº¦æ˜¯ç†è®ºä¸Šçš„æœ€åæƒ…å†µè¿˜æ˜¯å…¸å‹æƒ…å†µï¼Œæ¯”å¦‚ç¬¦å·å¾®åˆ†çš„è¡¨è¾¾å¼è†¨èƒ€åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ›´ä¸¥é‡ã€‚\n\nä»¥ä¸‹æ˜¯å…³äºæ•°å€¼å¾®åˆ†ã€ç¬¦å·å¾®åˆ†å’Œè‡ªåŠ¨å¾®åˆ†çš„æ—¶é—´/ç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†ï¼Œä»¥åŠæ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•çš„è¯¦ç»†è§£é‡Šï¼š\n\n---\n\n### ä¸€ã€æ—¶é—´å¤æ‚åº¦è®¡ç®—åŸç†\n\n#### 1. æ•°å€¼å¾®åˆ†ï¼ˆNumerical Differentiationï¼‰\n\n**å®ç°æ–¹å¼**ï¼šé€šè¿‡æœ‰é™å·®åˆ†è¿‘ä¼¼å¯¼æ•°\n$$ f'(x) \\approx \\frac{f(x+h)-f(x-h)}{2h} $$\n\n**æ—¶é—´å¤æ‚åº¦åˆ†æ**ï¼š\n\n- **å•å‚æ•°è®¡ç®—**ï¼šæ¯æ¬¡è®¡ç®—éœ€è¦ **2 æ¬¡å‰å‘ä¼ æ’­**\n- **n ä¸ªå‚æ•°**ï¼šéœ€è¦ **2n æ¬¡å‰å‘ä¼ æ’­**\n- **å‰å‘ä¼ æ’­å¤æ‚åº¦**ï¼šå‡è®¾å•æ¬¡å‰å‘ä¼ æ’­ä¸º $$ O(k) $$ï¼ˆk ä¸ºè®¡ç®—æ­¥éª¤æ•°ï¼‰\n- **æ€»æ—¶é—´å¤æ‚åº¦**ï¼š$$ O(2n \\times k) = O(nk) $$\n\n**å…³é”®ç»“è®º**ï¼šæ—¶é—´å¤æ‚åº¦ä¸å‚æ•°æ•°é‡æˆçº¿æ€§å…³ç³»ï¼Œä½†å‰å‘ä¼ æ’­çš„ $$ k $$ é€šå¸¸ä¸ç½‘ç»œè§„æ¨¡ç›¸å…³ï¼Œå®é™…å¤æ‚åº¦ä¸º $$ O(n^2) $$\n\n\u003e ç¤ºä¾‹ï¼šè®¡ç®— $$ f(w*1,w_2,...,w*{100}) $$ çš„æ¢¯åº¦ï¼Œéœ€è¦ 200 æ¬¡å‰å‘ä¼ æ’­\n\n---\n\n#### 2. ç¬¦å·å¾®åˆ†ï¼ˆSymbolic Differentiationï¼‰\n\n**å®ç°æ–¹å¼**ï¼šé€šè¿‡ä»£æ•°è§„åˆ™æ¨å¯¼é—­å¼è¡¨è¾¾å¼\n\n**æ—¶é—´å¤æ‚åº¦åˆ†æ**ï¼š\n\n- **è¡¨è¾¾å¼è†¨èƒ€**ï¼šå¯¹å¤åˆå‡½æ•° $$ f(g(h(x))) $$ æ±‚å¯¼ä¼šäº§ç”ŸåµŒå¥—ä¹˜ç§¯é¡¹\n- **æœ€åæƒ…å†µ**ï¼šæ¯å±‚æ“ä½œå¯¼è‡´è¡¨è¾¾å¼é•¿åº¦æŒ‡æ•°çº§å¢é•¿ $$ O(2^d) $$ï¼ˆd ä¸ºç½‘ç»œæ·±åº¦ï¼‰\n- **ä¼˜åŒ–æƒ…å†µ**ï¼šç°ä»£ç³»ç»Ÿä¼šè¿›è¡Œè¡¨è¾¾å¼ç®€åŒ–ï¼Œå…¸å‹å¤æ‚åº¦ä¸º $$ O(d) $$\n\n\u003e ç¤ºä¾‹ï¼šå¯¹ $$ f(x) = \\sin(e^{x^2}) $$ æ±‚å¯¼ï¼š\n\u003e $$ f'(x) = \\cos(e^{x^2}) \\cdot e^{x^2} \\cdot 2x $$\n\u003e è¡¨è¾¾å¼é•¿åº¦éšæ±‚å¯¼æ¬¡æ•°çº¿æ€§å¢é•¿\n\n---\n\n#### 3. è‡ªåŠ¨å¾®åˆ†ï¼ˆAutomatic Differentiationï¼‰\n\n**å®ç°æ–¹å¼**ï¼šåŸºäºè®¡ç®—å›¾åˆ†è§£æ±‚å¯¼è¿‡ç¨‹\n\n**æ—¶é—´å¤æ‚åº¦åˆ†æ**ï¼š\n\n- **å‰å‘ä¼ æ’­**ï¼š$$ O(d) $$ï¼ˆd ä¸ºè®¡ç®—å›¾æ·±åº¦ï¼‰\n- **åå‘ä¼ æ’­**ï¼šæ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œå›ºå®šæ—¶é—´çš„æ¢¯åº¦è®¡ç®—ï¼Œå¤æ‚åº¦ $$ O(d) $$\n- **æ€»æ—¶é—´å¤æ‚åº¦**ï¼š$$ O(d) + O(d) = O(d) $$\n\n**å…³é”®ä¼˜åŒ–**ï¼šè®¡ç®—å›¾èŠ‚ç‚¹æ•°é€šå¸¸ä¸å‚æ•°æ•°é‡ $$ n $$ æˆçº¿æ€§å…³ç³»ï¼Œå› æ­¤å¤æ‚åº¦å¯è¡¨ç¤ºä¸º $$ O(n) $$\n\n\u003e ç¤ºä¾‹ï¼šå…¨è¿æ¥ç½‘ç»œçš„åå‘ä¼ æ’­æ—¶é—´ä¸å‚æ•°æ•°é‡æˆæ­£æ¯”\n\n---\n\n### äºŒã€ç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†\n\n#### å¯¹æ¯”è¡¨æ ¼\n\n| æ–¹æ³•     | ç©ºé—´å¤æ‚åº¦ | åŸå›                                                        |\n| -------- | ---------- | ---------------------------------------------------------- |\n| æ•°å€¼å¾®åˆ† | $$ O(1) $$ | åªéœ€å­˜å‚¨å½“å‰å‚æ•°å€¼å’Œæ‰°åŠ¨ç»“æœ                               |\n| ç¬¦å·å¾®åˆ† | $$ O(n) $$ | éœ€è¦å­˜å‚¨å®Œæ•´çš„ç¬¦å·è¡¨è¾¾å¼ï¼ˆå¯èƒ½æŒ‡æ•°è†¨èƒ€ï¼Œä½†ä¼˜åŒ–åçº¿æ€§å¢é•¿ï¼‰ |\n| è‡ªåŠ¨å¾®åˆ† | $$ O(n) $$ | éœ€è¦å­˜å‚¨è®¡ç®—å›¾ä¸­æ‰€æœ‰ä¸­é—´å˜é‡çš„å‰å‘å€¼                       |\n\n**è¯¦ç»†è§£é‡Š**ï¼š\n\n- **æ•°å€¼å¾®åˆ†**ï¼šä»…éœ€ä¿æŒåŸå§‹å‚æ•°å’Œæ‰°åŠ¨åçš„å‚æ•°å‰¯æœ¬ï¼Œå†…å­˜å ç”¨æ’å®š\n- **ç¬¦å·å¾®åˆ†**ï¼šå¯¼æ•°çš„ç¬¦å·è¡¨è¾¾å¼å¯èƒ½éå¸¸åºå¤§ï¼Œä¾‹å¦‚ï¼š\n  $$ \\frac{\\partial}{\\partial x} \\prod*{i=1}^n x_i = \\sum*{j=1}^n \\prod\\_{i \\neq j} x_i $$\n  éœ€è¦å­˜å‚¨ $$ n $$ ä¸ªä¹˜ç§¯é¡¹\n- **è‡ªåŠ¨å¾®åˆ†**ï¼šéœ€è¦ä¿å­˜å‰å‘ä¼ æ’­çš„æ‰€æœ‰ä¸­é—´ç»“æœç”¨äºåå‘è®¡ç®—ï¼Œä¾‹å¦‚ï¼š\n  ```python\n  # å‰å‘è®¡ç®—éœ€è¦ä¿å­˜è¿™äº›å€¼\n  a = W1 * x\n  b = a + b1\n  c = relu(b)\n  ```\n\n---\n\n### ä¸‰ã€æ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•\n\n#### 1. æ•°å€¼å¾®åˆ†ç¨³å®šæ€§\n\n**è¯¯å·®æ¥æº**ï¼š\n\n- **æˆªæ–­è¯¯å·®**ï¼š$$ O(h^2) $$ï¼ˆæ¥è‡ªæ³°å‹’å±•å¼€çš„è¿‘ä¼¼ï¼‰\n- **èˆå…¥è¯¯å·®**ï¼š$$ O(\\epsilon/h) $$ï¼ˆ$$ \\epsilon $$ ä¸ºæœºå™¨ç²¾åº¦ï¼‰\n\n**ç¨³å®šæ€§åˆ†æ**ï¼š\n$$ \\text{æ€»è¯¯å·®} = O(h^2) + O(\\epsilon/h) $$\n\n- **æœ€ä¼˜æ­¥é•¿é€‰æ‹©**ï¼šå½“ $$ h \\approx \\sqrt[3]{\\epsilon} $$ æ—¶è¯¯å·®æœ€å°\n- **å…¸å‹é—®é¢˜**ï¼šå¯¹äºç—…æ€æ¡ä»¶æ•°çš„é—®é¢˜ï¼ˆå¦‚æŒ‡æ•°å‡½æ•°ï¼‰ï¼Œå°æ­¥é•¿ä¼šæ”¾å¤§èˆå…¥è¯¯å·®\n\n\u003e ç¤ºä¾‹ï¼šè®¡ç®— $$ f(x) = e^x $$ åœ¨ $$ x=20 $$ å¤„çš„å¯¼æ•°ï¼š\n\u003e\n\u003e - çœŸå®å¯¼æ•°ï¼š$$ e^{20} \\approx 4.85 \\times 10^8 $$\n\u003e - æ•°å€¼è®¡ç®—å¯èƒ½äº§ç”Ÿæ˜¾è‘—ç›¸å¯¹è¯¯å·®\n\n---\n\n#### 2. ç¬¦å·å¾®åˆ†ç¨³å®šæ€§\n\n**ç‰¹ç‚¹**ï¼š\n\n- **ç²¾ç¡®è®¡ç®—**ï¼šç†è®ºä¸Šæ²¡æœ‰æ•°å€¼è¯¯å·®\n- **å®é™…é™åˆ¶**ï¼š\n  - ç¬¦å·åŒ–ç®€å¯èƒ½å¯¼è‡´æ•°å€¼ä¸ç¨³å®šè¡¨è¾¾å¼\n  - è½¬æ¢ä¸ºæµ®ç‚¹è¿ç®—æ—¶ä»ä¼šå¼•å…¥èˆå…¥è¯¯å·®\n\n**è¯„ä¼°æ–¹æ³•**ï¼š\n\n- **è¡¨è¾¾å¼å¤æ‚åº¦**ï¼šæ£€æŸ¥å¯¼æ•°è¡¨è¾¾å¼æ˜¯å¦åŒ…å«ç—…æ€æ“ä½œï¼ˆå¦‚å¤§æ•°ç›¸å‡ï¼‰\n  $$ \\frac{\\partial}{\\partial x} (e^x - e^{-x}) = e^x + e^{-x} $$\n  ç›´æ¥è®¡ç®—å¯èƒ½åœ¨ $$ x $$ è¾ƒå¤§æ—¶å‡ºç°ç²¾åº¦æŸå¤±\n\n---\n\n#### 3. è‡ªåŠ¨å¾®åˆ†ç¨³å®šæ€§\n\n**è¯¯å·®æ¥æº**ï¼š\n\n- **å‰å‘ä¼ æ’­èˆå…¥è¯¯å·®**ï¼šä¸ç¬¦å·å¾®åˆ†ç›¸åŒé‡çº§\n- **åå‘ä¼ æ’­ç¨³å®šæ€§**ï¼šå–å†³äºæ¢¯åº¦è®¡ç®—è·¯å¾„\n\n**ç¨³å®šæ€§ä¼˜åŠ¿**ï¼š\n\n- **é¿å…è¯¯å·®ç´¯ç§¯**ï¼šé€šè¿‡ä¿æŒåŸå§‹è®¡ç®—è·¯å¾„çš„æ•°å€¼ç‰¹æ€§\n- **å…¸å‹å¯¹æ¯”**ï¼š\n  - ç›´æ¥è®¡ç®— $$ f(x) = \\sqrt{x^2 + 1} - x $$ çš„å¯¼æ•°\n  - ç¬¦å·å¾®åˆ†å¯èƒ½å¾—åˆ°ä¸ç¨³å®šçš„ $$ \\frac{x}{\\sqrt{x^2+1}} - 1 $$\n  - è‡ªåŠ¨å¾®åˆ†åœ¨è®¡ç®—æ—¶ä¿æŒåŸå§‹è¡¨è¾¾å¼ç»“æ„\n\n---\n\n### å››ã€ç»¼åˆå¯¹æ¯”ä¸å·¥ç¨‹é€‰æ‹©\n\n#### 1. æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘\n\n```mermaid\ngraph TD\n    A[éœ€è¦å¾®åˆ†] --\u003e B{å‚æ•°è§„æ¨¡}\n    B --\u003e|\"å°è§„æ¨¡(n\u003c100)\"| C[ç¬¦å·å¾®åˆ†]\n    B --\u003e|ä¸­å¤§è§„æ¨¡| D{æ˜¯å¦éœ€è¦æœ€é«˜ç²¾åº¦}\n    D --\u003e|æ˜¯| E[è‡ªåŠ¨å¾®åˆ†]\n    D --\u003e|å¦| F[æ•°å€¼å¾®åˆ†]\n    C --\u003e G[è·å¾—ç²¾ç¡®è¡¨è¾¾å¼]\n    E --\u003e H[é«˜æ•ˆè®¡ç®—æ¢¯åº¦]\n    F --\u003e I[å¿«é€Ÿä½†ä½ç²¾åº¦]\n```\n\n#### 2. å®é™…æ¡†æ¶å®ç°\n\n- **PyTorch/TensorFlow**ï¼šé‡‡ç”¨è‡ªåŠ¨å¾®åˆ†ï¼ˆåå‘ä¼ æ’­ï¼‰\n- **Mathematica**ï¼šä½¿ç”¨ç¬¦å·å¾®åˆ†\n- **æœ‰é™å·®åˆ†åº“**ï¼šå¸¸ç”¨äºéªŒè¯å…¶ä»–æ–¹æ³•çš„æ­£ç¡®æ€§\n\n---\n\n### äº”ã€æ·±åº¦å­¦ä¹ ä¸­çš„ç‰¹æ®Šè€ƒé‡\n\n#### 1. GPU å†…å­˜ç“¶é¢ˆ\n\n- **è‡ªåŠ¨å¾®åˆ†ä¼˜åŒ–**ï¼šPyTorch çš„ `checkpoint` æœºåˆ¶é€šè¿‡ç‰ºç‰²è®¡ç®—æ¢å†…å­˜\n  ```python\n  # å‡å°‘ä¸­é—´å˜é‡å­˜å‚¨\n  from torch.utils.checkpoint import checkpoint\n  x = checkpoint(layer1, x)\n  x = checkpoint(layer2, x)\n  ```\n\n#### 2. æ··åˆç²¾åº¦è®­ç»ƒ\n\n- **ç¨³å®šæ€§æŒ‘æˆ˜**ï¼šfloat16 ç±»å‹ä¸‹çš„æ¢¯åº¦è®¡ç®—éœ€è¦ç‰¹æ®Šå¤„ç†\n- **è§£å†³æ–¹æ¡ˆ**ï¼šæ¢¯åº¦ç¼©æ”¾ï¼ˆGradient Scalingï¼‰\n  ```python\n  scaler = torch.cuda.amp.GradScaler()\n  with torch.cuda.amp.autocast():\n      output = model(input)\n  scaler.scale(loss).backward()\n  ```\n\n---\n\n### å…­ã€æ•°å­¦è¯æ˜ç¤ºä¾‹\n\n#### æ•°å€¼å¾®åˆ†è¯¯å·®åˆ†æ\n\nè®¾çœŸå®å¯¼æ•°ä¸º $$ f'(x) $$ï¼Œæ•°å€¼è¿‘ä¼¼ä¸ºï¼š\n$$ \\tilde{f}'(x) = \\frac{f(x+h) - f(x-h)}{2h} $$\n\n**æ³°å‹’å±•å¼€**ï¼š\n$$ f(x+h) = f(x) + hf'(x) + \\frac{h^2}{2}f''(x) + \\frac{h^3}{6}f'''(Î¾_1) $$\n$$ f(x-h) = f(x) - hf'(x) + \\frac{h^2}{2}f''(x) - \\frac{h^3}{6}f'''(Î¾_2) $$\n\n**ç›¸å‡å¾—**ï¼š\n$$ \\tilde{f}'(x) = f'(x) + \\frac{h^2}{12}[f'''(Î¾_1) + f'''(Î¾_2)] $$\n\n**è¯¯å·®é¡¹**ï¼š\n$$ \\text{æˆªæ–­è¯¯å·®} = O(h^2) $$\n\n---\n\n### ä¸ƒã€æ€»ç»“ç†è§£\n\n1. **å¤æ‚åº¦è®¡ç®—æœ¬è´¨**ï¼š\n\n   - æ—¶é—´å¤æ‚åº¦ï¼šè®¡ç®—ä»£ä»·éšé—®é¢˜è§„æ¨¡çš„å¢é•¿ç‡\n   - ç©ºé—´å¤æ‚åº¦ï¼šå†…å­˜éœ€æ±‚éšé—®é¢˜è§„æ¨¡çš„å¢é•¿ç‡\n\n2. **ç¨³å®šæ€§è¯„ä¼°æ ¸å¿ƒ**ï¼š\n\n   - å¯¹èˆå…¥è¯¯å·®å’Œæˆªæ–­è¯¯å·®çš„æ•æ„Ÿåº¦\n   - ä¿æŒæ•°å€¼è®¡ç®—ç²¾åº¦çš„èƒ½åŠ›\n\n3. **å·¥ç¨‹å®è·µæŒ‡å¯¼**ï¼š\n   - å°è§„æ¨¡é—®é¢˜ï¼šä¼˜å…ˆç¬¦å·å¾®åˆ†ï¼ˆå¦‚ç‰©ç†ä»¿çœŸï¼‰\n   - å¤§è§„æ¨¡å¯å¾®ç¼–ç¨‹ï¼šå¿…é€‰è‡ªåŠ¨å¾®åˆ†ï¼ˆæ·±åº¦å­¦ä¹ æ¡†æ¶ï¼‰\n   - å¿«é€ŸéªŒè¯ï¼šä½¿ç”¨æ•°å€¼å¾®åˆ†ï¼ˆåŸå‹å¼€å‘é˜¶æ®µï¼‰\n\n\u003e [!NOTE] äº®æ›°ï¼š\n\u003e\n\u003e - æ•°å€¼å¾®åˆ†ï¼šå‚æ•°åš Delta ï¼Œè®¡ç®—æœ€ç»ˆå€¼çš„å·®ï¼Œæ²¡æœ‰åå‘ä¼ æ’­è¿‡ç¨‹\n\u003e - ç¬¦å·å¾®åˆ†ï¼šç›´æ¥æ¨å¯¼å‡ºå¯¼æ•°è¡¨è¾¾å¼ï¼Œå†ä»£å…¥è®¡ç®—ï¼Œè¡¨è¾¾å¼å¤æ‚\n\u003e - è‡ªåŠ¨å¾®åˆ†ï¼šå‰å‘ä¼ æ’­è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å€¼ï¼Œå†åå‘ä¼ æ’­ç”¨é“¾å¼æ³•åˆ™è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æ¢¯åº¦ã€‚\n\u003e\n\u003e è‡ªåŠ¨å¾®åˆ†å¯ä»¥ç®—æ˜¯ä¸€ç§åŠ¨æ€è§„åˆ’ï¼Œæš‚å­˜è®¡ç®—ä¸­é‡å¤ç”¨åˆ°çš„ä¸­é—´æ•°æ®ï¼Œç”¨ç©ºé—´æ¢æ—¶é—´ã€‚æ›´è¿›ä¸€æ­¥ï¼Œåå‘ä¼ æ’­æ—¶ï¼Œç”¨å±‚åºéå†è®¡ç®—å›¾ï¼Œå½“èŠ‚ç‚¹çš„æ‰€æœ‰å…¥è¾¹ï¼ˆåå‘æ—¶çš„å‡ºè¾¹ï¼‰éƒ½è®¡ç®—å®Œåï¼Œå³å¯å°†å½“å‰èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œä»è€ŒèŠ‚çœå†…å­˜ã€‚\n","title":"PyTorch è‡ªåŠ¨å¾®åˆ†ä¸åå‘ä¼ æ’­æœºåˆ¶åŸç†è§£æ","abstract":"\u003e æœ¬æ–‡ä¸ºç”¨æˆ·ä¸ DeepSeek çš„é—®ç­”ã€‚ä¸»é¢˜ä¸º PyTorch çš„åå‘ä¼ æ’­æœºåˆ¶ã€‚æœ¬æ–‡ä»æ•°å­¦åŸç†ã€è®¡ç®—å›¾æœºåˆ¶å’Œå®é™…éœ€æ±‚ä¸‰ä¸ªæ–¹é¢æ·±å…¥è§£é‡Šå…¶å·¥ä½œåŸç†ï¼Œå¹¶ç»“åˆ PyTorch çš„è‡ªåŠ¨å¾®åˆ†ï¼ˆAutogradï¼‰ç³»ç»Ÿè¿›è¡Œè¯´æ˜ã€‚\n\u003e [!query]\n\u003e","length":952,"created_at":"2025-03-06T15:50:00.000Z","updated_at":"2025-03-06T15:50:00.000Z","tags":["PyTorch","æ·±åº¦å­¦ä¹ ","åå‘ä¼ æ’­","è‡ªåŠ¨å¾®åˆ†","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","href":"#q-æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","heading":2,"title":"Q; æ·±å…¥è§£æ PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","children":[{"key":"æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","href":"#æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","heading":3,"title":"æ·±å…¥è§£æ PyTorch ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶","children":[{"key":"ä¸€åå‘ä¼ æ’­çš„æ•°å­¦åŸç†","href":"#ä¸€åå‘ä¼ æ’­çš„æ•°å­¦åŸç†","heading":4,"title":"ä¸€ã€åå‘ä¼ æ’­çš„æ•°å­¦åŸç†","children":[{"key":"1-é“¾å¼æ³•åˆ™chain-rule","href":"#1-é“¾å¼æ³•åˆ™chain-rule","heading":5,"title":"1. é“¾å¼æ³•åˆ™ï¼ˆChain Ruleï¼‰","children":[],"id":"1-é“¾å¼æ³•åˆ™chain-rule"},{"key":"2-æ¢¯åº¦ç´¯ç§¯å…¬å¼","href":"#2-æ¢¯åº¦ç´¯ç§¯å…¬å¼","heading":5,"title":"2. æ¢¯åº¦ç´¯ç§¯å…¬å¼","children":[],"id":"2-æ¢¯åº¦ç´¯ç§¯å…¬å¼"}],"id":"ä¸€åå‘ä¼ æ’­çš„æ•°å­¦åŸç†"},{"key":"äºŒpytorch-çš„å®ç°æœºåˆ¶","href":"#äºŒpytorch-çš„å®ç°æœºåˆ¶","heading":4,"title":"äºŒã€PyTorch çš„å®ç°æœºåˆ¶","children":[{"key":"1-åŠ¨æ€è®¡ç®—å›¾dynamic-computation-graph","href":"#1-åŠ¨æ€è®¡ç®—å›¾dynamic-computation-graph","heading":5,"title":"1. åŠ¨æ€è®¡ç®—å›¾ï¼ˆDynamic Computation Graphï¼‰","children":[],"id":"1-åŠ¨æ€è®¡ç®—å›¾dynamic-computation-graph"},{"key":"2-autograd-æ ¸å¿ƒç»„ä»¶","href":"#2-autograd-æ ¸å¿ƒç»„ä»¶","heading":5,"title":"2. Autograd æ ¸å¿ƒç»„ä»¶","children":[],"id":"2-autograd-æ ¸å¿ƒç»„ä»¶"},{"key":"3-åå‘ä¼ æ’­è¿‡ç¨‹","href":"#3-åå‘ä¼ æ’­è¿‡ç¨‹","heading":5,"title":"3. åå‘ä¼ æ’­è¿‡ç¨‹","children":[],"id":"3-åå‘ä¼ æ’­è¿‡ç¨‹"}],"id":"äºŒpytorch-çš„å®ç°æœºåˆ¶"},{"key":"ä¸‰ä¸ºä½•éœ€è¦åå‘ä¼ æ’­","href":"#ä¸‰ä¸ºä½•éœ€è¦åå‘ä¼ æ’­","heading":4,"title":"ä¸‰ã€ä¸ºä½•éœ€è¦åå‘ä¼ æ’­ï¼Ÿ","children":[{"key":"1-æ‰‹åŠ¨è®¡ç®—ä¸å¯è¡Œæ€§","href":"#1-æ‰‹åŠ¨è®¡ç®—ä¸å¯è¡Œæ€§","heading":5,"title":"1. æ‰‹åŠ¨è®¡ç®—ä¸å¯è¡Œæ€§","children":[],"id":"1-æ‰‹åŠ¨è®¡ç®—ä¸å¯è¡Œæ€§"},{"key":"2-è®¡ç®—æ•ˆç‡å¯¹æ¯”","href":"#2-è®¡ç®—æ•ˆç‡å¯¹æ¯”","heading":5,"title":"2. è®¡ç®—æ•ˆç‡å¯¹æ¯”","children":[],"id":"2-è®¡ç®—æ•ˆç‡å¯¹æ¯”"},{"key":"3-å†…å­˜ä¼˜åŒ–ç­–ç•¥","href":"#3-å†…å­˜ä¼˜åŒ–ç­–ç•¥","heading":5,"title":"3. å†…å­˜ä¼˜åŒ–ç­–ç•¥","children":[],"id":"3-å†…å­˜ä¼˜åŒ–ç­–ç•¥"}],"id":"ä¸‰ä¸ºä½•éœ€è¦åå‘ä¼ æ’­"},{"key":"å››åå‘ä¼ æ’­çš„æ•°å­¦æ‰©å±•","href":"#å››åå‘ä¼ æ’­çš„æ•°å­¦æ‰©å±•","heading":4,"title":"å››ã€åå‘ä¼ æ’­çš„æ•°å­¦æ‰©å±•","children":[{"key":"1-çŸ©é˜µæ±‚å¯¼ç¤ºä¾‹","href":"#1-çŸ©é˜µæ±‚å¯¼ç¤ºä¾‹","heading":5,"title":"1. çŸ©é˜µæ±‚å¯¼ç¤ºä¾‹","children":[],"id":"1-çŸ©é˜µæ±‚å¯¼ç¤ºä¾‹"},{"key":"2-å¤æ‚è¿ç®—å¤„ç†","href":"#2-å¤æ‚è¿ç®—å¤„ç†","heading":5,"title":"2. å¤æ‚è¿ç®—å¤„ç†","children":[],"id":"2-å¤æ‚è¿ç®—å¤„ç†"}],"id":"å››åå‘ä¼ æ’­çš„æ•°å­¦æ‰©å±•"},{"key":"äº”æ€»ç»“","href":"#äº”æ€»ç»“","heading":4,"title":"äº”ã€æ€»ç»“","children":[],"id":"äº”æ€»ç»“"}],"id":"æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶"}],"id":"q-æ·±å…¥è§£æ-pytorch-ä¸­çš„åå‘ä¼ æ’­æœºåˆ¶"},{"key":"q-å‚æ•°çš„æ¢¯åº¦ç´¯åŠ è®¡ç®—å…¬å¼","href":"#q-å‚æ•°çš„æ¢¯åº¦ç´¯åŠ è®¡ç®—å…¬å¼","heading":2,"title":"Q: å‚æ•°çš„æ¢¯åº¦ç´¯åŠ è®¡ç®—å…¬å¼","children":[{"key":"ä¸€é—®é¢˜åœºæ™¯è®¾å®š","href":"#ä¸€é—®é¢˜åœºæ™¯è®¾å®š","heading":3,"title":"ä¸€ã€é—®é¢˜åœºæ™¯è®¾å®š","children":[],"id":"ä¸€é—®é¢˜åœºæ™¯è®¾å®š"},{"key":"äºŒåˆ†æ­¥æ¨å¯¼","href":"#äºŒåˆ†æ­¥æ¨å¯¼","heading":3,"title":"äºŒã€åˆ†æ­¥æ¨å¯¼","children":[{"key":"æ­¥éª¤-1å‰å‘ä¼ æ’­è¡¨è¾¾å¼","href":"#æ­¥éª¤-1å‰å‘ä¼ æ’­è¡¨è¾¾å¼","heading":4,"title":"æ­¥éª¤ 1ï¼šå‰å‘ä¼ æ’­è¡¨è¾¾å¼","children":[],"id":"æ­¥éª¤-1å‰å‘ä¼ æ’­è¡¨è¾¾å¼"},{"key":"æ­¥éª¤-2ç›´æ¥æ±‚å¯¼å¯¹æ¯”éªŒè¯","href":"#æ­¥éª¤-2ç›´æ¥æ±‚å¯¼å¯¹æ¯”éªŒè¯","heading":4,"title":"æ­¥éª¤ 2ï¼šç›´æ¥æ±‚å¯¼ï¼ˆå¯¹æ¯”éªŒè¯ï¼‰","children":[],"id":"æ­¥éª¤-2ç›´æ¥æ±‚å¯¼å¯¹æ¯”éªŒè¯"},{"key":"æ­¥éª¤-3åå‘ä¼ æ’­è§†è§’","href":"#æ­¥éª¤-3åå‘ä¼ æ’­è§†è§’","heading":4,"title":"æ­¥éª¤ 3ï¼šåå‘ä¼ æ’­è§†è§’","children":[{"key":"è·¯å¾„-1-çš„æ¢¯åº¦è®¡ç®—Î¸--a--l","href":"#è·¯å¾„-1-çš„æ¢¯åº¦è®¡ç®—Î¸--a--l","heading":5,"title":"è·¯å¾„ 1 çš„æ¢¯åº¦è®¡ç®—ï¼ˆÎ¸ â†’ A â†’ Lï¼‰","children":[],"id":"è·¯å¾„-1-çš„æ¢¯åº¦è®¡ç®—Î¸--a--l"},{"key":"è·¯å¾„-2-çš„æ¢¯åº¦è®¡ç®—Î¸--b--l","href":"#è·¯å¾„-2-çš„æ¢¯åº¦è®¡ç®—Î¸--b--l","heading":5,"title":"è·¯å¾„ 2 çš„æ¢¯åº¦è®¡ç®—ï¼ˆÎ¸ â†’ B â†’ Lï¼‰","children":[],"id":"è·¯å¾„-2-çš„æ¢¯åº¦è®¡ç®—Î¸--b--l"},{"key":"æ€»æ¢¯åº¦--è·¯å¾„-1--è·¯å¾„-2","href":"#æ€»æ¢¯åº¦--è·¯å¾„-1--è·¯å¾„-2","heading":5,"title":"æ€»æ¢¯åº¦ = è·¯å¾„ 1 + è·¯å¾„ 2","children":[],"id":"æ€»æ¢¯åº¦--è·¯å¾„-1--è·¯å¾„-2"}],"id":"æ­¥éª¤-3åå‘ä¼ æ’­è§†è§’"}],"id":"äºŒåˆ†æ­¥æ¨å¯¼"},{"key":"ä¸‰é€šç”¨å…¬å¼è§£æ","href":"#ä¸‰é€šç”¨å…¬å¼è§£æ","heading":3,"title":"ä¸‰ã€é€šç”¨å…¬å¼è§£æ","children":[{"key":"1-ç¬¦å·è§£é‡Š","href":"#1-ç¬¦å·è§£é‡Š","heading":4,"title":"1. ç¬¦å·è§£é‡Š","children":[],"id":"1-ç¬¦å·è§£é‡Š"},{"key":"2-å…³é”®æ€§è´¨","href":"#2-å…³é”®æ€§è´¨","heading":4,"title":"2. å…³é”®æ€§è´¨","children":[],"id":"2-å…³é”®æ€§è´¨"}],"id":"ä¸‰é€šç”¨å…¬å¼è§£æ"},{"key":"å››å¤æ‚æ¡ˆä¾‹éªŒè¯","href":"#å››å¤æ‚æ¡ˆä¾‹éªŒè¯","heading":3,"title":"å››ã€å¤æ‚æ¡ˆä¾‹éªŒè¯","children":[{"key":"å‰å‘ä¼ æ’­è¡¨è¾¾å¼","href":"#å‰å‘ä¼ æ’­è¡¨è¾¾å¼","heading":4,"title":"å‰å‘ä¼ æ’­è¡¨è¾¾å¼","children":[],"id":"å‰å‘ä¼ æ’­è¡¨è¾¾å¼"},{"key":"åå‘ä¼ æ’­è®¡ç®—","href":"#åå‘ä¼ æ’­è®¡ç®—","heading":4,"title":"åå‘ä¼ æ’­è®¡ç®—","children":[{"key":"è·¯å¾„-1Î¸--c--e--l","href":"#è·¯å¾„-1Î¸--c--e--l","heading":5,"title":"è·¯å¾„ 1ï¼šÎ¸ â†’ C â†’ E â†’ L","children":[],"id":"è·¯å¾„-1Î¸--c--e--l"},{"key":"è·¯å¾„-2Î¸--d--e--l","href":"#è·¯å¾„-2Î¸--d--e--l","heading":5,"title":"è·¯å¾„ 2ï¼šÎ¸ â†’ D â†’ E â†’ L","children":[],"id":"è·¯å¾„-2Î¸--d--e--l"},{"key":"æ€»æ¢¯åº¦","href":"#æ€»æ¢¯åº¦","heading":5,"title":"æ€»æ¢¯åº¦","children":[],"id":"æ€»æ¢¯åº¦"}],"id":"åå‘ä¼ æ’­è®¡ç®—"}],"id":"å››å¤æ‚æ¡ˆä¾‹éªŒè¯"},{"key":"äº”åå‘ä¼ æ’­çš„æœ¬è´¨","href":"#äº”åå‘ä¼ æ’­çš„æœ¬è´¨","heading":3,"title":"äº”ã€åå‘ä¼ æ’­çš„æœ¬è´¨","children":[],"id":"äº”åå‘ä¼ æ’­çš„æœ¬è´¨"},{"key":"å…­æ€»ç»“","href":"#å…­æ€»ç»“","heading":3,"title":"å…­ã€æ€»ç»“","children":[],"id":"å…­æ€»ç»“"}],"id":"q-å‚æ•°çš„æ¢¯åº¦ç´¯åŠ è®¡ç®—å…¬å¼"},{"key":"q-ä»-pytorch-ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹-pytorch-çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°","href":"#q-ä»-pytorch-ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹-pytorch-çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°","heading":2,"title":"Q: ä» PyTorch ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹ PyTorch çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°","children":[{"key":"ä¸€pytorch-åå‘ä¼ æ’­çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶","href":"#ä¸€pytorch-åå‘ä¼ æ’­çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶","heading":3,"title":"ä¸€ã€PyTorch åå‘ä¼ æ’­çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶","children":[{"key":"1-tensor-çš„æ¢¯åº¦è¿½è¸ªæœºåˆ¶","href":"#1-tensor-çš„æ¢¯åº¦è¿½è¸ªæœºåˆ¶","heading":4,"title":"1. Tensor çš„æ¢¯åº¦è¿½è¸ªæœºåˆ¶","children":[],"id":"1-tensor-çš„æ¢¯åº¦è¿½è¸ªæœºåˆ¶"},{"key":"2-è®¡ç®—å›¾çš„åŠ¨æ€æ„å»º","href":"#2-è®¡ç®—å›¾çš„åŠ¨æ€æ„å»º","heading":4,"title":"2. è®¡ç®—å›¾çš„åŠ¨æ€æ„å»º","children":[],"id":"2-è®¡ç®—å›¾çš„åŠ¨æ€æ„å»º"},{"key":"3-åå‘ä¼ æ’­å¼•æ“autograd-engine","href":"#3-åå‘ä¼ æ’­å¼•æ“autograd-engine","heading":4,"title":"3. åå‘ä¼ æ’­å¼•æ“ï¼ˆAutograd Engineï¼‰","children":[],"id":"3-åå‘ä¼ æ’­å¼•æ“autograd-engine"}],"id":"ä¸€pytorch-åå‘ä¼ æ’­çš„ä¸‰å¤§æ ¸å¿ƒç»„ä»¶"},{"key":"äºŒä»£ç çº§åå‘ä¼ æ’­æµç¨‹åˆ†è§£","href":"#äºŒä»£ç çº§åå‘ä¼ æ’­æµç¨‹åˆ†è§£","heading":3,"title":"äºŒã€ä»£ç çº§åå‘ä¼ æ’­æµç¨‹åˆ†è§£","children":[{"key":"æ­¥éª¤-1å‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾","href":"#æ­¥éª¤-1å‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾","heading":4,"title":"æ­¥éª¤ 1ï¼šå‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾","children":[],"id":"æ­¥éª¤-1å‰å‘ä¼ æ’­æ„å»ºè®¡ç®—å›¾"},{"key":"æ­¥éª¤-2æ‰§è¡Œåå‘ä¼ æ’­","href":"#æ­¥éª¤-2æ‰§è¡Œåå‘ä¼ æ’­","heading":4,"title":"æ­¥éª¤ 2ï¼šæ‰§è¡Œåå‘ä¼ æ’­","children":[{"key":"åº•å±‚æ“ä½œåˆ†è§£","href":"#åº•å±‚æ“ä½œåˆ†è§£","heading":5,"title":"åº•å±‚æ“ä½œåˆ†è§£ï¼š","children":[],"id":"åº•å±‚æ“ä½œåˆ†è§£"}],"id":"æ­¥éª¤-2æ‰§è¡Œåå‘ä¼ æ’­"},{"key":"æ­¥éª¤-3æŸ¥çœ‹ç»“æœ","href":"#æ­¥éª¤-3æŸ¥çœ‹ç»“æœ","heading":4,"title":"æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç»“æœ","children":[],"id":"æ­¥éª¤-3æŸ¥çœ‹ç»“æœ"}],"id":"äºŒä»£ç çº§åå‘ä¼ æ’­æµç¨‹åˆ†è§£"},{"key":"ä¸‰pytorch-åå‘ä¼ æ’­çš„å…³é”®å®ç°ç»†èŠ‚","href":"#ä¸‰pytorch-åå‘ä¼ æ’­çš„å…³é”®å®ç°ç»†èŠ‚","heading":3,"title":"ä¸‰ã€PyTorch åå‘ä¼ æ’­çš„å…³é”®å®ç°ç»†èŠ‚","children":[{"key":"1-æ¢¯åº¦è®¡ç®—è§„åˆ™æ³¨å†Œ","href":"#1-æ¢¯åº¦è®¡ç®—è§„åˆ™æ³¨å†Œ","heading":4,"title":"1. æ¢¯åº¦è®¡ç®—è§„åˆ™æ³¨å†Œ","children":[],"id":"1-æ¢¯åº¦è®¡ç®—è§„åˆ™æ³¨å†Œ"},{"key":"2-æ¢¯åº¦ç´¯åŠ æœºåˆ¶","href":"#2-æ¢¯åº¦ç´¯åŠ æœºåˆ¶","heading":4,"title":"2. æ¢¯åº¦ç´¯åŠ æœºåˆ¶","children":[],"id":"2-æ¢¯åº¦ç´¯åŠ æœºåˆ¶"},{"key":"3-éæ ‡é‡å¼ é‡çš„åå‘ä¼ æ’­","href":"#3-éæ ‡é‡å¼ é‡çš„åå‘ä¼ æ’­","heading":4,"title":"3. éæ ‡é‡å¼ é‡çš„åå‘ä¼ æ’­","children":[],"id":"3-éæ ‡é‡å¼ é‡çš„åå‘ä¼ æ’­"},{"key":"4-å†…å­˜ä¼˜åŒ–ç­–ç•¥","href":"#4-å†…å­˜ä¼˜åŒ–ç­–ç•¥","heading":4,"title":"4. å†…å­˜ä¼˜åŒ–ç­–ç•¥","children":[],"id":"4-å†…å­˜ä¼˜åŒ–ç­–ç•¥"}],"id":"ä¸‰pytorch-åå‘ä¼ æ’­çš„å…³é”®å®ç°ç»†èŠ‚"},{"key":"å››å¯è§†åŒ–åå‘ä¼ æ’­è¿‡ç¨‹","href":"#å››å¯è§†åŒ–åå‘ä¼ æ’­è¿‡ç¨‹","heading":3,"title":"å››ã€å¯è§†åŒ–åå‘ä¼ æ’­è¿‡ç¨‹","children":[{"key":"ç¤ºä¾‹ä»£ç ","href":"#ç¤ºä¾‹ä»£ç ","heading":4,"title":"ç¤ºä¾‹ä»£ç ","children":[],"id":"ç¤ºä¾‹ä»£ç "},{"key":"ç”Ÿæˆçš„è®¡ç®—å›¾ç»“æ„","href":"#ç”Ÿæˆçš„è®¡ç®—å›¾ç»“æ„","heading":4,"title":"ç”Ÿæˆçš„è®¡ç®—å›¾ç»“æ„","children":[],"id":"ç”Ÿæˆçš„è®¡ç®—å›¾ç»“æ„"}],"id":"å››å¯è§†åŒ–åå‘ä¼ æ’­è¿‡ç¨‹"},{"key":"äº”pytorch-åå‘ä¼ æ’­çš„æ€§èƒ½ä¼˜åŒ–","href":"#äº”pytorch-åå‘ä¼ æ’­çš„æ€§èƒ½ä¼˜åŒ–","heading":3,"title":"äº”ã€PyTorch åå‘ä¼ æ’­çš„æ€§èƒ½ä¼˜åŒ–","children":[{"key":"1-å¼‚æ­¥æ‰§è¡Œ","href":"#1-å¼‚æ­¥æ‰§è¡Œ","heading":4,"title":"1. å¼‚æ­¥æ‰§è¡Œ","children":[],"id":"1-å¼‚æ­¥æ‰§è¡Œ"},{"key":"2-æ··åˆç²¾åº¦è®­ç»ƒ","href":"#2-æ··åˆç²¾åº¦è®­ç»ƒ","heading":4,"title":"2. æ··åˆç²¾åº¦è®­ç»ƒ","children":[],"id":"2-æ··åˆç²¾åº¦è®­ç»ƒ"},{"key":"3-æ¢¯åº¦è£å‰ª","href":"#3-æ¢¯åº¦è£å‰ª","heading":4,"title":"3. æ¢¯åº¦è£å‰ª","children":[],"id":"3-æ¢¯åº¦è£å‰ª"}],"id":"äº”pytorch-åå‘ä¼ æ’­çš„æ€§èƒ½ä¼˜åŒ–"},{"key":"å…­è°ƒè¯•æŠ€å·§","href":"#å…­è°ƒè¯•æŠ€å·§","heading":3,"title":"å…­ã€è°ƒè¯•æŠ€å·§","children":[{"key":"1-æ£€æŸ¥æ¢¯åº¦æ˜¯å¦å­˜åœ¨","href":"#1-æ£€æŸ¥æ¢¯åº¦æ˜¯å¦å­˜åœ¨","heading":4,"title":"1. æ£€æŸ¥æ¢¯åº¦æ˜¯å¦å­˜åœ¨","children":[],"id":"1-æ£€æŸ¥æ¢¯åº¦æ˜¯å¦å­˜åœ¨"},{"key":"2-æ¢¯åº¦æ•°å€¼æ£€æŸ¥","href":"#2-æ¢¯åº¦æ•°å€¼æ£€æŸ¥","heading":4,"title":"2. æ¢¯åº¦æ•°å€¼æ£€æŸ¥","children":[],"id":"2-æ¢¯åº¦æ•°å€¼æ£€æŸ¥"},{"key":"3-ä¿ç•™ä¸­é—´æ¢¯åº¦","href":"#3-ä¿ç•™ä¸­é—´æ¢¯åº¦","heading":4,"title":"3. ä¿ç•™ä¸­é—´æ¢¯åº¦","children":[],"id":"3-ä¿ç•™ä¸­é—´æ¢¯åº¦"}],"id":"å…­è°ƒè¯•æŠ€å·§"},{"key":"ä¸ƒåº•å±‚å®ç°åŸç†","href":"#ä¸ƒåº•å±‚å®ç°åŸç†","heading":3,"title":"ä¸ƒã€åº•å±‚å®ç°åŸç†","children":[{"key":"1-c-æ ¸å¿ƒå¼•æ“","href":"#1-c-æ ¸å¿ƒå¼•æ“","heading":4,"title":"1. C++ æ ¸å¿ƒå¼•æ“","children":[],"id":"1-c-æ ¸å¿ƒå¼•æ“"},{"key":"2-åå‘ä¼ æ’­ä»»åŠ¡è°ƒåº¦","href":"#2-åå‘ä¼ æ’­ä»»åŠ¡è°ƒåº¦","heading":4,"title":"2. åå‘ä¼ æ’­ä»»åŠ¡è°ƒåº¦","children":[],"id":"2-åå‘ä¼ æ’­ä»»åŠ¡è°ƒåº¦"}],"id":"ä¸ƒåº•å±‚å®ç°åŸç†"},{"key":"å…«æ€»ç»“pytorch-åå‘ä¼ æ’­çš„è®¾è®¡å“²å­¦","href":"#å…«æ€»ç»“pytorch-åå‘ä¼ æ’­çš„è®¾è®¡å“²å­¦","heading":3,"title":"å…«ã€æ€»ç»“ï¼šPyTorch åå‘ä¼ æ’­çš„è®¾è®¡å“²å­¦","children":[],"id":"å…«æ€»ç»“pytorch-åå‘ä¼ æ’­çš„è®¾è®¡å“²å­¦"}],"id":"q-ä»-pytorch-ä»£ç å±‚é¢æ·±å…¥è§£é‡Šä¸€ä¸‹-pytorch-çš„åå‘ä¼ æ’­å¦‚ä½•å®ç°"},{"key":"q-æ·±å…¥è®²è§£å‡ ç§å¾®åˆ†æ–¹æ³•çš„å¤æ‚åº¦ä¸æ•°å€¼ç¨³å®šæ€§","href":"#q-æ·±å…¥è®²è§£å‡ ç§å¾®åˆ†æ–¹æ³•çš„å¤æ‚åº¦ä¸æ•°å€¼ç¨³å®šæ€§","heading":2,"title":"Q: æ·±å…¥è®²è§£å‡ ç§å¾®åˆ†æ–¹æ³•çš„å¤æ‚åº¦ä¸æ•°å€¼ç¨³å®šæ€§","children":[{"key":"ä¸€æ—¶é—´å¤æ‚åº¦è®¡ç®—åŸç†","href":"#ä¸€æ—¶é—´å¤æ‚åº¦è®¡ç®—åŸç†","heading":3,"title":"ä¸€ã€æ—¶é—´å¤æ‚åº¦è®¡ç®—åŸç†","children":[{"key":"1-æ•°å€¼å¾®åˆ†numerical-differentiation","href":"#1-æ•°å€¼å¾®åˆ†numerical-differentiation","heading":4,"title":"1. æ•°å€¼å¾®åˆ†ï¼ˆNumerical Differentiationï¼‰","children":[],"id":"1-æ•°å€¼å¾®åˆ†numerical-differentiation"},{"key":"2-ç¬¦å·å¾®åˆ†symbolic-differentiation","href":"#2-ç¬¦å·å¾®åˆ†symbolic-differentiation","heading":4,"title":"2. ç¬¦å·å¾®åˆ†ï¼ˆSymbolic Differentiationï¼‰","children":[],"id":"2-ç¬¦å·å¾®åˆ†symbolic-differentiation"},{"key":"3-è‡ªåŠ¨å¾®åˆ†automatic-differentiation","href":"#3-è‡ªåŠ¨å¾®åˆ†automatic-differentiation","heading":4,"title":"3. è‡ªåŠ¨å¾®åˆ†ï¼ˆAutomatic Differentiationï¼‰","children":[],"id":"3-è‡ªåŠ¨å¾®åˆ†automatic-differentiation"}],"id":"ä¸€æ—¶é—´å¤æ‚åº¦è®¡ç®—åŸç†"},{"key":"äºŒç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†","href":"#äºŒç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†","heading":3,"title":"äºŒã€ç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†","children":[{"key":"å¯¹æ¯”è¡¨æ ¼","href":"#å¯¹æ¯”è¡¨æ ¼","heading":4,"title":"å¯¹æ¯”è¡¨æ ¼","children":[],"id":"å¯¹æ¯”è¡¨æ ¼"}],"id":"äºŒç©ºé—´å¤æ‚åº¦è®¡ç®—åŸç†"},{"key":"ä¸‰æ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•","href":"#ä¸‰æ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•","heading":3,"title":"ä¸‰ã€æ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•","children":[{"key":"1-æ•°å€¼å¾®åˆ†ç¨³å®šæ€§","href":"#1-æ•°å€¼å¾®åˆ†ç¨³å®šæ€§","heading":4,"title":"1. æ•°å€¼å¾®åˆ†ç¨³å®šæ€§","children":[],"id":"1-æ•°å€¼å¾®åˆ†ç¨³å®šæ€§"},{"key":"2-ç¬¦å·å¾®åˆ†ç¨³å®šæ€§","href":"#2-ç¬¦å·å¾®åˆ†ç¨³å®šæ€§","heading":4,"title":"2. ç¬¦å·å¾®åˆ†ç¨³å®šæ€§","children":[],"id":"2-ç¬¦å·å¾®åˆ†ç¨³å®šæ€§"},{"key":"3-è‡ªåŠ¨å¾®åˆ†ç¨³å®šæ€§","href":"#3-è‡ªåŠ¨å¾®åˆ†ç¨³å®šæ€§","heading":4,"title":"3. è‡ªåŠ¨å¾®åˆ†ç¨³å®šæ€§","children":[],"id":"3-è‡ªåŠ¨å¾®åˆ†ç¨³å®šæ€§"}],"id":"ä¸‰æ•°å€¼ç¨³å®šæ€§è¯„ä¼°æ–¹æ³•"},{"key":"å››ç»¼åˆå¯¹æ¯”ä¸å·¥ç¨‹é€‰æ‹©","href":"#å››ç»¼åˆå¯¹æ¯”ä¸å·¥ç¨‹é€‰æ‹©","heading":3,"title":"å››ã€ç»¼åˆå¯¹æ¯”ä¸å·¥ç¨‹é€‰æ‹©","children":[{"key":"1-æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘","href":"#1-æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘","heading":4,"title":"1. æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘","children":[],"id":"1-æ–¹æ³•é€‰æ‹©å†³ç­–æ ‘"},{"key":"2-å®é™…æ¡†æ¶å®ç°","href":"#2-å®é™…æ¡†æ¶å®ç°","heading":4,"title":"2. å®é™…æ¡†æ¶å®ç°","children":[],"id":"2-å®é™…æ¡†æ¶å®ç°"}],"id":"å››ç»¼åˆå¯¹æ¯”ä¸å·¥ç¨‹é€‰æ‹©"},{"key":"äº”æ·±åº¦å­¦ä¹ ä¸­çš„ç‰¹æ®Šè€ƒé‡","href":"#äº”æ·±åº¦å­¦ä¹ ä¸­çš„ç‰¹æ®Šè€ƒé‡","heading":3,"title":"äº”ã€æ·±åº¦å­¦ä¹ ä¸­çš„ç‰¹æ®Šè€ƒé‡","children":[{"key":"1-gpu-å†…å­˜ç“¶é¢ˆ","href":"#1-gpu-å†…å­˜ç“¶é¢ˆ","heading":4,"title":"1. GPU å†…å­˜ç“¶é¢ˆ","children":[],"id":"1-gpu-å†…å­˜ç“¶é¢ˆ"},{"key":"2-æ··åˆç²¾åº¦è®­ç»ƒ-1","href":"#2-æ··åˆç²¾åº¦è®­ç»ƒ-1","heading":4,"title":"2. æ··åˆç²¾åº¦è®­ç»ƒ","children":[],"id":"2-æ··åˆç²¾åº¦è®­ç»ƒ-1"}],"id":"äº”æ·±åº¦å­¦ä¹ ä¸­çš„ç‰¹æ®Šè€ƒé‡"},{"key":"å…­æ•°å­¦è¯æ˜ç¤ºä¾‹","href":"#å…­æ•°å­¦è¯æ˜ç¤ºä¾‹","heading":3,"title":"å…­ã€æ•°å­¦è¯æ˜ç¤ºä¾‹","children":[{"key":"æ•°å€¼å¾®åˆ†è¯¯å·®åˆ†æ","href":"#æ•°å€¼å¾®åˆ†è¯¯å·®åˆ†æ","heading":4,"title":"æ•°å€¼å¾®åˆ†è¯¯å·®åˆ†æ","children":[],"id":"æ•°å€¼å¾®åˆ†è¯¯å·®åˆ†æ"}],"id":"å…­æ•°å­¦è¯æ˜ç¤ºä¾‹"},{"key":"ä¸ƒæ€»ç»“ç†è§£","href":"#ä¸ƒæ€»ç»“ç†è§£","heading":3,"title":"ä¸ƒã€æ€»ç»“ç†è§£","children":[],"id":"ä¸ƒæ€»ç»“ç†è§£"}],"id":"q-æ·±å…¥è®²è§£å‡ ç§å¾®åˆ†æ–¹æ³•çš„å¤æ‚åº¦ä¸æ•°å€¼ç¨³å®šæ€§"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2025-03-05-lora-matrix-initialization-strategy.md","pagePath":"/learn_from_ai/lora-matrix-initialization-strategy","slug":"lora-matrix-initialization-strategy"},"meta":{"content":"\n\u003e æœ¬æ–‡æ˜¯ä¸ Deepseek-R1 æ¨¡å‹+Search çš„å¯¹è¯è®°å½•ï¼Œè¯¦ç»†æ¢è®¨äº† LoRAï¼ˆä½ç§©é€‚åº”ï¼‰å¾®è°ƒæŠ€æœ¯ä¸­çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥çš„æ•°å­¦åŸç†ã€‚æ–‡ç« åˆ†æäº†ä¸ºä»€ä¹ˆåœ¨ LoRA ä¸­çŸ©é˜µ A é‡‡ç”¨éšæœºåˆå§‹åŒ–è€ŒçŸ©é˜µ B é‡‡ç”¨é›¶åˆå§‹åŒ–çš„åŸå› ï¼ŒåŒ…æ‹¬ä¿æŒåˆå§‹æ¨¡å‹ç¨³å®šæ€§ã€ç¡®ä¿æ¢¯åº¦æ›´æ–°æœ‰æ•ˆæ€§ã€å®ç°é€æ­¥å­¦ä¹ çš„ä½ç§©æ›´æ–°ç­‰æ–¹é¢ã€‚åŒæ—¶ï¼Œæ–‡ç« ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåå‘åˆå§‹åŒ–ç­–ç•¥ï¼ˆBéšæœºè€ŒAä¸ºé›¶ï¼‰åœ¨ç†è®ºä¸Šå­˜åœ¨é—®é¢˜ï¼Œä¼šå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±å’Œè®­ç»ƒæ•ˆç‡ä¸‹é™ã€‚è¿™äº›åˆ†ææœ‰åŠ©äºç†è§£æ·±åº¦å­¦ä¹ ä¸­å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯çš„è®¾è®¡åŸç†ã€‚\n\n## Q: åˆå§‹åŒ– LoRA æ—¶ï¼Œä¸ºä»€ä¹ˆ A çŸ©é˜µæ˜¯éšæœºåˆå§‹åŒ–è€Œ B çŸ©é˜µæ˜¯ 0 åˆå§‹åŒ–ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e å—¯ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºLoRAï¼ˆä½ç§©é€‚åº”ï¼‰åˆå§‹åŒ–çš„ã€‚ä¸ºä»€ä¹ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒçŸ©é˜µAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œè€ŒçŸ©é˜µBæ˜¯é›¶åˆå§‹åŒ–çš„å‘¢ï¼Ÿæˆ‘éœ€è¦ä»”ç»†æ€è€ƒä¸€ä¸‹ã€‚\n\u003e\n\u003e é¦–å…ˆï¼Œæˆ‘åº”è¯¥å›å¿†ä¸€ä¸‹LoRAçš„åŸºæœ¬åŸç†ã€‚LoRAæ˜¯ä¸€ç§ç”¨äºå¾®è°ƒå¤§å‹é¢„è®­ç»ƒæ¨¡å‹çš„æŠ€æœ¯ï¼Œå®ƒé€šè¿‡ä½ç§©åˆ†è§£æ¥å‡å°‘å¯è®­ç»ƒå‚æ•°çš„æ•°é‡ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºé¢„è®­ç»ƒæ¨¡å‹ä¸­çš„æŸä¸ªæƒé‡çŸ©é˜µWï¼ŒLoRAå¼•å…¥ä¸¤ä¸ªè¾ƒå°çš„çŸ©é˜µAå’ŒBï¼Œä½¿å¾—åŸæ¥çš„æƒé‡æ›´æ–°Î”Wå¯ä»¥è¡¨ç¤ºä¸ºBAã€‚è¿™æ ·ï¼Œè®­ç»ƒçš„æ—¶å€™åªéœ€è¦æ›´æ–°Aå’ŒBï¼Œè€Œä¸æ˜¯æ•´ä¸ªWï¼Œä»è€ŒèŠ‚çœäº†è®¡ç®—èµ„æºå’Œå†…å­˜ã€‚\n\u003e\n\u003e é‚£é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆåˆå§‹åŒ–çš„æ—¶å€™ï¼ŒAæ˜¯éšæœºçš„ï¼Œè€ŒBæ˜¯é›¶å‘¢ï¼Ÿå¯èƒ½çš„è§£é‡Šæ˜¯ï¼Œè¿™æ ·åˆå§‹åŒ–åï¼Œåˆå§‹çš„Î”Wï¼ˆå³BAï¼‰æ˜¯é›¶çŸ©é˜µï¼Œè¿™æ ·åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œæ¨¡å‹çš„è¡Œä¸ºå’ŒåŸå§‹é¢„è®­ç»ƒæ¨¡å‹ä¿æŒä¸€è‡´ï¼Œä¸ä¼šå› ä¸ºéšæœºåˆå§‹åŒ–å¸¦æ¥å¤§çš„æ‰°åŠ¨ã€‚å› ä¸ºå¦‚æœBåˆå§‹åŒ–ä¸ºé›¶ï¼Œæ— è®ºAæ˜¯ä»€ä¹ˆï¼ŒBAéƒ½æ˜¯é›¶ï¼Œæ‰€ä»¥Î”Wåˆå§‹ä¸ºé›¶ï¼Œè¿™æ ·æ¨¡å‹çš„åˆå§‹è¾“å‡ºä¸ä¼šæ”¹å˜ï¼Œä¿è¯äº†è®­ç»ƒçš„ç¨³å®šæ€§ã€‚\n\u003e\n\u003e ä¸è¿‡ï¼Œè¿™é‡Œå¯èƒ½æœ‰ä¸€ä¸ªç–‘é—®ï¼šå¦‚æœBåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¢¯åº¦æ˜¯å¦‚ä½•æ›´æ–°çš„å‘¢ï¼Ÿå› ä¸ºå¦‚æœBä¸€å¼€å§‹æ˜¯é›¶ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡åå‘ä¼ æ’­æ—¶ï¼ŒBçš„æ¢¯åº¦å¯èƒ½ä¾èµ–äºAçš„å€¼ã€‚è€ŒAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œæ‰€ä»¥å¯èƒ½æ¢¯åº¦ä¼šæœ‰å˜åŒ–ã€‚ä¸è¿‡ï¼Œå› ä¸ºAæ˜¯éšæœºçš„ï¼Œåˆå§‹çš„BAæ˜¯é›¶ï¼Œè¿™æ ·åœ¨ç¬¬ä¸€æ¬¡å‰å‘ä¼ æ’­æ—¶ï¼ŒÎ”Wä¸å½±å“åŸå§‹æƒé‡ï¼Œå› æ­¤æŸå¤±å‡½æ•°å’ŒåŸå§‹æ¨¡å‹ä¸€æ ·ï¼Œæ¢¯åº¦å¯èƒ½ä»è¯¯å·®ä¿¡å·å¼€å§‹ç´¯ç§¯ï¼Œé€æ­¥è°ƒæ•´Aå’ŒBçš„å‚æ•°ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œå¯èƒ½è¿˜æœ‰å‚æ•°æ›´æ–°çš„è€ƒè™‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœAæ˜¯éšæœºåˆå§‹åŒ–ï¼ŒBåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆåœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œå‚æ•°çš„å˜åŒ–ä»é›¶å¼€å§‹é€æ­¥å¢åŠ ï¼Œè¿™ç±»ä¼¼äºæ®‹å·®è¿æ¥çš„æ€æƒ³ï¼Œå³åˆå§‹æ—¶æ²¡æœ‰æ”¹å˜ï¼Œç„¶åé€æ¸å­¦ä¹ è°ƒæ•´ã€‚è¿™æœ‰åŠ©äºè®­ç»ƒçš„ç¨³å®šæ€§ï¼Œé¿å…äº†åˆå§‹é˜¶æ®µçš„å¤§å¹…åº¦æ³¢åŠ¨ã€‚\n\u003e\n\u003e å†æƒ³ä¸€ä¸‹ï¼Œå¦‚æœåè¿‡æ¥ï¼ŒæŠŠAåˆå§‹åŒ–ä¸ºé›¶ï¼ŒBéšæœºåˆå§‹åŒ–ï¼Œé‚£ä¹ˆÎ”Wä¸€å¼€å§‹å°±æ˜¯é›¶ï¼Œå› ä¸ºAæ˜¯é›¶ï¼Œè¿™æ ·å¯èƒ½æ— æ³•æœ‰æ•ˆè®­ç»ƒï¼Œå› ä¸ºæ— è®ºBå¦‚ä½•å˜åŒ–ï¼Œå¦‚æœAæ˜¯é›¶çš„è¯ï¼ŒÎ”Wå§‹ç»ˆæ˜¯é›¶ï¼Œé™¤éAè¢«æ›´æ–°ã€‚ä½†é€šå¸¸æ¥è¯´ï¼Œå‚æ•°éœ€è¦ä¸€å®šçš„éšæœºæ€§æ¥æ‰“ç ´å¯¹ç§°æ€§ï¼Œä½¿å¾—æ¢¯åº¦å¯ä»¥æœ‰æ•ˆåœ°æ›´æ–°ä¸åŒçš„å‚æ•°ã€‚æ‰€ä»¥å¯èƒ½å¦‚æœAåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆåç»­çš„æ›´æ–°å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼Œå› ä¸ºæ¢¯åº¦å¯èƒ½éœ€è¦åŒæ—¶æ›´æ–°Aå’ŒBæ‰èƒ½æœ‰æ•ˆï¼Œè€Œåˆå§‹æ—¶Açš„æ¢¯åº¦å¯èƒ½å¾ˆå°ï¼Œå¯¼è‡´è®­ç»ƒç¼“æ…¢ã€‚å› æ­¤ï¼Œå°†Aéšæœºåˆå§‹åŒ–ï¼ŒBåˆå§‹åŒ–ä¸ºé›¶ï¼Œå¯ä»¥ç¡®ä¿åˆå§‹çš„Î”Wä¸ºé›¶ï¼ŒåŒæ—¶Açš„éšæœºæ€§å…è®¸æ¢¯åº¦åœ¨åå‘ä¼ æ’­æ—¶æœ‰æ•ˆåœ°æ›´æ–°å‚æ•°ï¼Œè€Œä¸ä¼šå¯¼è‡´åˆå§‹é˜¶æ®µçš„å¤§åå·®ã€‚\n\u003e\n\u003e æ€»ç»“ä¸€ä¸‹ï¼Œå¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š\n\u003e\n\u003e 1. ä¿æŒåˆå§‹Î”Wä¸ºé›¶ï¼Œä½¿å¾—æ¨¡å‹å¼€å§‹è®­ç»ƒæ—¶å’ŒåŸå§‹é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´ï¼Œè®­ç»ƒç¨³å®šæ€§ã€‚\n\u003e\n\u003e 2. éšæœºåˆå§‹åŒ–Aå¯ä»¥æ‰“ç ´å¯¹ç§°æ€§ï¼Œå…è®¸æ¢¯åº¦æœ‰æ•ˆæ›´æ–°å‚æ•°ï¼Œè€ŒBåˆå§‹åŒ–ä¸ºé›¶åˆ™ä¿è¯åˆå§‹æ—¶æ²¡æœ‰æ”¹å˜æƒé‡ï¼Œè¿™æ ·è®­ç»ƒå¯ä»¥é€æ­¥è¿›è¡Œã€‚\n\u003e\n\u003e 3. å¦‚æœBåˆå§‹åŒ–ä¸ºéé›¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´åˆå§‹Î”Wä¸ä¸ºé›¶ï¼Œä»è€Œå¼•å…¥ä¸å¿…è¦çš„å™ªå£°ï¼Œå½±å“è®­ç»ƒåˆå§‹é˜¶æ®µçš„ç¨³å®šæ€§ã€‚\n\u003e\n\u003e å¯èƒ½è¿˜æœ‰å…¶ä»–åŸå› ï¼Œæ¯”å¦‚ä¼˜åŒ–å™¨çš„åŠ¨æ€ç‰¹æ€§ã€‚æ¯”å¦‚ï¼Œå¦‚æœä½¿ç”¨Adamè¿™æ ·çš„ä¼˜åŒ–å™¨ï¼Œå‚æ•°çš„åˆå§‹æ­¥é•¿å¯èƒ½ä¼šæ ¹æ®æ¢¯åº¦çš„å†å²è¿›è¡Œè°ƒæ•´ã€‚å¦‚æœBåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆåœ¨æœ€åˆçš„å‡ æ¬¡è¿­ä»£ä¸­ï¼ŒBçš„æ¢¯åº¦å¯èƒ½ä¼šè¾ƒå°ï¼Œä»è€Œè°ƒæ•´å…¶å­¦ä¹ ç‡ï¼Œè€ŒAçš„éšæœºåˆå§‹åŒ–å¯èƒ½æœ‰åŠ©äºæ¢¯åº¦æ–¹å‘çš„å¤šæ ·æ€§ï¼Œä¿ƒè¿›æœ‰æ•ˆçš„å‚æ•°æ›´æ–°ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œè¿˜éœ€è¦è€ƒè™‘çŸ©é˜µä¹˜æ³•çš„é¡ºåºã€‚åœ¨LoRAä¸­ï¼ŒÎ”W = B*Aï¼Œå‡è®¾Açš„ç»´åº¦æ˜¯dÃ—rï¼ŒBçš„ç»´åº¦æ˜¯rÃ—dï¼Œé‚£ä¹ˆBAçš„ä¹˜ç§¯æ˜¯dÃ—dçš„çŸ©é˜µï¼Œä¸åŸæƒé‡çŸ©é˜µWçš„å¤§å°ç›¸åŒã€‚å½“Båˆå§‹åŒ–ä¸ºé›¶æ—¶ï¼Œæ— è®ºAçš„å€¼å¦‚ä½•ï¼ŒÎ”Wéƒ½æ˜¯é›¶ï¼Œè¿™æ ·åˆå§‹çš„æ¨¡å‹è¾“å‡ºä¸ä¼šæ”¹å˜ã€‚ç„¶åï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒæ•´Bå’ŒAæ¥é€æ¸å­¦ä¹ Î”Wã€‚è¿™å¯èƒ½æ¯”åŒæ—¶éšæœºåˆå§‹åŒ–ä¸¤è€…æ›´ç¨³å®šï¼Œå› ä¸ºå¦‚æœä¸¤è€…éƒ½éšæœºåˆå§‹åŒ–ï¼ŒÎ”Wå¯èƒ½ä¼šæœ‰ä¸€ä¸ªè¾ƒå¤§çš„åˆå§‹å€¼ï¼Œå½±å“æ¨¡å‹çš„åˆå§‹è¡¨ç°ã€‚\n\u003e\n\u003e ä¾‹å¦‚ï¼Œå‡è®¾Aå’ŒBéƒ½æ˜¯éšæœºé«˜æ–¯åˆå§‹åŒ–ï¼Œå‡å€¼ä¸º0ï¼Œæ ‡å‡†å·®ä¸ºÏƒã€‚é‚£ä¹ˆBAçš„å…ƒç´ å°†æ˜¯ä¸¤ä¸ªç‹¬ç«‹é«˜æ–¯å˜é‡çš„ä¹˜ç§¯ä¹‹å’Œï¼Œè¿™å¯èƒ½ä¼šæœ‰è¾ƒå¤§çš„æ–¹å·®ï¼Œå¯¼è‡´Î”Wçš„åˆå§‹å€¼è¾ƒå¤§ï¼Œå¯èƒ½å¹²æ‰°é¢„è®­ç»ƒæ¨¡å‹çš„åŸå§‹æƒé‡ï¼Œå¯¼è‡´è®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šã€‚è€Œå°†Båˆå§‹åŒ–ä¸ºé›¶ï¼Œåˆ™é¿å…äº†è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåˆå§‹æ—¶Î”Wä¸ºé›¶ï¼Œä¹‹åéšç€è®­ç»ƒé€æ¸è°ƒæ•´ï¼Œè¿™æ ·æ›´å®‰å…¨ã€‚\n\u003e\n\u003e æ­¤å¤–ï¼Œè¿™ç§åˆå§‹åŒ–æ–¹å¼å¯èƒ½ç±»ä¼¼äºæ®‹å·®ç½‘ç»œä¸­çš„æ®‹å·®å—åˆå§‹åŒ–ï¼Œå°†æ®‹å·®è·¯å¾„åˆå§‹åŒ–ä¸ºé›¶ï¼Œä½¿å¾—åˆå§‹é˜¶æ®µç½‘ç»œä¸»è¦ä¾èµ–åŸå§‹è·¯å¾„ï¼Œç„¶åé€æ­¥å­¦ä¹ æ®‹å·®è°ƒæ•´ã€‚ç±»ä¼¼çš„æ€è·¯å¯èƒ½è¢«åº”ç”¨åˆ°äº†LoRAä¸­ï¼Œå³åˆå§‹æ—¶ä¸æ”¹å˜åŸæ¨¡å‹ï¼Œé€æ­¥è¿›è¡Œä½ç§©è°ƒæ•´ã€‚\n\u003e\n\u003e è¿˜æœ‰ä¸€ä¸ªè§’åº¦æ˜¯å‚æ•°çš„æ¢¯åº¦è®¡ç®—ã€‚å½“Båˆå§‹åŒ–ä¸ºé›¶æ—¶ï¼Œç¬¬ä¸€æ¬¡å‰å‘ä¼ æ’­ä¸­ï¼ŒBAä¸ºé›¶ï¼Œå› æ­¤åœ¨åå‘ä¼ æ’­æ—¶ï¼ŒæŸå¤±å‡½æ•°å¯¹Bçš„æ¢¯åº¦å°†ä¾èµ–äºAçš„å€¼ã€‚ç”±äºAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œè¿™æ ·Bçš„æ¢¯åº¦ä¼šæœ‰ä¸€å®šçš„æ–¹å‘æ€§ï¼Œä»è€Œå…è®¸Bè¢«æœ‰æ•ˆåœ°æ›´æ–°ã€‚ç›¸åï¼Œå¦‚æœAåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆBçš„æ¢¯åº¦ä¹Ÿä¼šæ˜¯é›¶ï¼Œå¯¼è‡´æ— æ³•æ›´æ–°å‚æ•°ã€‚å› æ­¤ï¼Œå¿…é¡»å°†Aéšæœºåˆå§‹åŒ–ï¼Œä»¥ä¾¿åœ¨ç¬¬ä¸€æ¬¡åå‘ä¼ æ’­æ—¶ï¼ŒBèƒ½å¤Ÿè·å¾—æœ‰æ•ˆçš„æ¢¯åº¦ã€‚\n\u003e\n\u003e ä¾‹å¦‚ï¼Œå‡è®¾æŸå¤±å‡½æ•°Lå¯¹Bçš„æ¢¯åº¦æ˜¯âˆ‚L/âˆ‚B = (âˆ‚L/âˆ‚(BA)) * A^Tã€‚å¦‚æœAåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆæ¢¯åº¦âˆ‚L/âˆ‚Bä¹Ÿä¸ºé›¶ï¼Œå¯¼è‡´Bæ— æ³•è¢«æ›´æ–°ã€‚è€Œå¦‚æœAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œåˆ™æ¢¯åº¦ä¸ä¸ºé›¶ï¼Œå…è®¸Bè¢«æ›´æ–°ã€‚åŒæ—¶ï¼ŒBåˆå§‹åŒ–ä¸ºé›¶ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶ï¼ŒBçš„å€¼ä¼šæ ¹æ®æ¢¯åº¦è°ƒæ•´ï¼Œè€ŒAä¹Ÿä¼šæ ¹æ®æ¢¯åº¦è¿›è¡Œæ›´æ–°ã€‚è¿™æ ·ï¼Œä¸¤è€…å¯ä»¥ååŒå·¥ä½œï¼Œé€æ¸æ„å»ºå‡ºæœ‰æ•ˆçš„ä½ç§©æ›´æ–°çŸ©é˜µã€‚\n\u003e\n\u003e å› æ­¤ï¼Œæ€»ç»“å¯èƒ½çš„åŸå› ï¼š\n\u003e\n\u003e - ä¿æŒåˆå§‹Î”Wä¸ºé›¶ï¼Œç»´æŒé¢„è®­ç»ƒæ¨¡å‹çš„åˆå§‹è¡¨ç°ï¼Œä¿è¯è®­ç»ƒç¨³å®šæ€§ã€‚\n\u003e\n\u003e - éšæœºåˆå§‹åŒ–Aæ‰“ç ´å¯¹ç§°æ€§ï¼Œå…è®¸æ¢¯åº¦æœ‰æ•ˆæ›´æ–°Bçš„å‚æ•°ã€‚\n\u003e\n\u003e - é¿å…åˆå§‹Î”Wçš„éšæœºæ€§å¸¦æ¥çš„å¹²æ‰°ï¼Œåªé€šè¿‡è®­ç»ƒè¿‡ç¨‹é€æ­¥è°ƒæ•´ã€‚\n\u003e\n\u003e - å¦‚æœAåˆå§‹åŒ–ä¸ºéé›¶è€ŒBä¸ºé›¶ï¼Œè¿™æ ·BAä¸ºé›¶ï¼ŒåŒæ—¶å…è®¸æ¢¯åº¦åœ¨åå‘ä¼ æ’­æ—¶æœ‰æ•ˆä¼ é€’åˆ°Bï¼Œä»è€Œå¯åŠ¨è®­ç»ƒè¿‡ç¨‹ã€‚\n\u003e\n\u003e å¯èƒ½è¿˜æœ‰å…¶ä»–å› ç´ ï¼Œæ¯”å¦‚å®ç°ä¸Šçš„ç®€ä¾¿æ€§ï¼Œæˆ–è€…å®éªŒéªŒè¯è¿‡è¿™ç§åˆå§‹åŒ–æ–¹å¼çš„æ•ˆæœæ›´å¥½ã€‚ä½†æ ¸å¿ƒçš„æ•°å­¦å’Œä¼˜åŒ–åŸå› åº”è¯¥æ˜¯ä¸Šè¿°å‡ ç‚¹ã€‚\n\nåœ¨åˆå§‹åŒ–LoRAï¼ˆä½ç§©é€‚åº”ï¼‰æ—¶ï¼ŒçŸ©é˜µAé‡‡ç”¨éšæœºåˆå§‹åŒ–è€ŒçŸ©é˜µBåˆå§‹åŒ–ä¸ºé›¶ï¼Œä¸»è¦åŸå› å¦‚ä¸‹ï¼š\n\n1. **ä¿æŒåˆå§‹æ¨¡å‹ç¨³å®šæ€§**ï¼š  \n   å½“Båˆå§‹åŒ–ä¸ºé›¶æ—¶ï¼Œæ— è®ºAçš„å€¼å¦‚ä½•ï¼Œä½ç§©æ›´æ–°çŸ©é˜µÎ”W = BAåˆå§‹å€¼ä¸ºé›¶ã€‚è¿™ä½¿å¾—å¾®è°ƒå¼€å§‹æ—¶ï¼Œæ¨¡å‹çš„è¾“å‡ºä¸åŸå§‹é¢„è®­ç»ƒæ¨¡å‹å®Œå…¨ä¸€è‡´ï¼Œé¿å…äº†åˆå§‹é˜¶æ®µå› éšæœºæ‰°åŠ¨å¯¼è‡´çš„æ€§èƒ½æ³¢åŠ¨ï¼Œç¡®ä¿äº†è®­ç»ƒçš„ç¨³å®šæ€§ã€‚\n\n2. **æ¢¯åº¦æ›´æ–°çš„æœ‰æ•ˆæ€§**ï¼š  \n   éšæœºåˆå§‹åŒ–Aèƒ½å¤Ÿæ‰“ç ´å¯¹ç§°æ€§ï¼Œä½¿å¾—åå‘ä¼ æ’­æ—¶Bçš„æ¢¯åº¦ä¾èµ–äºAçš„éšæœºåˆå§‹å€¼ï¼ˆâˆ‚L/âˆ‚B = (âˆ‚L/âˆ‚Î”W) Â· Aáµ€ï¼‰ã€‚è‹¥Aåˆå§‹åŒ–ä¸ºé›¶ï¼ŒBçš„æ¢¯åº¦å°†ä¸ºé›¶ï¼Œå¯¼è‡´è®­ç»ƒæ— æ³•å¯åŠ¨ï¼›è€ŒéšæœºAä¸ºéé›¶ï¼Œä½¿å¾—Bçš„æ¢¯åº¦åœ¨ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶å³å¯æœ‰æ•ˆè°ƒæ•´ã€‚\n\n3. **é€æ­¥å­¦ä¹ ä½ç§©æ›´æ–°**ï¼š  \n   é€šè¿‡Båˆå§‹ä¸ºé›¶ï¼ŒÎ”Wä»é›¶å¼€å§‹é€æ­¥ç§¯ç´¯æ›´æ–°é‡ï¼Œç±»ä¼¼äºæ®‹å·®å­¦ä¹ çš„æ€æƒ³ã€‚è¿™ç§ç­–ç•¥è®©æ¨¡å‹ä¼˜å…ˆä¾èµ–é¢„è®­ç»ƒæƒé‡ï¼Œå†é€æ¸å­¦ä¹ ä½ç§©è°ƒæ•´ï¼Œé¿å…äº†åˆå§‹è¾ƒå¤§çš„éšæœºÎ”Wå¯¹é¢„è®­ç»ƒçŸ¥è¯†çš„å¹²æ‰°ã€‚\n\n4. **ä¼˜åŒ–åŠ¨æ€çš„åˆç†æ€§**ï¼š  \n   è‹¥Aå’ŒBå‡éšæœºåˆå§‹åŒ–ï¼ŒÎ”Wçš„åˆå§‹å€¼å¯èƒ½å…·æœ‰è¾ƒå¤§çš„æ–¹å·®ï¼Œå¼•å…¥ä¸å¿…è¦çš„å™ªå£°ã€‚è€ŒBåˆå§‹ä¸ºé›¶æ—¶ï¼ŒÎ”Wçš„åˆå§‹æ–¹å·®ä¸ºé›¶ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­é€šè¿‡ååŒä¼˜åŒ–Aå’ŒBé€æ­¥å¼•å…¥æ›´æ–°ï¼Œæ›´ç¬¦åˆä½ç§©é€‚åº”çš„è®¾è®¡ç›®æ ‡ã€‚\n\nç»¼ä¸Šï¼Œè¿™ç§åˆå§‹åŒ–æ–¹å¼åœ¨æ•°å­¦ä¸Šç¡®ä¿äº†è®­ç»ƒçš„é«˜æ•ˆå¯åŠ¨ï¼ŒåŒæ—¶åœ¨å·¥ç¨‹å®è·µä¸­æå‡äº†å¾®è°ƒçš„ç¨³å®šæ€§å’Œæ•ˆæœã€‚\n\n## Q: BçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒAçŸ©é˜µåˆå§‹åŒ–æ—¶è®¾ä¸º 0 ä¸è¡Œå—ï¼Ÿ\n\n\u003e [!reasoning]-\n\u003e å¥½çš„ï¼Œç”¨æˆ·é—®å¦‚æœBçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒAçŸ©é˜µåˆå§‹åŒ–ä¸º0è¡Œä¸è¡Œã€‚æˆ‘éœ€è¦ä»”ç»†åˆ†æè¿™ä¸ªé—®é¢˜ã€‚é¦–å…ˆï¼Œå›æƒ³ä¸€ä¸‹ä¹‹å‰çš„å¯¹è¯ï¼Œç”¨æˆ·å·²ç»äº†è§£äº†LoRAåˆå§‹åŒ–æ—¶Aéšæœºï¼ŒBä¸º0çš„åŸå› ã€‚ç°åœ¨ä»–æƒ³åè¿‡æ¥ï¼Œå¯èƒ½æ˜¯åœ¨æ€è€ƒæ˜¯å¦æœ‰å…¶ä»–å¯èƒ½æ€§ã€‚\n\u003e\n\u003e æˆ‘éœ€è¦ä»åŸç†å‡ºå‘ï¼Œè€ƒè™‘è¿™ç§åˆå§‹åŒ–æ–¹å¼å¯¹è®­ç»ƒçš„å½±å“ã€‚å¦‚æœAåˆå§‹åŒ–ä¸º0ï¼Œé‚£ä¹ˆÎ”W = BAå°±ä¼šå˜æˆBä¹˜ä»¥0çŸ©é˜µï¼Œä¹Ÿå°±æ˜¯å…¨0ã€‚è¿™æ ·åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œå¾®è°ƒçš„æ¨¡å—ä¸ä¼šå¯¹åŸæ¨¡å‹äº§ç”Ÿå½±å“ï¼Œå’Œä¹‹å‰çš„æƒ…å†µç±»ä¼¼ã€‚ä½†æ˜¯è¿™é‡Œçš„å…³é”®æ˜¯æ¢¯åº¦å¦‚ä½•ä¼ æ’­ã€‚\n\u003e\n\u003e æ ¹æ®é“¾å¼æ³•åˆ™ï¼Œæ¢¯åº¦ä¼šä»æŸå¤±å‡½æ•°ä¼ åˆ°Î”Wï¼Œç„¶ååˆ†è§£åˆ°Bå’ŒAã€‚å¯¹äºAçš„æ¢¯åº¦æ˜¯Bçš„è½¬ç½®ä¹˜ä»¥Î”Wçš„æ¢¯åº¦ï¼Œè€ŒBçš„æ¢¯åº¦æ˜¯Î”Wçš„æ¢¯åº¦ä¹˜ä»¥Açš„è½¬ç½®ã€‚å¦‚æœAåˆå§‹ä¸º0ï¼Œé‚£ä¹ˆåœ¨ç¬¬ä¸€æ¬¡åå‘ä¼ æ’­æ—¶ï¼ŒBçš„æ¢¯åº¦ä¼šæ˜¯Î”Wçš„æ¢¯åº¦ä¹˜ä»¥0çŸ©é˜µï¼Œå¯¼è‡´Bçš„æ¢¯åº¦ä¸º0ã€‚è¿™æ—¶å€™Bæ— æ³•è¢«æ›´æ–°ï¼Œæ•´ä¸ªè®­ç»ƒå°±å¡ä½äº†ã€‚\n\u003e\n\u003e å¦å¤–ï¼ŒAçš„å‚æ•°å¦‚æœåˆå§‹ä¸º0ï¼Œåœ¨ç¬¬ä¸€æ¬¡å‰å‘æ—¶ï¼ŒÎ”Wæ˜¯0ï¼Œæ‰€ä»¥æ²¡é—®é¢˜ã€‚ä½†æ˜¯ç¬¬ä¸€æ¬¡åå‘ä¼ æ’­æ—¶ï¼ŒAçš„æ¢¯åº¦æ˜¯Bè½¬ç½®ä¹˜ä»¥Î”Wçš„æ¢¯åº¦ã€‚å¦‚æœBæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œè¿™æ—¶å€™Açš„æ¢¯åº¦å¯èƒ½ä¼šæœ‰å€¼ï¼Œå¯ä»¥æ›´æ–°Aã€‚ä½†é—®é¢˜åœ¨äºï¼Œå½“Aè¢«æ›´æ–°åï¼Œä¸‹ä¸€æ¬¡å‰å‘æ—¶Î”W = B*Aä¼šæœ‰å˜åŒ–ã€‚ä½†è¿™é‡Œå¯èƒ½æœ‰ä¸€ä¸ªé¡ºåºé—®é¢˜ï¼Œæ¯”å¦‚ç¬¬ä¸€æ¬¡è¿­ä»£æ—¶Aæ˜¯0ï¼Œå¯¼è‡´Î”Wä¸º0ï¼ŒBçš„æ¢¯åº¦æ— æ³•æ›´æ–°ï¼Œè€ŒAçš„æ¢¯åº¦å¯èƒ½æœ‰æ•ˆï¼Œä½†ä¹‹åAè¢«æ›´æ–°åï¼ŒBæ‰ä¼šæœ‰æœºä¼šæ›´æ–°ã€‚è¿™æ—¶å€™æ˜¯å¦ä¼šå¯¼è‡´è®­ç»ƒä¸ç¨³å®šï¼Ÿ\n\u003e\n\u003e å¯èƒ½éœ€è¦æ›´ä»”ç»†åœ°åˆ†ææ¢¯åº¦æµã€‚å‡è®¾Aåˆå§‹ä¸º0ï¼ŒBéšæœºã€‚ç¬¬ä¸€æ¬¡å‰å‘æ—¶ï¼ŒÎ”W=0ï¼Œä¸å½±å“æ¨¡å‹è¾“å‡ºã€‚åå‘ä¼ æ’­æ—¶ï¼Œè®¡ç®—æ¢¯åº¦ï¼Œå¯¹Açš„æ¢¯åº¦æ˜¯âˆ‚L/âˆ‚A = B^T * âˆ‚L/âˆ‚Î”Wã€‚è€ŒBçš„æ¢¯åº¦æ˜¯âˆ‚L/âˆ‚B = âˆ‚L/âˆ‚Î”W * A^Tã€‚å› ä¸ºAåˆå§‹ä¸º0ï¼Œæ‰€ä»¥âˆ‚L/âˆ‚Bä¼šæ˜¯0ï¼Œå¯¼è‡´Båœ¨ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶æ— æ³•è¢«ä¼˜åŒ–ã€‚è€ŒAçš„æ¢¯åº¦åˆ™å–å†³äºBçš„åˆå§‹å€¼å’ŒÎ”Wçš„æ¢¯åº¦ã€‚å¦‚æœBæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œé‚£ä¹ˆAçš„æ¢¯åº¦ä¸ä¸º0ï¼Œå¯ä»¥æ›´æ–°Aã€‚è¿™æ ·åœ¨ç¬¬äºŒæ¬¡å‰å‘æ—¶ï¼ŒAå·²ç»ä¸æ˜¯0äº†ï¼ŒÎ”W=B*Aä¼šæœ‰éé›¶å€¼ï¼Œæ­¤æ—¶Bçš„æ¢¯åº¦ä¹Ÿä¼šå¼€å§‹æ›´æ–°ã€‚\n\u003e\n\u003e è¿™æ ·çœ‹èµ·æ¥å¯èƒ½å¯è¡Œï¼Œä½†å­˜åœ¨ä»€ä¹ˆé—®é¢˜å—ï¼Ÿæ¯”å¦‚è®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šï¼Œæˆ–è€…éœ€è¦æ›´å¤šçš„è¿­ä»£æ‰èƒ½å¯åŠ¨ã€‚ä¸è¿‡åŸæ¥çš„æ–¹æ³•ä¸­ï¼ŒBåˆå§‹ä¸º0ï¼ŒAéšæœºï¼Œå¯ä»¥ä¿è¯Î”Wåˆå§‹ä¸º0ï¼ŒåŒæ—¶Bçš„æ¢¯åº¦åœ¨ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶å°±å¯ä»¥é€šè¿‡Açš„éšæœºå€¼å¾—åˆ°æœ‰æ•ˆæ›´æ–°ã€‚è€Œåè¿‡æ¥ï¼ŒAåˆå§‹ä¸º0ï¼ŒBéšæœºï¼Œå¯¼è‡´Î”Wåˆå§‹ä¸º0ï¼Œä½†Bçš„æ¢¯åº¦åœ¨ç¬¬ä¸€æ¬¡æ— æ³•æ›´æ–°ï¼Œè€ŒAå¯ä»¥æ›´æ–°ã€‚è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£åï¼ŒAæœ‰äº†æ›´æ–°å€¼ï¼Œç¬¬äºŒæ¬¡Bæ‰èƒ½å¼€å§‹æ›´æ–°ã€‚è¿™æ ·å¯èƒ½éœ€è¦å¤šä¸€ä¸ªæ­¥éª¤æ‰èƒ½è®©ä¸¤ä¸ªçŸ©é˜µéƒ½å¼€å§‹å­¦ä¹ ï¼Œå¯èƒ½å½±å“æ”¶æ•›é€Ÿåº¦ã€‚\n\u003e\n\u003e å¦å¤–ï¼Œå½“Aåˆå§‹ä¸º0ï¼ŒBéšæœºæ—¶ï¼Œè™½ç„¶Î”Wåˆå§‹ä¸º0ï¼Œä½†æ­¤æ—¶Açš„æ¢¯åº¦ä¾èµ–äºBçš„éšæœºå€¼ï¼Œå¯èƒ½å¯¼è‡´Açš„åˆå§‹æ›´æ–°æ–¹å‘å¸¦æœ‰è¾ƒå¤§çš„éšæœºæ€§ï¼Œè€ŒBæœ¬èº«æ²¡æœ‰è¢«è°ƒæ•´ï¼Œè¿™æ ·å¯èƒ½ä¼šå¼•å…¥æ›´å¤šçš„å™ªå£°ï¼Œå½±å“è®­ç»ƒçš„ç¨³å®šæ€§ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒåŸæ¥çš„æ–¹æ³•ä¸­ï¼ŒAéšæœºï¼ŒBä¸º0ï¼Œè¿™æ ·Î”Wåˆå§‹ä¸º0ï¼Œè€ŒBçš„æ¢¯åº¦ç›´æ¥ç”±Açš„éšæœºå€¼å’ŒæŸå¤±æ¢¯åº¦å†³å®šï¼Œå¯èƒ½æ›´æœ‰æ•ˆã€‚\n\u003e\n\u003e å†è€ƒè™‘ä¼˜åŒ–åŠ¨æ€ï¼ŒåŸæ¥çš„æ–¹æ³•ä¸­ï¼ŒBåˆå§‹ä¸º0ï¼Œæ„å‘³ç€åœ¨åˆå§‹é˜¶æ®µï¼Œåªæœ‰Açš„éšæœºæ€§è¢«å¼•å…¥ï¼Œä½†é€šè¿‡æ¢¯åº¦ä¸‹é™ï¼ŒBå¯ä»¥å¿«é€Ÿè°ƒæ•´ã€‚è€Œåè¿‡æ¥ï¼ŒAåˆå§‹ä¸º0ï¼ŒBéšæœºï¼Œè™½ç„¶Î”Wåˆå§‹ä¸º0ï¼Œä½†Açš„æ›´æ–°å¯èƒ½æ›´å¿«åœ°å¼•å…¥å˜åŒ–ï¼Œè€ŒBçš„è°ƒæ•´æ»åï¼Œå¯èƒ½å¯¼è‡´è®­ç»ƒåˆæœŸçš„ä¸ç¨³å®šã€‚\n\u003e\n\u003e æ€»ç»“æ¥è¯´ï¼Œè™½ç„¶ç†è®ºä¸Šå¯èƒ½å­˜åœ¨å¯è¡Œçš„è·¯å¾„ï¼Œä½†å®é™…ä¸­åŸæ¥çš„åˆå§‹åŒ–æ–¹å¼åœ¨æ¢¯åº¦æ›´æ–°æ•ˆç‡å’Œç¨³å®šæ€§ä¸Šæ›´ä¼˜ã€‚å› æ­¤ï¼Œå°†Aéšæœºã€Båˆå§‹åŒ–ä¸º0æ˜¯æ›´åˆç†çš„é€‰æ‹©ï¼Œè€Œåè¿‡æ¥å¯èƒ½å¯¼è‡´è®­ç»ƒæ•ˆç‡ä½ä¸‹æˆ–æ”¶æ•›å›°éš¾ã€‚\n\nå°†çŸ©é˜µ **B** éšæœºåˆå§‹åŒ–è€ŒçŸ©é˜µ **A** åˆå§‹åŒ–ä¸ºé›¶ï¼Œåœ¨ç†è®ºä¸Šè™½ç„¶å¯èƒ½ï¼Œä½†ä¼šå¯¼è‡´è®­ç»ƒæ•ˆç‡æ˜¾è‘—ä¸‹é™ç”šè‡³å¤±è´¥ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åˆ†æï¼š\n\n---\n\n### **1. æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼šåå‘ä¼ æ’­çš„æ•°å­¦é™åˆ¶**\n- **å‰å‘ä¼ æ’­**ï¼šè‹¥ **A** åˆå§‹åŒ–ä¸ºé›¶ï¼Œåˆ™åˆå§‹çš„æƒé‡æ›´æ–°ä¸ºï¼š\n  $$\n  \\Delta W = B \\cdot A = B \\cdot 0 = 0\n  $$\n  æ­¤æ—¶æ¨¡å‹çš„è¾“å‡ºä¸åŸå§‹é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´ï¼Œä¸æ ‡å‡† LoRA åˆå§‹åŒ–ç±»ä¼¼ã€‚\n\n- **åå‘ä¼ æ’­**ï¼š\n  - **B çš„æ¢¯åº¦**ï¼š  \n    $$\n    \\frac{\\partial L}{\\partial B} = \\frac{\\partial L}{\\partial \\Delta W} \\cdot A^\\top\n    $$\n    ç”±äº **A** åˆå§‹åŒ–ä¸ºé›¶ï¼Œ**B** çš„æ¢¯åº¦åœ¨ç¬¬ä¸€æ¬¡æ›´æ–°æ—¶ç›´æ¥ä¸ºé›¶ï¼Œå¯¼è‡´ **B** æ— æ³•è¢«ä¼˜åŒ–ï¼ˆæ¢¯åº¦æ¶ˆå¤±ï¼‰ã€‚\n\n  - **A çš„æ¢¯åº¦**ï¼š  \n    $$\n    \\frac{\\partial L}{\\partial A} = B^\\top \\cdot \\frac{\\partial L}{\\partial \\Delta W}\n    $$\n    è™½ç„¶ **A** çš„æ¢¯åº¦ä¸ä¸ºé›¶ï¼ˆå–å†³äºéšæœºåˆå§‹åŒ–çš„ **B**ï¼‰ï¼Œä½† **A** çš„æ›´æ–°éœ€è¦ä¸ **B** çš„æ›´æ–°ååŒæ‰èƒ½æœ‰æ•ˆè°ƒæ•´æƒé‡ã€‚ç”±äº **B** åœ¨åˆå§‹é˜¶æ®µæ— æ³•æ›´æ–°ï¼Œ**A** çš„æ›´æ–°æ–¹å‘ä¼šå—é™äºåˆå§‹éšæœºçš„ **B**ï¼Œå¯¼è‡´ä¼˜åŒ–è¿‡ç¨‹ä¸ç¨³å®šã€‚\n\n---\n\n### **2. è®­ç»ƒæ•ˆç‡çš„æ˜¾è‘—ä¸‹é™**\n- **B çš„å»¶è¿Ÿæ›´æ–°**ï¼š  \n  ç”±äº **B** çš„æ¢¯åº¦åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æ—¶ä¸ºé›¶ï¼Œå¿…é¡»ç­‰å¾… **A** è¢«æ›´æ–°ä¸ºéé›¶å€¼åï¼Œ**B** çš„æ¢¯åº¦æ‰ä¼šå¼€å§‹æœ‰æ•ˆæ›´æ–°ã€‚è¿™ä¼šå¼•å…¥é¢å¤–çš„è®­ç»ƒå»¶è¿Ÿï¼Œæ˜¾è‘—é™ä½æ”¶æ•›é€Ÿåº¦ã€‚\n\n- **å‚æ•°è€¦åˆé—®é¢˜**ï¼š  \n  LoRA çš„æ ¸å¿ƒè®¾è®¡æ˜¯ **ä½ç§©åˆ†è§£**ï¼ˆ$$\\Delta W = BA$$ï¼‰ï¼Œå…¶æœ‰æ•ˆæ€§ä¾èµ–äº **A** å’Œ **B** çš„ååŒä¼˜åŒ–ã€‚è‹¥ **A** åˆå§‹ä¸ºé›¶ï¼Œä¸¤è€…çš„ä¼˜åŒ–åŠ¨æ€è¢«è§£è€¦ï¼š**A** çš„æ›´æ–°ä¾èµ–äºéšæœºåˆå§‹åŒ–çš„ **B**ï¼Œè€Œ **B** çš„æ›´æ–°åˆéœ€è¦ç­‰å¾… **A** è¢«è°ƒæ•´ã€‚è¿™ç§è€¦åˆæ–­è£‚ä¼šå¯¼è‡´è®­ç»ƒè¿‡ç¨‹ä½æ•ˆä¸”ä¸ç¨³å®šã€‚\n\n---\n\n### **3. ä¸æ ‡å‡† LoRA åˆå§‹åŒ–çš„å¯¹æ¯”**\n- **æ ‡å‡†åˆå§‹åŒ–ï¼ˆAéšæœºï¼ŒB=0ï¼‰çš„ä¼˜åŠ¿**ï¼š  \n  - **B çš„æ¢¯åº¦æœ‰æ•ˆå¯åŠ¨**ï¼š  \n    ç”±äº **A** éšæœºåˆå§‹åŒ–ï¼Œ**B** çš„æ¢¯åº¦ $$\\frac{\\partial L}{\\partial B} = \\frac{\\partial L}{\\partial \\Delta W} \\cdot A^\\top$$ åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æ—¶å³å¯éé›¶ï¼Œç¡®ä¿ **B** ç«‹å³å‚ä¸ä¼˜åŒ–ã€‚\n  - **å¯¹ç§°æ€§æ‰“ç ´**ï¼š  \n    **A** çš„éšæœºæ€§å¤©ç„¶æ‰“ç ´äº†å‚æ•°å¯¹ç§°æ€§ï¼Œé¿å…äº†æ¢¯åº¦å†²çªã€‚\n  - **ç¨³å®šçš„æ®‹å·®å­¦ä¹ **ï¼š  \n    $$\\Delta W$$ ä»é›¶å¼€å§‹é€æ­¥å¢é•¿ï¼Œç¬¦åˆæ®‹å·®å­¦ä¹ çš„ç‰¹æ€§ï¼Œä¿æŠ¤äº†é¢„è®­ç»ƒçŸ¥è¯†ã€‚\n\n- **åè½¬åˆå§‹åŒ–ï¼ˆA=0ï¼ŒBéšæœºï¼‰çš„åŠ£åŠ¿**ï¼š  \n  - **B çš„æ¢¯åº¦æ¶ˆå¤±**ï¼šåˆå§‹é˜¶æ®µ **B** æ— æ³•æ›´æ–°ï¼Œå¯¼è‡´è®­ç»ƒ\"å†·å¯åŠ¨\"ã€‚\n  - **å‚æ•°ä¼˜åŒ–çš„å†²çª**ï¼š**A** çš„æ›´æ–°æ–¹å‘å—é™äºéšæœºåˆå§‹åŒ–çš„ **B**ï¼Œå¯èƒ½å¼•å…¥å™ªå£°ã€‚\n\n---\n\n### **4. å®éªŒè§’åº¦çš„éªŒè¯**\nåœ¨å®é™…ä»»åŠ¡ä¸­ï¼ˆå¦‚å¾®è°ƒ GPT æˆ– BERTï¼‰ï¼Œè‹¥å°† **A** åˆå§‹åŒ–ä¸ºé›¶ä¸” **B** éšæœºï¼Œé€šå¸¸ä¼šå¯¼è‡´ä»¥ä¸‹ç°è±¡ï¼š\n1. **è®­ç»ƒæŸå¤±éœ‡è¡**ï¼šç”±äº **A** å’Œ **B** çš„ä¼˜åŒ–åŠ¨æ€ä¸åŒ¹é…ï¼ŒæŸå¤±å‡½æ•°éš¾ä»¥ç¨³å®šä¸‹é™ã€‚\n2. **æ”¶æ•›é€Ÿåº¦ç¼“æ…¢**ï¼šéœ€è¦æ›´å¤šè¿­ä»£æ¬¡æ•°æ‰èƒ½è¾¾åˆ°ä¸æ ‡å‡†åˆå§‹åŒ–ç›¸å½“çš„æ€§èƒ½ã€‚\n3. **æœ€ç»ˆæ€§èƒ½ä¸‹é™**ï¼šå‚æ•°è€¦åˆé—®é¢˜å¯èƒ½å¯¼è‡´æ¨¡å‹é™·å…¥æ¬¡ä¼˜è§£ã€‚\n\n---\n\n### **ç»“è®ºï¼šä¸ºä»€ä¹ˆä¸èƒ½å°† A åˆå§‹åŒ–ä¸ºé›¶ï¼Ÿ**\n- **æ•°å­¦å±‚é¢**ï¼šæ¢¯åº¦æ¶ˆå¤±é—®é¢˜å¯¼è‡´ **B** æ— æ³•åœ¨åˆå§‹é˜¶æ®µæ›´æ–°ï¼Œç ´åäº†ä½ç§©åˆ†è§£çš„ä¼˜åŒ–åŠ¨æ€ã€‚\n- **å·¥ç¨‹å±‚é¢**ï¼šè®­ç»ƒæ•ˆç‡æ˜¾è‘—ä¸‹é™ï¼Œä¸”å¯èƒ½å¼•å…¥ä¸ç¨³å®šæ€§ã€‚\n- **è®¾è®¡å“²å­¦**ï¼šLoRA çš„ç›®æ ‡æ˜¯\"ä»¥æœ€å°çš„æ‰°åŠ¨é«˜æ•ˆè°ƒæ•´é¢„è®­ç»ƒæ¨¡å‹\"ã€‚æ ‡å‡†åˆå§‹åŒ–ï¼ˆAéšæœºï¼ŒB=0ï¼‰é€šè¿‡æ¢¯åº¦ååŒæ€§å’Œæ®‹å·®å­¦ä¹ çš„ç‰¹æ€§ï¼Œå®Œç¾å¥‘åˆè¿™ä¸€ç›®æ ‡ï¼›è€Œåè½¬åˆå§‹åŒ–è¿èƒŒäº†è¿™ä¸€è®¾è®¡åŸåˆ™ã€‚\n\nå› æ­¤ï¼Œ**A éšæœºåˆå§‹åŒ– + B åˆå§‹åŒ–ä¸ºé›¶**æ˜¯å”¯ä¸€åˆç†çš„åˆå§‹åŒ–ç­–ç•¥ã€‚\n\n","title":"LoRAå¾®è°ƒä¸­çš„çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥ï¼šAéšæœºä¸Bé›¶åˆå§‹åŒ–","abstract":"\u003e æœ¬æ–‡æ˜¯ä¸ Deepseek-R1 æ¨¡å‹+Search çš„å¯¹è¯è®°å½•ï¼Œè¯¦ç»†æ¢è®¨äº† LoRAï¼ˆä½ç§©é€‚åº”ï¼‰å¾®è°ƒæŠ€æœ¯ä¸­çŸ©é˜µåˆå§‹åŒ–ç­–ç•¥çš„æ•°å­¦åŸç†ã€‚æ–‡ç« åˆ†æäº†ä¸ºä»€ä¹ˆåœ¨ LoRA ä¸­çŸ©é˜µ A é‡‡ç”¨éšæœºåˆå§‹åŒ–è€ŒçŸ©é˜µ B é‡‡ç”¨é›¶åˆå§‹åŒ–çš„åŸå› ï¼ŒåŒ…æ‹¬ä¿æŒåˆå§‹æ¨¡å‹ç¨³å®šæ€§ã€ç¡®ä¿æ¢¯åº¦æ›´æ–°æœ‰æ•ˆæ€§ã€å®ç°é€æ­¥å­¦ä¹ çš„ä½ç§©æ›´æ–°ç­‰æ–¹é¢ã€‚åŒæ—¶ï¼Œæ–‡ç« ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåå‘åˆå§‹åŒ–ç­–ç•¥ï¼ˆBéšæœºè€ŒAä¸ºé›¶ï¼‰åœ¨ç†è®ºä¸Šå­˜åœ¨é—®é¢˜ï¼Œä¼šå¯¼è‡´æ¢¯åº¦æ¶ˆå¤±å’Œè®­ç»ƒæ•ˆç‡ä¸‹é™ã€‚è¿™äº›åˆ†ææœ‰åŠ©äºç†è§£æ·±åº¦å­¦ä¹ ä¸­å‚æ•°é«˜æ•ˆå¾®è°ƒæŠ€æœ¯çš„è®¾è®¡åŸç†ã€‚\n\u003e [!reasoning]-\n\u003e å—¯ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å…³äºLoRAï¼ˆä½ç§©é€‚åº”ï¼‰åˆå§‹åŒ–çš„ã€‚ä¸ºä»€ä¹ˆåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ŒçŸ©é˜µAæ˜¯éšæœºåˆå§‹åŒ–çš„ï¼Œè€ŒçŸ©é˜µBæ˜¯é›¶åˆå§‹åŒ–çš„å‘¢ï¼Ÿæˆ‘éœ€è¦ä»”ç»†æ€è€ƒä¸€ä¸‹ã€‚","length":153,"created_at":"2025-03-05T02:00:00.000Z","updated_at":"2025-03-05T02:00:00.000Z","tags":["æ·±åº¦å­¦ä¹ ","LoRA","å‚æ•°é«˜æ•ˆå¾®è°ƒ","æ¨¡å‹è®­ç»ƒ","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-åˆå§‹åŒ–-lora-æ—¶ä¸ºä»€ä¹ˆ-a-çŸ©é˜µæ˜¯éšæœºåˆå§‹åŒ–è€Œ-b-çŸ©é˜µæ˜¯-0-åˆå§‹åŒ–","href":"#q-åˆå§‹åŒ–-lora-æ—¶ä¸ºä»€ä¹ˆ-a-çŸ©é˜µæ˜¯éšæœºåˆå§‹åŒ–è€Œ-b-çŸ©é˜µæ˜¯-0-åˆå§‹åŒ–","heading":2,"title":"Q: åˆå§‹åŒ– LoRA æ—¶ï¼Œä¸ºä»€ä¹ˆ A çŸ©é˜µæ˜¯éšæœºåˆå§‹åŒ–è€Œ B çŸ©é˜µæ˜¯ 0 åˆå§‹åŒ–ï¼Ÿ","children":[],"id":"q-åˆå§‹åŒ–-lora-æ—¶ä¸ºä»€ä¹ˆ-a-çŸ©é˜µæ˜¯éšæœºåˆå§‹åŒ–è€Œ-b-çŸ©é˜µæ˜¯-0-åˆå§‹åŒ–"},{"key":"q-bçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒaçŸ©é˜µåˆå§‹åŒ–æ—¶è®¾ä¸º-0-ä¸è¡Œå—","href":"#q-bçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒaçŸ©é˜µåˆå§‹åŒ–æ—¶è®¾ä¸º-0-ä¸è¡Œå—","heading":2,"title":"Q: BçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒAçŸ©é˜µåˆå§‹åŒ–æ—¶è®¾ä¸º 0 ä¸è¡Œå—ï¼Ÿ","children":[{"key":"1-æ¢¯åº¦æ¶ˆå¤±é—®é¢˜åå‘ä¼ æ’­çš„æ•°å­¦é™åˆ¶","href":"#1-æ¢¯åº¦æ¶ˆå¤±é—®é¢˜åå‘ä¼ æ’­çš„æ•°å­¦é™åˆ¶","heading":3,"title":"1. æ¢¯åº¦æ¶ˆå¤±é—®é¢˜ï¼šåå‘ä¼ æ’­çš„æ•°å­¦é™åˆ¶","children":[],"id":"1-æ¢¯åº¦æ¶ˆå¤±é—®é¢˜åå‘ä¼ æ’­çš„æ•°å­¦é™åˆ¶"},{"key":"2-è®­ç»ƒæ•ˆç‡çš„æ˜¾è‘—ä¸‹é™","href":"#2-è®­ç»ƒæ•ˆç‡çš„æ˜¾è‘—ä¸‹é™","heading":3,"title":"2. è®­ç»ƒæ•ˆç‡çš„æ˜¾è‘—ä¸‹é™","children":[],"id":"2-è®­ç»ƒæ•ˆç‡çš„æ˜¾è‘—ä¸‹é™"},{"key":"3-ä¸æ ‡å‡†-lora-åˆå§‹åŒ–çš„å¯¹æ¯”","href":"#3-ä¸æ ‡å‡†-lora-åˆå§‹åŒ–çš„å¯¹æ¯”","heading":3,"title":"3. ä¸æ ‡å‡† LoRA åˆå§‹åŒ–çš„å¯¹æ¯”","children":[],"id":"3-ä¸æ ‡å‡†-lora-åˆå§‹åŒ–çš„å¯¹æ¯”"},{"key":"4-å®éªŒè§’åº¦çš„éªŒè¯","href":"#4-å®éªŒè§’åº¦çš„éªŒè¯","heading":3,"title":"4. å®éªŒè§’åº¦çš„éªŒè¯","children":[],"id":"4-å®éªŒè§’åº¦çš„éªŒè¯"},{"key":"ç»“è®ºä¸ºä»€ä¹ˆä¸èƒ½å°†-a-åˆå§‹åŒ–ä¸ºé›¶","href":"#ç»“è®ºä¸ºä»€ä¹ˆä¸èƒ½å°†-a-åˆå§‹åŒ–ä¸ºé›¶","heading":3,"title":"ç»“è®ºï¼šä¸ºä»€ä¹ˆä¸èƒ½å°† A åˆå§‹åŒ–ä¸ºé›¶ï¼Ÿ","children":[],"id":"ç»“è®ºä¸ºä»€ä¹ˆä¸èƒ½å°†-a-åˆå§‹åŒ–ä¸ºé›¶"}],"id":"q-bçŸ©é˜µéšæœºåˆå§‹åŒ–è€ŒaçŸ©é˜µåˆå§‹åŒ–æ—¶è®¾ä¸º-0-ä¸è¡Œå—"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2024-12-08-executable-file-formats.md","pagePath":"/learn_from_ai/executable-file-formats","slug":"executable-file-formats"},"meta":{"content":"\n\u003e æœ¬æ–‡ä»‹ç»äº†å‡ ç§ä¸»è¦çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ŒåŒ…æ‹¬Linuxç³»ç»Ÿä½¿ç”¨çš„ELFæ ¼å¼ã€Windowsç³»ç»Ÿä½¿ç”¨çš„PEæ ¼å¼ã€ä»¥åŠmacOSç³»ç»Ÿä½¿ç”¨çš„Mach-Oæ ¼å¼ç­‰ã€‚æ–‡ç« è¯¦ç»†è®¨è®ºäº†æ¯ç§æ ¼å¼çš„ç‰¹ç‚¹ã€ä½¿ç”¨å¹³å°å’Œå†å²æ¼”å˜ï¼Œå¸®åŠ©è¯»è€…ç†è§£ä¸åŒæ“ä½œç³»ç»Ÿä¸­äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„å·®å¼‚ã€‚\n\n## Q: è§£é‡Š: ELF æ‰§è¡Œæ–‡ä»¶\n\nELFï¼ˆExecutable and Linkable Formatï¼‰æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸€ç§ç”¨äºLinuxå’Œç±»Unixæ“ä½œç³»ç»Ÿçš„æ ‡å‡†äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ã€‚å®ƒåŒ…å«äº†å¯æ‰§è¡Œç¨‹åºã€å…±äº«åº“ã€ç›®æ ‡æ–‡ä»¶å’Œæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚ELFæ–‡ä»¶æ ¼å¼è®¾è®¡çµæ´»ã€å¯æ‰©å±•ï¼Œå¹¶ä¸”å¯ç§»æ¤ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä»£ç çš„åŠ è½½å’Œæ‰§è¡Œæ–¹å¼ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ç­‰ã€‚æ“ä½œç³»ç»Ÿæ ¹æ®ELFæ–‡ä»¶ä¸­çš„è¿™äº›ä¿¡æ¯æ¥å’Œæ‰§è¡Œç¨‹åºã€‚ELFæ ¼å¼ä¹Ÿå…è®¸ç¨‹åºå…±äº«åº“ï¼Œå³å¤šä¸ªç¨‹åºå¯ä»¥å…±äº«åŒä¸€æ®µä»£ç ï¼Œä»è€Œå‡å°‘å†…å­˜å ç”¨å¹¶æé«˜æ•ˆç‡ã€‚åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒELFæ–‡ä»¶ä½œä¸ºç›®æ ‡æ–‡ä»¶æ ¼å¼åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œå¹¶æœ€ç»ˆç”±é“¾æ¥å™¨ç»„åˆå½¢æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ã€‚\n\n## Q: æœ‰ä¸ ELF ç›¸å¹¶åˆ—çš„å¦å¤–çš„ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å—ï¼Ÿ\n\næ˜¯çš„ï¼Œé™¤äº†ELFï¼ˆExecutable and Linking Formatï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–å‡ ç§å¸¸è§çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œå¹³å°ä¸Šè¢«å¹¿æ³›ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼š\n\n1. **PEï¼ˆPortable Executableï¼‰**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šä¸»è¦åœ¨Windowsæ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼šPEæ ¼å¼æ˜¯COFFï¼ˆCommon Object File Formatï¼‰çš„æ‰©å±•ï¼Œç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ã€åŠ¨æ€é“¾æ¥åº“DLLsï¼‰å’Œé©±åŠ¨ç¨‹åºç­‰ã€‚PEæ–‡ä»¶åŒ…å«ä¸€ä¸ªå¤´éƒ¨ï¼ˆPE headerï¼‰ã€èŠ‚è¡¨ï¼ˆsection tableï¼‰å’Œå„ä¸ªèŠ‚ï¼ˆsectionsï¼‰ï¼Œå¦‚ä»£ç èŠ‚ã€æ•°æ®èŠ‚ç­‰ã€‚\n\n2. **Mach-Oï¼ˆMach Objectï¼‰**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šä¸»è¦åœ¨Appleçš„macOSå’ŒiOSæ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼šMach-Oæ ¼å¼ç”¨äºå­˜å‚¨å¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶å’ŒåŠ¨æ€åº“ã€‚å®ƒåŒ…å«å¤šä¸ªæ®µï¼ˆsegmentså’ŒèŠ‚ï¼ˆsectionsï¼‰ï¼Œæ”¯æŒå¤šç§æ¶æ„ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«å¤šä¸ªæ¶æ„çš„ä»£ç ï¼ˆç§°ä¸º\"fat binary\"ï¼‰ã€‚\n\n3. **COFFï¼ˆCommon Object File Formatï¼‰**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šæ—©æœŸåœ¨Unix System Vå’ŒWindows NTä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼šCOFFæ ¼å¼æ˜¯ä¸€ç§é€šç”¨çš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ï¼ŒåŒ…å«ä»£ç ã€æ•°æ®å’Œé‡å®šä½ä¿¡æ¯ã€‚è™½ç„¶ç°åœ¨è¾ƒå°‘ç›´æ¥ä½¿ç”¨ï¼Œä½†å®ƒçš„è®¸å¤šæ¦‚å¿µå’Œç»“æ„è¢«PEå’ŒELFç»§æ‰¿ã€‚\n\n4. **a.outï¼ˆAssembler Outputï¼‰**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šæ—©æœŸUnixç³»ç»Ÿä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼ša.outæ˜¯ä¸€ç§è¾ƒç®€å•çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼ŒåŒ…å«å¯æ‰§è¡Œä»£ç ã€æ•°æ®å’Œç¬¦å·è¡¨ã€‚éšç€ELFæ ¼å¼çš„å‡ºç°ï¼Œa.outé€æ¸è¢«æ·˜æ±°ã€‚\n\n5. **DOS MZï¼ˆMark Zbikowskiï¼‰**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šæ—©æœŸDOSå’ŒWindowsç³»ç»Ÿä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼šDOSZæ ¼å¼æ˜¯DOSå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ï¼Œä»¥\"MZ\"ï¼ˆå¼€å‘è€…Mark Zbikowskiçš„é¦–å­—æ¯ï¼‰ä½œä¸ºæ–‡ä»¶å¤´éƒ¨çš„æ ‡è¯†ã€‚å®ƒè¢«åæ¥çš„PEæ ¼å¼æ‰€å–ä»£ã€‚\n\n6. **COMæ–‡ä»¶**ï¼š\n   - **ä½¿ç”¨å¹³å°**ï¼šæ—©æœŸDOSç³»ç»Ÿä¸Šä½¿ç”¨ã€‚\n   - **ç‰¹ç‚¹**ï¼šCOMæ–‡ä»¶æ˜¯ä¸€ç§éå¸¸ç®€å•çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼Œä»…åŒ…å«ä»£ç å’Œæ•°æ®ï¼Œæ²¡æœ‰å¤´éƒ¨ä¿¡æ¯ï¼Œå¤§å°é™åˆ¶ä¸º64KBã€‚\n\nè¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å„æœ‰ç‰¹ç‚¹ï¼Œé€‚ç”¨äºä¸åŒçš„å’Œåœºæ™¯ã€‚å®ƒä»¬åœ¨æ–‡ä»¶ç»“æ„ã€åŠ è½½æœºåˆ¶å’ŒåŠŸèƒ½æ”¯æŒä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†éƒ½æ—¨åœ¨å®ç°ç¨‹åºä»£ç çš„æœ‰æ•ˆå­˜å‚¨å’Œæ‰§è¡Œã€‚\n\n","title":"å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼å¯¹æ¯”ï¼šELFã€PEã€Mach-Oç­‰","abstract":"\u003e æœ¬æ–‡ä»‹ç»äº†å‡ ç§ä¸»è¦çš„å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ï¼ŒåŒ…æ‹¬Linuxç³»ç»Ÿä½¿ç”¨çš„ELFæ ¼å¼ã€Windowsç³»ç»Ÿä½¿ç”¨çš„PEæ ¼å¼ã€ä»¥åŠmacOSç³»ç»Ÿä½¿ç”¨çš„Mach-Oæ ¼å¼ç­‰ã€‚æ–‡ç« è¯¦ç»†è®¨è®ºäº†æ¯ç§æ ¼å¼çš„ç‰¹ç‚¹ã€ä½¿ç”¨å¹³å°å’Œå†å²æ¼”å˜ï¼Œå¸®åŠ©è¯»è€…ç†è§£ä¸åŒæ“ä½œç³»ç»Ÿä¸­äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼çš„å·®å¼‚ã€‚\nELFï¼ˆExecutable and Linkable Formatï¼‰æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸€ç§ç”¨äºLinuxå’Œç±»Unixæ“ä½œç³»ç»Ÿçš„æ ‡å‡†äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ã€‚å®ƒåŒ…å«äº†å¯æ‰§è¡Œç¨‹åºã€å…±äº«åº“ã€ç›®æ ‡æ–‡ä»¶å’Œæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚ELFæ–‡ä»¶æ ¼å¼è®¾è®¡çµæ´»ã€å¯æ‰©å±•ï¼Œå¹¶ä¸”å¯ç§»æ¤ï¼Œå®ƒå®šä¹‰äº†ç¨‹åºä»£ç çš„åŠ è½½å’Œæ‰§è¡Œæ–¹å¼ï¼ŒåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€ç¬¦å·è¡¨å’Œé‡å®šä½ä¿¡æ¯ç­‰ã€‚æ“ä½œç³»ç»Ÿæ ¹æ®ELFæ–‡ä»¶ä¸­çš„è¿™äº›ä¿¡æ¯æ¥å’Œæ‰§è¡Œç¨‹åºã€‚ELFæ ¼å¼ä¹Ÿå…è®¸ç¨‹åºå…±äº«åº“ï¼Œå³å¤šä¸ªç¨‹åºå¯ä»¥å…±äº«åŒä¸€æ®µä»£ç ï¼Œä»è€Œå‡å°‘å†…å­˜å ç”¨å¹¶æé«˜æ•ˆç‡ã€‚åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒELFæ–‡ä»¶ä½œä¸ºç›®æ ‡æ–‡ä»¶æ ¼å¼åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œå¹¶æœ€ç»ˆç”±é“¾æ¥å™¨ç»„åˆå½¢æˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ã€‚\næ˜¯çš„ï¼Œé™¤äº†ELFï¼ˆExecutable and Linking Formatï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–å‡ ç§å¸¸è§çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œå¹³å°ä¸Šè¢«å¹¿æ³›ä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›ä¸»è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼ï¼š","length":38,"created_at":"2024-12-08T02:00:00.000Z","updated_at":"2024-12-08T02:00:00.000Z","tags":["Linux","Windows","macOS","å¯æ‰§è¡Œæ–‡ä»¶","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"q-è§£é‡Š-elf-æ‰§è¡Œæ–‡ä»¶","href":"#q-è§£é‡Š-elf-æ‰§è¡Œæ–‡ä»¶","heading":2,"title":"Q: è§£é‡Š: ELF æ‰§è¡Œæ–‡ä»¶","children":[],"id":"q-è§£é‡Š-elf-æ‰§è¡Œæ–‡ä»¶"},{"key":"q-æœ‰ä¸-elf-ç›¸å¹¶åˆ—çš„å¦å¤–çš„ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å—","href":"#q-æœ‰ä¸-elf-ç›¸å¹¶åˆ—çš„å¦å¤–çš„ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å—","heading":2,"title":"Q: æœ‰ä¸ ELF ç›¸å¹¶åˆ—çš„å¦å¤–çš„ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å—ï¼Ÿ","children":[],"id":"q-æœ‰ä¸-elf-ç›¸å¹¶åˆ—çš„å¦å¤–çš„ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼å—"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2024-11-29-opencv-coordinate-system-conventions.md","pagePath":"/learn_from_ai/opencv-coordinate-system-conventions","slug":"opencv-coordinate-system-conventions"},"meta":{"content":"\n\u003e ğŸ“ æœ¬æ–‡æ˜¯æˆ‘åœ¨å­¦ä¹  OpenCV æ—¶é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚é—®é¢˜çš„è§£ç­”å’Œä¸­æ–‡ç¿»è¯‘å‡ç”± AI ç”Ÿæˆã€‚\n\n## OpenCV åæ ‡è¡¨ç¤ºï¼šç†è§£ (y, x) ä¸ (x, y) çš„åŒºåˆ«\n\n## Q\n\nWhy sometimes opencv represent a point coordinate as (y,x) (e.g. the result of cv2.findContours) , and sometimes it represent as (x, y) (e.g. the arg `center` of cv2.circle)?\n\n\u003e ä¸ºä»€ä¹ˆ OpenCV æœ‰æ—¶ç”¨ (y,x) è¡¨ç¤ºåæ ‡ç‚¹ï¼ˆæ¯”å¦‚ cv2.findContours çš„è¿”å›å€¼ï¼‰ï¼Œæœ‰æ—¶åˆç”¨ (x,y) è¡¨ç¤ºï¼ˆæ¯”å¦‚ cv2.circle å‡½æ•°çš„ `center` å‚æ•°ï¼‰ï¼Ÿ\n\n## A\n\nOpenCV uses different conventions for different functions based on their specific requirements and historical reasons:\n\n\u003e OpenCV åŸºäºä¸åŒå‡½æ•°çš„å…·ä½“éœ€æ±‚å’Œå†å²åŸå› ï¼Œä½¿ç”¨äº†ä¸åŒçš„åæ ‡è¡¨ç¤ºçº¦å®šï¼š\n\n1. **(y, x) Convention**: This is often used when dealing with image matrices directly. In image processing, images are typically represented as 2D arrays where the first dimension is the row (height, y-coordinate) and the second dimension is the column (width, x-coordinate). Functions like `cv2.findContours` return coordinates in this order to match the array indexing.\n\n\u003e 1. **(y, x) çº¦å®š**ï¼šè¿™ç§è¡¨ç¤ºæ–¹æ³•é€šå¸¸ç”¨äºç›´æ¥å¤„ç†å›¾åƒçŸ©é˜µæ—¶ã€‚åœ¨å›¾åƒå¤„ç†ä¸­ï¼Œå›¾åƒé€šå¸¸è¡¨ç¤ºä¸ºäºŒç»´æ•°ç»„ï¼Œå…¶ä¸­ç¬¬ä¸€ç»´æ˜¯è¡Œï¼ˆé«˜åº¦ï¼Œy åæ ‡ï¼‰ï¼Œç¬¬äºŒç»´æ˜¯åˆ—ï¼ˆå®½åº¦ï¼Œx åæ ‡ï¼‰ã€‚åƒ `cv2.findContours` è¿™æ ·çš„å‡½æ•°è¿”å›è¿™ç§é¡ºåºçš„åæ ‡æ˜¯ä¸ºäº†åŒ¹é…æ•°ç»„ç´¢å¼•æ–¹å¼ã€‚\n\n2. **(x, y) Convention**: This is used in functions that deal with geometric shapes or points in a more traditional Cartesian coordinate system, where `x` is the horizontal axis and `y` is the vertical axis. Functions like `cv2.circle` use this convention to specify the center of the circle.\n\n\u003e 2. **(x, y) çº¦å®š**ï¼šè¿™ç§è¡¨ç¤ºæ–¹æ³•ç”¨äºå¤„ç†å‡ ä½•å›¾å½¢æˆ–åœ¨ä¼ ç»Ÿç¬›å¡å°”åæ ‡ç³»ä¸­çš„ç‚¹ï¼Œå…¶ä¸­ `x` æ˜¯æ°´å¹³è½´ï¼Œ`y` æ˜¯å‚ç›´è½´ã€‚åƒ `cv2.circle` è¿™æ ·çš„å‡½æ•°ä½¿ç”¨è¿™ç§çº¦å®šæ¥æŒ‡å®šåœ†å¿ƒä½ç½®ã€‚\n\nThe inconsistency arises because OpenCV aims to balance between image matrix operations and geometric operations, each having their own conventional coordinate systems.\n\n\u003e è¿™ç§ä¸ä¸€è‡´æ€§çš„å‡ºç°æ˜¯å› ä¸º OpenCV éœ€è¦åœ¨å›¾åƒçŸ©é˜µè¿ç®—å’Œå‡ ä½•è¿ç®—ä¹‹é—´å–å¾—å¹³è¡¡ï¼Œè€Œè¿™ä¸¤ç§è¿ç®—å„è‡ªæœ‰å…¶ä¼ ç»Ÿçš„åæ ‡ç³»ç»Ÿè¡¨ç¤ºæ–¹æ³•ã€‚\n","title":"OpenCV åæ ‡è¡¨ç¤ºï¼šç†è§£ (y, x) ä¸ (x, y) çš„åŒºåˆ«","abstract":"\u003e ğŸ“ æœ¬æ–‡æ˜¯æˆ‘åœ¨å­¦ä¹  OpenCV æ—¶é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜ã€‚é—®é¢˜çš„è§£ç­”å’Œä¸­æ–‡ç¿»è¯‘å‡ç”± AI ç”Ÿæˆã€‚\nWhy sometimes opencv represent a point coordinate as (y,x) (e.g. the result of cv2.findContours) , and sometimes it represent as (x, y) (e.g. the arg `center` of cv2.circle)?\n\u003e ä¸ºä»€ä¹ˆ OpenCV æœ‰æ—¶ç”¨ (y,x) è¡¨ç¤ºåæ ‡ç‚¹ï¼ˆæ¯”å¦‚ cv2.findContours çš„è¿”å›å€¼ï¼‰ï¼Œæœ‰æ—¶åˆç”¨ (x,y) è¡¨ç¤ºï¼ˆæ¯”å¦‚ cv2.circle å‡½æ•°çš„ `center` å‚æ•°ï¼‰ï¼Ÿ","length":29,"created_at":"2024-11-29T03:00:00.000Z","updated_at":"2024-11-29T03:00:00.000Z","tags":["OpenCV","å›¾åƒå¤„ç†","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"opencv-åæ ‡è¡¨ç¤ºç†è§£-y-x-ä¸-x-y-çš„åŒºåˆ«","href":"#opencv-åæ ‡è¡¨ç¤ºç†è§£-y-x-ä¸-x-y-çš„åŒºåˆ«","heading":2,"title":"OpenCV åæ ‡è¡¨ç¤ºï¼šç†è§£ (y, x) ä¸ (x, y) çš„åŒºåˆ«","children":[],"id":"opencv-åæ ‡è¡¨ç¤ºç†è§£-y-x-ä¸-x-y-çš„åŒºåˆ«"},{"key":"q","href":"#q","heading":2,"title":"Q","children":[],"id":"q"},{"key":"a","href":"#a","heading":2,"title":"A","children":[],"id":"a"}],"wikiRefAliases":[],"richRefAliases":[]}},{"pathMapping":{"filePath":"public/content/learn_from_ai/2024-11-29-deep-learning-model-formats.md","pagePath":"/learn_from_ai/deep-learning-model-formats","slug":"deep-learning-model-formats"},"meta":{"content":"\n\u003e æœ¬é¡µé¢ä»‹ç»äº†ä¸‰ç§æœºå™¨å­¦ä¹ æ¨¡å‹æ–‡ä»¶æ ¼å¼ï¼š.pthã€.safetensor å’Œ .onnxã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬æ¯ç§æ ¼å¼çš„å®šä¹‰ã€ä¿å­˜çš„å†…å®¹ã€ç”¨é€”ä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å’Œè½¬æ¢æ–¹æ³•ã€‚\n\n## pytorch ä¿å­˜çš„ .pth æ–‡ä»¶é‡Œéƒ½ä¿å­˜äº†äº›ä»€ä¹ˆä¸œè¥¿ï¼Ÿ\n\nPyTorch ä¸­çš„`.pth`æ–‡ä»¶é€šå¸¸ç”¨äºä¿å­˜æ¨¡å‹çš„æƒé‡ï¼ˆparametersï¼‰å’Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆoptimizer stateï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ª`.pth`æ–‡ä»¶å¯èƒ½åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\n\n1. **æ¨¡å‹çŠ¶æ€å­—å…¸ï¼ˆModel state dictionaryï¼‰**ï¼š\n   - è¿™æ˜¯`.pth`æ–‡ä»¶ä¸­æœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå®ƒåŒ…å«äº†æ¨¡å‹çš„æ‰€æœ‰æƒé‡ï¼ˆå³ç¥ç»ç½‘ç»œçš„å‚æ•°ï¼‰ï¼ŒåŒ…æ‹¬å·ç§¯å±‚çš„æ»¤æ³¢å™¨ã€å…¨è¿æ¥å±‚çš„æƒé‡å’Œåç½®ç­‰ã€‚\n   - çŠ¶æ€å­—å…¸æ˜¯ä¸€ä¸ªç®€å•çš„ Python å­—å…¸å¯¹è±¡ï¼Œå…¶é”®æ˜¯å±‚çš„åå­—ï¼Œå€¼æ˜¯ç›¸åº”çš„å‚æ•°å¼ é‡ã€‚\n2. **ä¼˜åŒ–å™¨çŠ¶æ€å­—å…¸ï¼ˆOptimizer state dictionaryï¼‰**ï¼š\n   - å½“ä¿å­˜æ¨¡å‹æ—¶ï¼Œé€šå¸¸ä¹Ÿä¼šä¿å­˜ä¼˜åŒ–å™¨çš„çŠ¶æ€ï¼Œè¿™æ ·å¯ä»¥åœ¨æ¨¡å‹è®­ç»ƒä¸­æ–­åï¼Œä»ä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­è®­ç»ƒã€‚\n   - ä¼˜åŒ–å™¨çŠ¶æ€å­—å…¸é€šå¸¸åŒ…å«æ¯ä¸ªå‚æ•°çš„æ¢¯åº¦ã€åŠ¨é‡ï¼ˆmomentumï¼‰å’Œå…¶ä»–ä¸ä¼˜åŒ–å™¨ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ï¼ˆä¾‹å¦‚ Adam ä¼˜åŒ–å™¨çš„çŸ©ä¼°è®¡ï¼‰ã€‚\n3. **å…¶ä»–å¯é€‰ä¿¡æ¯**ï¼š\n   - æœ‰æ—¶å€™ï¼Œ`.pth`æ–‡ä»¶å¯èƒ½è¿˜ä¼šåŒ…å«å…¶ä»–è¾…åŠ©ä¿¡æ¯ï¼Œæ¯”å¦‚è®­ç»ƒçš„æŸå¤±å€¼ã€é¢å¤–çš„å…ƒæ•°æ®æˆ–è€…æ‰¹å¤„ç†å¤§å°ç­‰ï¼Œä½†è¿™äº›ä¿¡æ¯ä¸æ˜¯å¿…é¡»çš„ã€‚\n     ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºå¦‚ä½•åœ¨ PyTorch ä¸­ä¿å­˜å’ŒåŠ è½½`.pth`æ–‡ä»¶ï¼š\n\n```python\n# ä¿å­˜æ¨¡å‹å’Œä¼˜åŒ–å™¨çŠ¶æ€\ntorch.save({\n    'epoch': epoch,\n    'model_state_dict': model.state_dict(),\n    'optimizer_state_dict': optimizer.state_dict(),\n    'loss': loss,\n    ...\n}, 'model.pth')\n# åŠ è½½æ¨¡å‹å’Œä¼˜åŒ–å™¨çŠ¶æ€\ncheckpoint = torch.load('model.pth')\nmodel.load_state_dict(checkpoint['model_state_dict'])\noptimizer.load_state_dict(checkpoint['optimizer_state_dict'])\nepoch = checkpoint['epoch']\nloss = checkpoint['loss']\n...\n```\n\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`model`æ˜¯ä½ è¦ä¿å­˜çš„æ¨¡å‹å¯¹è±¡ï¼Œ`optimizer`æ˜¯è®­ç»ƒè¯¥æ¨¡å‹ä½¿ç”¨çš„ä¼˜åŒ–å™¨ã€‚é€šè¿‡`torch.save`å‡½æ•°ï¼Œä½ å¯ä»¥å°†æ¨¡å‹çš„çŠ¶æ€å­—å…¸å’Œä¼˜åŒ–å™¨çš„çŠ¶æ€å­—å…¸ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚ä¹‹åï¼Œå¯ä»¥ä½¿ç”¨`torch.load`å‡½æ•°æ¥æ¢å¤è¿™äº›çŠ¶æ€ï¼Œä»¥ä¾¿ç»§ç»­è®­ç»ƒæˆ–è€…è¿›è¡Œæ¨ç†ã€‚\n\n## .safetensor æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¸œè¥¿ï¼Ÿ\n\n`.safetensor` æ–‡ä»¶æ ¼å¼æ˜¯ç”± Hugging Face çš„ Safety Checker å·¥å…·å¼•å…¥çš„ï¼Œå®ƒæ˜¯ä¸ºäº†åœ¨æ¨¡å‹æ¨ç†æ—¶æä¾›ä¸€ä¸ªé¢å¤–çš„å®‰å…¨å±‚ã€‚`.safetensor` æ–‡ä»¶ä¸­ä¿å­˜çš„å†…å®¹ä¸»è¦åŒ…æ‹¬ï¼š\n\n1. **æ¨¡å‹æƒé‡**ï¼š\n   - è¿™æ˜¯æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œä¸ PyTorch çš„ `.pth` æ–‡ä»¶ç±»ä¼¼ï¼Œ`.safetensor` æ–‡ä»¶ä¹Ÿä¿å­˜äº†æ¨¡å‹çš„æƒé‡ï¼Œå³ç¥ç»ç½‘ç»œä¸­çš„å‚æ•°ã€‚\n2. **å…ƒæ•°æ®**ï¼š\n   - `.safetensor` æ–‡ä»¶åŒ…å«äº†ä¸€äº›å…ƒæ•°æ®ï¼Œè¿™äº›æ•°æ®æè¿°äº†æ¨¡å‹çš„æ¶æ„ã€æƒé‡å½¢çŠ¶ã€æ•°æ®ç±»å‹ç­‰ä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥åœ¨åŠ è½½æ¨¡å‹æ—¶è¿›è¡ŒéªŒè¯å’Œé€‚é…ã€‚\n3. **å®‰å…¨æ€§ä¿¡æ¯**ï¼š\n   - `.safetensor` æ–‡ä»¶å¯èƒ½ä¼šåŒ…å«ä¸æ¨¡å‹å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å“ªäº›å±‚æˆ–å‚æ•°å¯èƒ½éœ€è¦ç‰¹åˆ«çš„å®‰å…¨æ£€æŸ¥ï¼Œä»¥åŠå¯èƒ½çš„é˜ˆå€¼è®¾ç½®ç­‰ã€‚\n     å…·ä½“æ¥è¯´ï¼Œ`.safetensor` æ–‡ä»¶çš„å†…å®¹ç»“æ„å¯èƒ½å¦‚ä¸‹ï¼š\n\n- `weights`: åŒ…å«æ¨¡å‹æƒé‡çš„å­—å…¸ï¼Œé€šå¸¸æ˜¯ä»¥å¼ é‡çš„å½¢å¼å­˜å‚¨ã€‚\n- `metadata`: åŒ…å«æ¨¡å‹çš„å…ƒæ•°æ®ï¼Œå¦‚ç‰ˆæœ¬å·ã€æ¶æ„ä¿¡æ¯ç­‰ã€‚\n- `config`: åŒ…å«æ¨¡å‹é…ç½®ä¿¡æ¯ï¼Œå¦‚æ¨¡å‹ç±»å‹ã€ç±»åç­‰ã€‚\n- `safety`: åŒ…å«æ¨¡å‹å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n  ä½¿ç”¨ `.safetensor` æ–‡ä»¶çš„ç›®çš„ä¹‹ä¸€æ˜¯ä¸ºäº†ç¡®ä¿åœ¨æ¨¡å‹éƒ¨ç½²æ—¶èƒ½å¤Ÿè¿›è¡Œæœ‰æ•ˆçš„å®‰å…¨æ£€æŸ¥ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†ç”Ÿæˆå‹æ¨¡å‹ï¼ˆå¦‚æ–‡æœ¬ç”Ÿæˆã€å›¾åƒç”Ÿæˆç­‰ï¼‰æ—¶ï¼Œå¯ä»¥é˜²æ­¢ç”Ÿæˆä¸é€‚å½“çš„å†…å®¹ã€‚\n  è¯·æ³¨æ„ï¼Œ`.safetensor` æ–‡ä»¶æ ¼å¼å¹¶ä¸æ˜¯ PyTorch çš„æ ‡å‡†ä¿å­˜æ ¼å¼ï¼Œè€Œæ˜¯ Hugging Face çš„ç‰¹å®šå®ç°ã€‚å› æ­¤ï¼Œå®ƒå¯èƒ½ä¸å¦‚ `.pth` æ–‡ä»¶é‚£æ ·è¢«å¹¿æ³›ä½¿ç”¨ã€‚å¦‚æœä½ åœ¨ä½¿ç”¨ Hugging Face çš„æ¨¡å‹å’Œå·¥å…·ï¼Œå¯èƒ½ä¼šé‡åˆ° `.safetensor` æ–‡ä»¶ã€‚åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦ç¡®ä¿ä½ çš„ç¯å¢ƒæ”¯æŒè¿™ç§æ ¼å¼ã€‚\n\n## .onnx æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯ï¼Ÿ\n\n`.onnx`ï¼ˆOpen Neural Network Exchangeï¼‰æ–‡ä»¶æ˜¯ä¸€ä¸ªå¼€æ”¾æ ¼å¼ï¼Œç”¨äºè¡¨ç¤ºæœºå™¨å­¦ä¹ æ¨¡å‹ã€‚å®ƒæ—¨åœ¨æä¾›ä¸€ç§æ ‡å‡†çš„æ–¹å¼æ¥è¡¨ç¤ºæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä½¿å¾—æ¨¡å‹å¯ä»¥åœ¨ä¸åŒçš„æ¡†æ¶å’Œå·¥å…·ä¹‹é—´è¿›è¡Œè½¬æ¢å’Œäº’æ“ä½œã€‚ä¸€ä¸ª`.onnx`æ–‡ä»¶ä¸­é€šå¸¸åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š\n\n1. **æ¨¡å‹å›¾ï¼ˆModel Graphï¼‰**ï¼š\n   - æ¨¡å‹å›¾å®šä¹‰äº†æ¨¡å‹çš„è®¡ç®—æµç¨‹ï¼Œå®ƒç”±èŠ‚ç‚¹ï¼ˆnodesï¼‰å’Œè¾¹ï¼ˆedgesï¼‰ç»„æˆã€‚\n   - èŠ‚ç‚¹ä»£è¡¨è®¡ç®—æ“ä½œï¼Œå¦‚å·ç§¯ã€çŸ©é˜µä¹˜æ³•ã€æ¿€æ´»å‡½æ•°ç­‰ã€‚\n   - è¾¹ä»£è¡¨èŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®æµï¼Œå³å¼ é‡ï¼ˆtensorsï¼‰çš„æµåŠ¨ã€‚\n2. **åˆå§‹å€¼ï¼ˆInitializersï¼‰**ï¼š\n   - åˆå§‹å€¼åŒ…å«äº†æ¨¡å‹çš„æƒé‡ã€åç½®ç­‰å‚æ•°çš„å€¼ã€‚\n   - è¿™äº›å‚æ•°æ˜¯åœ¨æ¨¡å‹å›¾æ‰§è¡Œä¹‹å‰å°±å·²ç»ç¡®å®šçš„ã€‚\n3. **æ¨¡å‹å±æ€§ï¼ˆAttributesï¼‰**ï¼š\n   - æ¯ä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰ä¸ä¹‹å…³è”çš„å±æ€§ï¼Œè¿™äº›å±æ€§å®šä¹‰äº†èŠ‚ç‚¹çš„å…·ä½“è¡Œä¸ºï¼Œä¾‹å¦‚å·ç§¯æ“ä½œä¸­çš„æ­¥é•¿ï¼ˆstrideï¼‰å’Œå¡«å……ï¼ˆpaddingï¼‰ã€‚\n4. **è¾“å…¥å’Œè¾“å‡ºï¼ˆInputs and Outputsï¼‰**ï¼š\n   - å®šä¹‰äº†æ¨¡å‹çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„åç§°ã€æ•°æ®ç±»å‹å’Œå½¢çŠ¶ã€‚\n   - è¿™æœ‰åŠ©äºç†è§£æ¨¡å‹æœŸæœ›çš„è¾“å…¥æ ¼å¼ä»¥åŠå®ƒå°†äº§ç”Ÿçš„è¾“å‡ºæ ¼å¼ã€‚\n5. **å…ƒæ•°æ®ï¼ˆMetadataï¼‰**ï¼š\n   - åŒ…æ‹¬æ¨¡å‹çš„åç§°ã€ç‰ˆæœ¬ã€ä½œè€…ã€ç”Ÿäº§æ—¥æœŸç­‰ä¿¡æ¯ã€‚\n   - è¿™äº›ä¿¡æ¯æœ‰åŠ©äºæ¨¡å‹çš„è¿½è¸ªå’Œç®¡ç†ã€‚\n6. **ä¼˜åŒ–ä¿¡æ¯ï¼ˆOptimization Informationï¼‰**ï¼ˆå¯é€‰ï¼‰ï¼š\n   - ä¸€äº›`.onnx`æ–‡ä»¶å¯èƒ½åŒ…å«ç”¨äºä¼˜åŒ–æ¨¡å‹æ‰§è¡Œçš„é¢å¤–ä¿¡æ¯ï¼Œå¦‚èåˆæ“ä½œæˆ–ç‰¹å®šç¡¬ä»¶ä¸Šçš„ä¼˜åŒ–æŒ‡ä»¤ã€‚\n     `.onnx`æ–‡ä»¶çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š\n\n- `ir_version`: ONNX æ ¼å¼çš„ç‰ˆæœ¬å·ã€‚\n- `opset_import`: æ¨¡å‹ä½¿ç”¨çš„æ“ä½œé›†ç‰ˆæœ¬ã€‚\n- `producer_name`: ç”Ÿæˆè¯¥ ONNX æ¨¡å‹çš„å·¥å…·æˆ–åº“çš„åç§°ã€‚\n- `producer_version`: ç”Ÿæˆè¯¥ ONNX æ¨¡å‹çš„å·¥å…·æˆ–åº“çš„ç‰ˆæœ¬ã€‚\n- `graph`: åŒ…å«æ¨¡å‹å›¾çš„ç»“æ„å’Œå±æ€§ã€‚\n  - `node`: è®¡ç®—èŠ‚ç‚¹åˆ—è¡¨ã€‚\n  - `input`: è¾“å…¥åˆ—è¡¨ã€‚\n  - `output`: è¾“å‡ºåˆ—è¡¨ã€‚\n  - `initializer`: åˆå§‹åŒ–å‚æ•°åˆ—è¡¨ã€‚\n  - `value_info`: æä¾›é¢å¤–çš„å¼ é‡ä¿¡æ¯ã€‚\n    ä½¿ç”¨`.onnx`æ–‡ä»¶ï¼Œå¯ä»¥è½»æ¾åœ°å°†æ¨¡å‹ä» PyTorchã€TensorFlowã€Caffe2 ç­‰æ¡†æ¶è½¬æ¢åˆ° ONNX æ ¼å¼ï¼Œç„¶åå†éƒ¨ç½²åˆ°ä¸åŒçš„æ¨ç†å¼•æ“æˆ–ç¡¬ä»¶å¹³å°ä¸Šï¼Œä¾‹å¦‚ä½¿ç”¨ ONNX Runtime è¿›è¡Œæ¨ç†ã€‚è¿™ç§æ ¼å¼æé«˜äº†æ¨¡å‹çš„ä¾¿æºæ€§å’Œäº’æ“ä½œæ€§ã€‚\n\n## ç®€è¿° .pth ï¼Œ .safetensor ï¼Œ .onnx ä¿å­˜çš„ä¿¡æ¯ä¸­ï¼Œæœ‰å“ªäº›æ˜¯ç›¸åŒçš„ï¼Ÿæœ‰å“ªäº›æœ‰åŒºåˆ«ï¼Ÿ\n\n.pth, .safetensor, å’Œ .onnx æ–‡ä»¶æ ¼å¼éƒ½ç”¨äºä¿å­˜æœºå™¨å­¦ä¹ æ¨¡å‹çš„ç›¸å…³ä¿¡æ¯ï¼Œä½†å®ƒä»¬çš„è®¾è®¡ç›®çš„ã€å…¼å®¹æ€§å’ŒåŒ…å«çš„å…·ä½“å†…å®¹æœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬ä¹‹é—´ç›¸åŒç‚¹å’ŒåŒºåˆ«çš„æ¦‚è¿°ï¼š\n**ç›¸åŒç‚¹ï¼š**\n\n1. **æ¨¡å‹å‚æ•°/æƒé‡**ï¼š\n   - æ‰€æœ‰ä¸‰ç§æ ¼å¼éƒ½ä¿å­˜äº†æ¨¡å‹çš„å‚æ•°æˆ–æƒé‡ï¼Œè¿™äº›æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ åˆ°çš„æ•°å€¼ï¼Œå¯¹äºæ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›è‡³å…³é‡è¦ã€‚\n2. **å…ƒæ•°æ®**ï¼š\n   - å®ƒä»¬éƒ½å¯èƒ½åŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œå¦‚æ¨¡å‹çš„ç‰ˆæœ¬ã€åˆ›å»ºæ—¥æœŸæˆ–å…¶ä»–æè¿°æ€§ä¿¡æ¯ï¼Œå°½ç®¡å…·ä½“çš„å…ƒæ•°æ®å†…å®¹å’Œæ ¼å¼å¯èƒ½æœ‰æ‰€ä¸åŒã€‚\n     **åŒºåˆ«ï¼š**\n3. **æ ¼å¼å’Œå…¼å®¹æ€§**ï¼š\n   - `.pth` æ˜¯ PyTorch çš„åŸç”Ÿæ ¼å¼ï¼Œä¸“é—¨ç”¨äºä¿å­˜å’ŒåŠ è½½ PyTorch æ¨¡å‹çš„çŠ¶æ€å­—å…¸ï¼ŒåŒ…æ‹¬æ¨¡å‹æƒé‡å’Œä¼˜åŒ–å™¨çŠ¶æ€ã€‚\n   - `.safetensor` æ˜¯ Hugging Face çš„ Safety Checker å·¥å…·ä½¿ç”¨çš„æ ¼å¼ï¼Œé™¤äº†æ¨¡å‹æƒé‡ï¼Œè¿˜åŒ…å«äº†å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n   - `.onnx` æ˜¯ä¸€ä¸ªå¼€æ”¾çš„ã€è·¨æ¡†æ¶çš„æ ¼å¼ï¼Œç”¨äºåœ¨ä¸åŒçš„æ·±åº¦å­¦ä¹ æ¡†æ¶ä¹‹é—´äº¤æ¢æ¨¡å‹ï¼Œä¸ä»…åŒ…å«æ¨¡å‹ç»“æ„å’Œå‚æ•°ï¼Œè¿˜å®šä¹‰äº†æ¨¡å‹è®¡ç®—å›¾ã€‚\n4. **åŒ…å«å†…å®¹**ï¼š\n   - `.pth` æ–‡ä»¶é€šå¸¸åŒ…å«æ¨¡å‹çš„çŠ¶æ€å­—å…¸å’Œä¼˜åŒ–å™¨çš„çŠ¶æ€å­—å…¸ï¼Œä»¥åŠå¯é€‰çš„å…¶ä»–è®­ç»ƒä¿¡æ¯ï¼ˆå¦‚æŸå¤±å€¼ã€è¿­ä»£æ¬¡æ•°ç­‰ï¼‰ã€‚\n   - `.safetensor` æ–‡ä»¶åŒ…å«æ¨¡å‹æƒé‡ã€å…ƒæ•°æ®ä»¥åŠä¸æ¨¡å‹å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n   - `.onnx` æ–‡ä»¶åŒ…å«æ¨¡å‹è®¡ç®—å›¾ã€èŠ‚ç‚¹å®šä¹‰ã€è¾¹çš„è¿æ¥ã€åˆå§‹å€¼ï¼ˆæ¨¡å‹æƒé‡ï¼‰ã€è¾“å…¥è¾“å‡ºå®šä¹‰ä»¥åŠå¯é€‰çš„ä¼˜åŒ–ä¿¡æ¯ã€‚\n5. **ä½¿ç”¨åœºæ™¯**ï¼š\n   - `.pth` æ–‡ä»¶ä¸»è¦ç”¨äº PyTorch æ¨¡å‹çš„è®­ç»ƒå’Œæ¨ç†ã€‚\n   - `.safetensor` æ–‡ä»¶ç”¨äºåœ¨ Hugging Face çš„ç”Ÿæ€ç³»ç»Ÿä¸­è¿›è¡Œæ¨¡å‹çš„å®‰å…¨æ£€æŸ¥ã€‚\n   - `.onnx` æ–‡ä»¶ç”¨äºæ¨¡å‹åœ¨ä¸åŒæ¡†æ¶ä¹‹é—´çš„è½¬æ¢å’Œéƒ¨ç½²ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦è·¨å¹³å°æˆ–ç¡¬ä»¶ä¼˜åŒ–çš„åœºæ™¯ä¸­ã€‚\n6. **å¼€æ”¾æ€§å’Œäº’æ“ä½œæ€§**ï¼š\n   - `.onnx` æ ¼å¼çš„è®¾è®¡é‡ç‚¹åœ¨äºå¼€æ”¾æ€§å’Œäº’æ“ä½œæ€§ï¼Œä½¿å…¶æˆä¸ºä¸åŒæ¡†æ¶å’Œå·¥å…·ä¹‹é—´æ¨¡å‹äº¤æ¢çš„æ¡¥æ¢ã€‚\n   - `.pth` å’Œ `.safetensor` æ›´ä¸“æ³¨äºç‰¹å®šæ¡†æ¶æˆ–å·¥å…·é“¾å†…çš„ä½¿ç”¨ã€‚\n     æ€»ç»“æ¥è¯´ï¼Œè¿™ä¸‰ç§æ ¼å¼éƒ½ç”¨äºä¿å­˜æ¨¡å‹æƒé‡ï¼Œä½†å®ƒä»¬åœ¨æ ¼å¼å…¼å®¹æ€§ã€åŒ…å«çš„é¢å¤–ä¿¡æ¯å’Œä½¿ç”¨åœºæ™¯ä¸Šå­˜åœ¨æ˜æ˜¾å·®å¼‚ã€‚`.onnx` æ ¼å¼æ›´åŠ å¼€æ”¾å’Œé€šç”¨ï¼Œè€Œ `.pth` å’Œ `.safetensor` æ›´ä¸“æ³¨äºç‰¹å®šçš„æ¡†æ¶æˆ–åº”ç”¨éœ€æ±‚ã€‚\n\n## ç®€è¿° .pth ï¼Œ .safetensor ï¼Œ .onnx ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„ï¼Ÿä¿å­˜çš„ä¿¡æ¯ä¸­åˆæœ‰å“ªäº›æœ‰åŒºåˆ«ï¼Ÿ\n\n.pthã€.safetensor å’Œ.onnx æ–‡ä»¶æ ¼å¼è™½ç„¶éƒ½æ˜¯ä¸ºäº†ä¿å­˜æœºå™¨å­¦ä¹ æ¨¡å‹çš„ç›¸å…³ä¿¡æ¯ï¼Œä½†å®ƒä»¬åœ¨ä¿å­˜çš„å†…å®¹ä¸Šå­˜åœ¨ç›¸åŒç‚¹å’Œå·®å¼‚ã€‚\n**ç›¸åŒç‚¹ï¼š**\n\n1. **æ¨¡å‹å‚æ•°/æƒé‡**ï¼šè¿™ä¸‰ç§æ–‡ä»¶æ ¼å¼éƒ½ä¼šä¿å­˜æ¨¡å‹çš„å‚æ•°æˆ–æƒé‡ï¼Œè¿™äº›æƒé‡æ˜¯æ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ åˆ°çš„ï¼Œå¯¹æ¨¡å‹çš„é¢„æµ‹èƒ½åŠ›è‡³å…³é‡è¦ã€‚\n2. **å…ƒæ•°æ®**ï¼šå®ƒä»¬éƒ½å¯èƒ½åŒ…å«ä¸€äº›å…ƒæ•°æ®ï¼Œä¾‹å¦‚æ¨¡å‹çš„ç‰ˆæœ¬ã€åˆ›å»ºæ—¥æœŸæˆ–å…¶ä»–æè¿°æ€§ä¿¡æ¯ï¼Œå°½ç®¡å…·ä½“çš„å…ƒæ•°æ®å’Œæ ¼å¼å¯èƒ½å› æ–‡ä»¶æ ¼å¼è€Œå¼‚ã€‚\n   **åŒºåˆ«ï¼š**\n3. **æ ¼å¼å’Œå…¼å®¹æ€§**ï¼š\n   - .pth æ–‡ä»¶æ˜¯ PyTorch çš„åŸç”Ÿæ ¼å¼ï¼Œä¸»è¦ç”¨äºä¿å­˜å’ŒåŠ è½½ PyTorch æ¨¡å‹çš„çŠ¶æ€å­—å…¸ï¼ŒåŒ…æ‹¬æ¨¡å‹æƒé‡å’Œä¼˜åŒ–å™¨çŠ¶æ€ã€‚\n   - .safetensor æ–‡ä»¶æ˜¯ Hugging Face çš„ Safety Checker å·¥å…·ä½¿ç”¨çš„æ ¼å¼ï¼Œé™¤äº†æ¨¡å‹æƒé‡ï¼Œè¿˜åŒ…æ‹¬å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n   - .onnx æ–‡ä»¶æ˜¯ä¸€ç§å¼€æ”¾çš„ã€è·¨æ¡†æ¶çš„æ ¼å¼ï¼Œç”¨äºåœ¨ä¸åŒæ·±åº¦å­¦ä¹ æ¡†æ¶ä¹‹é—´äº¤æ¢æ¨¡å‹ï¼ŒåŒ…å«æ¨¡å‹ç»“æ„å’Œå‚æ•°ä»¥åŠæ¨¡å‹è®¡ç®—å›¾ã€‚\n4. **åŒ…å«å†…å®¹**ï¼š\n   - .pth æ–‡ä»¶é€šå¸¸åŒ…å«æ¨¡å‹çš„çŠ¶æ€å­—å…¸å’Œä¼˜åŒ–å™¨çš„çŠ¶æ€å­—å…¸ï¼Œå¯èƒ½è¿˜åŒ…æ‹¬å…¶ä»–è®­ç»ƒä¿¡æ¯ï¼Œå¦‚æŸå¤±å€¼ã€è¿­ä»£æ¬¡æ•°ç­‰ã€‚\n   - .safetensor æ–‡ä»¶åŒ…å«æ¨¡å‹æƒé‡ã€å…ƒæ•°æ®ä»¥åŠä¸æ¨¡å‹å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n   - .onnx æ–‡ä»¶åŒ…å«æ¨¡å‹è®¡ç®—å›¾ã€èŠ‚ç‚¹å®šä¹‰ã€è¾¹çš„è¿æ¥ã€åˆå§‹å€¼ï¼ˆæ¨¡å‹æƒé‡ï¼‰ã€è¾“å…¥è¾“å‡ºå®šä¹‰ä»¥åŠå¯é€‰çš„ä¼˜åŒ–ä¿¡æ¯ã€‚\n5. **ä½¿ç”¨åœºæ™¯**ï¼š\n   - .pth æ–‡ä»¶ä¸»è¦ç”¨äº PyTorch æ¨¡å‹çš„è®­ç»ƒå’Œæ¨ç†ã€‚\n   - .safetensor æ–‡ä»¶ç”¨äº Hugging Face ç”Ÿæ€ç³»ç»Ÿä¸­çš„æ¨¡å‹å®‰å…¨æ£€æŸ¥ã€‚\n   - .onnx æ–‡ä»¶ç”¨äºæ¨¡å‹åœ¨ä¸åŒæ¡†æ¶ä¹‹é—´çš„è½¬æ¢å’Œéƒ¨ç½²ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦è·¨å¹³å°æˆ–ç¡¬ä»¶ä¼˜åŒ–çš„åœºæ™¯ä¸­ã€‚\n6. **å¼€æ”¾æ€§å’Œäº’æ“ä½œæ€§**ï¼š\n   - .onnx æ ¼å¼é‡ç‚¹åœ¨äºå¼€æ”¾æ€§å’Œäº’æ“ä½œæ€§ï¼Œä¾¿äºä¸åŒæ¡†æ¶å’Œå·¥å…·ä¹‹é—´æ¨¡å‹äº¤æ¢ã€‚\n   - .pth å’Œ.safetensor æ–‡ä»¶æ›´ä¸“æ³¨äºç‰¹å®šæ¡†æ¶æˆ–å·¥å…·é“¾å†…çš„ä½¿ç”¨ã€‚\n     æ€»ç»“æ¥è¯´ï¼Œè¿™ä¸‰ç§æ–‡ä»¶æ ¼å¼éƒ½ä¿å­˜æ¨¡å‹æƒé‡ï¼Œä½†åœ¨æ ¼å¼å…¼å®¹æ€§ã€åŒ…å«çš„é¢å¤–ä¿¡æ¯å’Œä½¿ç”¨åœºæ™¯ä¸Šå­˜åœ¨æ˜æ˜¾å·®å¼‚ã€‚.onnx æ ¼å¼æ›´å¼€æ”¾å’Œé€šç”¨ï¼Œè€Œ.pth å’Œ.safetensor åˆ™æ›´ä¸“æ³¨äºç‰¹å®šæ¡†æ¶æˆ–åº”ç”¨éœ€æ±‚ã€‚\n\n## .pth ï¼Œ .safetensor ï¼Œ .onnx ä¸‰ç§æ ¼å¼ï¼Œå„è‡ªèƒ½å¦ç”¨äºæ¨¡å‹çš„ finetunning ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n\n.pthã€.safetensor å’Œ .onnx ä¸‰ç§æ ¼å¼åœ¨æ¨¡å‹å¾®è°ƒï¼ˆfinetuningï¼‰æ–¹é¢çš„é€‚ç”¨æ€§å„æœ‰ä¸åŒï¼Œä»¥ä¸‹æ˜¯å„è‡ªçš„é€‚ç”¨æ€§åˆ†æï¼š\n**.pth æ ¼å¼ï¼š**\n.pth æ–‡ä»¶å¯ä»¥ç”¨äºæ¨¡å‹çš„å¾®è°ƒã€‚åŸå› å¦‚ä¸‹ï¼š\n\n- .pth æ–‡ä»¶æ˜¯ PyTorch çš„åŸç”Ÿæ ¼å¼ï¼Œå®ƒä¿å­˜äº†æ¨¡å‹çš„çŠ¶æ€å­—å…¸ï¼ŒåŒ…æ‹¬æ¨¡å‹çš„æƒé‡å’Œå¯é€‰çš„ä¼˜åŒ–å™¨çŠ¶æ€ã€‚\n- åœ¨å¾®è°ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥åŠ è½½ .pth æ–‡ä»¶ä¸­çš„æ¨¡å‹æƒé‡ï¼Œç„¶åæ ¹æ®æ–°çš„æ•°æ®é›†å¯¹æ¨¡å‹è¿›è¡Œè¿›ä¸€æ­¥çš„è®­ç»ƒã€‚\n- å¦‚æœ .pth æ–‡ä»¶ä¸­åŒ…å«äº†ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œé‚£ä¹ˆå¯ä»¥ä»ä¸­æ–­ç‚¹ç»§ç»­è®­ç»ƒï¼Œè¿™å¯¹äºå¾®è°ƒè¿‡ç¨‹æ˜¯æœ‰å¸®åŠ©çš„ã€‚\n  **.safetensor æ ¼å¼ï¼š**\n  .safetensor æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºæ¨¡å‹çš„å¾®è°ƒï¼Œä½†æœ‰ä¸€äº›é™åˆ¶ï¼š\n- .safetensor æ–‡ä»¶ä¸»è¦æ˜¯ç”± Hugging Face çš„ Safety Checker å·¥å…·ä½¿ç”¨çš„ï¼Œå®ƒä¿å­˜äº†æ¨¡å‹æƒé‡å’Œä¸å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n- è™½ç„¶è¿™ä¸ªæ ¼å¼ä¸»è¦ç”¨äºå®‰å…¨æ£€æŸ¥ï¼Œä½†å®ƒä»ç„¶åŒ…å«äº†æ¨¡å‹æƒé‡ï¼Œå› æ­¤ç†è®ºä¸Šå¯ä»¥ç”¨äºå¾®è°ƒã€‚\n- ä½†æ˜¯ï¼Œç”±äº .safetensor æ–‡ä»¶æ ¼å¼å¯èƒ½ä¸å¦‚ .pth é‚£æ ·è¢«å¹¿æ³›æ”¯æŒï¼Œå› æ­¤åœ¨å¾®è°ƒæ—¶å¯èƒ½éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥è½¬æ¢æ ¼å¼æˆ–åŠ è½½æƒé‡ã€‚\n  **.onnx æ ¼å¼ï¼š**\n  .onnx æ–‡ä»¶åœ¨å¾®è°ƒæ–¹é¢çš„é€‚ç”¨æ€§è¾ƒä½ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n- .onnx æ–‡ä»¶æ˜¯ä¸€ä¸ªå¼€æ”¾çš„ã€è·¨æ¡†æ¶çš„æ ¼å¼ï¼Œå®ƒä¸ä»…åŒ…å«æ¨¡å‹æƒé‡ï¼Œè¿˜å®šä¹‰äº†æ¨¡å‹è®¡ç®—å›¾ã€‚\n- è™½ç„¶ .onnx æ ¼å¼æ”¯æŒåœ¨ä¸åŒçš„æ¡†æ¶ä¹‹é—´è½¬æ¢æ¨¡å‹ï¼Œä½†å®ƒä¸æ˜¯ä¸ºäº†å¾®è°ƒè€Œè®¾è®¡çš„ã€‚è®¡ç®—å›¾æ˜¯å›ºå®šçš„ï¼Œä¸æ˜“äºä¿®æ”¹ã€‚\n- å¦‚æœéœ€è¦å¾®è°ƒ .onnx æ ¼å¼çš„æ¨¡å‹ï¼Œé€šå¸¸éœ€è¦å…ˆå°†æ¨¡å‹è½¬æ¢å›åŸå§‹æ¡†æ¶ï¼ˆå¦‚ PyTorch æˆ– TensorFlowï¼‰ï¼Œç„¶åå†è¿›è¡Œå¾®è°ƒã€‚\n- å› æ­¤ï¼Œç›´æ¥åœ¨ .onnx æ ¼å¼ä¸Šè¿›è¡Œå¾®è°ƒé€šå¸¸ä¸åˆ‡å®é™…ï¼Œé™¤éæœ‰ç‰¹å®šçš„å·¥å…·æˆ–åº“æ”¯æŒè¿™ç§æ“ä½œã€‚\n  æ€»ç»“æ¥è¯´ï¼Œ.pth æ ¼å¼æœ€é€‚åˆç”¨äº PyTorch æ¨¡å‹çš„å¾®è°ƒï¼Œå› ä¸ºå®ƒç›´æ¥ä¸ PyTorch çš„è®­ç»ƒå’Œæ¨ç†æµç¨‹å…¼å®¹ã€‚.safetensor æ ¼å¼ä¹Ÿå¯ä»¥ç”¨äºå¾®è°ƒï¼Œä½†å¯èƒ½éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥å¤„ç†ã€‚è€Œ .onnx æ ¼å¼é€šå¸¸ä¸ç›´æ¥ç”¨äºå¾®è°ƒï¼Œéœ€è¦è½¬æ¢ä¸ºå…¶ä»–æ¡†æ¶æ ¼å¼åæ‰èƒ½è¿›è¡Œå¾®è°ƒã€‚\n\n## .pth ï¼Œ .safetensor ï¼Œ .onnx ä¸‰ç§æ ¼å¼ï¼Œå„è‡ªèƒ½å¦ç”¨äºè®­ç»ƒ LoRA ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n\nLoRAï¼ˆLow-Rank Adaptationï¼‰æ˜¯ä¸€ç§ç”¨äºå¾®è°ƒå¤§å‹é¢„è®­ç»ƒæ¨¡å‹çš„æŠ€æœ¯ï¼Œå®ƒé€šè¿‡å¼•å…¥ä½ç§©åˆ†è§£æ¥å‡å°‘å¾®è°ƒæ‰€éœ€çš„å‚æ•°æ•°é‡ï¼Œä»è€Œå‡å°‘å­˜å‚¨å’Œè®¡ç®—éœ€æ±‚ã€‚ä»¥ä¸‹æ˜¯å…³äº .pthã€.safetensor å’Œ .onnx æ ¼å¼åœ¨è®­ç»ƒ LoRA æ—¶çš„é€‚ç”¨æ€§åˆ†æï¼š\n**.pth æ ¼å¼ï¼š**\n.pth æ–‡ä»¶å¯ä»¥ç”¨äºè®­ç»ƒ LoRAã€‚åŸå› å¦‚ä¸‹ï¼š\n\n- .pth æ–‡ä»¶æ˜¯ PyTorch çš„åŸç”Ÿæ ¼å¼ï¼Œå¯ä»¥ç›´æ¥ä¿å­˜å’ŒåŠ è½½æ¨¡å‹çš„æƒé‡ï¼ŒåŒ…æ‹¬ LoRA å¼•å…¥çš„ä½ç§©çŸ©é˜µã€‚\n- åœ¨è®­ç»ƒ LoRA æ—¶ï¼Œé€šå¸¸éœ€è¦åœ¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹çš„åŸºç¡€ä¸Šæ·»åŠ é¢å¤–çš„å‚æ•°ï¼ˆå³ä½ç§©çŸ©é˜µï¼‰ï¼Œè¿™äº›å‚æ•°å¯ä»¥åœ¨ PyTorch ä¸­é€šè¿‡è‡ªå®šä¹‰å±‚æˆ–ä¿®æ”¹ç°æœ‰å±‚æ¥å®ç°ã€‚\n- ç”±äº .pth æ–‡ä»¶ä¸ PyTorch æ¡†æ¶ç´§å¯†é›†æˆï¼Œå› æ­¤å¯ä»¥è½»æ¾åœ°ä¿å­˜å’ŒåŠ è½½ LoRA çš„å‚æ•°ï¼Œå¹¶è¿›è¡Œè®­ç»ƒã€‚\n  **.safetensor æ ¼å¼ï¼š**\n  .safetensor æ–‡ä»¶ä¹Ÿå¯ä»¥ç”¨äºè®­ç»ƒ LoRAï¼Œä½†å¯èƒ½æœ‰ä¸€äº›é™åˆ¶ï¼š\n- .safetensor æ–‡ä»¶æ˜¯ä¸ºäº†æé«˜æ¨¡å‹ä½¿ç”¨çš„å®‰å…¨æ€§è€Œè®¾è®¡çš„ï¼Œå®ƒä¿å­˜äº†æ¨¡å‹æƒé‡å’Œå…¶ä»–ä¸å®‰å…¨æ€§ç›¸å…³çš„ä¿¡æ¯ã€‚\n- å¦‚æœ LoRA çš„å‚æ•°è¢«åŒ…å«åœ¨ .safetensor æ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆç†è®ºä¸Šå¯ä»¥ç”¨äºè®­ç»ƒã€‚\n- ç„¶è€Œï¼Œç”±äº .safetensor æ–‡ä»¶æ ¼å¼å¯èƒ½ä¸å¦‚ .pth é‚£æ ·è¢«å¹¿æ³›æ”¯æŒï¼Œå› æ­¤åœ¨è®­ç»ƒ LoRA æ—¶å¯èƒ½éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥å¤„ç†æ–‡ä»¶æ ¼å¼ã€‚\n  **.onnx æ ¼å¼ï¼š**\n  .onnx æ–‡ä»¶åœ¨è®­ç»ƒ LoRA æ–¹é¢é€šå¸¸ä¸é€‚ç”¨ã€‚åŸå› å¦‚ä¸‹ï¼š\n- .onnx æ–‡ä»¶å®šä¹‰äº†æ¨¡å‹çš„è®¡ç®—å›¾å’Œæƒé‡ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªé™æ€çš„æ¨¡å‹æè¿°æ ¼å¼ï¼Œä¸é€‚åˆåŠ¨æ€ä¿®æ”¹æ¨¡å‹ç»“æ„ï¼Œå¦‚æ·»åŠ  LoRA å±‚ã€‚\n- LoRA éœ€è¦åœ¨é¢„è®­ç»ƒæ¨¡å‹çš„ç‰¹å®šå±‚ä¸­æ’å…¥ä½ç§©çŸ©é˜µï¼Œè¿™é€šå¸¸éœ€è¦å¯¹æ¨¡å‹ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œè€Œ .onnx æ ¼å¼ä¸æ”¯æŒè¿™ç§ä¿®æ”¹ã€‚\n- å¦‚æœéœ€è¦ä½¿ç”¨ .onnx æ–‡ä»¶ä¸­çš„æ¨¡å‹æ¥è®­ç»ƒ LoRAï¼Œé€šå¸¸éœ€è¦å…ˆå°†æ¨¡å‹è½¬æ¢å› PyTorch æˆ–å…¶ä»–æ”¯æŒåŠ¨æ€å›¾ä¿®æ”¹çš„æ¡†æ¶ï¼Œç„¶åå†è¿›è¡Œè®­ç»ƒã€‚\n  æ€»ç»“æ¥è¯´ï¼Œ.pth æ ¼å¼æœ€é€‚åˆç”¨äºè®­ç»ƒ LoRAï¼Œå› ä¸ºå®ƒä¸ PyTorch æ¡†æ¶ç´§å¯†é›†æˆï¼Œæ”¯æŒåŠ¨æ€å›¾å’Œè‡ªå®šä¹‰å±‚çš„æ·»åŠ ã€‚.safetensor æ ¼å¼åœ¨ç†è®ºä¸Šä¹Ÿæ˜¯å¯è¡Œçš„ï¼Œä½†å¯èƒ½éœ€è¦é¢å¤–çš„å¤„ç†æ­¥éª¤ã€‚è€Œ .onnx æ ¼å¼ç”±äºä¸æ”¯æŒåŠ¨æ€ä¿®æ”¹æ¨¡å‹ç»“æ„ï¼Œå› æ­¤ä¸é€‚åˆç›´æ¥ç”¨äºè®­ç»ƒ LoRAã€‚\n\n## pth ï¼Œ safetensor ï¼Œ onnx ï¼Œä¸‰ç§æ ¼å¼å¦‚ä½•ä¸¤ä¸¤è½¬æ¢ï¼Ÿ\n\n.pthã€.safetensor å’Œ .onnx æ–‡ä»¶æ ¼å¼ä¹‹é—´çš„è½¬æ¢é€šå¸¸éœ€è¦é€šè¿‡ç‰¹å®šçš„å·¥å…·å’Œåº“æ¥å®ç°ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨è¿™ä¸‰ç§æ ¼å¼ä¹‹é—´è¿›è¡Œä¸¤ä¸¤è½¬æ¢çš„æ¦‚è¿°ï¼š\n\n### .pth åˆ° .safetensor çš„è½¬æ¢\n\nç›®å‰ï¼Œå¹¶æ²¡æœ‰ç›´æ¥çš„æ ‡å‡†å·¥å…·æ¥å°† .pth æ–‡ä»¶è½¬æ¢ä¸º .safetensor æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¯ä»¥æ‰‹åŠ¨åŠ è½½ .pth æ–‡ä»¶ä¸­çš„æƒé‡ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º .safetensor æ ¼å¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹æ­¥éª¤ï¼š\n\n1. ä½¿ç”¨ PyTorch åŠ è½½ .pth æ–‡ä»¶ã€‚\n2. æå–æ¨¡å‹æƒé‡ã€‚\n3. ä½¿ç”¨ Hugging Face çš„ `transformers` åº“æˆ–å…¶ä»–ç›¸å…³å·¥å…·å°†æƒé‡ä¿å­˜ä¸º .safetensor æ–‡ä»¶ã€‚\n\n### .safetensor åˆ° .pth çš„è½¬æ¢\n\nåŒæ ·åœ°ï¼Œå°† .safetensor æ–‡ä»¶è½¬æ¢ä¸º .pth æ–‡ä»¶ä¹Ÿæ²¡æœ‰ç›´æ¥çš„è½¬æ¢å·¥å…·ã€‚ä»¥ä¸‹æ˜¯æ‰‹åŠ¨è½¬æ¢çš„æ­¥éª¤ï¼š\n\n1. ä½¿ç”¨ Hugging Face çš„ `transformers` åº“æˆ–å…¶ä»–ç›¸å…³å·¥å…·åŠ è½½ .safetensor æ–‡ä»¶ã€‚\n2. æå–æ¨¡å‹æƒé‡ã€‚\n3. ä½¿ç”¨ PyTorch å°†æƒé‡ä¿å­˜ä¸º .pth æ–‡ä»¶ã€‚\n\n### .pth åˆ° .onnx çš„è½¬æ¢\n\nPyTorch æä¾›äº†ç›´æ¥å°†æ¨¡å‹è½¬æ¢ä¸º .onnx æ ¼å¼çš„å·¥å…·ï¼š\n\n```python\nimport torch\nimport torch.onnx\n# å‡è®¾ model æ˜¯ä¸€ä¸ª PyTorch æ¨¡å‹\nmodel = ...  # åŠ è½½æˆ–å®šä¹‰æ¨¡å‹\n# å‡è®¾è¾“å…¥æ˜¯ä¸€ä¸ªå¼ é‡ï¼Œå…¶å½¢çŠ¶ä¸æ¨¡å‹è¾“å…¥å…¼å®¹\ninput_sample = torch.randn(batch_size, channels, height, width)\n# å°†æ¨¡å‹è½¬æ¢ä¸º ONNX æ ¼å¼\ntorch.onnx.export(model,               # æ¨¡å‹\n                  input_sample,        # æ¨¡å‹è¾“å…¥ï¼ˆæˆ–ä¸€ä¸ªåŒ…å«è¾“å…¥çš„å…ƒç»„ï¼‰\n                  \"model.onnx\",       # è¾“å‡ºæ–‡ä»¶å\n                  export_params=True,  # æ˜¯å¦å¯¼å‡ºå‚æ•°\n                  opset_version=10,    # ONNX ç®—å­é›†ç‰ˆæœ¬\n                  do_constant_folding=True,  # æ˜¯å¦æ‰§è¡Œå¸¸é‡æŠ˜å ä¼˜åŒ–\n                  input_names=['input'],   # è¾“å…¥å\n                  output_names=['output'], # è¾“å‡ºå\n                  dynamic_axes={'input': {0: 'batch_size'},  # åŠ¨æ€è½´\n                                'output': {0: 'batch_size'}})\n```\n\n### .onnx åˆ° .pth çš„è½¬æ¢\n\nå°† .onnx æ–‡ä»¶è½¬æ¢ä¸º .pth æ–‡ä»¶é€šå¸¸ä¸ç›´æ¥è¿›è¡Œï¼Œå› ä¸º .onnx æ–‡ä»¶åŒ…å«äº†æ¨¡å‹çš„ç»“æ„ä¿¡æ¯ï¼Œè€Œ .pth æ–‡ä»¶åªåŒ…å«æƒé‡ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥é‡æ–°åˆ›å»º PyTorch æ¨¡å‹ç»“æ„ï¼Œç„¶ååŠ è½½ .onnx æ–‡ä»¶ä¸­çš„æƒé‡ï¼š\n\n1. å®šä¹‰ä¸ .onnx æ–‡ä»¶å¯¹åº”çš„ PyTorch æ¨¡å‹ç»“æ„ã€‚\n2. ä½¿ç”¨ `onnx.load` åŠ è½½ .onnx æ–‡ä»¶ã€‚\n3. æå–æƒé‡å¹¶å°†å…¶åŠ è½½åˆ° PyTorch æ¨¡å‹ä¸­ã€‚\n\n### .safetensor åˆ° .onnx çš„è½¬æ¢\n\nç›®å‰æ²¡æœ‰ç›´æ¥çš„æ–¹æ³•å°† .safetensor æ–‡ä»¶è½¬æ¢ä¸º .onnx æ–‡ä»¶ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥å…ˆå°† .safetensor æ–‡ä»¶è½¬æ¢ä¸º .pth æ–‡ä»¶ï¼Œç„¶åå†æŒ‰ç…§ä¸Šè¿°æ–¹æ³•å°† .pth æ–‡ä»¶è½¬æ¢ä¸º .onnx æ–‡ä»¶ã€‚\n\n### .onnx åˆ° .safetensor çš„è½¬æ¢\n\nåŒæ ·åœ°ï¼Œå°† .onnx æ–‡ä»¶è½¬æ¢ä¸º .safetensor æ–‡ä»¶ä¹Ÿæ²¡æœ‰ç›´æ¥çš„è½¬æ¢å·¥å…·ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥å…ˆå°† .onnx æ–‡ä»¶è½¬æ¢ä¸º .pth æ–‡ä»¶ï¼Œç„¶åå†å°† .pth æ–‡ä»¶è½¬æ¢ä¸º .safetensor æ–‡ä»¶ã€‚\nåœ¨è¿›è¡Œè¿™äº›è½¬æ¢æ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¬æ¢è¿‡ç¨‹ä¸­å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›ç‰¹å®šçš„ä¿¡æ¯ï¼Œå¦‚ä¼˜åŒ–å™¨çŠ¶æ€æˆ–æ¨¡å‹é…ç½®ï¼Œå› æ­¤åœ¨è½¬æ¢åå¯èƒ½éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥ç¡®ä¿æ¨¡å‹çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚\n\n## æˆ‘æœ‰ä¸€ä¸ªä»ç½‘ç»œä¸Šä¸‹è½½çš„ .pth æ–‡ä»¶ `001.pth` ã€‚ç»™æˆ‘ Python ä»£ç ï¼Œå°†å…¶è½¬æ¢ä¸º onnx æ ¼å¼ã€‚\n\nè¦å°†ä¸€ä¸ª `.pth` æ–‡ä»¶è½¬æ¢ä¸º `.onnx` æ ¼å¼ï¼Œä½ éœ€è¦é¦–å…ˆåŠ è½½ `.pth` æ–‡ä»¶ä¸­çš„æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ PyTorch çš„ `torch.onnx.export` å‡½æ•°æ¥è¿›è¡Œè½¬æ¢ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ª Python ä»£ç ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•è¿›è¡Œè¿™ä¸€è½¬æ¢è¿‡ç¨‹ã€‚å‡è®¾ä½ å·²ç»æœ‰äº†å¯¹åº”çš„ PyTorch æ¨¡å‹å®šä¹‰ï¼Œå¹¶ä¸” `.pth` æ–‡ä»¶ä¸­åŒ…å«çš„æ˜¯è¯¥æ¨¡å‹çš„æƒé‡ã€‚\nè¯·æ³¨æ„ï¼Œä»¥ä¸‹ä»£ç å‡è®¾ä½ çš„æ¨¡å‹æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ PyTorch æ¨¡å‹ï¼Œå¹¶ä¸”ä½ çŸ¥é“æ¨¡å‹çš„è¾“å…¥å°º ï¿½ï¿½ã€‚ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹å®é™…æƒ…å†µæ¥è°ƒæ•´è¾“å…¥å°ºå¯¸å’Œæ¨¡å‹ç»“æ„ã€‚\n\n```python\nimport torch\nimport torch.onnx\n# å‡è®¾æ¨¡å‹ç»“æ„å’Œè¾“å…¥å°ºå¯¸å·²çŸ¥\n# è¿™é‡Œæ˜¯ç¤ºä¾‹æ¨¡å‹ç»“æ„å’Œè¾“å…¥å°ºå¯¸ï¼Œä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹è¿›è¡Œä¿®æ”¹\nclass MyModel(torch.nn.Module):\n    def __init__(self):\n        super(MyModel, self).__init__()\n        # å®šä¹‰æ¨¡å‹ç»“æ„\n        self.conv1 = torch.nn.Conv2d(3, 16, kernel_size=3, stride=1, padding=1)\n        self.relu = torch.nn.ReLU()\n        self.pool = torch.nn.MaxPool2d(kernel_size=2, stride=2, padding=0)\n        # ... æ·»åŠ æ›´å¤šå±‚ ...\n    def forward(self, x):\n        # å®šä¹‰å‰å‘ä¼ æ’­\n        x = self.conv1(x)\n        x = self.relu(x)\n        x = self.pool(x)\n        # ... åº”ç”¨æ›´å¤šå±‚ ...\n        return x\n# åˆ›å»ºæ¨¡å‹å®ä¾‹\nmodel = MyModel()\n# åŠ è½½.pthæ–‡ä»¶ä¸­çš„æƒé‡\nmodel.load_state_dict(torch.load('001.pth'))\n# è®¾ç½®æ¨¡å‹ä¸ºè¯„ä¼°æ¨¡å¼ï¼ˆå¦‚æœé€‚ç”¨ï¼‰\nmodel.eval()\n# åˆ›å»ºä¸€ä¸ªç¬¦åˆæ¨¡å‹è¾“å…¥å°ºå¯¸çš„ç¤ºä¾‹è¾“å…¥\n# å‡è®¾è¾“å…¥æ˜¯å•å¼ å›¾ç‰‡ï¼Œé€šé“æ•°ä¸º3ï¼Œé«˜å’Œå®½åˆ†åˆ«ä¸º224å’Œ224\n# ä½ éœ€è¦æ ¹æ®ä½ çš„æ¨¡å‹è°ƒæ•´è¾“å…¥å°ºå¯¸\ninput_sample = torch.randn(1, 3, 224, 224)\n# æŒ‡å®šONNXæ¨¡å‹çš„è¾“å‡ºæ–‡ä»¶å\noutput_file = 'model.onnx'\n# å¯¼å‡ºæ¨¡å‹ä¸ºONNXæ ¼å¼\ntorch.onnx.export(model,               # æ¨¡å‹\n                  input_sample,        # æ¨¡å‹è¾“å…¥ï¼ˆæˆ–ä¸€ä¸ªåŒ…å«è¾“å…¥çš„å…ƒç»„ï¼‰\n                  output_file,         # è¾“å‡ºæ–‡ä»¶å\n                  export_params=True,  # æ˜¯å¦å¯¼å‡ºå‚æ•°\n                  opset_version=10,    # ONNX ç®—å­é›†ç‰ˆæœ¬\n                  do_constant_folding=True,  # æ˜¯å¦æ‰§è¡Œå¸¸é‡æŠ˜å ä¼˜åŒ–\n                  input_names=['input'],   # è¾“å…¥å\n                  output_names=['output'], # è¾“å‡ºå\n                  dynamic_axes={'input': {0: 'batch_size'},  # åŠ¨æ€è½´\n                                'output': {0: 'batch_size'}})\n```\n\nåœ¨è¿è¡Œè¿™æ®µä»£ç ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š\n\n- ä½ çš„ç¯å¢ƒä¸­å·²ç»å®‰è£…äº† PyTorch å’Œ onnxã€‚\n- ä½ å·²ç»æ ¹æ®ä½ çš„æ¨¡å‹ç»“æ„æ­£ç¡®åœ°å®šä¹‰äº† `MyModel` ç±»ã€‚\n- ä½ å·²ç»æ ¹æ®ä½ çš„æ¨¡å‹è¾“å…¥å°ºå¯¸æ­£ç¡®åœ°è®¾ç½®äº† `input_sample`ã€‚\n  è¿è¡Œä¸Šè¿°ä»£ç åï¼Œä½ åº”è¯¥ä¼šåœ¨å½“å‰ç›®å½•ä¸‹å¾—åˆ°ä¸€ä¸ªåä¸º `model.onnx` çš„æ–‡ä»¶ï¼Œè¿™å°±æ˜¯è½¬æ¢åçš„ ONNX æ ¼å¼çš„æ¨¡å‹ã€‚\n\n## æˆ‘æ²¡æœ‰å¯¹åº”çš„ PyTorch æ¨¡å‹å®šä¹‰ã€‚æˆ‘è¦å¦‚ä½•è·å¾—ï¼Ÿ\n\nå¦‚æœä½ æ²¡æœ‰æ¨¡å‹çš„ PyTorch å®šä¹‰ï¼Œä½†ä½ æœ‰ä¸€ä¸ª `.pth` æ–‡ä»¶ï¼Œä½ å¯ä»¥å°è¯•ä»¥ä¸‹å‡ ç§æ–¹æ³•æ¥è·å–æˆ–é‡å»ºæ¨¡å‹çš„ç»“æ„ï¼š\n\n### 1. ä½¿ç”¨ PyTorch çš„ `torch.jit.load`\n\nå¦‚æœä½ çš„ `.pth` æ–‡ä»¶æ˜¯ä¸€ä¸ª JIT traced çš„æ¨¡å‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `torch.jit.load` æ¥åŠ è½½å®ƒï¼Œè¿™æ ·å°±ä¸éœ€è¦åŸå§‹çš„æ¨¡å‹å®šä¹‰ã€‚\n\n```python\nimport torch\n# åŠ è½½JIT tracedæ¨¡å‹\ntraced_model = torch.jit.load('001.pth')\n# ä½¿ç”¨æ¨¡å‹ï¼ˆä¾‹å¦‚è¿›è¡Œæ¨ç†ï¼‰\n# input_sample = ...  # åˆ›å»ºä¸€ä¸ªç¬¦åˆæ¨¡å‹è¾“å…¥å°ºå¯¸çš„ç¤ºä¾‹è¾“å…¥\n# output = traced_model(input_sample)\n```\n\n### 2. æŸ¥æ‰¾æ¨¡å‹çš„æ–‡æ¡£æˆ–ä»£ç \n\nå¦‚æœæ¨¡å‹æ˜¯ä»æŸä¸ªçŸ¥åçš„ä»£ç åº“æˆ–è®ºæ–‡ä¸­è·å¾—çš„ï¼Œä½ å¯ä»¥å°è¯•æŸ¥æ‰¾åŸå§‹çš„æ¨¡å‹å®šä¹‰ä»£ç ã€‚é€šå¸¸ï¼Œè®ºæ–‡çš„é™„å½•æˆ–ä»£ç åº“çš„ README æ–‡ä»¶ä¼šåŒ…å«æ¨¡å‹çš„å®šä¹‰ã€‚\n\n### 3. ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“\n\næœ‰äº›ç¬¬ä¸‰æ–¹åº“å¯èƒ½æä¾›äº†é¢„å®šä¹‰çš„æ¨¡å‹ç»“æ„ï¼Œä½ å¯ä»¥å°è¯•ä½¿ç”¨è¿™äº›åº“æ¥åŠ è½½æ¨¡å‹ã€‚\nä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªåœ¨ torchvision ä¸­å®šä¹‰çš„æ¨¡å‹ï¼Œä½ å¯ä»¥è¿™æ ·åšï¼š\n\n```python\nimport torch\nimport torchvision.models as models\n# å‡è®¾ä½ çŸ¥é“æ¨¡å‹æ˜¯ torchvision ä¸­çš„æŸä¸ªæ¨¡å‹\nmodel = models.resnet50(pretrained=False)\n# åŠ è½½æƒé‡\nmodel.load_state_dict(torch.load('001.pth'))\n```\n\n### 4. ååºåˆ—åŒ–çŠ¶æ€å­—å…¸\n\nå¦‚æœä½ åªæ˜¯ä¸¢å¤±äº†æ¨¡å‹å®šä¹‰ï¼Œä½†ä½ æœ‰çŠ¶æ€å­—å…¸ï¼Œä½ å¯ä»¥å°è¯•ååºåˆ—åŒ–çŠ¶æ€å­—å…¸æ¥é‡å»ºæ¨¡å‹ç»“æ„ã€‚\n\n```python\nimport torch\n# åŠ è½½çŠ¶æ€å­—å…¸\nstate_dict = torch.load('001.pth')\n# å‡è®¾ä½ çŸ¥é“æ¨¡å‹ç»“æ„ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªç©ºçš„æ¨¡å‹å®ä¾‹ï¼Œç„¶ååŠ è½½çŠ¶æ€å­—å…¸\n# model = ...  # åˆ›å»ºæ¨¡å‹å®ä¾‹\n# model.load_state_dict(state_dict)\n```\n\n### 5. ä½¿ç”¨æ¨¡å‹æ¶æ„æœç´¢å·¥å…·\n\næœ‰ä¸€äº›å·¥å…·å’Œåº“å¯ä»¥å¸®åŠ©ä½ æ ¹æ®æƒé‡æ–‡ä»¶æ¨æ–­å‡ºæ¨¡å‹ç»“æ„ã€‚ä¾‹å¦‚ï¼Œ`netron` æ˜¯ä¸€ä¸ªå¯è§†åŒ–ç¥ç»ç½‘ç»œå·¥å…·ï¼Œå¯ä»¥æ˜¾ç¤º `.pth` æ–‡ä»¶ä¸­çš„æ¨¡å‹ç»“æ„ã€‚\n\n```bash\n# å®‰è£… netron\npip install netron\n# ä½¿ç”¨ netron å¯è§†åŒ–æ¨¡å‹\nnetron start 001.pth\n```\n\né€šè¿‡è¿™äº›æ–¹æ³•ï¼Œä½ åº”è¯¥èƒ½å¤Ÿæ‰¾åˆ°æˆ–é‡å»ºæ¨¡å‹çš„ç»“æ„ã€‚ä¸€æ—¦ä½ æœ‰äº†æ¨¡å‹å®šä¹‰ï¼Œä½ å¯ä»¥ä½¿ç”¨å‰é¢æä¾›çš„ä»£ç ç¤ºä¾‹æ¥å°† `.pth` æ–‡ä»¶è½¬æ¢ä¸º `.onnx` æ ¼å¼ã€‚å¦‚æœä½ æ— æ³•ç¡®å®šæ¨¡å‹ç»“æ„ï¼Œä½ å¯èƒ½éœ€è¦è”ç³»æ¨¡å‹çš„åŸå§‹ä½œè€…æˆ–æŸ¥æ‰¾ç›¸å…³çš„æ–‡æ¡£æ¥è·å–æ¨¡å‹å®šä¹‰ã€‚\n","title":"æ·±åº¦å­¦ä¹ æ¨¡å‹æ–‡ä»¶æ ¼å¼å¯¹æ¯”ï¼špthã€safetensor ä¸ onnx","abstract":"\u003e æœ¬é¡µé¢ä»‹ç»äº†ä¸‰ç§æœºå™¨å­¦ä¹ æ¨¡å‹æ–‡ä»¶æ ¼å¼ï¼š.pthã€.safetensor å’Œ .onnxã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬æ¯ç§æ ¼å¼çš„å®šä¹‰ã€ä¿å­˜çš„å†…å®¹ã€ç”¨é€”ä»¥åŠå®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å’Œè½¬æ¢æ–¹æ³•ã€‚\nPyTorch ä¸­çš„`.pth`æ–‡ä»¶é€šå¸¸ç”¨äºä¿å­˜æ¨¡å‹çš„æƒé‡ï¼ˆparametersï¼‰å’Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆoptimizer stateï¼‰ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ª`.pth`æ–‡ä»¶å¯èƒ½åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\n1. **æ¨¡å‹çŠ¶æ€å­—å…¸ï¼ˆModel state dictionaryï¼‰**ï¼š","length":365,"created_at":"2024-11-29T02:00:00.000Z","updated_at":"2024-11-29T02:00:00.000Z","tags":["PyTorch","ONNX","æ·±åº¦å­¦ä¹ ","æ¨¡å‹éƒ¨ç½²","å­¦ä¹ ç¬”è®°"],"license":true,"headingTrees":[{"key":"pytorch-ä¿å­˜çš„-pth-æ–‡ä»¶é‡Œéƒ½ä¿å­˜äº†äº›ä»€ä¹ˆä¸œè¥¿","href":"#pytorch-ä¿å­˜çš„-pth-æ–‡ä»¶é‡Œéƒ½ä¿å­˜äº†äº›ä»€ä¹ˆä¸œè¥¿","heading":2,"title":"pytorch ä¿å­˜çš„ .pth æ–‡ä»¶é‡Œéƒ½ä¿å­˜äº†äº›ä»€ä¹ˆä¸œè¥¿ï¼Ÿ","children":[],"id":"pytorch-ä¿å­˜çš„-pth-æ–‡ä»¶é‡Œéƒ½ä¿å­˜äº†äº›ä»€ä¹ˆä¸œè¥¿"},{"key":"safetensor-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¸œè¥¿","href":"#safetensor-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¸œè¥¿","heading":2,"title":".safetensor æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¸œè¥¿ï¼Ÿ","children":[],"id":"safetensor-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¸œè¥¿"},{"key":"onnx-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯","href":"#onnx-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯","heading":2,"title":".onnx æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯ï¼Ÿ","children":[],"id":"onnx-æ–‡ä»¶ä¸­åˆä¿å­˜äº†ä»€ä¹ˆä¿¡æ¯"},{"key":"ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„æœ‰å“ªäº›æœ‰åŒºåˆ«","href":"#ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„æœ‰å“ªäº›æœ‰åŒºåˆ«","heading":2,"title":"ç®€è¿° .pth ï¼Œ .safetensor ï¼Œ .onnx ä¿å­˜çš„ä¿¡æ¯ä¸­ï¼Œæœ‰å“ªäº›æ˜¯ç›¸åŒçš„ï¼Ÿæœ‰å“ªäº›æœ‰åŒºåˆ«ï¼Ÿ","children":[],"id":"ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„æœ‰å“ªäº›æœ‰åŒºåˆ«"},{"key":"ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„ä¿å­˜çš„ä¿¡æ¯ä¸­åˆæœ‰å“ªäº›æœ‰åŒºåˆ«","href":"#ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„ä¿å­˜çš„ä¿¡æ¯ä¸­åˆæœ‰å“ªäº›æœ‰åŒºåˆ«","heading":2,"title":"ç®€è¿° .pth ï¼Œ .safetensor ï¼Œ .onnx ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„ï¼Ÿä¿å­˜çš„ä¿¡æ¯ä¸­åˆæœ‰å“ªäº›æœ‰åŒºåˆ«ï¼Ÿ","children":[],"id":"ç®€è¿°-pth--safetensor--onnx-ä¿å­˜çš„ä¿¡æ¯ä¸­æœ‰å“ªäº›æ˜¯ç›¸åŒçš„ä¿å­˜çš„ä¿¡æ¯ä¸­åˆæœ‰å“ªäº›æœ‰åŒºåˆ«"},{"key":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºæ¨¡å‹çš„-finetunning-ä¸ºä»€ä¹ˆ","href":"#pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºæ¨¡å‹çš„-finetunning-ä¸ºä»€ä¹ˆ","heading":2,"title":".pth ï¼Œ .safetensor ï¼Œ .onnx ä¸‰ç§æ ¼å¼ï¼Œå„è‡ªèƒ½å¦ç”¨äºæ¨¡å‹çš„ finetunning ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ","children":[],"id":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºæ¨¡å‹çš„-finetunning-ä¸ºä»€ä¹ˆ"},{"key":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºè®­ç»ƒ-lora-ä¸ºä»€ä¹ˆ","href":"#pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºè®­ç»ƒ-lora-ä¸ºä»€ä¹ˆ","heading":2,"title":".pth ï¼Œ .safetensor ï¼Œ .onnx ä¸‰ç§æ ¼å¼ï¼Œå„è‡ªèƒ½å¦ç”¨äºè®­ç»ƒ LoRA ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ","children":[],"id":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å„è‡ªèƒ½å¦ç”¨äºè®­ç»ƒ-lora-ä¸ºä»€ä¹ˆ"},{"key":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å¦‚ä½•ä¸¤ä¸¤è½¬æ¢","href":"#pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å¦‚ä½•ä¸¤ä¸¤è½¬æ¢","heading":2,"title":"pth ï¼Œ safetensor ï¼Œ onnx ï¼Œä¸‰ç§æ ¼å¼å¦‚ä½•ä¸¤ä¸¤è½¬æ¢ï¼Ÿ","children":[{"key":"pth-åˆ°-safetensor-çš„è½¬æ¢","href":"#pth-åˆ°-safetensor-çš„è½¬æ¢","heading":3,"title":".pth åˆ° .safetensor çš„è½¬æ¢","children":[],"id":"pth-åˆ°-safetensor-çš„è½¬æ¢"},{"key":"safetensor-åˆ°-pth-çš„è½¬æ¢","href":"#safetensor-åˆ°-pth-çš„è½¬æ¢","heading":3,"title":".safetensor åˆ° .pth çš„è½¬æ¢","children":[],"id":"safetensor-åˆ°-pth-çš„è½¬æ¢"},{"key":"pth-åˆ°-onnx-çš„è½¬æ¢","href":"#pth-åˆ°-onnx-çš„è½¬æ¢","heading":3,"title":".pth åˆ° .onnx çš„è½¬æ¢","children":[],"id":"pth-åˆ°-onnx-çš„è½¬æ¢"},{"key":"onnx-åˆ°-pth-çš„è½¬æ¢","href":"#onnx-åˆ°-pth-çš„è½¬æ¢","heading":3,"title":".onnx åˆ° .pth çš„è½¬æ¢","children":[],"id":"onnx-åˆ°-pth-çš„è½¬æ¢"},{"key":"safetensor-åˆ°-onnx-çš„è½¬æ¢","href":"#safetensor-åˆ°-onnx-çš„è½¬æ¢","heading":3,"title":".safetensor åˆ° .onnx çš„è½¬æ¢","children":[],"id":"safetensor-åˆ°-onnx-çš„è½¬æ¢"},{"key":"onnx-åˆ°-safetensor-çš„è½¬æ¢","href":"#onnx-åˆ°-safetensor-çš„è½¬æ¢","heading":3,"title":".onnx åˆ° .safetensor çš„è½¬æ¢","children":[],"id":"onnx-åˆ°-safetensor-çš„è½¬æ¢"}],"id":"pth--safetensor--onnx-ä¸‰ç§æ ¼å¼å¦‚ä½•ä¸¤ä¸¤è½¬æ¢"},{"key":"æˆ‘æœ‰ä¸€ä¸ªä»ç½‘ç»œä¸Šä¸‹è½½çš„-pth-æ–‡ä»¶-001pth-ç»™æˆ‘-python-ä»£ç å°†å…¶è½¬æ¢ä¸º-onnx-æ ¼å¼","href":"#æˆ‘æœ‰ä¸€ä¸ªä»ç½‘ç»œä¸Šä¸‹è½½çš„-pth-æ–‡ä»¶-001pth-ç»™æˆ‘-python-ä»£ç å°†å…¶è½¬æ¢ä¸º-onnx-æ ¼å¼","heading":2,"title":"æˆ‘æœ‰ä¸€ä¸ªä»ç½‘ç»œä¸Šä¸‹è½½çš„ .pth æ–‡ä»¶ 001.pth ã€‚ç»™æˆ‘ Python ä»£ç ï¼Œå°†å…¶è½¬æ¢ä¸º onnx æ ¼å¼ã€‚","children":[],"id":"æˆ‘æœ‰ä¸€ä¸ªä»ç½‘ç»œä¸Šä¸‹è½½çš„-pth-æ–‡ä»¶-001pth-ç»™æˆ‘-python-ä»£ç å°†å…¶è½¬æ¢ä¸º-onnx-æ ¼å¼"},{"key":"æˆ‘æ²¡æœ‰å¯¹åº”çš„-pytorch-æ¨¡å‹å®šä¹‰æˆ‘è¦å¦‚ä½•è·å¾—","href":"#æˆ‘æ²¡æœ‰å¯¹åº”çš„-pytorch-æ¨¡å‹å®šä¹‰æˆ‘è¦å¦‚ä½•è·å¾—","heading":2,"title":"æˆ‘æ²¡æœ‰å¯¹åº”çš„ PyTorch æ¨¡å‹å®šä¹‰ã€‚æˆ‘è¦å¦‚ä½•è·å¾—ï¼Ÿ","children":[{"key":"1-ä½¿ç”¨-pytorch-çš„-torchjitload","href":"#1-ä½¿ç”¨-pytorch-çš„-torchjitload","heading":3,"title":"1. ä½¿ç”¨ PyTorch çš„ torch.jit.load","children":[],"id":"1-ä½¿ç”¨-pytorch-çš„-torchjitload"},{"key":"2-æŸ¥æ‰¾æ¨¡å‹çš„æ–‡æ¡£æˆ–ä»£ç ","href":"#2-æŸ¥æ‰¾æ¨¡å‹çš„æ–‡æ¡£æˆ–ä»£ç ","heading":3,"title":"2. æŸ¥æ‰¾æ¨¡å‹çš„æ–‡æ¡£æˆ–ä»£ç ","children":[],"id":"2-æŸ¥æ‰¾æ¨¡å‹çš„æ–‡æ¡£æˆ–ä»£ç "},{"key":"3-ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“","href":"#3-ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“","heading":3,"title":"3. ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“","children":[],"id":"3-ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“"},{"key":"4-ååºåˆ—åŒ–çŠ¶æ€å­—å…¸","href":"#4-ååºåˆ—åŒ–çŠ¶æ€å­—å…¸","heading":3,"title":"4. ååºåˆ—åŒ–çŠ¶æ€å­—å…¸","children":[],"id":"4-ååºåˆ—åŒ–çŠ¶æ€å­—å…¸"},{"key":"5-ä½¿ç”¨æ¨¡å‹æ¶æ„æœç´¢å·¥å…·","href":"#5-ä½¿ç”¨æ¨¡å‹æ¶æ„æœç´¢å·¥å…·","heading":3,"title":"5. ä½¿ç”¨æ¨¡å‹æ¶æ„æœç´¢å·¥å…·","children":[],"id":"5-ä½¿ç”¨æ¨¡å‹æ¶æ„æœç´¢å·¥å…·"}],"id":"æˆ‘æ²¡æœ‰å¯¹åº”çš„-pytorch-æ¨¡å‹å®šä¹‰æˆ‘è¦å¦‚ä½•è·å¾—"}],"wikiRefAliases":[],"richRefAliases":[]}}]},"__N_SSG":true},"page":"/tags/[tag]","query":{"tag":"å­¦ä¹ ç¬”è®°"},"buildId":"C8wT_gaFm6V74l2wBJOmN","assetPrefix":"/blog-next","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>